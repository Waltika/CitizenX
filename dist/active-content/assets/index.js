var nq=Object.defineProperty;var BA=r=>{throw TypeError(r)};var iq=(r,e,t)=>e in r?nq(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var u=(r,e,t)=>iq(r,typeof e!="symbol"?e+"":e,t),V4=(r,e,t)=>e.has(r)||BA("Cannot "+t);var se=(r,e,t)=>(V4(r,e,"read from private field"),t?t.call(r):e.get(r)),Ge=(r,e,t)=>e.has(r)?BA("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(r):e.set(r,t),vt=(r,e,t,n)=>(V4(r,e,"write to private field"),n?n.call(r,t):e.set(r,t),t),Ie=(r,e,t)=>(V4(r,e,"access private method"),t);var Es=(r,e,t,n)=>({set _(i){vt(r,e,i,t)},get _(){return se(r,e,n)}});(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function t(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(i){if(i.ep)return;i.ep=!0;const s=t(i);fetch(i.href,s)}})();var v1=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Nc(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}var IM={exports:{}},y3={},kM={exports:{}},qe={};/**
 * @license React
 * react.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Cp=Symbol.for("react.element"),sq=Symbol.for("react.portal"),oq=Symbol.for("react.fragment"),aq=Symbol.for("react.strict_mode"),cq=Symbol.for("react.profiler"),lq=Symbol.for("react.provider"),uq=Symbol.for("react.context"),dq=Symbol.for("react.forward_ref"),hq=Symbol.for("react.suspense"),fq=Symbol.for("react.memo"),pq=Symbol.for("react.lazy"),UA=Symbol.iterator;function gq(r){return r===null||typeof r!="object"?null:(r=UA&&r[UA]||r["@@iterator"],typeof r=="function"?r:null)}var _M={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},TM=Object.assign,PM={};function Ah(r,e,t){this.props=r,this.context=e,this.refs=PM,this.updater=t||_M}Ah.prototype.isReactComponent={};Ah.prototype.setState=function(r,e){if(typeof r!="object"&&typeof r!="function"&&r!=null)throw Error("setState(...): takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,r,e,"setState")};Ah.prototype.forceUpdate=function(r){this.updater.enqueueForceUpdate(this,r,"forceUpdate")};function DM(){}DM.prototype=Ah.prototype;function _9(r,e,t){this.props=r,this.context=e,this.refs=PM,this.updater=t||_M}var T9=_9.prototype=new DM;T9.constructor=_9;TM(T9,Ah.prototype);T9.isPureReactComponent=!0;var FA=Array.isArray,$M=Object.prototype.hasOwnProperty,P9={current:null},NM={key:!0,ref:!0,__self:!0,__source:!0};function MM(r,e,t){var n,i={},s=null,o=null;if(e!=null)for(n in e.ref!==void 0&&(o=e.ref),e.key!==void 0&&(s=""+e.key),e)$M.call(e,n)&&!NM.hasOwnProperty(n)&&(i[n]=e[n]);var a=arguments.length-2;if(a===1)i.children=t;else if(1<a){for(var c=Array(a),l=0;l<a;l++)c[l]=arguments[l+2];i.children=c}if(r&&r.defaultProps)for(n in a=r.defaultProps,a)i[n]===void 0&&(i[n]=a[n]);return{$$typeof:Cp,type:r,key:s,ref:o,props:i,_owner:P9.current}}function yq(r,e){return{$$typeof:Cp,type:r.type,key:e,ref:r.ref,props:r.props,_owner:r._owner}}function D9(r){return typeof r=="object"&&r!==null&&r.$$typeof===Cp}function mq(r){var e={"=":"=0",":":"=2"};return"$"+r.replace(/[=:]/g,function(t){return e[t]})}var zA=/\/+/g;function K4(r,e){return typeof r=="object"&&r!==null&&r.key!=null?mq(""+r.key):e.toString(36)}function Cg(r,e,t,n,i){var s=typeof r;(s==="undefined"||s==="boolean")&&(r=null);var o=!1;if(r===null)o=!0;else switch(s){case"string":case"number":o=!0;break;case"object":switch(r.$$typeof){case Cp:case sq:o=!0}}if(o)return o=r,i=i(o),r=n===""?"."+K4(o,0):n,FA(i)?(t="",r!=null&&(t=r.replace(zA,"$&/")+"/"),Cg(i,e,t,"",function(l){return l})):i!=null&&(D9(i)&&(i=yq(i,t+(!i.key||o&&o.key===i.key?"":(""+i.key).replace(zA,"$&/")+"/")+r)),e.push(i)),1;if(o=0,n=n===""?".":n+":",FA(r))for(var a=0;a<r.length;a++){s=r[a];var c=n+K4(s,a);o+=Cg(s,e,t,c,i)}else if(c=gq(r),typeof c=="function")for(r=c.call(r),a=0;!(s=r.next()).done;)s=s.value,c=n+K4(s,a++),o+=Cg(s,e,t,c,i);else if(s==="object")throw e=String(r),Error("Objects are not valid as a React child (found: "+(e==="[object Object]"?"object with keys {"+Object.keys(r).join(", ")+"}":e)+"). If you meant to render a collection of children, use an array instead.");return o}function g0(r,e,t){if(r==null)return r;var n=[],i=0;return Cg(r,n,"","",function(s){return e.call(t,s,i++)}),n}function wq(r){if(r._status===-1){var e=r._result;e=e(),e.then(function(t){(r._status===0||r._status===-1)&&(r._status=1,r._result=t)},function(t){(r._status===0||r._status===-1)&&(r._status=2,r._result=t)}),r._status===-1&&(r._status=0,r._result=e)}if(r._status===1)return r._result.default;throw r._result}var pn={current:null},Ig={transition:null},bq={ReactCurrentDispatcher:pn,ReactCurrentBatchConfig:Ig,ReactCurrentOwner:P9};function OM(){throw Error("act(...) is not supported in production builds of React.")}qe.Children={map:g0,forEach:function(r,e,t){g0(r,function(){e.apply(this,arguments)},t)},count:function(r){var e=0;return g0(r,function(){e++}),e},toArray:function(r){return g0(r,function(e){return e})||[]},only:function(r){if(!D9(r))throw Error("React.Children.only expected to receive a single React element child.");return r}};qe.Component=Ah;qe.Fragment=oq;qe.Profiler=cq;qe.PureComponent=_9;qe.StrictMode=aq;qe.Suspense=hq;qe.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=bq;qe.act=OM;qe.cloneElement=function(r,e,t){if(r==null)throw Error("React.cloneElement(...): The argument must be a React element, but you passed "+r+".");var n=TM({},r.props),i=r.key,s=r.ref,o=r._owner;if(e!=null){if(e.ref!==void 0&&(s=e.ref,o=P9.current),e.key!==void 0&&(i=""+e.key),r.type&&r.type.defaultProps)var a=r.type.defaultProps;for(c in e)$M.call(e,c)&&!NM.hasOwnProperty(c)&&(n[c]=e[c]===void 0&&a!==void 0?a[c]:e[c])}var c=arguments.length-2;if(c===1)n.children=t;else if(1<c){a=Array(c);for(var l=0;l<c;l++)a[l]=arguments[l+2];n.children=a}return{$$typeof:Cp,type:r.type,key:i,ref:s,props:n,_owner:o}};qe.createContext=function(r){return r={$$typeof:uq,_currentValue:r,_currentValue2:r,_threadCount:0,Provider:null,Consumer:null,_defaultValue:null,_globalName:null},r.Provider={$$typeof:lq,_context:r},r.Consumer=r};qe.createElement=MM;qe.createFactory=function(r){var e=MM.bind(null,r);return e.type=r,e};qe.createRef=function(){return{current:null}};qe.forwardRef=function(r){return{$$typeof:dq,render:r}};qe.isValidElement=D9;qe.lazy=function(r){return{$$typeof:pq,_payload:{_status:-1,_result:r},_init:wq}};qe.memo=function(r,e){return{$$typeof:fq,type:r,compare:e===void 0?null:e}};qe.startTransition=function(r){var e=Ig.transition;Ig.transition={};try{r()}finally{Ig.transition=e}};qe.unstable_act=OM;qe.useCallback=function(r,e){return pn.current.useCallback(r,e)};qe.useContext=function(r){return pn.current.useContext(r)};qe.useDebugValue=function(){};qe.useDeferredValue=function(r){return pn.current.useDeferredValue(r)};qe.useEffect=function(r,e){return pn.current.useEffect(r,e)};qe.useId=function(){return pn.current.useId()};qe.useImperativeHandle=function(r,e,t){return pn.current.useImperativeHandle(r,e,t)};qe.useInsertionEffect=function(r,e){return pn.current.useInsertionEffect(r,e)};qe.useLayoutEffect=function(r,e){return pn.current.useLayoutEffect(r,e)};qe.useMemo=function(r,e){return pn.current.useMemo(r,e)};qe.useReducer=function(r,e,t){return pn.current.useReducer(r,e,t)};qe.useRef=function(r){return pn.current.useRef(r)};qe.useState=function(r){return pn.current.useState(r)};qe.useSyncExternalStore=function(r,e,t){return pn.current.useSyncExternalStore(r,e,t)};qe.useTransition=function(){return pn.current.useTransition()};qe.version="18.3.1";kM.exports=qe;var Qe=kM.exports;/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var vq=Qe,Eq=Symbol.for("react.element"),Sq=Symbol.for("react.fragment"),xq=Object.prototype.hasOwnProperty,Aq=vq.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,Cq={key:!0,ref:!0,__self:!0,__source:!0};function RM(r,e,t){var n,i={},s=null,o=null;t!==void 0&&(s=""+t),e.key!==void 0&&(s=""+e.key),e.ref!==void 0&&(o=e.ref);for(n in e)xq.call(e,n)&&!Cq.hasOwnProperty(n)&&(i[n]=e[n]);if(r&&r.defaultProps)for(n in e=r.defaultProps,e)i[n]===void 0&&(i[n]=e[n]);return{$$typeof:Eq,type:r,key:s,ref:o,props:i,_owner:Aq.current}}y3.Fragment=Sq;y3.jsx=RM;y3.jsxs=RM;IM.exports=y3;var Ae=IM.exports,LM={exports:{}},ri={},BM={exports:{}},UM={};/**
 * @license React
 * scheduler.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */(function(r){function e(O,U){var W=O.length;O.push(U);e:for(;0<W;){var Y=W-1>>>1,H=O[Y];if(0<i(H,U))O[Y]=U,O[W]=H,W=Y;else break e}}function t(O){return O.length===0?null:O[0]}function n(O){if(O.length===0)return null;var U=O[0],W=O.pop();if(W!==U){O[0]=W;e:for(var Y=0,H=O.length,ne=H>>>1;Y<ne;){var ye=2*(Y+1)-1,ue=O[ye],ce=ye+1,Ne=O[ce];if(0>i(ue,W))ce<H&&0>i(Ne,ue)?(O[Y]=Ne,O[ce]=W,Y=ce):(O[Y]=ue,O[ye]=W,Y=ye);else if(ce<H&&0>i(Ne,W))O[Y]=Ne,O[ce]=W,Y=ce;else break e}}return U}function i(O,U){var W=O.sortIndex-U.sortIndex;return W!==0?W:O.id-U.id}if(typeof performance=="object"&&typeof performance.now=="function"){var s=performance;r.unstable_now=function(){return s.now()}}else{var o=Date,a=o.now();r.unstable_now=function(){return o.now()-a}}var c=[],l=[],d=1,h=null,p=3,m=!1,f=!1,g=!1,v=typeof setTimeout=="function"?setTimeout:null,y=typeof clearTimeout=="function"?clearTimeout:null,w=typeof setImmediate<"u"?setImmediate:null;typeof navigator<"u"&&navigator.scheduling!==void 0&&navigator.scheduling.isInputPending!==void 0&&navigator.scheduling.isInputPending.bind(navigator.scheduling);function b(O){for(var U=t(l);U!==null;){if(U.callback===null)n(l);else if(U.startTime<=O)n(l),U.sortIndex=U.expirationTime,e(c,U);else break;U=t(l)}}function E(O){if(g=!1,b(O),!f)if(t(c)!==null)f=!0,Q(A);else{var U=t(l);U!==null&&K(E,U.startTime-O)}}function A(O,U){f=!1,g&&(g=!1,y(I),I=-1),m=!0;var W=p;try{for(b(U),h=t(c);h!==null&&(!(h.expirationTime>U)||O&&!z());){var Y=h.callback;if(typeof Y=="function"){h.callback=null,p=h.priorityLevel;var H=Y(h.expirationTime<=U);U=r.unstable_now(),typeof H=="function"?h.callback=H:h===t(c)&&n(c),b(U)}else n(c);h=t(c)}if(h!==null)var ne=!0;else{var ye=t(l);ye!==null&&K(E,ye.startTime-U),ne=!1}return ne}finally{h=null,p=W,m=!1}}var k=!1,x=null,I=-1,T=5,L=-1;function z(){return!(r.unstable_now()-L<T)}function B(){if(x!==null){var O=r.unstable_now();L=O;var U=!0;try{U=x(!0,O)}finally{U?G():(k=!1,x=null)}}else k=!1}var G;if(typeof w=="function")G=function(){w(B)};else if(typeof MessageChannel<"u"){var j=new MessageChannel,q=j.port2;j.port1.onmessage=B,G=function(){q.postMessage(null)}}else G=function(){v(B,0)};function Q(O){x=O,k||(k=!0,G())}function K(O,U){I=v(function(){O(r.unstable_now())},U)}r.unstable_IdlePriority=5,r.unstable_ImmediatePriority=1,r.unstable_LowPriority=4,r.unstable_NormalPriority=3,r.unstable_Profiling=null,r.unstable_UserBlockingPriority=2,r.unstable_cancelCallback=function(O){O.callback=null},r.unstable_continueExecution=function(){f||m||(f=!0,Q(A))},r.unstable_forceFrameRate=function(O){0>O||125<O?console.error("forceFrameRate takes a positive int between 0 and 125, forcing frame rates higher than 125 fps is not supported"):T=0<O?Math.floor(1e3/O):5},r.unstable_getCurrentPriorityLevel=function(){return p},r.unstable_getFirstCallbackNode=function(){return t(c)},r.unstable_next=function(O){switch(p){case 1:case 2:case 3:var U=3;break;default:U=p}var W=p;p=U;try{return O()}finally{p=W}},r.unstable_pauseExecution=function(){},r.unstable_requestPaint=function(){},r.unstable_runWithPriority=function(O,U){switch(O){case 1:case 2:case 3:case 4:case 5:break;default:O=3}var W=p;p=O;try{return U()}finally{p=W}},r.unstable_scheduleCallback=function(O,U,W){var Y=r.unstable_now();switch(typeof W=="object"&&W!==null?(W=W.delay,W=typeof W=="number"&&0<W?Y+W:Y):W=Y,O){case 1:var H=-1;break;case 2:H=250;break;case 5:H=1073741823;break;case 4:H=1e4;break;default:H=5e3}return H=W+H,O={id:d++,callback:U,priorityLevel:O,startTime:W,expirationTime:H,sortIndex:-1},W>Y?(O.sortIndex=W,e(l,O),t(c)===null&&O===t(l)&&(g?(y(I),I=-1):g=!0,K(E,W-Y))):(O.sortIndex=H,e(c,O),f||m||(f=!0,Q(A))),O},r.unstable_shouldYield=z,r.unstable_wrapCallback=function(O){var U=p;return function(){var W=p;p=U;try{return O.apply(this,arguments)}finally{p=W}}}})(UM);BM.exports=UM;var Iq=BM.exports;/**
 * @license React
 * react-dom.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var kq=Qe,Zn=Iq;function ee(r){for(var e="https://reactjs.org/docs/error-decoder.html?invariant="+r,t=1;t<arguments.length;t++)e+="&args[]="+encodeURIComponent(arguments[t]);return"Minified React error #"+r+"; visit "+e+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}var FM=new Set,E1={};function fu(r,e){Od(r,e),Od(r+"Capture",e)}function Od(r,e){for(E1[r]=e,r=0;r<e.length;r++)FM.add(e[r])}var Ro=!(typeof window>"u"||typeof window.document>"u"||typeof window.document.createElement>"u"),t6=Object.prototype.hasOwnProperty,_q=/^[:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD][:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\-.0-9\u00B7\u0300-\u036F\u203F-\u2040]*$/,VA={},KA={};function Tq(r){return t6.call(KA,r)?!0:t6.call(VA,r)?!1:_q.test(r)?KA[r]=!0:(VA[r]=!0,!1)}function Pq(r,e,t,n){if(t!==null&&t.type===0)return!1;switch(typeof e){case"function":case"symbol":return!0;case"boolean":return n?!1:t!==null?!t.acceptsBooleans:(r=r.toLowerCase().slice(0,5),r!=="data-"&&r!=="aria-");default:return!1}}function Dq(r,e,t,n){if(e===null||typeof e>"u"||Pq(r,e,t,n))return!0;if(n)return!1;if(t!==null)switch(t.type){case 3:return!e;case 4:return e===!1;case 5:return isNaN(e);case 6:return isNaN(e)||1>e}return!1}function gn(r,e,t,n,i,s,o){this.acceptsBooleans=e===2||e===3||e===4,this.attributeName=n,this.attributeNamespace=i,this.mustUseProperty=t,this.propertyName=r,this.type=e,this.sanitizeURL=s,this.removeEmptyString=o}var Ar={};"children dangerouslySetInnerHTML defaultValue defaultChecked innerHTML suppressContentEditableWarning suppressHydrationWarning style".split(" ").forEach(function(r){Ar[r]=new gn(r,0,!1,r,null,!1,!1)});[["acceptCharset","accept-charset"],["className","class"],["htmlFor","for"],["httpEquiv","http-equiv"]].forEach(function(r){var e=r[0];Ar[e]=new gn(e,1,!1,r[1],null,!1,!1)});["contentEditable","draggable","spellCheck","value"].forEach(function(r){Ar[r]=new gn(r,2,!1,r.toLowerCase(),null,!1,!1)});["autoReverse","externalResourcesRequired","focusable","preserveAlpha"].forEach(function(r){Ar[r]=new gn(r,2,!1,r,null,!1,!1)});"allowFullScreen async autoFocus autoPlay controls default defer disabled disablePictureInPicture disableRemotePlayback formNoValidate hidden loop noModule noValidate open playsInline readOnly required reversed scoped seamless itemScope".split(" ").forEach(function(r){Ar[r]=new gn(r,3,!1,r.toLowerCase(),null,!1,!1)});["checked","multiple","muted","selected"].forEach(function(r){Ar[r]=new gn(r,3,!0,r,null,!1,!1)});["capture","download"].forEach(function(r){Ar[r]=new gn(r,4,!1,r,null,!1,!1)});["cols","rows","size","span"].forEach(function(r){Ar[r]=new gn(r,6,!1,r,null,!1,!1)});["rowSpan","start"].forEach(function(r){Ar[r]=new gn(r,5,!1,r.toLowerCase(),null,!1,!1)});var $9=/[\-:]([a-z])/g;function N9(r){return r[1].toUpperCase()}"accent-height alignment-baseline arabic-form baseline-shift cap-height clip-path clip-rule color-interpolation color-interpolation-filters color-profile color-rendering dominant-baseline enable-background fill-opacity fill-rule flood-color flood-opacity font-family font-size font-size-adjust font-stretch font-style font-variant font-weight glyph-name glyph-orientation-horizontal glyph-orientation-vertical horiz-adv-x horiz-origin-x image-rendering letter-spacing lighting-color marker-end marker-mid marker-start overline-position overline-thickness paint-order panose-1 pointer-events rendering-intent shape-rendering stop-color stop-opacity strikethrough-position strikethrough-thickness stroke-dasharray stroke-dashoffset stroke-linecap stroke-linejoin stroke-miterlimit stroke-opacity stroke-width text-anchor text-decoration text-rendering underline-position underline-thickness unicode-bidi unicode-range units-per-em v-alphabetic v-hanging v-ideographic v-mathematical vector-effect vert-adv-y vert-origin-x vert-origin-y word-spacing writing-mode xmlns:xlink x-height".split(" ").forEach(function(r){var e=r.replace($9,N9);Ar[e]=new gn(e,1,!1,r,null,!1,!1)});"xlink:actuate xlink:arcrole xlink:role xlink:show xlink:title xlink:type".split(" ").forEach(function(r){var e=r.replace($9,N9);Ar[e]=new gn(e,1,!1,r,"http://www.w3.org/1999/xlink",!1,!1)});["xml:base","xml:lang","xml:space"].forEach(function(r){var e=r.replace($9,N9);Ar[e]=new gn(e,1,!1,r,"http://www.w3.org/XML/1998/namespace",!1,!1)});["tabIndex","crossOrigin"].forEach(function(r){Ar[r]=new gn(r,1,!1,r.toLowerCase(),null,!1,!1)});Ar.xlinkHref=new gn("xlinkHref",1,!1,"xlink:href","http://www.w3.org/1999/xlink",!0,!1);["src","href","action","formAction"].forEach(function(r){Ar[r]=new gn(r,1,!1,r.toLowerCase(),null,!0,!0)});function M9(r,e,t,n){var i=Ar.hasOwnProperty(e)?Ar[e]:null;(i!==null?i.type!==0:n||!(2<e.length)||e[0]!=="o"&&e[0]!=="O"||e[1]!=="n"&&e[1]!=="N")&&(Dq(e,t,i,n)&&(t=null),n||i===null?Tq(e)&&(t===null?r.removeAttribute(e):r.setAttribute(e,""+t)):i.mustUseProperty?r[i.propertyName]=t===null?i.type===3?!1:"":t:(e=i.attributeName,n=i.attributeNamespace,t===null?r.removeAttribute(e):(i=i.type,t=i===3||i===4&&t===!0?"":""+t,n?r.setAttributeNS(n,e,t):r.setAttribute(e,t))))}var Qo=kq.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED,y0=Symbol.for("react.element"),Hu=Symbol.for("react.portal"),qu=Symbol.for("react.fragment"),O9=Symbol.for("react.strict_mode"),r6=Symbol.for("react.profiler"),zM=Symbol.for("react.provider"),VM=Symbol.for("react.context"),R9=Symbol.for("react.forward_ref"),n6=Symbol.for("react.suspense"),i6=Symbol.for("react.suspense_list"),L9=Symbol.for("react.memo"),Ia=Symbol.for("react.lazy"),KM=Symbol.for("react.offscreen"),jA=Symbol.iterator;function Jh(r){return r===null||typeof r!="object"?null:(r=jA&&r[jA]||r["@@iterator"],typeof r=="function"?r:null)}var Ft=Object.assign,j4;function Rf(r){if(j4===void 0)try{throw Error()}catch(t){var e=t.stack.trim().match(/\n( *(at )?)/);j4=e&&e[1]||""}return`
`+j4+r}var H4=!1;function q4(r,e){if(!r||H4)return"";H4=!0;var t=Error.prepareStackTrace;Error.prepareStackTrace=void 0;try{if(e)if(e=function(){throw Error()},Object.defineProperty(e.prototype,"props",{set:function(){throw Error()}}),typeof Reflect=="object"&&Reflect.construct){try{Reflect.construct(e,[])}catch(l){var n=l}Reflect.construct(r,[],e)}else{try{e.call()}catch(l){n=l}r.call(e.prototype)}else{try{throw Error()}catch(l){n=l}r()}}catch(l){if(l&&n&&typeof l.stack=="string"){for(var i=l.stack.split(`
`),s=n.stack.split(`
`),o=i.length-1,a=s.length-1;1<=o&&0<=a&&i[o]!==s[a];)a--;for(;1<=o&&0<=a;o--,a--)if(i[o]!==s[a]){if(o!==1||a!==1)do if(o--,a--,0>a||i[o]!==s[a]){var c=`
`+i[o].replace(" at new "," at ");return r.displayName&&c.includes("<anonymous>")&&(c=c.replace("<anonymous>",r.displayName)),c}while(1<=o&&0<=a);break}}}finally{H4=!1,Error.prepareStackTrace=t}return(r=r?r.displayName||r.name:"")?Rf(r):""}function $q(r){switch(r.tag){case 5:return Rf(r.type);case 16:return Rf("Lazy");case 13:return Rf("Suspense");case 19:return Rf("SuspenseList");case 0:case 2:case 15:return r=q4(r.type,!1),r;case 11:return r=q4(r.type.render,!1),r;case 1:return r=q4(r.type,!0),r;default:return""}}function s6(r){if(r==null)return null;if(typeof r=="function")return r.displayName||r.name||null;if(typeof r=="string")return r;switch(r){case qu:return"Fragment";case Hu:return"Portal";case r6:return"Profiler";case O9:return"StrictMode";case n6:return"Suspense";case i6:return"SuspenseList"}if(typeof r=="object")switch(r.$$typeof){case VM:return(r.displayName||"Context")+".Consumer";case zM:return(r._context.displayName||"Context")+".Provider";case R9:var e=r.render;return r=r.displayName,r||(r=e.displayName||e.name||"",r=r!==""?"ForwardRef("+r+")":"ForwardRef"),r;case L9:return e=r.displayName||null,e!==null?e:s6(r.type)||"Memo";case Ia:e=r._payload,r=r._init;try{return s6(r(e))}catch{}}return null}function Nq(r){var e=r.type;switch(r.tag){case 24:return"Cache";case 9:return(e.displayName||"Context")+".Consumer";case 10:return(e._context.displayName||"Context")+".Provider";case 18:return"DehydratedFragment";case 11:return r=e.render,r=r.displayName||r.name||"",e.displayName||(r!==""?"ForwardRef("+r+")":"ForwardRef");case 7:return"Fragment";case 5:return e;case 4:return"Portal";case 3:return"Root";case 6:return"Text";case 16:return s6(e);case 8:return e===O9?"StrictMode":"Mode";case 22:return"Offscreen";case 12:return"Profiler";case 21:return"Scope";case 13:return"Suspense";case 19:return"SuspenseList";case 25:return"TracingMarker";case 1:case 0:case 17:case 2:case 14:case 15:if(typeof e=="function")return e.displayName||e.name||null;if(typeof e=="string")return e}return null}function yc(r){switch(typeof r){case"boolean":case"number":case"string":case"undefined":return r;case"object":return r;default:return""}}function jM(r){var e=r.type;return(r=r.nodeName)&&r.toLowerCase()==="input"&&(e==="checkbox"||e==="radio")}function Mq(r){var e=jM(r)?"checked":"value",t=Object.getOwnPropertyDescriptor(r.constructor.prototype,e),n=""+r[e];if(!r.hasOwnProperty(e)&&typeof t<"u"&&typeof t.get=="function"&&typeof t.set=="function"){var i=t.get,s=t.set;return Object.defineProperty(r,e,{configurable:!0,get:function(){return i.call(this)},set:function(o){n=""+o,s.call(this,o)}}),Object.defineProperty(r,e,{enumerable:t.enumerable}),{getValue:function(){return n},setValue:function(o){n=""+o},stopTracking:function(){r._valueTracker=null,delete r[e]}}}}function m0(r){r._valueTracker||(r._valueTracker=Mq(r))}function HM(r){if(!r)return!1;var e=r._valueTracker;if(!e)return!0;var t=e.getValue(),n="";return r&&(n=jM(r)?r.checked?"true":"false":r.value),r=n,r!==t?(e.setValue(r),!0):!1}function w2(r){if(r=r||(typeof document<"u"?document:void 0),typeof r>"u")return null;try{return r.activeElement||r.body}catch{return r.body}}function o6(r,e){var t=e.checked;return Ft({},e,{defaultChecked:void 0,defaultValue:void 0,value:void 0,checked:t??r._wrapperState.initialChecked})}function HA(r,e){var t=e.defaultValue==null?"":e.defaultValue,n=e.checked!=null?e.checked:e.defaultChecked;t=yc(e.value!=null?e.value:t),r._wrapperState={initialChecked:n,initialValue:t,controlled:e.type==="checkbox"||e.type==="radio"?e.checked!=null:e.value!=null}}function qM(r,e){e=e.checked,e!=null&&M9(r,"checked",e,!1)}function a6(r,e){qM(r,e);var t=yc(e.value),n=e.type;if(t!=null)n==="number"?(t===0&&r.value===""||r.value!=t)&&(r.value=""+t):r.value!==""+t&&(r.value=""+t);else if(n==="submit"||n==="reset"){r.removeAttribute("value");return}e.hasOwnProperty("value")?c6(r,e.type,t):e.hasOwnProperty("defaultValue")&&c6(r,e.type,yc(e.defaultValue)),e.checked==null&&e.defaultChecked!=null&&(r.defaultChecked=!!e.defaultChecked)}function qA(r,e,t){if(e.hasOwnProperty("value")||e.hasOwnProperty("defaultValue")){var n=e.type;if(!(n!=="submit"&&n!=="reset"||e.value!==void 0&&e.value!==null))return;e=""+r._wrapperState.initialValue,t||e===r.value||(r.value=e),r.defaultValue=e}t=r.name,t!==""&&(r.name=""),r.defaultChecked=!!r._wrapperState.initialChecked,t!==""&&(r.name=t)}function c6(r,e,t){(e!=="number"||w2(r.ownerDocument)!==r)&&(t==null?r.defaultValue=""+r._wrapperState.initialValue:r.defaultValue!==""+t&&(r.defaultValue=""+t))}var Lf=Array.isArray;function cd(r,e,t,n){if(r=r.options,e){e={};for(var i=0;i<t.length;i++)e["$"+t[i]]=!0;for(t=0;t<r.length;t++)i=e.hasOwnProperty("$"+r[t].value),r[t].selected!==i&&(r[t].selected=i),i&&n&&(r[t].defaultSelected=!0)}else{for(t=""+yc(t),e=null,i=0;i<r.length;i++){if(r[i].value===t){r[i].selected=!0,n&&(r[i].defaultSelected=!0);return}e!==null||r[i].disabled||(e=r[i])}e!==null&&(e.selected=!0)}}function l6(r,e){if(e.dangerouslySetInnerHTML!=null)throw Error(ee(91));return Ft({},e,{value:void 0,defaultValue:void 0,children:""+r._wrapperState.initialValue})}function WA(r,e){var t=e.value;if(t==null){if(t=e.children,e=e.defaultValue,t!=null){if(e!=null)throw Error(ee(92));if(Lf(t)){if(1<t.length)throw Error(ee(93));t=t[0]}e=t}e==null&&(e=""),t=e}r._wrapperState={initialValue:yc(t)}}function WM(r,e){var t=yc(e.value),n=yc(e.defaultValue);t!=null&&(t=""+t,t!==r.value&&(r.value=t),e.defaultValue==null&&r.defaultValue!==t&&(r.defaultValue=t)),n!=null&&(r.defaultValue=""+n)}function GA(r){var e=r.textContent;e===r._wrapperState.initialValue&&e!==""&&e!==null&&(r.value=e)}function GM(r){switch(r){case"svg":return"http://www.w3.org/2000/svg";case"math":return"http://www.w3.org/1998/Math/MathML";default:return"http://www.w3.org/1999/xhtml"}}function u6(r,e){return r==null||r==="http://www.w3.org/1999/xhtml"?GM(e):r==="http://www.w3.org/2000/svg"&&e==="foreignObject"?"http://www.w3.org/1999/xhtml":r}var w0,QM=function(r){return typeof MSApp<"u"&&MSApp.execUnsafeLocalFunction?function(e,t,n,i){MSApp.execUnsafeLocalFunction(function(){return r(e,t,n,i)})}:r}(function(r,e){if(r.namespaceURI!=="http://www.w3.org/2000/svg"||"innerHTML"in r)r.innerHTML=e;else{for(w0=w0||document.createElement("div"),w0.innerHTML="<svg>"+e.valueOf().toString()+"</svg>",e=w0.firstChild;r.firstChild;)r.removeChild(r.firstChild);for(;e.firstChild;)r.appendChild(e.firstChild)}});function S1(r,e){if(e){var t=r.firstChild;if(t&&t===r.lastChild&&t.nodeType===3){t.nodeValue=e;return}}r.textContent=e}var Yf={animationIterationCount:!0,aspectRatio:!0,borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,columns:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridArea:!0,gridRow:!0,gridRowEnd:!0,gridRowSpan:!0,gridRowStart:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnSpan:!0,gridColumnStart:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},Oq=["Webkit","ms","Moz","O"];Object.keys(Yf).forEach(function(r){Oq.forEach(function(e){e=e+r.charAt(0).toUpperCase()+r.substring(1),Yf[e]=Yf[r]})});function YM(r,e,t){return e==null||typeof e=="boolean"||e===""?"":t||typeof e!="number"||e===0||Yf.hasOwnProperty(r)&&Yf[r]?(""+e).trim():e+"px"}function JM(r,e){r=r.style;for(var t in e)if(e.hasOwnProperty(t)){var n=t.indexOf("--")===0,i=YM(t,e[t],n);t==="float"&&(t="cssFloat"),n?r.setProperty(t,i):r[t]=i}}var Rq=Ft({menuitem:!0},{area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0});function d6(r,e){if(e){if(Rq[r]&&(e.children!=null||e.dangerouslySetInnerHTML!=null))throw Error(ee(137,r));if(e.dangerouslySetInnerHTML!=null){if(e.children!=null)throw Error(ee(60));if(typeof e.dangerouslySetInnerHTML!="object"||!("__html"in e.dangerouslySetInnerHTML))throw Error(ee(61))}if(e.style!=null&&typeof e.style!="object")throw Error(ee(62))}}function h6(r,e){if(r.indexOf("-")===-1)return typeof e.is=="string";switch(r){case"annotation-xml":case"color-profile":case"font-face":case"font-face-src":case"font-face-uri":case"font-face-format":case"font-face-name":case"missing-glyph":return!1;default:return!0}}var f6=null;function B9(r){return r=r.target||r.srcElement||window,r.correspondingUseElement&&(r=r.correspondingUseElement),r.nodeType===3?r.parentNode:r}var p6=null,ld=null,ud=null;function QA(r){if(r=_p(r)){if(typeof p6!="function")throw Error(ee(280));var e=r.stateNode;e&&(e=E3(e),p6(r.stateNode,r.type,e))}}function XM(r){ld?ud?ud.push(r):ud=[r]:ld=r}function ZM(){if(ld){var r=ld,e=ud;if(ud=ld=null,QA(r),e)for(r=0;r<e.length;r++)QA(e[r])}}function eO(r,e){return r(e)}function tO(){}var W4=!1;function rO(r,e,t){if(W4)return r(e,t);W4=!0;try{return eO(r,e,t)}finally{W4=!1,(ld!==null||ud!==null)&&(tO(),ZM())}}function x1(r,e){var t=r.stateNode;if(t===null)return null;var n=E3(t);if(n===null)return null;t=n[e];e:switch(e){case"onClick":case"onClickCapture":case"onDoubleClick":case"onDoubleClickCapture":case"onMouseDown":case"onMouseDownCapture":case"onMouseMove":case"onMouseMoveCapture":case"onMouseUp":case"onMouseUpCapture":case"onMouseEnter":(n=!n.disabled)||(r=r.type,n=!(r==="button"||r==="input"||r==="select"||r==="textarea")),r=!n;break e;default:r=!1}if(r)return null;if(t&&typeof t!="function")throw Error(ee(231,e,typeof t));return t}var g6=!1;if(Ro)try{var Xh={};Object.defineProperty(Xh,"passive",{get:function(){g6=!0}}),window.addEventListener("test",Xh,Xh),window.removeEventListener("test",Xh,Xh)}catch{g6=!1}function Lq(r,e,t,n,i,s,o,a,c){var l=Array.prototype.slice.call(arguments,3);try{e.apply(t,l)}catch(d){this.onError(d)}}var Jf=!1,b2=null,v2=!1,y6=null,Bq={onError:function(r){Jf=!0,b2=r}};function Uq(r,e,t,n,i,s,o,a,c){Jf=!1,b2=null,Lq.apply(Bq,arguments)}function Fq(r,e,t,n,i,s,o,a,c){if(Uq.apply(this,arguments),Jf){if(Jf){var l=b2;Jf=!1,b2=null}else throw Error(ee(198));v2||(v2=!0,y6=l)}}function pu(r){var e=r,t=r;if(r.alternate)for(;e.return;)e=e.return;else{r=e;do e=r,e.flags&4098&&(t=e.return),r=e.return;while(r)}return e.tag===3?t:null}function nO(r){if(r.tag===13){var e=r.memoizedState;if(e===null&&(r=r.alternate,r!==null&&(e=r.memoizedState)),e!==null)return e.dehydrated}return null}function YA(r){if(pu(r)!==r)throw Error(ee(188))}function zq(r){var e=r.alternate;if(!e){if(e=pu(r),e===null)throw Error(ee(188));return e!==r?null:r}for(var t=r,n=e;;){var i=t.return;if(i===null)break;var s=i.alternate;if(s===null){if(n=i.return,n!==null){t=n;continue}break}if(i.child===s.child){for(s=i.child;s;){if(s===t)return YA(i),r;if(s===n)return YA(i),e;s=s.sibling}throw Error(ee(188))}if(t.return!==n.return)t=i,n=s;else{for(var o=!1,a=i.child;a;){if(a===t){o=!0,t=i,n=s;break}if(a===n){o=!0,n=i,t=s;break}a=a.sibling}if(!o){for(a=s.child;a;){if(a===t){o=!0,t=s,n=i;break}if(a===n){o=!0,n=s,t=i;break}a=a.sibling}if(!o)throw Error(ee(189))}}if(t.alternate!==n)throw Error(ee(190))}if(t.tag!==3)throw Error(ee(188));return t.stateNode.current===t?r:e}function iO(r){return r=zq(r),r!==null?sO(r):null}function sO(r){if(r.tag===5||r.tag===6)return r;for(r=r.child;r!==null;){var e=sO(r);if(e!==null)return e;r=r.sibling}return null}var oO=Zn.unstable_scheduleCallback,JA=Zn.unstable_cancelCallback,Vq=Zn.unstable_shouldYield,Kq=Zn.unstable_requestPaint,qt=Zn.unstable_now,jq=Zn.unstable_getCurrentPriorityLevel,U9=Zn.unstable_ImmediatePriority,aO=Zn.unstable_UserBlockingPriority,E2=Zn.unstable_NormalPriority,Hq=Zn.unstable_LowPriority,cO=Zn.unstable_IdlePriority,m3=null,Us=null;function qq(r){if(Us&&typeof Us.onCommitFiberRoot=="function")try{Us.onCommitFiberRoot(m3,r,void 0,(r.current.flags&128)===128)}catch{}}var os=Math.clz32?Math.clz32:Qq,Wq=Math.log,Gq=Math.LN2;function Qq(r){return r>>>=0,r===0?32:31-(Wq(r)/Gq|0)|0}var b0=64,v0=4194304;function Bf(r){switch(r&-r){case 1:return 1;case 2:return 2;case 4:return 4;case 8:return 8;case 16:return 16;case 32:return 32;case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return r&4194240;case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:return r&130023424;case 134217728:return 134217728;case 268435456:return 268435456;case 536870912:return 536870912;case 1073741824:return 1073741824;default:return r}}function S2(r,e){var t=r.pendingLanes;if(t===0)return 0;var n=0,i=r.suspendedLanes,s=r.pingedLanes,o=t&268435455;if(o!==0){var a=o&~i;a!==0?n=Bf(a):(s&=o,s!==0&&(n=Bf(s)))}else o=t&~i,o!==0?n=Bf(o):s!==0&&(n=Bf(s));if(n===0)return 0;if(e!==0&&e!==n&&!(e&i)&&(i=n&-n,s=e&-e,i>=s||i===16&&(s&4194240)!==0))return e;if(n&4&&(n|=t&16),e=r.entangledLanes,e!==0)for(r=r.entanglements,e&=n;0<e;)t=31-os(e),i=1<<t,n|=r[t],e&=~i;return n}function Yq(r,e){switch(r){case 1:case 2:case 4:return e+250;case 8:case 16:case 32:case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return e+5e3;case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:return-1;case 134217728:case 268435456:case 536870912:case 1073741824:return-1;default:return-1}}function Jq(r,e){for(var t=r.suspendedLanes,n=r.pingedLanes,i=r.expirationTimes,s=r.pendingLanes;0<s;){var o=31-os(s),a=1<<o,c=i[o];c===-1?(!(a&t)||a&n)&&(i[o]=Yq(a,e)):c<=e&&(r.expiredLanes|=a),s&=~a}}function m6(r){return r=r.pendingLanes&-1073741825,r!==0?r:r&1073741824?1073741824:0}function lO(){var r=b0;return b0<<=1,!(b0&4194240)&&(b0=64),r}function G4(r){for(var e=[],t=0;31>t;t++)e.push(r);return e}function Ip(r,e,t){r.pendingLanes|=e,e!==536870912&&(r.suspendedLanes=0,r.pingedLanes=0),r=r.eventTimes,e=31-os(e),r[e]=t}function Xq(r,e){var t=r.pendingLanes&~e;r.pendingLanes=e,r.suspendedLanes=0,r.pingedLanes=0,r.expiredLanes&=e,r.mutableReadLanes&=e,r.entangledLanes&=e,e=r.entanglements;var n=r.eventTimes;for(r=r.expirationTimes;0<t;){var i=31-os(t),s=1<<i;e[i]=0,n[i]=-1,r[i]=-1,t&=~s}}function F9(r,e){var t=r.entangledLanes|=e;for(r=r.entanglements;t;){var n=31-os(t),i=1<<n;i&e|r[n]&e&&(r[n]|=e),t&=~i}}var ht=0;function uO(r){return r&=-r,1<r?4<r?r&268435455?16:536870912:4:1}var dO,z9,hO,fO,pO,w6=!1,E0=[],ec=null,tc=null,rc=null,A1=new Map,C1=new Map,Ua=[],Zq="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput copy cut paste click change contextmenu reset submit".split(" ");function XA(r,e){switch(r){case"focusin":case"focusout":ec=null;break;case"dragenter":case"dragleave":tc=null;break;case"mouseover":case"mouseout":rc=null;break;case"pointerover":case"pointerout":A1.delete(e.pointerId);break;case"gotpointercapture":case"lostpointercapture":C1.delete(e.pointerId)}}function Zh(r,e,t,n,i,s){return r===null||r.nativeEvent!==s?(r={blockedOn:e,domEventName:t,eventSystemFlags:n,nativeEvent:s,targetContainers:[i]},e!==null&&(e=_p(e),e!==null&&z9(e)),r):(r.eventSystemFlags|=n,e=r.targetContainers,i!==null&&e.indexOf(i)===-1&&e.push(i),r)}function eW(r,e,t,n,i){switch(e){case"focusin":return ec=Zh(ec,r,e,t,n,i),!0;case"dragenter":return tc=Zh(tc,r,e,t,n,i),!0;case"mouseover":return rc=Zh(rc,r,e,t,n,i),!0;case"pointerover":var s=i.pointerId;return A1.set(s,Zh(A1.get(s)||null,r,e,t,n,i)),!0;case"gotpointercapture":return s=i.pointerId,C1.set(s,Zh(C1.get(s)||null,r,e,t,n,i)),!0}return!1}function gO(r){var e=fl(r.target);if(e!==null){var t=pu(e);if(t!==null){if(e=t.tag,e===13){if(e=nO(t),e!==null){r.blockedOn=e,pO(r.priority,function(){hO(t)});return}}else if(e===3&&t.stateNode.current.memoizedState.isDehydrated){r.blockedOn=t.tag===3?t.stateNode.containerInfo:null;return}}}r.blockedOn=null}function kg(r){if(r.blockedOn!==null)return!1;for(var e=r.targetContainers;0<e.length;){var t=b6(r.domEventName,r.eventSystemFlags,e[0],r.nativeEvent);if(t===null){t=r.nativeEvent;var n=new t.constructor(t.type,t);f6=n,t.target.dispatchEvent(n),f6=null}else return e=_p(t),e!==null&&z9(e),r.blockedOn=t,!1;e.shift()}return!0}function ZA(r,e,t){kg(r)&&t.delete(e)}function tW(){w6=!1,ec!==null&&kg(ec)&&(ec=null),tc!==null&&kg(tc)&&(tc=null),rc!==null&&kg(rc)&&(rc=null),A1.forEach(ZA),C1.forEach(ZA)}function ef(r,e){r.blockedOn===e&&(r.blockedOn=null,w6||(w6=!0,Zn.unstable_scheduleCallback(Zn.unstable_NormalPriority,tW)))}function I1(r){function e(i){return ef(i,r)}if(0<E0.length){ef(E0[0],r);for(var t=1;t<E0.length;t++){var n=E0[t];n.blockedOn===r&&(n.blockedOn=null)}}for(ec!==null&&ef(ec,r),tc!==null&&ef(tc,r),rc!==null&&ef(rc,r),A1.forEach(e),C1.forEach(e),t=0;t<Ua.length;t++)n=Ua[t],n.blockedOn===r&&(n.blockedOn=null);for(;0<Ua.length&&(t=Ua[0],t.blockedOn===null);)gO(t),t.blockedOn===null&&Ua.shift()}var dd=Qo.ReactCurrentBatchConfig,x2=!0;function rW(r,e,t,n){var i=ht,s=dd.transition;dd.transition=null;try{ht=1,V9(r,e,t,n)}finally{ht=i,dd.transition=s}}function nW(r,e,t,n){var i=ht,s=dd.transition;dd.transition=null;try{ht=4,V9(r,e,t,n)}finally{ht=i,dd.transition=s}}function V9(r,e,t,n){if(x2){var i=b6(r,e,t,n);if(i===null)i5(r,e,n,A2,t),XA(r,n);else if(eW(i,r,e,t,n))n.stopPropagation();else if(XA(r,n),e&4&&-1<Zq.indexOf(r)){for(;i!==null;){var s=_p(i);if(s!==null&&dO(s),s=b6(r,e,t,n),s===null&&i5(r,e,n,A2,t),s===i)break;i=s}i!==null&&n.stopPropagation()}else i5(r,e,n,null,t)}}var A2=null;function b6(r,e,t,n){if(A2=null,r=B9(n),r=fl(r),r!==null)if(e=pu(r),e===null)r=null;else if(t=e.tag,t===13){if(r=nO(e),r!==null)return r;r=null}else if(t===3){if(e.stateNode.current.memoizedState.isDehydrated)return e.tag===3?e.stateNode.containerInfo:null;r=null}else e!==r&&(r=null);return A2=r,null}function yO(r){switch(r){case"cancel":case"click":case"close":case"contextmenu":case"copy":case"cut":case"auxclick":case"dblclick":case"dragend":case"dragstart":case"drop":case"focusin":case"focusout":case"input":case"invalid":case"keydown":case"keypress":case"keyup":case"mousedown":case"mouseup":case"paste":case"pause":case"play":case"pointercancel":case"pointerdown":case"pointerup":case"ratechange":case"reset":case"resize":case"seeked":case"submit":case"touchcancel":case"touchend":case"touchstart":case"volumechange":case"change":case"selectionchange":case"textInput":case"compositionstart":case"compositionend":case"compositionupdate":case"beforeblur":case"afterblur":case"beforeinput":case"blur":case"fullscreenchange":case"focus":case"hashchange":case"popstate":case"select":case"selectstart":return 1;case"drag":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"mousemove":case"mouseout":case"mouseover":case"pointermove":case"pointerout":case"pointerover":case"scroll":case"toggle":case"touchmove":case"wheel":case"mouseenter":case"mouseleave":case"pointerenter":case"pointerleave":return 4;case"message":switch(jq()){case U9:return 1;case aO:return 4;case E2:case Hq:return 16;case cO:return 536870912;default:return 16}default:return 16}}var qa=null,K9=null,_g=null;function mO(){if(_g)return _g;var r,e=K9,t=e.length,n,i="value"in qa?qa.value:qa.textContent,s=i.length;for(r=0;r<t&&e[r]===i[r];r++);var o=t-r;for(n=1;n<=o&&e[t-n]===i[s-n];n++);return _g=i.slice(r,1<n?1-n:void 0)}function Tg(r){var e=r.keyCode;return"charCode"in r?(r=r.charCode,r===0&&e===13&&(r=13)):r=e,r===10&&(r=13),32<=r||r===13?r:0}function S0(){return!0}function eC(){return!1}function ni(r){function e(t,n,i,s,o){this._reactName=t,this._targetInst=i,this.type=n,this.nativeEvent=s,this.target=o,this.currentTarget=null;for(var a in r)r.hasOwnProperty(a)&&(t=r[a],this[a]=t?t(s):s[a]);return this.isDefaultPrevented=(s.defaultPrevented!=null?s.defaultPrevented:s.returnValue===!1)?S0:eC,this.isPropagationStopped=eC,this}return Ft(e.prototype,{preventDefault:function(){this.defaultPrevented=!0;var t=this.nativeEvent;t&&(t.preventDefault?t.preventDefault():typeof t.returnValue!="unknown"&&(t.returnValue=!1),this.isDefaultPrevented=S0)},stopPropagation:function(){var t=this.nativeEvent;t&&(t.stopPropagation?t.stopPropagation():typeof t.cancelBubble!="unknown"&&(t.cancelBubble=!0),this.isPropagationStopped=S0)},persist:function(){},isPersistent:S0}),e}var Ch={eventPhase:0,bubbles:0,cancelable:0,timeStamp:function(r){return r.timeStamp||Date.now()},defaultPrevented:0,isTrusted:0},j9=ni(Ch),kp=Ft({},Ch,{view:0,detail:0}),iW=ni(kp),Q4,Y4,tf,w3=Ft({},kp,{screenX:0,screenY:0,clientX:0,clientY:0,pageX:0,pageY:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,getModifierState:H9,button:0,buttons:0,relatedTarget:function(r){return r.relatedTarget===void 0?r.fromElement===r.srcElement?r.toElement:r.fromElement:r.relatedTarget},movementX:function(r){return"movementX"in r?r.movementX:(r!==tf&&(tf&&r.type==="mousemove"?(Q4=r.screenX-tf.screenX,Y4=r.screenY-tf.screenY):Y4=Q4=0,tf=r),Q4)},movementY:function(r){return"movementY"in r?r.movementY:Y4}}),tC=ni(w3),sW=Ft({},w3,{dataTransfer:0}),oW=ni(sW),aW=Ft({},kp,{relatedTarget:0}),J4=ni(aW),cW=Ft({},Ch,{animationName:0,elapsedTime:0,pseudoElement:0}),lW=ni(cW),uW=Ft({},Ch,{clipboardData:function(r){return"clipboardData"in r?r.clipboardData:window.clipboardData}}),dW=ni(uW),hW=Ft({},Ch,{data:0}),rC=ni(hW),fW={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},pW={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",224:"Meta"},gW={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"};function yW(r){var e=this.nativeEvent;return e.getModifierState?e.getModifierState(r):(r=gW[r])?!!e[r]:!1}function H9(){return yW}var mW=Ft({},kp,{key:function(r){if(r.key){var e=fW[r.key]||r.key;if(e!=="Unidentified")return e}return r.type==="keypress"?(r=Tg(r),r===13?"Enter":String.fromCharCode(r)):r.type==="keydown"||r.type==="keyup"?pW[r.keyCode]||"Unidentified":""},code:0,location:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,repeat:0,locale:0,getModifierState:H9,charCode:function(r){return r.type==="keypress"?Tg(r):0},keyCode:function(r){return r.type==="keydown"||r.type==="keyup"?r.keyCode:0},which:function(r){return r.type==="keypress"?Tg(r):r.type==="keydown"||r.type==="keyup"?r.keyCode:0}}),wW=ni(mW),bW=Ft({},w3,{pointerId:0,width:0,height:0,pressure:0,tangentialPressure:0,tiltX:0,tiltY:0,twist:0,pointerType:0,isPrimary:0}),nC=ni(bW),vW=Ft({},kp,{touches:0,targetTouches:0,changedTouches:0,altKey:0,metaKey:0,ctrlKey:0,shiftKey:0,getModifierState:H9}),EW=ni(vW),SW=Ft({},Ch,{propertyName:0,elapsedTime:0,pseudoElement:0}),xW=ni(SW),AW=Ft({},w3,{deltaX:function(r){return"deltaX"in r?r.deltaX:"wheelDeltaX"in r?-r.wheelDeltaX:0},deltaY:function(r){return"deltaY"in r?r.deltaY:"wheelDeltaY"in r?-r.wheelDeltaY:"wheelDelta"in r?-r.wheelDelta:0},deltaZ:0,deltaMode:0}),CW=ni(AW),IW=[9,13,27,32],q9=Ro&&"CompositionEvent"in window,Xf=null;Ro&&"documentMode"in document&&(Xf=document.documentMode);var kW=Ro&&"TextEvent"in window&&!Xf,wO=Ro&&(!q9||Xf&&8<Xf&&11>=Xf),iC=" ",sC=!1;function bO(r,e){switch(r){case"keyup":return IW.indexOf(e.keyCode)!==-1;case"keydown":return e.keyCode!==229;case"keypress":case"mousedown":case"focusout":return!0;default:return!1}}function vO(r){return r=r.detail,typeof r=="object"&&"data"in r?r.data:null}var Wu=!1;function _W(r,e){switch(r){case"compositionend":return vO(e);case"keypress":return e.which!==32?null:(sC=!0,iC);case"textInput":return r=e.data,r===iC&&sC?null:r;default:return null}}function TW(r,e){if(Wu)return r==="compositionend"||!q9&&bO(r,e)?(r=mO(),_g=K9=qa=null,Wu=!1,r):null;switch(r){case"paste":return null;case"keypress":if(!(e.ctrlKey||e.altKey||e.metaKey)||e.ctrlKey&&e.altKey){if(e.char&&1<e.char.length)return e.char;if(e.which)return String.fromCharCode(e.which)}return null;case"compositionend":return wO&&e.locale!=="ko"?null:e.data;default:return null}}var PW={color:!0,date:!0,datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0};function oC(r){var e=r&&r.nodeName&&r.nodeName.toLowerCase();return e==="input"?!!PW[r.type]:e==="textarea"}function EO(r,e,t,n){XM(n),e=C2(e,"onChange"),0<e.length&&(t=new j9("onChange","change",null,t,n),r.push({event:t,listeners:e}))}var Zf=null,k1=null;function DW(r){$O(r,0)}function b3(r){var e=Yu(r);if(HM(e))return r}function $W(r,e){if(r==="change")return e}var SO=!1;if(Ro){var X4;if(Ro){var Z4="oninput"in document;if(!Z4){var aC=document.createElement("div");aC.setAttribute("oninput","return;"),Z4=typeof aC.oninput=="function"}X4=Z4}else X4=!1;SO=X4&&(!document.documentMode||9<document.documentMode)}function cC(){Zf&&(Zf.detachEvent("onpropertychange",xO),k1=Zf=null)}function xO(r){if(r.propertyName==="value"&&b3(k1)){var e=[];EO(e,k1,r,B9(r)),rO(DW,e)}}function NW(r,e,t){r==="focusin"?(cC(),Zf=e,k1=t,Zf.attachEvent("onpropertychange",xO)):r==="focusout"&&cC()}function MW(r){if(r==="selectionchange"||r==="keyup"||r==="keydown")return b3(k1)}function OW(r,e){if(r==="click")return b3(e)}function RW(r,e){if(r==="input"||r==="change")return b3(e)}function LW(r,e){return r===e&&(r!==0||1/r===1/e)||r!==r&&e!==e}var hs=typeof Object.is=="function"?Object.is:LW;function _1(r,e){if(hs(r,e))return!0;if(typeof r!="object"||r===null||typeof e!="object"||e===null)return!1;var t=Object.keys(r),n=Object.keys(e);if(t.length!==n.length)return!1;for(n=0;n<t.length;n++){var i=t[n];if(!t6.call(e,i)||!hs(r[i],e[i]))return!1}return!0}function lC(r){for(;r&&r.firstChild;)r=r.firstChild;return r}function uC(r,e){var t=lC(r);r=0;for(var n;t;){if(t.nodeType===3){if(n=r+t.textContent.length,r<=e&&n>=e)return{node:t,offset:e-r};r=n}e:{for(;t;){if(t.nextSibling){t=t.nextSibling;break e}t=t.parentNode}t=void 0}t=lC(t)}}function AO(r,e){return r&&e?r===e?!0:r&&r.nodeType===3?!1:e&&e.nodeType===3?AO(r,e.parentNode):"contains"in r?r.contains(e):r.compareDocumentPosition?!!(r.compareDocumentPosition(e)&16):!1:!1}function CO(){for(var r=window,e=w2();e instanceof r.HTMLIFrameElement;){try{var t=typeof e.contentWindow.location.href=="string"}catch{t=!1}if(t)r=e.contentWindow;else break;e=w2(r.document)}return e}function W9(r){var e=r&&r.nodeName&&r.nodeName.toLowerCase();return e&&(e==="input"&&(r.type==="text"||r.type==="search"||r.type==="tel"||r.type==="url"||r.type==="password")||e==="textarea"||r.contentEditable==="true")}function BW(r){var e=CO(),t=r.focusedElem,n=r.selectionRange;if(e!==t&&t&&t.ownerDocument&&AO(t.ownerDocument.documentElement,t)){if(n!==null&&W9(t)){if(e=n.start,r=n.end,r===void 0&&(r=e),"selectionStart"in t)t.selectionStart=e,t.selectionEnd=Math.min(r,t.value.length);else if(r=(e=t.ownerDocument||document)&&e.defaultView||window,r.getSelection){r=r.getSelection();var i=t.textContent.length,s=Math.min(n.start,i);n=n.end===void 0?s:Math.min(n.end,i),!r.extend&&s>n&&(i=n,n=s,s=i),i=uC(t,s);var o=uC(t,n);i&&o&&(r.rangeCount!==1||r.anchorNode!==i.node||r.anchorOffset!==i.offset||r.focusNode!==o.node||r.focusOffset!==o.offset)&&(e=e.createRange(),e.setStart(i.node,i.offset),r.removeAllRanges(),s>n?(r.addRange(e),r.extend(o.node,o.offset)):(e.setEnd(o.node,o.offset),r.addRange(e)))}}for(e=[],r=t;r=r.parentNode;)r.nodeType===1&&e.push({element:r,left:r.scrollLeft,top:r.scrollTop});for(typeof t.focus=="function"&&t.focus(),t=0;t<e.length;t++)r=e[t],r.element.scrollLeft=r.left,r.element.scrollTop=r.top}}var UW=Ro&&"documentMode"in document&&11>=document.documentMode,Gu=null,v6=null,e1=null,E6=!1;function dC(r,e,t){var n=t.window===t?t.document:t.nodeType===9?t:t.ownerDocument;E6||Gu==null||Gu!==w2(n)||(n=Gu,"selectionStart"in n&&W9(n)?n={start:n.selectionStart,end:n.selectionEnd}:(n=(n.ownerDocument&&n.ownerDocument.defaultView||window).getSelection(),n={anchorNode:n.anchorNode,anchorOffset:n.anchorOffset,focusNode:n.focusNode,focusOffset:n.focusOffset}),e1&&_1(e1,n)||(e1=n,n=C2(v6,"onSelect"),0<n.length&&(e=new j9("onSelect","select",null,e,t),r.push({event:e,listeners:n}),e.target=Gu)))}function x0(r,e){var t={};return t[r.toLowerCase()]=e.toLowerCase(),t["Webkit"+r]="webkit"+e,t["Moz"+r]="moz"+e,t}var Qu={animationend:x0("Animation","AnimationEnd"),animationiteration:x0("Animation","AnimationIteration"),animationstart:x0("Animation","AnimationStart"),transitionend:x0("Transition","TransitionEnd")},e5={},IO={};Ro&&(IO=document.createElement("div").style,"AnimationEvent"in window||(delete Qu.animationend.animation,delete Qu.animationiteration.animation,delete Qu.animationstart.animation),"TransitionEvent"in window||delete Qu.transitionend.transition);function v3(r){if(e5[r])return e5[r];if(!Qu[r])return r;var e=Qu[r],t;for(t in e)if(e.hasOwnProperty(t)&&t in IO)return e5[r]=e[t];return r}var kO=v3("animationend"),_O=v3("animationiteration"),TO=v3("animationstart"),PO=v3("transitionend"),DO=new Map,hC="abort auxClick cancel canPlay canPlayThrough click close contextMenu copy cut drag dragEnd dragEnter dragExit dragLeave dragOver dragStart drop durationChange emptied encrypted ended error gotPointerCapture input invalid keyDown keyPress keyUp load loadedData loadedMetadata loadStart lostPointerCapture mouseDown mouseMove mouseOut mouseOver mouseUp paste pause play playing pointerCancel pointerDown pointerMove pointerOut pointerOver pointerUp progress rateChange reset resize seeked seeking stalled submit suspend timeUpdate touchCancel touchEnd touchStart volumeChange scroll toggle touchMove waiting wheel".split(" ");function Mc(r,e){DO.set(r,e),fu(e,[r])}for(var t5=0;t5<hC.length;t5++){var r5=hC[t5],FW=r5.toLowerCase(),zW=r5[0].toUpperCase()+r5.slice(1);Mc(FW,"on"+zW)}Mc(kO,"onAnimationEnd");Mc(_O,"onAnimationIteration");Mc(TO,"onAnimationStart");Mc("dblclick","onDoubleClick");Mc("focusin","onFocus");Mc("focusout","onBlur");Mc(PO,"onTransitionEnd");Od("onMouseEnter",["mouseout","mouseover"]);Od("onMouseLeave",["mouseout","mouseover"]);Od("onPointerEnter",["pointerout","pointerover"]);Od("onPointerLeave",["pointerout","pointerover"]);fu("onChange","change click focusin focusout input keydown keyup selectionchange".split(" "));fu("onSelect","focusout contextmenu dragend focusin keydown keyup mousedown mouseup selectionchange".split(" "));fu("onBeforeInput",["compositionend","keypress","textInput","paste"]);fu("onCompositionEnd","compositionend focusout keydown keypress keyup mousedown".split(" "));fu("onCompositionStart","compositionstart focusout keydown keypress keyup mousedown".split(" "));fu("onCompositionUpdate","compositionupdate focusout keydown keypress keyup mousedown".split(" "));var Uf="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange resize seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),VW=new Set("cancel close invalid load scroll toggle".split(" ").concat(Uf));function fC(r,e,t){var n=r.type||"unknown-event";r.currentTarget=t,Fq(n,e,void 0,r),r.currentTarget=null}function $O(r,e){e=(e&4)!==0;for(var t=0;t<r.length;t++){var n=r[t],i=n.event;n=n.listeners;e:{var s=void 0;if(e)for(var o=n.length-1;0<=o;o--){var a=n[o],c=a.instance,l=a.currentTarget;if(a=a.listener,c!==s&&i.isPropagationStopped())break e;fC(i,a,l),s=c}else for(o=0;o<n.length;o++){if(a=n[o],c=a.instance,l=a.currentTarget,a=a.listener,c!==s&&i.isPropagationStopped())break e;fC(i,a,l),s=c}}}if(v2)throw r=y6,v2=!1,y6=null,r}function Tt(r,e){var t=e[I6];t===void 0&&(t=e[I6]=new Set);var n=r+"__bubble";t.has(n)||(NO(e,r,2,!1),t.add(n))}function n5(r,e,t){var n=0;e&&(n|=4),NO(t,r,n,e)}var A0="_reactListening"+Math.random().toString(36).slice(2);function T1(r){if(!r[A0]){r[A0]=!0,FM.forEach(function(t){t!=="selectionchange"&&(VW.has(t)||n5(t,!1,r),n5(t,!0,r))});var e=r.nodeType===9?r:r.ownerDocument;e===null||e[A0]||(e[A0]=!0,n5("selectionchange",!1,e))}}function NO(r,e,t,n){switch(yO(e)){case 1:var i=rW;break;case 4:i=nW;break;default:i=V9}t=i.bind(null,e,t,r),i=void 0,!g6||e!=="touchstart"&&e!=="touchmove"&&e!=="wheel"||(i=!0),n?i!==void 0?r.addEventListener(e,t,{capture:!0,passive:i}):r.addEventListener(e,t,!0):i!==void 0?r.addEventListener(e,t,{passive:i}):r.addEventListener(e,t,!1)}function i5(r,e,t,n,i){var s=n;if(!(e&1)&&!(e&2)&&n!==null)e:for(;;){if(n===null)return;var o=n.tag;if(o===3||o===4){var a=n.stateNode.containerInfo;if(a===i||a.nodeType===8&&a.parentNode===i)break;if(o===4)for(o=n.return;o!==null;){var c=o.tag;if((c===3||c===4)&&(c=o.stateNode.containerInfo,c===i||c.nodeType===8&&c.parentNode===i))return;o=o.return}for(;a!==null;){if(o=fl(a),o===null)return;if(c=o.tag,c===5||c===6){n=s=o;continue e}a=a.parentNode}}n=n.return}rO(function(){var l=s,d=B9(t),h=[];e:{var p=DO.get(r);if(p!==void 0){var m=j9,f=r;switch(r){case"keypress":if(Tg(t)===0)break e;case"keydown":case"keyup":m=wW;break;case"focusin":f="focus",m=J4;break;case"focusout":f="blur",m=J4;break;case"beforeblur":case"afterblur":m=J4;break;case"click":if(t.button===2)break e;case"auxclick":case"dblclick":case"mousedown":case"mousemove":case"mouseup":case"mouseout":case"mouseover":case"contextmenu":m=tC;break;case"drag":case"dragend":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"dragstart":case"drop":m=oW;break;case"touchcancel":case"touchend":case"touchmove":case"touchstart":m=EW;break;case kO:case _O:case TO:m=lW;break;case PO:m=xW;break;case"scroll":m=iW;break;case"wheel":m=CW;break;case"copy":case"cut":case"paste":m=dW;break;case"gotpointercapture":case"lostpointercapture":case"pointercancel":case"pointerdown":case"pointermove":case"pointerout":case"pointerover":case"pointerup":m=nC}var g=(e&4)!==0,v=!g&&r==="scroll",y=g?p!==null?p+"Capture":null:p;g=[];for(var w=l,b;w!==null;){b=w;var E=b.stateNode;if(b.tag===5&&E!==null&&(b=E,y!==null&&(E=x1(w,y),E!=null&&g.push(P1(w,E,b)))),v)break;w=w.return}0<g.length&&(p=new m(p,f,null,t,d),h.push({event:p,listeners:g}))}}if(!(e&7)){e:{if(p=r==="mouseover"||r==="pointerover",m=r==="mouseout"||r==="pointerout",p&&t!==f6&&(f=t.relatedTarget||t.fromElement)&&(fl(f)||f[Lo]))break e;if((m||p)&&(p=d.window===d?d:(p=d.ownerDocument)?p.defaultView||p.parentWindow:window,m?(f=t.relatedTarget||t.toElement,m=l,f=f?fl(f):null,f!==null&&(v=pu(f),f!==v||f.tag!==5&&f.tag!==6)&&(f=null)):(m=null,f=l),m!==f)){if(g=tC,E="onMouseLeave",y="onMouseEnter",w="mouse",(r==="pointerout"||r==="pointerover")&&(g=nC,E="onPointerLeave",y="onPointerEnter",w="pointer"),v=m==null?p:Yu(m),b=f==null?p:Yu(f),p=new g(E,w+"leave",m,t,d),p.target=v,p.relatedTarget=b,E=null,fl(d)===l&&(g=new g(y,w+"enter",f,t,d),g.target=b,g.relatedTarget=v,E=g),v=E,m&&f)t:{for(g=m,y=f,w=0,b=g;b;b=Iu(b))w++;for(b=0,E=y;E;E=Iu(E))b++;for(;0<w-b;)g=Iu(g),w--;for(;0<b-w;)y=Iu(y),b--;for(;w--;){if(g===y||y!==null&&g===y.alternate)break t;g=Iu(g),y=Iu(y)}g=null}else g=null;m!==null&&pC(h,p,m,g,!1),f!==null&&v!==null&&pC(h,v,f,g,!0)}}e:{if(p=l?Yu(l):window,m=p.nodeName&&p.nodeName.toLowerCase(),m==="select"||m==="input"&&p.type==="file")var A=$W;else if(oC(p))if(SO)A=RW;else{A=MW;var k=NW}else(m=p.nodeName)&&m.toLowerCase()==="input"&&(p.type==="checkbox"||p.type==="radio")&&(A=OW);if(A&&(A=A(r,l))){EO(h,A,t,d);break e}k&&k(r,p,l),r==="focusout"&&(k=p._wrapperState)&&k.controlled&&p.type==="number"&&c6(p,"number",p.value)}switch(k=l?Yu(l):window,r){case"focusin":(oC(k)||k.contentEditable==="true")&&(Gu=k,v6=l,e1=null);break;case"focusout":e1=v6=Gu=null;break;case"mousedown":E6=!0;break;case"contextmenu":case"mouseup":case"dragend":E6=!1,dC(h,t,d);break;case"selectionchange":if(UW)break;case"keydown":case"keyup":dC(h,t,d)}var x;if(q9)e:{switch(r){case"compositionstart":var I="onCompositionStart";break e;case"compositionend":I="onCompositionEnd";break e;case"compositionupdate":I="onCompositionUpdate";break e}I=void 0}else Wu?bO(r,t)&&(I="onCompositionEnd"):r==="keydown"&&t.keyCode===229&&(I="onCompositionStart");I&&(wO&&t.locale!=="ko"&&(Wu||I!=="onCompositionStart"?I==="onCompositionEnd"&&Wu&&(x=mO()):(qa=d,K9="value"in qa?qa.value:qa.textContent,Wu=!0)),k=C2(l,I),0<k.length&&(I=new rC(I,r,null,t,d),h.push({event:I,listeners:k}),x?I.data=x:(x=vO(t),x!==null&&(I.data=x)))),(x=kW?_W(r,t):TW(r,t))&&(l=C2(l,"onBeforeInput"),0<l.length&&(d=new rC("onBeforeInput","beforeinput",null,t,d),h.push({event:d,listeners:l}),d.data=x))}$O(h,e)})}function P1(r,e,t){return{instance:r,listener:e,currentTarget:t}}function C2(r,e){for(var t=e+"Capture",n=[];r!==null;){var i=r,s=i.stateNode;i.tag===5&&s!==null&&(i=s,s=x1(r,t),s!=null&&n.unshift(P1(r,s,i)),s=x1(r,e),s!=null&&n.push(P1(r,s,i))),r=r.return}return n}function Iu(r){if(r===null)return null;do r=r.return;while(r&&r.tag!==5);return r||null}function pC(r,e,t,n,i){for(var s=e._reactName,o=[];t!==null&&t!==n;){var a=t,c=a.alternate,l=a.stateNode;if(c!==null&&c===n)break;a.tag===5&&l!==null&&(a=l,i?(c=x1(t,s),c!=null&&o.unshift(P1(t,c,a))):i||(c=x1(t,s),c!=null&&o.push(P1(t,c,a)))),t=t.return}o.length!==0&&r.push({event:e,listeners:o})}var KW=/\r\n?/g,jW=/\u0000|\uFFFD/g;function gC(r){return(typeof r=="string"?r:""+r).replace(KW,`
`).replace(jW,"")}function C0(r,e,t){if(e=gC(e),gC(r)!==e&&t)throw Error(ee(425))}function I2(){}var S6=null,x6=null;function A6(r,e){return r==="textarea"||r==="noscript"||typeof e.children=="string"||typeof e.children=="number"||typeof e.dangerouslySetInnerHTML=="object"&&e.dangerouslySetInnerHTML!==null&&e.dangerouslySetInnerHTML.__html!=null}var C6=typeof setTimeout=="function"?setTimeout:void 0,HW=typeof clearTimeout=="function"?clearTimeout:void 0,yC=typeof Promise=="function"?Promise:void 0,qW=typeof queueMicrotask=="function"?queueMicrotask:typeof yC<"u"?function(r){return yC.resolve(null).then(r).catch(WW)}:C6;function WW(r){setTimeout(function(){throw r})}function s5(r,e){var t=e,n=0;do{var i=t.nextSibling;if(r.removeChild(t),i&&i.nodeType===8)if(t=i.data,t==="/$"){if(n===0){r.removeChild(i),I1(e);return}n--}else t!=="$"&&t!=="$?"&&t!=="$!"||n++;t=i}while(t);I1(e)}function nc(r){for(;r!=null;r=r.nextSibling){var e=r.nodeType;if(e===1||e===3)break;if(e===8){if(e=r.data,e==="$"||e==="$!"||e==="$?")break;if(e==="/$")return null}}return r}function mC(r){r=r.previousSibling;for(var e=0;r;){if(r.nodeType===8){var t=r.data;if(t==="$"||t==="$!"||t==="$?"){if(e===0)return r;e--}else t==="/$"&&e++}r=r.previousSibling}return null}var Ih=Math.random().toString(36).slice(2),Rs="__reactFiber$"+Ih,D1="__reactProps$"+Ih,Lo="__reactContainer$"+Ih,I6="__reactEvents$"+Ih,GW="__reactListeners$"+Ih,QW="__reactHandles$"+Ih;function fl(r){var e=r[Rs];if(e)return e;for(var t=r.parentNode;t;){if(e=t[Lo]||t[Rs]){if(t=e.alternate,e.child!==null||t!==null&&t.child!==null)for(r=mC(r);r!==null;){if(t=r[Rs])return t;r=mC(r)}return e}r=t,t=r.parentNode}return null}function _p(r){return r=r[Rs]||r[Lo],!r||r.tag!==5&&r.tag!==6&&r.tag!==13&&r.tag!==3?null:r}function Yu(r){if(r.tag===5||r.tag===6)return r.stateNode;throw Error(ee(33))}function E3(r){return r[D1]||null}var k6=[],Ju=-1;function Oc(r){return{current:r}}function Pt(r){0>Ju||(r.current=k6[Ju],k6[Ju]=null,Ju--)}function Ct(r,e){Ju++,k6[Ju]=r.current,r.current=e}var mc={},en=Oc(mc),Tn=Oc(!1),Bl=mc;function Rd(r,e){var t=r.type.contextTypes;if(!t)return mc;var n=r.stateNode;if(n&&n.__reactInternalMemoizedUnmaskedChildContext===e)return n.__reactInternalMemoizedMaskedChildContext;var i={},s;for(s in t)i[s]=e[s];return n&&(r=r.stateNode,r.__reactInternalMemoizedUnmaskedChildContext=e,r.__reactInternalMemoizedMaskedChildContext=i),i}function Pn(r){return r=r.childContextTypes,r!=null}function k2(){Pt(Tn),Pt(en)}function wC(r,e,t){if(en.current!==mc)throw Error(ee(168));Ct(en,e),Ct(Tn,t)}function MO(r,e,t){var n=r.stateNode;if(e=e.childContextTypes,typeof n.getChildContext!="function")return t;n=n.getChildContext();for(var i in n)if(!(i in e))throw Error(ee(108,Nq(r)||"Unknown",i));return Ft({},t,n)}function _2(r){return r=(r=r.stateNode)&&r.__reactInternalMemoizedMergedChildContext||mc,Bl=en.current,Ct(en,r),Ct(Tn,Tn.current),!0}function bC(r,e,t){var n=r.stateNode;if(!n)throw Error(ee(169));t?(r=MO(r,e,Bl),n.__reactInternalMemoizedMergedChildContext=r,Pt(Tn),Pt(en),Ct(en,r)):Pt(Tn),Ct(Tn,t)}var yo=null,S3=!1,o5=!1;function OO(r){yo===null?yo=[r]:yo.push(r)}function YW(r){S3=!0,OO(r)}function Rc(){if(!o5&&yo!==null){o5=!0;var r=0,e=ht;try{var t=yo;for(ht=1;r<t.length;r++){var n=t[r];do n=n(!0);while(n!==null)}yo=null,S3=!1}catch(i){throw yo!==null&&(yo=yo.slice(r+1)),oO(U9,Rc),i}finally{ht=e,o5=!1}}return null}var Xu=[],Zu=0,T2=null,P2=0,bi=[],vi=0,Ul=null,Io=1,ko="";function nl(r,e){Xu[Zu++]=P2,Xu[Zu++]=T2,T2=r,P2=e}function RO(r,e,t){bi[vi++]=Io,bi[vi++]=ko,bi[vi++]=Ul,Ul=r;var n=Io;r=ko;var i=32-os(n)-1;n&=~(1<<i),t+=1;var s=32-os(e)+i;if(30<s){var o=i-i%5;s=(n&(1<<o)-1).toString(32),n>>=o,i-=o,Io=1<<32-os(e)+i|t<<i|n,ko=s+r}else Io=1<<s|t<<i|n,ko=r}function G9(r){r.return!==null&&(nl(r,1),RO(r,1,0))}function Q9(r){for(;r===T2;)T2=Xu[--Zu],Xu[Zu]=null,P2=Xu[--Zu],Xu[Zu]=null;for(;r===Ul;)Ul=bi[--vi],bi[vi]=null,ko=bi[--vi],bi[vi]=null,Io=bi[--vi],bi[vi]=null}var Xn=null,Jn=null,Nt=!1,ts=null;function LO(r,e){var t=Ai(5,null,null,0);t.elementType="DELETED",t.stateNode=e,t.return=r,e=r.deletions,e===null?(r.deletions=[t],r.flags|=16):e.push(t)}function vC(r,e){switch(r.tag){case 5:var t=r.type;return e=e.nodeType!==1||t.toLowerCase()!==e.nodeName.toLowerCase()?null:e,e!==null?(r.stateNode=e,Xn=r,Jn=nc(e.firstChild),!0):!1;case 6:return e=r.pendingProps===""||e.nodeType!==3?null:e,e!==null?(r.stateNode=e,Xn=r,Jn=null,!0):!1;case 13:return e=e.nodeType!==8?null:e,e!==null?(t=Ul!==null?{id:Io,overflow:ko}:null,r.memoizedState={dehydrated:e,treeContext:t,retryLane:1073741824},t=Ai(18,null,null,0),t.stateNode=e,t.return=r,r.child=t,Xn=r,Jn=null,!0):!1;default:return!1}}function _6(r){return(r.mode&1)!==0&&(r.flags&128)===0}function T6(r){if(Nt){var e=Jn;if(e){var t=e;if(!vC(r,e)){if(_6(r))throw Error(ee(418));e=nc(t.nextSibling);var n=Xn;e&&vC(r,e)?LO(n,t):(r.flags=r.flags&-4097|2,Nt=!1,Xn=r)}}else{if(_6(r))throw Error(ee(418));r.flags=r.flags&-4097|2,Nt=!1,Xn=r}}}function EC(r){for(r=r.return;r!==null&&r.tag!==5&&r.tag!==3&&r.tag!==13;)r=r.return;Xn=r}function I0(r){if(r!==Xn)return!1;if(!Nt)return EC(r),Nt=!0,!1;var e;if((e=r.tag!==3)&&!(e=r.tag!==5)&&(e=r.type,e=e!=="head"&&e!=="body"&&!A6(r.type,r.memoizedProps)),e&&(e=Jn)){if(_6(r))throw BO(),Error(ee(418));for(;e;)LO(r,e),e=nc(e.nextSibling)}if(EC(r),r.tag===13){if(r=r.memoizedState,r=r!==null?r.dehydrated:null,!r)throw Error(ee(317));e:{for(r=r.nextSibling,e=0;r;){if(r.nodeType===8){var t=r.data;if(t==="/$"){if(e===0){Jn=nc(r.nextSibling);break e}e--}else t!=="$"&&t!=="$!"&&t!=="$?"||e++}r=r.nextSibling}Jn=null}}else Jn=Xn?nc(r.stateNode.nextSibling):null;return!0}function BO(){for(var r=Jn;r;)r=nc(r.nextSibling)}function Ld(){Jn=Xn=null,Nt=!1}function Y9(r){ts===null?ts=[r]:ts.push(r)}var JW=Qo.ReactCurrentBatchConfig;function rf(r,e,t){if(r=t.ref,r!==null&&typeof r!="function"&&typeof r!="object"){if(t._owner){if(t=t._owner,t){if(t.tag!==1)throw Error(ee(309));var n=t.stateNode}if(!n)throw Error(ee(147,r));var i=n,s=""+r;return e!==null&&e.ref!==null&&typeof e.ref=="function"&&e.ref._stringRef===s?e.ref:(e=function(o){var a=i.refs;o===null?delete a[s]:a[s]=o},e._stringRef=s,e)}if(typeof r!="string")throw Error(ee(284));if(!t._owner)throw Error(ee(290,r))}return r}function k0(r,e){throw r=Object.prototype.toString.call(e),Error(ee(31,r==="[object Object]"?"object with keys {"+Object.keys(e).join(", ")+"}":r))}function SC(r){var e=r._init;return e(r._payload)}function UO(r){function e(y,w){if(r){var b=y.deletions;b===null?(y.deletions=[w],y.flags|=16):b.push(w)}}function t(y,w){if(!r)return null;for(;w!==null;)e(y,w),w=w.sibling;return null}function n(y,w){for(y=new Map;w!==null;)w.key!==null?y.set(w.key,w):y.set(w.index,w),w=w.sibling;return y}function i(y,w){return y=ac(y,w),y.index=0,y.sibling=null,y}function s(y,w,b){return y.index=b,r?(b=y.alternate,b!==null?(b=b.index,b<w?(y.flags|=2,w):b):(y.flags|=2,w)):(y.flags|=1048576,w)}function o(y){return r&&y.alternate===null&&(y.flags|=2),y}function a(y,w,b,E){return w===null||w.tag!==6?(w=f5(b,y.mode,E),w.return=y,w):(w=i(w,b),w.return=y,w)}function c(y,w,b,E){var A=b.type;return A===qu?d(y,w,b.props.children,E,b.key):w!==null&&(w.elementType===A||typeof A=="object"&&A!==null&&A.$$typeof===Ia&&SC(A)===w.type)?(E=i(w,b.props),E.ref=rf(y,w,b),E.return=y,E):(E=Rg(b.type,b.key,b.props,null,y.mode,E),E.ref=rf(y,w,b),E.return=y,E)}function l(y,w,b,E){return w===null||w.tag!==4||w.stateNode.containerInfo!==b.containerInfo||w.stateNode.implementation!==b.implementation?(w=p5(b,y.mode,E),w.return=y,w):(w=i(w,b.children||[]),w.return=y,w)}function d(y,w,b,E,A){return w===null||w.tag!==7?(w=Il(b,y.mode,E,A),w.return=y,w):(w=i(w,b),w.return=y,w)}function h(y,w,b){if(typeof w=="string"&&w!==""||typeof w=="number")return w=f5(""+w,y.mode,b),w.return=y,w;if(typeof w=="object"&&w!==null){switch(w.$$typeof){case y0:return b=Rg(w.type,w.key,w.props,null,y.mode,b),b.ref=rf(y,null,w),b.return=y,b;case Hu:return w=p5(w,y.mode,b),w.return=y,w;case Ia:var E=w._init;return h(y,E(w._payload),b)}if(Lf(w)||Jh(w))return w=Il(w,y.mode,b,null),w.return=y,w;k0(y,w)}return null}function p(y,w,b,E){var A=w!==null?w.key:null;if(typeof b=="string"&&b!==""||typeof b=="number")return A!==null?null:a(y,w,""+b,E);if(typeof b=="object"&&b!==null){switch(b.$$typeof){case y0:return b.key===A?c(y,w,b,E):null;case Hu:return b.key===A?l(y,w,b,E):null;case Ia:return A=b._init,p(y,w,A(b._payload),E)}if(Lf(b)||Jh(b))return A!==null?null:d(y,w,b,E,null);k0(y,b)}return null}function m(y,w,b,E,A){if(typeof E=="string"&&E!==""||typeof E=="number")return y=y.get(b)||null,a(w,y,""+E,A);if(typeof E=="object"&&E!==null){switch(E.$$typeof){case y0:return y=y.get(E.key===null?b:E.key)||null,c(w,y,E,A);case Hu:return y=y.get(E.key===null?b:E.key)||null,l(w,y,E,A);case Ia:var k=E._init;return m(y,w,b,k(E._payload),A)}if(Lf(E)||Jh(E))return y=y.get(b)||null,d(w,y,E,A,null);k0(w,E)}return null}function f(y,w,b,E){for(var A=null,k=null,x=w,I=w=0,T=null;x!==null&&I<b.length;I++){x.index>I?(T=x,x=null):T=x.sibling;var L=p(y,x,b[I],E);if(L===null){x===null&&(x=T);break}r&&x&&L.alternate===null&&e(y,x),w=s(L,w,I),k===null?A=L:k.sibling=L,k=L,x=T}if(I===b.length)return t(y,x),Nt&&nl(y,I),A;if(x===null){for(;I<b.length;I++)x=h(y,b[I],E),x!==null&&(w=s(x,w,I),k===null?A=x:k.sibling=x,k=x);return Nt&&nl(y,I),A}for(x=n(y,x);I<b.length;I++)T=m(x,y,I,b[I],E),T!==null&&(r&&T.alternate!==null&&x.delete(T.key===null?I:T.key),w=s(T,w,I),k===null?A=T:k.sibling=T,k=T);return r&&x.forEach(function(z){return e(y,z)}),Nt&&nl(y,I),A}function g(y,w,b,E){var A=Jh(b);if(typeof A!="function")throw Error(ee(150));if(b=A.call(b),b==null)throw Error(ee(151));for(var k=A=null,x=w,I=w=0,T=null,L=b.next();x!==null&&!L.done;I++,L=b.next()){x.index>I?(T=x,x=null):T=x.sibling;var z=p(y,x,L.value,E);if(z===null){x===null&&(x=T);break}r&&x&&z.alternate===null&&e(y,x),w=s(z,w,I),k===null?A=z:k.sibling=z,k=z,x=T}if(L.done)return t(y,x),Nt&&nl(y,I),A;if(x===null){for(;!L.done;I++,L=b.next())L=h(y,L.value,E),L!==null&&(w=s(L,w,I),k===null?A=L:k.sibling=L,k=L);return Nt&&nl(y,I),A}for(x=n(y,x);!L.done;I++,L=b.next())L=m(x,y,I,L.value,E),L!==null&&(r&&L.alternate!==null&&x.delete(L.key===null?I:L.key),w=s(L,w,I),k===null?A=L:k.sibling=L,k=L);return r&&x.forEach(function(B){return e(y,B)}),Nt&&nl(y,I),A}function v(y,w,b,E){if(typeof b=="object"&&b!==null&&b.type===qu&&b.key===null&&(b=b.props.children),typeof b=="object"&&b!==null){switch(b.$$typeof){case y0:e:{for(var A=b.key,k=w;k!==null;){if(k.key===A){if(A=b.type,A===qu){if(k.tag===7){t(y,k.sibling),w=i(k,b.props.children),w.return=y,y=w;break e}}else if(k.elementType===A||typeof A=="object"&&A!==null&&A.$$typeof===Ia&&SC(A)===k.type){t(y,k.sibling),w=i(k,b.props),w.ref=rf(y,k,b),w.return=y,y=w;break e}t(y,k);break}else e(y,k);k=k.sibling}b.type===qu?(w=Il(b.props.children,y.mode,E,b.key),w.return=y,y=w):(E=Rg(b.type,b.key,b.props,null,y.mode,E),E.ref=rf(y,w,b),E.return=y,y=E)}return o(y);case Hu:e:{for(k=b.key;w!==null;){if(w.key===k)if(w.tag===4&&w.stateNode.containerInfo===b.containerInfo&&w.stateNode.implementation===b.implementation){t(y,w.sibling),w=i(w,b.children||[]),w.return=y,y=w;break e}else{t(y,w);break}else e(y,w);w=w.sibling}w=p5(b,y.mode,E),w.return=y,y=w}return o(y);case Ia:return k=b._init,v(y,w,k(b._payload),E)}if(Lf(b))return f(y,w,b,E);if(Jh(b))return g(y,w,b,E);k0(y,b)}return typeof b=="string"&&b!==""||typeof b=="number"?(b=""+b,w!==null&&w.tag===6?(t(y,w.sibling),w=i(w,b),w.return=y,y=w):(t(y,w),w=f5(b,y.mode,E),w.return=y,y=w),o(y)):t(y,w)}return v}var Bd=UO(!0),FO=UO(!1),D2=Oc(null),$2=null,ed=null,J9=null;function X9(){J9=ed=$2=null}function Z9(r){var e=D2.current;Pt(D2),r._currentValue=e}function P6(r,e,t){for(;r!==null;){var n=r.alternate;if((r.childLanes&e)!==e?(r.childLanes|=e,n!==null&&(n.childLanes|=e)):n!==null&&(n.childLanes&e)!==e&&(n.childLanes|=e),r===t)break;r=r.return}}function hd(r,e){$2=r,J9=ed=null,r=r.dependencies,r!==null&&r.firstContext!==null&&(r.lanes&e&&(kn=!0),r.firstContext=null)}function $i(r){var e=r._currentValue;if(J9!==r)if(r={context:r,memoizedValue:e,next:null},ed===null){if($2===null)throw Error(ee(308));ed=r,$2.dependencies={lanes:0,firstContext:r}}else ed=ed.next=r;return e}var pl=null;function eE(r){pl===null?pl=[r]:pl.push(r)}function zO(r,e,t,n){var i=e.interleaved;return i===null?(t.next=t,eE(e)):(t.next=i.next,i.next=t),e.interleaved=t,Bo(r,n)}function Bo(r,e){r.lanes|=e;var t=r.alternate;for(t!==null&&(t.lanes|=e),t=r,r=r.return;r!==null;)r.childLanes|=e,t=r.alternate,t!==null&&(t.childLanes|=e),t=r,r=r.return;return t.tag===3?t.stateNode:null}var ka=!1;function tE(r){r.updateQueue={baseState:r.memoizedState,firstBaseUpdate:null,lastBaseUpdate:null,shared:{pending:null,interleaved:null,lanes:0},effects:null}}function VO(r,e){r=r.updateQueue,e.updateQueue===r&&(e.updateQueue={baseState:r.baseState,firstBaseUpdate:r.firstBaseUpdate,lastBaseUpdate:r.lastBaseUpdate,shared:r.shared,effects:r.effects})}function To(r,e){return{eventTime:r,lane:e,tag:0,payload:null,callback:null,next:null}}function ic(r,e,t){var n=r.updateQueue;if(n===null)return null;if(n=n.shared,rt&2){var i=n.pending;return i===null?e.next=e:(e.next=i.next,i.next=e),n.pending=e,Bo(r,t)}return i=n.interleaved,i===null?(e.next=e,eE(n)):(e.next=i.next,i.next=e),n.interleaved=e,Bo(r,t)}function Pg(r,e,t){if(e=e.updateQueue,e!==null&&(e=e.shared,(t&4194240)!==0)){var n=e.lanes;n&=r.pendingLanes,t|=n,e.lanes=t,F9(r,t)}}function xC(r,e){var t=r.updateQueue,n=r.alternate;if(n!==null&&(n=n.updateQueue,t===n)){var i=null,s=null;if(t=t.firstBaseUpdate,t!==null){do{var o={eventTime:t.eventTime,lane:t.lane,tag:t.tag,payload:t.payload,callback:t.callback,next:null};s===null?i=s=o:s=s.next=o,t=t.next}while(t!==null);s===null?i=s=e:s=s.next=e}else i=s=e;t={baseState:n.baseState,firstBaseUpdate:i,lastBaseUpdate:s,shared:n.shared,effects:n.effects},r.updateQueue=t;return}r=t.lastBaseUpdate,r===null?t.firstBaseUpdate=e:r.next=e,t.lastBaseUpdate=e}function N2(r,e,t,n){var i=r.updateQueue;ka=!1;var s=i.firstBaseUpdate,o=i.lastBaseUpdate,a=i.shared.pending;if(a!==null){i.shared.pending=null;var c=a,l=c.next;c.next=null,o===null?s=l:o.next=l,o=c;var d=r.alternate;d!==null&&(d=d.updateQueue,a=d.lastBaseUpdate,a!==o&&(a===null?d.firstBaseUpdate=l:a.next=l,d.lastBaseUpdate=c))}if(s!==null){var h=i.baseState;o=0,d=l=c=null,a=s;do{var p=a.lane,m=a.eventTime;if((n&p)===p){d!==null&&(d=d.next={eventTime:m,lane:0,tag:a.tag,payload:a.payload,callback:a.callback,next:null});e:{var f=r,g=a;switch(p=e,m=t,g.tag){case 1:if(f=g.payload,typeof f=="function"){h=f.call(m,h,p);break e}h=f;break e;case 3:f.flags=f.flags&-65537|128;case 0:if(f=g.payload,p=typeof f=="function"?f.call(m,h,p):f,p==null)break e;h=Ft({},h,p);break e;case 2:ka=!0}}a.callback!==null&&a.lane!==0&&(r.flags|=64,p=i.effects,p===null?i.effects=[a]:p.push(a))}else m={eventTime:m,lane:p,tag:a.tag,payload:a.payload,callback:a.callback,next:null},d===null?(l=d=m,c=h):d=d.next=m,o|=p;if(a=a.next,a===null){if(a=i.shared.pending,a===null)break;p=a,a=p.next,p.next=null,i.lastBaseUpdate=p,i.shared.pending=null}}while(!0);if(d===null&&(c=h),i.baseState=c,i.firstBaseUpdate=l,i.lastBaseUpdate=d,e=i.shared.interleaved,e!==null){i=e;do o|=i.lane,i=i.next;while(i!==e)}else s===null&&(i.shared.lanes=0);zl|=o,r.lanes=o,r.memoizedState=h}}function AC(r,e,t){if(r=e.effects,e.effects=null,r!==null)for(e=0;e<r.length;e++){var n=r[e],i=n.callback;if(i!==null){if(n.callback=null,n=t,typeof i!="function")throw Error(ee(191,i));i.call(n)}}}var Tp={},Fs=Oc(Tp),$1=Oc(Tp),N1=Oc(Tp);function gl(r){if(r===Tp)throw Error(ee(174));return r}function rE(r,e){switch(Ct(N1,e),Ct($1,r),Ct(Fs,Tp),r=e.nodeType,r){case 9:case 11:e=(e=e.documentElement)?e.namespaceURI:u6(null,"");break;default:r=r===8?e.parentNode:e,e=r.namespaceURI||null,r=r.tagName,e=u6(e,r)}Pt(Fs),Ct(Fs,e)}function Ud(){Pt(Fs),Pt($1),Pt(N1)}function KO(r){gl(N1.current);var e=gl(Fs.current),t=u6(e,r.type);e!==t&&(Ct($1,r),Ct(Fs,t))}function nE(r){$1.current===r&&(Pt(Fs),Pt($1))}var Lt=Oc(0);function M2(r){for(var e=r;e!==null;){if(e.tag===13){var t=e.memoizedState;if(t!==null&&(t=t.dehydrated,t===null||t.data==="$?"||t.data==="$!"))return e}else if(e.tag===19&&e.memoizedProps.revealOrder!==void 0){if(e.flags&128)return e}else if(e.child!==null){e.child.return=e,e=e.child;continue}if(e===r)break;for(;e.sibling===null;){if(e.return===null||e.return===r)return null;e=e.return}e.sibling.return=e.return,e=e.sibling}return null}var a5=[];function iE(){for(var r=0;r<a5.length;r++)a5[r]._workInProgressVersionPrimary=null;a5.length=0}var Dg=Qo.ReactCurrentDispatcher,c5=Qo.ReactCurrentBatchConfig,Fl=0,Ut=null,rr=null,ur=null,O2=!1,t1=!1,M1=0,XW=0;function Dr(){throw Error(ee(321))}function sE(r,e){if(e===null)return!1;for(var t=0;t<e.length&&t<r.length;t++)if(!hs(r[t],e[t]))return!1;return!0}function oE(r,e,t,n,i,s){if(Fl=s,Ut=e,e.memoizedState=null,e.updateQueue=null,e.lanes=0,Dg.current=r===null||r.memoizedState===null?rG:nG,r=t(n,i),t1){s=0;do{if(t1=!1,M1=0,25<=s)throw Error(ee(301));s+=1,ur=rr=null,e.updateQueue=null,Dg.current=iG,r=t(n,i)}while(t1)}if(Dg.current=R2,e=rr!==null&&rr.next!==null,Fl=0,ur=rr=Ut=null,O2=!1,e)throw Error(ee(300));return r}function aE(){var r=M1!==0;return M1=0,r}function Ps(){var r={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};return ur===null?Ut.memoizedState=ur=r:ur=ur.next=r,ur}function Ni(){if(rr===null){var r=Ut.alternate;r=r!==null?r.memoizedState:null}else r=rr.next;var e=ur===null?Ut.memoizedState:ur.next;if(e!==null)ur=e,rr=r;else{if(r===null)throw Error(ee(310));rr=r,r={memoizedState:rr.memoizedState,baseState:rr.baseState,baseQueue:rr.baseQueue,queue:rr.queue,next:null},ur===null?Ut.memoizedState=ur=r:ur=ur.next=r}return ur}function O1(r,e){return typeof e=="function"?e(r):e}function l5(r){var e=Ni(),t=e.queue;if(t===null)throw Error(ee(311));t.lastRenderedReducer=r;var n=rr,i=n.baseQueue,s=t.pending;if(s!==null){if(i!==null){var o=i.next;i.next=s.next,s.next=o}n.baseQueue=i=s,t.pending=null}if(i!==null){s=i.next,n=n.baseState;var a=o=null,c=null,l=s;do{var d=l.lane;if((Fl&d)===d)c!==null&&(c=c.next={lane:0,action:l.action,hasEagerState:l.hasEagerState,eagerState:l.eagerState,next:null}),n=l.hasEagerState?l.eagerState:r(n,l.action);else{var h={lane:d,action:l.action,hasEagerState:l.hasEagerState,eagerState:l.eagerState,next:null};c===null?(a=c=h,o=n):c=c.next=h,Ut.lanes|=d,zl|=d}l=l.next}while(l!==null&&l!==s);c===null?o=n:c.next=a,hs(n,e.memoizedState)||(kn=!0),e.memoizedState=n,e.baseState=o,e.baseQueue=c,t.lastRenderedState=n}if(r=t.interleaved,r!==null){i=r;do s=i.lane,Ut.lanes|=s,zl|=s,i=i.next;while(i!==r)}else i===null&&(t.lanes=0);return[e.memoizedState,t.dispatch]}function u5(r){var e=Ni(),t=e.queue;if(t===null)throw Error(ee(311));t.lastRenderedReducer=r;var n=t.dispatch,i=t.pending,s=e.memoizedState;if(i!==null){t.pending=null;var o=i=i.next;do s=r(s,o.action),o=o.next;while(o!==i);hs(s,e.memoizedState)||(kn=!0),e.memoizedState=s,e.baseQueue===null&&(e.baseState=s),t.lastRenderedState=s}return[s,n]}function jO(){}function HO(r,e){var t=Ut,n=Ni(),i=e(),s=!hs(n.memoizedState,i);if(s&&(n.memoizedState=i,kn=!0),n=n.queue,cE(GO.bind(null,t,n,r),[r]),n.getSnapshot!==e||s||ur!==null&&ur.memoizedState.tag&1){if(t.flags|=2048,R1(9,WO.bind(null,t,n,i,e),void 0,null),hr===null)throw Error(ee(349));Fl&30||qO(t,e,i)}return i}function qO(r,e,t){r.flags|=16384,r={getSnapshot:e,value:t},e=Ut.updateQueue,e===null?(e={lastEffect:null,stores:null},Ut.updateQueue=e,e.stores=[r]):(t=e.stores,t===null?e.stores=[r]:t.push(r))}function WO(r,e,t,n){e.value=t,e.getSnapshot=n,QO(e)&&YO(r)}function GO(r,e,t){return t(function(){QO(e)&&YO(r)})}function QO(r){var e=r.getSnapshot;r=r.value;try{var t=e();return!hs(r,t)}catch{return!0}}function YO(r){var e=Bo(r,1);e!==null&&as(e,r,1,-1)}function CC(r){var e=Ps();return typeof r=="function"&&(r=r()),e.memoizedState=e.baseState=r,r={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:O1,lastRenderedState:r},e.queue=r,r=r.dispatch=tG.bind(null,Ut,r),[e.memoizedState,r]}function R1(r,e,t,n){return r={tag:r,create:e,destroy:t,deps:n,next:null},e=Ut.updateQueue,e===null?(e={lastEffect:null,stores:null},Ut.updateQueue=e,e.lastEffect=r.next=r):(t=e.lastEffect,t===null?e.lastEffect=r.next=r:(n=t.next,t.next=r,r.next=n,e.lastEffect=r)),r}function JO(){return Ni().memoizedState}function $g(r,e,t,n){var i=Ps();Ut.flags|=r,i.memoizedState=R1(1|e,t,void 0,n===void 0?null:n)}function x3(r,e,t,n){var i=Ni();n=n===void 0?null:n;var s=void 0;if(rr!==null){var o=rr.memoizedState;if(s=o.destroy,n!==null&&sE(n,o.deps)){i.memoizedState=R1(e,t,s,n);return}}Ut.flags|=r,i.memoizedState=R1(1|e,t,s,n)}function IC(r,e){return $g(8390656,8,r,e)}function cE(r,e){return x3(2048,8,r,e)}function XO(r,e){return x3(4,2,r,e)}function ZO(r,e){return x3(4,4,r,e)}function eR(r,e){if(typeof e=="function")return r=r(),e(r),function(){e(null)};if(e!=null)return r=r(),e.current=r,function(){e.current=null}}function tR(r,e,t){return t=t!=null?t.concat([r]):null,x3(4,4,eR.bind(null,e,r),t)}function lE(){}function rR(r,e){var t=Ni();e=e===void 0?null:e;var n=t.memoizedState;return n!==null&&e!==null&&sE(e,n[1])?n[0]:(t.memoizedState=[r,e],r)}function nR(r,e){var t=Ni();e=e===void 0?null:e;var n=t.memoizedState;return n!==null&&e!==null&&sE(e,n[1])?n[0]:(r=r(),t.memoizedState=[r,e],r)}function iR(r,e,t){return Fl&21?(hs(t,e)||(t=lO(),Ut.lanes|=t,zl|=t,r.baseState=!0),e):(r.baseState&&(r.baseState=!1,kn=!0),r.memoizedState=t)}function ZW(r,e){var t=ht;ht=t!==0&&4>t?t:4,r(!0);var n=c5.transition;c5.transition={};try{r(!1),e()}finally{ht=t,c5.transition=n}}function sR(){return Ni().memoizedState}function eG(r,e,t){var n=oc(r);if(t={lane:n,action:t,hasEagerState:!1,eagerState:null,next:null},oR(r))aR(e,t);else if(t=zO(r,e,t,n),t!==null){var i=un();as(t,r,n,i),cR(t,e,n)}}function tG(r,e,t){var n=oc(r),i={lane:n,action:t,hasEagerState:!1,eagerState:null,next:null};if(oR(r))aR(e,i);else{var s=r.alternate;if(r.lanes===0&&(s===null||s.lanes===0)&&(s=e.lastRenderedReducer,s!==null))try{var o=e.lastRenderedState,a=s(o,t);if(i.hasEagerState=!0,i.eagerState=a,hs(a,o)){var c=e.interleaved;c===null?(i.next=i,eE(e)):(i.next=c.next,c.next=i),e.interleaved=i;return}}catch{}finally{}t=zO(r,e,i,n),t!==null&&(i=un(),as(t,r,n,i),cR(t,e,n))}}function oR(r){var e=r.alternate;return r===Ut||e!==null&&e===Ut}function aR(r,e){t1=O2=!0;var t=r.pending;t===null?e.next=e:(e.next=t.next,t.next=e),r.pending=e}function cR(r,e,t){if(t&4194240){var n=e.lanes;n&=r.pendingLanes,t|=n,e.lanes=t,F9(r,t)}}var R2={readContext:$i,useCallback:Dr,useContext:Dr,useEffect:Dr,useImperativeHandle:Dr,useInsertionEffect:Dr,useLayoutEffect:Dr,useMemo:Dr,useReducer:Dr,useRef:Dr,useState:Dr,useDebugValue:Dr,useDeferredValue:Dr,useTransition:Dr,useMutableSource:Dr,useSyncExternalStore:Dr,useId:Dr,unstable_isNewReconciler:!1},rG={readContext:$i,useCallback:function(r,e){return Ps().memoizedState=[r,e===void 0?null:e],r},useContext:$i,useEffect:IC,useImperativeHandle:function(r,e,t){return t=t!=null?t.concat([r]):null,$g(4194308,4,eR.bind(null,e,r),t)},useLayoutEffect:function(r,e){return $g(4194308,4,r,e)},useInsertionEffect:function(r,e){return $g(4,2,r,e)},useMemo:function(r,e){var t=Ps();return e=e===void 0?null:e,r=r(),t.memoizedState=[r,e],r},useReducer:function(r,e,t){var n=Ps();return e=t!==void 0?t(e):e,n.memoizedState=n.baseState=e,r={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:r,lastRenderedState:e},n.queue=r,r=r.dispatch=eG.bind(null,Ut,r),[n.memoizedState,r]},useRef:function(r){var e=Ps();return r={current:r},e.memoizedState=r},useState:CC,useDebugValue:lE,useDeferredValue:function(r){return Ps().memoizedState=r},useTransition:function(){var r=CC(!1),e=r[0];return r=ZW.bind(null,r[1]),Ps().memoizedState=r,[e,r]},useMutableSource:function(){},useSyncExternalStore:function(r,e,t){var n=Ut,i=Ps();if(Nt){if(t===void 0)throw Error(ee(407));t=t()}else{if(t=e(),hr===null)throw Error(ee(349));Fl&30||qO(n,e,t)}i.memoizedState=t;var s={value:t,getSnapshot:e};return i.queue=s,IC(GO.bind(null,n,s,r),[r]),n.flags|=2048,R1(9,WO.bind(null,n,s,t,e),void 0,null),t},useId:function(){var r=Ps(),e=hr.identifierPrefix;if(Nt){var t=ko,n=Io;t=(n&~(1<<32-os(n)-1)).toString(32)+t,e=":"+e+"R"+t,t=M1++,0<t&&(e+="H"+t.toString(32)),e+=":"}else t=XW++,e=":"+e+"r"+t.toString(32)+":";return r.memoizedState=e},unstable_isNewReconciler:!1},nG={readContext:$i,useCallback:rR,useContext:$i,useEffect:cE,useImperativeHandle:tR,useInsertionEffect:XO,useLayoutEffect:ZO,useMemo:nR,useReducer:l5,useRef:JO,useState:function(){return l5(O1)},useDebugValue:lE,useDeferredValue:function(r){var e=Ni();return iR(e,rr.memoizedState,r)},useTransition:function(){var r=l5(O1)[0],e=Ni().memoizedState;return[r,e]},useMutableSource:jO,useSyncExternalStore:HO,useId:sR,unstable_isNewReconciler:!1},iG={readContext:$i,useCallback:rR,useContext:$i,useEffect:cE,useImperativeHandle:tR,useInsertionEffect:XO,useLayoutEffect:ZO,useMemo:nR,useReducer:u5,useRef:JO,useState:function(){return u5(O1)},useDebugValue:lE,useDeferredValue:function(r){var e=Ni();return rr===null?e.memoizedState=r:iR(e,rr.memoizedState,r)},useTransition:function(){var r=u5(O1)[0],e=Ni().memoizedState;return[r,e]},useMutableSource:jO,useSyncExternalStore:HO,useId:sR,unstable_isNewReconciler:!1};function Ji(r,e){if(r&&r.defaultProps){e=Ft({},e),r=r.defaultProps;for(var t in r)e[t]===void 0&&(e[t]=r[t]);return e}return e}function D6(r,e,t,n){e=r.memoizedState,t=t(n,e),t=t==null?e:Ft({},e,t),r.memoizedState=t,r.lanes===0&&(r.updateQueue.baseState=t)}var A3={isMounted:function(r){return(r=r._reactInternals)?pu(r)===r:!1},enqueueSetState:function(r,e,t){r=r._reactInternals;var n=un(),i=oc(r),s=To(n,i);s.payload=e,t!=null&&(s.callback=t),e=ic(r,s,i),e!==null&&(as(e,r,i,n),Pg(e,r,i))},enqueueReplaceState:function(r,e,t){r=r._reactInternals;var n=un(),i=oc(r),s=To(n,i);s.tag=1,s.payload=e,t!=null&&(s.callback=t),e=ic(r,s,i),e!==null&&(as(e,r,i,n),Pg(e,r,i))},enqueueForceUpdate:function(r,e){r=r._reactInternals;var t=un(),n=oc(r),i=To(t,n);i.tag=2,e!=null&&(i.callback=e),e=ic(r,i,n),e!==null&&(as(e,r,n,t),Pg(e,r,n))}};function kC(r,e,t,n,i,s,o){return r=r.stateNode,typeof r.shouldComponentUpdate=="function"?r.shouldComponentUpdate(n,s,o):e.prototype&&e.prototype.isPureReactComponent?!_1(t,n)||!_1(i,s):!0}function lR(r,e,t){var n=!1,i=mc,s=e.contextType;return typeof s=="object"&&s!==null?s=$i(s):(i=Pn(e)?Bl:en.current,n=e.contextTypes,s=(n=n!=null)?Rd(r,i):mc),e=new e(t,s),r.memoizedState=e.state!==null&&e.state!==void 0?e.state:null,e.updater=A3,r.stateNode=e,e._reactInternals=r,n&&(r=r.stateNode,r.__reactInternalMemoizedUnmaskedChildContext=i,r.__reactInternalMemoizedMaskedChildContext=s),e}function _C(r,e,t,n){r=e.state,typeof e.componentWillReceiveProps=="function"&&e.componentWillReceiveProps(t,n),typeof e.UNSAFE_componentWillReceiveProps=="function"&&e.UNSAFE_componentWillReceiveProps(t,n),e.state!==r&&A3.enqueueReplaceState(e,e.state,null)}function $6(r,e,t,n){var i=r.stateNode;i.props=t,i.state=r.memoizedState,i.refs={},tE(r);var s=e.contextType;typeof s=="object"&&s!==null?i.context=$i(s):(s=Pn(e)?Bl:en.current,i.context=Rd(r,s)),i.state=r.memoizedState,s=e.getDerivedStateFromProps,typeof s=="function"&&(D6(r,e,s,t),i.state=r.memoizedState),typeof e.getDerivedStateFromProps=="function"||typeof i.getSnapshotBeforeUpdate=="function"||typeof i.UNSAFE_componentWillMount!="function"&&typeof i.componentWillMount!="function"||(e=i.state,typeof i.componentWillMount=="function"&&i.componentWillMount(),typeof i.UNSAFE_componentWillMount=="function"&&i.UNSAFE_componentWillMount(),e!==i.state&&A3.enqueueReplaceState(i,i.state,null),N2(r,t,i,n),i.state=r.memoizedState),typeof i.componentDidMount=="function"&&(r.flags|=4194308)}function Fd(r,e){try{var t="",n=e;do t+=$q(n),n=n.return;while(n);var i=t}catch(s){i=`
Error generating stack: `+s.message+`
`+s.stack}return{value:r,source:e,stack:i,digest:null}}function d5(r,e,t){return{value:r,source:null,stack:t??null,digest:e??null}}function N6(r,e){try{console.error(e.value)}catch(t){setTimeout(function(){throw t})}}var sG=typeof WeakMap=="function"?WeakMap:Map;function uR(r,e,t){t=To(-1,t),t.tag=3,t.payload={element:null};var n=e.value;return t.callback=function(){B2||(B2=!0,K6=n),N6(r,e)},t}function dR(r,e,t){t=To(-1,t),t.tag=3;var n=r.type.getDerivedStateFromError;if(typeof n=="function"){var i=e.value;t.payload=function(){return n(i)},t.callback=function(){N6(r,e)}}var s=r.stateNode;return s!==null&&typeof s.componentDidCatch=="function"&&(t.callback=function(){N6(r,e),typeof n!="function"&&(sc===null?sc=new Set([this]):sc.add(this));var o=e.stack;this.componentDidCatch(e.value,{componentStack:o!==null?o:""})}),t}function TC(r,e,t){var n=r.pingCache;if(n===null){n=r.pingCache=new sG;var i=new Set;n.set(e,i)}else i=n.get(e),i===void 0&&(i=new Set,n.set(e,i));i.has(t)||(i.add(t),r=bG.bind(null,r,e,t),e.then(r,r))}function PC(r){do{var e;if((e=r.tag===13)&&(e=r.memoizedState,e=e!==null?e.dehydrated!==null:!0),e)return r;r=r.return}while(r!==null);return null}function DC(r,e,t,n,i){return r.mode&1?(r.flags|=65536,r.lanes=i,r):(r===e?r.flags|=65536:(r.flags|=128,t.flags|=131072,t.flags&=-52805,t.tag===1&&(t.alternate===null?t.tag=17:(e=To(-1,1),e.tag=2,ic(t,e,1))),t.lanes|=1),r)}var oG=Qo.ReactCurrentOwner,kn=!1;function sn(r,e,t,n){e.child=r===null?FO(e,null,t,n):Bd(e,r.child,t,n)}function $C(r,e,t,n,i){t=t.render;var s=e.ref;return hd(e,i),n=oE(r,e,t,n,s,i),t=aE(),r!==null&&!kn?(e.updateQueue=r.updateQueue,e.flags&=-2053,r.lanes&=~i,Uo(r,e,i)):(Nt&&t&&G9(e),e.flags|=1,sn(r,e,n,i),e.child)}function NC(r,e,t,n,i){if(r===null){var s=t.type;return typeof s=="function"&&!mE(s)&&s.defaultProps===void 0&&t.compare===null&&t.defaultProps===void 0?(e.tag=15,e.type=s,hR(r,e,s,n,i)):(r=Rg(t.type,null,n,e,e.mode,i),r.ref=e.ref,r.return=e,e.child=r)}if(s=r.child,!(r.lanes&i)){var o=s.memoizedProps;if(t=t.compare,t=t!==null?t:_1,t(o,n)&&r.ref===e.ref)return Uo(r,e,i)}return e.flags|=1,r=ac(s,n),r.ref=e.ref,r.return=e,e.child=r}function hR(r,e,t,n,i){if(r!==null){var s=r.memoizedProps;if(_1(s,n)&&r.ref===e.ref)if(kn=!1,e.pendingProps=n=s,(r.lanes&i)!==0)r.flags&131072&&(kn=!0);else return e.lanes=r.lanes,Uo(r,e,i)}return M6(r,e,t,n,i)}function fR(r,e,t){var n=e.pendingProps,i=n.children,s=r!==null?r.memoizedState:null;if(n.mode==="hidden")if(!(e.mode&1))e.memoizedState={baseLanes:0,cachePool:null,transitions:null},Ct(rd,Hn),Hn|=t;else{if(!(t&1073741824))return r=s!==null?s.baseLanes|t:t,e.lanes=e.childLanes=1073741824,e.memoizedState={baseLanes:r,cachePool:null,transitions:null},e.updateQueue=null,Ct(rd,Hn),Hn|=r,null;e.memoizedState={baseLanes:0,cachePool:null,transitions:null},n=s!==null?s.baseLanes:t,Ct(rd,Hn),Hn|=n}else s!==null?(n=s.baseLanes|t,e.memoizedState=null):n=t,Ct(rd,Hn),Hn|=n;return sn(r,e,i,t),e.child}function pR(r,e){var t=e.ref;(r===null&&t!==null||r!==null&&r.ref!==t)&&(e.flags|=512,e.flags|=2097152)}function M6(r,e,t,n,i){var s=Pn(t)?Bl:en.current;return s=Rd(e,s),hd(e,i),t=oE(r,e,t,n,s,i),n=aE(),r!==null&&!kn?(e.updateQueue=r.updateQueue,e.flags&=-2053,r.lanes&=~i,Uo(r,e,i)):(Nt&&n&&G9(e),e.flags|=1,sn(r,e,t,i),e.child)}function MC(r,e,t,n,i){if(Pn(t)){var s=!0;_2(e)}else s=!1;if(hd(e,i),e.stateNode===null)Ng(r,e),lR(e,t,n),$6(e,t,n,i),n=!0;else if(r===null){var o=e.stateNode,a=e.memoizedProps;o.props=a;var c=o.context,l=t.contextType;typeof l=="object"&&l!==null?l=$i(l):(l=Pn(t)?Bl:en.current,l=Rd(e,l));var d=t.getDerivedStateFromProps,h=typeof d=="function"||typeof o.getSnapshotBeforeUpdate=="function";h||typeof o.UNSAFE_componentWillReceiveProps!="function"&&typeof o.componentWillReceiveProps!="function"||(a!==n||c!==l)&&_C(e,o,n,l),ka=!1;var p=e.memoizedState;o.state=p,N2(e,n,o,i),c=e.memoizedState,a!==n||p!==c||Tn.current||ka?(typeof d=="function"&&(D6(e,t,d,n),c=e.memoizedState),(a=ka||kC(e,t,a,n,p,c,l))?(h||typeof o.UNSAFE_componentWillMount!="function"&&typeof o.componentWillMount!="function"||(typeof o.componentWillMount=="function"&&o.componentWillMount(),typeof o.UNSAFE_componentWillMount=="function"&&o.UNSAFE_componentWillMount()),typeof o.componentDidMount=="function"&&(e.flags|=4194308)):(typeof o.componentDidMount=="function"&&(e.flags|=4194308),e.memoizedProps=n,e.memoizedState=c),o.props=n,o.state=c,o.context=l,n=a):(typeof o.componentDidMount=="function"&&(e.flags|=4194308),n=!1)}else{o=e.stateNode,VO(r,e),a=e.memoizedProps,l=e.type===e.elementType?a:Ji(e.type,a),o.props=l,h=e.pendingProps,p=o.context,c=t.contextType,typeof c=="object"&&c!==null?c=$i(c):(c=Pn(t)?Bl:en.current,c=Rd(e,c));var m=t.getDerivedStateFromProps;(d=typeof m=="function"||typeof o.getSnapshotBeforeUpdate=="function")||typeof o.UNSAFE_componentWillReceiveProps!="function"&&typeof o.componentWillReceiveProps!="function"||(a!==h||p!==c)&&_C(e,o,n,c),ka=!1,p=e.memoizedState,o.state=p,N2(e,n,o,i);var f=e.memoizedState;a!==h||p!==f||Tn.current||ka?(typeof m=="function"&&(D6(e,t,m,n),f=e.memoizedState),(l=ka||kC(e,t,l,n,p,f,c)||!1)?(d||typeof o.UNSAFE_componentWillUpdate!="function"&&typeof o.componentWillUpdate!="function"||(typeof o.componentWillUpdate=="function"&&o.componentWillUpdate(n,f,c),typeof o.UNSAFE_componentWillUpdate=="function"&&o.UNSAFE_componentWillUpdate(n,f,c)),typeof o.componentDidUpdate=="function"&&(e.flags|=4),typeof o.getSnapshotBeforeUpdate=="function"&&(e.flags|=1024)):(typeof o.componentDidUpdate!="function"||a===r.memoizedProps&&p===r.memoizedState||(e.flags|=4),typeof o.getSnapshotBeforeUpdate!="function"||a===r.memoizedProps&&p===r.memoizedState||(e.flags|=1024),e.memoizedProps=n,e.memoizedState=f),o.props=n,o.state=f,o.context=c,n=l):(typeof o.componentDidUpdate!="function"||a===r.memoizedProps&&p===r.memoizedState||(e.flags|=4),typeof o.getSnapshotBeforeUpdate!="function"||a===r.memoizedProps&&p===r.memoizedState||(e.flags|=1024),n=!1)}return O6(r,e,t,n,s,i)}function O6(r,e,t,n,i,s){pR(r,e);var o=(e.flags&128)!==0;if(!n&&!o)return i&&bC(e,t,!1),Uo(r,e,s);n=e.stateNode,oG.current=e;var a=o&&typeof t.getDerivedStateFromError!="function"?null:n.render();return e.flags|=1,r!==null&&o?(e.child=Bd(e,r.child,null,s),e.child=Bd(e,null,a,s)):sn(r,e,a,s),e.memoizedState=n.state,i&&bC(e,t,!0),e.child}function gR(r){var e=r.stateNode;e.pendingContext?wC(r,e.pendingContext,e.pendingContext!==e.context):e.context&&wC(r,e.context,!1),rE(r,e.containerInfo)}function OC(r,e,t,n,i){return Ld(),Y9(i),e.flags|=256,sn(r,e,t,n),e.child}var R6={dehydrated:null,treeContext:null,retryLane:0};function L6(r){return{baseLanes:r,cachePool:null,transitions:null}}function yR(r,e,t){var n=e.pendingProps,i=Lt.current,s=!1,o=(e.flags&128)!==0,a;if((a=o)||(a=r!==null&&r.memoizedState===null?!1:(i&2)!==0),a?(s=!0,e.flags&=-129):(r===null||r.memoizedState!==null)&&(i|=1),Ct(Lt,i&1),r===null)return T6(e),r=e.memoizedState,r!==null&&(r=r.dehydrated,r!==null)?(e.mode&1?r.data==="$!"?e.lanes=8:e.lanes=1073741824:e.lanes=1,null):(o=n.children,r=n.fallback,s?(n=e.mode,s=e.child,o={mode:"hidden",children:o},!(n&1)&&s!==null?(s.childLanes=0,s.pendingProps=o):s=k3(o,n,0,null),r=Il(r,n,t,null),s.return=e,r.return=e,s.sibling=r,e.child=s,e.child.memoizedState=L6(t),e.memoizedState=R6,r):uE(e,o));if(i=r.memoizedState,i!==null&&(a=i.dehydrated,a!==null))return aG(r,e,o,n,a,i,t);if(s){s=n.fallback,o=e.mode,i=r.child,a=i.sibling;var c={mode:"hidden",children:n.children};return!(o&1)&&e.child!==i?(n=e.child,n.childLanes=0,n.pendingProps=c,e.deletions=null):(n=ac(i,c),n.subtreeFlags=i.subtreeFlags&14680064),a!==null?s=ac(a,s):(s=Il(s,o,t,null),s.flags|=2),s.return=e,n.return=e,n.sibling=s,e.child=n,n=s,s=e.child,o=r.child.memoizedState,o=o===null?L6(t):{baseLanes:o.baseLanes|t,cachePool:null,transitions:o.transitions},s.memoizedState=o,s.childLanes=r.childLanes&~t,e.memoizedState=R6,n}return s=r.child,r=s.sibling,n=ac(s,{mode:"visible",children:n.children}),!(e.mode&1)&&(n.lanes=t),n.return=e,n.sibling=null,r!==null&&(t=e.deletions,t===null?(e.deletions=[r],e.flags|=16):t.push(r)),e.child=n,e.memoizedState=null,n}function uE(r,e){return e=k3({mode:"visible",children:e},r.mode,0,null),e.return=r,r.child=e}function _0(r,e,t,n){return n!==null&&Y9(n),Bd(e,r.child,null,t),r=uE(e,e.pendingProps.children),r.flags|=2,e.memoizedState=null,r}function aG(r,e,t,n,i,s,o){if(t)return e.flags&256?(e.flags&=-257,n=d5(Error(ee(422))),_0(r,e,o,n)):e.memoizedState!==null?(e.child=r.child,e.flags|=128,null):(s=n.fallback,i=e.mode,n=k3({mode:"visible",children:n.children},i,0,null),s=Il(s,i,o,null),s.flags|=2,n.return=e,s.return=e,n.sibling=s,e.child=n,e.mode&1&&Bd(e,r.child,null,o),e.child.memoizedState=L6(o),e.memoizedState=R6,s);if(!(e.mode&1))return _0(r,e,o,null);if(i.data==="$!"){if(n=i.nextSibling&&i.nextSibling.dataset,n)var a=n.dgst;return n=a,s=Error(ee(419)),n=d5(s,n,void 0),_0(r,e,o,n)}if(a=(o&r.childLanes)!==0,kn||a){if(n=hr,n!==null){switch(o&-o){case 4:i=2;break;case 16:i=8;break;case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:i=32;break;case 536870912:i=268435456;break;default:i=0}i=i&(n.suspendedLanes|o)?0:i,i!==0&&i!==s.retryLane&&(s.retryLane=i,Bo(r,i),as(n,r,i,-1))}return yE(),n=d5(Error(ee(421))),_0(r,e,o,n)}return i.data==="$?"?(e.flags|=128,e.child=r.child,e=vG.bind(null,r),i._reactRetry=e,null):(r=s.treeContext,Jn=nc(i.nextSibling),Xn=e,Nt=!0,ts=null,r!==null&&(bi[vi++]=Io,bi[vi++]=ko,bi[vi++]=Ul,Io=r.id,ko=r.overflow,Ul=e),e=uE(e,n.children),e.flags|=4096,e)}function RC(r,e,t){r.lanes|=e;var n=r.alternate;n!==null&&(n.lanes|=e),P6(r.return,e,t)}function h5(r,e,t,n,i){var s=r.memoizedState;s===null?r.memoizedState={isBackwards:e,rendering:null,renderingStartTime:0,last:n,tail:t,tailMode:i}:(s.isBackwards=e,s.rendering=null,s.renderingStartTime=0,s.last=n,s.tail=t,s.tailMode=i)}function mR(r,e,t){var n=e.pendingProps,i=n.revealOrder,s=n.tail;if(sn(r,e,n.children,t),n=Lt.current,n&2)n=n&1|2,e.flags|=128;else{if(r!==null&&r.flags&128)e:for(r=e.child;r!==null;){if(r.tag===13)r.memoizedState!==null&&RC(r,t,e);else if(r.tag===19)RC(r,t,e);else if(r.child!==null){r.child.return=r,r=r.child;continue}if(r===e)break e;for(;r.sibling===null;){if(r.return===null||r.return===e)break e;r=r.return}r.sibling.return=r.return,r=r.sibling}n&=1}if(Ct(Lt,n),!(e.mode&1))e.memoizedState=null;else switch(i){case"forwards":for(t=e.child,i=null;t!==null;)r=t.alternate,r!==null&&M2(r)===null&&(i=t),t=t.sibling;t=i,t===null?(i=e.child,e.child=null):(i=t.sibling,t.sibling=null),h5(e,!1,i,t,s);break;case"backwards":for(t=null,i=e.child,e.child=null;i!==null;){if(r=i.alternate,r!==null&&M2(r)===null){e.child=i;break}r=i.sibling,i.sibling=t,t=i,i=r}h5(e,!0,t,null,s);break;case"together":h5(e,!1,null,null,void 0);break;default:e.memoizedState=null}return e.child}function Ng(r,e){!(e.mode&1)&&r!==null&&(r.alternate=null,e.alternate=null,e.flags|=2)}function Uo(r,e,t){if(r!==null&&(e.dependencies=r.dependencies),zl|=e.lanes,!(t&e.childLanes))return null;if(r!==null&&e.child!==r.child)throw Error(ee(153));if(e.child!==null){for(r=e.child,t=ac(r,r.pendingProps),e.child=t,t.return=e;r.sibling!==null;)r=r.sibling,t=t.sibling=ac(r,r.pendingProps),t.return=e;t.sibling=null}return e.child}function cG(r,e,t){switch(e.tag){case 3:gR(e),Ld();break;case 5:KO(e);break;case 1:Pn(e.type)&&_2(e);break;case 4:rE(e,e.stateNode.containerInfo);break;case 10:var n=e.type._context,i=e.memoizedProps.value;Ct(D2,n._currentValue),n._currentValue=i;break;case 13:if(n=e.memoizedState,n!==null)return n.dehydrated!==null?(Ct(Lt,Lt.current&1),e.flags|=128,null):t&e.child.childLanes?yR(r,e,t):(Ct(Lt,Lt.current&1),r=Uo(r,e,t),r!==null?r.sibling:null);Ct(Lt,Lt.current&1);break;case 19:if(n=(t&e.childLanes)!==0,r.flags&128){if(n)return mR(r,e,t);e.flags|=128}if(i=e.memoizedState,i!==null&&(i.rendering=null,i.tail=null,i.lastEffect=null),Ct(Lt,Lt.current),n)break;return null;case 22:case 23:return e.lanes=0,fR(r,e,t)}return Uo(r,e,t)}var wR,B6,bR,vR;wR=function(r,e){for(var t=e.child;t!==null;){if(t.tag===5||t.tag===6)r.appendChild(t.stateNode);else if(t.tag!==4&&t.child!==null){t.child.return=t,t=t.child;continue}if(t===e)break;for(;t.sibling===null;){if(t.return===null||t.return===e)return;t=t.return}t.sibling.return=t.return,t=t.sibling}};B6=function(){};bR=function(r,e,t,n){var i=r.memoizedProps;if(i!==n){r=e.stateNode,gl(Fs.current);var s=null;switch(t){case"input":i=o6(r,i),n=o6(r,n),s=[];break;case"select":i=Ft({},i,{value:void 0}),n=Ft({},n,{value:void 0}),s=[];break;case"textarea":i=l6(r,i),n=l6(r,n),s=[];break;default:typeof i.onClick!="function"&&typeof n.onClick=="function"&&(r.onclick=I2)}d6(t,n);var o;t=null;for(l in i)if(!n.hasOwnProperty(l)&&i.hasOwnProperty(l)&&i[l]!=null)if(l==="style"){var a=i[l];for(o in a)a.hasOwnProperty(o)&&(t||(t={}),t[o]="")}else l!=="dangerouslySetInnerHTML"&&l!=="children"&&l!=="suppressContentEditableWarning"&&l!=="suppressHydrationWarning"&&l!=="autoFocus"&&(E1.hasOwnProperty(l)?s||(s=[]):(s=s||[]).push(l,null));for(l in n){var c=n[l];if(a=i!=null?i[l]:void 0,n.hasOwnProperty(l)&&c!==a&&(c!=null||a!=null))if(l==="style")if(a){for(o in a)!a.hasOwnProperty(o)||c&&c.hasOwnProperty(o)||(t||(t={}),t[o]="");for(o in c)c.hasOwnProperty(o)&&a[o]!==c[o]&&(t||(t={}),t[o]=c[o])}else t||(s||(s=[]),s.push(l,t)),t=c;else l==="dangerouslySetInnerHTML"?(c=c?c.__html:void 0,a=a?a.__html:void 0,c!=null&&a!==c&&(s=s||[]).push(l,c)):l==="children"?typeof c!="string"&&typeof c!="number"||(s=s||[]).push(l,""+c):l!=="suppressContentEditableWarning"&&l!=="suppressHydrationWarning"&&(E1.hasOwnProperty(l)?(c!=null&&l==="onScroll"&&Tt("scroll",r),s||a===c||(s=[])):(s=s||[]).push(l,c))}t&&(s=s||[]).push("style",t);var l=s;(e.updateQueue=l)&&(e.flags|=4)}};vR=function(r,e,t,n){t!==n&&(e.flags|=4)};function nf(r,e){if(!Nt)switch(r.tailMode){case"hidden":e=r.tail;for(var t=null;e!==null;)e.alternate!==null&&(t=e),e=e.sibling;t===null?r.tail=null:t.sibling=null;break;case"collapsed":t=r.tail;for(var n=null;t!==null;)t.alternate!==null&&(n=t),t=t.sibling;n===null?e||r.tail===null?r.tail=null:r.tail.sibling=null:n.sibling=null}}function $r(r){var e=r.alternate!==null&&r.alternate.child===r.child,t=0,n=0;if(e)for(var i=r.child;i!==null;)t|=i.lanes|i.childLanes,n|=i.subtreeFlags&14680064,n|=i.flags&14680064,i.return=r,i=i.sibling;else for(i=r.child;i!==null;)t|=i.lanes|i.childLanes,n|=i.subtreeFlags,n|=i.flags,i.return=r,i=i.sibling;return r.subtreeFlags|=n,r.childLanes=t,e}function lG(r,e,t){var n=e.pendingProps;switch(Q9(e),e.tag){case 2:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return $r(e),null;case 1:return Pn(e.type)&&k2(),$r(e),null;case 3:return n=e.stateNode,Ud(),Pt(Tn),Pt(en),iE(),n.pendingContext&&(n.context=n.pendingContext,n.pendingContext=null),(r===null||r.child===null)&&(I0(e)?e.flags|=4:r===null||r.memoizedState.isDehydrated&&!(e.flags&256)||(e.flags|=1024,ts!==null&&(q6(ts),ts=null))),B6(r,e),$r(e),null;case 5:nE(e);var i=gl(N1.current);if(t=e.type,r!==null&&e.stateNode!=null)bR(r,e,t,n,i),r.ref!==e.ref&&(e.flags|=512,e.flags|=2097152);else{if(!n){if(e.stateNode===null)throw Error(ee(166));return $r(e),null}if(r=gl(Fs.current),I0(e)){n=e.stateNode,t=e.type;var s=e.memoizedProps;switch(n[Rs]=e,n[D1]=s,r=(e.mode&1)!==0,t){case"dialog":Tt("cancel",n),Tt("close",n);break;case"iframe":case"object":case"embed":Tt("load",n);break;case"video":case"audio":for(i=0;i<Uf.length;i++)Tt(Uf[i],n);break;case"source":Tt("error",n);break;case"img":case"image":case"link":Tt("error",n),Tt("load",n);break;case"details":Tt("toggle",n);break;case"input":HA(n,s),Tt("invalid",n);break;case"select":n._wrapperState={wasMultiple:!!s.multiple},Tt("invalid",n);break;case"textarea":WA(n,s),Tt("invalid",n)}d6(t,s),i=null;for(var o in s)if(s.hasOwnProperty(o)){var a=s[o];o==="children"?typeof a=="string"?n.textContent!==a&&(s.suppressHydrationWarning!==!0&&C0(n.textContent,a,r),i=["children",a]):typeof a=="number"&&n.textContent!==""+a&&(s.suppressHydrationWarning!==!0&&C0(n.textContent,a,r),i=["children",""+a]):E1.hasOwnProperty(o)&&a!=null&&o==="onScroll"&&Tt("scroll",n)}switch(t){case"input":m0(n),qA(n,s,!0);break;case"textarea":m0(n),GA(n);break;case"select":case"option":break;default:typeof s.onClick=="function"&&(n.onclick=I2)}n=i,e.updateQueue=n,n!==null&&(e.flags|=4)}else{o=i.nodeType===9?i:i.ownerDocument,r==="http://www.w3.org/1999/xhtml"&&(r=GM(t)),r==="http://www.w3.org/1999/xhtml"?t==="script"?(r=o.createElement("div"),r.innerHTML="<script><\/script>",r=r.removeChild(r.firstChild)):typeof n.is=="string"?r=o.createElement(t,{is:n.is}):(r=o.createElement(t),t==="select"&&(o=r,n.multiple?o.multiple=!0:n.size&&(o.size=n.size))):r=o.createElementNS(r,t),r[Rs]=e,r[D1]=n,wR(r,e,!1,!1),e.stateNode=r;e:{switch(o=h6(t,n),t){case"dialog":Tt("cancel",r),Tt("close",r),i=n;break;case"iframe":case"object":case"embed":Tt("load",r),i=n;break;case"video":case"audio":for(i=0;i<Uf.length;i++)Tt(Uf[i],r);i=n;break;case"source":Tt("error",r),i=n;break;case"img":case"image":case"link":Tt("error",r),Tt("load",r),i=n;break;case"details":Tt("toggle",r),i=n;break;case"input":HA(r,n),i=o6(r,n),Tt("invalid",r);break;case"option":i=n;break;case"select":r._wrapperState={wasMultiple:!!n.multiple},i=Ft({},n,{value:void 0}),Tt("invalid",r);break;case"textarea":WA(r,n),i=l6(r,n),Tt("invalid",r);break;default:i=n}d6(t,i),a=i;for(s in a)if(a.hasOwnProperty(s)){var c=a[s];s==="style"?JM(r,c):s==="dangerouslySetInnerHTML"?(c=c?c.__html:void 0,c!=null&&QM(r,c)):s==="children"?typeof c=="string"?(t!=="textarea"||c!=="")&&S1(r,c):typeof c=="number"&&S1(r,""+c):s!=="suppressContentEditableWarning"&&s!=="suppressHydrationWarning"&&s!=="autoFocus"&&(E1.hasOwnProperty(s)?c!=null&&s==="onScroll"&&Tt("scroll",r):c!=null&&M9(r,s,c,o))}switch(t){case"input":m0(r),qA(r,n,!1);break;case"textarea":m0(r),GA(r);break;case"option":n.value!=null&&r.setAttribute("value",""+yc(n.value));break;case"select":r.multiple=!!n.multiple,s=n.value,s!=null?cd(r,!!n.multiple,s,!1):n.defaultValue!=null&&cd(r,!!n.multiple,n.defaultValue,!0);break;default:typeof i.onClick=="function"&&(r.onclick=I2)}switch(t){case"button":case"input":case"select":case"textarea":n=!!n.autoFocus;break e;case"img":n=!0;break e;default:n=!1}}n&&(e.flags|=4)}e.ref!==null&&(e.flags|=512,e.flags|=2097152)}return $r(e),null;case 6:if(r&&e.stateNode!=null)vR(r,e,r.memoizedProps,n);else{if(typeof n!="string"&&e.stateNode===null)throw Error(ee(166));if(t=gl(N1.current),gl(Fs.current),I0(e)){if(n=e.stateNode,t=e.memoizedProps,n[Rs]=e,(s=n.nodeValue!==t)&&(r=Xn,r!==null))switch(r.tag){case 3:C0(n.nodeValue,t,(r.mode&1)!==0);break;case 5:r.memoizedProps.suppressHydrationWarning!==!0&&C0(n.nodeValue,t,(r.mode&1)!==0)}s&&(e.flags|=4)}else n=(t.nodeType===9?t:t.ownerDocument).createTextNode(n),n[Rs]=e,e.stateNode=n}return $r(e),null;case 13:if(Pt(Lt),n=e.memoizedState,r===null||r.memoizedState!==null&&r.memoizedState.dehydrated!==null){if(Nt&&Jn!==null&&e.mode&1&&!(e.flags&128))BO(),Ld(),e.flags|=98560,s=!1;else if(s=I0(e),n!==null&&n.dehydrated!==null){if(r===null){if(!s)throw Error(ee(318));if(s=e.memoizedState,s=s!==null?s.dehydrated:null,!s)throw Error(ee(317));s[Rs]=e}else Ld(),!(e.flags&128)&&(e.memoizedState=null),e.flags|=4;$r(e),s=!1}else ts!==null&&(q6(ts),ts=null),s=!0;if(!s)return e.flags&65536?e:null}return e.flags&128?(e.lanes=t,e):(n=n!==null,n!==(r!==null&&r.memoizedState!==null)&&n&&(e.child.flags|=8192,e.mode&1&&(r===null||Lt.current&1?nr===0&&(nr=3):yE())),e.updateQueue!==null&&(e.flags|=4),$r(e),null);case 4:return Ud(),B6(r,e),r===null&&T1(e.stateNode.containerInfo),$r(e),null;case 10:return Z9(e.type._context),$r(e),null;case 17:return Pn(e.type)&&k2(),$r(e),null;case 19:if(Pt(Lt),s=e.memoizedState,s===null)return $r(e),null;if(n=(e.flags&128)!==0,o=s.rendering,o===null)if(n)nf(s,!1);else{if(nr!==0||r!==null&&r.flags&128)for(r=e.child;r!==null;){if(o=M2(r),o!==null){for(e.flags|=128,nf(s,!1),n=o.updateQueue,n!==null&&(e.updateQueue=n,e.flags|=4),e.subtreeFlags=0,n=t,t=e.child;t!==null;)s=t,r=n,s.flags&=14680066,o=s.alternate,o===null?(s.childLanes=0,s.lanes=r,s.child=null,s.subtreeFlags=0,s.memoizedProps=null,s.memoizedState=null,s.updateQueue=null,s.dependencies=null,s.stateNode=null):(s.childLanes=o.childLanes,s.lanes=o.lanes,s.child=o.child,s.subtreeFlags=0,s.deletions=null,s.memoizedProps=o.memoizedProps,s.memoizedState=o.memoizedState,s.updateQueue=o.updateQueue,s.type=o.type,r=o.dependencies,s.dependencies=r===null?null:{lanes:r.lanes,firstContext:r.firstContext}),t=t.sibling;return Ct(Lt,Lt.current&1|2),e.child}r=r.sibling}s.tail!==null&&qt()>zd&&(e.flags|=128,n=!0,nf(s,!1),e.lanes=4194304)}else{if(!n)if(r=M2(o),r!==null){if(e.flags|=128,n=!0,t=r.updateQueue,t!==null&&(e.updateQueue=t,e.flags|=4),nf(s,!0),s.tail===null&&s.tailMode==="hidden"&&!o.alternate&&!Nt)return $r(e),null}else 2*qt()-s.renderingStartTime>zd&&t!==1073741824&&(e.flags|=128,n=!0,nf(s,!1),e.lanes=4194304);s.isBackwards?(o.sibling=e.child,e.child=o):(t=s.last,t!==null?t.sibling=o:e.child=o,s.last=o)}return s.tail!==null?(e=s.tail,s.rendering=e,s.tail=e.sibling,s.renderingStartTime=qt(),e.sibling=null,t=Lt.current,Ct(Lt,n?t&1|2:t&1),e):($r(e),null);case 22:case 23:return gE(),n=e.memoizedState!==null,r!==null&&r.memoizedState!==null!==n&&(e.flags|=8192),n&&e.mode&1?Hn&1073741824&&($r(e),e.subtreeFlags&6&&(e.flags|=8192)):$r(e),null;case 24:return null;case 25:return null}throw Error(ee(156,e.tag))}function uG(r,e){switch(Q9(e),e.tag){case 1:return Pn(e.type)&&k2(),r=e.flags,r&65536?(e.flags=r&-65537|128,e):null;case 3:return Ud(),Pt(Tn),Pt(en),iE(),r=e.flags,r&65536&&!(r&128)?(e.flags=r&-65537|128,e):null;case 5:return nE(e),null;case 13:if(Pt(Lt),r=e.memoizedState,r!==null&&r.dehydrated!==null){if(e.alternate===null)throw Error(ee(340));Ld()}return r=e.flags,r&65536?(e.flags=r&-65537|128,e):null;case 19:return Pt(Lt),null;case 4:return Ud(),null;case 10:return Z9(e.type._context),null;case 22:case 23:return gE(),null;case 24:return null;default:return null}}var T0=!1,Yr=!1,dG=typeof WeakSet=="function"?WeakSet:Set,ve=null;function td(r,e){var t=r.ref;if(t!==null)if(typeof t=="function")try{t(null)}catch(n){Kt(r,e,n)}else t.current=null}function U6(r,e,t){try{t()}catch(n){Kt(r,e,n)}}var LC=!1;function hG(r,e){if(S6=x2,r=CO(),W9(r)){if("selectionStart"in r)var t={start:r.selectionStart,end:r.selectionEnd};else e:{t=(t=r.ownerDocument)&&t.defaultView||window;var n=t.getSelection&&t.getSelection();if(n&&n.rangeCount!==0){t=n.anchorNode;var i=n.anchorOffset,s=n.focusNode;n=n.focusOffset;try{t.nodeType,s.nodeType}catch{t=null;break e}var o=0,a=-1,c=-1,l=0,d=0,h=r,p=null;t:for(;;){for(var m;h!==t||i!==0&&h.nodeType!==3||(a=o+i),h!==s||n!==0&&h.nodeType!==3||(c=o+n),h.nodeType===3&&(o+=h.nodeValue.length),(m=h.firstChild)!==null;)p=h,h=m;for(;;){if(h===r)break t;if(p===t&&++l===i&&(a=o),p===s&&++d===n&&(c=o),(m=h.nextSibling)!==null)break;h=p,p=h.parentNode}h=m}t=a===-1||c===-1?null:{start:a,end:c}}else t=null}t=t||{start:0,end:0}}else t=null;for(x6={focusedElem:r,selectionRange:t},x2=!1,ve=e;ve!==null;)if(e=ve,r=e.child,(e.subtreeFlags&1028)!==0&&r!==null)r.return=e,ve=r;else for(;ve!==null;){e=ve;try{var f=e.alternate;if(e.flags&1024)switch(e.tag){case 0:case 11:case 15:break;case 1:if(f!==null){var g=f.memoizedProps,v=f.memoizedState,y=e.stateNode,w=y.getSnapshotBeforeUpdate(e.elementType===e.type?g:Ji(e.type,g),v);y.__reactInternalSnapshotBeforeUpdate=w}break;case 3:var b=e.stateNode.containerInfo;b.nodeType===1?b.textContent="":b.nodeType===9&&b.documentElement&&b.removeChild(b.documentElement);break;case 5:case 6:case 4:case 17:break;default:throw Error(ee(163))}}catch(E){Kt(e,e.return,E)}if(r=e.sibling,r!==null){r.return=e.return,ve=r;break}ve=e.return}return f=LC,LC=!1,f}function r1(r,e,t){var n=e.updateQueue;if(n=n!==null?n.lastEffect:null,n!==null){var i=n=n.next;do{if((i.tag&r)===r){var s=i.destroy;i.destroy=void 0,s!==void 0&&U6(e,t,s)}i=i.next}while(i!==n)}}function C3(r,e){if(e=e.updateQueue,e=e!==null?e.lastEffect:null,e!==null){var t=e=e.next;do{if((t.tag&r)===r){var n=t.create;t.destroy=n()}t=t.next}while(t!==e)}}function F6(r){var e=r.ref;if(e!==null){var t=r.stateNode;switch(r.tag){case 5:r=t;break;default:r=t}typeof e=="function"?e(r):e.current=r}}function ER(r){var e=r.alternate;e!==null&&(r.alternate=null,ER(e)),r.child=null,r.deletions=null,r.sibling=null,r.tag===5&&(e=r.stateNode,e!==null&&(delete e[Rs],delete e[D1],delete e[I6],delete e[GW],delete e[QW])),r.stateNode=null,r.return=null,r.dependencies=null,r.memoizedProps=null,r.memoizedState=null,r.pendingProps=null,r.stateNode=null,r.updateQueue=null}function SR(r){return r.tag===5||r.tag===3||r.tag===4}function BC(r){e:for(;;){for(;r.sibling===null;){if(r.return===null||SR(r.return))return null;r=r.return}for(r.sibling.return=r.return,r=r.sibling;r.tag!==5&&r.tag!==6&&r.tag!==18;){if(r.flags&2||r.child===null||r.tag===4)continue e;r.child.return=r,r=r.child}if(!(r.flags&2))return r.stateNode}}function z6(r,e,t){var n=r.tag;if(n===5||n===6)r=r.stateNode,e?t.nodeType===8?t.parentNode.insertBefore(r,e):t.insertBefore(r,e):(t.nodeType===8?(e=t.parentNode,e.insertBefore(r,t)):(e=t,e.appendChild(r)),t=t._reactRootContainer,t!=null||e.onclick!==null||(e.onclick=I2));else if(n!==4&&(r=r.child,r!==null))for(z6(r,e,t),r=r.sibling;r!==null;)z6(r,e,t),r=r.sibling}function V6(r,e,t){var n=r.tag;if(n===5||n===6)r=r.stateNode,e?t.insertBefore(r,e):t.appendChild(r);else if(n!==4&&(r=r.child,r!==null))for(V6(r,e,t),r=r.sibling;r!==null;)V6(r,e,t),r=r.sibling}var wr=null,Xi=!1;function da(r,e,t){for(t=t.child;t!==null;)xR(r,e,t),t=t.sibling}function xR(r,e,t){if(Us&&typeof Us.onCommitFiberUnmount=="function")try{Us.onCommitFiberUnmount(m3,t)}catch{}switch(t.tag){case 5:Yr||td(t,e);case 6:var n=wr,i=Xi;wr=null,da(r,e,t),wr=n,Xi=i,wr!==null&&(Xi?(r=wr,t=t.stateNode,r.nodeType===8?r.parentNode.removeChild(t):r.removeChild(t)):wr.removeChild(t.stateNode));break;case 18:wr!==null&&(Xi?(r=wr,t=t.stateNode,r.nodeType===8?s5(r.parentNode,t):r.nodeType===1&&s5(r,t),I1(r)):s5(wr,t.stateNode));break;case 4:n=wr,i=Xi,wr=t.stateNode.containerInfo,Xi=!0,da(r,e,t),wr=n,Xi=i;break;case 0:case 11:case 14:case 15:if(!Yr&&(n=t.updateQueue,n!==null&&(n=n.lastEffect,n!==null))){i=n=n.next;do{var s=i,o=s.destroy;s=s.tag,o!==void 0&&(s&2||s&4)&&U6(t,e,o),i=i.next}while(i!==n)}da(r,e,t);break;case 1:if(!Yr&&(td(t,e),n=t.stateNode,typeof n.componentWillUnmount=="function"))try{n.props=t.memoizedProps,n.state=t.memoizedState,n.componentWillUnmount()}catch(a){Kt(t,e,a)}da(r,e,t);break;case 21:da(r,e,t);break;case 22:t.mode&1?(Yr=(n=Yr)||t.memoizedState!==null,da(r,e,t),Yr=n):da(r,e,t);break;default:da(r,e,t)}}function UC(r){var e=r.updateQueue;if(e!==null){r.updateQueue=null;var t=r.stateNode;t===null&&(t=r.stateNode=new dG),e.forEach(function(n){var i=EG.bind(null,r,n);t.has(n)||(t.add(n),n.then(i,i))})}}function Ki(r,e){var t=e.deletions;if(t!==null)for(var n=0;n<t.length;n++){var i=t[n];try{var s=r,o=e,a=o;e:for(;a!==null;){switch(a.tag){case 5:wr=a.stateNode,Xi=!1;break e;case 3:wr=a.stateNode.containerInfo,Xi=!0;break e;case 4:wr=a.stateNode.containerInfo,Xi=!0;break e}a=a.return}if(wr===null)throw Error(ee(160));xR(s,o,i),wr=null,Xi=!1;var c=i.alternate;c!==null&&(c.return=null),i.return=null}catch(l){Kt(i,e,l)}}if(e.subtreeFlags&12854)for(e=e.child;e!==null;)AR(e,r),e=e.sibling}function AR(r,e){var t=r.alternate,n=r.flags;switch(r.tag){case 0:case 11:case 14:case 15:if(Ki(e,r),Ss(r),n&4){try{r1(3,r,r.return),C3(3,r)}catch(g){Kt(r,r.return,g)}try{r1(5,r,r.return)}catch(g){Kt(r,r.return,g)}}break;case 1:Ki(e,r),Ss(r),n&512&&t!==null&&td(t,t.return);break;case 5:if(Ki(e,r),Ss(r),n&512&&t!==null&&td(t,t.return),r.flags&32){var i=r.stateNode;try{S1(i,"")}catch(g){Kt(r,r.return,g)}}if(n&4&&(i=r.stateNode,i!=null)){var s=r.memoizedProps,o=t!==null?t.memoizedProps:s,a=r.type,c=r.updateQueue;if(r.updateQueue=null,c!==null)try{a==="input"&&s.type==="radio"&&s.name!=null&&qM(i,s),h6(a,o);var l=h6(a,s);for(o=0;o<c.length;o+=2){var d=c[o],h=c[o+1];d==="style"?JM(i,h):d==="dangerouslySetInnerHTML"?QM(i,h):d==="children"?S1(i,h):M9(i,d,h,l)}switch(a){case"input":a6(i,s);break;case"textarea":WM(i,s);break;case"select":var p=i._wrapperState.wasMultiple;i._wrapperState.wasMultiple=!!s.multiple;var m=s.value;m!=null?cd(i,!!s.multiple,m,!1):p!==!!s.multiple&&(s.defaultValue!=null?cd(i,!!s.multiple,s.defaultValue,!0):cd(i,!!s.multiple,s.multiple?[]:"",!1))}i[D1]=s}catch(g){Kt(r,r.return,g)}}break;case 6:if(Ki(e,r),Ss(r),n&4){if(r.stateNode===null)throw Error(ee(162));i=r.stateNode,s=r.memoizedProps;try{i.nodeValue=s}catch(g){Kt(r,r.return,g)}}break;case 3:if(Ki(e,r),Ss(r),n&4&&t!==null&&t.memoizedState.isDehydrated)try{I1(e.containerInfo)}catch(g){Kt(r,r.return,g)}break;case 4:Ki(e,r),Ss(r);break;case 13:Ki(e,r),Ss(r),i=r.child,i.flags&8192&&(s=i.memoizedState!==null,i.stateNode.isHidden=s,!s||i.alternate!==null&&i.alternate.memoizedState!==null||(fE=qt())),n&4&&UC(r);break;case 22:if(d=t!==null&&t.memoizedState!==null,r.mode&1?(Yr=(l=Yr)||d,Ki(e,r),Yr=l):Ki(e,r),Ss(r),n&8192){if(l=r.memoizedState!==null,(r.stateNode.isHidden=l)&&!d&&r.mode&1)for(ve=r,d=r.child;d!==null;){for(h=ve=d;ve!==null;){switch(p=ve,m=p.child,p.tag){case 0:case 11:case 14:case 15:r1(4,p,p.return);break;case 1:td(p,p.return);var f=p.stateNode;if(typeof f.componentWillUnmount=="function"){n=p,t=p.return;try{e=n,f.props=e.memoizedProps,f.state=e.memoizedState,f.componentWillUnmount()}catch(g){Kt(n,t,g)}}break;case 5:td(p,p.return);break;case 22:if(p.memoizedState!==null){zC(h);continue}}m!==null?(m.return=p,ve=m):zC(h)}d=d.sibling}e:for(d=null,h=r;;){if(h.tag===5){if(d===null){d=h;try{i=h.stateNode,l?(s=i.style,typeof s.setProperty=="function"?s.setProperty("display","none","important"):s.display="none"):(a=h.stateNode,c=h.memoizedProps.style,o=c!=null&&c.hasOwnProperty("display")?c.display:null,a.style.display=YM("display",o))}catch(g){Kt(r,r.return,g)}}}else if(h.tag===6){if(d===null)try{h.stateNode.nodeValue=l?"":h.memoizedProps}catch(g){Kt(r,r.return,g)}}else if((h.tag!==22&&h.tag!==23||h.memoizedState===null||h===r)&&h.child!==null){h.child.return=h,h=h.child;continue}if(h===r)break e;for(;h.sibling===null;){if(h.return===null||h.return===r)break e;d===h&&(d=null),h=h.return}d===h&&(d=null),h.sibling.return=h.return,h=h.sibling}}break;case 19:Ki(e,r),Ss(r),n&4&&UC(r);break;case 21:break;default:Ki(e,r),Ss(r)}}function Ss(r){var e=r.flags;if(e&2){try{e:{for(var t=r.return;t!==null;){if(SR(t)){var n=t;break e}t=t.return}throw Error(ee(160))}switch(n.tag){case 5:var i=n.stateNode;n.flags&32&&(S1(i,""),n.flags&=-33);var s=BC(r);V6(r,s,i);break;case 3:case 4:var o=n.stateNode.containerInfo,a=BC(r);z6(r,a,o);break;default:throw Error(ee(161))}}catch(c){Kt(r,r.return,c)}r.flags&=-3}e&4096&&(r.flags&=-4097)}function fG(r,e,t){ve=r,CR(r)}function CR(r,e,t){for(var n=(r.mode&1)!==0;ve!==null;){var i=ve,s=i.child;if(i.tag===22&&n){var o=i.memoizedState!==null||T0;if(!o){var a=i.alternate,c=a!==null&&a.memoizedState!==null||Yr;a=T0;var l=Yr;if(T0=o,(Yr=c)&&!l)for(ve=i;ve!==null;)o=ve,c=o.child,o.tag===22&&o.memoizedState!==null?VC(i):c!==null?(c.return=o,ve=c):VC(i);for(;s!==null;)ve=s,CR(s),s=s.sibling;ve=i,T0=a,Yr=l}FC(r)}else i.subtreeFlags&8772&&s!==null?(s.return=i,ve=s):FC(r)}}function FC(r){for(;ve!==null;){var e=ve;if(e.flags&8772){var t=e.alternate;try{if(e.flags&8772)switch(e.tag){case 0:case 11:case 15:Yr||C3(5,e);break;case 1:var n=e.stateNode;if(e.flags&4&&!Yr)if(t===null)n.componentDidMount();else{var i=e.elementType===e.type?t.memoizedProps:Ji(e.type,t.memoizedProps);n.componentDidUpdate(i,t.memoizedState,n.__reactInternalSnapshotBeforeUpdate)}var s=e.updateQueue;s!==null&&AC(e,s,n);break;case 3:var o=e.updateQueue;if(o!==null){if(t=null,e.child!==null)switch(e.child.tag){case 5:t=e.child.stateNode;break;case 1:t=e.child.stateNode}AC(e,o,t)}break;case 5:var a=e.stateNode;if(t===null&&e.flags&4){t=a;var c=e.memoizedProps;switch(e.type){case"button":case"input":case"select":case"textarea":c.autoFocus&&t.focus();break;case"img":c.src&&(t.src=c.src)}}break;case 6:break;case 4:break;case 12:break;case 13:if(e.memoizedState===null){var l=e.alternate;if(l!==null){var d=l.memoizedState;if(d!==null){var h=d.dehydrated;h!==null&&I1(h)}}}break;case 19:case 17:case 21:case 22:case 23:case 25:break;default:throw Error(ee(163))}Yr||e.flags&512&&F6(e)}catch(p){Kt(e,e.return,p)}}if(e===r){ve=null;break}if(t=e.sibling,t!==null){t.return=e.return,ve=t;break}ve=e.return}}function zC(r){for(;ve!==null;){var e=ve;if(e===r){ve=null;break}var t=e.sibling;if(t!==null){t.return=e.return,ve=t;break}ve=e.return}}function VC(r){for(;ve!==null;){var e=ve;try{switch(e.tag){case 0:case 11:case 15:var t=e.return;try{C3(4,e)}catch(c){Kt(e,t,c)}break;case 1:var n=e.stateNode;if(typeof n.componentDidMount=="function"){var i=e.return;try{n.componentDidMount()}catch(c){Kt(e,i,c)}}var s=e.return;try{F6(e)}catch(c){Kt(e,s,c)}break;case 5:var o=e.return;try{F6(e)}catch(c){Kt(e,o,c)}}}catch(c){Kt(e,e.return,c)}if(e===r){ve=null;break}var a=e.sibling;if(a!==null){a.return=e.return,ve=a;break}ve=e.return}}var pG=Math.ceil,L2=Qo.ReactCurrentDispatcher,dE=Qo.ReactCurrentOwner,Ti=Qo.ReactCurrentBatchConfig,rt=0,hr=null,Xt=null,Sr=0,Hn=0,rd=Oc(0),nr=0,L1=null,zl=0,I3=0,hE=0,n1=null,Cn=null,fE=0,zd=1/0,fo=null,B2=!1,K6=null,sc=null,P0=!1,Wa=null,U2=0,i1=0,j6=null,Mg=-1,Og=0;function un(){return rt&6?qt():Mg!==-1?Mg:Mg=qt()}function oc(r){return r.mode&1?rt&2&&Sr!==0?Sr&-Sr:JW.transition!==null?(Og===0&&(Og=lO()),Og):(r=ht,r!==0||(r=window.event,r=r===void 0?16:yO(r.type)),r):1}function as(r,e,t,n){if(50<i1)throw i1=0,j6=null,Error(ee(185));Ip(r,t,n),(!(rt&2)||r!==hr)&&(r===hr&&(!(rt&2)&&(I3|=t),nr===4&&Fa(r,Sr)),Dn(r,n),t===1&&rt===0&&!(e.mode&1)&&(zd=qt()+500,S3&&Rc()))}function Dn(r,e){var t=r.callbackNode;Jq(r,e);var n=S2(r,r===hr?Sr:0);if(n===0)t!==null&&JA(t),r.callbackNode=null,r.callbackPriority=0;else if(e=n&-n,r.callbackPriority!==e){if(t!=null&&JA(t),e===1)r.tag===0?YW(KC.bind(null,r)):OO(KC.bind(null,r)),qW(function(){!(rt&6)&&Rc()}),t=null;else{switch(uO(n)){case 1:t=U9;break;case 4:t=aO;break;case 16:t=E2;break;case 536870912:t=cO;break;default:t=E2}t=NR(t,IR.bind(null,r))}r.callbackPriority=e,r.callbackNode=t}}function IR(r,e){if(Mg=-1,Og=0,rt&6)throw Error(ee(327));var t=r.callbackNode;if(fd()&&r.callbackNode!==t)return null;var n=S2(r,r===hr?Sr:0);if(n===0)return null;if(n&30||n&r.expiredLanes||e)e=F2(r,n);else{e=n;var i=rt;rt|=2;var s=_R();(hr!==r||Sr!==e)&&(fo=null,zd=qt()+500,Cl(r,e));do try{mG();break}catch(a){kR(r,a)}while(!0);X9(),L2.current=s,rt=i,Xt!==null?e=0:(hr=null,Sr=0,e=nr)}if(e!==0){if(e===2&&(i=m6(r),i!==0&&(n=i,e=H6(r,i))),e===1)throw t=L1,Cl(r,0),Fa(r,n),Dn(r,qt()),t;if(e===6)Fa(r,n);else{if(i=r.current.alternate,!(n&30)&&!gG(i)&&(e=F2(r,n),e===2&&(s=m6(r),s!==0&&(n=s,e=H6(r,s))),e===1))throw t=L1,Cl(r,0),Fa(r,n),Dn(r,qt()),t;switch(r.finishedWork=i,r.finishedLanes=n,e){case 0:case 1:throw Error(ee(345));case 2:il(r,Cn,fo);break;case 3:if(Fa(r,n),(n&130023424)===n&&(e=fE+500-qt(),10<e)){if(S2(r,0)!==0)break;if(i=r.suspendedLanes,(i&n)!==n){un(),r.pingedLanes|=r.suspendedLanes&i;break}r.timeoutHandle=C6(il.bind(null,r,Cn,fo),e);break}il(r,Cn,fo);break;case 4:if(Fa(r,n),(n&4194240)===n)break;for(e=r.eventTimes,i=-1;0<n;){var o=31-os(n);s=1<<o,o=e[o],o>i&&(i=o),n&=~s}if(n=i,n=qt()-n,n=(120>n?120:480>n?480:1080>n?1080:1920>n?1920:3e3>n?3e3:4320>n?4320:1960*pG(n/1960))-n,10<n){r.timeoutHandle=C6(il.bind(null,r,Cn,fo),n);break}il(r,Cn,fo);break;case 5:il(r,Cn,fo);break;default:throw Error(ee(329))}}}return Dn(r,qt()),r.callbackNode===t?IR.bind(null,r):null}function H6(r,e){var t=n1;return r.current.memoizedState.isDehydrated&&(Cl(r,e).flags|=256),r=F2(r,e),r!==2&&(e=Cn,Cn=t,e!==null&&q6(e)),r}function q6(r){Cn===null?Cn=r:Cn.push.apply(Cn,r)}function gG(r){for(var e=r;;){if(e.flags&16384){var t=e.updateQueue;if(t!==null&&(t=t.stores,t!==null))for(var n=0;n<t.length;n++){var i=t[n],s=i.getSnapshot;i=i.value;try{if(!hs(s(),i))return!1}catch{return!1}}}if(t=e.child,e.subtreeFlags&16384&&t!==null)t.return=e,e=t;else{if(e===r)break;for(;e.sibling===null;){if(e.return===null||e.return===r)return!0;e=e.return}e.sibling.return=e.return,e=e.sibling}}return!0}function Fa(r,e){for(e&=~hE,e&=~I3,r.suspendedLanes|=e,r.pingedLanes&=~e,r=r.expirationTimes;0<e;){var t=31-os(e),n=1<<t;r[t]=-1,e&=~n}}function KC(r){if(rt&6)throw Error(ee(327));fd();var e=S2(r,0);if(!(e&1))return Dn(r,qt()),null;var t=F2(r,e);if(r.tag!==0&&t===2){var n=m6(r);n!==0&&(e=n,t=H6(r,n))}if(t===1)throw t=L1,Cl(r,0),Fa(r,e),Dn(r,qt()),t;if(t===6)throw Error(ee(345));return r.finishedWork=r.current.alternate,r.finishedLanes=e,il(r,Cn,fo),Dn(r,qt()),null}function pE(r,e){var t=rt;rt|=1;try{return r(e)}finally{rt=t,rt===0&&(zd=qt()+500,S3&&Rc())}}function Vl(r){Wa!==null&&Wa.tag===0&&!(rt&6)&&fd();var e=rt;rt|=1;var t=Ti.transition,n=ht;try{if(Ti.transition=null,ht=1,r)return r()}finally{ht=n,Ti.transition=t,rt=e,!(rt&6)&&Rc()}}function gE(){Hn=rd.current,Pt(rd)}function Cl(r,e){r.finishedWork=null,r.finishedLanes=0;var t=r.timeoutHandle;if(t!==-1&&(r.timeoutHandle=-1,HW(t)),Xt!==null)for(t=Xt.return;t!==null;){var n=t;switch(Q9(n),n.tag){case 1:n=n.type.childContextTypes,n!=null&&k2();break;case 3:Ud(),Pt(Tn),Pt(en),iE();break;case 5:nE(n);break;case 4:Ud();break;case 13:Pt(Lt);break;case 19:Pt(Lt);break;case 10:Z9(n.type._context);break;case 22:case 23:gE()}t=t.return}if(hr=r,Xt=r=ac(r.current,null),Sr=Hn=e,nr=0,L1=null,hE=I3=zl=0,Cn=n1=null,pl!==null){for(e=0;e<pl.length;e++)if(t=pl[e],n=t.interleaved,n!==null){t.interleaved=null;var i=n.next,s=t.pending;if(s!==null){var o=s.next;s.next=i,n.next=o}t.pending=n}pl=null}return r}function kR(r,e){do{var t=Xt;try{if(X9(),Dg.current=R2,O2){for(var n=Ut.memoizedState;n!==null;){var i=n.queue;i!==null&&(i.pending=null),n=n.next}O2=!1}if(Fl=0,ur=rr=Ut=null,t1=!1,M1=0,dE.current=null,t===null||t.return===null){nr=1,L1=e,Xt=null;break}e:{var s=r,o=t.return,a=t,c=e;if(e=Sr,a.flags|=32768,c!==null&&typeof c=="object"&&typeof c.then=="function"){var l=c,d=a,h=d.tag;if(!(d.mode&1)&&(h===0||h===11||h===15)){var p=d.alternate;p?(d.updateQueue=p.updateQueue,d.memoizedState=p.memoizedState,d.lanes=p.lanes):(d.updateQueue=null,d.memoizedState=null)}var m=PC(o);if(m!==null){m.flags&=-257,DC(m,o,a,s,e),m.mode&1&&TC(s,l,e),e=m,c=l;var f=e.updateQueue;if(f===null){var g=new Set;g.add(c),e.updateQueue=g}else f.add(c);break e}else{if(!(e&1)){TC(s,l,e),yE();break e}c=Error(ee(426))}}else if(Nt&&a.mode&1){var v=PC(o);if(v!==null){!(v.flags&65536)&&(v.flags|=256),DC(v,o,a,s,e),Y9(Fd(c,a));break e}}s=c=Fd(c,a),nr!==4&&(nr=2),n1===null?n1=[s]:n1.push(s),s=o;do{switch(s.tag){case 3:s.flags|=65536,e&=-e,s.lanes|=e;var y=uR(s,c,e);xC(s,y);break e;case 1:a=c;var w=s.type,b=s.stateNode;if(!(s.flags&128)&&(typeof w.getDerivedStateFromError=="function"||b!==null&&typeof b.componentDidCatch=="function"&&(sc===null||!sc.has(b)))){s.flags|=65536,e&=-e,s.lanes|=e;var E=dR(s,a,e);xC(s,E);break e}}s=s.return}while(s!==null)}PR(t)}catch(A){e=A,Xt===t&&t!==null&&(Xt=t=t.return);continue}break}while(!0)}function _R(){var r=L2.current;return L2.current=R2,r===null?R2:r}function yE(){(nr===0||nr===3||nr===2)&&(nr=4),hr===null||!(zl&268435455)&&!(I3&268435455)||Fa(hr,Sr)}function F2(r,e){var t=rt;rt|=2;var n=_R();(hr!==r||Sr!==e)&&(fo=null,Cl(r,e));do try{yG();break}catch(i){kR(r,i)}while(!0);if(X9(),rt=t,L2.current=n,Xt!==null)throw Error(ee(261));return hr=null,Sr=0,nr}function yG(){for(;Xt!==null;)TR(Xt)}function mG(){for(;Xt!==null&&!Vq();)TR(Xt)}function TR(r){var e=$R(r.alternate,r,Hn);r.memoizedProps=r.pendingProps,e===null?PR(r):Xt=e,dE.current=null}function PR(r){var e=r;do{var t=e.alternate;if(r=e.return,e.flags&32768){if(t=uG(t,e),t!==null){t.flags&=32767,Xt=t;return}if(r!==null)r.flags|=32768,r.subtreeFlags=0,r.deletions=null;else{nr=6,Xt=null;return}}else if(t=lG(t,e,Hn),t!==null){Xt=t;return}if(e=e.sibling,e!==null){Xt=e;return}Xt=e=r}while(e!==null);nr===0&&(nr=5)}function il(r,e,t){var n=ht,i=Ti.transition;try{Ti.transition=null,ht=1,wG(r,e,t,n)}finally{Ti.transition=i,ht=n}return null}function wG(r,e,t,n){do fd();while(Wa!==null);if(rt&6)throw Error(ee(327));t=r.finishedWork;var i=r.finishedLanes;if(t===null)return null;if(r.finishedWork=null,r.finishedLanes=0,t===r.current)throw Error(ee(177));r.callbackNode=null,r.callbackPriority=0;var s=t.lanes|t.childLanes;if(Xq(r,s),r===hr&&(Xt=hr=null,Sr=0),!(t.subtreeFlags&2064)&&!(t.flags&2064)||P0||(P0=!0,NR(E2,function(){return fd(),null})),s=(t.flags&15990)!==0,t.subtreeFlags&15990||s){s=Ti.transition,Ti.transition=null;var o=ht;ht=1;var a=rt;rt|=4,dE.current=null,hG(r,t),AR(t,r),BW(x6),x2=!!S6,x6=S6=null,r.current=t,fG(t),Kq(),rt=a,ht=o,Ti.transition=s}else r.current=t;if(P0&&(P0=!1,Wa=r,U2=i),s=r.pendingLanes,s===0&&(sc=null),qq(t.stateNode),Dn(r,qt()),e!==null)for(n=r.onRecoverableError,t=0;t<e.length;t++)i=e[t],n(i.value,{componentStack:i.stack,digest:i.digest});if(B2)throw B2=!1,r=K6,K6=null,r;return U2&1&&r.tag!==0&&fd(),s=r.pendingLanes,s&1?r===j6?i1++:(i1=0,j6=r):i1=0,Rc(),null}function fd(){if(Wa!==null){var r=uO(U2),e=Ti.transition,t=ht;try{if(Ti.transition=null,ht=16>r?16:r,Wa===null)var n=!1;else{if(r=Wa,Wa=null,U2=0,rt&6)throw Error(ee(331));var i=rt;for(rt|=4,ve=r.current;ve!==null;){var s=ve,o=s.child;if(ve.flags&16){var a=s.deletions;if(a!==null){for(var c=0;c<a.length;c++){var l=a[c];for(ve=l;ve!==null;){var d=ve;switch(d.tag){case 0:case 11:case 15:r1(8,d,s)}var h=d.child;if(h!==null)h.return=d,ve=h;else for(;ve!==null;){d=ve;var p=d.sibling,m=d.return;if(ER(d),d===l){ve=null;break}if(p!==null){p.return=m,ve=p;break}ve=m}}}var f=s.alternate;if(f!==null){var g=f.child;if(g!==null){f.child=null;do{var v=g.sibling;g.sibling=null,g=v}while(g!==null)}}ve=s}}if(s.subtreeFlags&2064&&o!==null)o.return=s,ve=o;else e:for(;ve!==null;){if(s=ve,s.flags&2048)switch(s.tag){case 0:case 11:case 15:r1(9,s,s.return)}var y=s.sibling;if(y!==null){y.return=s.return,ve=y;break e}ve=s.return}}var w=r.current;for(ve=w;ve!==null;){o=ve;var b=o.child;if(o.subtreeFlags&2064&&b!==null)b.return=o,ve=b;else e:for(o=w;ve!==null;){if(a=ve,a.flags&2048)try{switch(a.tag){case 0:case 11:case 15:C3(9,a)}}catch(A){Kt(a,a.return,A)}if(a===o){ve=null;break e}var E=a.sibling;if(E!==null){E.return=a.return,ve=E;break e}ve=a.return}}if(rt=i,Rc(),Us&&typeof Us.onPostCommitFiberRoot=="function")try{Us.onPostCommitFiberRoot(m3,r)}catch{}n=!0}return n}finally{ht=t,Ti.transition=e}}return!1}function jC(r,e,t){e=Fd(t,e),e=uR(r,e,1),r=ic(r,e,1),e=un(),r!==null&&(Ip(r,1,e),Dn(r,e))}function Kt(r,e,t){if(r.tag===3)jC(r,r,t);else for(;e!==null;){if(e.tag===3){jC(e,r,t);break}else if(e.tag===1){var n=e.stateNode;if(typeof e.type.getDerivedStateFromError=="function"||typeof n.componentDidCatch=="function"&&(sc===null||!sc.has(n))){r=Fd(t,r),r=dR(e,r,1),e=ic(e,r,1),r=un(),e!==null&&(Ip(e,1,r),Dn(e,r));break}}e=e.return}}function bG(r,e,t){var n=r.pingCache;n!==null&&n.delete(e),e=un(),r.pingedLanes|=r.suspendedLanes&t,hr===r&&(Sr&t)===t&&(nr===4||nr===3&&(Sr&130023424)===Sr&&500>qt()-fE?Cl(r,0):hE|=t),Dn(r,e)}function DR(r,e){e===0&&(r.mode&1?(e=v0,v0<<=1,!(v0&130023424)&&(v0=4194304)):e=1);var t=un();r=Bo(r,e),r!==null&&(Ip(r,e,t),Dn(r,t))}function vG(r){var e=r.memoizedState,t=0;e!==null&&(t=e.retryLane),DR(r,t)}function EG(r,e){var t=0;switch(r.tag){case 13:var n=r.stateNode,i=r.memoizedState;i!==null&&(t=i.retryLane);break;case 19:n=r.stateNode;break;default:throw Error(ee(314))}n!==null&&n.delete(e),DR(r,t)}var $R;$R=function(r,e,t){if(r!==null)if(r.memoizedProps!==e.pendingProps||Tn.current)kn=!0;else{if(!(r.lanes&t)&&!(e.flags&128))return kn=!1,cG(r,e,t);kn=!!(r.flags&131072)}else kn=!1,Nt&&e.flags&1048576&&RO(e,P2,e.index);switch(e.lanes=0,e.tag){case 2:var n=e.type;Ng(r,e),r=e.pendingProps;var i=Rd(e,en.current);hd(e,t),i=oE(null,e,n,r,i,t);var s=aE();return e.flags|=1,typeof i=="object"&&i!==null&&typeof i.render=="function"&&i.$$typeof===void 0?(e.tag=1,e.memoizedState=null,e.updateQueue=null,Pn(n)?(s=!0,_2(e)):s=!1,e.memoizedState=i.state!==null&&i.state!==void 0?i.state:null,tE(e),i.updater=A3,e.stateNode=i,i._reactInternals=e,$6(e,n,r,t),e=O6(null,e,n,!0,s,t)):(e.tag=0,Nt&&s&&G9(e),sn(null,e,i,t),e=e.child),e;case 16:n=e.elementType;e:{switch(Ng(r,e),r=e.pendingProps,i=n._init,n=i(n._payload),e.type=n,i=e.tag=xG(n),r=Ji(n,r),i){case 0:e=M6(null,e,n,r,t);break e;case 1:e=MC(null,e,n,r,t);break e;case 11:e=$C(null,e,n,r,t);break e;case 14:e=NC(null,e,n,Ji(n.type,r),t);break e}throw Error(ee(306,n,""))}return e;case 0:return n=e.type,i=e.pendingProps,i=e.elementType===n?i:Ji(n,i),M6(r,e,n,i,t);case 1:return n=e.type,i=e.pendingProps,i=e.elementType===n?i:Ji(n,i),MC(r,e,n,i,t);case 3:e:{if(gR(e),r===null)throw Error(ee(387));n=e.pendingProps,s=e.memoizedState,i=s.element,VO(r,e),N2(e,n,null,t);var o=e.memoizedState;if(n=o.element,s.isDehydrated)if(s={element:n,isDehydrated:!1,cache:o.cache,pendingSuspenseBoundaries:o.pendingSuspenseBoundaries,transitions:o.transitions},e.updateQueue.baseState=s,e.memoizedState=s,e.flags&256){i=Fd(Error(ee(423)),e),e=OC(r,e,n,t,i);break e}else if(n!==i){i=Fd(Error(ee(424)),e),e=OC(r,e,n,t,i);break e}else for(Jn=nc(e.stateNode.containerInfo.firstChild),Xn=e,Nt=!0,ts=null,t=FO(e,null,n,t),e.child=t;t;)t.flags=t.flags&-3|4096,t=t.sibling;else{if(Ld(),n===i){e=Uo(r,e,t);break e}sn(r,e,n,t)}e=e.child}return e;case 5:return KO(e),r===null&&T6(e),n=e.type,i=e.pendingProps,s=r!==null?r.memoizedProps:null,o=i.children,A6(n,i)?o=null:s!==null&&A6(n,s)&&(e.flags|=32),pR(r,e),sn(r,e,o,t),e.child;case 6:return r===null&&T6(e),null;case 13:return yR(r,e,t);case 4:return rE(e,e.stateNode.containerInfo),n=e.pendingProps,r===null?e.child=Bd(e,null,n,t):sn(r,e,n,t),e.child;case 11:return n=e.type,i=e.pendingProps,i=e.elementType===n?i:Ji(n,i),$C(r,e,n,i,t);case 7:return sn(r,e,e.pendingProps,t),e.child;case 8:return sn(r,e,e.pendingProps.children,t),e.child;case 12:return sn(r,e,e.pendingProps.children,t),e.child;case 10:e:{if(n=e.type._context,i=e.pendingProps,s=e.memoizedProps,o=i.value,Ct(D2,n._currentValue),n._currentValue=o,s!==null)if(hs(s.value,o)){if(s.children===i.children&&!Tn.current){e=Uo(r,e,t);break e}}else for(s=e.child,s!==null&&(s.return=e);s!==null;){var a=s.dependencies;if(a!==null){o=s.child;for(var c=a.firstContext;c!==null;){if(c.context===n){if(s.tag===1){c=To(-1,t&-t),c.tag=2;var l=s.updateQueue;if(l!==null){l=l.shared;var d=l.pending;d===null?c.next=c:(c.next=d.next,d.next=c),l.pending=c}}s.lanes|=t,c=s.alternate,c!==null&&(c.lanes|=t),P6(s.return,t,e),a.lanes|=t;break}c=c.next}}else if(s.tag===10)o=s.type===e.type?null:s.child;else if(s.tag===18){if(o=s.return,o===null)throw Error(ee(341));o.lanes|=t,a=o.alternate,a!==null&&(a.lanes|=t),P6(o,t,e),o=s.sibling}else o=s.child;if(o!==null)o.return=s;else for(o=s;o!==null;){if(o===e){o=null;break}if(s=o.sibling,s!==null){s.return=o.return,o=s;break}o=o.return}s=o}sn(r,e,i.children,t),e=e.child}return e;case 9:return i=e.type,n=e.pendingProps.children,hd(e,t),i=$i(i),n=n(i),e.flags|=1,sn(r,e,n,t),e.child;case 14:return n=e.type,i=Ji(n,e.pendingProps),i=Ji(n.type,i),NC(r,e,n,i,t);case 15:return hR(r,e,e.type,e.pendingProps,t);case 17:return n=e.type,i=e.pendingProps,i=e.elementType===n?i:Ji(n,i),Ng(r,e),e.tag=1,Pn(n)?(r=!0,_2(e)):r=!1,hd(e,t),lR(e,n,i),$6(e,n,i,t),O6(null,e,n,!0,r,t);case 19:return mR(r,e,t);case 22:return fR(r,e,t)}throw Error(ee(156,e.tag))};function NR(r,e){return oO(r,e)}function SG(r,e,t,n){this.tag=r,this.key=t,this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null,this.index=0,this.ref=null,this.pendingProps=e,this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null,this.mode=n,this.subtreeFlags=this.flags=0,this.deletions=null,this.childLanes=this.lanes=0,this.alternate=null}function Ai(r,e,t,n){return new SG(r,e,t,n)}function mE(r){return r=r.prototype,!(!r||!r.isReactComponent)}function xG(r){if(typeof r=="function")return mE(r)?1:0;if(r!=null){if(r=r.$$typeof,r===R9)return 11;if(r===L9)return 14}return 2}function ac(r,e){var t=r.alternate;return t===null?(t=Ai(r.tag,e,r.key,r.mode),t.elementType=r.elementType,t.type=r.type,t.stateNode=r.stateNode,t.alternate=r,r.alternate=t):(t.pendingProps=e,t.type=r.type,t.flags=0,t.subtreeFlags=0,t.deletions=null),t.flags=r.flags&14680064,t.childLanes=r.childLanes,t.lanes=r.lanes,t.child=r.child,t.memoizedProps=r.memoizedProps,t.memoizedState=r.memoizedState,t.updateQueue=r.updateQueue,e=r.dependencies,t.dependencies=e===null?null:{lanes:e.lanes,firstContext:e.firstContext},t.sibling=r.sibling,t.index=r.index,t.ref=r.ref,t}function Rg(r,e,t,n,i,s){var o=2;if(n=r,typeof r=="function")mE(r)&&(o=1);else if(typeof r=="string")o=5;else e:switch(r){case qu:return Il(t.children,i,s,e);case O9:o=8,i|=8;break;case r6:return r=Ai(12,t,e,i|2),r.elementType=r6,r.lanes=s,r;case n6:return r=Ai(13,t,e,i),r.elementType=n6,r.lanes=s,r;case i6:return r=Ai(19,t,e,i),r.elementType=i6,r.lanes=s,r;case KM:return k3(t,i,s,e);default:if(typeof r=="object"&&r!==null)switch(r.$$typeof){case zM:o=10;break e;case VM:o=9;break e;case R9:o=11;break e;case L9:o=14;break e;case Ia:o=16,n=null;break e}throw Error(ee(130,r==null?r:typeof r,""))}return e=Ai(o,t,e,i),e.elementType=r,e.type=n,e.lanes=s,e}function Il(r,e,t,n){return r=Ai(7,r,n,e),r.lanes=t,r}function k3(r,e,t,n){return r=Ai(22,r,n,e),r.elementType=KM,r.lanes=t,r.stateNode={isHidden:!1},r}function f5(r,e,t){return r=Ai(6,r,null,e),r.lanes=t,r}function p5(r,e,t){return e=Ai(4,r.children!==null?r.children:[],r.key,e),e.lanes=t,e.stateNode={containerInfo:r.containerInfo,pendingChildren:null,implementation:r.implementation},e}function AG(r,e,t,n,i){this.tag=e,this.containerInfo=r,this.finishedWork=this.pingCache=this.current=this.pendingChildren=null,this.timeoutHandle=-1,this.callbackNode=this.pendingContext=this.context=null,this.callbackPriority=0,this.eventTimes=G4(0),this.expirationTimes=G4(-1),this.entangledLanes=this.finishedLanes=this.mutableReadLanes=this.expiredLanes=this.pingedLanes=this.suspendedLanes=this.pendingLanes=0,this.entanglements=G4(0),this.identifierPrefix=n,this.onRecoverableError=i,this.mutableSourceEagerHydrationData=null}function wE(r,e,t,n,i,s,o,a,c){return r=new AG(r,e,t,a,c),e===1?(e=1,s===!0&&(e|=8)):e=0,s=Ai(3,null,null,e),r.current=s,s.stateNode=r,s.memoizedState={element:n,isDehydrated:t,cache:null,transitions:null,pendingSuspenseBoundaries:null},tE(s),r}function CG(r,e,t){var n=3<arguments.length&&arguments[3]!==void 0?arguments[3]:null;return{$$typeof:Hu,key:n==null?null:""+n,children:r,containerInfo:e,implementation:t}}function MR(r){if(!r)return mc;r=r._reactInternals;e:{if(pu(r)!==r||r.tag!==1)throw Error(ee(170));var e=r;do{switch(e.tag){case 3:e=e.stateNode.context;break e;case 1:if(Pn(e.type)){e=e.stateNode.__reactInternalMemoizedMergedChildContext;break e}}e=e.return}while(e!==null);throw Error(ee(171))}if(r.tag===1){var t=r.type;if(Pn(t))return MO(r,t,e)}return e}function OR(r,e,t,n,i,s,o,a,c){return r=wE(t,n,!0,r,i,s,o,a,c),r.context=MR(null),t=r.current,n=un(),i=oc(t),s=To(n,i),s.callback=e??null,ic(t,s,i),r.current.lanes=i,Ip(r,i,n),Dn(r,n),r}function _3(r,e,t,n){var i=e.current,s=un(),o=oc(i);return t=MR(t),e.context===null?e.context=t:e.pendingContext=t,e=To(s,o),e.payload={element:r},n=n===void 0?null:n,n!==null&&(e.callback=n),r=ic(i,e,o),r!==null&&(as(r,i,o,s),Pg(r,i,o)),o}function z2(r){if(r=r.current,!r.child)return null;switch(r.child.tag){case 5:return r.child.stateNode;default:return r.child.stateNode}}function HC(r,e){if(r=r.memoizedState,r!==null&&r.dehydrated!==null){var t=r.retryLane;r.retryLane=t!==0&&t<e?t:e}}function bE(r,e){HC(r,e),(r=r.alternate)&&HC(r,e)}function IG(){return null}var RR=typeof reportError=="function"?reportError:function(r){console.error(r)};function vE(r){this._internalRoot=r}T3.prototype.render=vE.prototype.render=function(r){var e=this._internalRoot;if(e===null)throw Error(ee(409));_3(r,e,null,null)};T3.prototype.unmount=vE.prototype.unmount=function(){var r=this._internalRoot;if(r!==null){this._internalRoot=null;var e=r.containerInfo;Vl(function(){_3(null,r,null,null)}),e[Lo]=null}};function T3(r){this._internalRoot=r}T3.prototype.unstable_scheduleHydration=function(r){if(r){var e=fO();r={blockedOn:null,target:r,priority:e};for(var t=0;t<Ua.length&&e!==0&&e<Ua[t].priority;t++);Ua.splice(t,0,r),t===0&&gO(r)}};function EE(r){return!(!r||r.nodeType!==1&&r.nodeType!==9&&r.nodeType!==11)}function P3(r){return!(!r||r.nodeType!==1&&r.nodeType!==9&&r.nodeType!==11&&(r.nodeType!==8||r.nodeValue!==" react-mount-point-unstable "))}function qC(){}function kG(r,e,t,n,i){if(i){if(typeof n=="function"){var s=n;n=function(){var l=z2(o);s.call(l)}}var o=OR(e,n,r,0,null,!1,!1,"",qC);return r._reactRootContainer=o,r[Lo]=o.current,T1(r.nodeType===8?r.parentNode:r),Vl(),o}for(;i=r.lastChild;)r.removeChild(i);if(typeof n=="function"){var a=n;n=function(){var l=z2(c);a.call(l)}}var c=wE(r,0,!1,null,null,!1,!1,"",qC);return r._reactRootContainer=c,r[Lo]=c.current,T1(r.nodeType===8?r.parentNode:r),Vl(function(){_3(e,c,t,n)}),c}function D3(r,e,t,n,i){var s=t._reactRootContainer;if(s){var o=s;if(typeof i=="function"){var a=i;i=function(){var c=z2(o);a.call(c)}}_3(e,o,r,i)}else o=kG(t,e,r,i,n);return z2(o)}dO=function(r){switch(r.tag){case 3:var e=r.stateNode;if(e.current.memoizedState.isDehydrated){var t=Bf(e.pendingLanes);t!==0&&(F9(e,t|1),Dn(e,qt()),!(rt&6)&&(zd=qt()+500,Rc()))}break;case 13:Vl(function(){var n=Bo(r,1);if(n!==null){var i=un();as(n,r,1,i)}}),bE(r,1)}};z9=function(r){if(r.tag===13){var e=Bo(r,134217728);if(e!==null){var t=un();as(e,r,134217728,t)}bE(r,134217728)}};hO=function(r){if(r.tag===13){var e=oc(r),t=Bo(r,e);if(t!==null){var n=un();as(t,r,e,n)}bE(r,e)}};fO=function(){return ht};pO=function(r,e){var t=ht;try{return ht=r,e()}finally{ht=t}};p6=function(r,e,t){switch(e){case"input":if(a6(r,t),e=t.name,t.type==="radio"&&e!=null){for(t=r;t.parentNode;)t=t.parentNode;for(t=t.querySelectorAll("input[name="+JSON.stringify(""+e)+'][type="radio"]'),e=0;e<t.length;e++){var n=t[e];if(n!==r&&n.form===r.form){var i=E3(n);if(!i)throw Error(ee(90));HM(n),a6(n,i)}}}break;case"textarea":WM(r,t);break;case"select":e=t.value,e!=null&&cd(r,!!t.multiple,e,!1)}};eO=pE;tO=Vl;var _G={usingClientEntryPoint:!1,Events:[_p,Yu,E3,XM,ZM,pE]},sf={findFiberByHostInstance:fl,bundleType:0,version:"18.3.1",rendererPackageName:"react-dom"},TG={bundleType:sf.bundleType,version:sf.version,rendererPackageName:sf.rendererPackageName,rendererConfig:sf.rendererConfig,overrideHookState:null,overrideHookStateDeletePath:null,overrideHookStateRenamePath:null,overrideProps:null,overridePropsDeletePath:null,overridePropsRenamePath:null,setErrorHandler:null,setSuspenseHandler:null,scheduleUpdate:null,currentDispatcherRef:Qo.ReactCurrentDispatcher,findHostInstanceByFiber:function(r){return r=iO(r),r===null?null:r.stateNode},findFiberByHostInstance:sf.findFiberByHostInstance||IG,findHostInstancesForRefresh:null,scheduleRefresh:null,scheduleRoot:null,setRefreshHandler:null,getCurrentFiber:null,reconcilerVersion:"18.3.1-next-f1338f8080-20240426"};if(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__<"u"){var D0=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(!D0.isDisabled&&D0.supportsFiber)try{m3=D0.inject(TG),Us=D0}catch{}}ri.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=_G;ri.createPortal=function(r,e){var t=2<arguments.length&&arguments[2]!==void 0?arguments[2]:null;if(!EE(e))throw Error(ee(200));return CG(r,e,null,t)};ri.createRoot=function(r,e){if(!EE(r))throw Error(ee(299));var t=!1,n="",i=RR;return e!=null&&(e.unstable_strictMode===!0&&(t=!0),e.identifierPrefix!==void 0&&(n=e.identifierPrefix),e.onRecoverableError!==void 0&&(i=e.onRecoverableError)),e=wE(r,1,!1,null,null,t,!1,n,i),r[Lo]=e.current,T1(r.nodeType===8?r.parentNode:r),new vE(e)};ri.findDOMNode=function(r){if(r==null)return null;if(r.nodeType===1)return r;var e=r._reactInternals;if(e===void 0)throw typeof r.render=="function"?Error(ee(188)):(r=Object.keys(r).join(","),Error(ee(268,r)));return r=iO(e),r=r===null?null:r.stateNode,r};ri.flushSync=function(r){return Vl(r)};ri.hydrate=function(r,e,t){if(!P3(e))throw Error(ee(200));return D3(null,r,e,!0,t)};ri.hydrateRoot=function(r,e,t){if(!EE(r))throw Error(ee(405));var n=t!=null&&t.hydratedSources||null,i=!1,s="",o=RR;if(t!=null&&(t.unstable_strictMode===!0&&(i=!0),t.identifierPrefix!==void 0&&(s=t.identifierPrefix),t.onRecoverableError!==void 0&&(o=t.onRecoverableError)),e=OR(e,null,r,1,t??null,i,!1,s,o),r[Lo]=e.current,T1(r),n)for(r=0;r<n.length;r++)t=n[r],i=t._getVersion,i=i(t._source),e.mutableSourceEagerHydrationData==null?e.mutableSourceEagerHydrationData=[t,i]:e.mutableSourceEagerHydrationData.push(t,i);return new T3(e)};ri.render=function(r,e,t){if(!P3(e))throw Error(ee(200));return D3(null,r,e,!1,t)};ri.unmountComponentAtNode=function(r){if(!P3(r))throw Error(ee(40));return r._reactRootContainer?(Vl(function(){D3(null,null,r,!1,function(){r._reactRootContainer=null,r[Lo]=null})}),!0):!1};ri.unstable_batchedUpdates=pE;ri.unstable_renderSubtreeIntoContainer=function(r,e,t,n){if(!P3(t))throw Error(ee(200));if(r==null||r._reactInternals===void 0)throw Error(ee(38));return D3(r,e,t,!1,n)};ri.version="18.3.1-next-f1338f8080-20240426";function LR(){if(!(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__>"u"||typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE!="function"))try{__REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE(LR)}catch(r){console.error(r)}}LR(),LM.exports=ri;var PG=LM.exports,BR,WC=PG;BR=WC.createRoot,WC.hydrateRoot;var SE={exports:{}},pd=typeof Reflect=="object"?Reflect:null,GC=pd&&typeof pd.apply=="function"?pd.apply:function(e,t,n){return Function.prototype.apply.call(e,t,n)},Lg;pd&&typeof pd.ownKeys=="function"?Lg=pd.ownKeys:Object.getOwnPropertySymbols?Lg=function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:Lg=function(e){return Object.getOwnPropertyNames(e)};function DG(r){console&&console.warn&&console.warn(r)}var UR=Number.isNaN||function(e){return e!==e};function mt(){mt.init.call(this)}SE.exports=mt;SE.exports.once=OG;mt.EventEmitter=mt;mt.prototype._events=void 0;mt.prototype._eventsCount=0;mt.prototype._maxListeners=void 0;var QC=10;function $3(r){if(typeof r!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof r)}Object.defineProperty(mt,"defaultMaxListeners",{enumerable:!0,get:function(){return QC},set:function(r){if(typeof r!="number"||r<0||UR(r))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+r+".");QC=r}});mt.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};mt.prototype.setMaxListeners=function(e){if(typeof e!="number"||e<0||UR(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this};function FR(r){return r._maxListeners===void 0?mt.defaultMaxListeners:r._maxListeners}mt.prototype.getMaxListeners=function(){return FR(this)};mt.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t.push(arguments[n]);var i=e==="error",s=this._events;if(s!==void 0)i=i&&s.error===void 0;else if(!i)return!1;if(i){var o;if(t.length>0&&(o=t[0]),o instanceof Error)throw o;var a=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw a.context=o,a}var c=s[e];if(c===void 0)return!1;if(typeof c=="function")GC(c,this,t);else for(var l=c.length,d=HR(c,l),n=0;n<l;++n)GC(d[n],this,t);return!0};function zR(r,e,t,n){var i,s,o;if($3(t),s=r._events,s===void 0?(s=r._events=Object.create(null),r._eventsCount=0):(s.newListener!==void 0&&(r.emit("newListener",e,t.listener?t.listener:t),s=r._events),o=s[e]),o===void 0)o=s[e]=t,++r._eventsCount;else if(typeof o=="function"?o=s[e]=n?[t,o]:[o,t]:n?o.unshift(t):o.push(t),i=FR(r),i>0&&o.length>i&&!o.warned){o.warned=!0;var a=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");a.name="MaxListenersExceededWarning",a.emitter=r,a.type=e,a.count=o.length,DG(a)}return r}mt.prototype.addListener=function(e,t){return zR(this,e,t,!1)};mt.prototype.on=mt.prototype.addListener;mt.prototype.prependListener=function(e,t){return zR(this,e,t,!0)};function $G(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function VR(r,e,t){var n={fired:!1,wrapFn:void 0,target:r,type:e,listener:t},i=$G.bind(n);return i.listener=t,n.wrapFn=i,i}mt.prototype.once=function(e,t){return $3(t),this.on(e,VR(this,e,t)),this};mt.prototype.prependOnceListener=function(e,t){return $3(t),this.prependListener(e,VR(this,e,t)),this};mt.prototype.removeListener=function(e,t){var n,i,s,o,a;if($3(t),i=this._events,i===void 0)return this;if(n=i[e],n===void 0)return this;if(n===t||n.listener===t)--this._eventsCount===0?this._events=Object.create(null):(delete i[e],i.removeListener&&this.emit("removeListener",e,n.listener||t));else if(typeof n!="function"){for(s=-1,o=n.length-1;o>=0;o--)if(n[o]===t||n[o].listener===t){a=n[o].listener,s=o;break}if(s<0)return this;s===0?n.shift():NG(n,s),n.length===1&&(i[e]=n[0]),i.removeListener!==void 0&&this.emit("removeListener",e,a||t)}return this};mt.prototype.off=mt.prototype.removeListener;mt.prototype.removeAllListeners=function(e){var t,n,i;if(n=this._events,n===void 0)return this;if(n.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):n[e]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete n[e]),this;if(arguments.length===0){var s=Object.keys(n),o;for(i=0;i<s.length;++i)o=s[i],o!=="removeListener"&&this.removeAllListeners(o);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(t=n[e],typeof t=="function")this.removeListener(e,t);else if(t!==void 0)for(i=t.length-1;i>=0;i--)this.removeListener(e,t[i]);return this};function KR(r,e,t){var n=r._events;if(n===void 0)return[];var i=n[e];return i===void 0?[]:typeof i=="function"?t?[i.listener||i]:[i]:t?MG(i):HR(i,i.length)}mt.prototype.listeners=function(e){return KR(this,e,!0)};mt.prototype.rawListeners=function(e){return KR(this,e,!1)};mt.listenerCount=function(r,e){return typeof r.listenerCount=="function"?r.listenerCount(e):jR.call(r,e)};mt.prototype.listenerCount=jR;function jR(r){var e=this._events;if(e!==void 0){var t=e[r];if(typeof t=="function")return 1;if(t!==void 0)return t.length}return 0}mt.prototype.eventNames=function(){return this._eventsCount>0?Lg(this._events):[]};function HR(r,e){for(var t=new Array(e),n=0;n<e;++n)t[n]=r[n];return t}function NG(r,e){for(;e+1<r.length;e++)r[e]=r[e+1];r.pop()}function MG(r){for(var e=new Array(r.length),t=0;t<e.length;++t)e[t]=r[t].listener||r[t];return e}function OG(r,e){return new Promise(function(t,n){function i(o){r.removeListener(e,s),n(o)}function s(){typeof r.removeListener=="function"&&r.removeListener("error",i),t([].slice.call(arguments))}qR(r,e,s,{once:!0}),e!=="error"&&RG(r,i,{once:!0})})}function RG(r,e,t){typeof r.on=="function"&&qR(r,"error",e,t)}function qR(r,e,t,n){if(typeof r.on=="function")n.once?r.once(e,t):r.on(e,t);else if(typeof r.addEventListener=="function")r.addEventListener(e,function i(s){n.once&&r.removeEventListener(e,i),t(s)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof r)}var N3=SE.exports,WR={exports:{}};(function(r){var e=Object.prototype.hasOwnProperty,t="~";function n(){}Object.create&&(n.prototype=Object.create(null),new n().__proto__||(t=!1));function i(c,l,d){this.fn=c,this.context=l,this.once=d||!1}function s(c,l,d,h,p){if(typeof d!="function")throw new TypeError("The listener must be a function");var m=new i(d,h||c,p),f=t?t+l:l;return c._events[f]?c._events[f].fn?c._events[f]=[c._events[f],m]:c._events[f].push(m):(c._events[f]=m,c._eventsCount++),c}function o(c,l){--c._eventsCount===0?c._events=new n:delete c._events[l]}function a(){this._events=new n,this._eventsCount=0}a.prototype.eventNames=function(){var l=[],d,h;if(this._eventsCount===0)return l;for(h in d=this._events)e.call(d,h)&&l.push(t?h.slice(1):h);return Object.getOwnPropertySymbols?l.concat(Object.getOwnPropertySymbols(d)):l},a.prototype.listeners=function(l){var d=t?t+l:l,h=this._events[d];if(!h)return[];if(h.fn)return[h.fn];for(var p=0,m=h.length,f=new Array(m);p<m;p++)f[p]=h[p].fn;return f},a.prototype.listenerCount=function(l){var d=t?t+l:l,h=this._events[d];return h?h.fn?1:h.length:0},a.prototype.emit=function(l,d,h,p,m,f){var g=t?t+l:l;if(!this._events[g])return!1;var v=this._events[g],y=arguments.length,w,b;if(v.fn){switch(v.once&&this.removeListener(l,v.fn,void 0,!0),y){case 1:return v.fn.call(v.context),!0;case 2:return v.fn.call(v.context,d),!0;case 3:return v.fn.call(v.context,d,h),!0;case 4:return v.fn.call(v.context,d,h,p),!0;case 5:return v.fn.call(v.context,d,h,p,m),!0;case 6:return v.fn.call(v.context,d,h,p,m,f),!0}for(b=1,w=new Array(y-1);b<y;b++)w[b-1]=arguments[b];v.fn.apply(v.context,w)}else{var E=v.length,A;for(b=0;b<E;b++)switch(v[b].once&&this.removeListener(l,v[b].fn,void 0,!0),y){case 1:v[b].fn.call(v[b].context);break;case 2:v[b].fn.call(v[b].context,d);break;case 3:v[b].fn.call(v[b].context,d,h);break;case 4:v[b].fn.call(v[b].context,d,h,p);break;default:if(!w)for(A=1,w=new Array(y-1);A<y;A++)w[A-1]=arguments[A];v[b].fn.apply(v[b].context,w)}}return!0},a.prototype.on=function(l,d,h){return s(this,l,d,h,!1)},a.prototype.once=function(l,d,h){return s(this,l,d,h,!0)},a.prototype.removeListener=function(l,d,h,p){var m=t?t+l:l;if(!this._events[m])return this;if(!d)return o(this,m),this;var f=this._events[m];if(f.fn)f.fn===d&&(!p||f.once)&&(!h||f.context===h)&&o(this,m);else{for(var g=0,v=[],y=f.length;g<y;g++)(f[g].fn!==d||p&&!f[g].once||h&&f[g].context!==h)&&v.push(f[g]);v.length?this._events[m]=v.length===1?v[0]:v:o(this,m)}return this},a.prototype.removeAllListeners=function(l){var d;return l?(d=t?t+l:l,this._events[d]&&o(this,d)):(this._events=new n,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=t,a.EventEmitter=a,r.exports=a})(WR);var LG=WR.exports;const BG=Nc(LG);let GR=class extends Error{constructor(e){super(e),this.name="TimeoutError"}},UG=class extends Error{constructor(e){super(),this.name="AbortError",this.message=e}};const YC=r=>globalThis.DOMException===void 0?new UG(r):new DOMException(r),JC=r=>{const e=r.reason===void 0?YC("This operation was aborted."):r.reason;return e instanceof Error?e:YC(e)};function Pp(r,e){const{milliseconds:t,fallback:n,message:i,customTimers:s={setTimeout,clearTimeout}}=e;let o,a;const l=new Promise((d,h)=>{if(typeof t!="number"||Math.sign(t)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${t}\``);if(e.signal){const{signal:m}=e;m.aborted&&h(JC(m)),a=()=>{h(JC(m))},m.addEventListener("abort",a,{once:!0})}if(t===Number.POSITIVE_INFINITY){r.then(d,h);return}const p=new GR;o=s.setTimeout.call(void 0,()=>{if(n){try{d(n())}catch(m){h(m)}return}typeof r.cancel=="function"&&r.cancel(),i===!1?d():i instanceof Error?h(i):(p.message=i??`Promise timed out after ${t} milliseconds`,h(p))},t),(async()=>{try{d(await r)}catch(m){h(m)}})()}).finally(()=>{l.clear(),a&&e.signal&&e.signal.removeEventListener("abort",a)});return l.clear=()=>{s.clearTimeout.call(void 0,o),o=void 0},l}function FG(r,e,t){let n=0,i=r.length;for(;i>0;){const s=Math.trunc(i/2);let o=n+s;t(r[o],e)<=0?(n=++o,i-=s+1):i=s}return n}var gi,tN;let zG=(tN=class{constructor(){Ge(this,gi,[])}enqueue(e,t){t={priority:0,...t};const n={priority:t.priority,id:t.id,run:e};if(this.size===0||se(this,gi)[this.size-1].priority>=t.priority){se(this,gi).push(n);return}const i=FG(se(this,gi),n,(s,o)=>o.priority-s.priority);se(this,gi).splice(i,0,n)}setPriority(e,t){const n=se(this,gi).findIndex(s=>s.id===e);if(n===-1)throw new ReferenceError(`No promise function with the id "${e}" exists in the queue.`);const[i]=se(this,gi).splice(n,1);this.enqueue(i.run,{priority:t,id:e})}dequeue(){const e=se(this,gi).shift();return e==null?void 0:e.run}filter(e){return se(this,gi).filter(t=>t.priority===e.priority).map(t=>t.run)}get size(){return se(this,gi).length}},gi=new WeakMap,tN);var Cd,Id,ja,wp,kd,bp,yi,_d,nn,vp,mi,Td,So,Ep,f3,ot,QR,YR,JR,XR,ZR,Bg,W6,G6,Ug,eL,Fg;class wc extends BG{constructor(t){var n,i;super();Ge(this,ot);Ge(this,Cd);Ge(this,Id);Ge(this,ja,0);Ge(this,wp);Ge(this,kd);Ge(this,bp,0);Ge(this,yi);Ge(this,_d);Ge(this,nn);Ge(this,vp);Ge(this,mi,0);Ge(this,Td);Ge(this,So);Ge(this,Ep);Ge(this,f3,1n);u(this,"timeout");if(t={carryoverConcurrencyCount:!1,intervalCap:Number.POSITIVE_INFINITY,interval:0,concurrency:Number.POSITIVE_INFINITY,autoStart:!0,queueClass:zG,...t},!(typeof t.intervalCap=="number"&&t.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${((n=t.intervalCap)==null?void 0:n.toString())??""}\` (${typeof t.intervalCap})`);if(t.interval===void 0||!(Number.isFinite(t.interval)&&t.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${((i=t.interval)==null?void 0:i.toString())??""}\` (${typeof t.interval})`);vt(this,Cd,t.carryoverConcurrencyCount),vt(this,Id,t.intervalCap===Number.POSITIVE_INFINITY||t.interval===0),vt(this,wp,t.intervalCap),vt(this,kd,t.interval),vt(this,nn,new t.queueClass),vt(this,vp,t.queueClass),this.concurrency=t.concurrency,this.timeout=t.timeout,vt(this,Ep,t.throwOnTimeout===!0),vt(this,So,t.autoStart===!1)}get concurrency(){return se(this,Td)}set concurrency(t){if(!(typeof t=="number"&&t>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${t}\` (${typeof t})`);vt(this,Td,t),Ie(this,ot,Ug).call(this)}setPriority(t,n){se(this,nn).setPriority(t,n)}async add(t,n={}){return n.id??(n.id=(Es(this,f3)._++).toString()),n={timeout:this.timeout,throwOnTimeout:se(this,Ep),...n},new Promise((i,s)=>{se(this,nn).enqueue(async()=>{var o;Es(this,mi)._++,Es(this,ja)._++;try{(o=n.signal)==null||o.throwIfAborted();let a=t({signal:n.signal});n.timeout&&(a=Pp(Promise.resolve(a),{milliseconds:n.timeout})),n.signal&&(a=Promise.race([a,Ie(this,ot,eL).call(this,n.signal)]));const c=await a;i(c),this.emit("completed",c)}catch(a){if(a instanceof GR&&!n.throwOnTimeout){i();return}s(a),this.emit("error",a)}finally{Ie(this,ot,JR).call(this)}},n),this.emit("add"),Ie(this,ot,Bg).call(this)})}async addAll(t,n){return Promise.all(t.map(async i=>this.add(i,n)))}start(){return se(this,So)?(vt(this,So,!1),Ie(this,ot,Ug).call(this),this):this}pause(){vt(this,So,!0)}clear(){vt(this,nn,new(se(this,vp)))}async onEmpty(){se(this,nn).size!==0&&await Ie(this,ot,Fg).call(this,"empty")}async onSizeLessThan(t){se(this,nn).size<t||await Ie(this,ot,Fg).call(this,"next",()=>se(this,nn).size<t)}async onIdle(){se(this,mi)===0&&se(this,nn).size===0||await Ie(this,ot,Fg).call(this,"idle")}get size(){return se(this,nn).size}sizeBy(t){return se(this,nn).filter(t).length}get pending(){return se(this,mi)}get isPaused(){return se(this,So)}}Cd=new WeakMap,Id=new WeakMap,ja=new WeakMap,wp=new WeakMap,kd=new WeakMap,bp=new WeakMap,yi=new WeakMap,_d=new WeakMap,nn=new WeakMap,vp=new WeakMap,mi=new WeakMap,Td=new WeakMap,So=new WeakMap,Ep=new WeakMap,f3=new WeakMap,ot=new WeakSet,QR=function(){return se(this,Id)||se(this,ja)<se(this,wp)},YR=function(){return se(this,mi)<se(this,Td)},JR=function(){Es(this,mi)._--,Ie(this,ot,Bg).call(this),this.emit("next")},XR=function(){Ie(this,ot,G6).call(this),Ie(this,ot,W6).call(this),vt(this,_d,void 0)},ZR=function(){const t=Date.now();if(se(this,yi)===void 0){const n=se(this,bp)-t;if(n<0)vt(this,ja,se(this,Cd)?se(this,mi):0);else return se(this,_d)===void 0&&vt(this,_d,setTimeout(()=>{Ie(this,ot,XR).call(this)},n)),!0}return!1},Bg=function(){if(se(this,nn).size===0)return se(this,yi)&&clearInterval(se(this,yi)),vt(this,yi,void 0),this.emit("empty"),se(this,mi)===0&&this.emit("idle"),!1;if(!se(this,So)){const t=!se(this,ot,ZR);if(se(this,ot,QR)&&se(this,ot,YR)){const n=se(this,nn).dequeue();return n?(this.emit("active"),n(),t&&Ie(this,ot,W6).call(this),!0):!1}}return!1},W6=function(){se(this,Id)||se(this,yi)!==void 0||(vt(this,yi,setInterval(()=>{Ie(this,ot,G6).call(this)},se(this,kd))),vt(this,bp,Date.now()+se(this,kd)))},G6=function(){se(this,ja)===0&&se(this,mi)===0&&se(this,yi)&&(clearInterval(se(this,yi)),vt(this,yi,void 0)),vt(this,ja,se(this,Cd)?se(this,mi):0),Ie(this,ot,Ug).call(this)},Ug=function(){for(;Ie(this,ot,Bg).call(this););},eL=async function(t){return new Promise((n,i)=>{t.addEventListener("abort",()=>{i(t.reason)},{once:!0})})},Fg=async function(t,n){return new Promise(i=>{const s=()=>{n&&!n()||(this.off(t,s),i())};this.on(t,s)})};function Le(){const r={};return r.promise=new Promise((e,t)=>{r.resolve=e,r.reject=t}),r}class XC{constructor(e){u(this,"buffer");u(this,"mask");u(this,"top");u(this,"btm");u(this,"next");if(!(e>0)||e-1&e)throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}push(e){return this.buffer[this.top]!==void 0?!1:(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){const e=this.buffer[this.btm];if(e!==void 0)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}isEmpty(){return this.buffer[this.btm]===void 0}}class g5{constructor(e={}){u(this,"size");u(this,"hwm");u(this,"head");u(this,"tail");this.hwm=e.splitLimit??16,this.head=new XC(this.hwm),this.tail=this.head,this.size=0}calculateSize(e){return(e==null?void 0:e.byteLength)!=null?e.byteLength:1}push(e){if((e==null?void 0:e.value)!=null&&(this.size+=this.calculateSize(e.value)),!this.head.push(e)){const t=this.head;this.head=t.next=new XC(2*this.head.buffer.length),this.head.push(e)}}shift(){let e=this.tail.shift();if(e===void 0&&this.tail.next!=null){const t=this.tail.next;this.tail.next=null,this.tail=t,e=this.tail.shift()}return(e==null?void 0:e.value)!=null&&(this.size-=this.calculateSize(e.value)),e}isEmpty(){return this.head.isEmpty()}}let VG=class extends Error{constructor(t,n){super(t??"The operation was aborted");u(this,"type");u(this,"code");this.type="aborted",this.code=n??"ABORT_ERR"}};function Fo(r={}){return KG(t=>{const n=t.shift();if(n==null)return{done:!0};if(n.error!=null)throw n.error;return{done:n.done===!0,value:n.value}},r)}function KG(r,e){e=e??{};let t=e.onEnd,n=new g5,i,s,o,a=Le();const c=async()=>{try{return n.isEmpty()?o?{done:!0}:await new Promise((v,y)=>{s=w=>{s=null,n.push(w);try{v(r(n))}catch(b){y(b)}return i}}):r(n)}finally{n.isEmpty()&&queueMicrotask(()=>{a.resolve(),a=Le()})}},l=v=>s!=null?s(v):(n.push(v),i),d=v=>(n=new g5,s!=null?s({error:v}):(n.push({error:v}),i)),h=v=>{if(o)return i;if((e==null?void 0:e.objectMode)!==!0&&(v==null?void 0:v.byteLength)==null)throw new Error("objectMode was not true but tried to push non-Uint8Array value");return l({done:!1,value:v})},p=v=>o?i:(o=!0,v!=null?d(v):l({done:!0})),m=()=>(n=new g5,p(),{done:!0}),f=v=>(p(v),{done:!0});if(i={[Symbol.asyncIterator](){return this},next:c,return:m,throw:f,push:h,end:p,get readableLength(){return n.size},onEmpty:async v=>{const y=v==null?void 0:v.signal;if(y==null||y.throwIfAborted(),n.isEmpty())return;let w,b;y!=null&&(w=new Promise((E,A)=>{b=()=>{A(new VG)},y.addEventListener("abort",b)}));try{await Promise.race([a.promise,w])}finally{b!=null&&y!=null&&(y==null||y.removeEventListener("abort",b))}}},t==null)return i;const g=i;return i={[Symbol.asyncIterator](){return this},next(){return g.next()},throw(v){return g.throw(v),t!=null&&(t(v),t=void 0),{done:!0}},return(){return g.return(),t!=null&&(t(),t=void 0),{done:!0}},push:h,end(v){return g.end(v),t!=null&&(t(v),t=void 0),i},get readableLength(){return g.readableLength},onEmpty:v=>g.onEmpty(v)},i}let ZC=class extends Error{constructor(t,n,i){super(t??"The operation was aborted");u(this,"type");u(this,"code");this.type="aborted",this.name=i??"AbortError",this.code=n??"ABORT_ERR"}};async function cn(r,e,t){if(e==null)return r;if(e.aborted)return r.catch(()=>{}),Promise.reject(new ZC(t==null?void 0:t.errorMessage,t==null?void 0:t.errorCode,t==null?void 0:t.errorName));let n;const i=new ZC(t==null?void 0:t.errorMessage,t==null?void 0:t.errorCode,t==null?void 0:t.errorName);try{return await Promise.race([r,new Promise((s,o)=>{n=()=>{o(i)},e.addEventListener("abort",n)})])}finally{n!=null&&e.removeEventListener("abort",n)}}let jG=class{constructor(){u(this,"readNext");u(this,"haveNext");u(this,"ended");u(this,"nextResult");u(this,"error");this.ended=!1,this.readNext=Le(),this.haveNext=Le()}[Symbol.asyncIterator](){return this}async next(){if(this.nextResult==null&&await this.haveNext.promise,this.nextResult==null)throw new Error("HaveNext promise resolved but nextResult was undefined");const e=this.nextResult;return this.nextResult=void 0,this.readNext.resolve(),this.readNext=Le(),e}async throw(e){return this.ended=!0,this.error=e,e!=null&&(this.haveNext.promise.catch(()=>{}),this.haveNext.reject(e)),{done:!0,value:void 0}}async return(){const e={done:!0,value:void 0};return this.ended=!0,this.nextResult=e,this.haveNext.resolve(),e}async push(e,t){await this._push(e,t)}async end(e,t){e!=null?await this.throw(e):await this._push(void 0,t)}async _push(e,t){if(e!=null&&this.ended)throw this.error??new Error("Cannot push value onto an ended pushable");for(;this.nextResult!=null;)await this.readNext.promise;e!=null?this.nextResult={done:!1,value:e}:(this.ended=!0,this.nextResult={done:!0,value:void 0}),this.haveNext.resolve(),this.haveNext=Le(),await cn(this.readNext.promise,t==null?void 0:t.signal,t)}};function HG(){return new jG}function qG(r){return r[Symbol.asyncIterator]!=null}async function WG(r,e){try{await Promise.all(r.map(async t=>{for await(const n of t)await e.push(n)})),await e.end()}catch(t){await e.end(t).catch(()=>{})}}async function*GG(r){const e=HG();WG(r,e).catch(()=>{}),yield*e}function*QG(r){for(const e of r)yield*e}function cc(...r){const e=[];for(const t of r)qG(t)||e.push(t);return e.length===r.length?QG(e):GG(r)}function hn(r,...e){if(r==null)throw new Error("Empty pipeline");if(y5(r)){const n=r;r=()=>n.source}else if(rL(r)||tL(r)){const n=r;r=()=>n}const t=[r,...e];if(t.length>1&&y5(t[t.length-1])&&(t[t.length-1]=t[t.length-1].sink),t.length>2)for(let n=1;n<t.length-1;n++)y5(t[n])&&(t[n]=JG(t[n]));return YG(...t)}const YG=(...r)=>{let e;for(;r.length>0;)e=r.shift()(e);return e},tL=r=>(r==null?void 0:r[Symbol.asyncIterator])!=null,rL=r=>(r==null?void 0:r[Symbol.iterator])!=null,y5=r=>r==null?!1:r.sink!=null&&r.source!=null,JG=r=>e=>{const t=r.sink(e);if((t==null?void 0:t.then)!=null){const n=Fo({objectMode:!0});t.then(()=>{n.end()},o=>{n.end(o)});let i;const s=r.source;if(tL(s))i=async function*(){yield*s,n.end()};else if(rL(s))i=function*(){yield*s,n.end()};else throw new Error("Unknown duplex source type - must be Iterable or AsyncIterable");return cc(n,i())}return r.source};var XG=function(){return Date.now()};const $0=XG;class ZG{constructor(e,t,n){const i=this;this._started=$0(),this._rescheduled=0,this._scheduled=t,this._args=n,this._triggered=!1,this._timerWrapper=()=>{i._rescheduled>0?(i._scheduled=i._rescheduled-($0()-i._started),i._schedule(i._scheduled)):(i._triggered=!0,e.apply(null,i._args))},this._timer=setTimeout(this._timerWrapper,t)}reschedule(e){e||(e=this._scheduled);const t=$0();t+e-(this._started+this._scheduled)<0?(clearTimeout(this._timer),this._schedule(e)):this._triggered?this._schedule(e):(this._started=t,this._rescheduled=e)}_schedule(e){this._triggered=!1,this._started=$0(),this._rescheduled=0,this._scheduled=e,this._timer=setTimeout(this._timerWrapper,e)}clear(){clearTimeout(this._timer)}}function eQ(){if(typeof arguments[0]!="function")throw new Error("callback needed");if(typeof arguments[1]!="number")throw new Error("timeout needed");let r;if(arguments.length>0){r=new Array(arguments.length-2);for(var e=0;e<r.length;e++)r[e]=arguments[e+2]}return new ZG(arguments[0],arguments[1],r)}var tQ=eQ;const{AbortController:rQ}=globalThis,eI=tQ;class xE extends rQ{constructor(e){super(),this._ms=e,this._timer=eI(()=>this.abort(),e),Object.setPrototypeOf(this,xE.prototype)}abort(){return this._timer.clear(),super.abort()}clear(){this._timer.clear()}reset(){this._timer.clear(),this._timer=eI(()=>this.abort(),this._ms)}}var Q6={TimeoutController:xE};const lc=(...r)=>r.join("/").replace(new RegExp("((?<=\\/)\\/+)|(^\\.\\/)|((?<=\\/)\\.\\/)","g"),"")||".",nQ=3e4,iQ=async({ipfs:r,log:e,events:t,onSynced:n,start:i,timeout:s})=>{if(!r)throw new Error("An instance of ipfs is required.");if(!e)throw new Error("An instance of log is required.");const o=r.libp2p,a=r.libp2p.services.pubsub,c=e.id,l=lc("/orbitdb/heads/",c),d=new wc({concurrency:1}),h=new Set;t=t||new N3.EventEmitter,s=s||nQ;let p=!1;const m=async x=>{const I=await e.heads();t.emit("join",x,I)},f=x=>async function*(){const I=await e.heads();for await(const{bytes:T}of I)yield T}(),g=x=>async I=>{for await(const T of I){const L=T.subarray();L&&n&&await n(L)}p&&await m(x)},v=async({connection:x,stream:I})=>{const T=String(x.remotePeer);try{h.add(T),await hn(I,g(T),f,I)}catch(L){h.delete(T),t.emit("error",L)}},y=async x=>{const I=async()=>{const{peerId:T,subscriptions:L}=x.detail,z=String(T),B=L.find(G=>G.topic===c);if(B)if(B.subscribe){if(h.has(z))return;const G=new Q6.TimeoutController(s),{signal:j}=G;try{h.add(z);const q=await o.dialProtocol(T,l,{signal:j});await hn(f,q,g(z))}catch(q){h.delete(z),q.name==="UnsupportedProtocolError"||t.emit("error",q)}finally{G&&G.clear()}}else h.delete(z),t.emit("leave",z)};d.add(I)},w=async x=>{const{topic:I,data:T}=x.detail,L=async()=>{try{T&&n&&await n(T)}catch(z){t.emit("error",z)}};I===c&&d.add(L)},b=async x=>{h.delete(x.detail.toString())},E=async x=>{p&&await a.publish(c,x.bytes)},A=async()=>{p&&(p=!1,await d.onIdle(),a.removeEventListener("subscription-change",y),a.removeEventListener("message",w),await o.unhandle(l),await a.unsubscribe(c),o.removeEventListener("peer:disconnect",b),h.clear())},k=async()=>{p||(await o.handle(l,v),a.addEventListener("subscription-change",y),a.addEventListener("message",w),await a.subscribe(c),o.addEventListener("peer:disconnect",b),p=!0)};return i!==!1&&await k(),{add:E,stop:A,start:k,events:t,peers:h}};var Y6={exports:{}};typeof Object.create=="function"?Y6.exports=function(e,t){t&&(e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}))}:Y6.exports=function(e,t){if(t){e.super_=t;var n=function(){};n.prototype=t.prototype,e.prototype=new n,e.prototype.constructor=e}};var sQ=Y6.exports,nL=N3,oQ=sQ,aQ=ei;function ei(r){if(!(this instanceof ei))return new ei(r);typeof r=="number"&&(r={max:r}),r||(r={}),nL.EventEmitter.call(this),this.cache={},this.head=this.tail=null,this.length=0,this.max=r.max||1e3,this.maxAge=r.maxAge||0}oQ(ei,nL.EventEmitter);Object.defineProperty(ei.prototype,"keys",{get:function(){return Object.keys(this.cache)}});ei.prototype.clear=function(){this.cache={},this.head=this.tail=null,this.length=0};ei.prototype.remove=function(r){if(typeof r!="string"&&(r=""+r),!!this.cache.hasOwnProperty(r)){var e=this.cache[r];return delete this.cache[r],this._unlink(r,e.prev,e.next),e.value}};ei.prototype._unlink=function(r,e,t){this.length--,this.length===0?this.head=this.tail=null:this.head===r?(this.head=e,this.cache[this.head].next=null):this.tail===r?(this.tail=t,this.cache[this.tail].prev=null):(this.cache[e].next=t,this.cache[t].prev=e)};ei.prototype.peek=function(r){if(this.cache.hasOwnProperty(r)){var e=this.cache[r];if(this._checkAge(r,e))return e.value}};ei.prototype.set=function(r,e){typeof r!="string"&&(r=""+r);var t;if(this.cache.hasOwnProperty(r)){if(t=this.cache[r],t.value=e,this.maxAge&&(t.modified=Date.now()),r===this.head)return e;this._unlink(r,t.prev,t.next)}else t={value:e,modified:0,next:null,prev:null},this.maxAge&&(t.modified=Date.now()),this.cache[r]=t,this.length===this.max&&this.evict();return this.length++,t.next=null,t.prev=this.head,this.head&&(this.cache[this.head].next=r),this.head=r,this.tail||(this.tail=r),e};ei.prototype._checkAge=function(r,e){return this.maxAge&&Date.now()-e.modified>this.maxAge?(this.remove(r),this.emit("evict",{key:r,value:e.value}),!1):!0};ei.prototype.get=function(r){if(typeof r!="string"&&(r=""+r),!!this.cache.hasOwnProperty(r)){var e=this.cache[r];if(this._checkAge(r,e))return this.head!==r&&(r===this.tail?(this.tail=e.next,this.cache[this.tail].prev=null):this.cache[e.prev].next=e.next,this.cache[e.next].prev=e.prev,this.cache[this.head].next=r,e.prev=this.head,e.next=null,this.head=r),e.value}};ei.prototype.evict=function(){if(this.tail){var r=this.tail,e=this.remove(this.tail);this.emit("evict",{key:r,value:e})}};const J6=Nc(aQ),cQ=(r,e)=>{const t=r.time-e.time;return t===0&&r.id!==e.id?r.id<e.id?-1:1:t},lQ=r=>M3(r.id,++r.time),M3=(r,e)=>(e=e||0,{id:r,time:e}),uQ=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},AE=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")};function dQ(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var i=0;i<r.length;i++){var s=r.charAt(i),o=s.charCodeAt(0);if(t[o]!==255)throw new TypeError(s+" is ambiguous");t[o]=i}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),d=Math.log(256)/Math.log(a);function h(f){if(f instanceof Uint8Array||(ArrayBuffer.isView(f)?f=new Uint8Array(f.buffer,f.byteOffset,f.byteLength):Array.isArray(f)&&(f=Uint8Array.from(f))),!(f instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(f.length===0)return"";for(var g=0,v=0,y=0,w=f.length;y!==w&&f[y]===0;)y++,g++;for(var b=(w-y)*d+1>>>0,E=new Uint8Array(b);y!==w;){for(var A=f[y],k=0,x=b-1;(A!==0||k<v)&&x!==-1;x--,k++)A+=256*E[x]>>>0,E[x]=A%a>>>0,A=A/a>>>0;if(A!==0)throw new Error("Non-zero carry");v=k,y++}for(var I=b-v;I!==b&&E[I]===0;)I++;for(var T=c.repeat(g);I<b;++I)T+=r.charAt(E[I]);return T}function p(f){if(typeof f!="string")throw new TypeError("Expected String");if(f.length===0)return new Uint8Array;var g=0;if(f[g]!==" "){for(var v=0,y=0;f[g]===c;)v++,g++;for(var w=(f.length-g)*l+1>>>0,b=new Uint8Array(w);f[g];){var E=t[f.charCodeAt(g)];if(E===255)return;for(var A=0,k=w-1;(E!==0||A<y)&&k!==-1;k--,A++)E+=a*b[k]>>>0,b[k]=E%256>>>0,E=E/256>>>0;if(E!==0)throw new Error("Non-zero carry");y=A,g++}if(f[g]!==" "){for(var x=w-y;x!==w&&b[x]===0;)x++;for(var I=new Uint8Array(v+(w-x)),T=v;x!==w;)I[T++]=b[x++];return I}}}function m(f){var g=p(f);if(g)return g;throw new Error(`Non-${e} character`)}return{encode:h,decodeUnsafe:p,decode:m}}var hQ=dQ,fQ=hQ;let pQ=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},gQ=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return iL(this,e)}},yQ=class{constructor(e){this.decoders=e}or(e){return iL(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const iL=(r,e)=>new yQ({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let mQ=class{constructor(e,t,n,i){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=i,this.encoder=new pQ(e,t,n),this.decoder=new gQ(e,t,i)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const sL=({name:r,prefix:e,encode:t,decode:n})=>new mQ(r,e,t,n),oL=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:i}=fQ(t,e);return sL({prefix:r,name:e,encode:n,decode:s=>AE(i(s))})},wQ=(r,e,t,n)=>{const i={};for(let d=0;d<e.length;++d)i[e[d]]=d;let s=r.length;for(;r[s-1]==="=";)--s;const o=new Uint8Array(s*t/8|0);let a=0,c=0,l=0;for(let d=0;d<s;++d){const h=i[r[d]];if(h===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|h,a+=t,a>=8&&(a-=8,o[l++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},bQ=(r,e,t)=>{const n=e[e.length-1]==="=",i=(1<<t)-1;let s="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,s+=e[i&a>>o];if(o&&(s+=e[i&a<<t-o]),n)for(;s.length*t&7;)s+="=";return s},Yo=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>sL({prefix:e,name:r,encode(i){return bQ(i,n,t)},decode(i){return wQ(i,n,t,r)}}),zg=Yo({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});Yo({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});Yo({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});Yo({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});Yo({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});Yo({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});Yo({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});Yo({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});Yo({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const on=oL({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});oL({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var vQ=aL,tI=128,EQ=-128,SQ=Math.pow(2,31);function aL(r,e,t){e=e||[],t=t||0;for(var n=t;r>=SQ;)e[t++]=r&255|tI,r/=128;for(;r&EQ;)e[t++]=r&255|tI,r>>>=7;return e[t]=r|0,aL.bytes=t-n+1,e}var xQ=X6,AQ=128,rI=127;function X6(r,n){var t=0,n=n||0,i=0,s=n,o,a=r.length;do{if(s>=a)throw X6.bytes=0,new RangeError("Could not decode varint");o=r[s++],t+=i<28?(o&rI)<<i:(o&rI)*Math.pow(2,i),i+=7}while(o>=AQ);return X6.bytes=s-n,t}var CQ=Math.pow(2,7),IQ=Math.pow(2,14),kQ=Math.pow(2,21),_Q=Math.pow(2,28),TQ=Math.pow(2,35),PQ=Math.pow(2,42),DQ=Math.pow(2,49),$Q=Math.pow(2,56),NQ=Math.pow(2,63),MQ=function(r){return r<CQ?1:r<IQ?2:r<kQ?3:r<_Q?4:r<TQ?5:r<PQ?6:r<DQ?7:r<$Q?8:r<NQ?9:10},OQ={encode:vQ,decode:xQ,encodingLength:MQ},V2=OQ;const Z6=(r,e=0)=>[V2.decode(r,e),V2.decode.bytes],K2=(r,e,t=0)=>(V2.encode(r,e,t),e),j2=r=>V2.encodingLength(r),eb=(r,e)=>{const t=e.byteLength,n=j2(r),i=n+j2(t),s=new Uint8Array(i+t);return K2(r,s,0),K2(t,s,n),s.set(e,i),new CE(r,t,e,s)},RQ=r=>{const e=AE(r),[t,n]=Z6(e),[i,s]=Z6(e.subarray(n)),o=e.subarray(n+s);if(o.byteLength!==i)throw new Error("Incorrect length");return new CE(t,i,o,e)},LQ=(r,e)=>{if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&uQ(r.bytes,t.bytes)}};let CE=class{constructor(e,t,n,i){this.code=e,this.size=t,this.digest=n,this.bytes=i}};const nI=(r,e)=>{const{bytes:t,version:n}=r;switch(n){case 0:return UQ(t,tb(r),e||on.encoder);default:return FQ(t,tb(r),e||zg.encoder)}},iI=new WeakMap,tb=r=>{const e=iI.get(r);if(e==null){const t=new Map;return iI.set(r,t),t}return e};let fs=class Mr{constructor(e,t,n,i){this.code=t,this.version=e,this.multihash=n,this.bytes=i,this["/"]=i}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==of)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==zQ)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return Mr.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=eb(e,t);return Mr.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return Mr.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&LQ(e.multihash,n.multihash)}toString(e){return nI(this,e)}toJSON(){return{"/":nI(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof Mr)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:i,multihash:s,bytes:o}=t;return new Mr(n,i,s,o||sI(n,i,s.bytes))}else if(t[VQ]===!0){const{version:n,multihash:i,code:s}=t,o=RQ(i);return Mr.create(n,s,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==of)throw new Error(`Version 0 CID must use dag-pb (code: ${of}) block encoding`);return new Mr(e,t,n,n.bytes)}case 1:{const i=sI(e,t,n.bytes);return new Mr(e,t,n,i)}default:throw new Error("Invalid version")}}static createV0(e){return Mr.create(0,of,e)}static createV1(e,t){return Mr.create(1,e,t)}static decode(e){const[t,n]=Mr.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=Mr.inspectBytes(e),n=t.size-t.multihashSize,i=AE(e.subarray(n,n+t.multihashSize));if(i.byteLength!==t.multihashSize)throw new Error("Incorrect length");const s=i.subarray(t.multihashSize-t.digestSize),o=new CE(t.multihashCode,t.digestSize,s,i);return[t.version===0?Mr.createV0(o):Mr.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[h,p]=Z6(e.subarray(t));return t+=p,h};let i=n(),s=of;if(i===18?(i=0,t=0):s=n(),i!==0&&i!==1)throw new RangeError(`Invalid CID version ${i}`);const o=t,a=n(),c=n(),l=t+c,d=l-o;return{version:i,codec:s,multihashCode:a,digestSize:c,multihashSize:d,size:l}}static parse(e,t){const[n,i]=BQ(e,t),s=Mr.decode(i);if(s.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return tb(s).set(n,e),s}};const BQ=(r,e)=>{switch(r[0]){case"Q":{const t=e||on;return[on.prefix,t.decode(`${on.prefix}${r}`)]}case on.prefix:{const t=e||on;return[on.prefix,t.decode(r)]}case zg.prefix:{const t=e||zg;return[zg.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},UQ=(r,e,t)=>{const{prefix:n}=t;if(n!==on.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const i=e.get(n);if(i==null){const s=t.encode(r).slice(1);return e.set(n,s),s}else return i},FQ=(r,e,t)=>{const{prefix:n}=t,i=e.get(n);if(i==null){const s=t.encode(r);return e.set(n,s),s}else return i},of=112,zQ=18,sI=(r,e,t)=>{const n=j2(r),i=n+j2(e),s=new Uint8Array(i+t.byteLength);return K2(r,s,0),K2(e,s,n),s.set(t,i),s},VQ=Symbol.for("@ipld/js-cid/CID"),KQ=({name:r,code:e,encode:t})=>new jQ(r,e,t);let jQ=class{constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?eb(this.code,t):t.then(n=>eb(this.code,n))}else throw Error("Unknown type, must be binary type")}};function N0({enumerable:r=!0,configurable:e=!1}={}){return{enumerable:r,configurable:e,writable:!1}}function*HQ(r,e){if(e!=null&&typeof e=="object")if(Array.isArray(e))for(const[t,n]of e.entries()){const i=[...r,t],s=fs.asCID(n);s?yield[i.join("/"),s]:typeof n=="object"&&(yield*rb(n,i))}else{const t=fs.asCID(e);t?yield[r.join("/"),t]:yield*rb(e,r)}}function*rb(r,e){if(r==null||r instanceof Uint8Array)return;const t=fs.asCID(r);t&&(yield[e.join("/"),t]);for(const[n,i]of Object.entries(r)){const s=[...e,n];yield*HQ(s,i)}}function*qQ(r,e){if(Array.isArray(e))for(const[t,n]of e.entries()){const i=[...r,t];yield i.join("/"),typeof n=="object"&&!fs.asCID(n)&&(yield*nb(n,i))}else yield*nb(e,r)}function*nb(r,e){if(!(r==null||typeof r!="object"))for(const[t,n]of Object.entries(r)){const i=[...e,t];yield i.join("/"),n!=null&&!(n instanceof Uint8Array)&&typeof n=="object"&&!fs.asCID(n)&&(yield*qQ(i,n))}}function WQ(r,e){let t=r;for(const[n,i]of e.entries()){if(t=t[i],t==null)throw new Error(`Object has no property at ${e.slice(0,n+1).map(o=>`[${JSON.stringify(o)}]`).join("")}`);const s=fs.asCID(t);if(s)return{value:s,remaining:e.slice(n+1).join("/")}}return{value:t}}let cL=class{constructor({cid:e,bytes:t,value:n}){if(!e||!t||typeof n>"u")throw new Error("Missing required argument");this.cid=e,this.bytes=t,this.value=n,this.asBlock=this,Object.defineProperties(this,{cid:N0(),bytes:N0(),value:N0(),asBlock:N0()})}links(){return rb(this.value,[])}tree(){return nb(this.value,[])}get(e="/"){return WQ(this.value,e.split("/").filter(Boolean))}};async function kh({value:r,codec:e,hasher:t}){if(typeof r>"u")throw new Error('Missing required argument "value"');if(!e||!t)throw new Error("Missing required argument: codec or hasher");const n=e.encode(r),i=await t.digest(n),s=fs.create(1,e.code,i);return new cL({value:r,bytes:n,cid:s})}async function O3({bytes:r,codec:e,hasher:t}){if(!r)throw new Error('Missing required argument "bytes"');if(!e||!t)throw new Error("Missing required argument: codec or hasher");const n=e.decode(r),i=await t.digest(r),s=fs.create(1,e.code,i);return new cL({value:n,bytes:r,cid:s})}const GQ=["string","number","bigint","symbol"],QQ=["Function","Generator","AsyncGenerator","GeneratorFunction","AsyncGeneratorFunction","AsyncFunction","Observable","Array","Buffer","Object","RegExp","Date","Error","Map","Set","WeakMap","WeakSet","ArrayBuffer","SharedArrayBuffer","DataView","Promise","URL","HTMLElement","Int8Array","Uint8Array","Uint8ClampedArray","Int16Array","Uint16Array","Int32Array","Uint32Array","Float32Array","Float64Array","BigInt64Array","BigUint64Array"];function YQ(r){if(r===null)return"null";if(r===void 0)return"undefined";if(r===!0||r===!1)return"boolean";const e=typeof r;if(GQ.includes(e))return e;if(e==="function")return"Function";if(Array.isArray(r))return"Array";if(JQ(r))return"Buffer";const t=XQ(r);return t||"Object"}function JQ(r){return r&&r.constructor&&r.constructor.isBuffer&&r.constructor.isBuffer.call(null,r)}function XQ(r){const e=Object.prototype.toString.call(r).slice(8,-1);if(QQ.includes(e))return e}class V{constructor(e,t,n){this.major=e,this.majorEncoded=e<<5,this.name=t,this.terminal=n}toString(){return`Type[${this.major}].${this.name}`}compare(e){return this.major<e.major?-1:this.major>e.major?1:0}}V.uint=new V(0,"uint",!0);V.negint=new V(1,"negint",!0);V.bytes=new V(2,"bytes",!0);V.string=new V(3,"string",!0);V.array=new V(4,"array",!1);V.map=new V(5,"map",!1);V.tag=new V(6,"tag",!1);V.float=new V(7,"float",!0);V.false=new V(7,"false",!0);V.true=new V(7,"true",!0);V.null=new V(7,"null",!0);V.undefined=new V(7,"undefined",!0);V.break=new V(7,"break",!0);class ie{constructor(e,t,n){this.type=e,this.value=t,this.encodedLength=n,this.encodedBytes=void 0,this.byteValue=void 0}toString(){return`Token[${this.type}].${this.value}`}}const _h=globalThis.process&&!globalThis.process.browser&&globalThis.Buffer&&typeof globalThis.Buffer.isBuffer=="function",ZQ=new TextDecoder,eY=new TextEncoder;function H2(r){return _h&&globalThis.Buffer.isBuffer(r)}function IE(r){return r instanceof Uint8Array?H2(r)?new Uint8Array(r.buffer,r.byteOffset,r.byteLength):r:Uint8Array.from(r)}const tY=_h?(r,e,t)=>t-e>64?globalThis.Buffer.from(r.subarray(e,t)).toString("utf8"):aI(r,e,t):(r,e,t)=>t-e>64?ZQ.decode(r.subarray(e,t)):aI(r,e,t),lL=_h?r=>r.length>64?globalThis.Buffer.from(r):oI(r):r=>r.length>64?eY.encode(r):oI(r),ro=r=>Uint8Array.from(r),kE=_h?(r,e,t)=>H2(r)?new Uint8Array(r.subarray(e,t)):r.slice(e,t):(r,e,t)=>r.slice(e,t),rY=_h?(r,e)=>(r=r.map(t=>t instanceof Uint8Array?t:globalThis.Buffer.from(t)),IE(globalThis.Buffer.concat(r,e))):(r,e)=>{const t=new Uint8Array(e);let n=0;for(let i of r)n+i.length>t.length&&(i=i.subarray(0,t.length-n)),t.set(i,n),n+=i.length;return t},nY=_h?r=>globalThis.Buffer.allocUnsafe(r):r=>new Uint8Array(r);function iY(r,e){if(H2(r)&&H2(e))return r.compare(e);for(let t=0;t<r.length;t++)if(r[t]!==e[t])return r[t]<e[t]?-1:1;return 0}function oI(r){const e=[];let t=0;for(let n=0;n<r.length;n++){let i=r.charCodeAt(n);i<128?e[t++]=i:i<2048?(e[t++]=i>>6|192,e[t++]=i&63|128):(i&64512)===55296&&n+1<r.length&&(r.charCodeAt(n+1)&64512)===56320?(i=65536+((i&1023)<<10)+(r.charCodeAt(++n)&1023),e[t++]=i>>18|240,e[t++]=i>>12&63|128,e[t++]=i>>6&63|128,e[t++]=i&63|128):(e[t++]=i>>12|224,e[t++]=i>>6&63|128,e[t++]=i&63|128)}return e}function aI(r,e,t){const n=[];for(;e<t;){const i=r[e];let s=null,o=i>239?4:i>223?3:i>191?2:1;if(e+o<=t){let a,c,l,d;switch(o){case 1:i<128&&(s=i);break;case 2:a=r[e+1],(a&192)===128&&(d=(i&31)<<6|a&63,d>127&&(s=d));break;case 3:a=r[e+1],c=r[e+2],(a&192)===128&&(c&192)===128&&(d=(i&15)<<12|(a&63)<<6|c&63,d>2047&&(d<55296||d>57343)&&(s=d));break;case 4:a=r[e+1],c=r[e+2],l=r[e+3],(a&192)===128&&(c&192)===128&&(l&192)===128&&(d=(i&15)<<18|(a&63)<<12|(c&63)<<6|l&63,d>65535&&d<1114112&&(s=d))}}s===null?(s=65533,o=1):s>65535&&(s-=65536,n.push(s>>>10&1023|55296),s=56320|s&1023),n.push(s),e+=o}return uL(n)}const cI=4096;function uL(r){const e=r.length;if(e<=cI)return String.fromCharCode.apply(String,r);let t="",n=0;for(;n<e;)t+=String.fromCharCode.apply(String,r.slice(n,n+=cI));return t}const sY=256;class dL{constructor(e=sY){this.chunkSize=e,this.cursor=0,this.maxCursor=-1,this.chunks=[],this._initReuseChunk=null}reset(){this.cursor=0,this.maxCursor=-1,this.chunks.length&&(this.chunks=[]),this._initReuseChunk!==null&&(this.chunks.push(this._initReuseChunk),this.maxCursor=this._initReuseChunk.length-1)}push(e){let t=this.chunks[this.chunks.length-1];if(this.cursor+e.length<=this.maxCursor+1){const i=t.length-(this.maxCursor-this.cursor)-1;t.set(e,i)}else{if(t){const i=t.length-(this.maxCursor-this.cursor)-1;i<t.length&&(this.chunks[this.chunks.length-1]=t.subarray(0,i),this.maxCursor=this.cursor-1)}e.length<64&&e.length<this.chunkSize?(t=nY(this.chunkSize),this.chunks.push(t),this.maxCursor+=t.length,this._initReuseChunk===null&&(this._initReuseChunk=t),t.set(e,0)):(this.chunks.push(e),this.maxCursor+=e.length)}this.cursor+=e.length}toBytes(e=!1){let t;if(this.chunks.length===1){const n=this.chunks[0];e&&this.cursor>n.length/2?(t=this.cursor===n.length?n:n.subarray(0,this.cursor),this._initReuseChunk=null,this.chunks=[]):t=kE(n,0,this.cursor)}else t=rY(this.chunks,this.cursor);return e&&this.reset(),t}}const ke="CBOR decode error:",kl="CBOR encode error:";function Th(r,e,t){if(r.length-e<t)throw new Error(`${ke} not enough data for type`)}const vr=[24,256,65536,4294967296,BigInt("18446744073709551616")];function gu(r,e,t){Th(r,e,1);const n=r[e];if(t.strict===!0&&n<vr[0])throw new Error(`${ke} integer encoded in more bytes than necessary (strict decode)`);return n}function yu(r,e,t){Th(r,e,2);const n=r[e]<<8|r[e+1];if(t.strict===!0&&n<vr[1])throw new Error(`${ke} integer encoded in more bytes than necessary (strict decode)`);return n}function mu(r,e,t){Th(r,e,4);const n=r[e]*16777216+(r[e+1]<<16)+(r[e+2]<<8)+r[e+3];if(t.strict===!0&&n<vr[2])throw new Error(`${ke} integer encoded in more bytes than necessary (strict decode)`);return n}function wu(r,e,t){Th(r,e,8);const n=r[e]*16777216+(r[e+1]<<16)+(r[e+2]<<8)+r[e+3],i=r[e+4]*16777216+(r[e+5]<<16)+(r[e+6]<<8)+r[e+7],s=(BigInt(n)<<BigInt(32))+BigInt(i);if(t.strict===!0&&s<vr[3])throw new Error(`${ke} integer encoded in more bytes than necessary (strict decode)`);if(s<=Number.MAX_SAFE_INTEGER)return Number(s);if(t.allowBigInt===!0)return s;throw new Error(`${ke} integers outside of the safe integer range are not supported`)}function oY(r,e,t,n){return new ie(V.uint,gu(r,e+1,n),2)}function aY(r,e,t,n){return new ie(V.uint,yu(r,e+1,n),3)}function cY(r,e,t,n){return new ie(V.uint,mu(r,e+1,n),5)}function lY(r,e,t,n){return new ie(V.uint,wu(r,e+1,n),9)}function bu(r,e){return Ri(r,0,e.value)}function Ri(r,e,t){if(t<vr[0]){const n=Number(t);r.push([e|n])}else if(t<vr[1]){const n=Number(t);r.push([e|24,n])}else if(t<vr[2]){const n=Number(t);r.push([e|25,n>>>8,n&255])}else if(t<vr[3]){const n=Number(t);r.push([e|26,n>>>24&255,n>>>16&255,n>>>8&255,n&255])}else{const n=BigInt(t);if(n<vr[4]){const i=[e|27,0,0,0,0,0,0,0];let s=Number(n&BigInt(4294967295)),o=Number(n>>BigInt(32)&BigInt(4294967295));i[8]=s&255,s=s>>8,i[7]=s&255,s=s>>8,i[6]=s&255,s=s>>8,i[5]=s&255,i[4]=o&255,o=o>>8,i[3]=o&255,o=o>>8,i[2]=o&255,o=o>>8,i[1]=o&255,r.push(i)}else throw new Error(`${ke} encountered BigInt larger than allowable range`)}}bu.encodedSize=function(e){return Ri.encodedSize(e.value)};Ri.encodedSize=function(e){return e<vr[0]?1:e<vr[1]?2:e<vr[2]?3:e<vr[3]?5:9};bu.compareTokens=function(e,t){return e.value<t.value?-1:e.value>t.value?1:0};function uY(r,e,t,n){return new ie(V.negint,-1-gu(r,e+1,n),2)}function dY(r,e,t,n){return new ie(V.negint,-1-yu(r,e+1,n),3)}function hY(r,e,t,n){return new ie(V.negint,-1-mu(r,e+1,n),5)}const _E=BigInt(-1),hL=BigInt(1);function fY(r,e,t,n){const i=wu(r,e+1,n);if(typeof i!="bigint"){const s=-1-i;if(s>=Number.MIN_SAFE_INTEGER)return new ie(V.negint,s,9)}if(n.allowBigInt!==!0)throw new Error(`${ke} integers outside of the safe integer range are not supported`);return new ie(V.negint,_E-BigInt(i),9)}function TE(r,e){const t=e.value,n=typeof t=="bigint"?t*_E-hL:t*-1-1;Ri(r,e.type.majorEncoded,n)}TE.encodedSize=function(e){const t=e.value,n=typeof t=="bigint"?t*_E-hL:t*-1-1;return n<vr[0]?1:n<vr[1]?2:n<vr[2]?3:n<vr[3]?5:9};TE.compareTokens=function(e,t){return e.value<t.value?1:e.value>t.value?-1:0};function Dp(r,e,t,n){Th(r,e,t+n);const i=kE(r,e+t,e+t+n);return new ie(V.bytes,i,t+n)}function pY(r,e,t,n){return Dp(r,e,1,t)}function gY(r,e,t,n){return Dp(r,e,2,gu(r,e+1,n))}function yY(r,e,t,n){return Dp(r,e,3,yu(r,e+1,n))}function mY(r,e,t,n){return Dp(r,e,5,mu(r,e+1,n))}function wY(r,e,t,n){const i=wu(r,e+1,n);if(typeof i=="bigint")throw new Error(`${ke} 64-bit integer bytes lengths not supported`);return Dp(r,e,9,i)}function q2(r){return r.encodedBytes===void 0&&(r.encodedBytes=r.type===V.string?lL(r.value):r.value),r.encodedBytes}function R3(r,e){const t=q2(e);Ri(r,e.type.majorEncoded,t.length),r.push(t)}R3.encodedSize=function(e){const t=q2(e);return Ri.encodedSize(t.length)+t.length};R3.compareTokens=function(e,t){return bY(q2(e),q2(t))};function bY(r,e){return r.length<e.length?-1:r.length>e.length?1:iY(r,e)}function $p(r,e,t,n,i){const s=t+n;Th(r,e,s);const o=new ie(V.string,tY(r,e+t,e+s),s);return i.retainStringBytes===!0&&(o.byteValue=kE(r,e+t,e+s)),o}function vY(r,e,t,n){return $p(r,e,1,t,n)}function EY(r,e,t,n){return $p(r,e,2,gu(r,e+1,n),n)}function SY(r,e,t,n){return $p(r,e,3,yu(r,e+1,n),n)}function xY(r,e,t,n){return $p(r,e,5,mu(r,e+1,n),n)}function AY(r,e,t,n){const i=wu(r,e+1,n);if(typeof i=="bigint")throw new Error(`${ke} 64-bit integer string lengths not supported`);return $p(r,e,9,i,n)}const CY=R3;function Ph(r,e,t,n){return new ie(V.array,n,t)}function IY(r,e,t,n){return Ph(r,e,1,t)}function kY(r,e,t,n){return Ph(r,e,2,gu(r,e+1,n))}function _Y(r,e,t,n){return Ph(r,e,3,yu(r,e+1,n))}function TY(r,e,t,n){return Ph(r,e,5,mu(r,e+1,n))}function PY(r,e,t,n){const i=wu(r,e+1,n);if(typeof i=="bigint")throw new Error(`${ke} 64-bit integer array lengths not supported`);return Ph(r,e,9,i)}function DY(r,e,t,n){if(n.allowIndefinite===!1)throw new Error(`${ke} indefinite length items not allowed`);return Ph(r,e,1,1/0)}function PE(r,e){Ri(r,V.array.majorEncoded,e.value)}PE.compareTokens=bu.compareTokens;PE.encodedSize=function(e){return Ri.encodedSize(e.value)};function Dh(r,e,t,n){return new ie(V.map,n,t)}function $Y(r,e,t,n){return Dh(r,e,1,t)}function NY(r,e,t,n){return Dh(r,e,2,gu(r,e+1,n))}function MY(r,e,t,n){return Dh(r,e,3,yu(r,e+1,n))}function OY(r,e,t,n){return Dh(r,e,5,mu(r,e+1,n))}function RY(r,e,t,n){const i=wu(r,e+1,n);if(typeof i=="bigint")throw new Error(`${ke} 64-bit integer map lengths not supported`);return Dh(r,e,9,i)}function LY(r,e,t,n){if(n.allowIndefinite===!1)throw new Error(`${ke} indefinite length items not allowed`);return Dh(r,e,1,1/0)}function DE(r,e){Ri(r,V.map.majorEncoded,e.value)}DE.compareTokens=bu.compareTokens;DE.encodedSize=function(e){return Ri.encodedSize(e.value)};function BY(r,e,t,n){return new ie(V.tag,t,1)}function UY(r,e,t,n){return new ie(V.tag,gu(r,e+1,n),2)}function FY(r,e,t,n){return new ie(V.tag,yu(r,e+1,n),3)}function zY(r,e,t,n){return new ie(V.tag,mu(r,e+1,n),5)}function VY(r,e,t,n){return new ie(V.tag,wu(r,e+1,n),9)}function $E(r,e){Ri(r,V.tag.majorEncoded,e.value)}$E.compareTokens=bu.compareTokens;$E.encodedSize=function(e){return Ri.encodedSize(e.value)};const KY=20,jY=21,HY=22,qY=23;function WY(r,e,t,n){if(n.allowUndefined===!1)throw new Error(`${ke} undefined values are not supported`);return n.coerceUndefinedToNull===!0?new ie(V.null,null,1):new ie(V.undefined,void 0,1)}function GY(r,e,t,n){if(n.allowIndefinite===!1)throw new Error(`${ke} indefinite length items not allowed`);return new ie(V.break,void 0,1)}function NE(r,e,t){if(t){if(t.allowNaN===!1&&Number.isNaN(r))throw new Error(`${ke} NaN values are not supported`);if(t.allowInfinity===!1&&(r===1/0||r===-1/0))throw new Error(`${ke} Infinity values are not supported`)}return new ie(V.float,r,e)}function QY(r,e,t,n){return NE(OE(r,e+1),3,n)}function YY(r,e,t,n){return NE(RE(r,e+1),5,n)}function JY(r,e,t,n){return NE(yL(r,e+1),9,n)}function ME(r,e,t){const n=e.value;if(n===!1)r.push([V.float.majorEncoded|KY]);else if(n===!0)r.push([V.float.majorEncoded|jY]);else if(n===null)r.push([V.float.majorEncoded|HY]);else if(n===void 0)r.push([V.float.majorEncoded|qY]);else{let i,s=!1;(!t||t.float64!==!0)&&(pL(n),i=OE(Gi,1),n===i||Number.isNaN(n)?(Gi[0]=249,r.push(Gi.slice(0,3)),s=!0):(gL(n),i=RE(Gi,1),n===i&&(Gi[0]=250,r.push(Gi.slice(0,5)),s=!0))),s||(XY(n),i=yL(Gi,1),Gi[0]=251,r.push(Gi.slice(0,9)))}}ME.encodedSize=function(e,t){const n=e.value;if(n===!1||n===!0||n===null||n===void 0)return 1;if(!t||t.float64!==!0){pL(n);let i=OE(Gi,1);if(n===i||Number.isNaN(n))return 3;if(gL(n),i=RE(Gi,1),n===i)return 5}return 9};const fL=new ArrayBuffer(9),fi=new DataView(fL,1),Gi=new Uint8Array(fL,0);function pL(r){if(r===1/0)fi.setUint16(0,31744,!1);else if(r===-1/0)fi.setUint16(0,64512,!1);else if(Number.isNaN(r))fi.setUint16(0,32256,!1);else{fi.setFloat32(0,r);const e=fi.getUint32(0),t=(e&2139095040)>>23,n=e&8388607;if(t===255)fi.setUint16(0,31744,!1);else if(t===0)fi.setUint16(0,(r&2147483648)>>16|n>>13,!1);else{const i=t-127;i<-24?fi.setUint16(0,0):i<-14?fi.setUint16(0,(e&2147483648)>>16|1<<24+i,!1):fi.setUint16(0,(e&2147483648)>>16|i+15<<10|n>>13,!1)}}}function OE(r,e){if(r.length-e<2)throw new Error(`${ke} not enough data for float16`);const t=(r[e]<<8)+r[e+1];if(t===31744)return 1/0;if(t===64512)return-1/0;if(t===32256)return NaN;const n=t>>10&31,i=t&1023;let s;return n===0?s=i*2**-24:n!==31?s=(i+1024)*2**(n-25):s=i===0?1/0:NaN,t&32768?-s:s}function gL(r){fi.setFloat32(0,r,!1)}function RE(r,e){if(r.length-e<4)throw new Error(`${ke} not enough data for float32`);const t=(r.byteOffset||0)+e;return new DataView(r.buffer,t,4).getFloat32(0,!1)}function XY(r){fi.setFloat64(0,r,!1)}function yL(r,e){if(r.length-e<8)throw new Error(`${ke} not enough data for float64`);const t=(r.byteOffset||0)+e;return new DataView(r.buffer,t,8).getFloat64(0,!1)}ME.compareTokens=bu.compareTokens;function at(r,e,t){throw new Error(`${ke} encountered invalid minor (${t}) for major ${r[e]>>>5}`)}function L3(r){return()=>{throw new Error(`${ke} ${r}`)}}const le=[];for(let r=0;r<=23;r++)le[r]=at;le[24]=oY;le[25]=aY;le[26]=cY;le[27]=lY;le[28]=at;le[29]=at;le[30]=at;le[31]=at;for(let r=32;r<=55;r++)le[r]=at;le[56]=uY;le[57]=dY;le[58]=hY;le[59]=fY;le[60]=at;le[61]=at;le[62]=at;le[63]=at;for(let r=64;r<=87;r++)le[r]=pY;le[88]=gY;le[89]=yY;le[90]=mY;le[91]=wY;le[92]=at;le[93]=at;le[94]=at;le[95]=L3("indefinite length bytes/strings are not supported");for(let r=96;r<=119;r++)le[r]=vY;le[120]=EY;le[121]=SY;le[122]=xY;le[123]=AY;le[124]=at;le[125]=at;le[126]=at;le[127]=L3("indefinite length bytes/strings are not supported");for(let r=128;r<=151;r++)le[r]=IY;le[152]=kY;le[153]=_Y;le[154]=TY;le[155]=PY;le[156]=at;le[157]=at;le[158]=at;le[159]=DY;for(let r=160;r<=183;r++)le[r]=$Y;le[184]=NY;le[185]=MY;le[186]=OY;le[187]=RY;le[188]=at;le[189]=at;le[190]=at;le[191]=LY;for(let r=192;r<=215;r++)le[r]=BY;le[216]=UY;le[217]=FY;le[218]=zY;le[219]=VY;le[220]=at;le[221]=at;le[222]=at;le[223]=at;for(let r=224;r<=243;r++)le[r]=L3("simple values are not supported");le[244]=at;le[245]=at;le[246]=at;le[247]=WY;le[248]=L3("simple values are not supported");le[249]=QY;le[250]=YY;le[251]=JY;le[252]=at;le[253]=at;le[254]=at;le[255]=GY;const Qs=[];for(let r=0;r<24;r++)Qs[r]=new ie(V.uint,r,1);for(let r=-1;r>=-24;r--)Qs[31-r]=new ie(V.negint,r,1);Qs[64]=new ie(V.bytes,new Uint8Array(0),1);Qs[96]=new ie(V.string,"",1);Qs[128]=new ie(V.array,0,1);Qs[160]=new ie(V.map,0,1);Qs[244]=new ie(V.false,!1,1);Qs[245]=new ie(V.true,!0,1);Qs[246]=new ie(V.null,null,1);function ZY(r){switch(r.type){case V.false:return ro([244]);case V.true:return ro([245]);case V.null:return ro([246]);case V.bytes:return r.value.length?void 0:ro([64]);case V.string:return r.value===""?ro([96]):void 0;case V.array:return r.value===0?ro([128]):void 0;case V.map:return r.value===0?ro([160]):void 0;case V.uint:return r.value<24?ro([Number(r.value)]):void 0;case V.negint:if(r.value>=-24)return ro([31-Number(r.value)])}}const eJ={float64:!1,mapSorter:nJ,quickEncodeToken:ZY};function tJ(){const r=[];return r[V.uint.major]=bu,r[V.negint.major]=TE,r[V.bytes.major]=R3,r[V.string.major]=CY,r[V.array.major]=PE,r[V.map.major]=DE,r[V.tag.major]=$E,r[V.float.major]=ME,r}const mL=tJ(),m5=new dL;class W2{constructor(e,t){this.obj=e,this.parent=t}includes(e){let t=this;do if(t.obj===e)return!0;while(t=t.parent);return!1}static createCheck(e,t){if(e&&e.includes(t))throw new Error(`${kl} object contains circular references`);return new W2(t,e)}}const ha={null:new ie(V.null,null),undefined:new ie(V.undefined,void 0),true:new ie(V.true,!0),false:new ie(V.false,!1),emptyArray:new ie(V.array,0),emptyMap:new ie(V.map,0)},bc={number(r,e,t,n){return!Number.isInteger(r)||!Number.isSafeInteger(r)?new ie(V.float,r):r>=0?new ie(V.uint,r):new ie(V.negint,r)},bigint(r,e,t,n){return r>=BigInt(0)?new ie(V.uint,r):new ie(V.negint,r)},Uint8Array(r,e,t,n){return new ie(V.bytes,r)},string(r,e,t,n){return new ie(V.string,r)},boolean(r,e,t,n){return r?ha.true:ha.false},null(r,e,t,n){return ha.null},undefined(r,e,t,n){return ha.undefined},ArrayBuffer(r,e,t,n){return new ie(V.bytes,new Uint8Array(r))},DataView(r,e,t,n){return new ie(V.bytes,new Uint8Array(r.buffer,r.byteOffset,r.byteLength))},Array(r,e,t,n){if(!r.length)return t.addBreakTokens===!0?[ha.emptyArray,new ie(V.break)]:ha.emptyArray;n=W2.createCheck(n,r);const i=[];let s=0;for(const o of r)i[s++]=Vg(o,t,n);return t.addBreakTokens?[new ie(V.array,r.length),i,new ie(V.break)]:[new ie(V.array,r.length),i]},Object(r,e,t,n){const i=e!=="Object",s=i?r.keys():Object.keys(r),o=i?r.size:s.length;if(!o)return t.addBreakTokens===!0?[ha.emptyMap,new ie(V.break)]:ha.emptyMap;n=W2.createCheck(n,r);const a=[];let c=0;for(const l of s)a[c++]=[Vg(l,t,n),Vg(i?r.get(l):r[l],t,n)];return rJ(a,t),t.addBreakTokens?[new ie(V.map,o),a,new ie(V.break)]:[new ie(V.map,o),a]}};bc.Map=bc.Object;bc.Buffer=bc.Uint8Array;for(const r of"Uint8Clamped Uint16 Uint32 Int8 Int16 Int32 BigUint64 BigInt64 Float32 Float64".split(" "))bc[`${r}Array`]=bc.DataView;function Vg(r,e={},t){const n=YQ(r),i=e&&e.typeEncoders&&e.typeEncoders[n]||bc[n];if(typeof i=="function"){const o=i(r,n,e,t);if(o!=null)return o}const s=bc[n];if(!s)throw new Error(`${kl} unsupported type: ${n}`);return s(r,n,e,t)}function rJ(r,e){e.mapSorter&&r.sort(e.mapSorter)}function nJ(r,e){const t=Array.isArray(r[0])?r[0][0]:r[0],n=Array.isArray(e[0])?e[0][0]:e[0];if(t.type!==n.type)return t.type.compare(n.type);const i=t.type.major,s=mL[i].compareTokens(t,n);return s===0&&console.warn("WARNING: complex key types used, CBOR key sorting guarantees are gone"),s}function wL(r,e,t,n){if(Array.isArray(e))for(const i of e)wL(r,i,t,n);else t[e.type.major](r,e,n)}function bL(r,e,t){const n=Vg(r,t);if(!Array.isArray(n)&&t.quickEncodeToken){const i=t.quickEncodeToken(n);if(i)return i;const s=e[n.type.major];if(s.encodedSize){const o=s.encodedSize(n,t),a=new dL(o);if(s(a,n,t),a.chunks.length!==1)throw new Error(`Unexpected error: pre-calculated length for ${n} was wrong`);return IE(a.chunks[0])}}return m5.reset(),wL(m5,n,e,t),m5.toBytes(!0)}function Kg(r,e){return e=Object.assign({},eJ,e),bL(r,mL,e)}const iJ={strict:!1,allowIndefinite:!0,allowUndefined:!0,allowBigInt:!0};class sJ{constructor(e,t={}){this._pos=0,this.data=e,this.options=t}pos(){return this._pos}done(){return this._pos>=this.data.length}next(){const e=this.data[this._pos];let t=Qs[e];if(t===void 0){const n=le[e];if(!n)throw new Error(`${ke} no decoder for major type ${e>>>5} (byte 0x${e.toString(16).padStart(2,"0")})`);const i=e&31;t=n(this.data,this._pos,i,this.options)}return this._pos+=t.encodedLength,t}}const B1=Symbol.for("DONE"),B3=Symbol.for("BREAK");function oJ(r,e,t){const n=[];for(let i=0;i<r.value;i++){const s=U1(e,t);if(s===B3){if(r.value===1/0)break;throw new Error(`${ke} got unexpected break to lengthed array`)}if(s===B1)throw new Error(`${ke} found array but not enough entries (got ${i}, expected ${r.value})`);n[i]=s}return n}function aJ(r,e,t){const n=t.useMaps===!0,i=n?void 0:{},s=n?new Map:void 0;for(let o=0;o<r.value;o++){const a=U1(e,t);if(a===B3){if(r.value===1/0)break;throw new Error(`${ke} got unexpected break to lengthed map`)}if(a===B1)throw new Error(`${ke} found map but not enough entries (got ${o} [no key], expected ${r.value})`);if(n!==!0&&typeof a!="string")throw new Error(`${ke} non-string keys not supported (got ${typeof a})`);if(t.rejectDuplicateMapKeys===!0&&(n&&s.has(a)||!n&&a in i))throw new Error(`${ke} found repeat map key "${a}"`);const c=U1(e,t);if(c===B1)throw new Error(`${ke} found map but not enough entries (got ${o} [no value], expected ${r.value})`);n?s.set(a,c):i[a]=c}return n?s:i}function U1(r,e){if(r.done())return B1;const t=r.next();if(t.type===V.break)return B3;if(t.type.terminal)return t.value;if(t.type===V.array)return oJ(t,r,e);if(t.type===V.map)return aJ(t,r,e);if(t.type===V.tag){if(e.tags&&typeof e.tags[t.value]=="function"){const n=U1(r,e);return e.tags[t.value](n)}throw new Error(`${ke} tag not supported (${t.value})`)}throw new Error("unsupported")}function cJ(r,e){if(!(r instanceof Uint8Array))throw new Error(`${ke} data to decode must be a Uint8Array`);e=Object.assign({},iJ,e);const t=e.tokenizer||new sJ(r,e),n=U1(t,e);if(n===B1)throw new Error(`${ke} did not find any content to decode`);if(n===B3)throw new Error(`${ke} got unexpected break`);return[n,r.subarray(t.pos())]}function za(r,e){const[t,n]=cJ(r,e);if(n.length>0)throw new Error(`${ke} too many terminals, data makes no sense`);return t}function lJ(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function LE(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function uJ(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var i=0;i<r.length;i++){var s=r.charAt(i),o=s.charCodeAt(0);if(t[o]!==255)throw new TypeError(s+" is ambiguous");t[o]=i}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),d=Math.log(256)/Math.log(a);function h(f){if(f instanceof Uint8Array||(ArrayBuffer.isView(f)?f=new Uint8Array(f.buffer,f.byteOffset,f.byteLength):Array.isArray(f)&&(f=Uint8Array.from(f))),!(f instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(f.length===0)return"";for(var g=0,v=0,y=0,w=f.length;y!==w&&f[y]===0;)y++,g++;for(var b=(w-y)*d+1>>>0,E=new Uint8Array(b);y!==w;){for(var A=f[y],k=0,x=b-1;(A!==0||k<v)&&x!==-1;x--,k++)A+=256*E[x]>>>0,E[x]=A%a>>>0,A=A/a>>>0;if(A!==0)throw new Error("Non-zero carry");v=k,y++}for(var I=b-v;I!==b&&E[I]===0;)I++;for(var T=c.repeat(g);I<b;++I)T+=r.charAt(E[I]);return T}function p(f){if(typeof f!="string")throw new TypeError("Expected String");if(f.length===0)return new Uint8Array;var g=0;if(f[g]!==" "){for(var v=0,y=0;f[g]===c;)v++,g++;for(var w=(f.length-g)*l+1>>>0,b=new Uint8Array(w);f[g];){var E=t[f.charCodeAt(g)];if(E===255)return;for(var A=0,k=w-1;(E!==0||A<y)&&k!==-1;k--,A++)E+=a*b[k]>>>0,b[k]=E%256>>>0,E=E/256>>>0;if(E!==0)throw new Error("Non-zero carry");y=A,g++}if(f[g]!==" "){for(var x=w-y;x!==w&&b[x]===0;)x++;for(var I=new Uint8Array(v+(w-x)),T=v;x!==w;)I[T++]=b[x++];return I}}}function m(f){var g=p(f);if(g)return g;throw new Error(`Non-${e} character`)}return{encode:h,decodeUnsafe:p,decode:m}}var dJ=uJ,hJ=dJ;let fJ=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseEncode");this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},pJ=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseDecode");u(this,"prefixCodePoint");this.name=e,this.prefix=t;const i=t.codePointAt(0);if(i===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=i,this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return vL(this,e)}},gJ=class{constructor(e){u(this,"decoders");this.decoders=e}or(e){return vL(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};function vL(r,e){return new gJ({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}let yJ=class{constructor(e,t,n,i){u(this,"name");u(this,"prefix");u(this,"baseEncode");u(this,"baseDecode");u(this,"encoder");u(this,"decoder");this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=i,this.encoder=new fJ(e,t,n),this.decoder=new pJ(e,t,i)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};function EL({name:r,prefix:e,encode:t,decode:n}){return new yJ(r,e,t,n)}function U3({name:r,prefix:e,alphabet:t}){const{encode:n,decode:i}=hJ(t,r);return EL({prefix:e,name:r,encode:n,decode:s=>LE(i(s))})}function mJ(r,e,t,n){const i={};for(let d=0;d<e.length;++d)i[e[d]]=d;let s=r.length;for(;r[s-1]==="=";)--s;const o=new Uint8Array(s*t/8|0);let a=0,c=0,l=0;for(let d=0;d<s;++d){const h=i[r[d]];if(h===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|h,a+=t,a>=8&&(a-=8,o[l++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o}function wJ(r,e,t){const n=e[e.length-1]==="=",i=(1<<t)-1;let s="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,s+=e[i&a>>o];if(o!==0&&(s+=e[i&a<<t-o]),n)for(;s.length*t&7;)s+="=";return s}function Jo({name:r,prefix:e,bitsPerChar:t,alphabet:n}){return EL({prefix:e,name:r,encode(i){return wJ(i,n,t)},decode(i){return mJ(i,n,t,r)}})}const jg=Jo({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});Jo({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});Jo({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});Jo({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});Jo({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});Jo({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});Jo({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});Jo({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});Jo({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const w5=U3({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"});U3({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});const _a=U3({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});U3({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var bJ=SL,lI=128,vJ=-128,EJ=Math.pow(2,31);function SL(r,e,t){e=e||[],t=t||0;for(var n=t;r>=EJ;)e[t++]=r&255|lI,r/=128;for(;r&vJ;)e[t++]=r&255|lI,r>>>=7;return e[t]=r|0,SL.bytes=t-n+1,e}var SJ=ib,xJ=128,uI=127;function ib(r,n){var t=0,n=n||0,i=0,s=n,o,a=r.length;do{if(s>=a)throw ib.bytes=0,new RangeError("Could not decode varint");o=r[s++],t+=i<28?(o&uI)<<i:(o&uI)*Math.pow(2,i),i+=7}while(o>=xJ);return ib.bytes=s-n,t}var AJ=Math.pow(2,7),CJ=Math.pow(2,14),IJ=Math.pow(2,21),kJ=Math.pow(2,28),_J=Math.pow(2,35),TJ=Math.pow(2,42),PJ=Math.pow(2,49),DJ=Math.pow(2,56),$J=Math.pow(2,63),NJ=function(r){return r<AJ?1:r<CJ?2:r<IJ?3:r<kJ?4:r<_J?5:r<TJ?6:r<PJ?7:r<DJ?8:r<$J?9:10},MJ={encode:bJ,decode:SJ,encodingLength:NJ},G2=MJ;function sb(r,e=0){return[G2.decode(r,e),G2.decode.bytes]}function Q2(r,e,t=0){return G2.encode(r,e,t),e}function Y2(r){return G2.encodingLength(r)}function OJ(r,e){const t=e.byteLength,n=Y2(r),i=n+Y2(t),s=new Uint8Array(i+t);return Q2(r,s,0),Q2(t,s,n),s.set(e,i),new BE(r,t,e,s)}function RJ(r){const e=LE(r),[t,n]=sb(e),[i,s]=sb(e.subarray(n)),o=e.subarray(n+s);if(o.byteLength!==i)throw new Error("Incorrect length");return new BE(t,i,o,e)}function LJ(r,e){if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&lJ(r.bytes,t.bytes)}}let BE=class{constructor(e,t,n,i){u(this,"code");u(this,"size");u(this,"digest");u(this,"bytes");this.code=e,this.size=t,this.digest=n,this.bytes=i}};function dI(r,e){const{bytes:t,version:n}=r;switch(n){case 0:return UJ(t,ob(r),e??_a.encoder);default:return FJ(t,ob(r),e??jg.encoder)}}const hI=new WeakMap;function ob(r){const e=hI.get(r);if(e==null){const t=new Map;return hI.set(r,t),t}return e}var rN;let xL=class Or{constructor(e,t,n,i){u(this,"code");u(this,"version");u(this,"multihash");u(this,"bytes");u(this,"/");u(this,rN,"CID");this.code=t,this.version=e,this.multihash=n,this.bytes=i,this["/"]=i}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==af)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==zJ)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return Or.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=OJ(e,t);return Or.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return Or.equals(this,e)}static equals(e,t){const n=t;return n!=null&&e.code===n.code&&e.version===n.version&&LJ(e.multihash,n.multihash)}toString(e){return dI(this,e)}toJSON(){return{"/":dI(this)}}link(){return this}[(rN=Symbol.toStringTag,Symbol.for("nodejs.util.inspect.custom"))](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof Or)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:i,multihash:s,bytes:o}=t;return new Or(n,i,s,o??fI(n,i,s.bytes))}else if(t[VJ]===!0){const{version:n,multihash:i,code:s}=t,o=RJ(i);return Or.create(n,s,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==af)throw new Error(`Version 0 CID must use dag-pb (code: ${af}) block encoding`);return new Or(e,t,n,n.bytes)}case 1:{const i=fI(e,t,n.bytes);return new Or(e,t,n,i)}default:throw new Error("Invalid version")}}static createV0(e){return Or.create(0,af,e)}static createV1(e,t){return Or.create(1,e,t)}static decode(e){const[t,n]=Or.decodeFirst(e);if(n.length!==0)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=Or.inspectBytes(e),n=t.size-t.multihashSize,i=LE(e.subarray(n,n+t.multihashSize));if(i.byteLength!==t.multihashSize)throw new Error("Incorrect length");const s=i.subarray(t.multihashSize-t.digestSize),o=new BE(t.multihashCode,t.digestSize,s,i);return[t.version===0?Or.createV0(o):Or.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[h,p]=sb(e.subarray(t));return t+=p,h};let i=n(),s=af;if(i===18?(i=0,t=0):s=n(),i!==0&&i!==1)throw new RangeError(`Invalid CID version ${i}`);const o=t,a=n(),c=n(),l=t+c,d=l-o;return{version:i,codec:s,multihashCode:a,digestSize:c,multihashSize:d,size:l}}static parse(e,t){const[n,i]=BJ(e,t),s=Or.decode(i);if(s.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return ob(s).set(n,e),s}};function BJ(r,e){switch(r[0]){case"Q":{const t=e??_a;return[_a.prefix,t.decode(`${_a.prefix}${r}`)]}case _a.prefix:{const t=e??_a;return[_a.prefix,t.decode(r)]}case jg.prefix:{const t=e??jg;return[jg.prefix,t.decode(r)]}case w5.prefix:{const t=e??w5;return[w5.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}}function UJ(r,e,t){const{prefix:n}=t;if(n!==_a.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const i=e.get(n);if(i==null){const s=t.encode(r).slice(1);return e.set(n,s),s}else return i}function FJ(r,e,t){const{prefix:n}=t,i=e.get(n);if(i==null){const s=t.encode(r);return e.set(n,s),s}else return i}const af=112,zJ=18;function fI(r,e,t){const n=Y2(r),i=n+Y2(e),s=new Uint8Array(i+t.byteLength);return Q2(r,s,0),Q2(e,s,n),s.set(t,i),s}const VJ=Symbol.for("@ipld/js-cid/CID"),AL=42;function CL(r){return r instanceof ArrayBuffer?new Uint8Array(r,0,r.byteLength):r}function KJ(r){if(r.asCID!==r&&r["/"]!==r.bytes)return null;const e=xL.asCID(r);if(!e)return null;const t=new Uint8Array(e.bytes.byteLength+1);return t.set(e.bytes,1),[new ie(V.tag,AL),new ie(V.bytes,t)]}function jJ(){throw new Error("`undefined` is not supported by the IPLD Data Model and cannot be encoded")}function HJ(r){if(Number.isNaN(r))throw new Error("`NaN` is not supported by the IPLD Data Model and cannot be encoded");if(r===1/0||r===-1/0)throw new Error("`Infinity` and `-Infinity` is not supported by the IPLD Data Model and cannot be encoded");return null}const ab={float64:!0,typeEncoders:{Object:KJ,undefined:jJ,number:HJ}},qJ={...ab,typeEncoders:{...ab.typeEncoders}};function WJ(r){if(r[0]!==0)throw new Error("Invalid CID for CBOR tag 42; expected leading 0x00");return xL.decode(r.subarray(1))}const J2={allowIndefinite:!1,coerceUndefinedToNull:!0,allowNaN:!1,allowInfinity:!1,allowBigInt:!0,strict:!0,useMaps:!1,rejectDuplicateMapKeys:!0,tags:[]};J2.tags[AL]=WJ;const GJ={...J2,tags:J2.tags.slice()},QJ="dag-cbor",IL=113,YJ=r=>Kg(r,ab),JJ=r=>za(CL(r),J2),Np=Object.freeze(Object.defineProperty({__proto__:null,code:IL,decode:JJ,decodeOptions:GJ,encode:YJ,encodeOptions:qJ,name:QJ,toByteView:CL},Symbol.toStringTag,{value:"Module"})),XJ=r=>async e=>new Uint8Array(await crypto.subtle.digest(r,e)),F3=KQ({name:"sha2-256",code:18,encode:XJ("SHA-256")}),z3=Np,V3=F3,kL=on,ZJ=async(r,e,t,n=null,i=[],s=[])=>{if(r==null)throw new Error("Identity is required, cannot create entry");if(e==null)throw new Error("Entry requires an id");if(t==null)throw new Error("Entry requires a payload");if(i==null||!Array.isArray(i))throw new Error("'next' argument is not an array");n=n||M3(r.publicKey);const o={id:e,payload:t,next:i,refs:s,clock:n,v:2},{bytes:a}=await kh({value:o,codec:z3,hasher:V3}),c=await r.sign(r,a);return o.key=r.publicKey,o.identity=r.hash,o.sig=c,TL(o)},eX=async(r,e)=>{if(!r)throw new Error("Identities is required, cannot verify entry");if(!_L(e))throw new Error("Invalid Log entry");if(!e.key)throw new Error("Entry doesn't have a key");if(!e.sig)throw new Error("Entry doesn't have a signature");const t={id:e.id,payload:e.payload,next:e.next,refs:e.refs,clock:e.clock,v:e.v},{bytes:n}=await kh({value:t,codec:z3,hasher:V3});return r.verify(e.sig,e.key,n)},_L=r=>r&&r.id!==void 0&&r.next!==void 0&&r.payload!==void 0&&r.v!==void 0&&r.clock!==void 0&&r.refs!==void 0,tX=(r,e)=>r&&e&&r.hash===e.hash,rX=async r=>{const{cid:e,value:t}=await O3({bytes:r,codec:z3,hasher:V3}),n=e.toString(kL);return{...t,hash:n,bytes:r}},TL=async r=>{const{cid:e,bytes:t}=await kh({value:r,codec:z3,hasher:V3}),n=e.toString(kL),i=M3(r.clock.id,r.clock.time);return{...r,clock:i,hash:n,bytes:t}},mo={create:ZJ,verify:eX,decode:rX,encode:TL,isEntry:_L,isEqual:tX},UE=async()=>{let r={};const e=async(c,l)=>{r[c]=l};return{put:e,del:async c=>{delete r[c]},get:async c=>r[c],iterator:async function*(){for await(const[c,l]of Object.entries(r))yield[c,l]},merge:async c=>{if(c)for await(const[l,d]of c.iterator())e(l,d)},clear:async()=>{r={}},close:async()=>{}}},nX=UE,iX=async({storage:r,heads:e})=>{r=r||await nX();const t=async d=>{d=pI(d);for(const h of d)await r.put(h.hash,h.bytes)},n=async d=>{await r.clear(),await t(d)},i=async d=>{const h=await a();if(h.find(m=>mo.isEqual(m,d)))return;const p=pI([...h,d]);return await n(p),p},s=async d=>{const p=(await a()).filter(m=>m.hash!==d);await n(p)},o=async function*(){const d=r.iterator();for await(const[,h]of d)yield await mo.decode(h)},a=async()=>{const d=[];for await(const h of o())d.push(h);return d},c=async()=>{await r.clear()},l=async()=>{await r.close()};return await t(e||[]),{put:t,set:n,add:i,remove:s,iterator:o,all:a,clear:c,close:l}},pI=r=>{r=new Set(r);const e={};for(const n of r)for(const i of n.next)e[i]=n.hash;const t=[];for(const n of r)e[n.hash]||t.push(n);return t};function sX(r,e){const t=(s,o)=>s,n=(s,o)=>aX(s,o,t);return((s,o)=>oX(s,o,n))(r,e)}function oX(r,e,t){const n=cQ(r.clock,e.clock);return n===0?t(r,e):n}function aX(r,e,t){return r.clock.id===e.clock.id?t(r,e):r.clock.id<e.clock.id?-1:1}function cX(r){const e=`Your log's tiebreaker function, ${r.name}, has returned zero and therefore cannot be`;return(n,i)=>{const s=r(n,i);if(s===0)throw Error(e);return s}}const lX={LastWriteWins:sX,NoZeroes:cX},{LastWriteWins:uX,NoZeroes:dX}=lX,hX=()=>new Date().getTime().toString(),fX=(r,e)=>Math.max(r,e.clock.time),b5=UE,pX=async()=>({canAppend:async r=>!0}),gX=async(r,{logId:e,logHeads:t,access:n,entryStorage:i,headsStorage:s,indexStorage:o,sortFn:a}={})=>{if(r==null)throw new Error("Identity is required");if(t!=null&&!Array.isArray(t))throw new Error("'logHeads' argument must be an array");const c=e||hX();n=n||await pX();const l=i||await b5(),d=o||await b5();s=s||await b5();const h=await iX({storage:s,heads:t});a=dX(a||uX);const p=new wc({concurrency:1}),m=new wc({concurrency:1}),f=async()=>{const B=Math.max(0,(await g()).reduce(fX,0));return M3(r.publicKey,B)},g=async()=>(await h.all()).sort(a).reverse(),v=async()=>{const B=[];for await(const G of k())B.unshift(G);return B},y=async B=>{const G=await l.get(B);if(G)return await mo.decode(G)},w=async B=>await d.get(B)!=null,b=async(B,G={referencesCount:0})=>{const j=async()=>{const q=await g(),Q=q.map(W=>W.hash),K=await z(q,G.referencesCount+q.length),O=await mo.create(r,c,B,lQ(await f()),Q,K);if(!await n.canAppend(O))throw new Error(`Could not append entry:
Key "${r.hash}" is not allowed to write to the log`);return await h.set([O]),await l.put(O.hash,O.bytes),await d.put(O.hash,!0),O};return p.add(j)},E=async B=>{if(!B)throw new Error("Log instance not defined");if(!L(B))throw new Error("Given argument is not an instance of Log");l.merge&&await l.merge(B.storage);const G=await B.heads();for(const j of G)await A(j)},A=async B=>{const G=async()=>{if(await w(B.hash))return!1;const q=async Y=>{if(Y.id!==c)throw new Error(`Entry's id (${Y.id}) doesn't match the log's id (${c}).`);if(!await n.canAppend(Y))throw new Error(`Could not append entry:
Key "${Y.identity}" is not allowed to write to the log`);if(!await mo.verify(r,Y))throw new Error(`Could not validate signature for entry "${Y.hash}"`)};await q(B);const Q=(await g()).map(Y=>Y.hash),K=new Set([B.hash]),O=new Set([...B.next,...B.refs]),U=new Set,W=async()=>{const Y=Array.from(O.values()).filter(w).map(y),H=await Promise.all(Y);for(const ne of H){O.delete(ne.hash),await q(ne),K.add(ne.hash);for(const ye of[...ne.next,...ne.refs])!await w(ye)&&!K.has(ye)?O.add(ye):Q.includes(ye)&&U.add(ye)}O.size>0&&await W()};await W();for(const Y of K.values())await d.put(Y,!0);for(const Y of U.values())await h.remove(Y);return await l.put(B.hash,B.bytes),await h.add(B),!0};return m.add(G)},k=async function*(B,G){G=G||(()=>!1),B=B||await g();let q=B.sort(a);const Q={};let K=[];const O={},U=Y=>!(Q[Y]||O[Y]);let W;for(;q.length>0;)if(q=q.sort(a),W=q.pop(),W){const{hash:Y,next:H}=W;if(!Q[Y]){if(yield W,await G(W)===!0)break;Q[Y]=!0,O[Y]=!0,K=[...K,...H].filter(U);const ye=ce=>{if(!Q[ce]&&!O[ce])return O[ce]=!0,y(ce)},ue=await Promise.all(K.map(ye));K=ue.filter(ce=>ce!=null).reduce((ce,Ne)=>Array.from(new Set([...ce,...Ne.next])),[]).filter(U),q=[...ue,...q]}}},x=async function*({amount:B=-1,gt:G,gte:j,lt:q,lte:Q}={}){if(B===0)return;if(typeof Q=="string"&&(Q=[await y(Q)]),typeof q=="string"){const ce=await y(q);q=await Promise.all(ce.next.map(Me=>y(Me)))}if(q!=null&&!Array.isArray(q))throw new Error("lt must be a string or an array of Entries");if(Q!=null&&!Array.isArray(Q))throw new Error("lte must be a string or an array of Entries");const K=(q||Q||await g()).filter(ce=>ce!=null),O=G||j?await y(G||j):null,U=O||B===-1?-1:B;let W=0;const Y=async ce=>(W++,ce?!!(W>=U&&U!==-1||O&&mo.isEqual(ce,O)):!1),H=O&&B!==-1&&!q&&!Q,ne=H?new J6(B+2):null;let ye=0;const ue=k(K,Y);for await(const ce of ue){const Ne=q&&mo.isEqual(ce,K),Me=G&&mo.isEqual(ce,O);Ne||Me||(H?ne.set(ye++,ce.hash):yield ce)}if(H){const ce=ne.keys.length,Ne=ce>B?ce-B:0,Me=ne.keys.slice(Ne,ce);for(const Xe of Me){const tt=ne.get(Xe);yield await y(tt)}}},I=async()=>{await d.clear(),await h.clear(),await l.clear()},T=async()=>{await d.close(),await h.close(),await l.close()},L=B=>B&&B.id!==void 0&&B.clock!==void 0&&B.heads!==void 0&&B.values!==void 0&&B.access!==void 0&&B.identity!==void 0&&B.storage!==void 0,z=async(B,G=0)=>{let j=[];const q=async Q=>j.length>=G&&G!==-1;for await(const{hash:Q}of k(B,q))j.push(Q);return j=j.slice(B.length+1,G),j};return{id:c,clock:f,heads:g,values:v,all:v,get:y,has:w,append:b,join:E,joinEntry:A,traverse:k,iterator:x,clear:I,close:T,access:n,identity:r,storage:l}},_l=async(r,e)=>({put:async(l,d)=>{await r.put(l,d),await e.put(l,d)},get:async l=>{let d=await r.get(l);return d||(d=await e.get(l),d&&await r.put(l,d)),d},del:async l=>{await r.del(l),await e.del(l)},iterator:async function*({amount:l,reverse:d}={}){const h=[],p={amount:l||-1,reverse:d||!1};for(const m of[r,e])for await(const[f,g]of m.iterator(p))h[f]||(h[f]=!0,yield[f,g])},merge:async l=>{await r.merge(l),await e.merge(l),await l.merge(r),await l.merge(e)},clear:async()=>{await r.clear(),await e.clear()},close:async()=>{await r.close(),await e.close()}});function yX(r){return r[Symbol.asyncIterator]!=null}function zo(r){if(yX(r))return(async()=>{for await(const e of r);})();for(const e of r);}const gI=3e4,K3=async({ipfs:r,pin:e,timeout:t}={})=>{if(!r)throw new Error("An instance of ipfs is required.");return{put:async(d,h)=>{const p=fs.parse(d,on),{signal:m}=new Q6.TimeoutController(t||gI);await r.blockstore.put(p,h,{signal:m}),e&&!await r.pins.isPinned(p)&&await zo(r.pins.add(p))},del:async d=>{},get:async d=>{const h=fs.parse(d,on),{signal:p}=new Q6.TimeoutController(t||gI),m=await r.blockstore.get(h,{signal:p});if(m)return m},iterator:async function*(){},merge:async d=>{},clear:async()=>{},close:async()=>{}}};var PL={},Lc={},j3={},DL={};DL.supports=function(...e){const t=e.reduce((n,i)=>Object.assign(n,i),{});return Object.assign(t,{snapshots:t.snapshots||!1,permanence:t.permanence||!1,seek:t.seek||!1,clear:t.clear||!1,getMany:t.getMany||!1,keyIterator:t.keyIterator||!1,valueIterator:t.valueIterator||!1,iteratorNextv:t.iteratorNextv||!1,iteratorAll:t.iteratorAll||!1,status:t.status||!1,createIfMissing:t.createIfMissing||!1,errorIfExists:t.errorIfExists||!1,deferredOpen:t.deferredOpen||!1,promises:t.promises||!1,streams:t.streams||!1,encodings:Object.assign({},t.encodings),events:Object.assign({},t.events),additionalMethods:Object.assign({},t.additionalMethods)})};var $L={},Ys=class extends Error{constructor(e,t){super(e||""),typeof t=="object"&&t!==null&&(t.code&&(this.code=String(t.code)),t.expected&&(this.expected=!0),t.transient&&(this.transient=!0),t.cause&&(this.cause=t.cause)),Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor)}},vu={},H3={},q3={};q3.byteLength=bX;q3.toByteArray=EX;q3.fromByteArray=AX;var Ls=[],pi=[],mX=typeof Uint8Array<"u"?Uint8Array:Array,v5="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(var ku=0,wX=v5.length;ku<wX;++ku)Ls[ku]=v5[ku],pi[v5.charCodeAt(ku)]=ku;pi[45]=62;pi[95]=63;function NL(r){var e=r.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var t=r.indexOf("=");t===-1&&(t=e);var n=t===e?0:4-t%4;return[t,n]}function bX(r){var e=NL(r),t=e[0],n=e[1];return(t+n)*3/4-n}function vX(r,e,t){return(e+t)*3/4-t}function EX(r){var e,t=NL(r),n=t[0],i=t[1],s=new mX(vX(r,n,i)),o=0,a=i>0?n-4:n,c;for(c=0;c<a;c+=4)e=pi[r.charCodeAt(c)]<<18|pi[r.charCodeAt(c+1)]<<12|pi[r.charCodeAt(c+2)]<<6|pi[r.charCodeAt(c+3)],s[o++]=e>>16&255,s[o++]=e>>8&255,s[o++]=e&255;return i===2&&(e=pi[r.charCodeAt(c)]<<2|pi[r.charCodeAt(c+1)]>>4,s[o++]=e&255),i===1&&(e=pi[r.charCodeAt(c)]<<10|pi[r.charCodeAt(c+1)]<<4|pi[r.charCodeAt(c+2)]>>2,s[o++]=e>>8&255,s[o++]=e&255),s}function SX(r){return Ls[r>>18&63]+Ls[r>>12&63]+Ls[r>>6&63]+Ls[r&63]}function xX(r,e,t){for(var n,i=[],s=e;s<t;s+=3)n=(r[s]<<16&16711680)+(r[s+1]<<8&65280)+(r[s+2]&255),i.push(SX(n));return i.join("")}function AX(r){for(var e,t=r.length,n=t%3,i=[],s=16383,o=0,a=t-n;o<a;o+=s)i.push(xX(r,o,o+s>a?a:o+s));return n===1?(e=r[t-1],i.push(Ls[e>>2]+Ls[e<<4&63]+"==")):n===2&&(e=(r[t-2]<<8)+r[t-1],i.push(Ls[e>>10]+Ls[e>>4&63]+Ls[e<<2&63]+"=")),i.join("")}var FE={};/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */FE.read=function(r,e,t,n,i){var s,o,a=i*8-n-1,c=(1<<a)-1,l=c>>1,d=-7,h=t?i-1:0,p=t?-1:1,m=r[e+h];for(h+=p,s=m&(1<<-d)-1,m>>=-d,d+=a;d>0;s=s*256+r[e+h],h+=p,d-=8);for(o=s&(1<<-d)-1,s>>=-d,d+=n;d>0;o=o*256+r[e+h],h+=p,d-=8);if(s===0)s=1-l;else{if(s===c)return o?NaN:(m?-1:1)*(1/0);o=o+Math.pow(2,n),s=s-l}return(m?-1:1)*o*Math.pow(2,s-n)};FE.write=function(r,e,t,n,i,s){var o,a,c,l=s*8-i-1,d=(1<<l)-1,h=d>>1,p=i===23?Math.pow(2,-24)-Math.pow(2,-77):0,m=n?0:s-1,f=n?1:-1,g=e<0||e===0&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(a=isNaN(e)?1:0,o=d):(o=Math.floor(Math.log(e)/Math.LN2),e*(c=Math.pow(2,-o))<1&&(o--,c*=2),o+h>=1?e+=p/c:e+=p*Math.pow(2,1-h),e*c>=2&&(o++,c/=2),o+h>=d?(a=0,o=d):o+h>=1?(a=(e*c-1)*Math.pow(2,i),o=o+h):(a=e*Math.pow(2,h-1)*Math.pow(2,i),o=0));i>=8;r[t+m]=a&255,m+=f,a/=256,i-=8);for(o=o<<i|a,l+=i;l>0;r[t+m]=o&255,m+=f,o/=256,l-=8);r[t+m-f]|=g*128};/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */(function(r){const e=q3,t=FE,n=typeof Symbol=="function"&&typeof Symbol.for=="function"?Symbol.for("nodejs.util.inspect.custom"):null;r.Buffer=a,r.SlowBuffer=w,r.INSPECT_MAX_BYTES=50;const i=2147483647;r.kMaxLength=i,a.TYPED_ARRAY_SUPPORT=s(),!a.TYPED_ARRAY_SUPPORT&&typeof console<"u"&&typeof console.error=="function"&&console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support.");function s(){try{const D=new Uint8Array(1),S={foo:function(){return 42}};return Object.setPrototypeOf(S,Uint8Array.prototype),Object.setPrototypeOf(D,S),D.foo()===42}catch{return!1}}Object.defineProperty(a.prototype,"parent",{enumerable:!0,get:function(){if(a.isBuffer(this))return this.buffer}}),Object.defineProperty(a.prototype,"offset",{enumerable:!0,get:function(){if(a.isBuffer(this))return this.byteOffset}});function o(D){if(D>i)throw new RangeError('The value "'+D+'" is invalid for option "size"');const S=new Uint8Array(D);return Object.setPrototypeOf(S,a.prototype),S}function a(D,S,C){if(typeof D=="number"){if(typeof S=="string")throw new TypeError('The "string" argument must be of type string. Received type number');return h(D)}return c(D,S,C)}a.poolSize=8192;function c(D,S,C){if(typeof D=="string")return p(D,S);if(ArrayBuffer.isView(D))return f(D);if(D==null)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof D);if(tn(D,ArrayBuffer)||D&&tn(D.buffer,ArrayBuffer)||typeof SharedArrayBuffer<"u"&&(tn(D,SharedArrayBuffer)||D&&tn(D.buffer,SharedArrayBuffer)))return g(D,S,C);if(typeof D=="number")throw new TypeError('The "value" argument must not be of type number. Received type number');const M=D.valueOf&&D.valueOf();if(M!=null&&M!==D)return a.from(M,S,C);const P=v(D);if(P)return P;if(typeof Symbol<"u"&&Symbol.toPrimitive!=null&&typeof D[Symbol.toPrimitive]=="function")return a.from(D[Symbol.toPrimitive]("string"),S,C);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof D)}a.from=function(D,S,C){return c(D,S,C)},Object.setPrototypeOf(a.prototype,Uint8Array.prototype),Object.setPrototypeOf(a,Uint8Array);function l(D){if(typeof D!="number")throw new TypeError('"size" argument must be of type number');if(D<0)throw new RangeError('The value "'+D+'" is invalid for option "size"')}function d(D,S,C){return l(D),D<=0?o(D):S!==void 0?typeof C=="string"?o(D).fill(S,C):o(D).fill(S):o(D)}a.alloc=function(D,S,C){return d(D,S,C)};function h(D){return l(D),o(D<0?0:y(D)|0)}a.allocUnsafe=function(D){return h(D)},a.allocUnsafeSlow=function(D){return h(D)};function p(D,S){if((typeof S!="string"||S==="")&&(S="utf8"),!a.isEncoding(S))throw new TypeError("Unknown encoding: "+S);const C=b(D,S)|0;let M=o(C);const P=M.write(D,S);return P!==C&&(M=M.slice(0,P)),M}function m(D){const S=D.length<0?0:y(D.length)|0,C=o(S);for(let M=0;M<S;M+=1)C[M]=D[M]&255;return C}function f(D){if(tn(D,Uint8Array)){const S=new Uint8Array(D);return g(S.buffer,S.byteOffset,S.byteLength)}return m(D)}function g(D,S,C){if(S<0||D.byteLength<S)throw new RangeError('"offset" is outside of buffer bounds');if(D.byteLength<S+(C||0))throw new RangeError('"length" is outside of buffer bounds');let M;return S===void 0&&C===void 0?M=new Uint8Array(D):C===void 0?M=new Uint8Array(D,S):M=new Uint8Array(D,S,C),Object.setPrototypeOf(M,a.prototype),M}function v(D){if(a.isBuffer(D)){const S=y(D.length)|0,C=o(S);return C.length===0||D.copy(C,0,0,S),C}if(D.length!==void 0)return typeof D.length!="number"||ua(D.length)?o(0):m(D);if(D.type==="Buffer"&&Array.isArray(D.data))return m(D.data)}function y(D){if(D>=i)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+i.toString(16)+" bytes");return D|0}function w(D){return+D!=D&&(D=0),a.alloc(+D)}a.isBuffer=function(S){return S!=null&&S._isBuffer===!0&&S!==a.prototype},a.compare=function(S,C){if(tn(S,Uint8Array)&&(S=a.from(S,S.offset,S.byteLength)),tn(C,Uint8Array)&&(C=a.from(C,C.offset,C.byteLength)),!a.isBuffer(S)||!a.isBuffer(C))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(S===C)return 0;let M=S.length,P=C.length;for(let N=0,R=Math.min(M,P);N<R;++N)if(S[N]!==C[N]){M=S[N],P=C[N];break}return M<P?-1:P<M?1:0},a.isEncoding=function(S){switch(String(S).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},a.concat=function(S,C){if(!Array.isArray(S))throw new TypeError('"list" argument must be an Array of Buffers');if(S.length===0)return a.alloc(0);let M;if(C===void 0)for(C=0,M=0;M<S.length;++M)C+=S[M].length;const P=a.allocUnsafe(C);let N=0;for(M=0;M<S.length;++M){let R=S[M];if(tn(R,Uint8Array))N+R.length>P.length?(a.isBuffer(R)||(R=a.from(R)),R.copy(P,N)):Uint8Array.prototype.set.call(P,R,N);else if(a.isBuffer(R))R.copy(P,N);else throw new TypeError('"list" argument must be an Array of Buffers');N+=R.length}return P};function b(D,S){if(a.isBuffer(D))return D.length;if(ArrayBuffer.isView(D)||tn(D,ArrayBuffer))return D.byteLength;if(typeof D!="string")throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof D);const C=D.length,M=arguments.length>2&&arguments[2]===!0;if(!M&&C===0)return 0;let P=!1;for(;;)switch(S){case"ascii":case"latin1":case"binary":return C;case"utf8":case"utf-8":return ws(D).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return C*2;case"hex":return C>>>1;case"base64":return bs(D).length;default:if(P)return M?-1:ws(D).length;S=(""+S).toLowerCase(),P=!0}}a.byteLength=b;function E(D,S,C){let M=!1;if((S===void 0||S<0)&&(S=0),S>this.length||((C===void 0||C>this.length)&&(C=this.length),C<=0)||(C>>>=0,S>>>=0,C<=S))return"";for(D||(D="utf8");;)switch(D){case"hex":return U(this,S,C);case"utf8":case"utf-8":return j(this,S,C);case"ascii":return K(this,S,C);case"latin1":case"binary":return O(this,S,C);case"base64":return G(this,S,C);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return W(this,S,C);default:if(M)throw new TypeError("Unknown encoding: "+D);D=(D+"").toLowerCase(),M=!0}}a.prototype._isBuffer=!0;function A(D,S,C){const M=D[S];D[S]=D[C],D[C]=M}a.prototype.swap16=function(){const S=this.length;if(S%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let C=0;C<S;C+=2)A(this,C,C+1);return this},a.prototype.swap32=function(){const S=this.length;if(S%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let C=0;C<S;C+=4)A(this,C,C+3),A(this,C+1,C+2);return this},a.prototype.swap64=function(){const S=this.length;if(S%8!==0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let C=0;C<S;C+=8)A(this,C,C+7),A(this,C+1,C+6),A(this,C+2,C+5),A(this,C+3,C+4);return this},a.prototype.toString=function(){const S=this.length;return S===0?"":arguments.length===0?j(this,0,S):E.apply(this,arguments)},a.prototype.toLocaleString=a.prototype.toString,a.prototype.equals=function(S){if(!a.isBuffer(S))throw new TypeError("Argument must be a Buffer");return this===S?!0:a.compare(this,S)===0},a.prototype.inspect=function(){let S="";const C=r.INSPECT_MAX_BYTES;return S=this.toString("hex",0,C).replace(/(.{2})/g,"$1 ").trim(),this.length>C&&(S+=" ... "),"<Buffer "+S+">"},n&&(a.prototype[n]=a.prototype.inspect),a.prototype.compare=function(S,C,M,P,N){if(tn(S,Uint8Array)&&(S=a.from(S,S.offset,S.byteLength)),!a.isBuffer(S))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof S);if(C===void 0&&(C=0),M===void 0&&(M=S?S.length:0),P===void 0&&(P=0),N===void 0&&(N=this.length),C<0||M>S.length||P<0||N>this.length)throw new RangeError("out of range index");if(P>=N&&C>=M)return 0;if(P>=N)return-1;if(C>=M)return 1;if(C>>>=0,M>>>=0,P>>>=0,N>>>=0,this===S)return 0;let R=N-P,J=M-C;const he=Math.min(R,J),Oe=this.slice(P,N),Fe=S.slice(C,M);for(let Ee=0;Ee<he;++Ee)if(Oe[Ee]!==Fe[Ee]){R=Oe[Ee],J=Fe[Ee];break}return R<J?-1:J<R?1:0};function k(D,S,C,M,P){if(D.length===0)return-1;if(typeof C=="string"?(M=C,C=0):C>2147483647?C=2147483647:C<-2147483648&&(C=-2147483648),C=+C,ua(C)&&(C=P?0:D.length-1),C<0&&(C=D.length+C),C>=D.length){if(P)return-1;C=D.length-1}else if(C<0)if(P)C=0;else return-1;if(typeof S=="string"&&(S=a.from(S,M)),a.isBuffer(S))return S.length===0?-1:x(D,S,C,M,P);if(typeof S=="number")return S=S&255,typeof Uint8Array.prototype.indexOf=="function"?P?Uint8Array.prototype.indexOf.call(D,S,C):Uint8Array.prototype.lastIndexOf.call(D,S,C):x(D,[S],C,M,P);throw new TypeError("val must be string, number or Buffer")}function x(D,S,C,M,P){let N=1,R=D.length,J=S.length;if(M!==void 0&&(M=String(M).toLowerCase(),M==="ucs2"||M==="ucs-2"||M==="utf16le"||M==="utf-16le")){if(D.length<2||S.length<2)return-1;N=2,R/=2,J/=2,C/=2}function he(Fe,Ee){return N===1?Fe[Ee]:Fe.readUInt16BE(Ee*N)}let Oe;if(P){let Fe=-1;for(Oe=C;Oe<R;Oe++)if(he(D,Oe)===he(S,Fe===-1?0:Oe-Fe)){if(Fe===-1&&(Fe=Oe),Oe-Fe+1===J)return Fe*N}else Fe!==-1&&(Oe-=Oe-Fe),Fe=-1}else for(C+J>R&&(C=R-J),Oe=C;Oe>=0;Oe--){let Fe=!0;for(let Ee=0;Ee<J;Ee++)if(he(D,Oe+Ee)!==he(S,Ee)){Fe=!1;break}if(Fe)return Oe}return-1}a.prototype.includes=function(S,C,M){return this.indexOf(S,C,M)!==-1},a.prototype.indexOf=function(S,C,M){return k(this,S,C,M,!0)},a.prototype.lastIndexOf=function(S,C,M){return k(this,S,C,M,!1)};function I(D,S,C,M){C=Number(C)||0;const P=D.length-C;M?(M=Number(M),M>P&&(M=P)):M=P;const N=S.length;M>N/2&&(M=N/2);let R;for(R=0;R<M;++R){const J=parseInt(S.substr(R*2,2),16);if(ua(J))return R;D[C+R]=J}return R}function T(D,S,C,M){return zi(ws(S,D.length-C),D,C,M)}function L(D,S,C,M){return zi(fe(S),D,C,M)}function z(D,S,C,M){return zi(bs(S),D,C,M)}function B(D,S,C,M){return zi(Fi(S,D.length-C),D,C,M)}a.prototype.write=function(S,C,M,P){if(C===void 0)P="utf8",M=this.length,C=0;else if(M===void 0&&typeof C=="string")P=C,M=this.length,C=0;else if(isFinite(C))C=C>>>0,isFinite(M)?(M=M>>>0,P===void 0&&(P="utf8")):(P=M,M=void 0);else throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");const N=this.length-C;if((M===void 0||M>N)&&(M=N),S.length>0&&(M<0||C<0)||C>this.length)throw new RangeError("Attempt to write outside buffer bounds");P||(P="utf8");let R=!1;for(;;)switch(P){case"hex":return I(this,S,C,M);case"utf8":case"utf-8":return T(this,S,C,M);case"ascii":case"latin1":case"binary":return L(this,S,C,M);case"base64":return z(this,S,C,M);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return B(this,S,C,M);default:if(R)throw new TypeError("Unknown encoding: "+P);P=(""+P).toLowerCase(),R=!0}},a.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function G(D,S,C){return S===0&&C===D.length?e.fromByteArray(D):e.fromByteArray(D.slice(S,C))}function j(D,S,C){C=Math.min(D.length,C);const M=[];let P=S;for(;P<C;){const N=D[P];let R=null,J=N>239?4:N>223?3:N>191?2:1;if(P+J<=C){let he,Oe,Fe,Ee;switch(J){case 1:N<128&&(R=N);break;case 2:he=D[P+1],(he&192)===128&&(Ee=(N&31)<<6|he&63,Ee>127&&(R=Ee));break;case 3:he=D[P+1],Oe=D[P+2],(he&192)===128&&(Oe&192)===128&&(Ee=(N&15)<<12|(he&63)<<6|Oe&63,Ee>2047&&(Ee<55296||Ee>57343)&&(R=Ee));break;case 4:he=D[P+1],Oe=D[P+2],Fe=D[P+3],(he&192)===128&&(Oe&192)===128&&(Fe&192)===128&&(Ee=(N&15)<<18|(he&63)<<12|(Oe&63)<<6|Fe&63,Ee>65535&&Ee<1114112&&(R=Ee))}}R===null?(R=65533,J=1):R>65535&&(R-=65536,M.push(R>>>10&1023|55296),R=56320|R&1023),M.push(R),P+=J}return Q(M)}const q=4096;function Q(D){const S=D.length;if(S<=q)return String.fromCharCode.apply(String,D);let C="",M=0;for(;M<S;)C+=String.fromCharCode.apply(String,D.slice(M,M+=q));return C}function K(D,S,C){let M="";C=Math.min(D.length,C);for(let P=S;P<C;++P)M+=String.fromCharCode(D[P]&127);return M}function O(D,S,C){let M="";C=Math.min(D.length,C);for(let P=S;P<C;++P)M+=String.fromCharCode(D[P]);return M}function U(D,S,C){const M=D.length;(!S||S<0)&&(S=0),(!C||C<0||C>M)&&(C=M);let P="";for(let N=S;N<C;++N)P+=z4[D[N]];return P}function W(D,S,C){const M=D.slice(S,C);let P="";for(let N=0;N<M.length-1;N+=2)P+=String.fromCharCode(M[N]+M[N+1]*256);return P}a.prototype.slice=function(S,C){const M=this.length;S=~~S,C=C===void 0?M:~~C,S<0?(S+=M,S<0&&(S=0)):S>M&&(S=M),C<0?(C+=M,C<0&&(C=0)):C>M&&(C=M),C<S&&(C=S);const P=this.subarray(S,C);return Object.setPrototypeOf(P,a.prototype),P};function Y(D,S,C){if(D%1!==0||D<0)throw new RangeError("offset is not uint");if(D+S>C)throw new RangeError("Trying to access beyond buffer length")}a.prototype.readUintLE=a.prototype.readUIntLE=function(S,C,M){S=S>>>0,C=C>>>0,M||Y(S,C,this.length);let P=this[S],N=1,R=0;for(;++R<C&&(N*=256);)P+=this[S+R]*N;return P},a.prototype.readUintBE=a.prototype.readUIntBE=function(S,C,M){S=S>>>0,C=C>>>0,M||Y(S,C,this.length);let P=this[S+--C],N=1;for(;C>0&&(N*=256);)P+=this[S+--C]*N;return P},a.prototype.readUint8=a.prototype.readUInt8=function(S,C){return S=S>>>0,C||Y(S,1,this.length),this[S]},a.prototype.readUint16LE=a.prototype.readUInt16LE=function(S,C){return S=S>>>0,C||Y(S,2,this.length),this[S]|this[S+1]<<8},a.prototype.readUint16BE=a.prototype.readUInt16BE=function(S,C){return S=S>>>0,C||Y(S,2,this.length),this[S]<<8|this[S+1]},a.prototype.readUint32LE=a.prototype.readUInt32LE=function(S,C){return S=S>>>0,C||Y(S,4,this.length),(this[S]|this[S+1]<<8|this[S+2]<<16)+this[S+3]*16777216},a.prototype.readUint32BE=a.prototype.readUInt32BE=function(S,C){return S=S>>>0,C||Y(S,4,this.length),this[S]*16777216+(this[S+1]<<16|this[S+2]<<8|this[S+3])},a.prototype.readBigUInt64LE=vs(function(S){S=S>>>0,kt(S,"offset");const C=this[S],M=this[S+7];(C===void 0||M===void 0)&&Qt(S,this.length-8);const P=C+this[++S]*2**8+this[++S]*2**16+this[++S]*2**24,N=this[++S]+this[++S]*2**8+this[++S]*2**16+M*2**24;return BigInt(P)+(BigInt(N)<<BigInt(32))}),a.prototype.readBigUInt64BE=vs(function(S){S=S>>>0,kt(S,"offset");const C=this[S],M=this[S+7];(C===void 0||M===void 0)&&Qt(S,this.length-8);const P=C*2**24+this[++S]*2**16+this[++S]*2**8+this[++S],N=this[++S]*2**24+this[++S]*2**16+this[++S]*2**8+M;return(BigInt(P)<<BigInt(32))+BigInt(N)}),a.prototype.readIntLE=function(S,C,M){S=S>>>0,C=C>>>0,M||Y(S,C,this.length);let P=this[S],N=1,R=0;for(;++R<C&&(N*=256);)P+=this[S+R]*N;return N*=128,P>=N&&(P-=Math.pow(2,8*C)),P},a.prototype.readIntBE=function(S,C,M){S=S>>>0,C=C>>>0,M||Y(S,C,this.length);let P=C,N=1,R=this[S+--P];for(;P>0&&(N*=256);)R+=this[S+--P]*N;return N*=128,R>=N&&(R-=Math.pow(2,8*C)),R},a.prototype.readInt8=function(S,C){return S=S>>>0,C||Y(S,1,this.length),this[S]&128?(255-this[S]+1)*-1:this[S]},a.prototype.readInt16LE=function(S,C){S=S>>>0,C||Y(S,2,this.length);const M=this[S]|this[S+1]<<8;return M&32768?M|4294901760:M},a.prototype.readInt16BE=function(S,C){S=S>>>0,C||Y(S,2,this.length);const M=this[S+1]|this[S]<<8;return M&32768?M|4294901760:M},a.prototype.readInt32LE=function(S,C){return S=S>>>0,C||Y(S,4,this.length),this[S]|this[S+1]<<8|this[S+2]<<16|this[S+3]<<24},a.prototype.readInt32BE=function(S,C){return S=S>>>0,C||Y(S,4,this.length),this[S]<<24|this[S+1]<<16|this[S+2]<<8|this[S+3]},a.prototype.readBigInt64LE=vs(function(S){S=S>>>0,kt(S,"offset");const C=this[S],M=this[S+7];(C===void 0||M===void 0)&&Qt(S,this.length-8);const P=this[S+4]+this[S+5]*2**8+this[S+6]*2**16+(M<<24);return(BigInt(P)<<BigInt(32))+BigInt(C+this[++S]*2**8+this[++S]*2**16+this[++S]*2**24)}),a.prototype.readBigInt64BE=vs(function(S){S=S>>>0,kt(S,"offset");const C=this[S],M=this[S+7];(C===void 0||M===void 0)&&Qt(S,this.length-8);const P=(C<<24)+this[++S]*2**16+this[++S]*2**8+this[++S];return(BigInt(P)<<BigInt(32))+BigInt(this[++S]*2**24+this[++S]*2**16+this[++S]*2**8+M)}),a.prototype.readFloatLE=function(S,C){return S=S>>>0,C||Y(S,4,this.length),t.read(this,S,!0,23,4)},a.prototype.readFloatBE=function(S,C){return S=S>>>0,C||Y(S,4,this.length),t.read(this,S,!1,23,4)},a.prototype.readDoubleLE=function(S,C){return S=S>>>0,C||Y(S,8,this.length),t.read(this,S,!0,52,8)},a.prototype.readDoubleBE=function(S,C){return S=S>>>0,C||Y(S,8,this.length),t.read(this,S,!1,52,8)};function H(D,S,C,M,P,N){if(!a.isBuffer(D))throw new TypeError('"buffer" argument must be a Buffer instance');if(S>P||S<N)throw new RangeError('"value" argument is out of bounds');if(C+M>D.length)throw new RangeError("Index out of range")}a.prototype.writeUintLE=a.prototype.writeUIntLE=function(S,C,M,P){if(S=+S,C=C>>>0,M=M>>>0,!P){const J=Math.pow(2,8*M)-1;H(this,S,C,M,J,0)}let N=1,R=0;for(this[C]=S&255;++R<M&&(N*=256);)this[C+R]=S/N&255;return C+M},a.prototype.writeUintBE=a.prototype.writeUIntBE=function(S,C,M,P){if(S=+S,C=C>>>0,M=M>>>0,!P){const J=Math.pow(2,8*M)-1;H(this,S,C,M,J,0)}let N=M-1,R=1;for(this[C+N]=S&255;--N>=0&&(R*=256);)this[C+N]=S/R&255;return C+M},a.prototype.writeUint8=a.prototype.writeUInt8=function(S,C,M){return S=+S,C=C>>>0,M||H(this,S,C,1,255,0),this[C]=S&255,C+1},a.prototype.writeUint16LE=a.prototype.writeUInt16LE=function(S,C,M){return S=+S,C=C>>>0,M||H(this,S,C,2,65535,0),this[C]=S&255,this[C+1]=S>>>8,C+2},a.prototype.writeUint16BE=a.prototype.writeUInt16BE=function(S,C,M){return S=+S,C=C>>>0,M||H(this,S,C,2,65535,0),this[C]=S>>>8,this[C+1]=S&255,C+2},a.prototype.writeUint32LE=a.prototype.writeUInt32LE=function(S,C,M){return S=+S,C=C>>>0,M||H(this,S,C,4,4294967295,0),this[C+3]=S>>>24,this[C+2]=S>>>16,this[C+1]=S>>>8,this[C]=S&255,C+4},a.prototype.writeUint32BE=a.prototype.writeUInt32BE=function(S,C,M){return S=+S,C=C>>>0,M||H(this,S,C,4,4294967295,0),this[C]=S>>>24,this[C+1]=S>>>16,this[C+2]=S>>>8,this[C+3]=S&255,C+4};function ne(D,S,C,M,P){bt(S,M,P,D,C,7);let N=Number(S&BigInt(4294967295));D[C++]=N,N=N>>8,D[C++]=N,N=N>>8,D[C++]=N,N=N>>8,D[C++]=N;let R=Number(S>>BigInt(32)&BigInt(4294967295));return D[C++]=R,R=R>>8,D[C++]=R,R=R>>8,D[C++]=R,R=R>>8,D[C++]=R,C}function ye(D,S,C,M,P){bt(S,M,P,D,C,7);let N=Number(S&BigInt(4294967295));D[C+7]=N,N=N>>8,D[C+6]=N,N=N>>8,D[C+5]=N,N=N>>8,D[C+4]=N;let R=Number(S>>BigInt(32)&BigInt(4294967295));return D[C+3]=R,R=R>>8,D[C+2]=R,R=R>>8,D[C+1]=R,R=R>>8,D[C]=R,C+8}a.prototype.writeBigUInt64LE=vs(function(S,C=0){return ne(this,S,C,BigInt(0),BigInt("0xffffffffffffffff"))}),a.prototype.writeBigUInt64BE=vs(function(S,C=0){return ye(this,S,C,BigInt(0),BigInt("0xffffffffffffffff"))}),a.prototype.writeIntLE=function(S,C,M,P){if(S=+S,C=C>>>0,!P){const he=Math.pow(2,8*M-1);H(this,S,C,M,he-1,-he)}let N=0,R=1,J=0;for(this[C]=S&255;++N<M&&(R*=256);)S<0&&J===0&&this[C+N-1]!==0&&(J=1),this[C+N]=(S/R>>0)-J&255;return C+M},a.prototype.writeIntBE=function(S,C,M,P){if(S=+S,C=C>>>0,!P){const he=Math.pow(2,8*M-1);H(this,S,C,M,he-1,-he)}let N=M-1,R=1,J=0;for(this[C+N]=S&255;--N>=0&&(R*=256);)S<0&&J===0&&this[C+N+1]!==0&&(J=1),this[C+N]=(S/R>>0)-J&255;return C+M},a.prototype.writeInt8=function(S,C,M){return S=+S,C=C>>>0,M||H(this,S,C,1,127,-128),S<0&&(S=255+S+1),this[C]=S&255,C+1},a.prototype.writeInt16LE=function(S,C,M){return S=+S,C=C>>>0,M||H(this,S,C,2,32767,-32768),this[C]=S&255,this[C+1]=S>>>8,C+2},a.prototype.writeInt16BE=function(S,C,M){return S=+S,C=C>>>0,M||H(this,S,C,2,32767,-32768),this[C]=S>>>8,this[C+1]=S&255,C+2},a.prototype.writeInt32LE=function(S,C,M){return S=+S,C=C>>>0,M||H(this,S,C,4,2147483647,-2147483648),this[C]=S&255,this[C+1]=S>>>8,this[C+2]=S>>>16,this[C+3]=S>>>24,C+4},a.prototype.writeInt32BE=function(S,C,M){return S=+S,C=C>>>0,M||H(this,S,C,4,2147483647,-2147483648),S<0&&(S=4294967295+S+1),this[C]=S>>>24,this[C+1]=S>>>16,this[C+2]=S>>>8,this[C+3]=S&255,C+4},a.prototype.writeBigInt64LE=vs(function(S,C=0){return ne(this,S,C,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))}),a.prototype.writeBigInt64BE=vs(function(S,C=0){return ye(this,S,C,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))});function ue(D,S,C,M,P,N){if(C+M>D.length)throw new RangeError("Index out of range");if(C<0)throw new RangeError("Index out of range")}function ce(D,S,C,M,P){return S=+S,C=C>>>0,P||ue(D,S,C,4),t.write(D,S,C,M,23,4),C+4}a.prototype.writeFloatLE=function(S,C,M){return ce(this,S,C,!0,M)},a.prototype.writeFloatBE=function(S,C,M){return ce(this,S,C,!1,M)};function Ne(D,S,C,M,P){return S=+S,C=C>>>0,P||ue(D,S,C,8),t.write(D,S,C,M,52,8),C+8}a.prototype.writeDoubleLE=function(S,C,M){return Ne(this,S,C,!0,M)},a.prototype.writeDoubleBE=function(S,C,M){return Ne(this,S,C,!1,M)},a.prototype.copy=function(S,C,M,P){if(!a.isBuffer(S))throw new TypeError("argument should be a Buffer");if(M||(M=0),!P&&P!==0&&(P=this.length),C>=S.length&&(C=S.length),C||(C=0),P>0&&P<M&&(P=M),P===M||S.length===0||this.length===0)return 0;if(C<0)throw new RangeError("targetStart out of bounds");if(M<0||M>=this.length)throw new RangeError("Index out of range");if(P<0)throw new RangeError("sourceEnd out of bounds");P>this.length&&(P=this.length),S.length-C<P-M&&(P=S.length-C+M);const N=P-M;return this===S&&typeof Uint8Array.prototype.copyWithin=="function"?this.copyWithin(C,M,P):Uint8Array.prototype.set.call(S,this.subarray(M,P),C),N},a.prototype.fill=function(S,C,M,P){if(typeof S=="string"){if(typeof C=="string"?(P=C,C=0,M=this.length):typeof M=="string"&&(P=M,M=this.length),P!==void 0&&typeof P!="string")throw new TypeError("encoding must be a string");if(typeof P=="string"&&!a.isEncoding(P))throw new TypeError("Unknown encoding: "+P);if(S.length===1){const R=S.charCodeAt(0);(P==="utf8"&&R<128||P==="latin1")&&(S=R)}}else typeof S=="number"?S=S&255:typeof S=="boolean"&&(S=Number(S));if(C<0||this.length<C||this.length<M)throw new RangeError("Out of range index");if(M<=C)return this;C=C>>>0,M=M===void 0?this.length:M>>>0,S||(S=0);let N;if(typeof S=="number")for(N=C;N<M;++N)this[N]=S;else{const R=a.isBuffer(S)?S:a.from(S,P),J=R.length;if(J===0)throw new TypeError('The value "'+S+'" is invalid for argument "value"');for(N=0;N<M-C;++N)this[N+C]=R[N%J]}return this};const Me={};function Xe(D,S,C){Me[D]=class extends C{constructor(){super(),Object.defineProperty(this,"message",{value:S.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${D}]`,this.stack,delete this.name}get code(){return D}set code(P){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:P,writable:!0})}toString(){return`${this.name} [${D}]: ${this.message}`}}}Xe("ERR_BUFFER_OUT_OF_BOUNDS",function(D){return D?`${D} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"},RangeError),Xe("ERR_INVALID_ARG_TYPE",function(D,S){return`The "${D}" argument must be of type number. Received type ${typeof S}`},TypeError),Xe("ERR_OUT_OF_RANGE",function(D,S,C){let M=`The value of "${D}" is out of range.`,P=C;return Number.isInteger(C)&&Math.abs(C)>2**32?P=tt(String(C)):typeof C=="bigint"&&(P=String(C),(C>BigInt(2)**BigInt(32)||C<-(BigInt(2)**BigInt(32)))&&(P=tt(P)),P+="n"),M+=` It must be ${S}. Received ${P}`,M},RangeError);function tt(D){let S="",C=D.length;const M=D[0]==="-"?1:0;for(;C>=M+4;C-=3)S=`_${D.slice(C-3,C)}${S}`;return`${D.slice(0,C)}${S}`}function wt(D,S,C){kt(S,"offset"),(D[S]===void 0||D[S+C]===void 0)&&Qt(S,D.length-(C+1))}function bt(D,S,C,M,P,N){if(D>C||D<S){const R=typeof S=="bigint"?"n":"";let J;throw S===0||S===BigInt(0)?J=`>= 0${R} and < 2${R} ** ${(N+1)*8}${R}`:J=`>= -(2${R} ** ${(N+1)*8-1}${R}) and < 2 ** ${(N+1)*8-1}${R}`,new Me.ERR_OUT_OF_RANGE("value",J,D)}wt(M,P,N)}function kt(D,S){if(typeof D!="number")throw new Me.ERR_INVALID_ARG_TYPE(S,"number",D)}function Qt(D,S,C){throw Math.floor(D)!==D?(kt(D,C),new Me.ERR_OUT_OF_RANGE("offset","an integer",D)):S<0?new Me.ERR_BUFFER_OUT_OF_BOUNDS:new Me.ERR_OUT_OF_RANGE("offset",`>= 0 and <= ${S}`,D)}const pr=/[^+/0-9A-Za-z-_]/g;function to(D){if(D=D.split("=")[0],D=D.trim().replace(pr,""),D.length<2)return"";for(;D.length%4!==0;)D=D+"=";return D}function ws(D,S){S=S||1/0;let C;const M=D.length;let P=null;const N=[];for(let R=0;R<M;++R){if(C=D.charCodeAt(R),C>55295&&C<57344){if(!P){if(C>56319){(S-=3)>-1&&N.push(239,191,189);continue}else if(R+1===M){(S-=3)>-1&&N.push(239,191,189);continue}P=C;continue}if(C<56320){(S-=3)>-1&&N.push(239,191,189),P=C;continue}C=(P-55296<<10|C-56320)+65536}else P&&(S-=3)>-1&&N.push(239,191,189);if(P=null,C<128){if((S-=1)<0)break;N.push(C)}else if(C<2048){if((S-=2)<0)break;N.push(C>>6|192,C&63|128)}else if(C<65536){if((S-=3)<0)break;N.push(C>>12|224,C>>6&63|128,C&63|128)}else if(C<1114112){if((S-=4)<0)break;N.push(C>>18|240,C>>12&63|128,C>>6&63|128,C&63|128)}else throw new Error("Invalid code point")}return N}function fe(D){const S=[];for(let C=0;C<D.length;++C)S.push(D.charCodeAt(C)&255);return S}function Fi(D,S){let C,M,P;const N=[];for(let R=0;R<D.length&&!((S-=2)<0);++R)C=D.charCodeAt(R),M=C>>8,P=C%256,N.push(P),N.push(M);return N}function bs(D){return e.toByteArray(to(D))}function zi(D,S,C,M){let P;for(P=0;P<M&&!(P+C>=S.length||P>=D.length);++P)S[P+C]=D[P];return P}function tn(D,S){return D instanceof S||D!=null&&D.constructor!=null&&D.constructor.name!=null&&D.constructor.name===S.name}function ua(D){return D!==D}const z4=function(){const D="0123456789abcdef",S=new Array(256);for(let C=0;C<16;++C){const M=C*16;for(let P=0;P<16;++P)S[M+P]=D[C]+D[P]}return S}();function vs(D){return typeof BigInt>"u"?Hc:D}function Hc(){throw new Error("BigInt not supported")}})(H3);let E5=null;var ML=function(){return E5===null&&(E5={textEncoder:new TextEncoder,textDecoder:new TextDecoder}),E5},Mp={},zE={};const S5=Ys,CX=new Set(["buffer","view","utf8"]);let IX=class{constructor(e){if(this.encode=e.encode||this.encode,this.decode=e.decode||this.decode,this.name=e.name||this.name,this.format=e.format||this.format,typeof this.encode!="function")throw new TypeError("The 'encode' property must be a function");if(typeof this.decode!="function")throw new TypeError("The 'decode' property must be a function");if(this.encode=this.encode.bind(this),this.decode=this.decode.bind(this),typeof this.name!="string"||this.name==="")throw new TypeError("The 'name' property must be a string");if(typeof this.format!="string"||!CX.has(this.format))throw new TypeError("The 'format' property must be one of 'buffer', 'view', 'utf8'");e.createViewTranscoder&&(this.createViewTranscoder=e.createViewTranscoder),e.createBufferTranscoder&&(this.createBufferTranscoder=e.createBufferTranscoder),e.createUTF8Transcoder&&(this.createUTF8Transcoder=e.createUTF8Transcoder)}get commonName(){return this.name.split("+")[0]}createBufferTranscoder(){throw new S5(`Encoding '${this.name}' cannot be transcoded to 'buffer'`,{code:"LEVEL_ENCODING_NOT_SUPPORTED"})}createViewTranscoder(){throw new S5(`Encoding '${this.name}' cannot be transcoded to 'view'`,{code:"LEVEL_ENCODING_NOT_SUPPORTED"})}createUTF8Transcoder(){throw new S5(`Encoding '${this.name}' cannot be transcoded to 'utf8'`,{code:"LEVEL_ENCODING_NOT_SUPPORTED"})}};zE.Encoding=IX;const{Buffer:VE}=H3||{},{Encoding:KE}=zE,kX=ML;let jE=class extends KE{constructor(e){super({...e,format:"buffer"})}createViewTranscoder(){return new HE({encode:this.encode,decode:e=>this.decode(VE.from(e.buffer,e.byteOffset,e.byteLength)),name:`${this.name}+view`})}createBufferTranscoder(){return this}},HE=class extends KE{constructor(e){super({...e,format:"view"})}createBufferTranscoder(){return new jE({encode:e=>{const t=this.encode(e);return VE.from(t.buffer,t.byteOffset,t.byteLength)},decode:this.decode,name:`${this.name}+buffer`})}createViewTranscoder(){return this}},_X=class extends KE{constructor(e){super({...e,format:"utf8"})}createBufferTranscoder(){return new jE({encode:e=>VE.from(this.encode(e),"utf8"),decode:e=>this.decode(e.toString("utf8")),name:`${this.name}+buffer`})}createViewTranscoder(){const{textEncoder:e,textDecoder:t}=kX();return new HE({encode:n=>e.encode(this.encode(n)),decode:n=>this.decode(t.decode(n)),name:`${this.name}+view`})}createUTF8Transcoder(){return this}};Mp.BufferFormat=jE;Mp.ViewFormat=HE;Mp.UTF8Format=_X;const{Buffer:Xr}=H3||{Buffer:{isBuffer:()=>!1}},{textEncoder:OL,textDecoder:yI}=ML(),{BufferFormat:Op,ViewFormat:qE,UTF8Format:RL}=Mp,X2=r=>r;vu.utf8=new RL({encode:function(r){return Xr.isBuffer(r)?r.toString("utf8"):ArrayBuffer.isView(r)?yI.decode(r):String(r)},decode:X2,name:"utf8",createViewTranscoder(){return new qE({encode:function(r){return ArrayBuffer.isView(r)?r:OL.encode(r)},decode:function(r){return yI.decode(r)},name:`${this.name}+view`})},createBufferTranscoder(){return new Op({encode:function(r){return Xr.isBuffer(r)?r:ArrayBuffer.isView(r)?Xr.from(r.buffer,r.byteOffset,r.byteLength):Xr.from(String(r),"utf8")},decode:function(r){return r.toString("utf8")},name:`${this.name}+buffer`})}});vu.json=new RL({encode:JSON.stringify,decode:JSON.parse,name:"json"});vu.buffer=new Op({encode:function(r){return Xr.isBuffer(r)?r:ArrayBuffer.isView(r)?Xr.from(r.buffer,r.byteOffset,r.byteLength):Xr.from(String(r),"utf8")},decode:X2,name:"buffer",createViewTranscoder(){return new qE({encode:function(r){return ArrayBuffer.isView(r)?r:Xr.from(String(r),"utf8")},decode:function(r){return Xr.from(r.buffer,r.byteOffset,r.byteLength)},name:`${this.name}+view`})}});vu.view=new qE({encode:function(r){return ArrayBuffer.isView(r)?r:OL.encode(r)},decode:X2,name:"view",createBufferTranscoder(){return new Op({encode:function(r){return Xr.isBuffer(r)?r:ArrayBuffer.isView(r)?Xr.from(r.buffer,r.byteOffset,r.byteLength):Xr.from(String(r),"utf8")},decode:X2,name:`${this.name}+buffer`})}});vu.hex=new Op({encode:function(r){return Xr.isBuffer(r)?r:Xr.from(String(r),"hex")},decode:function(r){return r.toString("hex")},name:"hex"});vu.base64=new Op({encode:function(r){return Xr.isBuffer(r)?r:Xr.from(String(r),"base64")},decode:function(r){return r.toString("base64")},name:"base64"});const mI=Ys,Z2=vu,{Encoding:TX}=zE,{BufferFormat:PX,ViewFormat:DX,UTF8Format:$X}=Mp,cf=Symbol("formats"),M0=Symbol("encodings"),NX=new Set(["buffer","view","utf8"]);let MX=class{constructor(e){if(Array.isArray(e)){if(!e.every(t=>NX.has(t)))throw new TypeError("Format must be one of 'buffer', 'view', 'utf8'")}else throw new TypeError("The first argument 'formats' must be an array");this[M0]=new Map,this[cf]=new Set(e);for(const t in Z2)try{this.encoding(t)}catch(n){if(n.code!=="LEVEL_ENCODING_NOT_SUPPORTED")throw n}}encodings(){return Array.from(new Set(this[M0].values()))}encoding(e){let t=this[M0].get(e);if(t===void 0){if(typeof e=="string"&&e!==""){if(t=BX[e],!t)throw new mI(`Encoding '${e}' is not found`,{code:"LEVEL_ENCODING_NOT_FOUND"})}else{if(typeof e!="object"||e===null)throw new TypeError("First argument 'encoding' must be a string or object");t=OX(e)}const{name:n,format:i}=t;if(!this[cf].has(i))if(this[cf].has("view"))t=t.createViewTranscoder();else if(this[cf].has("buffer"))t=t.createBufferTranscoder();else if(this[cf].has("utf8"))t=t.createUTF8Transcoder();else throw new mI(`Encoding '${n}' cannot be transcoded`,{code:"LEVEL_ENCODING_NOT_SUPPORTED"});for(const s of[e,n,t.name,t.commonName])this[M0].set(s,t)}return t}};$L.Transcoder=MX;function OX(r){if(r instanceof TX)return r;const e="type"in r&&typeof r.type=="string"?r.type:void 0,t=r.name||e||`anonymous-${UX++}`;switch(RX(r)){case"view":return new DX({...r,name:t});case"utf8":return new $X({...r,name:t});case"buffer":return new PX({...r,name:t});default:throw new TypeError("Format must be one of 'buffer', 'view', 'utf8'")}}function RX(r){return"format"in r&&r.format!==void 0?r.format:"buffer"in r&&typeof r.buffer=="boolean"?r.buffer?"buffer":"utf8":"code"in r&&Number.isInteger(r.code)?"view":"buffer"}const LX={binary:Z2.buffer,"utf-8":Z2.utf8},BX={...Z2,...LX};let UX=0;var $h={},FX=typeof queueMicrotask=="function"?queueMicrotask:r=>Promise.resolve().then(r),wI=FX;$h.fromCallback=function(r,e){if(r===void 0){var t=new Promise(function(n,i){r=function(s,o){s?i(s):n(o)}});r[e!==void 0?e:"promise"]=t}else if(typeof r!="function")throw new TypeError("Callback must be a function");return r};$h.fromPromise=function(r,e){if(e===void 0)return r;r.then(function(t){wI(()=>e(null,t))}).catch(function(t){wI(()=>e(t))})};var Js={},Rp={};Rp.getCallback=function(r,e){return typeof r=="function"?r:e};Rp.getOptions=function(r,e){return typeof r=="object"&&r!==null?r:e!==void 0?e:{}};const{fromCallback:x5}=$h,Kn=Ys,{getOptions:A5,getCallback:bI}=Rp,qc=Symbol("promise"),_u=Symbol("callback"),xs=Symbol("working"),yl=Symbol("handleOne"),wo=Symbol("handleMany"),C5=Symbol("autoClose"),vc=Symbol("finishWork"),zs=Symbol("returnMany"),fa=Symbol("closing"),lf=Symbol("handleClose"),O0=Symbol("closed"),uf=Symbol("closeCallbacks"),uc=Symbol("keyEncoding"),Kl=Symbol("valueEncoding"),I5=Symbol("abortOnClose"),R0=Symbol("legacy"),k5=Symbol("keys"),_5=Symbol("values"),pa=Symbol("limit"),Ei=Symbol("count"),L0=Object.freeze({}),zX=()=>{};let vI=!1;class WE{constructor(e,t,n){if(typeof e!="object"||e===null){const i=e===null?"null":typeof e;throw new TypeError(`The first argument must be an abstract-level database, received ${i}`)}if(typeof t!="object"||t===null)throw new TypeError("The second argument must be an options object");this[O0]=!1,this[uf]=[],this[xs]=!1,this[fa]=!1,this[C5]=!1,this[_u]=null,this[yl]=this[yl].bind(this),this[wo]=this[wo].bind(this),this[lf]=this[lf].bind(this),this[uc]=t[uc],this[Kl]=t[Kl],this[R0]=n,this[pa]=Number.isInteger(t.limit)&&t.limit>=0?t.limit:1/0,this[Ei]=0,this[I5]=!!t.abortOnClose,this.db=e,this.db.attachResource(this),this.nextTick=e.nextTick}get count(){return this[Ei]}get limit(){return this[pa]}next(e){let t;if(e===void 0)t=new Promise((n,i)=>{e=(s,o,a)=>{s?i(s):this[R0]?o===void 0&&a===void 0?n():n([o,a]):n(o)}});else if(typeof e!="function")throw new TypeError("Callback must be a function");return this[fa]?this.nextTick(e,new Kn("Iterator is not open: cannot call next() after close()",{code:"LEVEL_ITERATOR_NOT_OPEN"})):this[xs]?this.nextTick(e,new Kn("Iterator is busy: cannot call next() until previous call has completed",{code:"LEVEL_ITERATOR_BUSY"})):(this[xs]=!0,this[_u]=e,this[Ei]>=this[pa]?this.nextTick(this[yl],null):this._next(this[yl])),t}_next(e){this.nextTick(e)}nextv(e,t,n){return n=bI(t,n),n=x5(n,qc),t=A5(t,L0),Number.isInteger(e)?(this[fa]?this.nextTick(n,new Kn("Iterator is not open: cannot call nextv() after close()",{code:"LEVEL_ITERATOR_NOT_OPEN"})):this[xs]?this.nextTick(n,new Kn("Iterator is busy: cannot call nextv() until previous call has completed",{code:"LEVEL_ITERATOR_BUSY"})):(e<1&&(e=1),this[pa]<1/0&&(e=Math.min(e,this[pa]-this[Ei])),this[xs]=!0,this[_u]=n,e<=0?this.nextTick(this[wo],null,[]):this._nextv(e,t,this[wo])),n[qc]):(this.nextTick(n,new TypeError("The first argument 'size' must be an integer")),n[qc])}_nextv(e,t,n){const i=[],s=(o,a,c)=>{if(o)return n(o);if(this[R0]?a===void 0&&c===void 0:a===void 0)return n(null,i);i.push(this[R0]?[a,c]:a),i.length===e?n(null,i):this._next(s)};this._next(s)}all(e,t){return t=bI(e,t),t=x5(t,qc),e=A5(e,L0),this[fa]?this.nextTick(t,new Kn("Iterator is not open: cannot call all() after close()",{code:"LEVEL_ITERATOR_NOT_OPEN"})):this[xs]?this.nextTick(t,new Kn("Iterator is busy: cannot call all() until previous call has completed",{code:"LEVEL_ITERATOR_BUSY"})):(this[xs]=!0,this[_u]=t,this[C5]=!0,this[Ei]>=this[pa]?this.nextTick(this[wo],null,[]):this._all(e,this[wo])),t[qc]}_all(e,t){let n=this[Ei];const i=[],s=()=>{const a=this[pa]<1/0?Math.min(1e3,this[pa]-n):1e3;a<=0?this.nextTick(t,null,i):this._nextv(a,L0,o)},o=(a,c)=>{a?t(a):c.length===0?t(null,i):(i.push.apply(i,c),n+=c.length,s())};s()}[vc](){const e=this[_u];return this[I5]&&e===null?zX:(this[xs]=!1,this[_u]=null,this[fa]&&this._close(this[lf]),e)}[zs](e,t,n){this[C5]?this.close(e.bind(null,t,n)):e(t,n)}seek(e,t){if(t=A5(t,L0),!this[fa]){if(this[xs])throw new Kn("Iterator is busy: cannot call seek() until next() has completed",{code:"LEVEL_ITERATOR_BUSY"});{const n=this.db.keyEncoding(t.keyEncoding||this[uc]),i=n.format;t.keyEncoding!==i&&(t={...t,keyEncoding:i});const s=this.db.prefixKey(n.encode(e),i);this._seek(s,t)}}}_seek(e,t){throw new Kn("Iterator does not support seek()",{code:"LEVEL_NOT_SUPPORTED"})}close(e){return e=x5(e,qc),this[O0]?this.nextTick(e):this[fa]?this[uf].push(e):(this[fa]=!0,this[uf].push(e),this[xs]?this[I5]&&this[vc]()(new Kn("Aborted on iterator close()",{code:"LEVEL_ITERATOR_NOT_OPEN"})):this._close(this[lf])),e[qc]}_close(e){this.nextTick(e)}[lf](){this[O0]=!0,this.db.detachResource(this);const e=this[uf];this[uf]=[];for(const t of e)t()}async*[Symbol.asyncIterator](){try{let e;for(;(e=await this.next())!==void 0;)yield e}finally{this[O0]||await this.close()}}}let W3=class extends WE{constructor(e,t){super(e,t,!0),this[k5]=t.keys!==!1,this[_5]=t.values!==!1}[yl](e,t,n){const i=this[vc]();if(e)return i(e);try{t=this[k5]&&t!==void 0?this[uc].decode(t):void 0,n=this[_5]&&n!==void 0?this[Kl].decode(n):void 0}catch(s){return i(new Vd("entry",s))}t===void 0&&n===void 0||this[Ei]++,i(null,t,n)}[wo](e,t){const n=this[vc]();if(e)return this[zs](n,e);try{for(const i of t){const s=i[0],o=i[1];i[0]=this[k5]&&s!==void 0?this[uc].decode(s):void 0,i[1]=this[_5]&&o!==void 0?this[Kl].decode(o):void 0}}catch(i){return this[zs](n,new Vd("entries",i))}this[Ei]+=t.length,this[zs](n,null,t)}end(e){return!vI&&typeof console<"u"&&(vI=!0,console.warn(new Kn("The iterator.end() method was renamed to close() and end() is an alias that will be removed in a future version",{code:"LEVEL_LEGACY"}))),this.close(e)}},VX=class extends WE{constructor(e,t){super(e,t,!1)}[yl](e,t){const n=this[vc]();if(e)return n(e);try{t=t!==void 0?this[uc].decode(t):void 0}catch(i){return n(new Vd("key",i))}t!==void 0&&this[Ei]++,n(null,t)}[wo](e,t){const n=this[vc]();if(e)return this[zs](n,e);try{for(let i=0;i<t.length;i++){const s=t[i];t[i]=s!==void 0?this[uc].decode(s):void 0}}catch(i){return this[zs](n,new Vd("keys",i))}this[Ei]+=t.length,this[zs](n,null,t)}},KX=class extends WE{constructor(e,t){super(e,t,!1)}[yl](e,t){const n=this[vc]();if(e)return n(e);try{t=t!==void 0?this[Kl].decode(t):void 0}catch(i){return n(new Vd("value",i))}t!==void 0&&this[Ei]++,n(null,t)}[wo](e,t){const n=this[vc]();if(e)return this[zs](n,e);try{for(let i=0;i<t.length;i++){const s=t[i];t[i]=s!==void 0?this[Kl].decode(s):void 0}}catch(i){return this[zs](n,new Vd("values",i))}this[Ei]+=t.length,this[zs](n,null,t)}};class Vd extends Kn{constructor(e,t){super(`Iterator could not decode ${e}`,{code:"LEVEL_DECODE_ERROR",cause:t})}}for(const r of["_ended property","_nexting property","_end method"])Object.defineProperty(W3.prototype,r.split(" ")[0],{get(){throw new Kn(`The ${r} has been removed`,{code:"LEVEL_LEGACY"})},set(){throw new Kn(`The ${r} has been removed`,{code:"LEVEL_LEGACY"})}});W3.keyEncoding=uc;W3.valueEncoding=Kl;Js.AbstractIterator=W3;Js.AbstractKeyIterator=VX;Js.AbstractValueIterator=KX;var GE={};const{AbstractKeyIterator:jX,AbstractValueIterator:HX}=Js,ol=Symbol("iterator"),df=Symbol("callback"),Kd=Symbol("handleOne"),Tl=Symbol("handleMany");let cb=class extends jX{constructor(e,t){super(e,t),this[ol]=e.iterator({...t,keys:!0,values:!1}),this[Kd]=this[Kd].bind(this),this[Tl]=this[Tl].bind(this)}},LL=class extends HX{constructor(e,t){super(e,t),this[ol]=e.iterator({...t,keys:!1,values:!0}),this[Kd]=this[Kd].bind(this),this[Tl]=this[Tl].bind(this)}};for(const r of[cb,LL]){const e=r===cb,t=e?n=>n[0]:n=>n[1];r.prototype._next=function(n){this[df]=n,this[ol].next(this[Kd])},r.prototype[Kd]=function(n,i,s){const o=this[df];n?o(n):o(null,e?i:s)},r.prototype._nextv=function(n,i,s){this[df]=s,this[ol].nextv(n,i,this[Tl])},r.prototype._all=function(n,i){this[df]=i,this[ol].all(n,this[Tl])},r.prototype[Tl]=function(n,i){const s=this[df];n?s(n):s(null,i.map(t))},r.prototype._seek=function(n,i){this[ol].seek(n,i)},r.prototype._close=function(n){this[ol].close(n)}}GE.DefaultKeyIterator=cb;GE.DefaultValueIterator=LL;var G3={};const{AbstractIterator:qX,AbstractKeyIterator:WX,AbstractValueIterator:GX}=Js,T5=Ys,wn=Symbol("nut"),Q3=Symbol("undefer"),Y3=Symbol("factory");let BL=class extends qX{constructor(e,t){super(e,t),this[wn]=null,this[Y3]=()=>e.iterator(t),this.db.defer(()=>this[Q3]())}},UL=class extends WX{constructor(e,t){super(e,t),this[wn]=null,this[Y3]=()=>e.keys(t),this.db.defer(()=>this[Q3]())}},FL=class extends GX{constructor(e,t){super(e,t),this[wn]=null,this[Y3]=()=>e.values(t),this.db.defer(()=>this[Q3]())}};for(const r of[BL,UL,FL])r.prototype[Q3]=function(){this.db.status==="open"&&(this[wn]=this[Y3]())},r.prototype._next=function(e){this[wn]!==null?this[wn].next(e):this.db.status==="opening"?this.db.defer(()=>this._next(e)):this.nextTick(e,new T5("Iterator is not open: cannot call next() after close()",{code:"LEVEL_ITERATOR_NOT_OPEN"}))},r.prototype._nextv=function(e,t,n){this[wn]!==null?this[wn].nextv(e,t,n):this.db.status==="opening"?this.db.defer(()=>this._nextv(e,t,n)):this.nextTick(n,new T5("Iterator is not open: cannot call nextv() after close()",{code:"LEVEL_ITERATOR_NOT_OPEN"}))},r.prototype._all=function(e,t){this[wn]!==null?this[wn].all(t):this.db.status==="opening"?this.db.defer(()=>this._all(e,t)):this.nextTick(t,new T5("Iterator is not open: cannot call all() after close()",{code:"LEVEL_ITERATOR_NOT_OPEN"}))},r.prototype._seek=function(e,t){this[wn]!==null?this[wn]._seek(e,t):this.db.status==="opening"&&this.db.defer(()=>this._seek(e,t))},r.prototype._close=function(e){this[wn]!==null?this[wn].close(e):this.db.status==="opening"?this.db.defer(()=>this._close(e)):this.nextTick(e)};G3.DeferredIterator=BL;G3.DeferredKeyIterator=UL;G3.DeferredValueIterator=FL;var zL={},QE={};const{fromCallback:EI}=$h,B0=Ys,{getCallback:QX,getOptions:YX}=Rp,U0=Symbol("promise"),hi=Symbol("status"),Tu=Symbol("operations"),hf=Symbol("finishClose"),Pu=Symbol("closeCallbacks");let JX=class{constructor(e){if(typeof e!="object"||e===null){const t=e===null?"null":typeof e;throw new TypeError(`The first argument must be an abstract-level database, received ${t}`)}this[Tu]=[],this[Pu]=[],this[hi]="open",this[hf]=this[hf].bind(this),this.db=e,this.db.attachResource(this),this.nextTick=e.nextTick}get length(){return this[Tu].length}put(e,t,n){if(this[hi]!=="open")throw new B0("Batch is not open: cannot call put() after write() or close()",{code:"LEVEL_BATCH_NOT_OPEN"});const i=this.db._checkKey(e)||this.db._checkValue(t);if(i)throw i;const s=n&&n.sublevel!=null?n.sublevel:this.db,o=n,a=s.keyEncoding(n&&n.keyEncoding),c=s.valueEncoding(n&&n.valueEncoding),l=a.format;n={...n,keyEncoding:l,valueEncoding:c.format},s!==this.db&&(n.sublevel=null);const d=s.prefixKey(a.encode(e),l),h=c.encode(t);return this._put(d,h,n),this[Tu].push({...o,type:"put",key:e,value:t}),this}_put(e,t,n){}del(e,t){if(this[hi]!=="open")throw new B0("Batch is not open: cannot call del() after write() or close()",{code:"LEVEL_BATCH_NOT_OPEN"});const n=this.db._checkKey(e);if(n)throw n;const i=t&&t.sublevel!=null?t.sublevel:this.db,s=t,o=i.keyEncoding(t&&t.keyEncoding),a=o.format;return t={...t,keyEncoding:a},i!==this.db&&(t.sublevel=null),this._del(i.prefixKey(o.encode(e),a),t),this[Tu].push({...s,type:"del",key:e}),this}_del(e,t){}clear(){if(this[hi]!=="open")throw new B0("Batch is not open: cannot call clear() after write() or close()",{code:"LEVEL_BATCH_NOT_OPEN"});return this._clear(),this[Tu]=[],this}_clear(){}write(e,t){return t=QX(e,t),t=EI(t,U0),e=YX(e),this[hi]!=="open"?this.nextTick(t,new B0("Batch is not open: cannot call write() after write() or close()",{code:"LEVEL_BATCH_NOT_OPEN"})):this.length===0?this.close(t):(this[hi]="writing",this._write(e,n=>{this[hi]="closing",this[Pu].push(()=>t(n)),n||this.db.emit("batch",this[Tu]),this._close(this[hf])})),t[U0]}_write(e,t){}close(e){return e=EI(e,U0),this[hi]==="closing"?this[Pu].push(e):this[hi]==="closed"?this.nextTick(e):(this[Pu].push(e),this[hi]!=="writing"&&(this[hi]="closing",this._close(this[hf]))),e[U0]}_close(e){this.nextTick(e)}[hf](){this[hi]="closed",this.db.detachResource(this);const e=this[Pu];this[Pu]=[];for(const t of e)t()}};QE.AbstractChainedBatch=JX;const{AbstractChainedBatch:XX}=QE,ZX=Ys,Du=Symbol("encoded");let eZ=class extends XX{constructor(e){super(e),this[Du]=[]}_put(e,t,n){this[Du].push({...n,type:"put",key:e,value:t})}_del(e,t){this[Du].push({...t,type:"del",key:e})}_clear(){this[Du]=[]}_write(e,t){this.db.status==="opening"?this.db.defer(()=>this._write(e,t)):this.db.status==="open"?this[Du].length===0?this.nextTick(t):this.db._batch(this[Du],e,t):this.nextTick(t,new ZX("Batch is not open: cannot call write() after write() or close()",{code:"LEVEL_BATCH_NOT_OPEN"}))}};zL.DefaultChainedBatch=eZ;const SI=Ys,tZ=Object.prototype.hasOwnProperty,rZ=new Set(["lt","lte","gt","gte"]);var nZ=function(r,e){const t={};for(const n in r)if(tZ.call(r,n)&&!(n==="keyEncoding"||n==="valueEncoding")){if(n==="start"||n==="end")throw new SI(`The legacy range option '${n}' has been removed`,{code:"LEVEL_LEGACY"});if(n==="encoding")throw new SI("The levelup-style 'encoding' alias has been removed, use 'valueEncoding' instead",{code:"LEVEL_LEGACY"});rZ.has(n)?t[n]=e.encode(r[n]):t[n]=r[n]}return t.reverse=!!t.reverse,t.limit=Number.isInteger(t.limit)&&t.limit>=0?t.limit:-1,t};/*! queue-microtask. MIT License. Feross Aboukhadijeh <https://feross.org/opensource> */let xI;var VL=typeof queueMicrotask=="function"?queueMicrotask.bind(typeof window<"u"?window:v1):r=>(xI||(xI=Promise.resolve())).then(r).catch(e=>setTimeout(()=>{throw e},0)),P5,AI;function iZ(){if(AI)return P5;AI=1;const r=VL;return P5=function(e,...t){t.length===0?r(e):r(()=>e(...t))},P5}var ff={},CI;function sZ(){if(CI)return ff;CI=1;const{AbstractIterator:r,AbstractKeyIterator:e,AbstractValueIterator:t}=Js,n=Symbol("unfix"),i=Symbol("iterator"),s=Symbol("handleOne"),o=Symbol("handleMany"),a=Symbol("callback");class c extends r{constructor(p,m,f,g){super(p,m),this[i]=f,this[n]=g,this[s]=this[s].bind(this),this[o]=this[o].bind(this),this[a]=null}[s](p,m,f){const g=this[a];if(p)return g(p);m!==void 0&&(m=this[n](m)),g(p,m,f)}[o](p,m){const f=this[a];if(p)return f(p);for(const g of m){const v=g[0];v!==void 0&&(g[0]=this[n](v))}f(p,m)}}class l extends e{constructor(p,m,f,g){super(p,m),this[i]=f,this[n]=g,this[s]=this[s].bind(this),this[o]=this[o].bind(this),this[a]=null}[s](p,m){const f=this[a];if(p)return f(p);m!==void 0&&(m=this[n](m)),f(p,m)}[o](p,m){const f=this[a];if(p)return f(p);for(let g=0;g<m.length;g++){const v=m[g];v!==void 0&&(m[g]=this[n](v))}f(p,m)}}class d extends t{constructor(p,m,f){super(p,m),this[i]=f}}for(const h of[c,l])h.prototype._next=function(p){this[a]=p,this[i].next(this[s])},h.prototype._nextv=function(p,m,f){this[a]=f,this[i].nextv(p,m,this[o])},h.prototype._all=function(p,m){this[a]=m,this[i].all(p,this[o])};for(const h of[d])h.prototype._next=function(p){this[i].next(p)},h.prototype._nextv=function(p,m,f){this[i].nextv(p,m,f)},h.prototype._all=function(p,m){this[i].all(p,m)};for(const h of[c,l,d])h.prototype._seek=function(p,m){this[i].seek(p,m)},h.prototype._close=function(p){this[i].close(p)};return ff.AbstractSublevelIterator=c,ff.AbstractSublevelKeyIterator=l,ff.AbstractSublevelValueIterator=d,ff}var D5,II;function oZ(){if(II)return D5;II=1;const r=Ys,{Buffer:e}=H3||{},{AbstractSublevelIterator:t,AbstractSublevelKeyIterator:n,AbstractSublevelValueIterator:i}=sZ(),s=Symbol("prefix"),o=Symbol("upperBound"),a=Symbol("prefixRange"),c=Symbol("parent"),l=Symbol("unfix"),d=new TextEncoder,h={separator:"!"};D5=function({AbstractLevel:y}){class w extends y{static defaults(E){if(typeof E=="string")throw new r("The subleveldown string shorthand for { separator } has been removed",{code:"LEVEL_LEGACY"});if(E&&E.open)throw new r("The subleveldown open option has been removed",{code:"LEVEL_LEGACY"});return E==null?h:E.separator?E:{...E,separator:"!"}}constructor(E,A,k){const{separator:x,manifest:I,...T}=w.defaults(k);A=v(A,x);const L=x.charCodeAt(0)+1,z=E[c]||E;if(!d.encode(A).every(j=>j>L&&j<127))throw new r(`Prefix must use bytes > ${L} < 127`,{code:"LEVEL_INVALID_PREFIX"});super(p(z,I),T);const B=(E.prefix||"")+x+A+x,G=B.slice(0,-1)+String.fromCharCode(L);this[c]=z,this[s]=new f(B),this[o]=new f(G),this[l]=new g,this.nextTick=z.nextTick}prefixKey(E,A){if(A==="utf8")return this[s].utf8+E;if(E.byteLength===0)return this[s][A];if(A==="view"){const k=this[s].view,x=new Uint8Array(k.byteLength+E.byteLength);return x.set(k,0),x.set(E,k.byteLength),x}else{const k=this[s].buffer;return e.concat([k,E],k.byteLength+E.byteLength)}}[a](E,A){E.gte!==void 0?E.gte=this.prefixKey(E.gte,A):E.gt!==void 0?E.gt=this.prefixKey(E.gt,A):E.gte=this[s][A],E.lte!==void 0?E.lte=this.prefixKey(E.lte,A):E.lt!==void 0?E.lt=this.prefixKey(E.lt,A):E.lte=this[o][A]}get prefix(){return this[s].utf8}get db(){return this[c]}_open(E,A){this[c].open({passive:!0},A)}_put(E,A,k,x){this[c].put(E,A,k,x)}_get(E,A,k){this[c].get(E,A,k)}_getMany(E,A,k){this[c].getMany(E,A,k)}_del(E,A,k){this[c].del(E,A,k)}_batch(E,A,k){this[c].batch(E,A,k)}_clear(E,A){this[a](E,E.keyEncoding),this[c].clear(E,A)}_iterator(E){this[a](E,E.keyEncoding);const A=this[c].iterator(E),k=this[l].get(this[s].utf8.length,E.keyEncoding);return new t(this,E,A,k)}_keys(E){this[a](E,E.keyEncoding);const A=this[c].keys(E),k=this[l].get(this[s].utf8.length,E.keyEncoding);return new n(this,E,A,k)}_values(E){this[a](E,E.keyEncoding);const A=this[c].values(E);return new i(this,E,A)}}return{AbstractSublevel:w}};const p=function(y,w){return{...y.supports,createIfMissing:!1,errorIfExists:!1,events:{},additionalMethods:{},...w,encodings:{utf8:m(y,"utf8"),buffer:m(y,"buffer"),view:m(y,"view")}}},m=function(y,w){return y.supports.encodings[w]?y.keyEncoding(w).name===w:!1};class f{constructor(w){this.utf8=w,this.view=d.encode(w),this.buffer=e?e.from(this.view.buffer,0,this.view.byteLength):{}}}class g{constructor(){this.cache=new Map}get(w,b){let E=this.cache.get(b);return E===void 0&&(b==="view"?E=(function(A,k){return k.subarray(A)}).bind(null,w):E=(function(A,k){return k.slice(A)}).bind(null,w),this.cache.set(b,E)),E}}const v=function(y,w){let b=0,E=y.length;for(;b<E&&y[b]===w;)b++;for(;E>b&&y[E-1]===w;)E--;return y.slice(b,E)};return D5}const{supports:aZ}=DL,{Transcoder:cZ}=$L,{EventEmitter:lZ}=N3,{fromCallback:ga}=$h,Wi=Ys,{AbstractIterator:Wc}=Js,{DefaultKeyIterator:uZ,DefaultValueIterator:dZ}=GE,{DeferredIterator:hZ,DeferredKeyIterator:fZ,DeferredValueIterator:pZ}=G3,{DefaultChainedBatch:kI}=zL,{getCallback:Gc,getOptions:ya}=Rp,F0=nZ,Ve=Symbol("promise"),no=Symbol("landed"),Qc=Symbol("resources"),$5=Symbol("closeResources"),pf=Symbol("operations"),gf=Symbol("undefer"),z0=Symbol("deferOpen"),_I=Symbol("options"),je=Symbol("status"),Yc=Symbol("defaultOptions"),$u=Symbol("transcoder"),V0=Symbol("keyEncoding"),N5=Symbol("valueEncoding"),gZ=()=>{};let YE=class extends lZ{constructor(e,t){if(super(),typeof e!="object"||e===null)throw new TypeError("The first argument 'manifest' must be an object");t=ya(t);const{keyEncoding:n,valueEncoding:i,passive:s,...o}=t;this[Qc]=new Set,this[pf]=[],this[z0]=!0,this[_I]=o,this[je]="opening",this.supports=aZ(e,{status:!0,promises:!0,clear:!0,getMany:!0,deferredOpen:!0,snapshots:e.snapshots!==!1,permanence:e.permanence!==!1,keyIterator:!0,valueIterator:!0,iteratorNextv:!0,iteratorAll:!0,encodings:e.encodings||{},events:Object.assign({},e.events,{opening:!0,open:!0,closing:!0,closed:!0,put:!0,del:!0,batch:!0,clear:!0})}),this[$u]=new cZ(yZ(this)),this[V0]=this[$u].encoding(n||"utf8"),this[N5]=this[$u].encoding(i||"utf8");for(const a of this[$u].encodings())this.supports.encodings[a.commonName]||(this.supports.encodings[a.commonName]=!0);this[Yc]={empty:Object.freeze({}),entry:Object.freeze({keyEncoding:this[V0].commonName,valueEncoding:this[N5].commonName}),key:Object.freeze({keyEncoding:this[V0].commonName})},this.nextTick(()=>{this[z0]&&this.open({passive:!1},gZ)})}get status(){return this[je]}keyEncoding(e){return this[$u].encoding(e??this[V0])}valueEncoding(e){return this[$u].encoding(e??this[N5])}open(e,t){t=Gc(e,t),t=ga(t,Ve),e={...this[_I],...ya(e)},e.createIfMissing=e.createIfMissing!==!1,e.errorIfExists=!!e.errorIfExists;const n=i=>{this[je]==="closing"||this[je]==="opening"?this.once(no,i?()=>n(i):n):this[je]!=="open"?t(new Wi("Database is not open",{code:"LEVEL_DATABASE_NOT_OPEN",cause:i})):t()};return e.passive?this[je]==="opening"?this.once(no,n):this.nextTick(n):this[je]==="closed"||this[z0]?(this[z0]=!1,this[je]="opening",this.emit("opening"),this._open(e,i=>{if(i){this[je]="closed",this[$5](()=>{this.emit(no),n(i)}),this[gf]();return}this[je]="open",this[gf](),this.emit(no),this[je]==="open"&&this.emit("open"),this[je]==="open"&&this.emit("ready"),n()})):this[je]==="open"?this.nextTick(n):this.once(no,()=>this.open(e,t)),t[Ve]}_open(e,t){this.nextTick(t)}close(e){e=ga(e,Ve);const t=n=>{this[je]==="opening"||this[je]==="closing"?this.once(no,n?t(n):t):this[je]!=="closed"?e(new Wi("Database is not closed",{code:"LEVEL_DATABASE_NOT_CLOSED",cause:n})):e()};if(this[je]==="open"){this[je]="closing",this.emit("closing");const n=i=>{this[je]="open",this[gf](),this.emit(no),t(i)};this[$5](()=>{this._close(i=>{if(i)return n(i);this[je]="closed",this[gf](),this.emit(no),this[je]==="closed"&&this.emit("closed"),t()})})}else this[je]==="closed"?this.nextTick(t):this.once(no,()=>this.close(e));return e[Ve]}[$5](e){if(this[Qc].size===0)return this.nextTick(e);let t=this[Qc].size,n=!0;const i=()=>{--t===0&&(n?this.nextTick(e):e())};for(const s of this[Qc])s.close(i);n=!1,this[Qc].clear()}_close(e){this.nextTick(e)}get(e,t,n){if(n=Gc(t,n),n=ga(n,Ve),t=ya(t,this[Yc].entry),this[je]==="opening")return this.defer(()=>this.get(e,t,n)),n[Ve];if(Nu(this,n))return n[Ve];const i=this._checkKey(e);if(i)return this.nextTick(n,i),n[Ve];const s=this.keyEncoding(t.keyEncoding),o=this.valueEncoding(t.valueEncoding),a=s.format,c=o.format;return(t.keyEncoding!==a||t.valueEncoding!==c)&&(t=Object.assign({},t,{keyEncoding:a,valueEncoding:c})),this._get(this.prefixKey(s.encode(e),a),t,(l,d)=>{if(l)return(l.code==="LEVEL_NOT_FOUND"||l.notFound||/NotFound/i.test(l))&&(l.code||(l.code="LEVEL_NOT_FOUND"),l.notFound||(l.notFound=!0),l.status||(l.status=404)),n(l);try{d=o.decode(d)}catch(h){return n(new Wi("Could not decode value",{code:"LEVEL_DECODE_ERROR",cause:h}))}n(null,d)}),n[Ve]}_get(e,t,n){this.nextTick(n,new Error("NotFound"))}getMany(e,t,n){if(n=Gc(t,n),n=ga(n,Ve),t=ya(t,this[Yc].entry),this[je]==="opening")return this.defer(()=>this.getMany(e,t,n)),n[Ve];if(Nu(this,n))return n[Ve];if(!Array.isArray(e))return this.nextTick(n,new TypeError("The first argument 'keys' must be an array")),n[Ve];if(e.length===0)return this.nextTick(n,null,[]),n[Ve];const i=this.keyEncoding(t.keyEncoding),s=this.valueEncoding(t.valueEncoding),o=i.format,a=s.format;(t.keyEncoding!==o||t.valueEncoding!==a)&&(t=Object.assign({},t,{keyEncoding:o,valueEncoding:a}));const c=new Array(e.length);for(let l=0;l<e.length;l++){const d=e[l],h=this._checkKey(d);if(h)return this.nextTick(n,h),n[Ve];c[l]=this.prefixKey(i.encode(d),o)}return this._getMany(c,t,(l,d)=>{if(l)return n(l);try{for(let h=0;h<d.length;h++)d[h]!==void 0&&(d[h]=s.decode(d[h]))}catch(h){return n(new Wi(`Could not decode one or more of ${d.length} value(s)`,{code:"LEVEL_DECODE_ERROR",cause:h}))}n(null,d)}),n[Ve]}_getMany(e,t,n){this.nextTick(n,null,new Array(e.length).fill(void 0))}put(e,t,n,i){if(i=Gc(n,i),i=ga(i,Ve),n=ya(n,this[Yc].entry),this[je]==="opening")return this.defer(()=>this.put(e,t,n,i)),i[Ve];if(Nu(this,i))return i[Ve];const s=this._checkKey(e)||this._checkValue(t);if(s)return this.nextTick(i,s),i[Ve];const o=this.keyEncoding(n.keyEncoding),a=this.valueEncoding(n.valueEncoding),c=o.format,l=a.format;(n.keyEncoding!==c||n.valueEncoding!==l)&&(n=Object.assign({},n,{keyEncoding:c,valueEncoding:l}));const d=this.prefixKey(o.encode(e),c),h=a.encode(t);return this._put(d,h,n,p=>{if(p)return i(p);this.emit("put",e,t),i()}),i[Ve]}_put(e,t,n,i){this.nextTick(i)}del(e,t,n){if(n=Gc(t,n),n=ga(n,Ve),t=ya(t,this[Yc].key),this[je]==="opening")return this.defer(()=>this.del(e,t,n)),n[Ve];if(Nu(this,n))return n[Ve];const i=this._checkKey(e);if(i)return this.nextTick(n,i),n[Ve];const s=this.keyEncoding(t.keyEncoding),o=s.format;return t.keyEncoding!==o&&(t=Object.assign({},t,{keyEncoding:o})),this._del(this.prefixKey(s.encode(e),o),t,a=>{if(a)return n(a);this.emit("del",e),n()}),n[Ve]}_del(e,t,n){this.nextTick(n)}batch(e,t,n){if(!arguments.length){if(this[je]==="opening")return new kI(this);if(this[je]!=="open")throw new Wi("Database is not open",{code:"LEVEL_DATABASE_NOT_OPEN"});return this._chainedBatch()}if(typeof e=="function"?n=e:n=Gc(t,n),n=ga(n,Ve),t=ya(t,this[Yc].empty),this[je]==="opening")return this.defer(()=>this.batch(e,t,n)),n[Ve];if(Nu(this,n))return n[Ve];if(!Array.isArray(e))return this.nextTick(n,new TypeError("The first argument 'operations' must be an array")),n[Ve];if(e.length===0)return this.nextTick(n),n[Ve];const i=new Array(e.length),{keyEncoding:s,valueEncoding:o,...a}=t;for(let c=0;c<e.length;c++){if(typeof e[c]!="object"||e[c]===null)return this.nextTick(n,new TypeError("A batch operation must be an object")),n[Ve];const l=Object.assign({},e[c]);if(l.type!=="put"&&l.type!=="del")return this.nextTick(n,new TypeError("A batch operation must have a type property that is 'put' or 'del'")),n[Ve];const d=this._checkKey(l.key);if(d)return this.nextTick(n,d),n[Ve];const h=l.sublevel!=null?l.sublevel:this,p=h.keyEncoding(l.keyEncoding||s),m=p.format;if(l.key=h.prefixKey(p.encode(l.key),m),l.keyEncoding=m,l.type==="put"){const f=this._checkValue(l.value);if(f)return this.nextTick(n,f),n[Ve];const g=h.valueEncoding(l.valueEncoding||o);l.value=g.encode(l.value),l.valueEncoding=g.format}h!==this&&(l.sublevel=null),i[c]=l}return this._batch(i,a,c=>{if(c)return n(c);this.emit("batch",e),n()}),n[Ve]}_batch(e,t,n){this.nextTick(n)}sublevel(e,t){return this._sublevel(e,lb.defaults(t))}_sublevel(e,t){return new lb(this,e,t)}prefixKey(e,t){return e}clear(e,t){if(t=Gc(e,t),t=ga(t,Ve),e=ya(e,this[Yc].empty),this[je]==="opening")return this.defer(()=>this.clear(e,t)),t[Ve];if(Nu(this,t))return t[Ve];const n=e,i=this.keyEncoding(e.keyEncoding);return e=F0(e,i),e.keyEncoding=i.format,e.limit===0?this.nextTick(t):this._clear(e,s=>{if(s)return t(s);this.emit("clear",n),t()}),t[Ve]}_clear(e,t){this.nextTick(t)}iterator(e){const t=this.keyEncoding(e&&e.keyEncoding),n=this.valueEncoding(e&&e.valueEncoding);if(e=F0(e,t),e.keys=e.keys!==!1,e.values=e.values!==!1,e[Wc.keyEncoding]=t,e[Wc.valueEncoding]=n,e.keyEncoding=t.format,e.valueEncoding=n.format,this[je]==="opening")return new hZ(this,e);if(this[je]!=="open")throw new Wi("Database is not open",{code:"LEVEL_DATABASE_NOT_OPEN"});return this._iterator(e)}_iterator(e){return new Wc(this,e)}keys(e){const t=this.keyEncoding(e&&e.keyEncoding),n=this.valueEncoding(e&&e.valueEncoding);if(e=F0(e,t),e[Wc.keyEncoding]=t,e[Wc.valueEncoding]=n,e.keyEncoding=t.format,e.valueEncoding=n.format,this[je]==="opening")return new fZ(this,e);if(this[je]!=="open")throw new Wi("Database is not open",{code:"LEVEL_DATABASE_NOT_OPEN"});return this._keys(e)}_keys(e){return new uZ(this,e)}values(e){const t=this.keyEncoding(e&&e.keyEncoding),n=this.valueEncoding(e&&e.valueEncoding);if(e=F0(e,t),e[Wc.keyEncoding]=t,e[Wc.valueEncoding]=n,e.keyEncoding=t.format,e.valueEncoding=n.format,this[je]==="opening")return new pZ(this,e);if(this[je]!=="open")throw new Wi("Database is not open",{code:"LEVEL_DATABASE_NOT_OPEN"});return this._values(e)}_values(e){return new dZ(this,e)}defer(e){if(typeof e!="function")throw new TypeError("The first argument must be a function");this[pf].push(e)}[gf](){if(this[pf].length===0)return;const e=this[pf];this[pf]=[];for(const t of e)t()}attachResource(e){if(typeof e!="object"||e===null||typeof e.close!="function")throw new TypeError("The first argument must be a resource object");this[Qc].add(e)}detachResource(e){this[Qc].delete(e)}_chainedBatch(){return new kI(this)}_checkKey(e){if(e==null)return new Wi("Key cannot be null or undefined",{code:"LEVEL_INVALID_KEY"})}_checkValue(e){if(e==null)return new Wi("Value cannot be null or undefined",{code:"LEVEL_INVALID_VALUE"})}};YE.prototype.nextTick=iZ();const{AbstractSublevel:lb}=oZ()({AbstractLevel:YE});j3.AbstractLevel=YE;j3.AbstractSublevel=lb;const Nu=function(r,e){return r[je]!=="open"?(r.nextTick(e,new Wi("Database is not open",{code:"LEVEL_DATABASE_NOT_OPEN"})),!0):!1},yZ=function(r){return Object.keys(r.supports.encodings).filter(e=>!!r.supports.encodings[e])};Lc.AbstractLevel=j3.AbstractLevel;Lc.AbstractSublevel=j3.AbstractSublevel;Lc.AbstractIterator=Js.AbstractIterator;Lc.AbstractKeyIterator=Js.AbstractKeyIterator;Lc.AbstractValueIterator=Js.AbstractValueIterator;Lc.AbstractChainedBatch=QE.AbstractChainedBatch;/*! run-parallel-limit. MIT License. Feross Aboukhadijeh <https://feross.org/opensource> */var mZ=bZ;const wZ=VL;function bZ(r,e,t){if(typeof e!="number")throw new Error("second argument must be a Number");let n,i,s,o,a,c=!0,l;Array.isArray(r)?(n=[],s=i=r.length):(o=Object.keys(r),n={},s=i=o.length);function d(p){function m(){t&&t(p,n),t=null}c?wZ(m):m()}function h(p,m,f){if(n[p]=f,m&&(a=!0),--s===0||m)d(m);else if(!a&&l<i){let g;o?(g=o[l],l+=1,r[g](function(v,y){h(g,v,y)})):(g=l,l+=1,r[g](function(v,y){h(g,v,y)}))}}l=e,s?o?o.some(function(p,m){return r[p](function(f,g){h(p,f,g)}),m===e-1}):r.some(function(p,m){return p(function(f,g){h(m,f,g)}),m===e-1}):d(null),c=!1}var KL={},jL=function(e){const t=e.gte!==void 0?e.gte:e.gt!==void 0?e.gt:void 0,n=e.lte!==void 0?e.lte:e.lt!==void 0?e.lt:void 0,i=e.gte===void 0,s=e.lte===void 0;return t!==void 0&&n!==void 0?IDBKeyRange.bound(t,n,i,s):t!==void 0?IDBKeyRange.lowerBound(t,i):n!==void 0?IDBKeyRange.upperBound(n,s):null};const vZ=new TextEncoder;var HL=function(r){return r instanceof Uint8Array?r:r instanceof ArrayBuffer?new Uint8Array(r):vZ.encode(r)};const{AbstractIterator:EZ}=Lc,TI=jL,K0=HL,As=Symbol("cache"),io=Symbol("finished"),Fn=Symbol("options"),so=Symbol("currentOptions"),Jc=Symbol("position"),M5=Symbol("location"),Mu=Symbol("first"),PI={};let SZ=class extends EZ{constructor(e,t,n){super(e,n),this[As]=[],this[io]=this.limit===0,this[Fn]=n,this[so]={...n},this[Jc]=void 0,this[M5]=t,this[Mu]=!0}_nextv(e,t,n){if(this[Mu]=!1,this[io])return this.nextTick(n,null,[]);if(this[As].length>0)return e=Math.min(e,this[As].length),this.nextTick(n,null,this[As].splice(0,e));this[Jc]!==void 0&&(this[Fn].reverse?(this[so].lt=this[Jc],this[so].lte=void 0):(this[so].gt=this[Jc],this[so].gte=void 0));let i;try{i=TI(this[so])}catch{return this[io]=!0,this.nextTick(n,null,[])}const s=this.db.db.transaction([this[M5]],"readonly"),o=s.objectStore(this[M5]),a=[];if(this[Fn].reverse){const c=!this[Fn].values&&o.openKeyCursor?"openKeyCursor":"openCursor";o[c](i,"prev").onsuccess=l=>{const d=l.target.result;if(d){const{key:h,value:p}=d;this[Jc]=h,a.push([this[Fn].keys&&h!==void 0?K0(h):void 0,this[Fn].values&&p!==void 0?K0(p):void 0]),a.length<e?d.continue():DI(s)}else this[io]=!0}}else{let c,l;const d=()=>{if(c===void 0||l===void 0)return;const h=Math.max(c.length,l.length);h===0||e===1/0?this[io]=!0:this[Jc]=c[h-1],a.length=h;for(let p=0;p<h;p++){const m=c[p],f=l[p];a[p]=[this[Fn].keys&&m!==void 0?K0(m):void 0,this[Fn].values&&f!==void 0?K0(f):void 0]}DI(s)};this[Fn].keys||e<1/0?o.getAllKeys(i,e<1/0?e:void 0).onsuccess=h=>{c=h.target.result,d()}:(c=[],this.nextTick(d)),this[Fn].values?o.getAll(i,e<1/0?e:void 0).onsuccess=h=>{l=h.target.result,d()}:(l=[],this.nextTick(d))}s.onabort=()=>{n(s.error||new Error("aborted by user")),n=null},s.oncomplete=()=>{n(null,a),n=null}}_next(e){if(this[As].length>0){const[t,n]=this[As].shift();this.nextTick(e,null,t,n)}else if(this[io])this.nextTick(e);else{let t=Math.min(100,this.limit-this.count);this[Mu]&&(this[Mu]=!1,t=1),this._nextv(t,PI,(n,i)=>{if(n)return e(n);this[As]=i,this._next(e)})}}_all(e,t){this[Mu]=!1;const n=this[As].splice(0,this[As].length),i=this.limit-this.count-n.length;if(i<=0)return this.nextTick(t,null,n);this._nextv(i,PI,(s,o)=>{if(s)return t(s);n.length>0&&(o=n.concat(o)),t(null,o)})}_seek(e,t){this[Mu]=!0,this[As]=[],this[io]=!1,this[Jc]=void 0,this[so]={...this[Fn]};let n;try{n=TI(this[Fn])}catch{this[io]=!0;return}n!==null&&!n.includes(e)?this[io]=!0:this[Fn].reverse?this[so].lte=e:this[so].gte=e}};KL.Iterator=SZ;function DI(r){typeof r.commit=="function"&&r.commit()}var xZ=function(e,t,n,i,s){if(i.limit===0)return e.nextTick(s);const o=e.db.transaction([t],"readwrite"),a=o.objectStore(t);let c=0;o.oncomplete=function(){s()},o.onabort=function(){s(o.error||new Error("aborted by user"))};const l=a.openKeyCursor?"openKeyCursor":"openCursor",d=i.reverse?"prev":"next";a[l](n,d).onsuccess=function(h){const p=h.target.result;p&&(a.delete(p.key).onsuccess=function(){(i.limit<=0||++c<i.limit)&&p.continue()})}};const{AbstractLevel:AZ}=Lc,$I=Ys,CZ=mZ,{fromCallback:IZ}=$h,{Iterator:kZ}=KL,NI=HL,_Z=xZ,TZ=jL,qL="level-js-",yf=Symbol("idb"),O5=Symbol("namePrefix"),oo=Symbol("location"),R5=Symbol("version"),Xc=Symbol("store"),mf=Symbol("onComplete"),MI=Symbol("promise");class WL extends AZ{constructor(e,t,n){if(typeof t=="function"||typeof n=="function")throw new $I("The levelup-style callback argument has been removed",{code:"LEVEL_LEGACY"});const{prefix:i,version:s,...o}=t||{};if(super({encodings:{view:!0},snapshots:!1,createIfMissing:!1,errorIfExists:!1,seek:!0},o),typeof e!="string")throw new Error("constructor requires a location string argument");this[oo]=e,this[O5]=i??qL,this[R5]=parseInt(s||1,10),this[yf]=null}get location(){return this[oo]}get namePrefix(){return this[O5]}get version(){return this[R5]}get db(){return this[yf]}get type(){return"browser-level"}_open(e,t){const n=indexedDB.open(this[O5]+this[oo],this[R5]);n.onerror=function(){t(n.error||new Error("unknown error"))},n.onsuccess=()=>{this[yf]=n.result,t()},n.onupgradeneeded=i=>{const s=i.target.result;s.objectStoreNames.contains(this[oo])||s.createObjectStore(this[oo])}}[Xc](e){return this[yf].transaction([this[oo]],e).objectStore(this[oo])}[mf](e,t){const n=e.transaction;n.onabort=function(){t(n.error||new Error("aborted by user"))},n.oncomplete=function(){t(null,e.result)}}_get(e,t,n){const i=this[Xc]("readonly");let s;try{s=i.get(e)}catch(o){return this.nextTick(n,o)}this[mf](s,function(o,a){if(o)return n(o);if(a===void 0)return n(new $I("Entry not found",{code:"LEVEL_NOT_FOUND"}));n(null,NI(a))})}_getMany(e,t,n){const i=this[Xc]("readonly"),s=e.map(o=>a=>{let c;try{c=i.get(o)}catch(l){return a(l)}c.onsuccess=()=>{const l=c.result;a(null,l===void 0?l:NI(l))},c.onerror=l=>{l.stopPropagation(),a(c.error)}});CZ(s,16,n)}_del(e,t,n){const i=this[Xc]("readwrite");let s;try{s=i.delete(e)}catch(o){return this.nextTick(n,o)}this[mf](s,n)}_put(e,t,n,i){const s=this[Xc]("readwrite");let o;try{o=s.put(t,e)}catch(a){return this.nextTick(i,a)}this[mf](o,i)}_iterator(e){return new kZ(this,this[oo],e)}_batch(e,t,n){const i=this[Xc]("readwrite"),s=i.transaction;let o=0,a;s.onabort=function(){n(a||s.error||new Error("aborted by user"))},s.oncomplete=function(){n()};function c(){const l=e[o++],d=l.key;let h;try{h=l.type==="del"?i.delete(d):i.put(l.value,d)}catch(p){a=p,s.abort();return}o<e.length?h.onsuccess=c:typeof s.commit=="function"&&s.commit()}c()}_clear(e,t){let n,i;try{n=TZ(e)}catch{return this.nextTick(t)}if(e.limit>=0)return _Z(this,this[oo],n,e,t);try{const s=this[Xc]("readwrite");i=n?s.delete(n):s.clear()}catch(s){return this.nextTick(t,s)}this[mf](i,t)}_close(e){this[yf].close(),this.nextTick(e)}}WL.destroy=function(r,e,t){typeof e=="function"&&(t=e,e=qL),t=IZ(t,MI);const n=indexedDB.deleteDatabase(e+r);return n.onsuccess=function(){t()},n.onerror=function(i){t(i)},t[MI]};PL.BrowserLevel=WL;var PZ=PL.BrowserLevel;const DZ="./level",$Z="view",ub=async({path:r,valueEncoding:e}={})=>{r=r||DZ,e=e||$Z;const t=new PZ(r,{valueEncoding:e,passive:!0});return await t.open(),{put:async(d,h)=>{await t.put(d,h)},del:async d=>{await t.del(d)},get:async d=>{try{const h=await t.get(d);if(h)return h}catch{}},iterator:async function*({amount:d,reverse:h}={}){const p={limit:d||-1,reverse:h||!1};for await(const[m,f]of t.iterator(p))yield[m,f]},merge:async d=>{},clear:async()=>{await t.clear()},close:async()=>{await t.close()}}},OI=1e6,Vs=async({size:r}={})=>{let e=new J6(r||OI);return{put:async(l,d)=>{e.set(l,d)},del:async l=>{e.remove(l)},get:async l=>e.get(l),iterator:async function*(){for await(const l of e.keys){const d=e.get(l);yield[l,d]}},merge:async l=>{if(l)for await(const[d,h]of l.iterator())e.set(d,h)},clear:async()=>{e=new J6(r||OI)},close:async()=>{}}},NZ=16,L5=1e3,JE=async({ipfs:r,identity:e,address:t,name:n,access:i,directory:s,meta:o,headsStorage:a,entryStorage:c,indexStorage:l,referencesCount:d,syncAutomatically:h,onUpdate:p})=>{s=lc(s||"./orbitdb",`./${t}/`),o=o||{},d=Number(d)>-1?d:NZ,c=c||await _l(await Vs({size:L5}),await K3({ipfs:r,pin:!0})),a=a||await _l(await Vs({size:L5}),await ub({path:lc(s,"/log/_heads/")})),l=l||await _l(await Vs({size:L5}),await ub({path:lc(s,"/log/_index/")}));const m=await gX(e,{logId:t,access:i,entryStorage:c,headsStorage:a,indexStorage:l}),f=new N3.EventEmitter,g=new wc({concurrency:1}),v=async A=>{const k=async()=>{const I=await m.append(A,{referencesCount:d});return await E.add(I),p&&await p(m,I),f.emit("update",I),I.hash},x=await g.add(k);return await g.onIdle(),x},y=async A=>{const k=async()=>{const x=await mo.decode(A);x&&await m.joinEntry(x)&&(p&&await p(m,x),f.emit("update",x))};await g.add(k)},w=async()=>{await E.stop(),await g.onIdle(),await m.close(),i&&i.close&&await i.close(),f.emit("close")},b=async()=>{await g.onIdle(),await m.clear(),i&&i.drop&&await i.drop(),f.emit("drop")},E=await iQ({ipfs:r,log:m,events:f,onSynced:y,start:h});return{address:t,name:n,identity:e,meta:o,close:w,drop:b,addOperation:v,log:m,sync:E,peers:E.peers,events:f,access:i}},GL="documents",MZ={indexBy:"_id"},QL=({indexBy:r}=MZ)=>async({ipfs:e,identity:t,address:n,name:i,access:s,directory:o,meta:a,headsStorage:c,entryStorage:l,indexStorage:d,referencesCount:h,syncAutomatically:p,onUpdate:m})=>{const f=await JE({ipfs:e,identity:t,address:n,name:i,access:s,directory:o,meta:a,headsStorage:c,entryStorage:l,indexStorage:d,referencesCount:h,syncAutomatically:p}),{addOperation:g,log:v}=f,y=async x=>{const I=x[r];if(!I)throw new Error(`The provided document doesn't contain field '${r}'`);return g({op:"PUT",key:I,value:x})},w=async x=>{if(!await b(x))throw new Error(`No document with key '${x}' in the database`);return g({op:"DEL",key:x,value:null})},b=async x=>{for await(const I of A())if(x===I.key)return I},E=async x=>{const I=[];for await(const T of A())x(T.value)&&I.push(T.value);return I},A=async function*({amount:x}={}){const I={};let T=0;for await(const L of v.iterator()){const{op:z,key:B,value:G}=L.payload;if(z==="PUT"&&!I[B]?(I[B]=!0,T++,yield{hash:L.hash,key:B,value:G}):z==="DEL"&&!I[B]&&(I[B]=!0),T>=x)break}};return{...f,type:GL,put:y,del:w,get:b,iterator:A,query:E,indexBy:r,all:async()=>{const x=[];for await(const I of A())x.unshift(I);return x}}};QL.type=GL;const YL="events",JL=()=>async({ipfs:r,identity:e,address:t,name:n,access:i,directory:s,meta:o,headsStorage:a,entryStorage:c,indexStorage:l,referencesCount:d,syncAutomatically:h,onUpdate:p})=>{const m=await JE({ipfs:r,identity:e,address:t,name:n,access:i,directory:s,meta:o,headsStorage:a,entryStorage:c,indexStorage:l,referencesCount:d,syncAutomatically:h,onUpdate:p}),{addOperation:f,log:g}=m,v=async E=>f({op:"ADD",key:null,value:E}),y=async E=>(await g.get(E)).payload.value,w=async function*({gt:E,gte:A,lt:k,lte:x,amount:I}={}){const T=g.iterator({gt:E,gte:A,lt:k,lte:x,amount:I});for await(const L of T){const z=L.hash,B=L.payload.value;yield{hash:z,value:B}}};return{...m,type:YL,add:v,get:y,iterator:w,all:async()=>{const E=[];for await(const A of w())E.unshift(A);return E}}};JL.type=YL;const XL="keyvalue",ZL=()=>async({ipfs:r,identity:e,address:t,name:n,access:i,directory:s,meta:o,headsStorage:a,entryStorage:c,indexStorage:l,referencesCount:d,syncAutomatically:h,onUpdate:p})=>{const m=await JE({ipfs:r,identity:e,address:t,name:n,access:i,directory:s,meta:o,headsStorage:a,entryStorage:c,indexStorage:l,referencesCount:d,syncAutomatically:h,onUpdate:p}),{addOperation:f,log:g}=m,v=async(A,k)=>f({op:"PUT",key:A,value:k}),y=async A=>f({op:"DEL",key:A,value:null}),w=async A=>{for await(const k of g.traverse()){const{op:x,key:I,value:T}=k.payload;if(x==="PUT"&&I===A)return T;if(x==="DEL"&&I===A)return}},b=async function*({amount:A}={}){const k={};let x=0;for await(const I of g.traverse()){const{op:T,key:L,value:z}=I.payload;if(T==="PUT"&&!k[L]){k[L]=!0,x++;const B=I.hash;yield{key:L,value:z,hash:B}}else T==="DEL"&&!k[L]&&(k[L]=!0);if(x>=A)break}};return{...m,type:XL,put:v,set:v,del:y,get:w,iterator:b,all:async()=>{const A=[];for await(const k of b())A.unshift(k);return A}}};ZL.type=XL;const db={},XE=r=>{if(!r.type)throw new Error("Database type does not contain required field 'type'.");db[r.type]=r},OZ=r=>{if(!r)throw new Error("Type not specified");if(!db[r])throw new Error(`Unsupported database type: '${r}'`);return db[r]};XE(JL);XE(QL);XE(ZL);const RZ=Symbol.for("@libp2p/connection"),jd=Symbol.for("@libp2p/content-routing"),ey=Symbol.for("@libp2p/peer-discovery"),ZE=Symbol.for("@libp2p/peer-id");function eB(r){return!!(r!=null&&r[ZE])}const Hd=Symbol.for("@libp2p/peer-routing"),J3="keep-alive",ty="StrictSign",eS="StrictNoSign";var xi;(function(r){r.Accept="accept",r.Ignore="ignore",r.Reject="reject"})(xi||(xi={}));const X3=Symbol.for("@libp2p/transport");var jl;(function(r){r[r.FATAL_ALL=0]="FATAL_ALL",r[r.NO_FATAL=1]="NO_FATAL"})(jl||(jl={}));var X8;let Hl=(X8=class extends Error{constructor(e="The operation was aborted"){super(e),this.name="AbortError"}},u(X8,"name","AbortError"),X8);class tB extends Error{constructor(e="Unexpected Peer"){super(e),this.name="UnexpectedPeerError"}}u(tB,"name","UnexpectedPeerError");var Z8;let LZ=(Z8=class extends Error{constructor(e="Invalid crypto exchange"){super(e),this.name="InvalidCryptoExchangeError"}},u(Z8,"name","InvalidCryptoExchangeError"),Z8);class Z extends Error{constructor(e="Invalid parameters"){super(e),this.name="InvalidParametersError"}}u(Z,"name","InvalidParametersError");class F1 extends Error{constructor(e="Invalid public key"){super(e),this.name="InvalidPublicKeyError"}}u(F1,"name","InvalidPublicKeyError");class tS extends Error{constructor(e="Invalid private key"){super(e),this.name="InvalidPrivateKeyError"}}u(tS,"name","InvalidPrivateKeyError");class rB extends Error{constructor(e="The connection is closing"){super(e),this.name="ConnectionClosingError"}}u(rB,"name","ConnectionClosingError");class rS extends Error{constructor(e="The connection is closed"){super(e),this.name="ConnectionClosedError"}}u(rS,"name","ConnectionClosedError");class nS extends Error{constructor(e="Connection failed"){super(e),this.name="ConnectionFailedError"}}u(nS,"name","ConnectionFailedError");class al extends Error{constructor(e="The muxer is closed"){super(e),this.name="MuxerClosedError"}}u(al,"name","MuxerClosedError");class nB extends Error{constructor(e="The stream has been reset"){super(e),this.name="StreamResetError"}}u(nB,"name","StreamResetError");class ry extends Error{constructor(e="The stream is in an invalid state"){super(e),this.name="StreamStateError"}}u(ry,"name","StreamStateError");var e6;let Zt=(e6=class extends Error{constructor(e="Not found"){super(e),this.name="NotFoundError"}},u(e6,"name","NotFoundError"),e6);class iS extends Error{constructor(e="Invalid PeerID"){super(e),this.name="InvalidPeerIdError"}}u(iS,"name","InvalidPeerIdError");class Z3 extends Error{constructor(e="Invalid multiaddr"){super(e),this.name="InvalidMultiaddrError"}}u(Z3,"name","InvalidMultiaddrError");class iB extends Error{constructor(e="Invalid CID"){super(e),this.name="InvalidCIDError"}}u(iB,"name","InvalidCIDError");class ew extends Error{constructor(e="Invalid Multihash"){super(e),this.name="InvalidMultihashError"}}u(ew,"name","InvalidMultihashError");class Lp extends Error{constructor(e="Unsupported protocol error"){super(e),this.name="UnsupportedProtocolError"}}u(Lp,"name","UnsupportedProtocolError");class xt extends Error{constructor(e="Invalid message"){super(e),this.name="InvalidMessageError"}}u(xt,"name","InvalidMessageError");class sB extends Error{constructor(e="Protocol error"){super(e),this.name="ProtocolError"}}u(sB,"name","ProtocolError");class Bp extends Error{constructor(e="Timed out"){super(e),this.name="TimeoutError"}}u(Bp,"name","TimeoutError");class ql extends Error{constructor(e="Not started"){super(e),this.name="NotStartedError"}}u(ql,"name","NotStartedError");class gd extends Error{constructor(e="Dial error"){super(e),this.name="DialError"}}u(gd,"name","DialError");class ny extends Error{constructor(e="Listen error"){super(e),this.name="ListenError"}}u(ny,"name","ListenError");class sS extends Error{constructor(e="Limited connection"){super(e),this.name="LimitedConnectionError"}}u(sS,"name","LimitedConnectionError");class oB extends Error{constructor(e="Too many inbound protocol streams"){super(e),this.name="TooManyInboundProtocolStreamsError"}}u(oB,"name","TooManyInboundProtocolStreamsError");class tw extends Error{constructor(e="Too many outbound protocol streams"){super(e),this.name="TooManyOutboundProtocolStreamsError"}}u(tw,"name","TooManyOutboundProtocolStreamsError");class Eu extends Error{constructor(e="Unsupported key type"){super(e),this.name="UnsupportedKeyTypeError"}}u(Eu,"name","UnsupportedKeyTypeError");var Ns;class er extends EventTarget{constructor(){super();Ge(this,Ns,new Map)}listenerCount(t){const n=se(this,Ns).get(t);return n==null?0:n.length}addEventListener(t,n,i){super.addEventListener(t,n,i);let s=se(this,Ns).get(t);s==null&&(s=[],se(this,Ns).set(t,s)),s.push({callback:n,once:(i!==!0&&i!==!1&&(i==null?void 0:i.once))??!1})}removeEventListener(t,n,i){super.removeEventListener(t.toString(),n??null,i);let s=se(this,Ns).get(t);s!=null&&(s=s.filter(({callback:o})=>o!==n),se(this,Ns).set(t,s))}dispatchEvent(t){const n=super.dispatchEvent(t);let i=se(this,Ns).get(t.type);return i==null||(i=i.filter(({once:s})=>!s),se(this,Ns).set(t.type,i)),n}safeDispatchEvent(t,n={}){return this.dispatchEvent(new CustomEvent(t,n))}}Ns=new WeakMap;function oS(r){return r!=null&&typeof r.start=="function"&&typeof r.stop=="function"}async function Vo(...r){const e=[];for(const t of r)oS(t)&&e.push(t);await Promise.all(e.map(async t=>{t.beforeStart!=null&&await t.beforeStart()})),await Promise.all(e.map(async t=>{await t.start()})),await Promise.all(e.map(async t=>{t.afterStart!=null&&await t.afterStart()}))}async function Bc(...r){const e=[];for(const t of r)oS(t)&&e.push(t);await Promise.all(e.map(async t=>{t.beforeStop!=null&&await t.beforeStop()})),await Promise.all(e.map(async t=>{await t.stop()})),await Promise.all(e.map(async t=>{t.afterStop!=null&&await t.afterStop()}))}const fr=Symbol.for("@libp2p/service-capabilities"),Ec=Symbol.for("@libp2p/service-dependencies");function BZ(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function rw(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function UZ(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var i=0;i<r.length;i++){var s=r.charAt(i),o=s.charCodeAt(0);if(t[o]!==255)throw new TypeError(s+" is ambiguous");t[o]=i}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),d=Math.log(256)/Math.log(a);function h(f){if(f instanceof Uint8Array||(ArrayBuffer.isView(f)?f=new Uint8Array(f.buffer,f.byteOffset,f.byteLength):Array.isArray(f)&&(f=Uint8Array.from(f))),!(f instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(f.length===0)return"";for(var g=0,v=0,y=0,w=f.length;y!==w&&f[y]===0;)y++,g++;for(var b=(w-y)*d+1>>>0,E=new Uint8Array(b);y!==w;){for(var A=f[y],k=0,x=b-1;(A!==0||k<v)&&x!==-1;x--,k++)A+=256*E[x]>>>0,E[x]=A%a>>>0,A=A/a>>>0;if(A!==0)throw new Error("Non-zero carry");v=k,y++}for(var I=b-v;I!==b&&E[I]===0;)I++;for(var T=c.repeat(g);I<b;++I)T+=r.charAt(E[I]);return T}function p(f){if(typeof f!="string")throw new TypeError("Expected String");if(f.length===0)return new Uint8Array;var g=0;if(f[g]!==" "){for(var v=0,y=0;f[g]===c;)v++,g++;for(var w=(f.length-g)*l+1>>>0,b=new Uint8Array(w);f[g];){var E=t[f.charCodeAt(g)];if(E===255)return;for(var A=0,k=w-1;(E!==0||A<y)&&k!==-1;k--,A++)E+=a*b[k]>>>0,b[k]=E%256>>>0,E=E/256>>>0;if(E!==0)throw new Error("Non-zero carry");y=A,g++}if(f[g]!==" "){for(var x=w-y;x!==w&&b[x]===0;)x++;for(var I=new Uint8Array(v+(w-x)),T=v;x!==w;)I[T++]=b[x++];return I}}}function m(f){var g=p(f);if(g)return g;throw new Error(`Non-${e} character`)}return{encode:h,decodeUnsafe:p,decode:m}}var FZ=UZ,zZ=FZ;let VZ=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseEncode");this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},KZ=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseDecode");u(this,"prefixCodePoint");this.name=e,this.prefix=t;const i=t.codePointAt(0);if(i===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=i,this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return aB(this,e)}},jZ=class{constructor(e){u(this,"decoders");this.decoders=e}or(e){return aB(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};function aB(r,e){return new jZ({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}let HZ=class{constructor(e,t,n,i){u(this,"name");u(this,"prefix");u(this,"baseEncode");u(this,"baseDecode");u(this,"encoder");u(this,"decoder");this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=i,this.encoder=new VZ(e,t,n),this.decoder=new KZ(e,t,i)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};function cB({name:r,prefix:e,encode:t,decode:n}){return new HZ(r,e,t,n)}function nw({name:r,prefix:e,alphabet:t}){const{encode:n,decode:i}=zZ(t,r);return cB({prefix:e,name:r,encode:n,decode:s=>rw(i(s))})}function qZ(r,e,t,n){const i={};for(let d=0;d<e.length;++d)i[e[d]]=d;let s=r.length;for(;r[s-1]==="=";)--s;const o=new Uint8Array(s*t/8|0);let a=0,c=0,l=0;for(let d=0;d<s;++d){const h=i[r[d]];if(h===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|h,a+=t,a>=8&&(a-=8,o[l++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o}function WZ(r,e,t){const n=e[e.length-1]==="=",i=(1<<t)-1;let s="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,s+=e[i&a>>o];if(o!==0&&(s+=e[i&a<<t-o]),n)for(;s.length*t&7;)s+="=";return s}function ii({name:r,prefix:e,bitsPerChar:t,alphabet:n}){return cB({prefix:e,name:r,encode(i){return WZ(i,n,t)},decode(i){return qZ(i,n,t,r)}})}const Si=nw({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});nw({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});const Hg=ii({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});ii({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});ii({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});ii({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});ii({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});ii({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});ii({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});ii({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});ii({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const B5=nw({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"});nw({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});var GZ=lB,RI=128,QZ=-128,YZ=Math.pow(2,31);function lB(r,e,t){e=e||[],t=t||0;for(var n=t;r>=YZ;)e[t++]=r&255|RI,r/=128;for(;r&QZ;)e[t++]=r&255|RI,r>>>=7;return e[t]=r|0,lB.bytes=t-n+1,e}var JZ=hb,XZ=128,LI=127;function hb(r,n){var t=0,n=n||0,i=0,s=n,o,a=r.length;do{if(s>=a)throw hb.bytes=0,new RangeError("Could not decode varint");o=r[s++],t+=i<28?(o&LI)<<i:(o&LI)*Math.pow(2,i),i+=7}while(o>=XZ);return hb.bytes=s-n,t}var ZZ=Math.pow(2,7),eee=Math.pow(2,14),tee=Math.pow(2,21),ree=Math.pow(2,28),nee=Math.pow(2,35),iee=Math.pow(2,42),see=Math.pow(2,49),oee=Math.pow(2,56),aee=Math.pow(2,63),cee=function(r){return r<ZZ?1:r<eee?2:r<tee?3:r<ree?4:r<nee?5:r<iee?6:r<see?7:r<oee?8:r<aee?9:10},lee={encode:GZ,decode:JZ,encodingLength:cee},iy=lee;function fb(r,e=0){return[iy.decode(r,e),iy.decode.bytes]}function sy(r,e,t=0){return iy.encode(r,e,t),e}function oy(r){return iy.encodingLength(r)}function Wl(r,e){const t=e.byteLength,n=oy(r),i=n+oy(t),s=new Uint8Array(i+t);return sy(r,s,0),sy(t,s,n),s.set(e,i),new aS(r,t,e,s)}function uee(r){const e=rw(r),[t,n]=fb(e),[i,s]=fb(e.subarray(n)),o=e.subarray(n+s);if(o.byteLength!==i)throw new Error("Incorrect length");return new aS(t,i,o,e)}function dee(r,e){if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&BZ(r.bytes,t.bytes)}}let aS=class{constructor(e,t,n,i){u(this,"code");u(this,"size");u(this,"digest");u(this,"bytes");this.code=e,this.size=t,this.digest=n,this.bytes=i}};function BI(r,e){const{bytes:t,version:n}=r;switch(n){case 0:return fee(t,pb(r),e??Si.encoder);default:return pee(t,pb(r),e??Hg.encoder)}}const UI=new WeakMap;function pb(r){const e=UI.get(r);if(e==null){const t=new Map;return UI.set(r,t),t}return e}var nN;let iw=class Rr{constructor(e,t,n,i){u(this,"code");u(this,"version");u(this,"multihash");u(this,"bytes");u(this,"/");u(this,nN,"CID");this.code=t,this.version=e,this.multihash=n,this.bytes=i,this["/"]=i}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==wf)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==gee)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return Rr.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=Wl(e,t);return Rr.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return Rr.equals(this,e)}static equals(e,t){const n=t;return n!=null&&e.code===n.code&&e.version===n.version&&dee(e.multihash,n.multihash)}toString(e){return BI(this,e)}toJSON(){return{"/":BI(this)}}link(){return this}[(nN=Symbol.toStringTag,Symbol.for("nodejs.util.inspect.custom"))](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof Rr)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:i,multihash:s,bytes:o}=t;return new Rr(n,i,s,o??FI(n,i,s.bytes))}else if(t[yee]===!0){const{version:n,multihash:i,code:s}=t,o=uee(i);return Rr.create(n,s,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==wf)throw new Error(`Version 0 CID must use dag-pb (code: ${wf}) block encoding`);return new Rr(e,t,n,n.bytes)}case 1:{const i=FI(e,t,n.bytes);return new Rr(e,t,n,i)}default:throw new Error("Invalid version")}}static createV0(e){return Rr.create(0,wf,e)}static createV1(e,t){return Rr.create(1,e,t)}static decode(e){const[t,n]=Rr.decodeFirst(e);if(n.length!==0)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=Rr.inspectBytes(e),n=t.size-t.multihashSize,i=rw(e.subarray(n,n+t.multihashSize));if(i.byteLength!==t.multihashSize)throw new Error("Incorrect length");const s=i.subarray(t.multihashSize-t.digestSize),o=new aS(t.multihashCode,t.digestSize,s,i);return[t.version===0?Rr.createV0(o):Rr.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[h,p]=fb(e.subarray(t));return t+=p,h};let i=n(),s=wf;if(i===18?(i=0,t=0):s=n(),i!==0&&i!==1)throw new RangeError(`Invalid CID version ${i}`);const o=t,a=n(),c=n(),l=t+c,d=l-o;return{version:i,codec:s,multihashCode:a,digestSize:c,multihashSize:d,size:l}}static parse(e,t){const[n,i]=hee(e,t),s=Rr.decode(i);if(s.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return pb(s).set(n,e),s}};function hee(r,e){switch(r[0]){case"Q":{const t=e??Si;return[Si.prefix,t.decode(`${Si.prefix}${r}`)]}case Si.prefix:{const t=e??Si;return[Si.prefix,t.decode(r)]}case Hg.prefix:{const t=e??Hg;return[Hg.prefix,t.decode(r)]}case B5.prefix:{const t=e??B5;return[B5.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}}function fee(r,e,t){const{prefix:n}=t;if(n!==Si.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const i=e.get(n);if(i==null){const s=t.encode(r).slice(1);return e.set(n,s),s}else return i}function pee(r,e,t){const{prefix:n}=t,i=e.get(n);if(i==null){const s=t.encode(r);return e.set(n,s),s}else return i}const wf=112,gee=18;function FI(r,e,t){const n=oy(r),i=n+oy(e),s=new Uint8Array(i+t.byteLength);return sy(r,s,0),sy(e,s,n),s.set(t,i),s}const yee=Symbol.for("@ipld/js-cid/CID"),uB=0,mee="identity",dB=rw;function wee(r){return Wl(uB,dB(r))}const cS={code:uB,name:mee,encode:dB,digest:wee};function He(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function Ye(r=0){return new Uint8Array(r)}function Mn(r=0){return new Uint8Array(r)}function ir(r,e){e==null&&(e=r.reduce((i,s)=>i+s.length,0));const t=Mn(e);let n=0;for(const i of r)t.set(i,n),n+=i.length;return t}const hB=Symbol.for("@achingbrain/uint8arraylist");function zI(r,e){if(e==null||e<0)throw new RangeError("index is out of bounds");let t=0;for(const n of r){const i=t+n.byteLength;if(e<i)return{buf:n,index:e-t};t=i}throw new RangeError("index is out of bounds")}function Ff(r){return!!(r!=null&&r[hB])}var iN;class Ue{constructor(...e){u(this,"bufs");u(this,"length");u(this,iN,!0);this.bufs=[],this.length=0,e.length>0&&this.appendAll(e)}*[(iN=hB,Symbol.iterator)](){yield*this.bufs}get byteLength(){return this.length}append(...e){this.appendAll(e)}appendAll(e){let t=0;for(const n of e)if(n instanceof Uint8Array)t+=n.byteLength,this.bufs.push(n);else if(Ff(n))t+=n.byteLength,this.bufs.push(...n.bufs);else throw new Error("Could not append value, must be an Uint8Array or a Uint8ArrayList");this.length+=t}prepend(...e){this.prependAll(e)}prependAll(e){let t=0;for(const n of e.reverse())if(n instanceof Uint8Array)t+=n.byteLength,this.bufs.unshift(n);else if(Ff(n))t+=n.byteLength,this.bufs.unshift(...n.bufs);else throw new Error("Could not prepend value, must be an Uint8Array or a Uint8ArrayList");this.length+=t}get(e){const t=zI(this.bufs,e);return t.buf[t.index]}set(e,t){const n=zI(this.bufs,e);n.buf[n.index]=t}write(e,t=0){if(e instanceof Uint8Array)for(let n=0;n<e.length;n++)this.set(t+n,e[n]);else if(Ff(e))for(let n=0;n<e.length;n++)this.set(t+n,e.get(n));else throw new Error("Could not write value, must be an Uint8Array or a Uint8ArrayList")}consume(e){if(e=Math.trunc(e),!(Number.isNaN(e)||e<=0)){if(e===this.byteLength){this.bufs=[],this.length=0;return}for(;this.bufs.length>0;)if(e>=this.bufs[0].byteLength)e-=this.bufs[0].byteLength,this.length-=this.bufs[0].byteLength,this.bufs.shift();else{this.bufs[0]=this.bufs[0].subarray(e),this.length-=e;break}}}slice(e,t){const{bufs:n,length:i}=this._subList(e,t);return ir(n,i)}subarray(e,t){const{bufs:n,length:i}=this._subList(e,t);return n.length===1?n[0]:ir(n,i)}sublist(e,t){const{bufs:n,length:i}=this._subList(e,t),s=new Ue;return s.length=i,s.bufs=[...n],s}_subList(e,t){if(e=e??0,t=t??this.length,e<0&&(e=this.length+e),t<0&&(t=this.length+t),e<0||t>this.length)throw new RangeError("index is out of bounds");if(e===t)return{bufs:[],length:0};if(e===0&&t===this.length)return{bufs:this.bufs,length:this.length};const n=[];let i=0;for(let s=0;s<this.bufs.length;s++){const o=this.bufs[s],a=i,c=a+o.byteLength;if(i=c,e>=c)continue;const l=e>=a&&e<c,d=t>a&&t<=c;if(l&&d){if(e===a&&t===c){n.push(o);break}const h=e-a;n.push(o.subarray(h,h+(t-e)));break}if(l){if(e===0){n.push(o);continue}n.push(o.subarray(e-a));continue}if(d){if(t===c){n.push(o);break}n.push(o.subarray(0,t-a));break}n.push(o)}return{bufs:n,length:t-e}}indexOf(e,t=0){if(!Ff(e)&&!(e instanceof Uint8Array))throw new TypeError('The "value" argument must be a Uint8ArrayList or Uint8Array');const n=e instanceof Uint8Array?e:e.subarray();if(t=Number(t??0),isNaN(t)&&(t=0),t<0&&(t=this.length+t),t<0&&(t=0),e.length===0)return t>this.length?this.length:t;const i=n.byteLength;if(i===0)throw new TypeError("search must be at least 1 byte long");const s=256,o=new Int32Array(s);for(let h=0;h<s;h++)o[h]=-1;for(let h=0;h<i;h++)o[n[h]]=h;const a=o,c=this.byteLength-n.byteLength,l=n.byteLength-1;let d;for(let h=t;h<=c;h+=d){d=0;for(let p=l;p>=0;p--){const m=this.get(h+p);if(n[p]!==m){d=Math.max(1,p-a[m]);break}}if(d===0)return h}return-1}getInt8(e){const t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getInt8(0)}setInt8(e,t){const n=Mn(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setInt8(0,t),this.write(n,e)}getInt16(e,t){const n=this.subarray(e,e+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt16(0,t)}setInt16(e,t,n){const i=Ye(2);new DataView(i.buffer,i.byteOffset,i.byteLength).setInt16(0,t,n),this.write(i,e)}getInt32(e,t){const n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt32(0,t)}setInt32(e,t,n){const i=Ye(4);new DataView(i.buffer,i.byteOffset,i.byteLength).setInt32(0,t,n),this.write(i,e)}getBigInt64(e,t){const n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigInt64(0,t)}setBigInt64(e,t,n){const i=Ye(8);new DataView(i.buffer,i.byteOffset,i.byteLength).setBigInt64(0,t,n),this.write(i,e)}getUint8(e){const t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getUint8(0)}setUint8(e,t){const n=Mn(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setUint8(0,t),this.write(n,e)}getUint16(e,t){const n=this.subarray(e,e+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint16(0,t)}setUint16(e,t,n){const i=Ye(2);new DataView(i.buffer,i.byteOffset,i.byteLength).setUint16(0,t,n),this.write(i,e)}getUint32(e,t){const n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint32(0,t)}setUint32(e,t,n){const i=Ye(4);new DataView(i.buffer,i.byteOffset,i.byteLength).setUint32(0,t,n),this.write(i,e)}getBigUint64(e,t){const n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigUint64(0,t)}setBigUint64(e,t,n){const i=Ye(8);new DataView(i.buffer,i.byteOffset,i.byteLength).setBigUint64(0,t,n),this.write(i,e)}getFloat32(e,t){const n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat32(0,t)}setFloat32(e,t,n){const i=Ye(4);new DataView(i.buffer,i.byteOffset,i.byteLength).setFloat32(0,t,n),this.write(i,e)}getFloat64(e,t){const n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat64(0,t)}setFloat64(e,t,n){const i=Ye(8);new DataView(i.buffer,i.byteOffset,i.byteLength).setFloat64(0,t,n),this.write(i,e)}equals(e){if(e==null||!(e instanceof Ue)||e.bufs.length!==this.bufs.length)return!1;for(let t=0;t<this.bufs.length;t++)if(!He(this.bufs[t],e.bufs[t]))return!1;return!0}static fromUint8Arrays(e,t){const n=new Ue;return n.bufs=e,t==null&&(t=e.reduce((i,s)=>i+s.byteLength,0)),n.length=t,n}}function bee(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function vee(r){return new TextEncoder().encode(r)}function Eee(r){return new TextDecoder().decode(r)}function See(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var i=0;i<r.length;i++){var s=r.charAt(i),o=s.charCodeAt(0);if(t[o]!==255)throw new TypeError(s+" is ambiguous");t[o]=i}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),d=Math.log(256)/Math.log(a);function h(f){if(f instanceof Uint8Array||(ArrayBuffer.isView(f)?f=new Uint8Array(f.buffer,f.byteOffset,f.byteLength):Array.isArray(f)&&(f=Uint8Array.from(f))),!(f instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(f.length===0)return"";for(var g=0,v=0,y=0,w=f.length;y!==w&&f[y]===0;)y++,g++;for(var b=(w-y)*d+1>>>0,E=new Uint8Array(b);y!==w;){for(var A=f[y],k=0,x=b-1;(A!==0||k<v)&&x!==-1;x--,k++)A+=256*E[x]>>>0,E[x]=A%a>>>0,A=A/a>>>0;if(A!==0)throw new Error("Non-zero carry");v=k,y++}for(var I=b-v;I!==b&&E[I]===0;)I++;for(var T=c.repeat(g);I<b;++I)T+=r.charAt(E[I]);return T}function p(f){if(typeof f!="string")throw new TypeError("Expected String");if(f.length===0)return new Uint8Array;var g=0;if(f[g]!==" "){for(var v=0,y=0;f[g]===c;)v++,g++;for(var w=(f.length-g)*l+1>>>0,b=new Uint8Array(w);f[g];){var E=t[f.charCodeAt(g)];if(E===255)return;for(var A=0,k=w-1;(E!==0||A<y)&&k!==-1;k--,A++)E+=a*b[k]>>>0,b[k]=E%256>>>0,E=E/256>>>0;if(E!==0)throw new Error("Non-zero carry");y=A,g++}if(f[g]!==" "){for(var x=w-y;x!==w&&b[x]===0;)x++;for(var I=new Uint8Array(v+(w-x)),T=v;x!==w;)I[T++]=b[x++];return I}}}function m(f){var g=p(f);if(g)return g;throw new Error(`Non-${e} character`)}return{encode:h,decodeUnsafe:p,decode:m}}var xee=See,Aee=xee;let Cee=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseEncode");this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},Iee=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseDecode");u(this,"prefixCodePoint");this.name=e,this.prefix=t;const i=t.codePointAt(0);if(i===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=i,this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return fB(this,e)}},kee=class{constructor(e){u(this,"decoders");this.decoders=e}or(e){return fB(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};function fB(r,e){return new kee({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}let _ee=class{constructor(e,t,n,i){u(this,"name");u(this,"prefix");u(this,"baseEncode");u(this,"baseDecode");u(this,"encoder");u(this,"decoder");this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=i,this.encoder=new Cee(e,t,n),this.decoder=new Iee(e,t,i)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};function sw({name:r,prefix:e,encode:t,decode:n}){return new _ee(r,e,t,n)}function Up({name:r,prefix:e,alphabet:t}){const{encode:n,decode:i}=Aee(t,r);return sw({prefix:e,name:r,encode:n,decode:s=>bee(i(s))})}function Tee(r,e,t,n){const i={};for(let d=0;d<e.length;++d)i[e[d]]=d;let s=r.length;for(;r[s-1]==="=";)--s;const o=new Uint8Array(s*t/8|0);let a=0,c=0,l=0;for(let d=0;d<s;++d){const h=i[r[d]];if(h===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|h,a+=t,a>=8&&(a-=8,o[l++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o}function Pee(r,e,t){const n=e[e.length-1]==="=",i=(1<<t)-1;let s="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,s+=e[i&a>>o];if(o!==0&&(s+=e[i&a<<t-o]),n)for(;s.length*t&7;)s+="=";return s}function _r({name:r,prefix:e,bitsPerChar:t,alphabet:n}){return sw({prefix:e,name:r,encode(i){return Pee(i,n,t)},decode(i){return Tee(i,n,t,r)}})}const Dee=Up({prefix:"9",name:"base10",alphabet:"0123456789"}),$ee=Object.freeze(Object.defineProperty({__proto__:null,base10:Dee},Symbol.toStringTag,{value:"Module"})),Nee=_r({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),Mee=_r({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),Oee=Object.freeze(Object.defineProperty({__proto__:null,base16:Nee,base16upper:Mee},Symbol.toStringTag,{value:"Module"})),Ree=_r({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),Lee=Object.freeze(Object.defineProperty({__proto__:null,base2:Ree},Symbol.toStringTag,{value:"Module"})),pB=Array.from(""),Bee=pB.reduce((r,e,t)=>(r[t]=e,r),[]),Uee=pB.reduce((r,e,t)=>{const n=e.codePointAt(0);if(n==null)throw new Error(`Invalid character: ${e}`);return r[n]=t,r},[]);function Fee(r){return r.reduce((e,t)=>(e+=Bee[t],e),"")}function zee(r){const e=[];for(const t of r){const n=t.codePointAt(0);if(n==null)throw new Error(`Invalid character: ${t}`);const i=Uee[n];if(i==null)throw new Error(`Non-base256emoji character: ${t}`);e.push(i)}return new Uint8Array(e)}const Vee=sw({prefix:"",name:"base256emoji",encode:Fee,decode:zee}),Kee=Object.freeze(Object.defineProperty({__proto__:null,base256emoji:Vee},Symbol.toStringTag,{value:"Module"})),jee=_r({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),Hee=_r({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),qee=_r({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),Wee=_r({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),Gee=_r({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),Qee=_r({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),Yee=_r({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),Jee=_r({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),Xee=_r({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),Zee=Object.freeze(Object.defineProperty({__proto__:null,base32:jee,base32hex:Gee,base32hexpad:Yee,base32hexpadupper:Jee,base32hexupper:Qee,base32pad:qee,base32padupper:Wee,base32upper:Hee,base32z:Xee},Symbol.toStringTag,{value:"Module"})),ete=Up({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),tte=Up({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),rte=Object.freeze(Object.defineProperty({__proto__:null,base36:ete,base36upper:tte},Symbol.toStringTag,{value:"Module"})),nte=Up({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),ite=Up({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),ste=Object.freeze(Object.defineProperty({__proto__:null,base58btc:nte,base58flickr:ite},Symbol.toStringTag,{value:"Module"})),ote=_r({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),ate=_r({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),cte=_r({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),lte=_r({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),ute=Object.freeze(Object.defineProperty({__proto__:null,base64:ote,base64pad:ate,base64url:cte,base64urlpad:lte},Symbol.toStringTag,{value:"Module"})),dte=_r({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),hte=Object.freeze(Object.defineProperty({__proto__:null,base8:dte},Symbol.toStringTag,{value:"Module"})),fte=sw({prefix:"\0",name:"identity",encode:r=>Eee(r),decode:r=>vee(r)}),pte=Object.freeze(Object.defineProperty({__proto__:null,identity:fte},Symbol.toStringTag,{value:"Module"}));new TextEncoder;new TextDecoder;const VI={...pte,...Lee,...hte,...$ee,...Oee,...Zee,...rte,...ste,...ute,...Kee};function gB(r,e,t,n){return{name:r,prefix:e,encoder:{name:r,prefix:e,encode:t},decoder:{decode:n}}}const KI=gB("utf8","u",r=>"u"+new TextDecoder("utf8").decode(r),r=>new TextEncoder().encode(r.substring(1))),U5=gB("ascii","a",r=>{let e="a";for(let t=0;t<r.length;t++)e+=String.fromCharCode(r[t]);return e},r=>{r=r.substring(1);const e=Mn(r.length);for(let t=0;t<r.length;t++)e[t]=r.charCodeAt(t);return e}),yB={utf8:KI,"utf-8":KI,hex:VI.base16,latin1:U5,ascii:U5,binary:U5,...VI};function oe(r,e="utf8"){const t=yB[e];if(t==null)throw new Error(`Unsupported encoding "${e}"`);return t.decoder.decode(`${t.prefix}${r}`)}function re(r,e="utf8"){const t=yB[e];if(t==null)throw new Error(`Unsupported encoding "${e}"`);return t.encoder.encode(r).substring(1)}const gte=parseInt("11111",2),gb=parseInt("10000000",2),yte=parseInt("01111111",2),jI={0:bf,1:bf,2:mte,3:vte,4:Ete,5:bte,6:wte,16:bf,22:bf,48:bf};function Uc(r,e={offset:0}){const t=r[e.offset]&gte;if(e.offset++,jI[t]!=null)return jI[t](r,e);throw new Error("No decoder for tag "+t)}function Fp(r,e){let t=0;if((r[e.offset]&gb)===gb){const n=r[e.offset]&yte;let i="0x";e.offset++;for(let s=0;s<n;s++,e.offset++)i+=r[e.offset].toString(16).padStart(2,"0");t=parseInt(i,16)}else t=r[e.offset],e.offset++;return t}function bf(r,e){Fp(r,e);const t=[];for(;!(e.offset>=r.byteLength);){const n=Uc(r,e);if(n===null)break;t.push(n)}return t}function mte(r,e){const t=Fp(r,e),n=e.offset,i=e.offset+t,s=[];for(let o=n;o<i;o++)o===n&&r[o]===0||s.push(r[o]);return e.offset+=t,Uint8Array.from(s)}function wte(r,e){const t=Fp(r,e),n=e.offset+t,i=r[e.offset];e.offset++;let s=0,o=0;i<40?(s=0,o=i):i<80?(s=1,o=i-40):(s=2,o=i-80);let a=`${s}.${o}`,c=[];for(;e.offset<n;){const l=r[e.offset];if(e.offset++,c.push(l&127),l<128){c.reverse();let d=0;for(let h=0;h<c.length;h++)d+=c[h]<<h*7;a+=`.${d}`,c=[]}}return a}function bte(r,e){return e.offset++,null}function vte(r,e){const t=Fp(r,e),n=r[e.offset];e.offset++;const i=r.subarray(e.offset,e.offset+t-1);if(e.offset+=t,n!==0)throw new Error("Unused bits in bit string is unimplemented");return i}function Ete(r,e){const t=Fp(r,e),n=r.subarray(e.offset,e.offset+t);return e.offset+=t,n}function Ste(r){let e=r.toString(16);e.length%2===1&&(e="0"+e);const t=new Ue;for(let n=0;n<e.length;n+=2)t.append(Uint8Array.from([parseInt(`${e[n]}${e[n+1]}`,16)]));return t}function ow(r){if(r.byteLength<128)return Uint8Array.from([r.byteLength]);const e=Ste(r.byteLength);return new Ue(Uint8Array.from([e.byteLength|gb]),e)}function jn(r){const e=new Ue,t=128;return(r.subarray()[0]&t)===t&&e.append(Uint8Array.from([0])),e.append(r),new Ue(Uint8Array.from([2]),ow(e),e)}function lS(r){const e=Uint8Array.from([0]),t=new Ue(e,r);return new Ue(Uint8Array.from([3]),ow(t),t)}function xte(r){return new Ue(Uint8Array.from([4]),ow(r),r)}function Po(r,e=48){const t=new Ue;for(const n of r)t.append(n);return new Ue(Uint8Array.from([e]),ow(t),t)}const mB="1.2.840.10045.3.1.7",wB="1.3.132.0.34",bB="1.3.132.0.35";async function Ate(r="P-256"){const e=await crypto.subtle.generateKey({name:"ECDSA",namedCurve:r},!0,["sign","verify"]);return{publicKey:await crypto.subtle.exportKey("jwk",e.publicKey),privateKey:await crypto.subtle.exportKey("jwk",e.privateKey)}}async function Cte(r,e){const t=await crypto.subtle.importKey("jwk",r,{name:"ECDSA",namedCurve:r.crv??"P-256"},!1,["sign"]),n=await crypto.subtle.sign({name:"ECDSA",hash:{name:"SHA-256"}},t,e.subarray());return new Uint8Array(n,0,n.byteLength)}async function Ite(r,e,t){const n=await crypto.subtle.importKey("jwk",r,{name:"ECDSA",namedCurve:r.crv??"P-256"},!1,["verify"]);return crypto.subtle.verify({name:"ECDSA",hash:{name:"SHA-256"}},n,e,t.subarray())}const kte=Uint8Array.from([6,8,42,134,72,206,61,3,1,7]),_te=Uint8Array.from([6,5,43,129,4,0,34]),Tte=Uint8Array.from([6,5,43,129,4,0,35]),vB={ext:!0,kty:"EC",crv:"P-256"},EB={ext:!0,kty:"EC",crv:"P-384"},SB={ext:!0,kty:"EC",crv:"P-521"},yd=32,md=48,wd=66;function Pte(r){const e=Uc(r);return xB(e)}function xB(r){const e=r[1],t=re(e,"base64url"),n=r[2][1][0],i=1;let s,o;if(e.byteLength===yd)return s=re(n.subarray(i,i+yd),"base64url"),o=re(n.subarray(i+yd),"base64url"),new Wg({...vB,key_ops:["sign"],d:t,x:s,y:o});if(e.byteLength===md)return s=re(n.subarray(i,i+md),"base64url"),o=re(n.subarray(i+md),"base64url"),new Wg({...EB,key_ops:["sign"],d:t,x:s,y:o});if(e.byteLength===wd)return s=re(n.subarray(i,i+wd),"base64url"),o=re(n.subarray(i+wd),"base64url"),new Wg({...SB,key_ops:["sign"],d:t,x:s,y:o});throw new Z(`Private key length was wrong length, got ${e.byteLength}, expected 32, 48 or 66`)}function AB(r){const e=Uc(r);return CB(e)}function CB(r){const e=r[1][1][0],t=1;let n,i;if(e.byteLength===yd*2+1)return n=re(e.subarray(t,t+yd),"base64url"),i=re(e.subarray(t+yd),"base64url"),new qg({...vB,key_ops:["verify"],x:n,y:i});if(e.byteLength===md*2+1)return n=re(e.subarray(t,t+md),"base64url"),i=re(e.subarray(t+md),"base64url"),new qg({...EB,key_ops:["verify"],x:n,y:i});if(e.byteLength===wd*2+1)return n=re(e.subarray(t,t+wd),"base64url"),i=re(e.subarray(t+wd),"base64url"),new qg({...SB,key_ops:["verify"],x:n,y:i});throw new Z(`coordinates were wrong length, got ${e.byteLength}, expected 65, 97 or 133`)}function Dte(r){return Po([jn(Uint8Array.from([1])),xte(oe(r.d??"","base64url")),Po([IB(r.crv)],160),Po([lS(new Ue(Uint8Array.from([4]),oe(r.x??"","base64url"),oe(r.y??"","base64url")))],161)]).subarray()}function $te(r){return Po([jn(Uint8Array.from([1])),Po([IB(r.crv)],160),Po([lS(new Ue(Uint8Array.from([4]),oe(r.x??"","base64url"),oe(r.y??"","base64url")))],161)]).subarray()}function IB(r){if(r==="P-256")return kte;if(r==="P-384")return _te;if(r==="P-521")return Tte;throw new Z(`Invalid curve ${r}`)}async function Nte(r="P-256"){const e=await Ate(r);return new Wg(e.privateKey)}class qg{constructor(e){u(this,"type","ECDSA");u(this,"jwk");u(this,"_raw");this.jwk=e}get raw(){return this._raw==null&&(this._raw=$te(this.jwk)),this._raw}toMultihash(){return cS.digest(Pi(this))}toCID(){return iw.createV1(114,this.toMultihash())}toString(){return Si.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:He(this.raw,e.raw)}async verify(e,t){return Ite(this.jwk,t,e)}}class Wg{constructor(e){u(this,"type","ECDSA");u(this,"jwk");u(this,"publicKey");u(this,"_raw");this.jwk=e,this.publicKey=new qg({crv:e.crv,ext:e.ext,key_ops:["verify"],kty:"EC",x:e.x,y:e.y})}get raw(){return this._raw==null&&(this._raw=Dte(this.jwk)),this._raw}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:He(this.raw,e.raw)}async sign(e){return Cte(this.jwk,e)}}function HI(r){if(!Number.isSafeInteger(r)||r<0)throw new Error("positive integer expected, got "+r)}function Mte(r){return r instanceof Uint8Array||ArrayBuffer.isView(r)&&r.constructor.name==="Uint8Array"}function aw(r,...e){if(!Mte(r))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(r.length))throw new Error("Uint8Array expected of length "+e+", got length="+r.length)}function Ote(r){if(typeof r!="function"||typeof r.create!="function")throw new Error("Hash should be wrapped by utils.wrapConstructor");HI(r.outputLen),HI(r.blockLen)}function ay(r,e=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(e&&r.finished)throw new Error("Hash#digest() has already been called")}function Rte(r,e){aw(r);const t=e.outputLen;if(r.length<t)throw new Error("digestInto() expects output buffer of length at least "+t)}const Ou=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */function F5(r){return new DataView(r.buffer,r.byteOffset,r.byteLength)}function Cs(r,e){return r<<32-e|r>>>e}typeof Uint8Array.from([]).toHex=="function"&&Uint8Array.fromHex;function Lte(r){if(typeof r!="string")throw new Error("utf8ToBytes expected string, got "+typeof r);return new Uint8Array(new TextEncoder().encode(r))}function uS(r){return typeof r=="string"&&(r=Lte(r)),aw(r),r}function Bte(...r){let e=0;for(let n=0;n<r.length;n++){const i=r[n];aw(i),e+=i.length}const t=new Uint8Array(e);for(let n=0,i=0;n<r.length;n++){const s=r[n];t.set(s,i),i+=s.length}return t}let kB=class{clone(){return this._cloneInto()}};function _B(r){const e=n=>r().update(uS(n)).digest(),t=r();return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=()=>r(),e}function dS(r=32){if(Ou&&typeof Ou.getRandomValues=="function")return Ou.getRandomValues(new Uint8Array(r));if(Ou&&typeof Ou.randomBytes=="function")return Uint8Array.from(Ou.randomBytes(r));throw new Error("crypto.getRandomValues must be defined")}function Ute(r,e,t,n){if(typeof r.setBigUint64=="function")return r.setBigUint64(e,t,n);const i=BigInt(32),s=BigInt(4294967295),o=Number(t>>i&s),a=Number(t&s),c=n?4:0,l=n?0:4;r.setUint32(e+c,o,n),r.setUint32(e+l,a,n)}function Fte(r,e,t){return r&e^~r&t}function zte(r,e,t){return r&e^r&t^e&t}let TB=class extends kB{constructor(e,t,n,i){super(),this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.blockLen=e,this.outputLen=t,this.padOffset=n,this.isLE=i,this.buffer=new Uint8Array(e),this.view=F5(this.buffer)}update(e){ay(this);const{view:t,buffer:n,blockLen:i}=this;e=uS(e);const s=e.length;for(let o=0;o<s;){const a=Math.min(i-this.pos,s-o);if(a===i){const c=F5(e);for(;i<=s-o;o+=i)this.process(c,o);continue}n.set(e.subarray(o,o+a),this.pos),this.pos+=a,o+=a,this.pos===i&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){ay(this),Rte(e,this),this.finished=!0;const{buffer:t,view:n,blockLen:i,isLE:s}=this;let{pos:o}=this;t[o++]=128,this.buffer.subarray(o).fill(0),this.padOffset>i-o&&(this.process(n,0),o=0);for(let h=o;h<i;h++)t[h]=0;Ute(n,i-8,BigInt(this.length*8),s),this.process(n,0);const a=F5(e),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const l=c/4,d=this.get();if(l>d.length)throw new Error("_sha2: outputLen bigger than state");for(let h=0;h<l;h++)a.setUint32(4*h,d[h],s)}digest(){const{buffer:e,outputLen:t}=this;this.digestInto(e);const n=e.slice(0,t);return this.destroy(),n}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());const{blockLen:t,buffer:n,length:i,finished:s,destroyed:o,pos:a}=this;return e.length=i,e.pos=a,e.finished=s,e.destroyed=o,i%t&&e.buffer.set(n),e}};const Vte=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),ma=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),wa=new Uint32Array(64);let Kte=class extends TB{constructor(e=32){super(64,e,8,!1),this.A=ma[0]|0,this.B=ma[1]|0,this.C=ma[2]|0,this.D=ma[3]|0,this.E=ma[4]|0,this.F=ma[5]|0,this.G=ma[6]|0,this.H=ma[7]|0}get(){const{A:e,B:t,C:n,D:i,E:s,F:o,G:a,H:c}=this;return[e,t,n,i,s,o,a,c]}set(e,t,n,i,s,o,a,c){this.A=e|0,this.B=t|0,this.C=n|0,this.D=i|0,this.E=s|0,this.F=o|0,this.G=a|0,this.H=c|0}process(e,t){for(let h=0;h<16;h++,t+=4)wa[h]=e.getUint32(t,!1);for(let h=16;h<64;h++){const p=wa[h-15],m=wa[h-2],f=Cs(p,7)^Cs(p,18)^p>>>3,g=Cs(m,17)^Cs(m,19)^m>>>10;wa[h]=g+wa[h-7]+f+wa[h-16]|0}let{A:n,B:i,C:s,D:o,E:a,F:c,G:l,H:d}=this;for(let h=0;h<64;h++){const p=Cs(a,6)^Cs(a,11)^Cs(a,25),m=d+p+Fte(a,c,l)+Vte[h]+wa[h]|0,g=(Cs(n,2)^Cs(n,13)^Cs(n,22))+zte(n,i,s)|0;d=l,l=c,c=a,a=o+m|0,o=s,s=i,i=n,n=m+g|0}n=n+this.A|0,i=i+this.B|0,s=s+this.C|0,o=o+this.D|0,a=a+this.E|0,c=c+this.F|0,l=l+this.G|0,d=d+this.H|0,this.set(n,i,s,o,a,c,l,d)}roundClean(){wa.fill(0)}destroy(){this.set(0,0,0,0,0,0,0,0),this.buffer.fill(0)}};const jte=_B(()=>new Kte),j0=BigInt(2**32-1),yb=BigInt(32);function PB(r,e=!1){return e?{h:Number(r&j0),l:Number(r>>yb&j0)}:{h:Number(r>>yb&j0)|0,l:Number(r&j0)|0}}function Hte(r,e=!1){let t=new Uint32Array(r.length),n=new Uint32Array(r.length);for(let i=0;i<r.length;i++){const{h:s,l:o}=PB(r[i],e);[t[i],n[i]]=[s,o]}return[t,n]}const qte=(r,e)=>BigInt(r>>>0)<<yb|BigInt(e>>>0),Wte=(r,e,t)=>r>>>t,Gte=(r,e,t)=>r<<32-t|e>>>t,Qte=(r,e,t)=>r>>>t|e<<32-t,Yte=(r,e,t)=>r<<32-t|e>>>t,Jte=(r,e,t)=>r<<64-t|e>>>t-32,Xte=(r,e,t)=>r>>>t-32|e<<64-t,Zte=(r,e)=>e,ere=(r,e)=>r,tre=(r,e,t)=>r<<t|e>>>32-t,rre=(r,e,t)=>e<<t|r>>>32-t,nre=(r,e,t)=>e<<t-32|r>>>64-t,ire=(r,e,t)=>r<<t-32|e>>>64-t;function sre(r,e,t,n){const i=(e>>>0)+(n>>>0);return{h:r+t+(i/2**32|0)|0,l:i|0}}const ore=(r,e,t)=>(r>>>0)+(e>>>0)+(t>>>0),are=(r,e,t,n)=>e+t+n+(r/2**32|0)|0,cre=(r,e,t,n)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0),lre=(r,e,t,n,i)=>e+t+n+i+(r/2**32|0)|0,ure=(r,e,t,n,i)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0)+(i>>>0),dre=(r,e,t,n,i,s)=>e+t+n+i+s+(r/2**32|0)|0,Ke={fromBig:PB,split:Hte,toBig:qte,shrSH:Wte,shrSL:Gte,rotrSH:Qte,rotrSL:Yte,rotrBH:Jte,rotrBL:Xte,rotr32H:Zte,rotr32L:ere,rotlSH:tre,rotlSL:rre,rotlBH:nre,rotlBL:ire,add:sre,add3L:ore,add3H:are,add4L:cre,add4H:lre,add5H:dre,add5L:ure},[hre,fre]=Ke.split(["0x428a2f98d728ae22","0x7137449123ef65cd","0xb5c0fbcfec4d3b2f","0xe9b5dba58189dbbc","0x3956c25bf348b538","0x59f111f1b605d019","0x923f82a4af194f9b","0xab1c5ed5da6d8118","0xd807aa98a3030242","0x12835b0145706fbe","0x243185be4ee4b28c","0x550c7dc3d5ffb4e2","0x72be5d74f27b896f","0x80deb1fe3b1696b1","0x9bdc06a725c71235","0xc19bf174cf692694","0xe49b69c19ef14ad2","0xefbe4786384f25e3","0x0fc19dc68b8cd5b5","0x240ca1cc77ac9c65","0x2de92c6f592b0275","0x4a7484aa6ea6e483","0x5cb0a9dcbd41fbd4","0x76f988da831153b5","0x983e5152ee66dfab","0xa831c66d2db43210","0xb00327c898fb213f","0xbf597fc7beef0ee4","0xc6e00bf33da88fc2","0xd5a79147930aa725","0x06ca6351e003826f","0x142929670a0e6e70","0x27b70a8546d22ffc","0x2e1b21385c26c926","0x4d2c6dfc5ac42aed","0x53380d139d95b3df","0x650a73548baf63de","0x766a0abb3c77b2a8","0x81c2c92e47edaee6","0x92722c851482353b","0xa2bfe8a14cf10364","0xa81a664bbc423001","0xc24b8b70d0f89791","0xc76c51a30654be30","0xd192e819d6ef5218","0xd69906245565a910","0xf40e35855771202a","0x106aa07032bbd1b8","0x19a4c116b8d2d0c8","0x1e376c085141ab53","0x2748774cdf8eeb99","0x34b0bcb5e19b48a8","0x391c0cb3c5c95a63","0x4ed8aa4ae3418acb","0x5b9cca4f7763e373","0x682e6ff3d6b2b8a3","0x748f82ee5defb2fc","0x78a5636f43172f60","0x84c87814a1f0ab72","0x8cc702081a6439ec","0x90befffa23631e28","0xa4506cebde82bde9","0xbef9a3f7b2c67915","0xc67178f2e372532b","0xca273eceea26619c","0xd186b8c721c0c207","0xeada7dd6cde0eb1e","0xf57d4f7fee6ed178","0x06f067aa72176fba","0x0a637dc5a2c898a6","0x113f9804bef90dae","0x1b710b35131c471b","0x28db77f523047d84","0x32caab7b40c72493","0x3c9ebe0a15c9bebc","0x431d67c49c100d4c","0x4cc5d4becb3e42b6","0x597f299cfc657e2a","0x5fcb6fab3ad6faec","0x6c44198c4a475817"].map(r=>BigInt(r))),ba=new Uint32Array(80),va=new Uint32Array(80);let pre=class extends TB{constructor(e=64){super(128,e,16,!1),this.Ah=1779033703,this.Al=-205731576,this.Bh=-1150833019,this.Bl=-2067093701,this.Ch=1013904242,this.Cl=-23791573,this.Dh=-1521486534,this.Dl=1595750129,this.Eh=1359893119,this.El=-1377402159,this.Fh=-1694144372,this.Fl=725511199,this.Gh=528734635,this.Gl=-79577749,this.Hh=1541459225,this.Hl=327033209}get(){const{Ah:e,Al:t,Bh:n,Bl:i,Ch:s,Cl:o,Dh:a,Dl:c,Eh:l,El:d,Fh:h,Fl:p,Gh:m,Gl:f,Hh:g,Hl:v}=this;return[e,t,n,i,s,o,a,c,l,d,h,p,m,f,g,v]}set(e,t,n,i,s,o,a,c,l,d,h,p,m,f,g,v){this.Ah=e|0,this.Al=t|0,this.Bh=n|0,this.Bl=i|0,this.Ch=s|0,this.Cl=o|0,this.Dh=a|0,this.Dl=c|0,this.Eh=l|0,this.El=d|0,this.Fh=h|0,this.Fl=p|0,this.Gh=m|0,this.Gl=f|0,this.Hh=g|0,this.Hl=v|0}process(e,t){for(let b=0;b<16;b++,t+=4)ba[b]=e.getUint32(t),va[b]=e.getUint32(t+=4);for(let b=16;b<80;b++){const E=ba[b-15]|0,A=va[b-15]|0,k=Ke.rotrSH(E,A,1)^Ke.rotrSH(E,A,8)^Ke.shrSH(E,A,7),x=Ke.rotrSL(E,A,1)^Ke.rotrSL(E,A,8)^Ke.shrSL(E,A,7),I=ba[b-2]|0,T=va[b-2]|0,L=Ke.rotrSH(I,T,19)^Ke.rotrBH(I,T,61)^Ke.shrSH(I,T,6),z=Ke.rotrSL(I,T,19)^Ke.rotrBL(I,T,61)^Ke.shrSL(I,T,6),B=Ke.add4L(x,z,va[b-7],va[b-16]),G=Ke.add4H(B,k,L,ba[b-7],ba[b-16]);ba[b]=G|0,va[b]=B|0}let{Ah:n,Al:i,Bh:s,Bl:o,Ch:a,Cl:c,Dh:l,Dl:d,Eh:h,El:p,Fh:m,Fl:f,Gh:g,Gl:v,Hh:y,Hl:w}=this;for(let b=0;b<80;b++){const E=Ke.rotrSH(h,p,14)^Ke.rotrSH(h,p,18)^Ke.rotrBH(h,p,41),A=Ke.rotrSL(h,p,14)^Ke.rotrSL(h,p,18)^Ke.rotrBL(h,p,41),k=h&m^~h&g,x=p&f^~p&v,I=Ke.add5L(w,A,x,fre[b],va[b]),T=Ke.add5H(I,y,E,k,hre[b],ba[b]),L=I|0,z=Ke.rotrSH(n,i,28)^Ke.rotrBH(n,i,34)^Ke.rotrBH(n,i,39),B=Ke.rotrSL(n,i,28)^Ke.rotrBL(n,i,34)^Ke.rotrBL(n,i,39),G=n&s^n&a^s&a,j=i&o^i&c^o&c;y=g|0,w=v|0,g=m|0,v=f|0,m=h|0,f=p|0,{h,l:p}=Ke.add(l|0,d|0,T|0,L|0),l=a|0,d=c|0,a=s|0,c=o|0,s=n|0,o=i|0;const q=Ke.add3L(L,B,j);n=Ke.add3H(q,T,z,G),i=q|0}({h:n,l:i}=Ke.add(this.Ah|0,this.Al|0,n|0,i|0)),{h:s,l:o}=Ke.add(this.Bh|0,this.Bl|0,s|0,o|0),{h:a,l:c}=Ke.add(this.Ch|0,this.Cl|0,a|0,c|0),{h:l,l:d}=Ke.add(this.Dh|0,this.Dl|0,l|0,d|0),{h,l:p}=Ke.add(this.Eh|0,this.El|0,h|0,p|0),{h:m,l:f}=Ke.add(this.Fh|0,this.Fl|0,m|0,f|0),{h:g,l:v}=Ke.add(this.Gh|0,this.Gl|0,g|0,v|0),{h:y,l:w}=Ke.add(this.Hh|0,this.Hl|0,y|0,w|0),this.set(n,i,s,o,a,c,l,d,h,p,m,f,g,v,y,w)}roundClean(){ba.fill(0),va.fill(0)}destroy(){this.buffer.fill(0),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}};const gre=_B(()=>new pre);/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const hS=BigInt(0),mb=BigInt(1);function qd(r){return r instanceof Uint8Array||ArrayBuffer.isView(r)&&r.constructor.name==="Uint8Array"}function fS(r){if(!qd(r))throw new Error("Uint8Array expected")}function dc(r,e){if(typeof e!="boolean")throw new Error(r+" boolean expected, got "+e)}function H0(r){const e=r.toString(16);return e.length&1?"0"+e:e}function DB(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);return r===""?hS:BigInt("0x"+r)}const $B=typeof Uint8Array.from([]).toHex=="function"&&typeof Uint8Array.fromHex=="function",yre=Array.from({length:256},(r,e)=>e.toString(16).padStart(2,"0"));function Wd(r){if(fS(r),$B)return r.toHex();let e="";for(let t=0;t<r.length;t++)e+=yre[r[t]];return e}const ao={_0:48,_9:57,A:65,F:70,a:97,f:102};function qI(r){if(r>=ao._0&&r<=ao._9)return r-ao._0;if(r>=ao.A&&r<=ao.F)return r-(ao.A-10);if(r>=ao.a&&r<=ao.f)return r-(ao.a-10)}function cy(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);if($B)return Uint8Array.fromHex(r);const e=r.length,t=e/2;if(e%2)throw new Error("hex string expected, got unpadded hex of length "+e);const n=new Uint8Array(t);for(let i=0,s=0;i<t;i++,s+=2){const o=qI(r.charCodeAt(s)),a=qI(r.charCodeAt(s+1));if(o===void 0||a===void 0){const c=r[s]+r[s+1];throw new Error('hex string expected, got non-hex character "'+c+'" at index '+s)}n[i]=o*16+a}return n}function Pl(r){return DB(Wd(r))}function Dl(r){return fS(r),DB(Wd(Uint8Array.from(r).reverse()))}function z1(r,e){return cy(r.toString(16).padStart(e*2,"0"))}function V1(r,e){return z1(r,e).reverse()}function jt(r,e,t){let n;if(typeof e=="string")try{n=cy(e)}catch(s){throw new Error(r+" must be hex string or Uint8Array, cause: "+s)}else if(qd(e))n=Uint8Array.from(e);else throw new Error(r+" must be hex string or Uint8Array");const i=n.length;if(typeof t=="number"&&i!==t)throw new Error(r+" of length "+t+" expected, got "+i);return n}function Gd(...r){let e=0;for(let n=0;n<r.length;n++){const i=r[n];fS(i),e+=i.length}const t=new Uint8Array(e);for(let n=0,i=0;n<r.length;n++){const s=r[n];t.set(s,i),i+=s.length}return t}const z5=r=>typeof r=="bigint"&&hS<=r;function pS(r,e,t){return z5(r)&&z5(e)&&z5(t)&&e<=r&&r<t}function Gn(r,e,t,n){if(!pS(e,t,n))throw new Error("expected valid "+r+": "+t+" <= n < "+n+", got "+e)}function mre(r){let e;for(e=0;r>hS;r>>=mb,e+=1);return e}const cw=r=>(mb<<BigInt(r))-mb,V5=r=>new Uint8Array(r),WI=r=>Uint8Array.from(r);function wre(r,e,t){if(typeof r!="number"||r<2)throw new Error("hashLen must be a number");if(typeof e!="number"||e<2)throw new Error("qByteLen must be a number");if(typeof t!="function")throw new Error("hmacFn must be a function");let n=V5(r),i=V5(r),s=0;const o=()=>{n.fill(1),i.fill(0),s=0},a=(...h)=>t(i,n,...h),c=(h=V5(0))=>{i=a(WI([0]),h),n=a(),h.length!==0&&(i=a(WI([1]),h),n=a())},l=()=>{if(s++>=1e3)throw new Error("drbg: tried 1000 values");let h=0;const p=[];for(;h<e;){n=a();const m=n.slice();p.push(m),h+=n.length}return Gd(...p)};return(h,p)=>{o(),c(h);let m;for(;!(m=p(l()));)c();return o(),m}}const bre={bigint:r=>typeof r=="bigint",function:r=>typeof r=="function",boolean:r=>typeof r=="boolean",string:r=>typeof r=="string",stringOrUint8Array:r=>typeof r=="string"||qd(r),isSafeInteger:r=>Number.isSafeInteger(r),array:r=>Array.isArray(r),field:(r,e)=>e.Fp.isValid(r),hash:r=>typeof r=="function"&&Number.isSafeInteger(r.outputLen)};function Nh(r,e,t={}){const n=(i,s,o)=>{const a=bre[s];if(typeof a!="function")throw new Error("invalid validator function");const c=r[i];if(!(o&&c===void 0)&&!a(c,r))throw new Error("param "+String(i)+" is invalid. Expected "+s+", got "+c)};for(const[i,s]of Object.entries(e))n(i,s,!1);for(const[i,s]of Object.entries(t))n(i,s,!0);return r}function ly(r){const e=new WeakMap;return(t,...n)=>{const i=e.get(t);if(i!==void 0)return i;const s=r(t,...n);return e.set(t,s),s}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const dr=BigInt(0),Bt=BigInt(1),cl=BigInt(2),vre=BigInt(3),wb=BigInt(4),GI=BigInt(5),QI=BigInt(8);function St(r,e){const t=r%e;return t>=dr?t:e+t}function NB(r,e,t){if(e<dr)throw new Error("invalid exponent, negatives unsupported");if(t<=dr)throw new Error("invalid modulus");if(t===Bt)return dr;let n=Bt;for(;e>dr;)e&Bt&&(n=n*r%t),r=r*r%t,e>>=Bt;return n}function Rt(r,e,t){let n=r;for(;e-- >dr;)n*=n,n%=t;return n}function bb(r,e){if(r===dr)throw new Error("invert: expected non-zero number");if(e<=dr)throw new Error("invert: expected positive modulus, got "+e);let t=St(r,e),n=e,i=dr,s=Bt;for(;t!==dr;){const a=n/t,c=n%t,l=i-s*a;n=t,t=c,i=s,s=l}if(n!==Bt)throw new Error("invert: does not exist");return St(i,e)}function Ere(r){const e=(r-Bt)/cl;let t,n,i;for(t=r-Bt,n=0;t%cl===dr;t/=cl,n++);for(i=cl;i<r&&NB(i,e,r)!==r-Bt;i++)if(i>1e3)throw new Error("Cannot find square root: likely non-prime P");if(n===1){const o=(r+Bt)/wb;return function(c,l){const d=c.pow(l,o);if(!c.eql(c.sqr(d),l))throw new Error("Cannot find square root");return d}}const s=(t+Bt)/cl;return function(a,c){if(a.pow(c,e)===a.neg(a.ONE))throw new Error("Cannot find square root");let l=n,d=a.pow(a.mul(a.ONE,i),t),h=a.pow(c,s),p=a.pow(c,t);for(;!a.eql(p,a.ONE);){if(a.eql(p,a.ZERO))return a.ZERO;let m=1;for(let g=a.sqr(p);m<l&&!a.eql(g,a.ONE);m++)g=a.sqr(g);const f=a.pow(d,Bt<<BigInt(l-m-1));d=a.sqr(f),h=a.mul(h,f),p=a.mul(p,d),l=m}return h}}function Sre(r){if(r%wb===vre){const e=(r+Bt)/wb;return function(n,i){const s=n.pow(i,e);if(!n.eql(n.sqr(s),i))throw new Error("Cannot find square root");return s}}if(r%QI===GI){const e=(r-GI)/QI;return function(n,i){const s=n.mul(i,cl),o=n.pow(s,e),a=n.mul(i,o),c=n.mul(n.mul(a,cl),o),l=n.mul(a,n.sub(c,n.ONE));if(!n.eql(n.sqr(l),i))throw new Error("Cannot find square root");return l}}return Ere(r)}const xre=(r,e)=>(St(r,e)&Bt)===Bt,Are=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function Cre(r){const e={ORDER:"bigint",MASK:"bigint",BYTES:"isSafeInteger",BITS:"isSafeInteger"},t=Are.reduce((n,i)=>(n[i]="function",n),e);return Nh(r,t)}function Ire(r,e,t){if(t<dr)throw new Error("invalid exponent, negatives unsupported");if(t===dr)return r.ONE;if(t===Bt)return e;let n=r.ONE,i=e;for(;t>dr;)t&Bt&&(n=r.mul(n,i)),i=r.sqr(i),t>>=Bt;return n}function kre(r,e){const t=new Array(e.length),n=e.reduce((s,o,a)=>r.is0(o)?s:(t[a]=s,r.mul(s,o)),r.ONE),i=r.inv(n);return e.reduceRight((s,o,a)=>r.is0(o)?s:(t[a]=r.mul(s,t[a]),r.mul(s,o)),i),t}function MB(r,e){const t=e!==void 0?e:r.toString(2).length,n=Math.ceil(t/8);return{nBitLength:t,nByteLength:n}}function lw(r,e,t=!1,n={}){if(r<=dr)throw new Error("invalid field: expected ORDER > 0, got "+r);const{nBitLength:i,nByteLength:s}=MB(r,e);if(s>2048)throw new Error("invalid field: expected ORDER of <= 2048 bytes");let o;const a=Object.freeze({ORDER:r,isLE:t,BITS:i,BYTES:s,MASK:cw(i),ZERO:dr,ONE:Bt,create:c=>St(c,r),isValid:c=>{if(typeof c!="bigint")throw new Error("invalid field element: expected bigint, got "+typeof c);return dr<=c&&c<r},is0:c=>c===dr,isOdd:c=>(c&Bt)===Bt,neg:c=>St(-c,r),eql:(c,l)=>c===l,sqr:c=>St(c*c,r),add:(c,l)=>St(c+l,r),sub:(c,l)=>St(c-l,r),mul:(c,l)=>St(c*l,r),pow:(c,l)=>Ire(a,c,l),div:(c,l)=>St(c*bb(l,r),r),sqrN:c=>c*c,addN:(c,l)=>c+l,subN:(c,l)=>c-l,mulN:(c,l)=>c*l,inv:c=>bb(c,r),sqrt:n.sqrt||(c=>(o||(o=Sre(r)),o(a,c))),invertBatch:c=>kre(a,c),cmov:(c,l,d)=>d?l:c,toBytes:c=>t?V1(c,s):z1(c,s),fromBytes:c=>{if(c.length!==s)throw new Error("Field.fromBytes: expected "+s+" bytes, got "+c.length);return t?Dl(c):Pl(c)}});return Object.freeze(a)}function OB(r){if(typeof r!="bigint")throw new Error("field order must be bigint");const e=r.toString(2).length;return Math.ceil(e/8)}function RB(r){const e=OB(r);return e+Math.ceil(e/2)}function _re(r,e,t=!1){const n=r.length,i=OB(e),s=RB(e);if(n<16||n<s||n>1024)throw new Error("expected "+s+"-1024 bytes of input, got "+n);const o=t?Dl(r):Pl(r),a=St(o,e-Bt)+Bt;return t?V1(a,i):z1(a,i)}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const YI=BigInt(0),vb=BigInt(1);function K5(r,e){const t=e.negate();return r?t:e}function LB(r,e){if(!Number.isSafeInteger(r)||r<=0||r>e)throw new Error("invalid window size, expected [1.."+e+"], got W="+r)}function j5(r,e){LB(r,e);const t=Math.ceil(e/r)+1,n=2**(r-1),i=2**r,s=cw(r),o=BigInt(r);return{windows:t,windowSize:n,mask:s,maxNumber:i,shiftBy:o}}function JI(r,e,t){const{windowSize:n,mask:i,maxNumber:s,shiftBy:o}=t;let a=Number(r&i),c=r>>o;a>n&&(a-=s,c+=vb);const l=e*n,d=l+Math.abs(a)-1,h=a===0,p=a<0,m=e%2!==0;return{nextN:c,offset:d,isZero:h,isNeg:p,isNegF:m,offsetF:l}}function Tre(r,e){if(!Array.isArray(r))throw new Error("array expected");r.forEach((t,n)=>{if(!(t instanceof e))throw new Error("invalid point at index "+n)})}function Pre(r,e){if(!Array.isArray(r))throw new Error("array of scalars expected");r.forEach((t,n)=>{if(!e.isValid(t))throw new Error("invalid scalar at index "+n)})}const H5=new WeakMap,BB=new WeakMap;function q5(r){return BB.get(r)||1}function UB(r,e){return{constTimeNegate:K5,hasPrecomputes(t){return q5(t)!==1},unsafeLadder(t,n,i=r.ZERO){let s=t;for(;n>YI;)n&vb&&(i=i.add(s)),s=s.double(),n>>=vb;return i},precomputeWindow(t,n){const{windows:i,windowSize:s}=j5(n,e),o=[];let a=t,c=a;for(let l=0;l<i;l++){c=a,o.push(c);for(let d=1;d<s;d++)c=c.add(a),o.push(c);a=c.double()}return o},wNAF(t,n,i){let s=r.ZERO,o=r.BASE;const a=j5(t,e);for(let c=0;c<a.windows;c++){const{nextN:l,offset:d,isZero:h,isNeg:p,isNegF:m,offsetF:f}=JI(i,c,a);i=l,h?o=o.add(K5(m,n[f])):s=s.add(K5(p,n[d]))}return{p:s,f:o}},wNAFUnsafe(t,n,i,s=r.ZERO){const o=j5(t,e);for(let a=0;a<o.windows&&i!==YI;a++){const{nextN:c,offset:l,isZero:d,isNeg:h}=JI(i,a,o);if(i=c,!d){const p=n[l];s=s.add(h?p.negate():p)}}return s},getPrecomputes(t,n,i){let s=H5.get(n);return s||(s=this.precomputeWindow(n,t),t!==1&&H5.set(n,i(s))),s},wNAFCached(t,n,i){const s=q5(t);return this.wNAF(s,this.getPrecomputes(s,t,i),n)},wNAFCachedUnsafe(t,n,i,s){const o=q5(t);return o===1?this.unsafeLadder(t,n,s):this.wNAFUnsafe(o,this.getPrecomputes(o,t,i),n,s)},setWindowSize(t,n){LB(n,e),BB.set(t,n),H5.delete(t)}}}function FB(r,e,t,n){if(Tre(t,r),Pre(n,e),t.length!==n.length)throw new Error("arrays of points and scalars must have equal length");const i=r.ZERO,s=mre(BigInt(t.length)),o=s>12?s-3:s>4?s-2:s?2:1,a=cw(o),c=new Array(Number(a)+1).fill(i),l=Math.floor((e.BITS-1)/o)*o;let d=i;for(let h=l;h>=0;h-=o){c.fill(i);for(let m=0;m<n.length;m++){const f=n[m],g=Number(f>>BigInt(h)&a);c[g]=c[g].add(t[m])}let p=i;for(let m=c.length-1,f=i;m>0;m--)f=f.add(c[m]),p=p.add(f);if(d=d.add(p),h!==0)for(let m=0;m<o;m++)d=d.double()}return d}function gS(r){return Cre(r.Fp),Nh(r,{n:"bigint",h:"bigint",Gx:"field",Gy:"field"},{nBitLength:"isSafeInteger",nByteLength:"isSafeInteger"}),Object.freeze({...MB(r.n,r.nBitLength),...r,p:r.Fp.ORDER})}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const Is=BigInt(0),rn=BigInt(1),XI=BigInt(2),Dre=BigInt(8),$re={zip215:!0};function Nre(r){const e=gS(r);return Nh(r,{hash:"function",a:"bigint",d:"bigint",randomBytes:"function"},{adjustScalarBytes:"function",domain:"function",uvRatio:"function",mapToCurve:"function"}),Object.freeze({...e})}function Mre(r){const e=Nre(r),{Fp:t,n,prehash:i,hash:s,randomBytes:o,nByteLength:a,h:c}=e,l=XI<<BigInt(a*8)-rn,d=t.create,h=lw(e.n,e.nBitLength),p=e.uvRatio||((K,O)=>{try{return{isValid:!0,value:t.sqrt(K*t.inv(O))}}catch{return{isValid:!1,value:Is}}}),m=e.adjustScalarBytes||(K=>K),f=e.domain||((K,O,U)=>{if(dc("phflag",U),O.length||U)throw new Error("Contexts/pre-hash are not supported");return K});function g(K,O,U=!1){const W=U?rn:Is;Gn("coordinate "+K,O,W,l)}function v(K){if(!(K instanceof b))throw new Error("ExtendedPoint expected")}const y=ly((K,O)=>{const{ex:U,ey:W,ez:Y}=K,H=K.is0();O==null&&(O=H?Dre:t.inv(Y));const ne=d(U*O),ye=d(W*O),ue=d(Y*O);if(H)return{x:Is,y:rn};if(ue!==rn)throw new Error("invZ was invalid");return{x:ne,y:ye}}),w=ly(K=>{const{a:O,d:U}=e;if(K.is0())throw new Error("bad point: ZERO");const{ex:W,ey:Y,ez:H,et:ne}=K,ye=d(W*W),ue=d(Y*Y),ce=d(H*H),Ne=d(ce*ce),Me=d(ye*O),Xe=d(ce*d(Me+ue)),tt=d(Ne+d(U*d(ye*ue)));if(Xe!==tt)throw new Error("bad point: equation left != right (1)");const wt=d(W*Y),bt=d(H*ne);if(wt!==bt)throw new Error("bad point: equation left != right (2)");return!0});class b{constructor(O,U,W,Y){g("x",O),g("y",U),g("z",W,!0),g("t",Y),this.ex=O,this.ey=U,this.ez=W,this.et=Y,Object.freeze(this)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}static fromAffine(O){if(O instanceof b)throw new Error("extended point not allowed");const{x:U,y:W}=O||{};return g("x",U),g("y",W),new b(U,W,rn,d(U*W))}static normalizeZ(O){const U=t.invertBatch(O.map(W=>W.ez));return O.map((W,Y)=>W.toAffine(U[Y])).map(b.fromAffine)}static msm(O,U){return FB(b,h,O,U)}_setWindowSize(O){k.setWindowSize(this,O)}assertValidity(){w(this)}equals(O){v(O);const{ex:U,ey:W,ez:Y}=this,{ex:H,ey:ne,ez:ye}=O,ue=d(U*ye),ce=d(H*Y),Ne=d(W*ye),Me=d(ne*Y);return ue===ce&&Ne===Me}is0(){return this.equals(b.ZERO)}negate(){return new b(d(-this.ex),this.ey,this.ez,d(-this.et))}double(){const{a:O}=e,{ex:U,ey:W,ez:Y}=this,H=d(U*U),ne=d(W*W),ye=d(XI*d(Y*Y)),ue=d(O*H),ce=U+W,Ne=d(d(ce*ce)-H-ne),Me=ue+ne,Xe=Me-ye,tt=ue-ne,wt=d(Ne*Xe),bt=d(Me*tt),kt=d(Ne*tt),Qt=d(Xe*Me);return new b(wt,bt,Qt,kt)}add(O){v(O);const{a:U,d:W}=e,{ex:Y,ey:H,ez:ne,et:ye}=this,{ex:ue,ey:ce,ez:Ne,et:Me}=O,Xe=d(Y*ue),tt=d(H*ce),wt=d(ye*W*Me),bt=d(ne*Ne),kt=d((Y+H)*(ue+ce)-Xe-tt),Qt=bt-wt,pr=bt+wt,to=d(tt-U*Xe),ws=d(kt*Qt),fe=d(pr*to),Fi=d(kt*to),bs=d(Qt*pr);return new b(ws,fe,bs,Fi)}subtract(O){return this.add(O.negate())}wNAF(O){return k.wNAFCached(this,O,b.normalizeZ)}multiply(O){const U=O;Gn("scalar",U,rn,n);const{p:W,f:Y}=this.wNAF(U);return b.normalizeZ([W,Y])[0]}multiplyUnsafe(O,U=b.ZERO){const W=O;return Gn("scalar",W,Is,n),W===Is?A:this.is0()||W===rn?this:k.wNAFCachedUnsafe(this,W,b.normalizeZ,U)}isSmallOrder(){return this.multiplyUnsafe(c).is0()}isTorsionFree(){return k.unsafeLadder(this,n).is0()}toAffine(O){return y(this,O)}clearCofactor(){const{h:O}=e;return O===rn?this:this.multiplyUnsafe(O)}static fromHex(O,U=!1){const{d:W,a:Y}=e,H=t.BYTES;O=jt("pointHex",O,H),dc("zip215",U);const ne=O.slice(),ye=O[H-1];ne[H-1]=ye&-129;const ue=Dl(ne),ce=U?l:t.ORDER;Gn("pointHex.y",ue,Is,ce);const Ne=d(ue*ue),Me=d(Ne-rn),Xe=d(W*Ne-Y);let{isValid:tt,value:wt}=p(Me,Xe);if(!tt)throw new Error("Point.fromHex: invalid y coordinate");const bt=(wt&rn)===rn,kt=(ye&128)!==0;if(!U&&wt===Is&&kt)throw new Error("Point.fromHex: x=0 and x_0=1");return kt!==bt&&(wt=d(-wt)),b.fromAffine({x:wt,y:ue})}static fromPrivateKey(O){const{scalar:U}=T(O);return E.multiply(U)}toRawBytes(){const{x:O,y:U}=this.toAffine(),W=V1(U,t.BYTES);return W[W.length-1]|=O&rn?128:0,W}toHex(){return Wd(this.toRawBytes())}}b.BASE=new b(e.Gx,e.Gy,rn,d(e.Gx*e.Gy)),b.ZERO=new b(Is,rn,rn,Is);const{BASE:E,ZERO:A}=b,k=UB(b,a*8);function x(K){return St(K,n)}function I(K){return x(Dl(K))}function T(K){const O=t.BYTES;K=jt("private key",K,O);const U=jt("hashed private key",s(K),2*O),W=m(U.slice(0,O)),Y=U.slice(O,2*O),H=I(W);return{head:W,prefix:Y,scalar:H}}function L(K){const{head:O,prefix:U,scalar:W}=T(K),Y=E.multiply(W),H=Y.toRawBytes();return{head:O,prefix:U,scalar:W,point:Y,pointBytes:H}}function z(K){return L(K).pointBytes}function B(K=new Uint8Array,...O){const U=Gd(...O);return I(s(f(U,jt("context",K),!!i)))}function G(K,O,U={}){K=jt("message",K),i&&(K=i(K));const{prefix:W,scalar:Y,pointBytes:H}=L(O),ne=B(U.context,W,K),ye=E.multiply(ne).toRawBytes(),ue=B(U.context,ye,H,K),ce=x(ne+ue*Y);Gn("signature.s",ce,Is,n);const Ne=Gd(ye,V1(ce,t.BYTES));return jt("result",Ne,t.BYTES*2)}const j=$re;function q(K,O,U,W=j){const{context:Y,zip215:H}=W,ne=t.BYTES;K=jt("signature",K,2*ne),O=jt("message",O),U=jt("publicKey",U,ne),H!==void 0&&dc("zip215",H),i&&(O=i(O));const ye=Dl(K.slice(ne,2*ne));let ue,ce,Ne;try{ue=b.fromHex(U,H),ce=b.fromHex(K.slice(0,ne),H),Ne=E.multiplyUnsafe(ye)}catch{return!1}if(!H&&ue.isSmallOrder())return!1;const Me=B(Y,ce.toRawBytes(),ue.toRawBytes(),O);return ce.add(ue.multiplyUnsafe(Me)).subtract(Ne).clearCofactor().equals(b.ZERO)}return E._setWindowSize(8),{CURVE:e,getPublicKey:z,sign:G,verify:q,ExtendedPoint:b,utils:{getExtendedPublicKey:L,randomPrivateKey:()=>o(t.BYTES),precompute(K=8,O=b.BASE){return O._setWindowSize(K),O.multiply(BigInt(3)),O}}}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const Ru=BigInt(0),W5=BigInt(1);function Ore(r){return Nh(r,{a:"bigint"},{montgomeryBits:"isSafeInteger",nByteLength:"isSafeInteger",adjustScalarBytes:"function",domain:"function",powPminus2:"function",Gu:"bigint"}),Object.freeze({...r})}function Rre(r){const e=Ore(r),{P:t}=e,n=w=>St(w,t),i=e.montgomeryBits,s=Math.ceil(i/8),o=e.nByteLength,a=e.adjustScalarBytes||(w=>w),c=e.powPminus2||(w=>NB(w,t-BigInt(2),t));function l(w,b,E){const A=n(w*(b-E));return b=n(b-A),E=n(E+A),[b,E]}const d=(e.a-BigInt(2))/BigInt(4);function h(w,b){Gn("u",w,Ru,t),Gn("scalar",b,Ru,t);const E=b,A=w;let k=W5,x=Ru,I=w,T=W5,L=Ru,z;for(let G=BigInt(i-1);G>=Ru;G--){const j=E>>G&W5;L^=j,z=l(L,k,I),k=z[0],I=z[1],z=l(L,x,T),x=z[0],T=z[1],L=j;const q=k+x,Q=n(q*q),K=k-x,O=n(K*K),U=Q-O,W=I+T,Y=I-T,H=n(Y*q),ne=n(W*K),ye=H+ne,ue=H-ne;I=n(ye*ye),T=n(A*n(ue*ue)),k=n(Q*O),x=n(U*(Q+n(d*U)))}z=l(L,k,I),k=z[0],I=z[1],z=l(L,x,T),x=z[0],T=z[1];const B=c(x);return n(k*B)}function p(w){return V1(n(w),s)}function m(w){const b=jt("u coordinate",w,s);return o===32&&(b[31]&=127),Dl(b)}function f(w){const b=jt("scalar",w),E=b.length;if(E!==s&&E!==o){let A=""+s+" or "+o;throw new Error("invalid scalar, expected "+A+" bytes, got "+E)}return Dl(a(b))}function g(w,b){const E=m(b),A=f(w),k=h(E,A);if(k===Ru)throw new Error("invalid private or public key received");return p(k)}const v=p(e.Gu);function y(w){return g(w,v)}return{scalarMult:g,scalarMultBase:y,getSharedSecret:(w,b)=>g(w,b),getPublicKey:w=>y(w),utils:{randomPrivateKey:()=>e.randomBytes(e.nByteLength)},GuBytes:v}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const K1=BigInt("57896044618658097711785492504343953926634992332820282019728792003956564819949"),ZI=BigInt("19681161376707505956807079304988542015446066515923890162744021073123829784752");BigInt(0);const Lre=BigInt(1),ek=BigInt(2),Bre=BigInt(3),Ure=BigInt(5),Fre=BigInt(8);function zB(r){const e=BigInt(10),t=BigInt(20),n=BigInt(40),i=BigInt(80),s=K1,a=r*r%s*r%s,c=Rt(a,ek,s)*a%s,l=Rt(c,Lre,s)*r%s,d=Rt(l,Ure,s)*l%s,h=Rt(d,e,s)*d%s,p=Rt(h,t,s)*h%s,m=Rt(p,n,s)*p%s,f=Rt(m,i,s)*m%s,g=Rt(f,i,s)*m%s,v=Rt(g,e,s)*d%s;return{pow_p_5_8:Rt(v,ek,s)*r%s,b2:a}}function VB(r){return r[0]&=248,r[31]&=127,r[31]|=64,r}function zre(r,e){const t=K1,n=St(e*e*e,t),i=St(n*n*e,t),s=zB(r*i).pow_p_5_8;let o=St(r*n*s,t);const a=St(e*o*o,t),c=o,l=St(o*ZI,t),d=a===r,h=a===St(-r,t),p=a===St(-r*ZI,t);return d&&(o=c),(h||p)&&(o=l),xre(o,t)&&(o=St(-o,t)),{isValid:d||h,value:o}}const tk=lw(K1,void 0,!0),Vre={a:tk.create(BigInt(-1)),d:BigInt("37095705934669439343138083508754565189542113879843219016388785533085940283555"),Fp:tk,n:BigInt("7237005577332262213973186563042994240857116359379907606001950938285454250989"),h:Fre,Gx:BigInt("15112221349535400772501151409588531511454012693041857206046113283949847762202"),Gy:BigInt("46316835694926478169428394003475163141307993866256225615783033603165251855960"),hash:gre,randomBytes:dS,adjustScalarBytes:VB,uvRatio:zre},uy=Mre(Vre),q0=Rre({P:K1,a:BigInt(486662),montgomeryBits:255,nByteLength:32,Gu:BigInt(9),powPminus2:r=>{const e=K1,{pow_p_5_8:t,b2:n}=zB(r);return St(Rt(t,Bre,e)*n,e)},adjustScalarBytes:VB,randomBytes:dS}),j1=32,bo=64,Eb=32;function Kre(){const r=uy.utils.randomPrivateKey(),e=uy.getPublicKey(r);return{privateKey:qre(r,e),publicKey:e}}function jre(r,e){const t=r.subarray(0,Eb);return uy.sign(e instanceof Uint8Array?e:e.subarray(),t)}function Hre(r,e,t){return uy.verify(e,t instanceof Uint8Array?t:t.subarray(),r)}function qre(r,e){const t=new Uint8Array(bo);for(let n=0;n<Eb;n++)t[n]=r[n],t[Eb+n]=e[n];return t}class KB{constructor(e){u(this,"type","Ed25519");u(this,"raw");this.raw=H1(e,j1)}toMultihash(){return cS.digest(Pi(this))}toCID(){return iw.createV1(114,this.toMultihash())}toString(){return Si.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:He(this.raw,e.raw)}verify(e,t){return Hre(this.raw,t,e)}}class Sb{constructor(e,t){u(this,"type","Ed25519");u(this,"raw");u(this,"publicKey");this.raw=H1(e,bo),this.publicKey=new KB(t)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:He(this.raw,e.raw)}sign(e){return jre(this.raw,e)}}function jB(r){if(r.length>bo){r=H1(r,bo+j1);const n=r.subarray(0,bo),i=r.subarray(bo,r.length);return new Sb(n,i)}r=H1(r,bo);const e=r.subarray(0,bo),t=r.subarray(j1);return new Sb(e,t)}function yS(r){return r=H1(r,j1),new KB(r)}async function Wre(){const{privateKey:r,publicKey:e}=Kre();return new Sb(r,e)}function H1(r,e){if(r=Uint8Array.from(r??[]),r.length!==e)throw new Z(`Key must be a Uint8Array of length ${e}, got ${r.length}`);return r}const Gre=Math.pow(2,7),Qre=Math.pow(2,14),Yre=Math.pow(2,21),mS=Math.pow(2,28),wS=Math.pow(2,35),bS=Math.pow(2,42),vS=Math.pow(2,49),ct=128,Gr=127;function gt(r){if(r<Gre)return 1;if(r<Qre)return 2;if(r<Yre)return 3;if(r<mS)return 4;if(r<wS)return 5;if(r<bS)return 6;if(r<vS)return 7;if(Number.MAX_SAFE_INTEGER!=null&&r>Number.MAX_SAFE_INTEGER)throw new RangeError("Could not encode varint");return 8}function HB(r,e,t=0){switch(gt(r)){case 8:e[t++]=r&255|ct,r/=128;case 7:e[t++]=r&255|ct,r/=128;case 6:e[t++]=r&255|ct,r/=128;case 5:e[t++]=r&255|ct,r/=128;case 4:e[t++]=r&255|ct,r>>>=7;case 3:e[t++]=r&255|ct,r>>>=7;case 2:e[t++]=r&255|ct,r>>>=7;case 1:{e[t++]=r&255,r>>>=7;break}default:throw new Error("unreachable")}return e}function Jre(r,e,t=0){switch(gt(r)){case 8:e.set(t++,r&255|ct),r/=128;case 7:e.set(t++,r&255|ct),r/=128;case 6:e.set(t++,r&255|ct),r/=128;case 5:e.set(t++,r&255|ct),r/=128;case 4:e.set(t++,r&255|ct),r>>>=7;case 3:e.set(t++,r&255|ct),r>>>=7;case 2:e.set(t++,r&255|ct),r>>>=7;case 1:{e.set(t++,r&255),r>>>=7;break}default:throw new Error("unreachable")}return e}function qB(r,e){let t=r[e],n=0;if(n+=t&Gr,t<ct||(t=r[e+1],n+=(t&Gr)<<7,t<ct)||(t=r[e+2],n+=(t&Gr)<<14,t<ct)||(t=r[e+3],n+=(t&Gr)<<21,t<ct)||(t=r[e+4],n+=(t&Gr)*mS,t<ct)||(t=r[e+5],n+=(t&Gr)*wS,t<ct)||(t=r[e+6],n+=(t&Gr)*bS,t<ct)||(t=r[e+7],n+=(t&Gr)*vS,t<ct))return n;throw new RangeError("Could not decode varint")}function Xre(r,e){let t=r.get(e),n=0;if(n+=t&Gr,t<ct||(t=r.get(e+1),n+=(t&Gr)<<7,t<ct)||(t=r.get(e+2),n+=(t&Gr)<<14,t<ct)||(t=r.get(e+3),n+=(t&Gr)<<21,t<ct)||(t=r.get(e+4),n+=(t&Gr)*mS,t<ct)||(t=r.get(e+5),n+=(t&Gr)*wS,t<ct)||(t=r.get(e+6),n+=(t&Gr)*bS,t<ct)||(t=r.get(e+7),n+=(t&Gr)*vS,t<ct))return n;throw new RangeError("Could not decode varint")}function xr(r,e,t=0){return e==null&&(e=Mn(gt(r))),e instanceof Uint8Array?HB(r,e,t):Jre(r,e,t)}function gs(r,e=0){return r instanceof Uint8Array?qB(r,e):Xre(r,e)}const ES=new Float32Array([-0]),Ga=new Uint8Array(ES.buffer);function Zre(r,e,t){ES[0]=r,e[t]=Ga[0],e[t+1]=Ga[1],e[t+2]=Ga[2],e[t+3]=Ga[3]}function ene(r,e){return Ga[0]=r[e],Ga[1]=r[e+1],Ga[2]=r[e+2],Ga[3]=r[e+3],ES[0]}const SS=new Float64Array([-0]),Qr=new Uint8Array(SS.buffer);function tne(r,e,t){SS[0]=r,e[t]=Qr[0],e[t+1]=Qr[1],e[t+2]=Qr[2],e[t+3]=Qr[3],e[t+4]=Qr[4],e[t+5]=Qr[5],e[t+6]=Qr[6],e[t+7]=Qr[7]}function rne(r,e){return Qr[0]=r[e],Qr[1]=r[e+1],Qr[2]=r[e+2],Qr[3]=r[e+3],Qr[4]=r[e+4],Qr[5]=r[e+5],Qr[6]=r[e+6],Qr[7]=r[e+7],SS[0]}const nne=BigInt(Number.MAX_SAFE_INTEGER),ine=BigInt(Number.MIN_SAFE_INTEGER);class Jr{constructor(e,t){u(this,"lo");u(this,"hi");this.lo=e|0,this.hi=t|0}toNumber(e=!1){if(!e&&this.hi>>>31>0){const t=~this.lo+1>>>0;let n=~this.hi>>>0;return t===0&&(n=n+1>>>0),-(t+n*4294967296)}return this.lo+this.hi*4294967296}toBigInt(e=!1){if(e)return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n);if(this.hi>>>31){const t=~this.lo+1>>>0;let n=~this.hi>>>0;return t===0&&(n=n+1>>>0),-(BigInt(t)+(BigInt(n)<<32n))}return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n)}toString(e=!1){return this.toBigInt(e).toString()}zzEncode(){const e=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^e)>>>0,this.lo=(this.lo<<1^e)>>>0,this}zzDecode(){const e=-(this.lo&1);return this.lo=((this.lo>>>1|this.hi<<31)^e)>>>0,this.hi=(this.hi>>>1^e)>>>0,this}length(){const e=this.lo,t=(this.lo>>>28|this.hi<<4)>>>0,n=this.hi>>>24;return n===0?t===0?e<16384?e<128?1:2:e<2097152?3:4:t<16384?t<128?5:6:t<2097152?7:8:n<128?9:10}static fromBigInt(e){if(e===0n)return $l;if(e<nne&&e>ine)return this.fromNumber(Number(e));const t=e<0n;t&&(e=-e);let n=e>>32n,i=e-(n<<32n);return t&&(n=~n|0n,i=~i|0n,++i>rk&&(i=0n,++n>rk&&(n=0n))),new Jr(Number(i),Number(n))}static fromNumber(e){if(e===0)return $l;const t=e<0;t&&(e=-e);let n=e>>>0,i=(e-n)/4294967296>>>0;return t&&(i=~i>>>0,n=~n>>>0,++n>4294967295&&(n=0,++i>4294967295&&(i=0))),new Jr(n,i)}static from(e){return typeof e=="number"?Jr.fromNumber(e):typeof e=="bigint"?Jr.fromBigInt(e):typeof e=="string"?Jr.fromBigInt(BigInt(e)):e.low!=null||e.high!=null?new Jr(e.low>>>0,e.high>>>0):$l}}const $l=new Jr(0,0);$l.toBigInt=function(){return 0n};$l.zzEncode=$l.zzDecode=function(){return this};$l.length=function(){return 1};const rk=4294967296n;function sne(r){let e=0,t=0;for(let n=0;n<r.length;++n)t=r.charCodeAt(n),t<128?e+=1:t<2048?e+=2:(t&64512)===55296&&(r.charCodeAt(n+1)&64512)===56320?(++n,e+=4):e+=3;return e}function one(r,e,t){if(t-e<1)return"";let i;const s=[];let o=0,a;for(;e<t;)a=r[e++],a<128?s[o++]=a:a>191&&a<224?s[o++]=(a&31)<<6|r[e++]&63:a>239&&a<365?(a=((a&7)<<18|(r[e++]&63)<<12|(r[e++]&63)<<6|r[e++]&63)-65536,s[o++]=55296+(a>>10),s[o++]=56320+(a&1023)):s[o++]=(a&15)<<12|(r[e++]&63)<<6|r[e++]&63,o>8191&&((i??(i=[])).push(String.fromCharCode.apply(String,s)),o=0);return i!=null?(o>0&&i.push(String.fromCharCode.apply(String,s.slice(0,o))),i.join("")):String.fromCharCode.apply(String,s.slice(0,o))}function WB(r,e,t){const n=t;let i,s;for(let o=0;o<r.length;++o)i=r.charCodeAt(o),i<128?e[t++]=i:i<2048?(e[t++]=i>>6|192,e[t++]=i&63|128):(i&64512)===55296&&((s=r.charCodeAt(o+1))&64512)===56320?(i=65536+((i&1023)<<10)+(s&1023),++o,e[t++]=i>>18|240,e[t++]=i>>12&63|128,e[t++]=i>>6&63|128,e[t++]=i&63|128):(e[t++]=i>>12|224,e[t++]=i>>6&63|128,e[t++]=i&63|128);return t-n}function ji(r,e){return RangeError(`index out of range: ${r.pos} + ${e??1} > ${r.len}`)}function W0(r,e){return(r[e-4]|r[e-3]<<8|r[e-2]<<16|r[e-1]<<24)>>>0}class ane{constructor(e){u(this,"buf");u(this,"pos");u(this,"len");u(this,"_slice",Uint8Array.prototype.subarray);this.buf=e,this.pos=0,this.len=e.length}uint32(){let e=4294967295;if(e=(this.buf[this.pos]&127)>>>0,this.buf[this.pos++]<128||(e=(e|(this.buf[this.pos]&127)<<7)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<14)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<21)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&15)<<28)>>>0,this.buf[this.pos++]<128))return e;if((this.pos+=5)>this.len)throw this.pos=this.len,ji(this,10);return e}int32(){return this.uint32()|0}sint32(){const e=this.uint32();return e>>>1^-(e&1)|0}bool(){return this.uint32()!==0}fixed32(){if(this.pos+4>this.len)throw ji(this,4);return W0(this.buf,this.pos+=4)}sfixed32(){if(this.pos+4>this.len)throw ji(this,4);return W0(this.buf,this.pos+=4)|0}float(){if(this.pos+4>this.len)throw ji(this,4);const e=ene(this.buf,this.pos);return this.pos+=4,e}double(){if(this.pos+8>this.len)throw ji(this,4);const e=rne(this.buf,this.pos);return this.pos+=8,e}bytes(){const e=this.uint32(),t=this.pos,n=this.pos+e;if(n>this.len)throw ji(this,e);return this.pos+=e,t===n?new Uint8Array(0):this.buf.subarray(t,n)}string(){const e=this.bytes();return one(e,0,e.length)}skip(e){if(typeof e=="number"){if(this.pos+e>this.len)throw ji(this,e);this.pos+=e}else do if(this.pos>=this.len)throw ji(this);while(this.buf[this.pos++]&128);return this}skipType(e){switch(e){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;(e=this.uint32()&7)!==4;)this.skipType(e);break;case 5:this.skip(4);break;default:throw Error(`invalid wire type ${e} at offset ${this.pos}`)}return this}readLongVarint(){const e=new Jr(0,0);let t=0;if(this.len-this.pos>4){for(;t<4;++t)if(e.lo=(e.lo|(this.buf[this.pos]&127)<<t*7)>>>0,this.buf[this.pos++]<128)return e;if(e.lo=(e.lo|(this.buf[this.pos]&127)<<28)>>>0,e.hi=(e.hi|(this.buf[this.pos]&127)>>4)>>>0,this.buf[this.pos++]<128)return e;t=0}else{for(;t<3;++t){if(this.pos>=this.len)throw ji(this);if(e.lo=(e.lo|(this.buf[this.pos]&127)<<t*7)>>>0,this.buf[this.pos++]<128)return e}return e.lo=(e.lo|(this.buf[this.pos++]&127)<<t*7)>>>0,e}if(this.len-this.pos>4){for(;t<5;++t)if(e.hi=(e.hi|(this.buf[this.pos]&127)<<t*7+3)>>>0,this.buf[this.pos++]<128)return e}else for(;t<5;++t){if(this.pos>=this.len)throw ji(this);if(e.hi=(e.hi|(this.buf[this.pos]&127)<<t*7+3)>>>0,this.buf[this.pos++]<128)return e}throw Error("invalid varint encoding")}readFixed64(){if(this.pos+8>this.len)throw ji(this,8);const e=W0(this.buf,this.pos+=4),t=W0(this.buf,this.pos+=4);return new Jr(e,t)}int64(){return this.readLongVarint().toBigInt()}int64Number(){return this.readLongVarint().toNumber()}int64String(){return this.readLongVarint().toString()}uint64(){return this.readLongVarint().toBigInt(!0)}uint64Number(){const e=qB(this.buf,this.pos);return this.pos+=gt(e),e}uint64String(){return this.readLongVarint().toString(!0)}sint64(){return this.readLongVarint().zzDecode().toBigInt()}sint64Number(){return this.readLongVarint().zzDecode().toNumber()}sint64String(){return this.readLongVarint().zzDecode().toString()}fixed64(){return this.readFixed64().toBigInt()}fixed64Number(){return this.readFixed64().toNumber()}fixed64String(){return this.readFixed64().toString()}sfixed64(){return this.readFixed64().toBigInt()}sfixed64Number(){return this.readFixed64().toNumber()}sfixed64String(){return this.readFixed64().toString()}}function cne(r){return new ane(r instanceof Uint8Array?r:r.subarray())}function Pe(r,e,t){const n=cne(r);return e.decode(n,void 0,t)}function lne(r){let n,i=8192;return function(o){if(o<1||o>4096)return Mn(o);i+o>8192&&(n=Mn(8192),i=0);const a=n.subarray(i,i+=o);return i&7&&(i=(i|7)+1),a}}class zf{constructor(e,t,n){u(this,"fn");u(this,"len");u(this,"next");u(this,"val");this.fn=e,this.len=t,this.next=void 0,this.val=n}}function G5(){}class une{constructor(e){u(this,"head");u(this,"tail");u(this,"len");u(this,"next");this.head=e.head,this.tail=e.tail,this.len=e.len,this.next=e.states}}const dne=lne();function hne(r){return globalThis.Buffer!=null?Mn(r):dne(r)}class xb{constructor(){u(this,"len");u(this,"head");u(this,"tail");u(this,"states");this.len=0,this.head=new zf(G5,0,0),this.tail=this.head,this.states=null}_push(e,t,n){return this.tail=this.tail.next=new zf(e,t,n),this.len+=t,this}uint32(e){return this.len+=(this.tail=this.tail.next=new pne((e=e>>>0)<128?1:e<16384?2:e<2097152?3:e<268435456?4:5,e)).len,this}int32(e){return e<0?this._push(G0,10,Jr.fromNumber(e)):this.uint32(e)}sint32(e){return this.uint32((e<<1^e>>31)>>>0)}uint64(e){const t=Jr.fromBigInt(e);return this._push(G0,t.length(),t)}uint64Number(e){return this._push(HB,gt(e),e)}uint64String(e){return this.uint64(BigInt(e))}int64(e){return this.uint64(e)}int64Number(e){return this.uint64Number(e)}int64String(e){return this.uint64String(e)}sint64(e){const t=Jr.fromBigInt(e).zzEncode();return this._push(G0,t.length(),t)}sint64Number(e){const t=Jr.fromNumber(e).zzEncode();return this._push(G0,t.length(),t)}sint64String(e){return this.sint64(BigInt(e))}bool(e){return this._push(Q5,1,e?1:0)}fixed32(e){return this._push(vf,4,e>>>0)}sfixed32(e){return this.fixed32(e)}fixed64(e){const t=Jr.fromBigInt(e);return this._push(vf,4,t.lo)._push(vf,4,t.hi)}fixed64Number(e){const t=Jr.fromNumber(e);return this._push(vf,4,t.lo)._push(vf,4,t.hi)}fixed64String(e){return this.fixed64(BigInt(e))}sfixed64(e){return this.fixed64(e)}sfixed64Number(e){return this.fixed64Number(e)}sfixed64String(e){return this.fixed64String(e)}float(e){return this._push(Zre,4,e)}double(e){return this._push(tne,8,e)}bytes(e){const t=e.length>>>0;return t===0?this._push(Q5,1,0):this.uint32(t)._push(gne,t,e)}string(e){const t=sne(e);return t!==0?this.uint32(t)._push(WB,t,e):this._push(Q5,1,0)}fork(){return this.states=new une(this),this.head=this.tail=new zf(G5,0,0),this.len=0,this}reset(){return this.states!=null?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new zf(G5,0,0),this.len=0),this}ldelim(){const e=this.head,t=this.tail,n=this.len;return this.reset().uint32(n),n!==0&&(this.tail.next=e.next,this.tail=t,this.len+=n),this}finish(){let e=this.head.next;const t=hne(this.len);let n=0;for(;e!=null;)e.fn(e.val,t,n),n+=e.len,e=e.next;return t}}function Q5(r,e,t){e[t]=r&255}function fne(r,e,t){for(;r>127;)e[t++]=r&127|128,r>>>=7;e[t]=r}class pne extends zf{constructor(t,n){super(fne,t,n);u(this,"next");this.next=void 0}}function G0(r,e,t){for(;r.hi!==0;)e[t++]=r.lo&127|128,r.lo=(r.lo>>>7|r.hi<<25)>>>0,r.hi>>>=7;for(;r.lo>127;)e[t++]=r.lo&127|128,r.lo=r.lo>>>7;e[t++]=r.lo}function vf(r,e,t){e[t]=r&255,e[t+1]=r>>>8&255,e[t+2]=r>>>16&255,e[t+3]=r>>>24}function gne(r,e,t){e.set(r,t)}globalThis.Buffer!=null&&(xb.prototype.bytes=function(r){const e=r.length>>>0;return this.uint32(e),e>0&&this._push(yne,e,r),this},xb.prototype.string=function(r){const e=globalThis.Buffer.byteLength(r);return this.uint32(e),e>0&&this._push(mne,e,r),this});function yne(r,e,t){e.set(r,t)}function mne(r,e,t){r.length<40?WB(r,e,t):e.utf8Write!=null?e.utf8Write(r,t):e.set(oe(r),t)}function wne(){return new xb}function De(r,e){const t=wne();return e.encode(r,t,{lengthDelimited:!1}),t.finish()}var dy;(function(r){r[r.VARINT=0]="VARINT",r[r.BIT64=1]="BIT64",r[r.LENGTH_DELIMITED=2]="LENGTH_DELIMITED",r[r.START_GROUP=3]="START_GROUP",r[r.END_GROUP=4]="END_GROUP",r[r.BIT32=5]="BIT32"})(dy||(dy={}));function GB(r,e,t,n){return{name:r,type:e,encode:t,decode:n}}function On(r){function e(i){if(r[i.toString()]==null)throw new Error("Invalid enum value");return r[i]}const t=function(s,o){const a=e(s);o.int32(a)},n=function(s){const o=s.int32();return e(o)};return GB("enum",dy.VARINT,t,n)}function $e(r,e){return GB("message",dy.LENGTH_DELIMITED,r,e)}class pt extends Error{constructor(){super(...arguments);u(this,"code","ERR_MAX_LENGTH");u(this,"name","MaxLengthError")}}class nk extends Error{constructor(){super(...arguments);u(this,"code","ERR_MAX_SIZE");u(this,"name","MaxSizeError")}}var Mt;(function(r){r.RSA="RSA",r.Ed25519="Ed25519",r.secp256k1="secp256k1",r.ECDSA="ECDSA"})(Mt||(Mt={}));var Ab;(function(r){r[r.RSA=0]="RSA",r[r.Ed25519=1]="Ed25519",r[r.secp256k1=2]="secp256k1",r[r.ECDSA=3]="ECDSA"})(Ab||(Ab={}));(function(r){r.codec=()=>On(Ab)})(Mt||(Mt={}));var Sc;(function(r){let e;r.codec=()=>(e==null&&(e=$e((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),Mt.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{const s={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.Type=Mt.codec().decode(t);break}case 2:{s.Data=t.bytes();break}default:{t.skipType(a&7);break}}}return s})),e),r.encode=t=>De(t,r.codec()),r.decode=(t,n)=>Pe(t,r.codec(),n)})(Sc||(Sc={}));var hy;(function(r){let e;r.codec=()=>(e==null&&(e=$e((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),Mt.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{const s={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.Type=Mt.codec().decode(t);break}case 2:{s.Data=t.bytes();break}default:{t.skipType(a&7);break}}}return s})),e),r.encode=t=>De(t,r.codec()),r.decode=(t,n)=>Pe(t,r.codec(),n)})(hy||(hy={}));const Lu=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */function bne(r){return r instanceof Uint8Array||ArrayBuffer.isView(r)&&r.constructor.name==="Uint8Array"}function bd(r){if(!Number.isSafeInteger(r)||r<0)throw new Error("positive integer expected, got "+r)}function zp(r,...e){if(!bne(r))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(r.length))throw new Error("Uint8Array expected of length "+e+", got length="+r.length)}function uw(r){if(typeof r!="function"||typeof r.create!="function")throw new Error("Hash should be wrapped by utils.createHasher");bd(r.outputLen),bd(r.blockLen)}function fy(r,e=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(e&&r.finished)throw new Error("Hash#digest() has already been called")}function vne(r,e){zp(r);const t=e.outputLen;if(r.length<t)throw new Error("digestInto() expects output buffer of length at least "+t)}function Hs(...r){for(let e=0;e<r.length;e++)r[e].fill(0)}function s1(r){return new DataView(r.buffer,r.byteOffset,r.byteLength)}function ks(r,e){return r<<32-e|r>>>e}function Y5(r,e){return r<<e|r>>>32-e>>>0}const Ene=async()=>{};async function Sne(r,e,t){let n=Date.now();for(let i=0;i<r;i++){t(i);const s=Date.now()-n;s>=0&&s<e||(await Ene(),n+=s)}}function QB(r){if(typeof r!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(r))}function q1(r){return typeof r=="string"&&(r=QB(r)),zp(r),r}function ik(r){return typeof r=="string"&&(r=QB(r)),zp(r),r}function xne(r,e){if(e!==void 0&&{}.toString.call(e)!=="[object Object]")throw new Error("options should be object or undefined");return Object.assign(r,e)}class YB{}function xS(r){const e=n=>r().update(q1(n)).digest(),t=r();return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=()=>r(),e}function Ane(r=32){if(Lu&&typeof Lu.getRandomValues=="function")return Lu.getRandomValues(new Uint8Array(r));if(Lu&&typeof Lu.randomBytes=="function")return Uint8Array.from(Lu.randomBytes(r));throw new Error("crypto.getRandomValues must be defined")}function xc(r){if(isNaN(r)||r<=0)throw new Z("random bytes length must be a Number bigger than 0");return Ane(r)}class sk extends Error{constructor(e="An error occurred while signing a message"){super(e),this.name="SigningError"}}class ok extends Error{constructor(e="An error occurred while verifying a message"){super(e),this.name="VerificationError"}}class Cne extends Error{constructor(e="Missing Web Crypto API"){super(e),this.name="WebCryptoMissingError"}}const qs={get(r=globalThis){const e=r.crypto;if((e==null?void 0:e.subtle)==null)throw new Cne("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p/blob/main/packages/crypto/README.md#web-crypto-api");return e}};function Ine(r,e,t,n){if(typeof r.setBigUint64=="function")return r.setBigUint64(e,t,n);const i=BigInt(32),s=BigInt(4294967295),o=Number(t>>i&s),a=Number(t&s),c=n?4:0,l=n?0:4;r.setUint32(e+c,o,n),r.setUint32(e+l,a,n)}function JB(r,e,t){return r&e^~r&t}function XB(r,e,t){return r&e^r&t^e&t}class AS extends YB{constructor(e,t,n,i){super(),this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.blockLen=e,this.outputLen=t,this.padOffset=n,this.isLE=i,this.buffer=new Uint8Array(e),this.view=s1(this.buffer)}update(e){fy(this),e=q1(e),zp(e);const{view:t,buffer:n,blockLen:i}=this,s=e.length;for(let o=0;o<s;){const a=Math.min(i-this.pos,s-o);if(a===i){const c=s1(e);for(;i<=s-o;o+=i)this.process(c,o);continue}n.set(e.subarray(o,o+a),this.pos),this.pos+=a,o+=a,this.pos===i&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){fy(this),vne(e,this),this.finished=!0;const{buffer:t,view:n,blockLen:i,isLE:s}=this;let{pos:o}=this;t[o++]=128,Hs(this.buffer.subarray(o)),this.padOffset>i-o&&(this.process(n,0),o=0);for(let h=o;h<i;h++)t[h]=0;Ine(n,i-8,BigInt(this.length*8),s),this.process(n,0);const a=s1(e),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const l=c/4,d=this.get();if(l>d.length)throw new Error("_sha2: outputLen bigger than state");for(let h=0;h<l;h++)a.setUint32(4*h,d[h],s)}digest(){const{buffer:e,outputLen:t}=this;this.digestInto(e);const n=e.slice(0,t);return this.destroy(),n}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());const{blockLen:t,buffer:n,length:i,finished:s,destroyed:o,pos:a}=this;return e.destroyed=o,e.finished=s,e.length=i,e.pos=a,i%t&&e.buffer.set(n),e}clone(){return this._cloneInto()}}const Ea=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),Nr=Uint32Array.from([1779033703,4089235720,3144134277,2227873595,1013904242,4271175723,2773480762,1595750129,1359893119,2917565137,2600822924,725511199,528734635,4215389547,1541459225,327033209]),Q0=BigInt(2**32-1),ak=BigInt(32);function kne(r,e=!1){return e?{h:Number(r&Q0),l:Number(r>>ak&Q0)}:{h:Number(r>>ak&Q0)|0,l:Number(r&Q0)|0}}function _ne(r,e=!1){const t=r.length;let n=new Uint32Array(t),i=new Uint32Array(t);for(let s=0;s<t;s++){const{h:o,l:a}=kne(r[s],e);[n[s],i[s]]=[o,a]}return[n,i]}const ck=(r,e,t)=>r>>>t,lk=(r,e,t)=>r<<32-t|e>>>t,Bu=(r,e,t)=>r>>>t|e<<32-t,Uu=(r,e,t)=>r<<32-t|e>>>t,Y0=(r,e,t)=>r<<64-t|e>>>t-32,J0=(r,e,t)=>r>>>t-32|e<<64-t;function co(r,e,t,n){const i=(e>>>0)+(n>>>0);return{h:r+t+(i/2**32|0)|0,l:i|0}}const Tne=(r,e,t)=>(r>>>0)+(e>>>0)+(t>>>0),Pne=(r,e,t,n)=>e+t+n+(r/2**32|0)|0,Dne=(r,e,t,n)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0),$ne=(r,e,t,n,i)=>e+t+n+i+(r/2**32|0)|0,Nne=(r,e,t,n,i)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0)+(i>>>0),Mne=(r,e,t,n,i,s)=>e+t+n+i+s+(r/2**32|0)|0,One=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),Sa=new Uint32Array(64);class Rne extends AS{constructor(e=32){super(64,e,8,!1),this.A=Ea[0]|0,this.B=Ea[1]|0,this.C=Ea[2]|0,this.D=Ea[3]|0,this.E=Ea[4]|0,this.F=Ea[5]|0,this.G=Ea[6]|0,this.H=Ea[7]|0}get(){const{A:e,B:t,C:n,D:i,E:s,F:o,G:a,H:c}=this;return[e,t,n,i,s,o,a,c]}set(e,t,n,i,s,o,a,c){this.A=e|0,this.B=t|0,this.C=n|0,this.D=i|0,this.E=s|0,this.F=o|0,this.G=a|0,this.H=c|0}process(e,t){for(let h=0;h<16;h++,t+=4)Sa[h]=e.getUint32(t,!1);for(let h=16;h<64;h++){const p=Sa[h-15],m=Sa[h-2],f=ks(p,7)^ks(p,18)^p>>>3,g=ks(m,17)^ks(m,19)^m>>>10;Sa[h]=g+Sa[h-7]+f+Sa[h-16]|0}let{A:n,B:i,C:s,D:o,E:a,F:c,G:l,H:d}=this;for(let h=0;h<64;h++){const p=ks(a,6)^ks(a,11)^ks(a,25),m=d+p+JB(a,c,l)+One[h]+Sa[h]|0,g=(ks(n,2)^ks(n,13)^ks(n,22))+XB(n,i,s)|0;d=l,l=c,c=a,a=o+m|0,o=s,s=i,i=n,n=m+g|0}n=n+this.A|0,i=i+this.B|0,s=s+this.C|0,o=o+this.D|0,a=a+this.E|0,c=c+this.F|0,l=l+this.G|0,d=d+this.H|0,this.set(n,i,s,o,a,c,l,d)}roundClean(){Hs(Sa)}destroy(){this.set(0,0,0,0,0,0,0,0),Hs(this.buffer)}}const ZB=_ne(["0x428a2f98d728ae22","0x7137449123ef65cd","0xb5c0fbcfec4d3b2f","0xe9b5dba58189dbbc","0x3956c25bf348b538","0x59f111f1b605d019","0x923f82a4af194f9b","0xab1c5ed5da6d8118","0xd807aa98a3030242","0x12835b0145706fbe","0x243185be4ee4b28c","0x550c7dc3d5ffb4e2","0x72be5d74f27b896f","0x80deb1fe3b1696b1","0x9bdc06a725c71235","0xc19bf174cf692694","0xe49b69c19ef14ad2","0xefbe4786384f25e3","0x0fc19dc68b8cd5b5","0x240ca1cc77ac9c65","0x2de92c6f592b0275","0x4a7484aa6ea6e483","0x5cb0a9dcbd41fbd4","0x76f988da831153b5","0x983e5152ee66dfab","0xa831c66d2db43210","0xb00327c898fb213f","0xbf597fc7beef0ee4","0xc6e00bf33da88fc2","0xd5a79147930aa725","0x06ca6351e003826f","0x142929670a0e6e70","0x27b70a8546d22ffc","0x2e1b21385c26c926","0x4d2c6dfc5ac42aed","0x53380d139d95b3df","0x650a73548baf63de","0x766a0abb3c77b2a8","0x81c2c92e47edaee6","0x92722c851482353b","0xa2bfe8a14cf10364","0xa81a664bbc423001","0xc24b8b70d0f89791","0xc76c51a30654be30","0xd192e819d6ef5218","0xd69906245565a910","0xf40e35855771202a","0x106aa07032bbd1b8","0x19a4c116b8d2d0c8","0x1e376c085141ab53","0x2748774cdf8eeb99","0x34b0bcb5e19b48a8","0x391c0cb3c5c95a63","0x4ed8aa4ae3418acb","0x5b9cca4f7763e373","0x682e6ff3d6b2b8a3","0x748f82ee5defb2fc","0x78a5636f43172f60","0x84c87814a1f0ab72","0x8cc702081a6439ec","0x90befffa23631e28","0xa4506cebde82bde9","0xbef9a3f7b2c67915","0xc67178f2e372532b","0xca273eceea26619c","0xd186b8c721c0c207","0xeada7dd6cde0eb1e","0xf57d4f7fee6ed178","0x06f067aa72176fba","0x0a637dc5a2c898a6","0x113f9804bef90dae","0x1b710b35131c471b","0x28db77f523047d84","0x32caab7b40c72493","0x3c9ebe0a15c9bebc","0x431d67c49c100d4c","0x4cc5d4becb3e42b6","0x597f299cfc657e2a","0x5fcb6fab3ad6faec","0x6c44198c4a475817"].map(r=>BigInt(r))),Lne=ZB[0],Bne=ZB[1],xa=new Uint32Array(80),Aa=new Uint32Array(80);class Une extends AS{constructor(e=64){super(128,e,16,!1),this.Ah=Nr[0]|0,this.Al=Nr[1]|0,this.Bh=Nr[2]|0,this.Bl=Nr[3]|0,this.Ch=Nr[4]|0,this.Cl=Nr[5]|0,this.Dh=Nr[6]|0,this.Dl=Nr[7]|0,this.Eh=Nr[8]|0,this.El=Nr[9]|0,this.Fh=Nr[10]|0,this.Fl=Nr[11]|0,this.Gh=Nr[12]|0,this.Gl=Nr[13]|0,this.Hh=Nr[14]|0,this.Hl=Nr[15]|0}get(){const{Ah:e,Al:t,Bh:n,Bl:i,Ch:s,Cl:o,Dh:a,Dl:c,Eh:l,El:d,Fh:h,Fl:p,Gh:m,Gl:f,Hh:g,Hl:v}=this;return[e,t,n,i,s,o,a,c,l,d,h,p,m,f,g,v]}set(e,t,n,i,s,o,a,c,l,d,h,p,m,f,g,v){this.Ah=e|0,this.Al=t|0,this.Bh=n|0,this.Bl=i|0,this.Ch=s|0,this.Cl=o|0,this.Dh=a|0,this.Dl=c|0,this.Eh=l|0,this.El=d|0,this.Fh=h|0,this.Fl=p|0,this.Gh=m|0,this.Gl=f|0,this.Hh=g|0,this.Hl=v|0}process(e,t){for(let b=0;b<16;b++,t+=4)xa[b]=e.getUint32(t),Aa[b]=e.getUint32(t+=4);for(let b=16;b<80;b++){const E=xa[b-15]|0,A=Aa[b-15]|0,k=Bu(E,A,1)^Bu(E,A,8)^ck(E,A,7),x=Uu(E,A,1)^Uu(E,A,8)^lk(E,A,7),I=xa[b-2]|0,T=Aa[b-2]|0,L=Bu(I,T,19)^Y0(I,T,61)^ck(I,T,6),z=Uu(I,T,19)^J0(I,T,61)^lk(I,T,6),B=Dne(x,z,Aa[b-7],Aa[b-16]),G=$ne(B,k,L,xa[b-7],xa[b-16]);xa[b]=G|0,Aa[b]=B|0}let{Ah:n,Al:i,Bh:s,Bl:o,Ch:a,Cl:c,Dh:l,Dl:d,Eh:h,El:p,Fh:m,Fl:f,Gh:g,Gl:v,Hh:y,Hl:w}=this;for(let b=0;b<80;b++){const E=Bu(h,p,14)^Bu(h,p,18)^Y0(h,p,41),A=Uu(h,p,14)^Uu(h,p,18)^J0(h,p,41),k=h&m^~h&g,x=p&f^~p&v,I=Nne(w,A,x,Bne[b],Aa[b]),T=Mne(I,y,E,k,Lne[b],xa[b]),L=I|0,z=Bu(n,i,28)^Y0(n,i,34)^Y0(n,i,39),B=Uu(n,i,28)^J0(n,i,34)^J0(n,i,39),G=n&s^n&a^s&a,j=i&o^i&c^o&c;y=g|0,w=v|0,g=m|0,v=f|0,m=h|0,f=p|0,{h,l:p}=co(l|0,d|0,T|0,L|0),l=a|0,d=c|0,a=s|0,c=o|0,s=n|0,o=i|0;const q=Tne(L,B,j);n=Pne(q,T,z,G),i=q|0}({h:n,l:i}=co(this.Ah|0,this.Al|0,n|0,i|0)),{h:s,l:o}=co(this.Bh|0,this.Bl|0,s|0,o|0),{h:a,l:c}=co(this.Ch|0,this.Cl|0,a|0,c|0),{h:l,l:d}=co(this.Dh|0,this.Dl|0,l|0,d|0),{h,l:p}=co(this.Eh|0,this.El|0,h|0,p|0),{h:m,l:f}=co(this.Fh|0,this.Fl|0,m|0,f|0),{h:g,l:v}=co(this.Gh|0,this.Gl|0,g|0,v|0),{h:y,l:w}=co(this.Hh|0,this.Hl|0,y|0,w|0),this.set(n,i,s,o,a,c,l,d,h,p,m,f,g,v,y,w)}roundClean(){Hs(xa,Aa)}destroy(){Hs(this.buffer),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}}const Fne=xS(()=>new Rne),zne=xS(()=>new Une),Nl=Fne;let CS=class{constructor(e,t){u(this,"type","RSA");u(this,"jwk");u(this,"_raw");u(this,"_multihash");this.jwk=e,this._multihash=t}get raw(){return this._raw==null&&(this._raw=kS(this.jwk)),this._raw}toMultihash(){return this._multihash}toCID(){return iw.createV1(114,this._multihash)}toString(){return Si.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:He(this.raw,e.raw)}verify(e,t){return tie(this.jwk,t,e)}},eU=class{constructor(e,t){u(this,"type","RSA");u(this,"jwk");u(this,"_raw");u(this,"publicKey");this.jwk=e,this.publicKey=t}get raw(){return this._raw==null&&(this._raw=Hne(this.jwk)),this._raw}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:He(this.raw,e.raw)}sign(e){return eie(this.jwk,e)}};const tU=8192,IS=18,Vne=1062,Kne=Uint8Array.from([48,13,6,9,42,134,72,134,247,13,1,1,1,5,0]);function jne(r){return{n:re(r[1],"base64url"),e:re(r[2],"base64url"),d:re(r[3],"base64url"),p:re(r[4],"base64url"),q:re(r[5],"base64url"),dp:re(r[6],"base64url"),dq:re(r[7],"base64url"),qi:re(r[8],"base64url"),kty:"RSA"}}function Hne(r){if(r.n==null||r.e==null||r.d==null||r.p==null||r.q==null||r.dp==null||r.dq==null||r.qi==null)throw new Z("JWK was missing components");return Po([jn(Uint8Array.from([0])),jn(oe(r.n,"base64url")),jn(oe(r.e,"base64url")),jn(oe(r.d,"base64url")),jn(oe(r.p,"base64url")),jn(oe(r.q,"base64url")),jn(oe(r.dp,"base64url")),jn(oe(r.dq,"base64url")),jn(oe(r.qi,"base64url"))]).subarray()}function qne(r){const e=Uc(r[1],{offset:0});return{kty:"RSA",n:re(e[0],"base64url"),e:re(e[1],"base64url")}}function kS(r){if(r.n==null||r.e==null)throw new Z("JWK was missing components");return Po([Kne,lS(Po([jn(oe(r.n,"base64url")),jn(oe(r.e,"base64url"))]))]).subarray()}function Wne(r){const e=Uc(r);return rU(e)}function rU(r){const e=jne(r);return Qne(e)}function Gne(r,e){if(r.byteLength>=Vne)throw new F1("Key size is too large");const t=Uc(r,{offset:0});return nU(t,r,e)}function nU(r,e,t){const n=qne(r);if(t==null){const i=Nl(Sc.encode({Type:Mt.RSA,Data:e}));t=Wl(IS,i)}return new CS(n,t)}function Qne(r){if(nie(r)>tU)throw new Z("Key size is too large");const e=Jne(r),t=Nl(Sc.encode({Type:Mt.RSA,Data:kS(e.publicKey)})),n=Wl(IS,t);return new eU(e.privateKey,new CS(e.publicKey,n))}async function Yne(r){if(r>tU)throw new Z("Key size is too large");const e=await Zne(r),t=Nl(Sc.encode({Type:Mt.RSA,Data:kS(e.publicKey)})),n=Wl(IS,t);return new eU(e.privateKey,new CS(e.publicKey,n))}function Jne(r){if(r==null)throw new Z("Missing key parameter");return{privateKey:r,publicKey:{kty:r.kty,n:r.n,e:r.e}}}const Xne="1.2.840.113549.1.1.1";async function Zne(r){const e=await qs.get().subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:r,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign","verify"]),t=await rie(e);return{privateKey:t[0],publicKey:t[1]}}async function eie(r,e){const t=await qs.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["sign"]),n=await qs.get().subtle.sign({name:"RSASSA-PKCS1-v1_5"},t,e instanceof Uint8Array?e:e.subarray());return new Uint8Array(n,0,n.byteLength)}async function tie(r,e,t){const n=await qs.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]);return qs.get().subtle.verify({name:"RSASSA-PKCS1-v1_5"},n,e,t instanceof Uint8Array?t:t.subarray())}async function rie(r){if(r.privateKey==null||r.publicKey==null)throw new Z("Private and public key are required");return Promise.all([qs.get().subtle.exportKey("jwk",r.privateKey),qs.get().subtle.exportKey("jwk",r.publicKey)])}function nie(r){if(r.kty!=="RSA")throw new Z("invalid key type");if(r.n==null)throw new Z("invalid key modulus");return oe(r.n,"base64url").length*8}let iU=class extends kB{constructor(e,t){super(),this.finished=!1,this.destroyed=!1,Ote(e);const n=uS(t);if(this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const i=this.blockLen,s=new Uint8Array(i);s.set(n.length>i?e.create().update(n).digest():n);for(let o=0;o<s.length;o++)s[o]^=54;this.iHash.update(s),this.oHash=e.create();for(let o=0;o<s.length;o++)s[o]^=106;this.oHash.update(s),s.fill(0)}update(e){return ay(this),this.iHash.update(e),this}digestInto(e){ay(this),aw(e,this.outputLen),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){const e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||(e=Object.create(Object.getPrototypeOf(this),{}));const{oHash:t,iHash:n,finished:i,destroyed:s,blockLen:o,outputLen:a}=this;return e=e,e.finished=i,e.destroyed=s,e.blockLen=o,e.outputLen=a,e.oHash=t._cloneInto(e.oHash),e.iHash=n._cloneInto(e.iHash),e}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}};const sU=(r,e,t)=>new iU(r,e).update(t).digest();sU.create=(r,e)=>new iU(r,e);/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */function uk(r){r.lowS!==void 0&&dc("lowS",r.lowS),r.prehash!==void 0&&dc("prehash",r.prehash)}function iie(r){const e=gS(r);Nh(e,{a:"field",b:"field"},{allowedPrivateKeyLengths:"array",wrapPrivateKey:"boolean",isTorsionFree:"function",clearCofactor:"function",allowInfinityPoint:"boolean",fromBytes:"function",toBytes:"function"});const{endo:t,Fp:n,a:i}=e;if(t){if(!n.eql(i,n.ZERO))throw new Error("invalid endomorphism, can only be defined for Koblitz curves that have a=0");if(typeof t!="object"||typeof t.beta!="bigint"||typeof t.splitScalar!="function")throw new Error("invalid endomorphism, expected beta: bigint and splitScalar: function")}return Object.freeze({...e})}class sie extends Error{constructor(e=""){super(e)}}const vo={Err:sie,_tlv:{encode:(r,e)=>{const{Err:t}=vo;if(r<0||r>256)throw new t("tlv.encode: wrong tag");if(e.length&1)throw new t("tlv.encode: unpadded data");const n=e.length/2,i=H0(n);if(i.length/2&128)throw new t("tlv.encode: long form length too big");const s=n>127?H0(i.length/2|128):"";return H0(r)+s+i+e},decode(r,e){const{Err:t}=vo;let n=0;if(r<0||r>256)throw new t("tlv.encode: wrong tag");if(e.length<2||e[n++]!==r)throw new t("tlv.decode: wrong tlv");const i=e[n++],s=!!(i&128);let o=0;if(!s)o=i;else{const c=i&127;if(!c)throw new t("tlv.decode(long): indefinite length not supported");if(c>4)throw new t("tlv.decode(long): byte length is too big");const l=e.subarray(n,n+c);if(l.length!==c)throw new t("tlv.decode: length bytes not complete");if(l[0]===0)throw new t("tlv.decode(long): zero leftmost byte");for(const d of l)o=o<<8|d;if(n+=c,o<128)throw new t("tlv.decode(long): not minimal encoding")}const a=e.subarray(n,n+o);if(a.length!==o)throw new t("tlv.decode: wrong value length");return{v:a,l:e.subarray(n+o)}}},_int:{encode(r){const{Err:e}=vo;if(r<xo)throw new e("integer: negative integers are not allowed");let t=H0(r);if(Number.parseInt(t[0],16)&8&&(t="00"+t),t.length&1)throw new e("unexpected DER parsing assertion: unpadded hex");return t},decode(r){const{Err:e}=vo;if(r[0]&128)throw new e("invalid signature integer: negative");if(r[0]===0&&!(r[1]&128))throw new e("invalid signature integer: unnecessary leading zero");return Pl(r)}},toSig(r){const{Err:e,_int:t,_tlv:n}=vo,i=jt("signature",r),{v:s,l:o}=n.decode(48,i);if(o.length)throw new e("invalid signature: left bytes after parsing");const{v:a,l:c}=n.decode(2,s),{v:l,l:d}=n.decode(2,c);if(d.length)throw new e("invalid signature: left bytes after parsing");return{r:t.decode(a),s:t.decode(l)}},hexFromSig(r){const{_tlv:e,_int:t}=vo,n=e.encode(2,t.encode(r.r)),i=e.encode(2,t.encode(r.s)),s=n+i;return e.encode(48,s)}},xo=BigInt(0),ar=BigInt(1);BigInt(2);const dk=BigInt(3);BigInt(4);function oie(r){const e=iie(r),{Fp:t}=e,n=lw(e.n,e.nBitLength),i=e.toBytes||((g,v,y)=>{const w=v.toAffine();return Gd(Uint8Array.from([4]),t.toBytes(w.x),t.toBytes(w.y))}),s=e.fromBytes||(g=>{const v=g.subarray(1),y=t.fromBytes(v.subarray(0,t.BYTES)),w=t.fromBytes(v.subarray(t.BYTES,2*t.BYTES));return{x:y,y:w}});function o(g){const{a:v,b:y}=e,w=t.sqr(g),b=t.mul(w,g);return t.add(t.add(b,t.mul(g,v)),y)}if(!t.eql(t.sqr(e.Gy),o(e.Gx)))throw new Error("bad generator point: equation left != right");function a(g){return pS(g,ar,e.n)}function c(g){const{allowedPrivateKeyLengths:v,nByteLength:y,wrapPrivateKey:w,n:b}=e;if(v&&typeof g!="bigint"){if(qd(g)&&(g=Wd(g)),typeof g!="string"||!v.includes(g.length))throw new Error("invalid private key");g=g.padStart(y*2,"0")}let E;try{E=typeof g=="bigint"?g:Pl(jt("private key",g,y))}catch{throw new Error("invalid private key, expected hex or "+y+" bytes, got "+typeof g)}return w&&(E=St(E,b)),Gn("private key",E,ar,b),E}function l(g){if(!(g instanceof p))throw new Error("ProjectivePoint expected")}const d=ly((g,v)=>{const{px:y,py:w,pz:b}=g;if(t.eql(b,t.ONE))return{x:y,y:w};const E=g.is0();v==null&&(v=E?t.ONE:t.inv(b));const A=t.mul(y,v),k=t.mul(w,v),x=t.mul(b,v);if(E)return{x:t.ZERO,y:t.ZERO};if(!t.eql(x,t.ONE))throw new Error("invZ was invalid");return{x:A,y:k}}),h=ly(g=>{if(g.is0()){if(e.allowInfinityPoint&&!t.is0(g.py))return;throw new Error("bad point: ZERO")}const{x:v,y}=g.toAffine();if(!t.isValid(v)||!t.isValid(y))throw new Error("bad point: x or y not FE");const w=t.sqr(y),b=o(v);if(!t.eql(w,b))throw new Error("bad point: equation left != right");if(!g.isTorsionFree())throw new Error("bad point: not in prime-order subgroup");return!0});class p{constructor(v,y,w){if(v==null||!t.isValid(v))throw new Error("x required");if(y==null||!t.isValid(y))throw new Error("y required");if(w==null||!t.isValid(w))throw new Error("z required");this.px=v,this.py=y,this.pz=w,Object.freeze(this)}static fromAffine(v){const{x:y,y:w}=v||{};if(!v||!t.isValid(y)||!t.isValid(w))throw new Error("invalid affine point");if(v instanceof p)throw new Error("projective point not allowed");const b=E=>t.eql(E,t.ZERO);return b(y)&&b(w)?p.ZERO:new p(y,w,t.ONE)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}static normalizeZ(v){const y=t.invertBatch(v.map(w=>w.pz));return v.map((w,b)=>w.toAffine(y[b])).map(p.fromAffine)}static fromHex(v){const y=p.fromAffine(s(jt("pointHex",v)));return y.assertValidity(),y}static fromPrivateKey(v){return p.BASE.multiply(c(v))}static msm(v,y){return FB(p,n,v,y)}_setWindowSize(v){f.setWindowSize(this,v)}assertValidity(){h(this)}hasEvenY(){const{y:v}=this.toAffine();if(t.isOdd)return!t.isOdd(v);throw new Error("Field doesn't support isOdd")}equals(v){l(v);const{px:y,py:w,pz:b}=this,{px:E,py:A,pz:k}=v,x=t.eql(t.mul(y,k),t.mul(E,b)),I=t.eql(t.mul(w,k),t.mul(A,b));return x&&I}negate(){return new p(this.px,t.neg(this.py),this.pz)}double(){const{a:v,b:y}=e,w=t.mul(y,dk),{px:b,py:E,pz:A}=this;let k=t.ZERO,x=t.ZERO,I=t.ZERO,T=t.mul(b,b),L=t.mul(E,E),z=t.mul(A,A),B=t.mul(b,E);return B=t.add(B,B),I=t.mul(b,A),I=t.add(I,I),k=t.mul(v,I),x=t.mul(w,z),x=t.add(k,x),k=t.sub(L,x),x=t.add(L,x),x=t.mul(k,x),k=t.mul(B,k),I=t.mul(w,I),z=t.mul(v,z),B=t.sub(T,z),B=t.mul(v,B),B=t.add(B,I),I=t.add(T,T),T=t.add(I,T),T=t.add(T,z),T=t.mul(T,B),x=t.add(x,T),z=t.mul(E,A),z=t.add(z,z),T=t.mul(z,B),k=t.sub(k,T),I=t.mul(z,L),I=t.add(I,I),I=t.add(I,I),new p(k,x,I)}add(v){l(v);const{px:y,py:w,pz:b}=this,{px:E,py:A,pz:k}=v;let x=t.ZERO,I=t.ZERO,T=t.ZERO;const L=e.a,z=t.mul(e.b,dk);let B=t.mul(y,E),G=t.mul(w,A),j=t.mul(b,k),q=t.add(y,w),Q=t.add(E,A);q=t.mul(q,Q),Q=t.add(B,G),q=t.sub(q,Q),Q=t.add(y,b);let K=t.add(E,k);return Q=t.mul(Q,K),K=t.add(B,j),Q=t.sub(Q,K),K=t.add(w,b),x=t.add(A,k),K=t.mul(K,x),x=t.add(G,j),K=t.sub(K,x),T=t.mul(L,Q),x=t.mul(z,j),T=t.add(x,T),x=t.sub(G,T),T=t.add(G,T),I=t.mul(x,T),G=t.add(B,B),G=t.add(G,B),j=t.mul(L,j),Q=t.mul(z,Q),G=t.add(G,j),j=t.sub(B,j),j=t.mul(L,j),Q=t.add(Q,j),B=t.mul(G,Q),I=t.add(I,B),B=t.mul(K,Q),x=t.mul(q,x),x=t.sub(x,B),B=t.mul(q,G),T=t.mul(K,T),T=t.add(T,B),new p(x,I,T)}subtract(v){return this.add(v.negate())}is0(){return this.equals(p.ZERO)}wNAF(v){return f.wNAFCached(this,v,p.normalizeZ)}multiplyUnsafe(v){const{endo:y,n:w}=e;Gn("scalar",v,xo,w);const b=p.ZERO;if(v===xo)return b;if(this.is0()||v===ar)return this;if(!y||f.hasPrecomputes(this))return f.wNAFCachedUnsafe(this,v,p.normalizeZ);let{k1neg:E,k1:A,k2neg:k,k2:x}=y.splitScalar(v),I=b,T=b,L=this;for(;A>xo||x>xo;)A&ar&&(I=I.add(L)),x&ar&&(T=T.add(L)),L=L.double(),A>>=ar,x>>=ar;return E&&(I=I.negate()),k&&(T=T.negate()),T=new p(t.mul(T.px,y.beta),T.py,T.pz),I.add(T)}multiply(v){const{endo:y,n:w}=e;Gn("scalar",v,ar,w);let b,E;if(y){const{k1neg:A,k1:k,k2neg:x,k2:I}=y.splitScalar(v);let{p:T,f:L}=this.wNAF(k),{p:z,f:B}=this.wNAF(I);T=f.constTimeNegate(A,T),z=f.constTimeNegate(x,z),z=new p(t.mul(z.px,y.beta),z.py,z.pz),b=T.add(z),E=L.add(B)}else{const{p:A,f:k}=this.wNAF(v);b=A,E=k}return p.normalizeZ([b,E])[0]}multiplyAndAddUnsafe(v,y,w){const b=p.BASE,E=(k,x)=>x===xo||x===ar||!k.equals(b)?k.multiplyUnsafe(x):k.multiply(x),A=E(this,y).add(E(v,w));return A.is0()?void 0:A}toAffine(v){return d(this,v)}isTorsionFree(){const{h:v,isTorsionFree:y}=e;if(v===ar)return!0;if(y)return y(p,this);throw new Error("isTorsionFree() has not been declared for the elliptic curve")}clearCofactor(){const{h:v,clearCofactor:y}=e;return v===ar?this:y?y(p,this):this.multiplyUnsafe(e.h)}toRawBytes(v=!0){return dc("isCompressed",v),this.assertValidity(),i(p,this,v)}toHex(v=!0){return dc("isCompressed",v),Wd(this.toRawBytes(v))}}p.BASE=new p(e.Gx,e.Gy,t.ONE),p.ZERO=new p(t.ZERO,t.ONE,t.ZERO);const m=e.nBitLength,f=UB(p,e.endo?Math.ceil(m/2):m);return{CURVE:e,ProjectivePoint:p,normPrivateKeyToScalar:c,weierstrassEquation:o,isWithinCurveOrder:a}}function aie(r){const e=gS(r);return Nh(e,{hash:"hash",hmac:"function",randomBytes:"function"},{bits2int:"function",bits2int_modN:"function",lowS:"boolean"}),Object.freeze({lowS:!0,...e})}function cie(r){const e=aie(r),{Fp:t,n}=e,i=t.BYTES+1,s=2*t.BYTES+1;function o(j){return St(j,n)}function a(j){return bb(j,n)}const{ProjectivePoint:c,normPrivateKeyToScalar:l,weierstrassEquation:d,isWithinCurveOrder:h}=oie({...e,toBytes(j,q,Q){const K=q.toAffine(),O=t.toBytes(K.x),U=Gd;return dc("isCompressed",Q),Q?U(Uint8Array.from([q.hasEvenY()?2:3]),O):U(Uint8Array.from([4]),O,t.toBytes(K.y))},fromBytes(j){const q=j.length,Q=j[0],K=j.subarray(1);if(q===i&&(Q===2||Q===3)){const O=Pl(K);if(!pS(O,ar,t.ORDER))throw new Error("Point is not on curve");const U=d(O);let W;try{W=t.sqrt(U)}catch(ne){const ye=ne instanceof Error?": "+ne.message:"";throw new Error("Point is not on curve"+ye)}const Y=(W&ar)===ar;return(Q&1)===1!==Y&&(W=t.neg(W)),{x:O,y:W}}else if(q===s&&Q===4){const O=t.fromBytes(K.subarray(0,t.BYTES)),U=t.fromBytes(K.subarray(t.BYTES,2*t.BYTES));return{x:O,y:U}}else{const O=i,U=s;throw new Error("invalid Point, expected length of "+O+", or uncompressed "+U+", got "+q)}}}),p=j=>Wd(z1(j,e.nByteLength));function m(j){const q=n>>ar;return j>q}function f(j){return m(j)?o(-j):j}const g=(j,q,Q)=>Pl(j.slice(q,Q));class v{constructor(q,Q,K){Gn("r",q,ar,n),Gn("s",Q,ar,n),this.r=q,this.s=Q,K!=null&&(this.recovery=K),Object.freeze(this)}static fromCompact(q){const Q=e.nByteLength;return q=jt("compactSignature",q,Q*2),new v(g(q,0,Q),g(q,Q,2*Q))}static fromDER(q){const{r:Q,s:K}=vo.toSig(jt("DER",q));return new v(Q,K)}assertValidity(){}addRecoveryBit(q){return new v(this.r,this.s,q)}recoverPublicKey(q){const{r:Q,s:K,recovery:O}=this,U=k(jt("msgHash",q));if(O==null||![0,1,2,3].includes(O))throw new Error("recovery id invalid");const W=O===2||O===3?Q+e.n:Q;if(W>=t.ORDER)throw new Error("recovery id 2 or 3 invalid");const Y=O&1?"03":"02",H=c.fromHex(Y+p(W)),ne=a(W),ye=o(-U*ne),ue=o(K*ne),ce=c.BASE.multiplyAndAddUnsafe(H,ye,ue);if(!ce)throw new Error("point at infinify");return ce.assertValidity(),ce}hasHighS(){return m(this.s)}normalizeS(){return this.hasHighS()?new v(this.r,o(-this.s),this.recovery):this}toDERRawBytes(){return cy(this.toDERHex())}toDERHex(){return vo.hexFromSig({r:this.r,s:this.s})}toCompactRawBytes(){return cy(this.toCompactHex())}toCompactHex(){return p(this.r)+p(this.s)}}const y={isValidPrivateKey(j){try{return l(j),!0}catch{return!1}},normPrivateKeyToScalar:l,randomPrivateKey:()=>{const j=RB(e.n);return _re(e.randomBytes(j),e.n)},precompute(j=8,q=c.BASE){return q._setWindowSize(j),q.multiply(BigInt(3)),q}};function w(j,q=!0){return c.fromPrivateKey(j).toRawBytes(q)}function b(j){const q=qd(j),Q=typeof j=="string",K=(q||Q)&&j.length;return q?K===i||K===s:Q?K===2*i||K===2*s:j instanceof c}function E(j,q,Q=!0){if(b(j))throw new Error("first arg must be private key");if(!b(q))throw new Error("second arg must be public key");return c.fromHex(q).multiply(l(j)).toRawBytes(Q)}const A=e.bits2int||function(j){if(j.length>8192)throw new Error("input is too large");const q=Pl(j),Q=j.length*8-e.nBitLength;return Q>0?q>>BigInt(Q):q},k=e.bits2int_modN||function(j){return o(A(j))},x=cw(e.nBitLength);function I(j){return Gn("num < 2^"+e.nBitLength,j,xo,x),z1(j,e.nByteLength)}function T(j,q,Q=L){if(["recovered","canonical"].some(Me=>Me in Q))throw new Error("sign() legacy options not supported");const{hash:K,randomBytes:O}=e;let{lowS:U,prehash:W,extraEntropy:Y}=Q;U==null&&(U=!0),j=jt("msgHash",j),uk(Q),W&&(j=jt("prehashed msgHash",K(j)));const H=k(j),ne=l(q),ye=[I(ne),I(H)];if(Y!=null&&Y!==!1){const Me=Y===!0?O(t.BYTES):Y;ye.push(jt("extraEntropy",Me))}const ue=Gd(...ye),ce=H;function Ne(Me){const Xe=A(Me);if(!h(Xe))return;const tt=a(Xe),wt=c.BASE.multiply(Xe).toAffine(),bt=o(wt.x);if(bt===xo)return;const kt=o(tt*o(ce+bt*ne));if(kt===xo)return;let Qt=(wt.x===bt?0:2)|Number(wt.y&ar),pr=kt;return U&&m(kt)&&(pr=f(kt),Qt^=1),new v(bt,pr,Qt)}return{seed:ue,k2sig:Ne}}const L={lowS:e.lowS,prehash:!1},z={lowS:e.lowS,prehash:!1};function B(j,q,Q=L){const{seed:K,k2sig:O}=T(j,q,Q),U=e;return wre(U.hash.outputLen,U.nByteLength,U.hmac)(K,O)}c.BASE._setWindowSize(8);function G(j,q,Q,K=z){var Qt;const O=j;q=jt("msgHash",q),Q=jt("publicKey",Q);const{lowS:U,prehash:W,format:Y}=K;if(uk(K),"strict"in K)throw new Error("options.strict was renamed to lowS");if(Y!==void 0&&Y!=="compact"&&Y!=="der")throw new Error("format must be compact or der");const H=typeof O=="string"||qd(O),ne=!H&&!Y&&typeof O=="object"&&O!==null&&typeof O.r=="bigint"&&typeof O.s=="bigint";if(!H&&!ne)throw new Error("invalid signature, expected Uint8Array, hex string or Signature instance");let ye,ue;try{if(ne&&(ye=new v(O.r,O.s)),H){try{Y!=="compact"&&(ye=v.fromDER(O))}catch(pr){if(!(pr instanceof vo.Err))throw pr}!ye&&Y!=="der"&&(ye=v.fromCompact(O))}ue=c.fromHex(Q)}catch{return!1}if(!ye||U&&ye.hasHighS())return!1;W&&(q=e.hash(q));const{r:ce,s:Ne}=ye,Me=k(q),Xe=a(Ne),tt=o(Me*Xe),wt=o(ce*Xe),bt=(Qt=c.BASE.multiplyAndAddUnsafe(ue,tt,wt))==null?void 0:Qt.toAffine();return bt?o(bt.x)===ce:!1}return{CURVE:e,getPublicKey:w,getSharedSecret:E,sign:B,verify:G,ProjectivePoint:c,Signature:v,utils:y}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */function lie(r){return{hash:r,hmac:(e,...t)=>sU(r,e,Bte(...t)),randomBytes:dS}}function uie(r,e){const t=n=>cie({...r,...lie(n)});return{...t(e),create:t}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const oU=BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),hk=BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),die=BigInt(1),Cb=BigInt(2),fk=(r,e)=>(r+e/Cb)/e;function hie(r){const e=oU,t=BigInt(3),n=BigInt(6),i=BigInt(11),s=BigInt(22),o=BigInt(23),a=BigInt(44),c=BigInt(88),l=r*r*r%e,d=l*l*r%e,h=Rt(d,t,e)*d%e,p=Rt(h,t,e)*d%e,m=Rt(p,Cb,e)*l%e,f=Rt(m,i,e)*m%e,g=Rt(f,s,e)*f%e,v=Rt(g,a,e)*g%e,y=Rt(v,c,e)*v%e,w=Rt(y,a,e)*g%e,b=Rt(w,t,e)*d%e,E=Rt(b,o,e)*f%e,A=Rt(E,n,e)*l%e,k=Rt(A,Cb,e);if(!Ib.eql(Ib.sqr(k),r))throw new Error("Cannot find square root");return k}const Ib=lw(oU,void 0,void 0,{sqrt:hie}),Ws=uie({a:BigInt(0),b:BigInt(7),Fp:Ib,n:hk,Gx:BigInt("55066263022277343669578718895168534326250603453777594175500187360389116729240"),Gy:BigInt("32670510020758816978083085130507043184471273380659243275938904335757337482424"),h:BigInt(1),lowS:!0,endo:{beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),splitScalar:r=>{const e=hk,t=BigInt("0x3086d221a7d46bcde86c90e49284eb15"),n=-die*BigInt("0xe4437ed6010e88286f547fa90abfe4c3"),i=BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),s=t,o=BigInt("0x100000000000000000000000000000000"),a=fk(s*r,e),c=fk(-n*r,e);let l=St(r-a*t-c*i,e),d=St(-a*n-c*s,e);const h=l>o,p=d>o;if(h&&(l=e-l),p&&(d=e-d),l>o||d>o)throw new Error("splitScalar: Endomorphism failed, k="+r);return{k1neg:h,k1:l,k2neg:p,k2:d}}}},jte);BigInt(0);Ws.ProjectivePoint;function fie({name:r,code:e,encode:t}){return new pie(r,e,t)}let pie=class{constructor(e,t,n){u(this,"name");u(this,"code");u(this,"encode");this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?Wl(this.code,t):t.then(n=>Wl(this.code,n))}else throw Error("Unknown type, must be binary type")}};function gie(r){return async e=>new Uint8Array(await crypto.subtle.digest(r,e))}const aU=fie({name:"sha2-256",code:18,encode:gie("SHA-256")});function cU(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}const yie=33,mie=32;function wie(r,e){const t=aU.digest(e instanceof Uint8Array?e:e.subarray());if(cU(t))return t.then(({digest:n})=>Ws.sign(n,r).toDERRawBytes()).catch(n=>{throw new sk(String(n))});try{return Ws.sign(t.digest,r).toDERRawBytes()}catch(n){throw new sk(String(n))}}function bie(r,e,t){const n=aU.digest(t instanceof Uint8Array?t:t.subarray());if(cU(n))return n.then(({digest:i})=>Ws.verify(e,i,r)).catch(i=>{throw new ok(String(i))});try{return Ws.verify(e,n.digest,r)}catch(i){throw new ok(String(i))}}class lU{constructor(e){u(this,"type","secp256k1");u(this,"raw");u(this,"_key");this._key=xie(e),this.raw=Eie(this._key)}toMultihash(){return cS.digest(Pi(this))}toCID(){return iw.createV1(114,this.toMultihash())}toString(){return Si.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:He(this.raw,e.raw)}verify(e,t){return bie(this._key,t,e)}}class uU{constructor(e,t){u(this,"type","secp256k1");u(this,"raw");u(this,"publicKey");this.raw=Sie(e),this.publicKey=new lU(t??Aie(e))}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:He(this.raw,e.raw)}sign(e){return wie(this.raw,e)}}function dU(r){return new uU(r)}function _S(r){return new lU(r)}async function vie(){const r=Cie();return new uU(r)}function Eie(r){return Ws.ProjectivePoint.fromHex(r).toRawBytes(!0)}function Sie(r){try{return Ws.getPublicKey(r,!0),r}catch(e){throw new tS(String(e))}}function xie(r){try{return Ws.ProjectivePoint.fromHex(r),r}catch(e){throw new F1(String(e))}}function Aie(r){try{return Ws.getPublicKey(r,!0)}catch(e){throw new tS(String(e))}}function Cie(){return Ws.utils.randomPrivateKey()}async function dw(r,e){if(r==="Ed25519")return Wre();if(r==="secp256k1")return vie();if(r==="RSA")return Yne(_ie(e));if(r==="ECDSA")return Nte(Tie(e));throw new Eu}function Rn(r,e){const{Type:t,Data:n}=Sc.decode(r),i=n??new Uint8Array;switch(t){case Mt.RSA:return Gne(i,e);case Mt.Ed25519:return yS(i);case Mt.secp256k1:return _S(i);case Mt.ECDSA:return AB(i);default:throw new Eu}}function Iie(r){var n,i;if(r.byteLength===j1)return yS(r);if(r.byteLength===yie)return _S(r);const e=Uc(r),t=(n=e[1])==null?void 0:n[0];if(t===mB||t===wB||t===bB)return CB(e);if(((i=e[0])==null?void 0:i[0])===Xne)return nU(e,r);throw new Z("Could not extract public key from raw bytes")}function hU(r){const{Type:e,Data:t}=Sc.decode(r.digest),n=t??new Uint8Array;switch(e){case Mt.Ed25519:return yS(n);case Mt.secp256k1:return _S(n);case Mt.ECDSA:return AB(n);default:throw new Eu}}function Pi(r){return Sc.encode({Type:Mt[r.type],Data:r.raw})}function kie(r){const e=hy.decode(r),t=e.Data??new Uint8Array;switch(e.Type){case Mt.RSA:return Wne(t);case Mt.Ed25519:return jB(t);case Mt.secp256k1:return dU(t);case Mt.ECDSA:return Pte(t);default:throw new Eu}}function kb(r){var n;if(r.byteLength===bo)return jB(r);if(r.byteLength===mie)return dU(r);const e=Uc(r),t=(n=e[2])==null?void 0:n[0];if(t===mB||t===wB||t===bB)return xB(e);if(e.length>8)return rU(e);throw new Z("Could not extract private key from raw bytes")}function Vp(r){return hy.encode({Type:Mt[r.type],Data:r.raw})}function _ie(r){return r==null?2048:parseInt(r,10)}function Tie(r){if(r==="P-256"||r==null)return"P-256";if(r==="P-384")return"P-384";if(r==="P-521")return"P-521";throw new Z("Unsupported curve, should be P-256, P-384 or P-521")}async function fU(r){if(r.type==="RSA")return{privateKey:await crypto.subtle.importKey("jwk",r.jwk,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["sign"]),publicKey:await crypto.subtle.importKey("jwk",r.publicKey.jwk,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["verify"])};if(r.type==="ECDSA")return{privateKey:await crypto.subtle.importKey("jwk",r.jwk,{name:"ECDSA",namedCurve:r.jwk.crv??"P-256"},!0,["sign"]),publicKey:await crypto.subtle.importKey("jwk",r.publicKey.jwk,{name:"ECDSA",namedCurve:r.publicKey.jwk.crv??"P-256"},!0,["verify"])};throw new Z("Only RSA and ECDSA keys are supported")}function Pie(r,e){for(let t=0;t<r.byteLength;t++){if(r[t]<e[t])return-1;if(r[t]>e[t])return 1}return r.byteLength>e.byteLength?1:r.byteLength<e.byteLength?-1:0}const Die=async(r,e,t)=>{if(!r)throw new Error("No signature given");if(!e)throw new Error("Given publicKey was undefined");if(!t)throw new Error("Given input data was undefined");t instanceof Uint8Array||(t=typeof t=="string"?oe(t):new Uint8Array(t));const n=(s,o,a)=>s.verify(o,a);let i=!1;try{const s=Iie(oe(e,"base16"));i=await n(s,t,oe(r,"base16"))}catch{}return Promise.resolve(i)},_b=async(r,e)=>{if(!r)throw new Error("No signing key given");if(!e)throw new Error("Given input data was undefined");return e instanceof Uint8Array||(e=typeof e=="string"?oe(e):new Uint8Array(e)),re(await r.sign(e),"base16")},$ie=Vs({size:1e3}),pU=async(r,e,t)=>{const n=await $ie,i=await n.get(r);let s=!1;if(i){const o=(a,c)=>c instanceof Uint8Array?Pie(a,c)===0:a.toString()===c.toString();s=i.publicKey===e&&o(i.data,t)}else{const o=await Die(r,e,t);s=o,o&&await n.put(r,{publicKey:e,data:t})}return s},Nie="./keystore",gU=async({storage:r,path:e}={})=>{r=r||await _l(await Vs({size:1e3}),await ub({path:e||Nie}));const t=await Vs({size:1e3}),n=async()=>{await r.close(),await t.close()},i=async()=>{await r.clear(),await t.clear()},s=async d=>{if(!d)throw new Error("id needed to check a key");let h=!1,p=await t.get(d);if(p)h=!0;else try{p=await r.get("private_"+d),h=p!=null}catch{console.error("Error: ENOENT: no such file or directory")}return h},o=async(d,h)=>{const{privateKey:p}=h;await r.put("private_"+d,p);const m=kb(p);await t.put(d,m)};return{clear:i,close:n,hasKey:s,addKey:o,createKey:async d=>{if(!d)throw new Error("id needed to create a key");const h=await dw("secp256k1"),p={publicKey:h.publicKey.raw,privateKey:h.raw};return await o(d,p),h},getKey:async d=>{if(!d)throw new Error("id needed to get a key");let h=await t.get(d);if(!h){let p;try{p=await r.get("private_"+d)}catch{}if(!p)return;h=kb(p),await t.put(d,h)}return h},getPublic:(d,h={})=>{const p=["hex","buffer"],m=h.format||"hex";if(p.indexOf(m)===-1)throw new Error("Supported formats are `hex` and `buffer`");const f=d.publicKey.raw;return m==="buffer"?f:re(f,"base16")}}},yU=Np,mU=F3,Mie=on,wU=async({id:r,publicKey:e,signatures:t,type:n,sign:i,verify:s}={})=>{if(!r)throw new Error("Identity id is required");if(!e)throw new Error("Invalid public key");if(!t)throw new Error("Signatures object is required");if(!t.id)throw new Error("Signature of id is required");if(!t.publicKey)throw new Error("Signature of publicKey+id is required");if(!n)throw new Error("Identity type is required");t=Object.assign({},t);const o={id:r,publicKey:e,signatures:t,type:n,sign:i,verify:s},{hash:a,bytes:c}=await Oie(o);return o.hash=a,o.bytes=c,o},Oie=async r=>{const{id:e,publicKey:t,signatures:n,type:i}=r,s={id:e,publicKey:t,signatures:n,type:i},{cid:o,bytes:a}=await kh({value:s,codec:yU,hasher:mU});return{hash:o.toString(Mie),bytes:Uint8Array.from(a)}},Rie=async r=>{const{value:e}=await O3({bytes:r,codec:yU,hasher:mU});return wU({...e})},Lie=r=>!!(r.id&&r.hash&&r.bytes&&r.publicKey&&r.signatures&&r.signatures.id&&r.signatures.publicKey&&r.type),Bie=(r,e)=>r.id===e.id&&r.hash===e.hash&&r.type===e.type&&r.publicKey===e.publicKey&&r.signatures.id===e.signatures.id&&r.signatures.publicKey===e.signatures.publicKey,bU="publickey",Uie=async r=>{const{id:e,publicKey:t,signatures:n}=r;return pU(n.publicKey,e,t+n.id)},TS=({keystore:r})=>async()=>{if(!r)throw new Error("PublicKeyIdentityProvider requires a keystore parameter");return{type:bU,getId:async({id:n}={})=>{if(!n)throw new Error("id is required");const i=await r.getKey(n)||await r.createKey(n);return re(i.publicKey.raw,"base16")},signIdentity:async(n,{id:i}={})=>{if(!i)throw new Error("id is required");const s=await r.getKey(i);if(!s)throw new Error(`Signing key for '${i}' not found`);return _b(s,n)}}};TS.verifyIdentity=Uie;TS.type=bU;const PS={},Fie=r=>Object.keys(PS).includes(r),J5=r=>{if(!Fie(r))throw new Error(`IdentityProvider type '${r}' is not supported`);return PS[r]},zie=r=>{if(!r.type||typeof r.type!="string")throw new Error("Given IdentityProvider doesn't have a field 'type'.");if(!r.verifyIdentity)throw new Error("Given IdentityProvider doesn't have a function 'verifyIdentity'.");PS[r.type]=r};zie(TS);const Vie=lc("./orbitdb","identities"),Kie=async({keystore:r,path:e,storage:t,ipfs:n}={})=>{r=r||await gU({path:e||Vie}),t||(t=n?await _l(await Vs({size:1e3}),await K3({ipfs:n,pin:!0})):await UE());const i=await Vs({size:1e3}),s=async d=>{const h=await t.get(d);if(h)return Rie(h)},o=async(d={})=>{d.keystore=r;const h=J5("publickey"),m=await(d.provider||h({keystore:r}))();if(!J5(m.type))throw new Error("Identity provider is unknown. Use useIdentityProvider(provider) to register the identity provider");const f=await m.getId(d),g=await r.getKey(f)||await r.createKey(f),v=r.getPublic(g),y=await _b(g,f),w=await m.signIdentity(v+y,d),E=await wU({id:f,publicKey:v,signatures:{id:y,publicKey:w},type:m.type,sign:c,verify:l});return await t.put(E.hash,E.bytes),E},a=async d=>{if(!Lie(d))return!1;const{id:h,publicKey:p,signatures:m}=d;if(!await l(m.id,p,h))return!1;const g=await i.get(m.id);if(g)return Bie(d,g);const y=await J5(d.type).verifyIdentity(d);return y&&await i.put(m.id,d),y},c=async(d,h)=>{const p=await r.getKey(d.id);if(!p)throw new Error("Private signing key not found from KeyStore");return await _b(p,h)},l=async(d,h,p)=>await pU(d,h,p);return{createIdentity:o,verifyIdentity:a,getIdentity:s,sign:c,verify:l,keystore:r}},jie=r=>{if(r=r.toString(),!r.startsWith("/orbitdb")&&!r.startsWith("\\orbitdb"))return!1;r=r.replaceAll("/orbitdb/",""),r=r.replaceAll("\\orbitdb\\",""),r=r.replaceAll("/",""),r=r.replaceAll("\\","");let e;try{e=fs.parse(r,on)}catch{return!1}return e!==void 0},pk=r=>{if(r&&r.protocol==="orbitdb"&&r.hash)return r;const e="orbitdb",t=r.replace("/orbitdb/","").replace("\\orbitdb\\","");return{protocol:e,hash:t,address:r,toString:()=>lc("/",e,t)}},gk=Np,yk=F3,Hie=on,qie=async({ipfs:r,storage:e}={})=>(e=e||await _l(await Vs({size:1e5}),await K3({ipfs:r,pin:!0})),{get:async s=>{const o=await e.get(s),{value:a}=await O3({bytes:o,codec:gk,hasher:yk});return a&&await e.put(s,o),a},create:async({name:s,type:o,accessController:a,meta:c})=>{if(!s)throw new Error("name is required");if(!o)throw new Error("type is required");if(!a)throw new Error("accessController is required");const l=Object.assign({name:s,type:o,accessController:a},c!==void 0?{meta:c}:{}),{cid:d,bytes:h}=await kh({value:l,codec:gk,hasher:yk}),p=d.toString(Hie);return await e.put(p,h),{hash:p,manifest:l}},close:async()=>{await e.close()}}),vU=async(r=32)=>{const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";let t="",n=0;for(;n<r;)t+=e.charAt(Math.floor(Math.random()*e.length)),n+=1;return t},EU=Np,SU=F3,Wie=on,Gie=async({storage:r,type:e,params:t})=>{const n={type:e,...t},{cid:i,bytes:s}=await kh({value:n,codec:EU,hasher:SU}),o=i.toString(Wie);return await r.put(o,s),o},Gg="ipfs",hw=({write:r,storage:e}={})=>async({orbitdb:t,identities:n,address:i})=>{if(e=e||await _l(await Vs({size:1e3}),await K3({ipfs:t.ipfs,pin:!0})),r=r||[t.identity.id],i){const o=await e.get(i.replaceAll("/ipfs/","")),{value:a}=await O3({bytes:o,codec:EU,hasher:SU});r=a.write}else i=await Gie({storage:e,type:Gg,params:{write:r}}),i=lc("/",Gg,i);return{type:Gg,address:i,write:r,canAppend:async o=>{const a=await n.getIdentity(o.identity);if(!a)return!1;const{id:c}=a;return r.includes(c)||r.includes("*")?await n.verifyIdentity(a):!1}}};hw.type=Gg;const xU="orbitdb",AU=({write:r}={})=>async({orbitdb:e,identities:t,address:n,name:i})=>{n=n||i||await vU(64),r=r||[e.identity.id];const s=await e.open(n,{type:"keyvalue",AccessController:hw({write:r})});n=s.address;const o=async f=>{const g=await t.getIdentity(f.identity);if(!g)return!1;const{id:v}=g;return await h("write",v)||await h("admin",v)?await t.verifyIdentity(g):!1},a=async()=>{const f=[];for await(const v of s.iterator())f[v.key]=v.value;const g=v=>{const y=v[0];f[y]=new Set([...f[y]||[],...v[1]])};return Object.entries({...f,admin:new Set([...f.admin||[],...s.access.write])}).forEach(g),f},c=async f=>(await a())[f]||new Set([]),l=async()=>{await s.close()},d=async()=>{await s.drop()},h=async(f,g)=>{const v=new Set(await c(f));return v.has(g)||v.has("*")};return{type:xU,address:n,write:r,canAppend:o,capabilities:a,get:c,grant:async(f,g)=>{const v=new Set([...await s.get(f)||[],g]);await s.put(f,Array.from(v.values()))},revoke:async(f,g)=>{const v=new Set(await s.get(f)||[]);v.delete(g),v.size>0?await s.put(f,Array.from(v.values())):await s.del(f)},close:l,drop:d,events:s.events}};AU.type=xU;const Tb={},Qie=r=>{if(!Tb[r])throw new Error(`AccessController type '${r}' is not supported`);return Tb[r]},CU=r=>{if(!r.type)throw new Error("AccessController does not contain required field 'type'.");Tb[r.type]=r};CU(hw);CU(AU);const Yie="events",Jie=hw,IU=async({ipfs:r,id:e,identity:t,identities:n,directory:i}={})=>{if(r==null)throw new Error("IPFS instance is a required argument.");e=e||await vU();const s=r.libp2p.peerId;i=i||"./orbitdb";let o;n?o=n.keystore:(o=await gU({path:lc(i,"./keystore")}),n=await Kie({ipfs:r,keystore:o})),t?t.provider&&(t=await n.createIdentity({...t})):t=await n.createIdentity({id:e});const a=await qie({ipfs:r});let c={};const l=async(p,{type:m,meta:f,sync:g,Database:v,AccessController:y,headsStorage:w,entryStorage:b,indexStorage:E,referencesCount:A}={})=>{let k,x,I;if(c[p])return c[p];if(jie(p)){const L=pk(p);x=await a.get(L.hash);const z=x.accessController.split("/",2).pop();y=Qie(z)(),I=await y({orbitdb:{open:l,identity:t,ipfs:r},identities:n,address:x.accessController}),k=x.name,m=m||x.type,f=x.meta}else{m=m||Yie,y=y||Jie(),I=await y({orbitdb:{open:l,identity:t,ipfs:r},identities:n,name:p});const L=await a.create({name:p,type:m,accessController:I.address,meta:f});if(x=L.manifest,p=pk(L.hash),k=x.name,f=x.meta,c[p])return c[p]}if(v=v||OZ(m)(),!v)throw new Error(`Unsupported database type: '${m}'`);p=p.toString();const T=await v({ipfs:r,identity:t,address:p,name:k,access:I,directory:i,meta:f,syncAutomatically:g,headsStorage:w,entryStorage:b,indexStorage:E,referencesCount:A});return T.events.on("close",d(p)),c[p]=T,T},d=p=>()=>{delete c[p]};return{id:e,open:l,stop:async()=>{for(const p of Object.values(c))await p.close();o&&await o.close(),a&&await a.close(),c={}},ipfs:r,directory:i,keystore:o,identities:n,identity:t,peerId:s}};function dt(r){const e=new globalThis.AbortController;function t(){e.abort();for(const s of r)(s==null?void 0:s.removeEventListener)!=null&&s.removeEventListener("abort",t)}for(const s of r){if((s==null?void 0:s.aborted)===!0){t();break}(s==null?void 0:s.addEventListener)!=null&&s.addEventListener("abort",t)}function n(){for(const s of r)(s==null?void 0:s.removeEventListener)!=null&&s.removeEventListener("abort",t)}const i=e.signal;return i.clear=n,i}let Xie=class extends Error{constructor(t,n){super(t??"The operation was aborted");u(this,"type");u(this,"code");this.type="aborted",this.name="AbortError",this.code=n??"ABORT_ERR"}};async function Ci(r,e,t,n){const i=new Xie(n==null?void 0:n.errorMessage,n==null?void 0:n.errorCode);return(t==null?void 0:t.aborted)===!0?Promise.reject(i):new Promise((s,o)=>{function a(){t==null||t.removeEventListener("abort",d),r.removeEventListener(e,c),(n==null?void 0:n.errorEvent)!=null&&r.removeEventListener(n.errorEvent,l)}const c=h=>{var p;try{if(((p=n==null?void 0:n.filter)==null?void 0:p.call(n,h))===!1)return}catch(m){a(),o(m);return}a(),s(h)},l=h=>{a(),o(h.detail)},d=()=>{a(),o(i)};t==null||t.addEventListener("abort",d),r.addEventListener(e,c),(n==null?void 0:n.errorEvent)!=null&&r.addEventListener(n.errorEvent,l)})}class Zie extends Error{constructor(t="Rate limit exceeded",n){super(t);u(this,"remainingPoints");u(this,"msBeforeNext");u(this,"consumedPoints");u(this,"isFirstInDuration");this.name="RateLimitError",this.remainingPoints=n.remainingPoints,this.msBeforeNext=n.msBeforeNext,this.consumedPoints=n.consumedPoints,this.isFirstInDuration=n.isFirstInDuration}}class kU extends Error{constructor(e="The queue was full"){super(e),this.name="QueueFullError"}}u(kU,"name","QueueFullError");class ese{constructor(e){u(this,"deferred");u(this,"signal");var t;this.signal=e,this.deferred=Le(),this.onAbort=this.onAbort.bind(this),(t=this.signal)==null||t.addEventListener("abort",this.onAbort)}onAbort(){var e;this.deferred.reject(((e=this.signal)==null?void 0:e.reason)??new Hl)}cleanup(){var e;(e=this.signal)==null||e.removeEventListener("abort",this.onAbort)}}function tse(){return`${parseInt(String(Math.random()*1e9),10).toString()}${Date.now()}`}class rse{constructor(e,t){u(this,"id");u(this,"fn");u(this,"options");u(this,"recipients");u(this,"status");u(this,"timeline");u(this,"controller");this.id=tse(),this.status="queued",this.fn=e,this.options=t,this.recipients=[],this.timeline={created:Date.now()},this.controller=new AbortController,this.controller.signal,this.onAbort=this.onAbort.bind(this)}abort(e){this.controller.abort(e)}onAbort(){this.recipients.reduce((t,n)=>{var i;return t&&((i=n.signal)==null?void 0:i.aborted)===!0},!0)&&(this.controller.abort(new Hl),this.cleanup())}async join(e={}){var n;const t=new ese(e.signal);return this.recipients.push(t),(n=e.signal)==null||n.addEventListener("abort",this.onAbort),t.deferred.promise}async run(){this.status="running",this.timeline.started=Date.now();try{this.controller.signal.throwIfAborted();const e=await cn(this.fn({...this.options??{},signal:this.controller.signal}),this.controller.signal);this.recipients.forEach(t=>{t.deferred.resolve(e)}),this.status="complete"}catch(e){this.recipients.forEach(t=>{t.deferred.reject(e)}),this.status="errored"}finally{this.timeline.finished=Date.now(),this.cleanup()}}cleanup(){this.recipients.forEach(e=>{var t;e.cleanup(),(t=e.signal)==null||t.removeEventListener("abort",this.onAbort)})}}class Gl extends er{constructor(t={}){var n;super();u(this,"concurrency");u(this,"maxSize");u(this,"queue");u(this,"pending");u(this,"sort");this.concurrency=t.concurrency??Number.POSITIVE_INFINITY,this.maxSize=t.maxSize??Number.POSITIVE_INFINITY,this.pending=0,t.metricName!=null&&((n=t.metrics)==null||n.registerMetricGroup(t.metricName,{calculate:()=>({size:this.queue.length,running:this.pending,queued:this.queue.length-this.pending})})),this.sort=t.sort,this.queue=[]}tryToStartAnother(){if(this.size===0)return queueMicrotask(()=>{this.safeDispatchEvent("empty")}),this.running===0&&queueMicrotask(()=>{this.safeDispatchEvent("idle")}),!1;if(this.pending<this.concurrency){let t;for(const n of this.queue)if(n.status==="queued"){t=n;break}return t==null?!1:(this.safeDispatchEvent("active"),this.pending++,t.run().finally(()=>{for(let n=0;n<this.queue.length;n++)if(this.queue[n]===t){this.queue.splice(n,1);break}this.pending--,this.tryToStartAnother(),this.safeDispatchEvent("next")}),!0)}return!1}enqueue(t){this.queue.push(t),this.sort!=null&&this.queue.sort(this.sort)}async add(t,n){var s;if((s=n==null?void 0:n.signal)==null||s.throwIfAborted(),this.size===this.maxSize)throw new kU;const i=new rse(t,n);return this.enqueue(i),this.safeDispatchEvent("add"),this.tryToStartAnother(),i.join(n).then(o=>(this.safeDispatchEvent("completed",{detail:o}),this.safeDispatchEvent("success",{detail:{job:i,result:o}}),o)).catch(o=>{if(i.status==="queued"){for(let a=0;a<this.queue.length;a++)if(this.queue[a]===i){this.queue.splice(a,1);break}}throw this.safeDispatchEvent("error",{detail:o}),this.safeDispatchEvent("failure",{detail:{job:i,error:o}}),o})}clear(){this.queue.splice(0,this.queue.length)}abort(){this.queue.forEach(t=>{t.abort(new Hl)}),this.clear()}async onEmpty(t){this.size!==0&&await Ci(this,"empty",t==null?void 0:t.signal)}async onSizeLessThan(t,n){this.size<t||await Ci(this,"next",n==null?void 0:n.signal,{filter:()=>this.size<t})}async onIdle(t){this.pending===0&&this.size===0||await Ci(this,"idle",t==null?void 0:t.signal)}get size(){return this.queue.length}get queued(){return this.queue.length-this.pending}get running(){return this.pending}async*toGenerator(t){var l,d,h;(l=t==null?void 0:t.signal)==null||l.throwIfAborted();const n=Fo({objectMode:!0}),i=p=>{p!=null?this.abort():this.clear(),n.end(p)},s=p=>{p.detail!=null&&n.push(p.detail)},o=p=>{i(p.detail)},a=()=>{i()},c=()=>{i(new Hl("Queue aborted"))};this.addEventListener("completed",s),this.addEventListener("error",o),this.addEventListener("idle",a),(d=t==null?void 0:t.signal)==null||d.addEventListener("abort",c);try{yield*n}finally{this.removeEventListener("completed",s),this.removeEventListener("error",o),this.removeEventListener("idle",a),(h=t==null?void 0:t.signal)==null||h.removeEventListener("abort",c),i()}}}class Ac extends Gl{has(e){return this.find(e)!=null}find(e){return this.queue.find(t=>e.equals(t.options.peerId))}}const nse=8,DS=1024*1024*4;let ise=class extends Error{constructor(){super(...arguments);u(this,"name","InvalidMessageLengthError");u(this,"code","ERR_INVALID_MSG_LENGTH")}},_U=class extends Error{constructor(){super(...arguments);u(this,"name","InvalidDataLengthError");u(this,"code","ERR_MSG_DATA_TOO_LONG")}},sse=class extends Error{constructor(){super(...arguments);u(this,"name","InvalidDataLengthLengthError");u(this,"code","ERR_MSG_LENGTH_TOO_LONG")}},mk=class extends Error{constructor(){super(...arguments);u(this,"name","UnexpectedEOFError");u(this,"code","ERR_UNEXPECTED_EOF")}};function TU(r){return r[Symbol.asyncIterator]!=null}function PU(r,e){if(r.byteLength>e)throw new _U("Message length too long")}const fw=r=>{const e=gt(r),t=Mn(e);return xr(r,t),fw.bytes=e,t};fw.bytes=0;function Qd(r,e){e=e??{};const t=e.lengthEncoder??fw,n=(e==null?void 0:e.maxDataLength)??DS;function*i(s){PU(s,n);const o=t(s.byteLength);o instanceof Uint8Array?yield o:yield*o,s instanceof Uint8Array?yield s:yield*s}return TU(r)?async function*(){for await(const s of r)yield*i(s)}():function*(){for(const s of r)yield*i(s)}()}Qd.single=(r,e)=>{e=e??{};const t=e.lengthEncoder??fw,n=(e==null?void 0:e.maxDataLength)??DS;return PU(r,n),new Ue(t(r.byteLength),r)};var ll;(function(r){r[r.LENGTH=0]="LENGTH",r[r.DATA=1]="DATA"})(ll||(ll={}));const $S=r=>{const e=gs(r);return $S.bytes=gt(e),e};$S.bytes=0;function Yd(r,e){const t=new Ue;let n=ll.LENGTH,i=-1;const s=(e==null?void 0:e.lengthDecoder)??$S,o=(e==null?void 0:e.maxLengthLength)??nse,a=(e==null?void 0:e.maxDataLength)??DS;function*c(){for(;t.byteLength>0;){if(n===ll.LENGTH)try{if(i=s(t),i<0)throw new ise("Invalid message length");if(i>a)throw new _U("Message length too long");const l=s.bytes;t.consume(l),(e==null?void 0:e.onLength)!=null&&e.onLength(i),n=ll.DATA}catch(l){if(l instanceof RangeError){if(t.byteLength>o)throw new sse("Message length length too long");break}throw l}if(n===ll.DATA){if(t.byteLength<i)break;const l=t.sublist(0,i);t.consume(i),(e==null?void 0:e.onData)!=null&&e.onData(l),yield l,n=ll.LENGTH}}}return TU(r)?async function*(){for await(const l of r)t.append(l),yield*c();if(t.byteLength>0)throw new mk("Unexpected end of input")}():function*(){for(const l of r)t.append(l),yield*c();if(t.byteLength>0)throw new mk("Unexpected end of input")}()}Yd.fromReader=(r,e)=>{let t=1;const n=async function*(){for(;;)try{const{done:s,value:o}=await r.next(t);if(s===!0)return;o!=null&&(yield o)}catch(s){if(s.code==="ERR_UNDER_READ")return{done:!0,value:null};throw s}finally{t=1}}();return Yd(n,{...e??{},onLength:s=>{t=s}})};function NS(r){const[e,t]=r[Symbol.asyncIterator]!=null?[r[Symbol.asyncIterator](),Symbol.asyncIterator]:[r[Symbol.iterator](),Symbol.iterator],n=[];return{peek:()=>e.next(),push:i=>{n.push(i)},next:()=>n.length>0?{done:!1,value:n.shift()}:e.next(),[t](){return this}}}function ose(r){return r[Symbol.asyncIterator]!=null}function Mh(r,e){let t=0;if(ose(r))return async function*(){for await(const c of r)yield e(c,t++)}();const n=NS(r),{value:i,done:s}=n.next();if(s===!0)return function*(){}();const o=e(i,t++);if(typeof o.then=="function")return async function*(){yield await o;for await(const c of n)yield e(c,t++)}();const a=e;return function*(){yield o;for(const c of n)yield a(c,t++)}()}function ase(r){return r[Symbol.asyncIterator]!=null}function py(r,e){return ase(r)?async function*(){let t=0;if(!(e<1)){for await(const n of r)if(yield n,t++,t===e)return}}():function*(){let t=0;if(!(e<1)){for(const n of r)if(yield n,t++,t===e)return}}()}class _e extends Event{constructor(t,n){super(t);u(this,"type");u(this,"detail");this.type=t,this.detail=n}}const X0="/ipfs/bitswap/1.2.0",cse=1024,lse=1024,use=1024,dse=5e3,hse=10,fse=50,pse=!1,gse=3,DU=1024*1024*4,yse=DU;var cr;(function(r){r.WantBlock="WantBlock",r.WantHave="WantHave"})(cr||(cr={}));var Pb;(function(r){r[r.WantBlock=0]="WantBlock",r[r.WantHave=1]="WantHave"})(Pb||(Pb={}));(function(r){r.codec=()=>On(Pb)})(cr||(cr={}));var W1;(function(r){let e;r.codec=()=>(e==null&&(e=$e((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.cid!=null&&t.cid.byteLength>0&&(n.uint32(10),n.bytes(t.cid)),t.priority!=null&&t.priority!==0&&(n.uint32(16),n.int32(t.priority)),t.cancel!=null&&(n.uint32(24),n.bool(t.cancel)),t.wantType!=null&&(n.uint32(32),cr.codec().encode(t.wantType,n)),t.sendDontHave!=null&&(n.uint32(40),n.bool(t.sendDontHave)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{const s={cid:Ye(0),priority:0},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.cid=t.bytes();break}case 2:{s.priority=t.int32();break}case 3:{s.cancel=t.bool();break}case 4:{s.wantType=cr.codec().decode(t);break}case 5:{s.sendDontHave=t.bool();break}default:{t.skipType(a&7);break}}}return s})),e),r.encode=t=>De(t,r.codec()),r.decode=(t,n)=>Pe(t,r.codec(),n)})(W1||(W1={}));var gy;(function(r){let e;r.codec=()=>(e==null&&(e=$e((t,n,i={})=>{if(i.lengthDelimited!==!1&&n.fork(),t.entries!=null)for(const s of t.entries)n.uint32(10),W1.codec().encode(s,n);t.full!=null&&(n.uint32(16),n.bool(t.full)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{var a,c;const s={entries:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{if(((a=i.limits)==null?void 0:a.entries)!=null&&s.entries.length===i.limits.entries)throw new pt('Decode error - map field "entries" had too many elements');s.entries.push(W1.codec().decode(t,t.uint32(),{limits:(c=i.limits)==null?void 0:c.entries$}));break}case 2:{s.full=t.bool();break}default:{t.skipType(l&7);break}}}return s})),e),r.encode=t=>De(t,r.codec()),r.decode=(t,n)=>Pe(t,r.codec(),n)})(gy||(gy={}));var G1;(function(r){let e;r.codec=()=>(e==null&&(e=$e((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.prefix!=null&&t.prefix.byteLength>0&&(n.uint32(10),n.bytes(t.prefix)),t.data!=null&&t.data.byteLength>0&&(n.uint32(18),n.bytes(t.data)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{const s={prefix:Ye(0),data:Ye(0)},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.prefix=t.bytes();break}case 2:{s.data=t.bytes();break}default:{t.skipType(a&7);break}}}return s})),e),r.encode=t=>De(t,r.codec()),r.decode=(t,n)=>Pe(t,r.codec(),n)})(G1||(G1={}));var Ks;(function(r){r.HaveBlock="HaveBlock",r.DoNotHaveBlock="DoNotHaveBlock"})(Ks||(Ks={}));var yy;(function(r){r[r.HaveBlock=0]="HaveBlock",r[r.DoNotHaveBlock=1]="DoNotHaveBlock"})(yy||(yy={}));(function(r){r.codec=()=>On(yy)})(Ks||(Ks={}));var Q1;(function(r){let e;r.codec=()=>(e==null&&(e=$e((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.cid!=null&&t.cid.byteLength>0&&(n.uint32(10),n.bytes(t.cid)),t.type!=null&&yy[t.type]!==0&&(n.uint32(16),Ks.codec().encode(t.type,n)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{const s={cid:Ye(0),type:Ks.HaveBlock},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.cid=t.bytes();break}case 2:{s.type=Ks.codec().decode(t);break}default:{t.skipType(a&7);break}}}return s})),e),r.encode=t=>De(t,r.codec()),r.decode=(t,n)=>Pe(t,r.codec(),n)})(Q1||(Q1={}));var Y1;(function(r){let e;r.codec=()=>(e==null&&(e=$e((t,n,i={})=>{if(i.lengthDelimited!==!1&&n.fork(),t.wantlist!=null&&(n.uint32(10),gy.codec().encode(t.wantlist,n)),t.blocks!=null)for(const s of t.blocks)n.uint32(26),G1.codec().encode(s,n);if(t.blockPresences!=null)for(const s of t.blockPresences)n.uint32(34),Q1.codec().encode(s,n);t.pendingBytes!=null&&t.pendingBytes!==0&&(n.uint32(40),n.int32(t.pendingBytes)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{var a,c,l,d,h;const s={blocks:[],blockPresences:[],pendingBytes:0},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const p=t.uint32();switch(p>>>3){case 1:{s.wantlist=gy.codec().decode(t,t.uint32(),{limits:(a=i.limits)==null?void 0:a.wantlist});break}case 3:{if(((c=i.limits)==null?void 0:c.blocks)!=null&&s.blocks.length===i.limits.blocks)throw new pt('Decode error - map field "blocks" had too many elements');s.blocks.push(G1.codec().decode(t,t.uint32(),{limits:(l=i.limits)==null?void 0:l.blocks$}));break}case 4:{if(((d=i.limits)==null?void 0:d.blockPresences)!=null&&s.blockPresences.length===i.limits.blockPresences)throw new pt('Decode error - map field "blockPresences" had too many elements');s.blockPresences.push(Q1.codec().decode(t,t.uint32(),{limits:(h=i.limits)==null?void 0:h.blockPresences$}));break}case 5:{s.pendingBytes=t.int32();break}default:{t.skipType(p&7);break}}}return s})),e),r.encode=t=>De(t,r.codec()),r.decode=(t,n)=>Pe(t,r.codec(),n)})(Y1||(Y1={}));function mse(r,e){for(const[t,n]of e.wantlist.entries()){const i=r.wantlist.get(t);i!=null&&(i.priority>n.priority&&(n.priority=i.priority),n.cancel=n.cancel??i.cancel,n.wantType=n.wantType??i.wantType,n.sendDontHave=n.sendDontHave??i.sendDontHave),r.wantlist.set(t,n)}for(const[t,n]of e.blockPresences.entries())r.blockPresences.set(t,n);for(const[t,n]of e.blocks.entries())r.blocks.set(t,n);return e.full&&!r.full&&(r.full=!0),r}class $U extends Error{constructor(e="Block too large"){super(e),this.name="BlockTooLargeError"}}u($U,"name","BlockTooLargeError");const wse=4193648,bse=wse+16;function*vse(r,e){const t=[...r.wantlist.values()],n=[...r.blockPresences.values()],i=[...r.blocks.values()];let s=0,o=0,a=0,c=!1;for(;;){const l={wantlist:{full:r.full??!1,entries:[]},blockPresences:[],blocks:[],pendingBytes:0};let d=Y1.encode(l).byteLength,{added:h,hasMore:p,newSize:m}=X5(i,l.blocks,a,e,d,Ese);a+=h,d=m;const f=p;({added:h,hasMore:p,newSize:m}=X5(n,l.blockPresences,o,e,d,Sse)),o+=h,d=m;const g=p;if({added:h,hasMore:p,newSize:m}=X5(t,l.wantlist.entries,s,e,d,xse),s+=h,d=m,c=!f&&!g&&!p,c||(l.wantlist.full=!1),yield Y1.encode(l),c)break}}function X5(r,e,t,n,i,s){let o=0,a=!1;for(let c=t;c<r.length;c++){const l=r[c],d=s(l);if(d>bse)throw new $U("Cannot send block as after encoding it is over the max message size");const h=i+d;if(h>n){a=!0;break}e.push(l),o++,i=h}return{hasMore:a,added:o,newSize:i}}function Ese(r){return MS(3,G1.encode(r))}function Sse(r){return MS(4,Q1.encode(r))}function xse(r){return MS(1,W1.encode(r))}function MS(r,e){const t=gt(r),n=gt(e.byteLength);return t+n+e.byteLength}let Ase=class extends er{constructor(t,n={}){var i,s;super();u(this,"log");u(this,"libp2p");u(this,"routing");u(this,"protocols");u(this,"running");u(this,"maxInboundStreams");u(this,"maxOutboundStreams");u(this,"messageReceiveTimeout");u(this,"registrarIds");u(this,"metrics");u(this,"sendQueue");u(this,"runOnLimitedConnections");u(this,"maxOutgoingMessageSize");u(this,"maxIncomingMessageSize");this.log=t.logger.forComponent("helia:bitswap:network"),this.libp2p=t.libp2p,this.routing=t.routing,this.protocols=n.protocols??[X0],this.registrarIds=[],this.running=!1,this._onStream=this._onStream.bind(this),this.maxInboundStreams=n.maxInboundStreams??lse,this.maxOutboundStreams=n.maxOutboundStreams??use,this.messageReceiveTimeout=n.messageReceiveTimeout??dse,this.runOnLimitedConnections=n.runOnLimitedConnections??pse,this.maxIncomingMessageSize=n.maxIncomingMessageSize??DU,this.maxOutgoingMessageSize=n.maxOutgoingMessageSize??n.maxIncomingMessageSize??yse,this.metrics={blocksSent:(i=t.metrics)==null?void 0:i.registerCounter("helia_bitswap_sent_blocks_total"),dataSent:(s=t.metrics)==null?void 0:s.registerCounter("helia_bitswap_sent_data_bytes_total")},this.sendQueue=new Ac({concurrency:n.messageSendConcurrency??fse,metrics:t.metrics,metricName:"helia_bitswap_message_send_queue"}),this.sendQueue.addEventListener("error",o=>{this.log.error("error sending wantlist to peer",o.detail)})}async start(){if(this.running)return;this.running=!0,await this.libp2p.handle(this.protocols,this._onStream,{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:this.runOnLimitedConnections});const t={onConnect:n=>{this.safeDispatchEvent("peer:connected",{detail:n})},onDisconnect:n=>{this.safeDispatchEvent("peer:disconnected",{detail:n})}};this.registrarIds=[];for(const n of this.protocols)this.registrarIds.push(await this.libp2p.register(n,t));this.libp2p.getConnections().forEach(n=>{this.safeDispatchEvent("peer:connected",{detail:n.remotePeer})})}async stop(){if(this.running=!1,await this.libp2p.unhandle(this.protocols),this.registrarIds!=null){for(const t of this.registrarIds)this.libp2p.unregister(t);this.registrarIds=[]}}_onStream(t){if(!this.running)return;const{stream:n,connection:i}=t;Promise.resolve().then(async()=>{this.log("incoming new bitswap %s stream from %p",n.protocol,i.remotePeer);const s=()=>{n.status==="open"?n.abort(new Bp(`Incoming Bitswap stream timed out after ${this.messageReceiveTimeout}ms`)):this.log("stream aborted with status %s",n.status)};let o=AbortSignal.timeout(this.messageReceiveTimeout);o.addEventListener("abort",s),await n.closeWrite(),await hn(n,a=>Yd(a,{maxDataLength:this.maxIncomingMessageSize}),async a=>{for await(const c of a)try{const l=Y1.decode(c);this.log("incoming new bitswap %s message from %p on stream",n.protocol,i.remotePeer,n.id),this.safeDispatchEvent("bitswap:message",{detail:{peer:i.remotePeer,message:l}}),o.removeEventListener("abort",s),o=AbortSignal.timeout(this.messageReceiveTimeout),o.addEventListener("abort",s)}catch(l){this.log.error("error reading incoming bitswap message from %p on stream",i.remotePeer,n.id,l),n.abort(l);break}})}).catch(s=>{this.log.error("error handling incoming stream from %p",i.remotePeer,s),n.abort(s)})}async*findProviders(t,n){var i;(i=n==null?void 0:n.onProgress)==null||i.call(n,new _e("bitswap:network:find-providers",t));for await(const s of this.routing.findProviders(t,n))await this.libp2p.isDialable(s.multiaddrs,{runOnLimitedConnection:this.runOnLimitedConnections})&&(yield s)}async findAndConnect(t,n){await zo(Mh(py(this.findProviders(t,n),(n==null?void 0:n.maxProviders)??gse),async i=>this.connectTo(i.id,n))).catch(i=>{this.log.error(i)})}async sendMessage(t,n,i){if(!this.running)throw new Error("network isn't running");const s=this.sendQueue.queue.find(o=>t.equals(o.options.peerId)&&o.status==="queued");if(s!=null){s.options.message=mse(s.options.message,n),await s.join({signal:i==null?void 0:i.signal});return}await this.sendQueue.add(async o=>{var l,d;const a=o==null?void 0:o.message;if(a==null)throw new Z("No message to send");this.log("sendMessage to %p",t),(l=o==null?void 0:o.onProgress)==null||l.call(o,new _e("bitswap:network:send-wantlist",t));const c=await this.libp2p.dialProtocol(t,X0,o);await c.closeRead();try{await hn(vse(a,this.maxOutgoingMessageSize),h=>Qd(h),c),await c.close(o)}catch(h){(d=o==null?void 0:o.onProgress)==null||d.call(o,new _e("bitswap:network:send-wantlist:error",{peer:t,error:h})),this.log.error("error sending message to %p",t,h),c.abort(h)}this._updateSentStats(a.blocks)},{peerId:t,signal:i==null?void 0:i.signal,message:n})}async connectTo(t,n){var s;if(!this.running)throw new ql("Network isn't running");(s=n==null?void 0:n.onProgress)==null||s.call(n,new _e("bitswap:network:dial",t));const[i]=await Promise.all([this.libp2p.dial(t,n),Ci(this.libp2p,"peer:identify",n==null?void 0:n.signal,{filter:o=>{if(!o.detail.peerId.equals(t))return!1;if(o.detail.protocols.includes(X0))return!0;throw new Lp(`${t} did not support ${X0}`)}})]);return i}_updateSentStats(t){var i,s;let n=0;for(const o of t.values())n+=o.data.byteLength;(i=this.metrics.dataSent)==null||i.increment(n),(s=this.metrics.blocksSent)==null||s.increment(t.size)}};function Cse(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function pw(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function Ise(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var i=0;i<r.length;i++){var s=r.charAt(i),o=s.charCodeAt(0);if(t[o]!==255)throw new TypeError(s+" is ambiguous");t[o]=i}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),d=Math.log(256)/Math.log(a);function h(f){if(f instanceof Uint8Array||(ArrayBuffer.isView(f)?f=new Uint8Array(f.buffer,f.byteOffset,f.byteLength):Array.isArray(f)&&(f=Uint8Array.from(f))),!(f instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(f.length===0)return"";for(var g=0,v=0,y=0,w=f.length;y!==w&&f[y]===0;)y++,g++;for(var b=(w-y)*d+1>>>0,E=new Uint8Array(b);y!==w;){for(var A=f[y],k=0,x=b-1;(A!==0||k<v)&&x!==-1;x--,k++)A+=256*E[x]>>>0,E[x]=A%a>>>0,A=A/a>>>0;if(A!==0)throw new Error("Non-zero carry");v=k,y++}for(var I=b-v;I!==b&&E[I]===0;)I++;for(var T=c.repeat(g);I<b;++I)T+=r.charAt(E[I]);return T}function p(f){if(typeof f!="string")throw new TypeError("Expected String");if(f.length===0)return new Uint8Array;var g=0;if(f[g]!==" "){for(var v=0,y=0;f[g]===c;)v++,g++;for(var w=(f.length-g)*l+1>>>0,b=new Uint8Array(w);f[g];){var E=t[f.charCodeAt(g)];if(E===255)return;for(var A=0,k=w-1;(E!==0||A<y)&&k!==-1;k--,A++)E+=a*b[k]>>>0,b[k]=E%256>>>0,E=E/256>>>0;if(E!==0)throw new Error("Non-zero carry");y=A,g++}if(f[g]!==" "){for(var x=w-y;x!==w&&b[x]===0;)x++;for(var I=new Uint8Array(v+(w-x)),T=v;x!==w;)I[T++]=b[x++];return I}}}function m(f){var g=p(f);if(g)return g;throw new Error(`Non-${e} character`)}return{encode:h,decodeUnsafe:p,decode:m}}var kse=Ise,_se=kse;let Tse=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseEncode");this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},Pse=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseDecode");u(this,"prefixCodePoint");this.name=e,this.prefix=t;const i=t.codePointAt(0);if(i===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=i,this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return NU(this,e)}},Dse=class{constructor(e){u(this,"decoders");this.decoders=e}or(e){return NU(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};function NU(r,e){return new Dse({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}let $se=class{constructor(e,t,n,i){u(this,"name");u(this,"prefix");u(this,"baseEncode");u(this,"baseDecode");u(this,"encoder");u(this,"decoder");this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=i,this.encoder=new Tse(e,t,n),this.decoder=new Pse(e,t,i)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};function MU({name:r,prefix:e,encode:t,decode:n}){return new $se(r,e,t,n)}function gw({name:r,prefix:e,alphabet:t}){const{encode:n,decode:i}=_se(t,r);return MU({prefix:e,name:r,encode:n,decode:s=>pw(i(s))})}function Nse(r,e,t,n){const i={};for(let d=0;d<e.length;++d)i[e[d]]=d;let s=r.length;for(;r[s-1]==="=";)--s;const o=new Uint8Array(s*t/8|0);let a=0,c=0,l=0;for(let d=0;d<s;++d){const h=i[r[d]];if(h===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|h,a+=t,a>=8&&(a-=8,o[l++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o}function Mse(r,e,t){const n=e[e.length-1]==="=",i=(1<<t)-1;let s="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,s+=e[i&a>>o];if(o!==0&&(s+=e[i&a<<t-o]),n)for(;s.length*t&7;)s+="=";return s}function Xo({name:r,prefix:e,bitsPerChar:t,alphabet:n}){return MU({prefix:e,name:r,encode(i){return Mse(i,n,t)},decode(i){return Nse(i,n,t,r)}})}const Ms=gw({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});gw({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});const Qg=Xo({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});Xo({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});Xo({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});Xo({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});Xo({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});Xo({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});Xo({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});Xo({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});Xo({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const Z5=gw({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"});gw({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});var Ose=OU,wk=128,Rse=-128,Lse=Math.pow(2,31);function OU(r,e,t){e=e||[],t=t||0;for(var n=t;r>=Lse;)e[t++]=r&255|wk,r/=128;for(;r&Rse;)e[t++]=r&255|wk,r>>>=7;return e[t]=r|0,OU.bytes=t-n+1,e}var Bse=Db,Use=128,bk=127;function Db(r,n){var t=0,n=n||0,i=0,s=n,o,a=r.length;do{if(s>=a)throw Db.bytes=0,new RangeError("Could not decode varint");o=r[s++],t+=i<28?(o&bk)<<i:(o&bk)*Math.pow(2,i),i+=7}while(o>=Use);return Db.bytes=s-n,t}var Fse=Math.pow(2,7),zse=Math.pow(2,14),Vse=Math.pow(2,21),Kse=Math.pow(2,28),jse=Math.pow(2,35),Hse=Math.pow(2,42),qse=Math.pow(2,49),Wse=Math.pow(2,56),Gse=Math.pow(2,63),Qse=function(r){return r<Fse?1:r<zse?2:r<Vse?3:r<Kse?4:r<jse?5:r<Hse?6:r<qse?7:r<Wse?8:r<Gse?9:10},Yse={encode:Ose,decode:Bse,encodingLength:Qse},my=Yse;function $b(r,e=0){return[my.decode(r,e),my.decode.bytes]}function wy(r,e,t=0){return my.encode(r,e,t),e}function by(r){return my.encodingLength(r)}function vy(r,e){const t=e.byteLength,n=by(r),i=n+by(t),s=new Uint8Array(i+t);return wy(r,s,0),wy(t,s,n),s.set(e,i),new OS(r,t,e,s)}function RU(r){const e=pw(r),[t,n]=$b(e),[i,s]=$b(e.subarray(n)),o=e.subarray(n+s);if(o.byteLength!==i)throw new Error("Incorrect length");return new OS(t,i,o,e)}function Jse(r,e){if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&Cse(r.bytes,t.bytes)}}let OS=class{constructor(e,t,n,i){u(this,"code");u(this,"size");u(this,"digest");u(this,"bytes");this.code=e,this.size=t,this.digest=n,this.bytes=i}};function vk(r,e){const{bytes:t,version:n}=r;switch(n){case 0:return Zse(t,Nb(r),e??Ms.encoder);default:return eoe(t,Nb(r),e??Qg.encoder)}}const Ek=new WeakMap;function Nb(r){const e=Ek.get(r);if(e==null){const t=new Map;return Ek.set(r,t),t}return e}var sN;let RS=class Lr{constructor(e,t,n,i){u(this,"code");u(this,"version");u(this,"multihash");u(this,"bytes");u(this,"/");u(this,sN,"CID");this.code=t,this.version=e,this.multihash=n,this.bytes=i,this["/"]=i}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==Ef)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==toe)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return Lr.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=vy(e,t);return Lr.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return Lr.equals(this,e)}static equals(e,t){const n=t;return n!=null&&e.code===n.code&&e.version===n.version&&Jse(e.multihash,n.multihash)}toString(e){return vk(this,e)}toJSON(){return{"/":vk(this)}}link(){return this}[(sN=Symbol.toStringTag,Symbol.for("nodejs.util.inspect.custom"))](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof Lr)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:i,multihash:s,bytes:o}=t;return new Lr(n,i,s,o??Sk(n,i,s.bytes))}else if(t[roe]===!0){const{version:n,multihash:i,code:s}=t,o=RU(i);return Lr.create(n,s,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==Ef)throw new Error(`Version 0 CID must use dag-pb (code: ${Ef}) block encoding`);return new Lr(e,t,n,n.bytes)}case 1:{const i=Sk(e,t,n.bytes);return new Lr(e,t,n,i)}default:throw new Error("Invalid version")}}static createV0(e){return Lr.create(0,Ef,e)}static createV1(e,t){return Lr.create(1,e,t)}static decode(e){const[t,n]=Lr.decodeFirst(e);if(n.length!==0)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=Lr.inspectBytes(e),n=t.size-t.multihashSize,i=pw(e.subarray(n,n+t.multihashSize));if(i.byteLength!==t.multihashSize)throw new Error("Incorrect length");const s=i.subarray(t.multihashSize-t.digestSize),o=new OS(t.multihashCode,t.digestSize,s,i);return[t.version===0?Lr.createV0(o):Lr.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[h,p]=$b(e.subarray(t));return t+=p,h};let i=n(),s=Ef;if(i===18?(i=0,t=0):s=n(),i!==0&&i!==1)throw new RangeError(`Invalid CID version ${i}`);const o=t,a=n(),c=n(),l=t+c,d=l-o;return{version:i,codec:s,multihashCode:a,digestSize:c,multihashSize:d,size:l}}static parse(e,t){const[n,i]=Xse(e,t),s=Lr.decode(i);if(s.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return Nb(s).set(n,e),s}};function Xse(r,e){switch(r[0]){case"Q":{const t=e??Ms;return[Ms.prefix,t.decode(`${Ms.prefix}${r}`)]}case Ms.prefix:{const t=e??Ms;return[Ms.prefix,t.decode(r)]}case Qg.prefix:{const t=e??Qg;return[Qg.prefix,t.decode(r)]}case Z5.prefix:{const t=e??Z5;return[Z5.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}}function Zse(r,e,t){const{prefix:n}=t;if(n!==Ms.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const i=e.get(n);if(i==null){const s=t.encode(r).slice(1);return e.set(n,s),s}else return i}function eoe(r,e,t){const{prefix:n}=t,i=e.get(n);if(i==null){const s=t.encode(r);return e.set(n,s),s}else return i}const Ef=112,toe=18;function Sk(r,e,t){const n=by(r),i=n+by(e),s=new Uint8Array(i+t.byteLength);return wy(r,s,0),wy(e,s,n),s.set(t,i),s}const roe=Symbol.for("@ipld/js-cid/CID"),LU=0,noe="identity",BU=pw;function ioe(r){return vy(LU,BU(r))}const UU={code:LU,name:noe,encode:BU,digest:ioe};function soe({name:r,code:e,encode:t}){return new ooe(r,e,t)}let ooe=class{constructor(e,t,n){u(this,"name");u(this,"code");u(this,"encode");this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?vy(this.code,t):t.then(n=>vy(this.code,n))}else throw Error("Unknown type, must be binary type")}};function aoe(r){return async e=>new Uint8Array(await crypto.subtle.digest(r,e))}const coe=soe({name:"sha2-256",code:18,encode:aoe("SHA-256")}),FU=Symbol.for("nodejs.util.inspect.custom"),loe=114;var oN;class LS{constructor(e){u(this,"type");u(this,"multihash");u(this,"publicKey");u(this,"string");u(this,oN,!0);this.type=e.type,this.multihash=e.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}toString(){return this.string==null&&(this.string=Ms.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return RS.createV1(loe,this.multihash)}toJSON(){return this.toString()}equals(e){var t;if(e==null)return!1;if(e instanceof Uint8Array)return He(this.multihash.bytes,e);if(typeof e=="string")return this.toString()===e;if(((t=e==null?void 0:e.toMultihash())==null?void 0:t.bytes)!=null)return He(this.multihash.bytes,e.toMultihash().bytes);throw new Error("not valid Id")}[(oN=ZE,FU)](){return`PeerId(${this.toString()})`}}class zU extends LS{constructor(t){super({...t,type:"RSA"});u(this,"type","RSA");u(this,"publicKey");this.publicKey=t.publicKey}}class VU extends LS{constructor(t){super({...t,type:"Ed25519"});u(this,"type","Ed25519");u(this,"publicKey");this.publicKey=t.publicKey}}class KU extends LS{constructor(t){super({...t,type:"secp256k1"});u(this,"type","secp256k1");u(this,"publicKey");this.publicKey=t.publicKey}}const uoe=2336;var aN,cN;class jU{constructor(e){u(this,"type","url");u(this,"multihash");u(this,"publicKey");u(this,"url");u(this,aN,!0);this.url=e.toString(),this.multihash=UU.digest(oe(this.url))}[(cN=FU,aN=ZE,cN)](){return`PeerId(${this.url})`}toString(){return this.toCID().toString()}toMultihash(){return this.multihash}toCID(){return RS.createV1(uoe,this.toMultihash())}toJSON(){return this.toString()}equals(e){return e==null?!1:(e instanceof Uint8Array&&(e=re(e)),e.toString()===this.toString())}}const doe=114,xk=2336;function Jt(r,e){let t;if(r.charAt(0)==="1"||r.charAt(0)==="Q")t=RU(Ms.decode(`z${r}`));else{if(r.startsWith("k51qzi5uqu5")||r.startsWith("kzwfwjn5ji4")||r.startsWith("k2k4r8")||r.startsWith("bafz"))return Oh(RS.parse(r));throw new Z('Please pass a multibase decoder for strings that do not start with "1" or "Q"')}return si(t)}function Jd(r){if(r.type==="Ed25519")return new VU({multihash:r.toCID().multihash,publicKey:r});if(r.type==="secp256k1")return new KU({multihash:r.toCID().multihash,publicKey:r});if(r.type==="RSA")return new zU({multihash:r.toCID().multihash,publicKey:r});throw new Eu}function hoe(r){return Jd(r.publicKey)}function si(r){if(poe(r))return new zU({multihash:r});if(foe(r))try{const e=hU(r);if(e.type==="Ed25519")return new VU({multihash:r,publicKey:e});if(e.type==="secp256k1")return new KU({multihash:r,publicKey:e})}catch{const t=re(r.digest);return new jU(new URL(t))}throw new ew("Supplied PeerID Multihash is invalid")}function Oh(r){if((r==null?void 0:r.multihash)==null||r.version==null||r.version===1&&r.code!==doe&&r.code!==xk)throw new iB("Supplied PeerID CID is invalid");if(r.code===xk){const e=re(r.multihash.digest);return new jU(new URL(e))}return si(r.multihash)}function foe(r){return r.code===UU.code}function poe(r){return r.code===coe.code}function HU(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function goe(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var i=0;i<r.length;i++){var s=r.charAt(i),o=s.charCodeAt(0);if(t[o]!==255)throw new TypeError(s+" is ambiguous");t[o]=i}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),d=Math.log(256)/Math.log(a);function h(f){if(f instanceof Uint8Array||(ArrayBuffer.isView(f)?f=new Uint8Array(f.buffer,f.byteOffset,f.byteLength):Array.isArray(f)&&(f=Uint8Array.from(f))),!(f instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(f.length===0)return"";for(var g=0,v=0,y=0,w=f.length;y!==w&&f[y]===0;)y++,g++;for(var b=(w-y)*d+1>>>0,E=new Uint8Array(b);y!==w;){for(var A=f[y],k=0,x=b-1;(A!==0||k<v)&&x!==-1;x--,k++)A+=256*E[x]>>>0,E[x]=A%a>>>0,A=A/a>>>0;if(A!==0)throw new Error("Non-zero carry");v=k,y++}for(var I=b-v;I!==b&&E[I]===0;)I++;for(var T=c.repeat(g);I<b;++I)T+=r.charAt(E[I]);return T}function p(f){if(typeof f!="string")throw new TypeError("Expected String");if(f.length===0)return new Uint8Array;var g=0;if(f[g]!==" "){for(var v=0,y=0;f[g]===c;)v++,g++;for(var w=(f.length-g)*l+1>>>0,b=new Uint8Array(w);f[g];){var E=t[f.charCodeAt(g)];if(E===255)return;for(var A=0,k=w-1;(E!==0||A<y)&&k!==-1;k--,A++)E+=a*b[k]>>>0,b[k]=E%256>>>0,E=E/256>>>0;if(E!==0)throw new Error("Non-zero carry");y=A,g++}if(f[g]!==" "){for(var x=w-y;x!==w&&b[x]===0;)x++;for(var I=new Uint8Array(v+(w-x)),T=v;x!==w;)I[T++]=b[x++];return I}}}function m(f){var g=p(f);if(g)return g;throw new Error(`Non-${e} character`)}return{encode:h,decodeUnsafe:p,decode:m}}var yoe=goe,moe=yoe;let woe=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseEncode");this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},boe=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseDecode");u(this,"prefixCodePoint");this.name=e,this.prefix=t;const i=t.codePointAt(0);if(i===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=i,this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return qU(this,e)}},voe=class{constructor(e){u(this,"decoders");this.decoders=e}or(e){return qU(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};function qU(r,e){return new voe({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}let Eoe=class{constructor(e,t,n,i){u(this,"name");u(this,"prefix");u(this,"baseEncode");u(this,"baseDecode");u(this,"encoder");u(this,"decoder");this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=i,this.encoder=new woe(e,t,n),this.decoder=new boe(e,t,i)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};function Soe({name:r,prefix:e,encode:t,decode:n}){return new Eoe(r,e,t,n)}function WU({name:r,prefix:e,alphabet:t}){const{encode:n,decode:i}=moe(t,r);return Soe({prefix:e,name:r,encode:n,decode:s=>HU(i(s))})}const xoe=WU({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});WU({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var Aoe=GU,Ak=128,Coe=-128,Ioe=Math.pow(2,31);function GU(r,e,t){e=e||[],t=t||0;for(var n=t;r>=Ioe;)e[t++]=r&255|Ak,r/=128;for(;r&Coe;)e[t++]=r&255|Ak,r>>>=7;return e[t]=r|0,GU.bytes=t-n+1,e}var koe=Mb,_oe=128,Ck=127;function Mb(r,n){var t=0,n=n||0,i=0,s=n,o,a=r.length;do{if(s>=a)throw Mb.bytes=0,new RangeError("Could not decode varint");o=r[s++],t+=i<28?(o&Ck)<<i:(o&Ck)*Math.pow(2,i),i+=7}while(o>=_oe);return Mb.bytes=s-n,t}var Toe=Math.pow(2,7),Poe=Math.pow(2,14),Doe=Math.pow(2,21),$oe=Math.pow(2,28),Noe=Math.pow(2,35),Moe=Math.pow(2,42),Ooe=Math.pow(2,49),Roe=Math.pow(2,56),Loe=Math.pow(2,63),Boe=function(r){return r<Toe?1:r<Poe?2:r<Doe?3:r<$oe?4:r<Noe?5:r<Moe?6:r<Ooe?7:r<Roe?8:r<Loe?9:10},Uoe={encode:Aoe,decode:koe,encodingLength:Boe},Ik=Uoe;function kk(r,e=0){return[Ik.decode(r,e),Ik.decode.bytes]}function Foe(r){const e=HU(r),[t,n]=kk(e),[i,s]=kk(e.subarray(n)),o=e.subarray(n+s);if(o.byteLength!==i)throw new Error("Incorrect length");return new zoe(t,i,o,e)}let zoe=class{constructor(e,t,n,i){u(this,"code");u(this,"size");u(this,"digest");u(this,"bytes");this.code=e,this.size=t,this.digest=n,this.bytes=i}};function o1(r,e){const t={[Symbol.iterator]:()=>t,next:()=>{const n=r.next(),i=n.value;return n.done===!0||i==null?{done:!0,value:void 0}:{done:!1,value:e(i)}}};return t}function e8(r){const e=Foe(xoe.decode(`z${r}`));return si(e)}class Fc{constructor(e){u(this,"map");if(this.map=new Map,e!=null)for(const[t,n]of e.entries())this.map.set(t.toString(),{key:t,value:n})}[Symbol.iterator](){return this.entries()}clear(){this.map.clear()}delete(e){return this.map.delete(e.toString())}entries(){return o1(this.map.entries(),e=>[e[1].key,e[1].value])}forEach(e){this.map.forEach((t,n)=>{e(t.value,t.key,this)})}get(e){var t;return(t=this.map.get(e.toString()))==null?void 0:t.value}has(e){return this.map.has(e.toString())}set(e,t){this.map.set(e.toString(),{key:e,value:t})}keys(){return o1(this.map.values(),e=>e.key)}values(){return o1(this.map.values(),e=>e.value)}get size(){return this.map.size}}class cs{constructor(e){u(this,"set");if(this.set=new Set,e!=null)for(const t of e)this.set.add(t.toString())}get size(){return this.set.size}[Symbol.iterator](){return this.values()}add(e){this.set.add(e.toString())}clear(){this.set.clear()}delete(e){this.set.delete(e.toString())}entries(){return o1(this.set.entries(),e=>{const t=e8(e[0]);return[t,t]})}forEach(e){this.set.forEach(t=>{const n=e8(t);e(n,n,this)})}has(e){return this.set.has(e.toString())}values(){return o1(this.set.values(),e=>e8(e))}intersection(e){const t=new cs;for(const n of e)this.has(n)&&t.add(n);return t}difference(e){const t=new cs;for(const n of this)e.has(n)||t.add(n);return t}union(e){const t=new cs;for(const n of e)t.add(n);for(const n of this)t.add(n);return t}}function Voe(){return new cs}class QU extends YB{constructor(e,t){super(),this.finished=!1,this.destroyed=!1,uw(e);const n=q1(t);if(this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const i=this.blockLen,s=new Uint8Array(i);s.set(n.length>i?e.create().update(n).digest():n);for(let o=0;o<s.length;o++)s[o]^=54;this.iHash.update(s),this.oHash=e.create();for(let o=0;o<s.length;o++)s[o]^=106;this.oHash.update(s),Hs(s)}update(e){return fy(this),this.iHash.update(e),this}digestInto(e){fy(this),zp(e,this.outputLen),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){const e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||(e=Object.create(Object.getPrototypeOf(this),{}));const{oHash:t,iHash:n,finished:i,destroyed:s,blockLen:o,outputLen:a}=this;return e=e,e.finished=i,e.destroyed=s,e.blockLen=o,e.outputLen=a,e.oHash=t._cloneInto(e.oHash),e.iHash=n._cloneInto(e.iHash),e}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}}const yw=(r,e,t)=>new QU(r,e).update(t).digest();yw.create=(r,e)=>new QU(r,e);function YU(r,e,t,n){uw(r);const i=xne({dkLen:32,asyncTick:10},n),{c:s,dkLen:o,asyncTick:a}=i;if(bd(s),bd(o),bd(a),s<1)throw new Error("iterations (c) should be >= 1");const c=ik(e),l=ik(t),d=new Uint8Array(o),h=yw.create(r,c),p=h._cloneInto().update(l);return{c:s,dkLen:o,asyncTick:a,DK:d,PRF:h,PRFSalt:p}}function JU(r,e,t,n,i){return r.destroy(),e.destroy(),n&&n.destroy(),Hs(i),t}function Koe(r,e,t,n){const{c:i,dkLen:s,DK:o,PRF:a,PRFSalt:c}=YU(r,e,t,n);let l;const d=new Uint8Array(4),h=s1(d),p=new Uint8Array(a.outputLen);for(let m=1,f=0;f<s;m++,f+=a.outputLen){const g=o.subarray(f,f+a.outputLen);h.setInt32(0,m,!1),(l=c._cloneInto(l)).update(d).digestInto(p),g.set(p.subarray(0,g.length));for(let v=1;v<i;v++){a._cloneInto(l).update(p).digestInto(p);for(let y=0;y<g.length;y++)g[y]^=p[y]}}return JU(a,c,o,l,p)}async function XU(r,e,t,n){const{c:i,dkLen:s,asyncTick:o,DK:a,PRF:c,PRFSalt:l}=YU(r,e,t,n);let d;const h=new Uint8Array(4),p=s1(h),m=new Uint8Array(c.outputLen);for(let f=1,g=0;g<s;f++,g+=c.outputLen){const v=a.subarray(g,g+c.outputLen);p.setInt32(0,f,!1),(d=l._cloneInto(d)).update(h).digestInto(m),v.set(m.subarray(0,v.length)),await Sne(i-1,o,()=>{c._cloneInto(d).update(m).digestInto(m);for(let y=0;y<v.length;y++)v[y]^=m[y]})}return JU(c,l,a,d,m)}const Sf=Uint32Array.from([1732584193,4023233417,2562383102,271733878,3285377520]),Ca=new Uint32Array(80);class joe extends AS{constructor(){super(64,20,8,!1),this.A=Sf[0]|0,this.B=Sf[1]|0,this.C=Sf[2]|0,this.D=Sf[3]|0,this.E=Sf[4]|0}get(){const{A:e,B:t,C:n,D:i,E:s}=this;return[e,t,n,i,s]}set(e,t,n,i,s){this.A=e|0,this.B=t|0,this.C=n|0,this.D=i|0,this.E=s|0}process(e,t){for(let c=0;c<16;c++,t+=4)Ca[c]=e.getUint32(t,!1);for(let c=16;c<80;c++)Ca[c]=Y5(Ca[c-3]^Ca[c-8]^Ca[c-14]^Ca[c-16],1);let{A:n,B:i,C:s,D:o,E:a}=this;for(let c=0;c<80;c++){let l,d;c<20?(l=JB(i,s,o),d=1518500249):c<40?(l=i^s^o,d=1859775393):c<60?(l=XB(i,s,o),d=2400959708):(l=i^s^o,d=3395469782);const h=Y5(n,5)+l+a+d+Ca[c]|0;a=o,o=s,s=Y5(i,30),i=n,n=h}n=n+this.A|0,i=i+this.B|0,s=s+this.C|0,o=o+this.D|0,a=a+this.E|0,this.set(n,i,s,o,a)}roundClean(){Hs(Ca)}destroy(){this.set(0,0,0,0,0),Hs(this.buffer)}}const Hoe=xS(()=>new joe),qoe=Hoe,BS=zne,Woe=ii({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6});ii({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6});ii({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6});ii({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});const _k={sha1:qoe,"sha2-256":Nl,"sha2-512":BS};function Tk(r,e,t,n,i){if(i!=="sha1"&&i!=="sha2-256"&&i!=="sha2-512"){const a=Object.keys(_k).join(" / ");throw new Z(`Hash '${i}' is unknown or not supported. Must be ${a}`)}const s=_k[i],o=Koe(s,r,e,{c:t,dkLen:n});return Woe.encode(o).substring(1)}const US={32:16777619n,64:1099511628211n,128:309485009821345068724781371n,256:374144419156711147060143317175368453031918731002211n,512:35835915874844867368919076489095108449946327955754392558399825615420669938882575126094039892345713852759n,1024:5016456510113118655434598811035278955030765345404790744303017523831112055108147451509157692220295382716162651878526895249385292291816524375083746691371804094271873160484737966720260389217684476157468082573n},ZU={32:2166136261n,64:14695981039346656037n,128:144066263297769815596495629667062367629n,256:100029257958052580907070968620625704837092796014241193945225284501741471925557n,512:9659303129496669498009435400716310466090418745672637896108374329434462657994582932197716438449813051892206539805784495328239340083876191928701583869517785n,1024:14197795064947621068722070641403218320880622795441933960878474914617582723252296732303717722150864096521202355549365628174669108571814760471015076148029755969804077320157692458563003215304957150157403644460363550505412711285966361610267868082893823963790439336411086884584107735010676915n},eF=new globalThis.TextEncoder;function Goe(r,e){const t=US[e];let n=ZU[e];for(let i=0;i<r.length;i++)n^=BigInt(r[i]),n=BigInt.asUintN(e,n*t);return n}function Qoe(r,e,t){if(t.length===0)throw new Error("The `utf8Buffer` option must have a length greater than zero");const n=US[e];let i=ZU[e],s=r;for(;s.length>0;){const o=eF.encodeInto(s,t);s=s.slice(o.read);for(let a=0;a<o.written;a++)i^=BigInt(t[a]),i=BigInt.asUintN(e,i*n)}return i}function Yoe(r,{size:e=32,utf8Buffer:t}={}){if(!US[e])throw new Error("The `size` option must be one of 32, 64, 128, 256, 512, or 1024");if(typeof r=="string"){if(t)return Qoe(r,e,t);r=eF.encode(r)}return Goe(r,e)}const FS={hash:r=>Number(Yoe(r,{size:32})),hashV:(r,e)=>Joe(FS.hash(r,e))};function Joe(r){let e=r.toString(16);return e.length%2===1&&(e=`0${e}`),oe(e,"base16")}const tF=64;class ml{constructor(e,t,n,i=2){u(this,"fp");u(this,"h");u(this,"seed");if(i>tF)throw new TypeError("Invalid Fingerprint Size");const s=t.hashV(e,n),o=Ye(i);for(let a=0;a<o.length;a++)o[a]=s[a];o.length===0&&(o[0]=7),this.fp=o,this.h=t,this.seed=n}hash(){return this.h.hash(this.fp,this.seed)}equals(e){return(e==null?void 0:e.fp)instanceof Uint8Array?He(this.fp,e.fp):!1}}function Ey(r,e){return Math.floor(Math.random()*(e-r))+r}class Z0{constructor(e){u(this,"contents");this.contents=new Array(e).fill(null)}has(e){if(!(e instanceof ml))throw new TypeError("Invalid Fingerprint");return this.contents.some(t=>e.equals(t))}add(e){if(!(e instanceof ml))throw new TypeError("Invalid Fingerprint");for(let t=0;t<this.contents.length;t++)if(this.contents[t]==null)return this.contents[t]=e,!0;return!0}swap(e){if(!(e instanceof ml))throw new TypeError("Invalid Fingerprint");const t=Ey(0,this.contents.length-1),n=this.contents[t];return this.contents[t]=e,n}remove(e){if(!(e instanceof ml))throw new TypeError("Invalid Fingerprint");const t=this.contents.findIndex(n=>e.equals(n));return t>-1?(this.contents[t]=null,!0):!1}}const Xoe=500;class Pk{constructor(e){u(this,"bucketSize");u(this,"filterSize");u(this,"fingerprintSize");u(this,"buckets");u(this,"count");u(this,"hash");u(this,"seed");this.filterSize=e.filterSize,this.bucketSize=e.bucketSize??4,this.fingerprintSize=e.fingerprintSize??2,this.count=0,this.buckets=[],this.hash=e.hash??FS,this.seed=e.seed??Ey(0,Math.pow(2,10))}add(e){typeof e=="string"&&(e=oe(e));const t=new ml(e,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(e,this.seed)%this.filterSize,i=(n^t.hash())%this.filterSize;if(this.buckets[n]==null&&(this.buckets[n]=new Z0(this.bucketSize)),this.buckets[i]==null&&(this.buckets[i]=new Z0(this.bucketSize)),this.buckets[n].add(t)||this.buckets[i].add(t))return this.count++,!0;const s=[n,i];let o=s[Ey(0,s.length-1)];this.buckets[o]==null&&(this.buckets[o]=new Z0(this.bucketSize));for(let a=0;a<Xoe;a++){const c=this.buckets[o].swap(t);if(c!=null&&(o=(o^c.hash())%this.filterSize,this.buckets[o]==null&&(this.buckets[o]=new Z0(this.bucketSize)),this.buckets[o].add(c)))return this.count++,!0}return!1}has(e){var o,a;typeof e=="string"&&(e=oe(e));const t=new ml(e,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(e,this.seed)%this.filterSize,i=((o=this.buckets[n])==null?void 0:o.has(t))??!1;if(i)return i;const s=(n^t.hash())%this.filterSize;return((a=this.buckets[s])==null?void 0:a.has(t))??!1}remove(e){var a,c;typeof e=="string"&&(e=oe(e));const t=new ml(e,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(e,this.seed)%this.filterSize,i=((a=this.buckets[n])==null?void 0:a.remove(t))??!1;if(i)return this.count--,i;const s=(n^t.hash())%this.filterSize,o=((c=this.buckets[s])==null?void 0:c.remove(t))??!1;return o&&this.count--,o}get reliable(){return Math.floor(100*(this.count/this.filterSize))<=90}}const Zoe={1:.5,2:.84,4:.95,8:.98};function eae(r=.001){return r>.002?2:r>1e-5?4:8}function tae(r,e=.001){const t=eae(e),n=Zoe[t],i=Math.round(r/n),s=Math.min(Math.ceil(Math.log2(1/e)+Math.log2(2*t)),tF);return{filterSize:i,bucketSize:t,fingerprintSize:s}}class rae{constructor(e){u(this,"filterSize");u(this,"bucketSize");u(this,"fingerprintSize");u(this,"scale");u(this,"filterSeries");u(this,"hash");u(this,"seed");this.bucketSize=e.bucketSize??4,this.filterSize=e.filterSize??(1<<18)/this.bucketSize,this.fingerprintSize=e.fingerprintSize??2,this.scale=e.scale??2,this.hash=e.hash??FS,this.seed=e.seed??Ey(0,Math.pow(2,10)),this.filterSeries=[new Pk({filterSize:this.filterSize,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed})]}add(e){if(typeof e=="string"&&(e=oe(e)),this.has(e))return!0;let t=this.filterSeries.find(n=>n.reliable);if(t==null){const n=this.filterSize*Math.pow(this.scale,this.filterSeries.length);t=new Pk({filterSize:n,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed}),this.filterSeries.push(t)}return t.add(e)}has(e){typeof e=="string"&&(e=oe(e));for(let t=0;t<this.filterSeries.length;t++)if(this.filterSeries[t].has(e))return!0;return!1}remove(e){typeof e=="string"&&(e=oe(e));for(let t=0;t<this.filterSeries.length;t++)if(this.filterSeries[t].remove(e))return!0;return!1}get count(){return this.filterSeries.reduce((e,t)=>e+t.count,0)}}function Ql(r,e=.001,t){return new rae({...tae(r,e)})}class nae{constructor(e,t){u(this,"filter");this.filter=Ql(e,t)}has(e){return this.filter.has(e.toMultihash().bytes)}add(e){this.filter.add(e.toMultihash().bytes)}remove(e){var t,n;(n=(t=this.filter).remove)==null||n.call(t,e.toMultihash().bytes)}}function iae(r,e=.001){return new nae(r,e)}class sae extends Fc{constructor(t){super();u(this,"metric");const{name:n,metrics:i}=t;this.metric=i.registerMetric(n),this.updateComponentMetric()}set(t,n){return super.set(t,n),this.updateComponentMetric(),this}delete(t){const n=super.delete(t);return this.updateComponentMetric(),n}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}}function rF(r){const{name:e,metrics:t}=r;let n;return t!=null?n=new sae({name:e,metrics:t}):n=new Fc,n}function oae(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function zS(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function aae(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var i=0;i<r.length;i++){var s=r.charAt(i),o=s.charCodeAt(0);if(t[o]!==255)throw new TypeError(s+" is ambiguous");t[o]=i}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),d=Math.log(256)/Math.log(a);function h(f){if(f instanceof Uint8Array||(ArrayBuffer.isView(f)?f=new Uint8Array(f.buffer,f.byteOffset,f.byteLength):Array.isArray(f)&&(f=Uint8Array.from(f))),!(f instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(f.length===0)return"";for(var g=0,v=0,y=0,w=f.length;y!==w&&f[y]===0;)y++,g++;for(var b=(w-y)*d+1>>>0,E=new Uint8Array(b);y!==w;){for(var A=f[y],k=0,x=b-1;(A!==0||k<v)&&x!==-1;x--,k++)A+=256*E[x]>>>0,E[x]=A%a>>>0,A=A/a>>>0;if(A!==0)throw new Error("Non-zero carry");v=k,y++}for(var I=b-v;I!==b&&E[I]===0;)I++;for(var T=c.repeat(g);I<b;++I)T+=r.charAt(E[I]);return T}function p(f){if(typeof f!="string")throw new TypeError("Expected String");if(f.length===0)return new Uint8Array;var g=0;if(f[g]!==" "){for(var v=0,y=0;f[g]===c;)v++,g++;for(var w=(f.length-g)*l+1>>>0,b=new Uint8Array(w);f[g];){var E=t[f.charCodeAt(g)];if(E===255)return;for(var A=0,k=w-1;(E!==0||A<y)&&k!==-1;k--,A++)E+=a*b[k]>>>0,b[k]=E%256>>>0,E=E/256>>>0;if(E!==0)throw new Error("Non-zero carry");y=A,g++}if(f[g]!==" "){for(var x=w-y;x!==w&&b[x]===0;)x++;for(var I=new Uint8Array(v+(w-x)),T=v;x!==w;)I[T++]=b[x++];return I}}}function m(f){var g=p(f);if(g)return g;throw new Error(`Non-${e} character`)}return{encode:h,decodeUnsafe:p,decode:m}}var cae=aae,lae=cae;let uae=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseEncode");this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},dae=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseDecode");u(this,"prefixCodePoint");this.name=e,this.prefix=t;const i=t.codePointAt(0);if(i===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=i,this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return nF(this,e)}},hae=class{constructor(e){u(this,"decoders");this.decoders=e}or(e){return nF(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};function nF(r,e){return new hae({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}let fae=class{constructor(e,t,n,i){u(this,"name");u(this,"prefix");u(this,"baseEncode");u(this,"baseDecode");u(this,"encoder");u(this,"decoder");this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=i,this.encoder=new uae(e,t,n),this.decoder=new dae(e,t,i)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};function iF({name:r,prefix:e,encode:t,decode:n}){return new fae(r,e,t,n)}function mw({name:r,prefix:e,alphabet:t}){const{encode:n,decode:i}=lae(t,r);return iF({prefix:e,name:r,encode:n,decode:s=>zS(i(s))})}function pae(r,e,t,n){const i={};for(let d=0;d<e.length;++d)i[e[d]]=d;let s=r.length;for(;r[s-1]==="=";)--s;const o=new Uint8Array(s*t/8|0);let a=0,c=0,l=0;for(let d=0;d<s;++d){const h=i[r[d]];if(h===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|h,a+=t,a>=8&&(a-=8,o[l++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o}function gae(r,e,t){const n=e[e.length-1]==="=",i=(1<<t)-1;let s="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,s+=e[i&a>>o];if(o!==0&&(s+=e[i&a<<t-o]),n)for(;s.length*t&7;)s+="=";return s}function oi({name:r,prefix:e,bitsPerChar:t,alphabet:n}){return iF({prefix:e,name:r,encode(i){return gae(i,n,t)},decode(i){return pae(i,n,t,r)}})}const Yg=oi({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});oi({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});oi({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});oi({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});oi({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});oi({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});oi({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});oi({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});oi({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const t8=mw({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"});mw({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});const Ta=mw({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});mw({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var yae=sF,Dk=128,mae=-128,wae=Math.pow(2,31);function sF(r,e,t){e=e||[],t=t||0;for(var n=t;r>=wae;)e[t++]=r&255|Dk,r/=128;for(;r&mae;)e[t++]=r&255|Dk,r>>>=7;return e[t]=r|0,sF.bytes=t-n+1,e}var bae=Ob,vae=128,$k=127;function Ob(r,n){var t=0,n=n||0,i=0,s=n,o,a=r.length;do{if(s>=a)throw Ob.bytes=0,new RangeError("Could not decode varint");o=r[s++],t+=i<28?(o&$k)<<i:(o&$k)*Math.pow(2,i),i+=7}while(o>=vae);return Ob.bytes=s-n,t}var Eae=Math.pow(2,7),Sae=Math.pow(2,14),xae=Math.pow(2,21),Aae=Math.pow(2,28),Cae=Math.pow(2,35),Iae=Math.pow(2,42),kae=Math.pow(2,49),_ae=Math.pow(2,56),Tae=Math.pow(2,63),Pae=function(r){return r<Eae?1:r<Sae?2:r<xae?3:r<Aae?4:r<Cae?5:r<Iae?6:r<kae?7:r<_ae?8:r<Tae?9:10},Dae={encode:yae,decode:bae,encodingLength:Pae},Sy=Dae;function Rb(r,e=0){return[Sy.decode(r,e),Sy.decode.bytes]}function xy(r,e,t=0){return Sy.encode(r,e,t),e}function Ay(r){return Sy.encodingLength(r)}function Lb(r,e){const t=e.byteLength,n=Ay(r),i=n+Ay(t),s=new Uint8Array(i+t);return xy(r,s,0),xy(t,s,n),s.set(e,i),new VS(r,t,e,s)}function $ae(r){const e=zS(r),[t,n]=Rb(e),[i,s]=Rb(e.subarray(n)),o=e.subarray(n+s);if(o.byteLength!==i)throw new Error("Incorrect length");return new VS(t,i,o,e)}function Nae(r,e){if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&oae(r.bytes,t.bytes)}}let VS=class{constructor(e,t,n,i){u(this,"code");u(this,"size");u(this,"digest");u(this,"bytes");this.code=e,this.size=t,this.digest=n,this.bytes=i}};function Nk(r,e){const{bytes:t,version:n}=r;switch(n){case 0:return Oae(t,Bb(r),e??Ta.encoder);default:return Rae(t,Bb(r),e??Yg.encoder)}}const Mk=new WeakMap;function Bb(r){const e=Mk.get(r);if(e==null){const t=new Map;return Mk.set(r,t),t}return e}var lN;let Ub=class Br{constructor(e,t,n,i){u(this,"code");u(this,"version");u(this,"multihash");u(this,"bytes");u(this,"/");u(this,lN,"CID");this.code=t,this.version=e,this.multihash=n,this.bytes=i,this["/"]=i}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==xf)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==Lae)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return Br.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=Lb(e,t);return Br.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return Br.equals(this,e)}static equals(e,t){const n=t;return n!=null&&e.code===n.code&&e.version===n.version&&Nae(e.multihash,n.multihash)}toString(e){return Nk(this,e)}toJSON(){return{"/":Nk(this)}}link(){return this}[(lN=Symbol.toStringTag,Symbol.for("nodejs.util.inspect.custom"))](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof Br)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:i,multihash:s,bytes:o}=t;return new Br(n,i,s,o??Ok(n,i,s.bytes))}else if(t[Bae]===!0){const{version:n,multihash:i,code:s}=t,o=$ae(i);return Br.create(n,s,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==xf)throw new Error(`Version 0 CID must use dag-pb (code: ${xf}) block encoding`);return new Br(e,t,n,n.bytes)}case 1:{const i=Ok(e,t,n.bytes);return new Br(e,t,n,i)}default:throw new Error("Invalid version")}}static createV0(e){return Br.create(0,xf,e)}static createV1(e,t){return Br.create(1,e,t)}static decode(e){const[t,n]=Br.decodeFirst(e);if(n.length!==0)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=Br.inspectBytes(e),n=t.size-t.multihashSize,i=zS(e.subarray(n,n+t.multihashSize));if(i.byteLength!==t.multihashSize)throw new Error("Incorrect length");const s=i.subarray(t.multihashSize-t.digestSize),o=new VS(t.multihashCode,t.digestSize,s,i);return[t.version===0?Br.createV0(o):Br.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[h,p]=Rb(e.subarray(t));return t+=p,h};let i=n(),s=xf;if(i===18?(i=0,t=0):s=n(),i!==0&&i!==1)throw new RangeError(`Invalid CID version ${i}`);const o=t,a=n(),c=n(),l=t+c,d=l-o;return{version:i,codec:s,multihashCode:a,digestSize:c,multihashSize:d,size:l}}static parse(e,t){const[n,i]=Mae(e,t),s=Br.decode(i);if(s.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return Bb(s).set(n,e),s}};function Mae(r,e){switch(r[0]){case"Q":{const t=e??Ta;return[Ta.prefix,t.decode(`${Ta.prefix}${r}`)]}case Ta.prefix:{const t=e??Ta;return[Ta.prefix,t.decode(r)]}case Yg.prefix:{const t=e??Yg;return[Yg.prefix,t.decode(r)]}case t8.prefix:{const t=e??t8;return[t8.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}}function Oae(r,e,t){const{prefix:n}=t;if(n!==Ta.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const i=e.get(n);if(i==null){const s=t.encode(r).slice(1);return e.set(n,s),s}else return i}function Rae(r,e,t){const{prefix:n}=t,i=e.get(n);if(i==null){const s=t.encode(r);return e.set(n,s),s}else return i}const xf=112,Lae=18;function Ok(r,e,t){const n=Ay(r),i=n+Ay(e),s=new Uint8Array(i+t.byteLength);return xy(r,s,0),xy(e,s,n),s.set(t,i),s}const Bae=Symbol.for("@ipld/js-cid/CID"),r8=oi({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6});oi({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6});oi({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6});oi({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});class Vf{constructor(e=!1,t=0){u(this,"full");u(this,"pendingBytes");u(this,"wantlist");u(this,"blocks");u(this,"blockPresences");this.full=e,this.wantlist=new Map,this.blocks=new Map,this.blockPresences=new Map,this.pendingBytes=0}addWantlistEntry(e,t){const n=r8.encode(e.multihash.bytes);this.wantlist.set(n,t)}addBlockPresence(e,t){const n=r8.encode(e.multihash.bytes);this.blockPresences.set(n,t)}addBlock(e,t){const n=r8.encode(e.multihash.bytes);this.blocks.set(n,t)}}function Uae(r){let e=new Uint8Array(r.reduce((n,i)=>n+gt(i),0)),t=0;for(const n of r)e=xr(n,e,t),t+=gt(n);return e}function Rk(r){return Uae([r.version,r.code,r.multihash.code,r.multihash.digest.byteLength])}class Fae{constructor(e,t){u(this,"peerId");u(this,"blockstore");u(this,"network");u(this,"wants");u(this,"exchangeCount");u(this,"bytesSent");u(this,"bytesReceived");u(this,"lastExchange");u(this,"maxSizeReplaceHasWithBlock");u(this,"log");this.peerId=e.peerId,this.blockstore=e.blockstore,this.network=e.network,this.wants=new Map,this.log=e.logger.forComponent(`helia:bitswap:ledger:${e.peerId}`),this.exchangeCount=0,this.bytesSent=0,this.bytesReceived=0,this.maxSizeReplaceHasWithBlock=t.maxSizeReplaceHasWithBlock??cse}sentBytes(e){this.exchangeCount++,this.lastExchange=new Date().getTime(),this.bytesSent+=e}receivedBytes(e){this.exchangeCount++,this.lastExchange=new Date().getTime(),this.bytesReceived+=e}debtRatio(){return this.bytesSent/(this.bytesReceived+1)}async sendBlocksToPeer(e){const t=new Vf,n=new Set;for(const[i,s]of this.wants.entries())try{const o=await this.blockstore.get(s.cid,e);s.wantType===cr.WantHave?o.byteLength<this.maxSizeReplaceHasWithBlock?(this.log("sending have and block for %c",s.cid),n.add(i),t.addBlock(s.cid,{data:o,prefix:Rk(s.cid)})):(this.log("sending have for %c",s.cid),t.addBlockPresence(s.cid,{cid:s.cid.bytes,type:Ks.HaveBlock})):(this.log("sending block for %c",s.cid),n.add(i),t.addBlock(s.cid,{data:o,prefix:Rk(s.cid)}))}catch(o){if(o.name!=="NotFoundError")throw o;if(this.log("do not have block for %c",s.cid),!s.sendDontHave||s.sentDoNotHave===!0)continue;s.sentDoNotHave=!0,t.addBlockPresence(s.cid,{cid:s.cid.bytes,type:Ks.DoNotHaveBlock})}if(t.blocks.size>0||t.blockPresences.size>0){this.log("sending message"),await this.network.sendMessage(this.peerId,t,e),this.log("sent message"),this.sentBytes([...t.blocks.values()].reduce((i,s)=>i+s.data.byteLength,0));for(const i of n)this.wants.delete(i)}}}class zae{constructor(e,t={}){u(this,"blockstore");u(this,"network");u(this,"ledgerMap");u(this,"maxSizeReplaceHasWithBlock");u(this,"log");u(this,"logger");this.blockstore=e.blockstore,this.network=e.network,this.maxSizeReplaceHasWithBlock=t.maxSizeReplaceHasWithBlock,this.log=e.logger.forComponent("helia:bitswap:peer-want-lists"),this.logger=e.logger,this.ledgerMap=rF({name:"helia_bitswap_ledger_map",metrics:e.metrics}),this.network.addEventListener("bitswap:message",n=>{this.receiveMessage(n.detail.peer,n.detail.message).catch(i=>{this.log.error("error receiving bitswap message from %p",n.detail.peer,i)})}),this.network.addEventListener("peer:disconnected",n=>{this.peerDisconnected(n.detail)})}ledgerForPeer(e){const t=this.ledgerMap.get(e);if(t!=null)return{peer:t.peerId,value:t.debtRatio(),sent:t.bytesSent,received:t.bytesReceived,exchanged:t.exchangeCount}}wantListForPeer(e){const t=this.ledgerMap.get(e);if(t!=null)return[...t.wants.values()]}peers(){return Array.from(this.ledgerMap.values()).map(e=>e.peerId)}async receiveMessage(e,t){var i;let n=this.ledgerMap.get(e);if(n==null&&(n=new Fae({peerId:e,blockstore:this.blockstore,network:this.network,logger:this.logger},{maxSizeReplaceHasWithBlock:this.maxSizeReplaceHasWithBlock}),this.ledgerMap.set(e,n)),n.receivedBytes(((i=t.blocks)==null?void 0:i.reduce((s,o)=>s+o.data.byteLength,0))??0),t.wantlist!=null){t.wantlist.full===!0&&n.wants.clear();for(const s of t.wantlist.entries){const o=Ub.decode(s.cid),a=re(o.multihash.bytes,"base64");s.cancel===!0?(this.log("peer %p cancelled want of block for %c",e,o),n.wants.delete(a)):(s.wantType===cr.WantHave?this.log("peer %p wanted block presence for %c",e,o):this.log("peer %p wanted block for %c",e,o),n.wants.set(a,{cid:o,priority:s.priority,wantType:s.wantType??cr.WantBlock,sendDontHave:s.sendDontHave??!1}))}}this.log("send blocks to peer"),await n.sendBlocksToPeer()}async receivedBlock(e,t){const n=re(e.multihash.bytes,"base64"),i=[];for(const s of this.ledgerMap.values())s.wants.has(n)&&i.push(s);await Promise.all(i.map(async s=>s.sendBlocksToPeer(t)))}peerDisconnected(e){this.ledgerMap.delete(e)}}function Vae(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function Kae(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var i=0;i<r.length;i++){var s=r.charAt(i),o=s.charCodeAt(0);if(t[o]!==255)throw new TypeError(s+" is ambiguous");t[o]=i}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),d=Math.log(256)/Math.log(a);function h(f){if(f instanceof Uint8Array||(ArrayBuffer.isView(f)?f=new Uint8Array(f.buffer,f.byteOffset,f.byteLength):Array.isArray(f)&&(f=Uint8Array.from(f))),!(f instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(f.length===0)return"";for(var g=0,v=0,y=0,w=f.length;y!==w&&f[y]===0;)y++,g++;for(var b=(w-y)*d+1>>>0,E=new Uint8Array(b);y!==w;){for(var A=f[y],k=0,x=b-1;(A!==0||k<v)&&x!==-1;x--,k++)A+=256*E[x]>>>0,E[x]=A%a>>>0,A=A/a>>>0;if(A!==0)throw new Error("Non-zero carry");v=k,y++}for(var I=b-v;I!==b&&E[I]===0;)I++;for(var T=c.repeat(g);I<b;++I)T+=r.charAt(E[I]);return T}function p(f){if(typeof f!="string")throw new TypeError("Expected String");if(f.length===0)return new Uint8Array;var g=0;if(f[g]!==" "){for(var v=0,y=0;f[g]===c;)v++,g++;for(var w=(f.length-g)*l+1>>>0,b=new Uint8Array(w);f[g];){var E=t[f.charCodeAt(g)];if(E===255)return;for(var A=0,k=w-1;(E!==0||A<y)&&k!==-1;k--,A++)E+=a*b[k]>>>0,b[k]=E%256>>>0,E=E/256>>>0;if(E!==0)throw new Error("Non-zero carry");y=A,g++}if(f[g]!==" "){for(var x=w-y;x!==w&&b[x]===0;)x++;for(var I=new Uint8Array(v+(w-x)),T=v;x!==w;)I[T++]=b[x++];return I}}}function m(f){var g=p(f);if(g)return g;throw new Error(`Non-${e} character`)}return{encode:h,decodeUnsafe:p,decode:m}}var jae=Kae,Hae=jae;let qae=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseEncode");this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},Wae=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseDecode");u(this,"prefixCodePoint");this.name=e,this.prefix=t;const i=t.codePointAt(0);if(i===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=i,this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return oF(this,e)}},Gae=class{constructor(e){u(this,"decoders");this.decoders=e}or(e){return oF(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};function oF(r,e){return new Gae({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}let Qae=class{constructor(e,t,n,i){u(this,"name");u(this,"prefix");u(this,"baseEncode");u(this,"baseDecode");u(this,"encoder");u(this,"decoder");this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=i,this.encoder=new qae(e,t,n),this.decoder=new Wae(e,t,i)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};function aF({name:r,prefix:e,encode:t,decode:n}){return new Qae(r,e,t,n)}function cF({name:r,prefix:e,alphabet:t}){const{encode:n,decode:i}=Hae(t,r);return aF({prefix:e,name:r,encode:n,decode:s=>Vae(i(s))})}function Yae(r,e,t,n){const i={};for(let d=0;d<e.length;++d)i[e[d]]=d;let s=r.length;for(;r[s-1]==="=";)--s;const o=new Uint8Array(s*t/8|0);let a=0,c=0,l=0;for(let d=0;d<s;++d){const h=i[r[d]];if(h===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|h,a+=t,a>=8&&(a-=8,o[l++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o}function Jae(r,e,t){const n=e[e.length-1]==="=",i=(1<<t)-1;let s="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,s+=e[i&a>>o];if(o!==0&&(s+=e[i&a<<t-o]),n)for(;s.length*t&7;)s+="=";return s}function ai({name:r,prefix:e,bitsPerChar:t,alphabet:n}){return aF({prefix:e,name:r,encode(i){return Jae(i,n,t)},decode(i){return Yae(i,n,t,r)}})}const Xae=ai({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});ai({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});ai({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});ai({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});ai({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});ai({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});ai({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});ai({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});ai({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const Zae=cF({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});cF({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});const ece=ai({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6});ai({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6});ai({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6});ai({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});const Xd=1e3,Zd=Xd*60,eh=Zd*60,Yl=eh*24,tce=Yl*7,rce=Yl*365.25;function lF(r,e){try{if(typeof r=="string"&&r.length>0)return nce(r);if(typeof r=="number"&&isFinite(r))return e!=null&&e.long?sce(r):ice(r);throw new Error("Value is not a string or number.")}catch(t){const n=oce(t)?`${t.message}. value=${JSON.stringify(r)}`:"An unknown error has occured.";throw new Error(n)}}function nce(r){if(r=String(r),r.length>100)throw new Error("Value exceeds the maximum length of 100 characters.");const e=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(r);if(!e)return NaN;const t=parseFloat(e[1]),n=(e[2]||"ms").toLowerCase();switch(n){case"years":case"year":case"yrs":case"yr":case"y":return t*rce;case"weeks":case"week":case"w":return t*tce;case"days":case"day":case"d":return t*Yl;case"hours":case"hour":case"hrs":case"hr":case"h":return t*eh;case"minutes":case"minute":case"mins":case"min":case"m":return t*Zd;case"seconds":case"second":case"secs":case"sec":case"s":return t*Xd;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return t;default:throw new Error(`The unit ${n} was matched, but no matching case exists.`)}}function ice(r){const e=Math.abs(r);return e>=Yl?`${Math.round(r/Yl)}d`:e>=eh?`${Math.round(r/eh)}h`:e>=Zd?`${Math.round(r/Zd)}m`:e>=Xd?`${Math.round(r/Xd)}s`:`${r}ms`}function sce(r){const e=Math.abs(r);return e>=Yl?eg(r,e,Yl,"day"):e>=eh?eg(r,e,eh,"hour"):e>=Zd?eg(r,e,Zd,"minute"):e>=Xd?eg(r,e,Xd,"second"):`${r} ms`}function eg(r,e,t,n){const i=e>=t*1.5;return`${Math.round(r/t)} ${n}${i?"s":""}`}function oce(r){return typeof r=="object"&&r!==null&&"message"in r}function ace(r){t.debug=t,t.default=t,t.coerce=c,t.disable=s,t.enable=i,t.enabled=o,t.humanize=lF,t.destroy=l,Object.keys(r).forEach(d=>{t[d]=r[d]}),t.names=[],t.skips=[],t.formatters={};function e(d){let h=0;for(let p=0;p<d.length;p++)h=(h<<5)-h+d.charCodeAt(p),h|=0;return t.colors[Math.abs(h)%t.colors.length]}t.selectColor=e;function t(d){let h,p=null,m,f;function g(...v){if(!g.enabled)return;const y=g,w=Number(new Date),b=w-(h||w);y.diff=b,y.prev=h,y.curr=w,h=w,v[0]=t.coerce(v[0]),typeof v[0]!="string"&&v.unshift("%O");let E=0;v[0]=v[0].replace(/%([a-zA-Z%])/g,(k,x)=>{if(k==="%%")return"%";E++;const I=t.formatters[x];if(typeof I=="function"){const T=v[E];k=I.call(y,T),v.splice(E,1),E--}return k}),t.formatArgs.call(y,v),(y.log||t.log).apply(y,v)}return g.namespace=d,g.useColors=t.useColors(),g.color=t.selectColor(d),g.extend=n,g.destroy=t.destroy,Object.defineProperty(g,"enabled",{enumerable:!0,configurable:!1,get:()=>p!==null?p:(m!==t.namespaces&&(m=t.namespaces,f=t.enabled(d)),f),set:v=>{p=v}}),typeof t.init=="function"&&t.init(g),g}function n(d,h){const p=t(this.namespace+(typeof h>"u"?":":h)+d);return p.log=this.log,p}function i(d){t.save(d),t.namespaces=d,t.names=[],t.skips=[];let h;const p=(typeof d=="string"?d:"").split(/[\s,]+/),m=p.length;for(h=0;h<m;h++)p[h]&&(d=p[h].replace(/\*/g,".*?"),d[0]==="-"?t.skips.push(new RegExp("^"+d.substr(1)+"$")):t.names.push(new RegExp("^"+d+"$")))}function s(){const d=[...t.names.map(a),...t.skips.map(a).map(h=>"-"+h)].join(",");return t.enable(""),d}function o(d){if(d[d.length-1]==="*")return!0;let h,p;for(h=0,p=t.skips.length;h<p;h++)if(t.skips[h].test(d))return!1;for(h=0,p=t.names.length;h<p;h++)if(t.names[h].test(d))return!0;return!1}function a(d){return d.toString().substring(2,d.toString().length-2).replace(/\.\*\?$/,"*")}function c(d){return d instanceof Error?d.stack??d.message:d}function l(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return t.setupFormatters(t.formatters),t.enable(t.load()),t}var cce={};const Os=gce(),lce=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function uce(){var r,e,t,n,i;return typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs)?!0:typeof navigator<"u"&&((r=navigator.userAgent)==null?void 0:r.toLowerCase().match(/(edge|trident)\/(\d+)/))!=null?!1:typeof document<"u"&&((t=(e=document.documentElement)==null?void 0:e.style)==null?void 0:t.WebkitAppearance)||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&((n=navigator.userAgent)==null?void 0:n.toLowerCase().match(/firefox\/(\d+)/))!=null&&parseInt(RegExp.$1,10)>=31||typeof navigator<"u"&&((i=navigator.userAgent)==null?void 0:i.toLowerCase().match(/applewebkit\/(\d+)/))}function dce(r){if(r[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+r[0]+(this.useColors?"%c ":" ")+"+"+lF(this.diff),!this.useColors)return;const e="color: "+this.color;r.splice(1,0,e,"color: inherit");let t=0,n=0;r[0].replace(/%[a-zA-Z%]/g,i=>{i!=="%%"&&(t++,i==="%c"&&(n=t))}),r.splice(n,0,e)}const hce=console.debug??console.log??(()=>{});function fce(r){try{r?Os==null||Os.setItem("debug",r):Os==null||Os.removeItem("debug")}catch{}}function pce(){let r;try{r=Os==null?void 0:Os.getItem("debug")}catch{}return!r&&typeof globalThis.process<"u"&&"env"in globalThis.process&&(r=cce.DEBUG),r}function gce(){try{return localStorage}catch{}}function yce(r){r.j=function(e){try{return JSON.stringify(e)}catch(t){return"[UnexpectedJSONParseError]: "+t.message}}}const Qn=ace({formatArgs:dce,save:fce,load:pce,useColors:uce,setupFormatters:yce,colors:lce,storage:Os,log:hce});Qn.formatters.b=r=>r==null?"undefined":Zae.baseEncode(r);Qn.formatters.t=r=>r==null?"undefined":Xae.baseEncode(r);Qn.formatters.m=r=>r==null?"undefined":ece.baseEncode(r);Qn.formatters.p=r=>r==null?"undefined":r.toString();Qn.formatters.c=r=>r==null?"undefined":r.toString();Qn.formatters.k=r=>r==null?"undefined":r.toString();Qn.formatters.a=r=>r==null?"undefined":r.toString();Qn.formatters.e=r=>r==null?"undefined":Lk(r.stack)??Lk(r.message)??r.toString();function mce(r){const e=()=>{};return e.enabled=!1,e.color="",e.diff=0,e.log=()=>{},e.namespace=r,e.destroy=()=>!0,e.extend=()=>e,e}function ww(){return{forComponent(r){return Rh(r)}}}function Rh(r){let e=mce(`${r}:trace`);return Qn.enabled(`${r}:trace`)&&Qn.names.map(t=>t.toString()).find(t=>t.includes(":trace"))!=null&&(e=Qn(`${r}:trace`)),Object.assign(Qn(r),{error:Qn(`${r}:error`),trace:e})}function Lk(r){if(r!=null&&(r=r.trim(),r.length!==0))return r}function uF(r){const e=[Cc.A];return r==null?e:Array.isArray(r)?r.length===0?e:r:[r]}const dF=60;function hF(r){return{Status:r.Status??0,TC:r.TC??r.flag_tc??!1,RD:r.RD??r.flag_rd??!1,RA:r.RA??r.flag_ra??!1,AD:r.AD??r.flag_ad??!1,CD:r.CD??r.flag_cd??!1,Question:(r.Question??r.questions??[]).map(e=>({name:e.name,type:Cc[e.type]})),Answer:(r.Answer??r.answers??[]).map(e=>({name:e.name,type:Cc[e.type],TTL:e.TTL??e.ttl??dF,data:e.data instanceof Uint8Array?re(e.data):e.data}))}}const wce=4;function Bk(r,e={}){const t=new wc({concurrency:e.queryConcurrency??wce});return async(n,i={})=>{var a;const s=new URLSearchParams;s.set("name",n),uF(i.types).forEach(c=>{s.append("type",Cc[c])}),(a=i.onProgress)==null||a.call(i,new _e("dns:query",{detail:n}));const o=await t.add(async()=>{var d;const c=await fetch(`${r}?${s}`,{headers:{accept:"application/dns-json"},signal:i==null?void 0:i.signal});if(c.status!==200)throw new Error(`Unexpected HTTP status: ${c.status} - ${c.statusText}`);const l=hF(await c.json());return(d=i.onProgress)==null||d.call(i,new _e("dns:response",{detail:l})),l},{signal:i.signal});if(o==null)throw new Error("No DNS response received");return o}}function bce(){return[Bk("https://cloudflare-dns.com/dns-query"),Bk("https://dns.google/resolve")]}var vce=function(r){if(!r)throw Error("hashlru must have a max value, of type number, greater than 0");var e=0,t=Object.create(null),n=Object.create(null);function i(s,o){t[s]=o,e++,e>=r&&(e=0,n=t,t=Object.create(null))}return{has:function(s){return t[s]!==void 0||n[s]!==void 0},remove:function(s){t[s]!==void 0&&(t[s]=void 0),n[s]!==void 0&&(n[s]=void 0)},get:function(s){var o=t[s];if(o!==void 0)return o;if((o=n[s])!==void 0)return i(s,o),o},set:function(s,o){t[s]!==void 0?t[s]=o:i(s,o)},clear:function(){t=Object.create(null),n=Object.create(null)}}};const Ece=Nc(vce);class Sce{constructor(e){u(this,"lru");this.lru=Ece(e)}get(e,t){let n=!0;const i=[];for(const s of t){const o=this.getAnswers(e,s);if(o.length===0){n=!1;break}i.push(...o)}if(n)return hF({answers:i})}getAnswers(e,t){const n=`${e.toLowerCase()}-${t}`,i=this.lru.get(n);if(i!=null){const s=i.filter(o=>o.expires>Date.now()).map(({expires:o,value:a})=>({...a,TTL:Math.round((o-Date.now())/1e3),type:Cc[a.type]}));return s.length===0&&this.lru.remove(n),s}return[]}add(e,t){const n=`${e.toLowerCase()}-${t.type}`,i=this.lru.get(n)??[];i.push({expires:Date.now()+(t.TTL??dF)*1e3,value:t}),this.lru.set(n,i)}remove(e,t){const n=`${e.toLowerCase()}-${t}`;this.lru.remove(n)}clear(){this.lru.clear()}}function xce(r){return new Sce(r)}const Ace=1e3;let Cce=class{constructor(e){u(this,"resolvers");u(this,"cache");this.resolvers={},this.cache=xce(e.cacheSize??Ace),Object.entries(e.resolvers??{}).forEach(([t,n])=>{Array.isArray(n)||(n=[n]),t.endsWith(".")||(t=`${t}.`),this.resolvers[t]=n}),this.resolvers["."]==null&&(this.resolvers["."]=bce())}async query(e,t={}){var c,l,d;const n=uF(t.types),i=t.cached!==!1?this.cache.get(e,n):void 0;if(i!=null)return(c=t.onProgress)==null||c.call(t,new _e("dns:cache",{detail:i})),i;const s=`${e.split(".").pop()}.`,o=(this.resolvers[s]??this.resolvers["."]).sort(()=>Math.random()>.5?-1:1),a=[];for(const h of o){if(((l=t.signal)==null?void 0:l.aborted)===!0)break;try{const p=await h(e,{...t,types:n});for(const m of p.Answer)this.cache.add(e,m);return p}catch(p){a.push(p),(d=t.onProgress)==null||d.call(t,new _e("dns:error",{detail:p}))}}throw a.length===1?a[0]:new AggregateError(a,`DNS lookup of ${e} ${n} failed`)}};var Cc;(function(r){r[r.A=1]="A",r[r.CNAME=5]="CNAME",r[r.TXT=16]="TXT",r[r.AAAA=28]="AAAA"})(Cc||(Cc={}));function fF(r={}){return new Cce(r)}const uo="/",pF=new TextEncoder().encode(uo),tg=pF[0];class Et{constructor(e,t){u(this,"_buf");if(typeof e=="string")this._buf=oe(e);else if(e instanceof Uint8Array)this._buf=e;else throw new Error("Invalid key, should be String of Uint8Array");if(t==null&&(t=!0),t&&this.clean(),this._buf.byteLength===0||this._buf[0]!==tg)throw new Error("Invalid key")}toString(e="utf8"){return re(this._buf,e)}uint8Array(){return this._buf}get[Symbol.toStringTag](){return`Key(${this.toString()})`}static withNamespaces(e){return new Et(e.join(uo))}static random(){return new Et(Math.random().toString().substring(2))}static asKey(e){return e instanceof Uint8Array||typeof e=="string"?new Et(e):typeof e.uint8Array=="function"?new Et(e.uint8Array()):null}clean(){if((this._buf==null||this._buf.byteLength===0)&&(this._buf=pF),this._buf[0]!==tg){const e=new Uint8Array(this._buf.byteLength+1);e.fill(tg,0,1),e.set(this._buf,1),this._buf=e}for(;this._buf.byteLength>1&&this._buf[this._buf.byteLength-1]===tg;)this._buf=this._buf.subarray(0,-1)}less(e){const t=this.list(),n=e.list();for(let i=0;i<t.length;i++){if(n.length<i+1)return!1;const s=t[i],o=n[i];if(s<o)return!0;if(s>o)return!1}return t.length<n.length}reverse(){return Et.withNamespaces(this.list().slice().reverse())}namespaces(){return this.list()}baseNamespace(){const e=this.namespaces();return e[e.length-1]}list(){return this.toString().split(uo).slice(1)}type(){return Ice(this.baseNamespace())}name(){return kce(this.baseNamespace())}instance(e){return new Et(this.toString()+":"+e)}path(){let e=this.parent().toString();return e.endsWith(uo)||(e+=uo),e+=this.type(),new Et(e)}parent(){const e=this.list();return e.length===1?new Et(uo):new Et(e.slice(0,-1).join(uo))}child(e){return this.toString()===uo?e:e.toString()===uo?this:new Et(this.toString()+e.toString(),!1)}isAncestorOf(e){return e.toString()===this.toString()?!1:e.toString().startsWith(this.toString())}isDecendantOf(e){return e.toString()===this.toString()?!1:this.toString().startsWith(e.toString())}isTopLevel(){return this.list().length===1}concat(...e){return Et.withNamespaces([...this.namespaces(),..._ce(e.map(t=>t.namespaces()))])}}function Ice(r){const e=r.split(":");return e.length<2?"":e.slice(0,-1).join(":")}function kce(r){const e=r.split(":");return e[e.length-1]}function _ce(r){return[].concat(...r)}function Tce(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function Lh(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function Pce(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var i=0;i<r.length;i++){var s=r.charAt(i),o=s.charCodeAt(0);if(t[o]!==255)throw new TypeError(s+" is ambiguous");t[o]=i}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),d=Math.log(256)/Math.log(a);function h(f){if(f instanceof Uint8Array||(ArrayBuffer.isView(f)?f=new Uint8Array(f.buffer,f.byteOffset,f.byteLength):Array.isArray(f)&&(f=Uint8Array.from(f))),!(f instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(f.length===0)return"";for(var g=0,v=0,y=0,w=f.length;y!==w&&f[y]===0;)y++,g++;for(var b=(w-y)*d+1>>>0,E=new Uint8Array(b);y!==w;){for(var A=f[y],k=0,x=b-1;(A!==0||k<v)&&x!==-1;x--,k++)A+=256*E[x]>>>0,E[x]=A%a>>>0,A=A/a>>>0;if(A!==0)throw new Error("Non-zero carry");v=k,y++}for(var I=b-v;I!==b&&E[I]===0;)I++;for(var T=c.repeat(g);I<b;++I)T+=r.charAt(E[I]);return T}function p(f){if(typeof f!="string")throw new TypeError("Expected String");if(f.length===0)return new Uint8Array;var g=0;if(f[g]!==" "){for(var v=0,y=0;f[g]===c;)v++,g++;for(var w=(f.length-g)*l+1>>>0,b=new Uint8Array(w);f[g];){var E=t[f.charCodeAt(g)];if(E===255)return;for(var A=0,k=w-1;(E!==0||A<y)&&k!==-1;k--,A++)E+=a*b[k]>>>0,b[k]=E%256>>>0,E=E/256>>>0;if(E!==0)throw new Error("Non-zero carry");y=A,g++}if(f[g]!==" "){for(var x=w-y;x!==w&&b[x]===0;)x++;for(var I=new Uint8Array(v+(w-x)),T=v;x!==w;)I[T++]=b[x++];return I}}}function m(f){var g=p(f);if(g)return g;throw new Error(`Non-${e} character`)}return{encode:h,decodeUnsafe:p,decode:m}}var Dce=Pce,$ce=Dce;let Nce=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseEncode");this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},Mce=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseDecode");u(this,"prefixCodePoint");this.name=e,this.prefix=t;const i=t.codePointAt(0);if(i===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=i,this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return gF(this,e)}},Oce=class{constructor(e){u(this,"decoders");this.decoders=e}or(e){return gF(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};function gF(r,e){return new Oce({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}let Rce=class{constructor(e,t,n,i){u(this,"name");u(this,"prefix");u(this,"baseEncode");u(this,"baseDecode");u(this,"encoder");u(this,"decoder");this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=i,this.encoder=new Nce(e,t,n),this.decoder=new Mce(e,t,i)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};function yF({name:r,prefix:e,encode:t,decode:n}){return new Rce(r,e,t,n)}function bw({name:r,prefix:e,alphabet:t}){const{encode:n,decode:i}=$ce(t,r);return yF({prefix:e,name:r,encode:n,decode:s=>Lh(i(s))})}function Lce(r,e,t,n){const i={};for(let d=0;d<e.length;++d)i[e[d]]=d;let s=r.length;for(;r[s-1]==="=";)--s;const o=new Uint8Array(s*t/8|0);let a=0,c=0,l=0;for(let d=0;d<s;++d){const h=i[r[d]];if(h===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|h,a+=t,a>=8&&(a-=8,o[l++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o}function Bce(r,e,t){const n=e[e.length-1]==="=",i=(1<<t)-1;let s="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,s+=e[i&a>>o];if(o!==0&&(s+=e[i&a<<t-o]),n)for(;s.length*t&7;)s+="=";return s}function ci({name:r,prefix:e,bitsPerChar:t,alphabet:n}){return yF({prefix:e,name:r,encode(i){return Bce(i,n,t)},decode(i){return Lce(i,n,t,r)}})}const vd=bw({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"});bw({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});const Jg=ci({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});ci({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});ci({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});ci({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});ci({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});ci({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});ci({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});ci({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});ci({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const Pa=bw({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});bw({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var Uce=mF,Uk=128,Fce=-128,zce=Math.pow(2,31);function mF(r,e,t){e=e||[],t=t||0;for(var n=t;r>=zce;)e[t++]=r&255|Uk,r/=128;for(;r&Fce;)e[t++]=r&255|Uk,r>>>=7;return e[t]=r|0,mF.bytes=t-n+1,e}var Vce=Fb,Kce=128,Fk=127;function Fb(r,n){var t=0,n=n||0,i=0,s=n,o,a=r.length;do{if(s>=a)throw Fb.bytes=0,new RangeError("Could not decode varint");o=r[s++],t+=i<28?(o&Fk)<<i:(o&Fk)*Math.pow(2,i),i+=7}while(o>=Kce);return Fb.bytes=s-n,t}var jce=Math.pow(2,7),Hce=Math.pow(2,14),qce=Math.pow(2,21),Wce=Math.pow(2,28),Gce=Math.pow(2,35),Qce=Math.pow(2,42),Yce=Math.pow(2,49),Jce=Math.pow(2,56),Xce=Math.pow(2,63),Zce=function(r){return r<jce?1:r<Hce?2:r<qce?3:r<Wce?4:r<Gce?5:r<Qce?6:r<Yce?7:r<Jce?8:r<Xce?9:10},ele={encode:Uce,decode:Vce,encodingLength:Zce},Cy=ele;function zb(r,e=0){return[Cy.decode(r,e),Cy.decode.bytes]}function Iy(r,e,t=0){return Cy.encode(r,e,t),e}function ky(r){return Cy.encodingLength(r)}function _y(r,e){const t=e.byteLength,n=ky(r),i=n+ky(t),s=new Uint8Array(i+t);return Iy(r,s,0),Iy(t,s,n),s.set(e,i),new KS(r,t,e,s)}function tle(r){const e=Lh(r),[t,n]=zb(e),[i,s]=zb(e.subarray(n)),o=e.subarray(n+s);if(o.byteLength!==i)throw new Error("Incorrect length");return new KS(t,i,o,e)}function rle(r,e){if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&Tce(r.bytes,t.bytes)}}let KS=class{constructor(e,t,n,i){u(this,"code");u(this,"size");u(this,"digest");u(this,"bytes");this.code=e,this.size=t,this.digest=n,this.bytes=i}};function zk(r,e){const{bytes:t,version:n}=r;switch(n){case 0:return ile(t,Vb(r),e??Pa.encoder);default:return sle(t,Vb(r),e??Jg.encoder)}}const Vk=new WeakMap;function Vb(r){const e=Vk.get(r);if(e==null){const t=new Map;return Vk.set(r,t),t}return e}var uN;let Jl=class Ur{constructor(e,t,n,i){u(this,"code");u(this,"version");u(this,"multihash");u(this,"bytes");u(this,"/");u(this,uN,"CID");this.code=t,this.version=e,this.multihash=n,this.bytes=i,this["/"]=i}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==Af)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==ole)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return Ur.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=_y(e,t);return Ur.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return Ur.equals(this,e)}static equals(e,t){const n=t;return n!=null&&e.code===n.code&&e.version===n.version&&rle(e.multihash,n.multihash)}toString(e){return zk(this,e)}toJSON(){return{"/":zk(this)}}link(){return this}[(uN=Symbol.toStringTag,Symbol.for("nodejs.util.inspect.custom"))](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof Ur)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:i,multihash:s,bytes:o}=t;return new Ur(n,i,s,o??Kk(n,i,s.bytes))}else if(t[ale]===!0){const{version:n,multihash:i,code:s}=t,o=tle(i);return Ur.create(n,s,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==Af)throw new Error(`Version 0 CID must use dag-pb (code: ${Af}) block encoding`);return new Ur(e,t,n,n.bytes)}case 1:{const i=Kk(e,t,n.bytes);return new Ur(e,t,n,i)}default:throw new Error("Invalid version")}}static createV0(e){return Ur.create(0,Af,e)}static createV1(e,t){return Ur.create(1,e,t)}static decode(e){const[t,n]=Ur.decodeFirst(e);if(n.length!==0)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=Ur.inspectBytes(e),n=t.size-t.multihashSize,i=Lh(e.subarray(n,n+t.multihashSize));if(i.byteLength!==t.multihashSize)throw new Error("Incorrect length");const s=i.subarray(t.multihashSize-t.digestSize),o=new KS(t.multihashCode,t.digestSize,s,i);return[t.version===0?Ur.createV0(o):Ur.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[h,p]=zb(e.subarray(t));return t+=p,h};let i=n(),s=Af;if(i===18?(i=0,t=0):s=n(),i!==0&&i!==1)throw new RangeError(`Invalid CID version ${i}`);const o=t,a=n(),c=n(),l=t+c,d=l-o;return{version:i,codec:s,multihashCode:a,digestSize:c,multihashSize:d,size:l}}static parse(e,t){const[n,i]=nle(e,t),s=Ur.decode(i);if(s.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return Vb(s).set(n,e),s}};function nle(r,e){switch(r[0]){case"Q":{const t=e??Pa;return[Pa.prefix,t.decode(`${Pa.prefix}${r}`)]}case Pa.prefix:{const t=e??Pa;return[Pa.prefix,t.decode(r)]}case Jg.prefix:{const t=e??Jg;return[Jg.prefix,t.decode(r)]}case vd.prefix:{const t=e??vd;return[vd.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}}function ile(r,e,t){const{prefix:n}=t;if(n!==Pa.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const i=e.get(n);if(i==null){const s=t.encode(r).slice(1);return e.set(n,s),s}else return i}function sle(r,e,t){const{prefix:n}=t,i=e.get(n);if(i==null){const s=t.encode(r);return e.set(n,s),s}else return i}const Af=112,ole=18;function Kk(r,e,t){const n=ky(r),i=n+ky(e),s=new Uint8Array(i+t.byteLength);return Iy(r,s,0),Iy(e,s,n),s.set(t,i),s}const ale=Symbol.for("@ipld/js-cid/CID");function wF({name:r,code:e,encode:t}){return new cle(r,e,t)}let cle=class{constructor(e,t,n){u(this,"name");u(this,"code");u(this,"encode");this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?_y(this.code,t):t.then(n=>_y(this.code,n))}else throw Error("Unknown type, must be binary type")}};function rg({enumerable:r=!0,configurable:e=!1}={}){return{enumerable:r,configurable:e,writable:!1}}function*lle(r,e){if(e!=null&&typeof e=="object")if(Array.isArray(e))for(const[t,n]of e.entries()){const i=[...r,t],s=Jl.asCID(n);s!=null?yield[i.join("/"),s]:typeof n=="object"&&(yield*Kb(n,i))}else{const t=Jl.asCID(e);t!=null?yield[r.join("/"),t]:yield*Kb(e,r)}}function*Kb(r,e){if(r==null||r instanceof Uint8Array)return;const t=Jl.asCID(r);t!=null&&(yield[e.join("/"),t]);for(const[n,i]of Object.entries(r)){const s=[...e,n];yield*lle(s,i)}}function*ule(r,e){if(Array.isArray(e))for(const[t,n]of e.entries()){const i=[...r,t];yield i.join("/"),typeof n=="object"&&Jl.asCID(n)==null&&(yield*jb(n,i))}else yield*jb(e,r)}function*jb(r,e){if(!(r==null||typeof r!="object"))for(const[t,n]of Object.entries(r)){const i=[...e,t];yield i.join("/"),n!=null&&!(n instanceof Uint8Array)&&typeof n=="object"&&Jl.asCID(n)==null&&(yield*ule(i,n))}}function dle(r,e){let t=r;for(const[n,i]of e.entries()){if(t=t[i],t==null)throw new Error(`Object has no property at ${e.slice(0,n+1).map(o=>`[${JSON.stringify(o)}]`).join("")}`);const s=Jl.asCID(t);if(s!=null)return{value:s,remaining:e.slice(n+1).join("/")}}return{value:t}}class hle{constructor({cid:e,bytes:t,value:n}){u(this,"cid");u(this,"bytes");u(this,"value");u(this,"asBlock");if(e==null||t==null||typeof n>"u")throw new Error("Missing required argument");this.cid=e,this.bytes=t,this.value=n,this.asBlock=this,Object.defineProperties(this,{cid:rg(),bytes:rg(),value:rg(),asBlock:rg()})}links(){return Kb(this.value,[])}tree(){return jb(this.value,[])}get(e="/"){return dle(this.value,e.split("/").filter(Boolean))}}function fle({bytes:r,cid:e,value:t,codec:n}){const i=t!==void 0?t:n==null?void 0:n.decode(r);if(i===void 0)throw new Error('Missing required argument, must either provide "value" or "codec"');return new hle({cid:e,bytes:r,value:i})}const bF="/pin/",jk="/pinned-block/",Hb=vd,Hk=1;function ng(r){return r.version===0&&(r=r.toV1()),new Et(`${bF}${r.toString(Hb)}`)}var Oo,Xg,qb;class ple{constructor(e,t,n){Ge(this,Oo);u(this,"datastore");u(this,"blockstore");u(this,"getCodec");this.datastore=e,this.blockstore=t,this.getCodec=n}async*add(e,t={}){const n=ng(e);if(await this.datastore.has(n))throw new Error("Already pinned");const i=Math.round(t.depth??1/0);if(i<0)throw new Error("Depth must be greater than or equal to 0");const s=new Gl({concurrency:Hk});for await(const a of Ie(this,Oo,Xg).call(this,e,s,{...t,depth:i}))await Ie(this,Oo,qb).call(this,a,c=>c.pinnedBy.find(l=>He(l,e.bytes))!=null?!1:(c.pinCount++,c.pinnedBy.push(e.bytes),!0),t),yield a;const o={depth:i,metadata:t.metadata??{}};await this.datastore.put(n,Kg(o),t)}async*rm(e,t={}){const n=ng(e),i=await this.datastore.get(n,t),s=za(i);await this.datastore.delete(n,t);const o=new Gl({concurrency:Hk});for await(const a of Ie(this,Oo,Xg).call(this,e,o,{...t,depth:s.depth}))await Ie(this,Oo,qb).call(this,a,c=>(c.pinCount--,c.pinnedBy=c.pinnedBy.filter(l=>He(l,e.bytes)),!0),{...t,depth:s.depth}),yield a}async*ls(e={}){for await(const{key:t,value:n}of this.datastore.query({prefix:bF+(e.cid!=null?`${e.cid.toString(vd)}`:"")},e)){const i=Jl.parse(t.toString().substring(5),vd),s=za(n);yield{cid:i,...s}}}async isPinned(e,t={}){const n=new Et(`${jk}${Hb.encode(e.multihash.bytes)}`);return this.datastore.has(n,t)}async get(e,t){const n=ng(e),i=await this.datastore.get(n,t);return za(i)}async setMetadata(e,t,n){const i=ng(e),s=await this.datastore.get(i,n),o=za(s);o.metadata=t??{},await this.datastore.put(i,Kg(o),n)}}Oo=new WeakSet,Xg=async function*(e,t,n){if(n.depth===-1)return;const i=await this.getCodec(e.code),s=await this.blockstore.get(e,n),o=fle({bytes:s,cid:e,codec:i});yield e;for await(const[,a]of o.links())yield*await t.add(async()=>Ie(this,Oo,Xg).call(this,a,t,{...n,depth:n.depth-1}))},qb=async function(e,t,n){var a;const i=new Et(`${jk}${Hb.encode(e.multihash.bytes)}`);let s={pinCount:0,pinnedBy:[]};try{s=za(await this.datastore.get(i,n))}catch(c){if(c.name!=="NotFoundError")throw c}if(t(s)){if(s.pinCount===0&&await this.datastore.has(i)){await this.datastore.delete(i);return}await this.datastore.put(i,Kg(s),n),(a=n.onProgress)==null||a.call(n,new _e("helia:pin:add",e))}};const gle=1,yle=5;class vF extends Error{constructor(e="Insufficient providers found"){super(e),this.name="InsufficientProvidersError"}}u(vF,"name","InsufficientProvidersError");class Kf extends Error{constructor(e="No routers available"){super(e),this.name="NoRoutersAvailableError"}}u(Kf,"name","NoRoutersAvailableError");class EF extends Error{constructor(e="Unknown hash algorithm"){super(e),this.name="UnknownHashAlgorithmError"}}u(EF,"name","UnknownHashAlgorithmError");class SF extends Error{constructor(e="Unknown codec"){super(e),this.name="UnknownCodecError"}}u(SF,"name","UnknownCodecError");const mle=5;class wle{constructor(e,t){u(this,"log");u(this,"routers");u(this,"providerLookupConcurrency");var n,i,s,o,a,c,l;this.log=e.logger.forComponent("helia:routing"),this.routers=t.routers??[],this.providerLookupConcurrency=t.providerLookupConcurrency??mle,this.findProviders=((n=e.metrics)==null?void 0:n.traceFunction("helia.routing.findProviders",this.findProviders.bind(this),{optionsIndex:1}))??this.findProviders,this.provide=((i=e.metrics)==null?void 0:i.traceFunction("helia.routing.provide",this.provide.bind(this),{optionsIndex:1}))??this.provide,this.cancelReprovide=((s=e.metrics)==null?void 0:s.traceFunction("helia.routing.cancelReprovide",this.cancelReprovide.bind(this),{optionsIndex:1}))??this.cancelReprovide,this.put=((o=e.metrics)==null?void 0:o.traceFunction("helia.routing.put",this.put.bind(this),{optionsIndex:2}))??this.put,this.get=((a=e.metrics)==null?void 0:a.traceFunction("helia.routing.get",this.get.bind(this),{optionsIndex:1}))??this.get,this.findPeer=((c=e.metrics)==null?void 0:c.traceFunction("helia.routing.findPeer",this.findPeer.bind(this),{optionsIndex:1}))??this.findPeer,this.getClosestPeers=((l=e.metrics)==null?void 0:l.traceFunction("helia.routing.getClosestPeers",this.getClosestPeers.bind(this),{optionsIndex:1}))??this.getClosestPeers}async start(){await Vo(...this.routers)}async stop(){await Bc(...this.routers)}async*findProviders(e,t={}){if(this.routers.length===0)throw new Kf("No content routers available");const n=new Ac({concurrency:this.providerLookupConcurrency});n.addEventListener("error",()=>{});for await(const i of cc(n.toGenerator(),...Zc(this.routers,"findProviders").map(s=>s.findProviders(e,t))))if(i!=null){if(i.multiaddrs.length===0){if(n.find(i.id)!=null)continue;n.add(async()=>{try{const s=await this.findPeer(i.id,t);return s.multiaddrs.length===0?null:s}catch(s){return this.log.error("could not load multiaddrs for peer %p",i.id,s),null}},{peerId:i.id,signal:t.signal}).catch(s=>{this.log.error("could not load multiaddrs for peer %p",i.id,s)})}yield i}}async provide(e,t={}){if(this.routers.length===0)throw new Kf("No content routers available");await Promise.all(Zc(this.routers,"provide").map(async n=>{await n.provide(e,t)}))}async cancelReprovide(e,t={}){await Promise.all(Zc(this.routers,"cancelReprovide").map(async n=>{await n.cancelReprovide(e,t)}))}async put(e,t,n){await Promise.all(Zc(this.routers,"put").map(async i=>{await i.put(e,t,n)}))}async get(e,t){return Promise.any(Zc(this.routers,"get").map(async n=>n.get(e,t)))}async findPeer(e,t){if(this.routers.length===0)throw new Kf("No peer routers available");const n=this,i=cc(...Zc(this.routers,"findPeer").map(s=>async function*(){try{yield await s.findPeer(e,t)}catch(o){n.log.error(o)}}()));for await(const s of i)if(s!=null)return s;throw new Zt("Could not find peer in routing")}async*getClosestPeers(e,t={}){if(this.routers.length===0)throw new Kf("No peer routers available");for await(const n of cc(...Zc(this.routers,"getClosestPeers").map(i=>i.getClosestPeers(e,t))))n!=null&&(yield n)}}function Zc(r,e){return r.filter(t=>t[e]!=null)}const hc={},Xl=r=>{r.addEventListener("message",e=>{Xl.dispatchEvent("message",r,e)}),r.port!=null&&r.port.addEventListener("message",e=>{Xl.dispatchEvent("message",r,e)})};Xl.addEventListener=(r,e)=>{hc[r]==null&&(hc[r]=[]),hc[r].push(e)};Xl.removeEventListener=(r,e)=>{hc[r]!=null&&(hc[r]=hc[r].filter(t=>t===e))};Xl.dispatchEvent=function(r,e,t){hc[r]!=null&&hc[r].forEach(n=>n(e,t))};const qk="lock:worker:request-read",Wk="lock:worker:release-read",Gk="lock:master:grant-read",Qk="lock:worker:request-write",Yk="lock:worker:release-write",Jk="lock:master:grant-write",ble=(r=21)=>Math.random().toString().substring(2),Xk=(r,e,t,n,i)=>(s,o)=>{if(o.data.type!==t)return;const a={type:o.data.type,name:o.data.name,identifier:o.data.identifier};r.dispatchEvent(new MessageEvent(e,{data:{name:a.name,handler:async()=>{s.postMessage({type:i,name:a.name,identifier:a.identifier}),await new Promise(c=>{const l=d=>{if((d==null?void 0:d.data)==null)return;const h={type:d.data.type,name:d.data.name,identifier:d.data.identifier};h.type===n&&h.identifier===a.identifier&&(s.removeEventListener("message",l),c())};s.addEventListener("message",l)})}}}))},Zk=(r,e,t,n)=>async()=>{const i=ble();return globalThis.postMessage({type:e,identifier:i,name:r}),new Promise(s=>{const o=a=>{if((a==null?void 0:a.data)==null)return;const c={type:a.data.type,identifier:a.data.identifier};c.type===t&&c.identifier===i&&(globalThis.removeEventListener("message",o),s(()=>{globalThis.postMessage({type:n,identifier:i,name:r})}))};globalThis.addEventListener("message",o)})},vle={singleProcess:!1},Ele=r=>{if(r=Object.assign({},vle,r),!!globalThis.document||r.singleProcess){const t=new EventTarget;return Xl.addEventListener("message",Xk(t,"requestReadLock",qk,Wk,Gk)),Xl.addEventListener("message",Xk(t,"requestWriteLock",Qk,Yk,Jk)),t}return{isWorker:!0,readLock:t=>Zk(t,qk,Gk,Wk),writeLock:t=>Zk(t,Qk,Jk,Yk)}},el={};let Va;async function n8(r,e){let t;const n=new Promise(i=>{t=i});return r.add(async()=>Pp((async()=>{await new Promise(i=>{t(()=>{i()})})})(),{milliseconds:e.timeout})),n}const Sle=(r,e)=>{if(Va.isWorker===!0)return{readLock:Va.readLock(r,e),writeLock:Va.writeLock(r,e)};const t=new wc({concurrency:1});let n;return{async readLock(){if(n!=null)return n8(n,e);n=new wc({concurrency:e.concurrency,autoStart:!1});const i=n,s=n8(n,e);return t.add(async()=>{i.start(),await i.onIdle().then(()=>{n===i&&(n=null)})}),s},async writeLock(){return n=null,n8(t,e)}}},xle={name:"lock",concurrency:1/0,timeout:846e5,singleProcess:!1};function jS(r){const e=Object.assign({},xle,r);return Va==null&&(Va=Ele(e),Va.isWorker!==!0&&(Va.addEventListener("requestReadLock",t=>{el[t.data.name]!=null&&el[t.data.name].readLock().then(async n=>t.data.handler().finally(()=>{n()}))}),Va.addEventListener("requestWriteLock",async t=>{el[t.data.name]!=null&&el[t.data.name].writeLock().then(async n=>t.data.handler().finally(()=>{n()}))}))),el[e.name]==null&&(el[e.name]=Sle(e.name,e)),el[e.name]}class Ale{constructor(e,t,n={}){u(this,"lock");u(this,"child");u(this,"pins");u(this,"started");this.child=e,this.pins=t,this.lock=jS({singleProcess:n.holdGcLock}),this.started=!1}isStarted(){return this.started}async start(){await Vo(this.child),this.started=!0}async stop(){await Bc(this.child),this.started=!1}unwrap(){return this.child}async put(e,t,n={}){var s;(s=n==null?void 0:n.signal)==null||s.throwIfAborted();const i=await this.lock.readLock();try{return await this.child.put(e,t,n)}finally{i()}}async*putMany(e,t={}){var i;(i=t==null?void 0:t.signal)==null||i.throwIfAborted();const n=await this.lock.readLock();try{yield*this.child.putMany(e,t)}finally{n()}}async get(e,t={}){var i;(i=t==null?void 0:t.signal)==null||i.throwIfAborted();const n=await this.lock.readLock();try{return await this.child.get(e,t)}finally{n()}}async*getMany(e,t={}){var i;(i=t==null?void 0:t.signal)==null||i.throwIfAborted();const n=await this.lock.readLock();try{yield*this.child.getMany(e,t)}finally{n()}}async delete(e,t={}){var i;(i=t==null?void 0:t.signal)==null||i.throwIfAborted();const n=await this.lock.writeLock();try{if(await this.pins.isPinned(e))throw new Error("CID was pinned");await this.child.delete(e,t)}finally{n()}}async*deleteMany(e,t={}){var i;(i=t==null?void 0:t.signal)==null||i.throwIfAborted();const n=await this.lock.writeLock();try{const s=this;yield*this.child.deleteMany(async function*(){for await(const o of e){if(await s.pins.isPinned(o))throw new Error("CID was pinned");yield o}}(),t)}finally{n()}}async has(e,t={}){var i;(i=t==null?void 0:t.signal)==null||i.throwIfAborted();const n=await this.lock.readLock();try{return await this.child.has(e,t)}finally{n()}}async*getAll(e={}){var n;(n=e==null?void 0:e.signal)==null||n.throwIfAborted();const t=await this.lock.readLock();try{yield*this.child.getAll(e)}finally{t()}}createSession(e,t){var n;return(n=t==null?void 0:t.signal)==null||n.throwIfAborted(),this.child.createSession(e,t)}}const i8=new Et("/version"),e_=1;async function Cle(r){if(!await r.has(i8)){await r.put(i8,oe(`${e_}`));return}const e=await r.get(i8),t=re(e);if(parseInt(t,10)!==e_)throw new Error("Unknown datastore version, a datastore migration may be required")}class Ile extends Array{constructor(){super(),this.inRecursive=[]}prefix(e){const t=this.inRecursive[this.inRecursive.length-1];t&&(t.type===V.array&&(t.elements++,t.elements!==1&&e.push([44])),t.type===V.map&&(t.elements++,t.elements!==1&&(t.elements%2===1?e.push([44]):e.push([58]))))}[V.uint.major](e,t){this.prefix(e);const n=String(t.value),i=[];for(let s=0;s<n.length;s++)i[s]=n.charCodeAt(s);e.push(i)}[V.negint.major](e,t){this[V.uint.major](e,t)}[V.bytes.major](e,t){throw new Error(`${kl} unsupported type: Uint8Array`)}[V.string.major](e,t){this.prefix(e);const n=lL(JSON.stringify(t.value));e.push(n.length>32?IE(n):n)}[V.array.major](e,t){this.prefix(e),this.inRecursive.push({type:V.array,elements:0}),e.push([91])}[V.map.major](e,t){this.prefix(e),this.inRecursive.push({type:V.map,elements:0}),e.push([123])}[V.tag.major](e,t){}[V.float.major](e,t){if(t.type.name==="break"){const o=this.inRecursive.pop();if(o){if(o.type===V.array)e.push([93]);else if(o.type===V.map)e.push([125]);else throw new Error("Unexpected recursive type; this should not happen!");return}throw new Error("Unexpected break; this should not happen!")}if(t.value===void 0)throw new Error(`${kl} unsupported type: undefined`);if(this.prefix(e),t.type.name==="true"){e.push([116,114,117,101]);return}else if(t.type.name==="false"){e.push([102,97,108,115,101]);return}else if(t.type.name==="null"){e.push([110,117,108,108]);return}const n=String(t.value),i=[];let s=!1;for(let o=0;o<n.length;o++)i[o]=n.charCodeAt(o),!s&&(i[o]===46||i[o]===101||i[o]===69)&&(s=!0);s||(i.push(46),i.push(48)),e.push(i)}}function kle(r,e){if(Array.isArray(r[0])||Array.isArray(e[0]))throw new Error(`${kl} complex map keys are not supported`);const t=r[0],n=e[0];if(t.type!==V.string||n.type!==V.string)throw new Error(`${kl} non-string map keys are not supported`);if(t<n)return-1;if(t>n)return 1;throw new Error(`${kl} unexpected duplicate map keys, this is not supported`)}const _le={addBreakTokens:!0,mapSorter:kle};function Tle(r,e){return e=Object.assign({},_le,e),bL(r,new Ile,e)}class xF{constructor(e,t={}){this._pos=0,this.data=e,this.options=t,this.modeStack=["value"],this.lastToken=""}pos(){return this._pos}done(){return this._pos>=this.data.length}ch(){return this.data[this._pos]}currentMode(){return this.modeStack[this.modeStack.length-1]}skipWhitespace(){let e=this.ch();for(;e===32||e===9||e===13||e===10;)e=this.data[++this._pos]}expect(e){if(this.data.length-this._pos<e.length)throw new Error(`${ke} unexpected end of input at position ${this._pos}`);for(let t=0;t<e.length;t++)if(this.data[this._pos++]!==e[t])throw new Error(`${ke} unexpected token at position ${this._pos}, expected to find '${String.fromCharCode(...e)}'`)}parseNumber(){const e=this._pos;let t=!1,n=!1;const i=a=>{for(;!this.done();){const c=this.ch();if(a.includes(c))this._pos++;else break}};if(this.ch()===45&&(t=!0,this._pos++),this.ch()===48)if(this._pos++,this.ch()===46)this._pos++,n=!0;else return new ie(V.uint,0,this._pos-e);if(i([48,49,50,51,52,53,54,55,56,57]),t&&this._pos===e+1)throw new Error(`${ke} unexpected token at position ${this._pos}`);if(!this.done()&&this.ch()===46){if(n)throw new Error(`${ke} unexpected token at position ${this._pos}`);n=!0,this._pos++,i([48,49,50,51,52,53,54,55,56,57])}!this.done()&&(this.ch()===101||this.ch()===69)&&(n=!0,this._pos++,!this.done()&&(this.ch()===43||this.ch()===45)&&this._pos++,i([48,49,50,51,52,53,54,55,56,57]));const s=String.fromCharCode.apply(null,this.data.subarray(e,this._pos)),o=parseFloat(s);return n?new ie(V.float,o,this._pos-e):this.options.allowBigInt!==!0||Number.isSafeInteger(o)?new ie(o>=0?V.uint:V.negint,o,this._pos-e):new ie(o>=0?V.uint:V.negint,BigInt(s),this._pos-e)}parseString(){if(this.ch()!==34)throw new Error(`${ke} unexpected character at position ${this._pos}; this shouldn't happen`);this._pos++;for(let s=this._pos,o=0;s<this.data.length&&o<65536;s++,o++){const a=this.data[s];if(a===92||a<32||a>=128)break;if(a===34){const c=String.fromCharCode.apply(null,this.data.subarray(this._pos,s));return this._pos=s+1,new ie(V.string,c,o)}}const e=this._pos,t=[],n=()=>{if(this._pos+4>=this.data.length)throw new Error(`${ke} unexpected end of unicode escape sequence at position ${this._pos}`);let s=0;for(let o=0;o<4;o++){let a=this.ch();if(a>=48&&a<=57)a-=48;else if(a>=97&&a<=102)a=a-97+10;else if(a>=65&&a<=70)a=a-65+10;else throw new Error(`${ke} unexpected unicode escape character at position ${this._pos}`);s=s*16+a,this._pos++}return s},i=()=>{const s=this.ch();let o=null,a=s>239?4:s>223?3:s>191?2:1;if(this._pos+a>this.data.length)throw new Error(`${ke} unexpected unicode sequence at position ${this._pos}`);let c,l,d,h;switch(a){case 1:s<128&&(o=s);break;case 2:c=this.data[this._pos+1],(c&192)===128&&(h=(s&31)<<6|c&63,h>127&&(o=h));break;case 3:c=this.data[this._pos+1],l=this.data[this._pos+2],(c&192)===128&&(l&192)===128&&(h=(s&15)<<12|(c&63)<<6|l&63,h>2047&&(h<55296||h>57343)&&(o=h));break;case 4:c=this.data[this._pos+1],l=this.data[this._pos+2],d=this.data[this._pos+3],(c&192)===128&&(l&192)===128&&(d&192)===128&&(h=(s&15)<<18|(c&63)<<12|(l&63)<<6|d&63,h>65535&&h<1114112&&(o=h))}o===null?(o=65533,a=1):o>65535&&(o-=65536,t.push(o>>>10&1023|55296),o=56320|o&1023),t.push(o),this._pos+=a};for(;!this.done();){const s=this.ch();let o;switch(s){case 92:if(this._pos++,this.done())throw new Error(`${ke} unexpected string termination at position ${this._pos}`);switch(o=this.ch(),this._pos++,o){case 34:case 39:case 92:case 47:t.push(o);break;case 98:t.push(8);break;case 116:t.push(9);break;case 110:t.push(10);break;case 102:t.push(12);break;case 114:t.push(13);break;case 117:t.push(n());break;default:throw new Error(`${ke} unexpected string escape character at position ${this._pos}`)}break;case 34:return this._pos++,new ie(V.string,uL(t),this._pos-e);default:if(s<32)throw new Error(`${ke} invalid control character at position ${this._pos}`);s<128?(t.push(s),this._pos++):i()}}throw new Error(`${ke} unexpected end of string at position ${this._pos}`)}parseValue(){switch(this.ch()){case 123:return this.modeStack.push("obj-start"),this._pos++,new ie(V.map,1/0,1);case 91:return this.modeStack.push("array-start"),this._pos++,new ie(V.array,1/0,1);case 34:return this.parseString();case 110:return this.expect([110,117,108,108]),new ie(V.null,null,4);case 102:return this.expect([102,97,108,115,101]),new ie(V.false,!1,5);case 116:return this.expect([116,114,117,101]),new ie(V.true,!0,4);case 45:case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:return this.parseNumber();default:throw new Error(`${ke} unexpected character at position ${this._pos}`)}}next(){switch(this.skipWhitespace(),this.currentMode()){case"value":return this.modeStack.pop(),this.parseValue();case"array-value":{if(this.modeStack.pop(),this.ch()===93)return this._pos++,this.skipWhitespace(),new ie(V.break,void 0,1);if(this.ch()!==44)throw new Error(`${ke} unexpected character at position ${this._pos}, was expecting array delimiter but found '${String.fromCharCode(this.ch())}'`);return this._pos++,this.modeStack.push("array-value"),this.skipWhitespace(),this.parseValue()}case"array-start":return this.modeStack.pop(),this.ch()===93?(this._pos++,this.skipWhitespace(),new ie(V.break,void 0,1)):(this.modeStack.push("array-value"),this.skipWhitespace(),this.parseValue());case"obj-key":if(this.ch()===125)return this.modeStack.pop(),this._pos++,this.skipWhitespace(),new ie(V.break,void 0,1);if(this.ch()!==44)throw new Error(`${ke} unexpected character at position ${this._pos}, was expecting object delimiter but found '${String.fromCharCode(this.ch())}'`);this._pos++,this.skipWhitespace();case"obj-start":{if(this.modeStack.pop(),this.ch()===125)return this._pos++,this.skipWhitespace(),new ie(V.break,void 0,1);const e=this.parseString();if(this.skipWhitespace(),this.ch()!==58)throw new Error(`${ke} unexpected character at position ${this._pos}, was expecting key/value delimiter ':' but found '${String.fromCharCode(this.ch())}'`);return this._pos++,this.modeStack.push("obj-value"),e}case"obj-value":return this.modeStack.pop(),this.modeStack.push("obj-key"),this.skipWhitespace(),this.parseValue();default:throw new Error(`${ke} unexpected parse state at position ${this._pos}; this shouldn't happen`)}}}function Ple(r,e){return e=Object.assign({tokenizer:new xF(r,e)},e),za(r,e)}function Dle(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function HS(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function $le(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var i=0;i<r.length;i++){var s=r.charAt(i),o=s.charCodeAt(0);if(t[o]!==255)throw new TypeError(s+" is ambiguous");t[o]=i}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),d=Math.log(256)/Math.log(a);function h(f){if(f instanceof Uint8Array||(ArrayBuffer.isView(f)?f=new Uint8Array(f.buffer,f.byteOffset,f.byteLength):Array.isArray(f)&&(f=Uint8Array.from(f))),!(f instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(f.length===0)return"";for(var g=0,v=0,y=0,w=f.length;y!==w&&f[y]===0;)y++,g++;for(var b=(w-y)*d+1>>>0,E=new Uint8Array(b);y!==w;){for(var A=f[y],k=0,x=b-1;(A!==0||k<v)&&x!==-1;x--,k++)A+=256*E[x]>>>0,E[x]=A%a>>>0,A=A/a>>>0;if(A!==0)throw new Error("Non-zero carry");v=k,y++}for(var I=b-v;I!==b&&E[I]===0;)I++;for(var T=c.repeat(g);I<b;++I)T+=r.charAt(E[I]);return T}function p(f){if(typeof f!="string")throw new TypeError("Expected String");if(f.length===0)return new Uint8Array;var g=0;if(f[g]!==" "){for(var v=0,y=0;f[g]===c;)v++,g++;for(var w=(f.length-g)*l+1>>>0,b=new Uint8Array(w);f[g];){var E=t[f.charCodeAt(g)];if(E===255)return;for(var A=0,k=w-1;(E!==0||A<y)&&k!==-1;k--,A++)E+=a*b[k]>>>0,b[k]=E%256>>>0,E=E/256>>>0;if(E!==0)throw new Error("Non-zero carry");y=A,g++}if(f[g]!==" "){for(var x=w-y;x!==w&&b[x]===0;)x++;for(var I=new Uint8Array(v+(w-x)),T=v;x!==w;)I[T++]=b[x++];return I}}}function m(f){var g=p(f);if(g)return g;throw new Error(`Non-${e} character`)}return{encode:h,decodeUnsafe:p,decode:m}}var Nle=$le,Mle=Nle;let Ole=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseEncode");this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},Rle=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseDecode");u(this,"prefixCodePoint");this.name=e,this.prefix=t;const i=t.codePointAt(0);if(i===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=i,this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return AF(this,e)}},Lle=class{constructor(e){u(this,"decoders");this.decoders=e}or(e){return AF(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};function AF(r,e){return new Lle({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}let Ble=class{constructor(e,t,n,i){u(this,"name");u(this,"prefix");u(this,"baseEncode");u(this,"baseDecode");u(this,"encoder");u(this,"decoder");this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=i,this.encoder=new Ole(e,t,n),this.decoder=new Rle(e,t,i)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};function CF({name:r,prefix:e,encode:t,decode:n}){return new Ble(r,e,t,n)}function vw({name:r,prefix:e,alphabet:t}){const{encode:n,decode:i}=Mle(t,r);return CF({prefix:e,name:r,encode:n,decode:s=>HS(i(s))})}function Ule(r,e,t,n){const i={};for(let d=0;d<e.length;++d)i[e[d]]=d;let s=r.length;for(;r[s-1]==="=";)--s;const o=new Uint8Array(s*t/8|0);let a=0,c=0,l=0;for(let d=0;d<s;++d){const h=i[r[d]];if(h===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|h,a+=t,a>=8&&(a-=8,o[l++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o}function Fle(r,e,t){const n=e[e.length-1]==="=",i=(1<<t)-1;let s="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,s+=e[i&a>>o];if(o!==0&&(s+=e[i&a<<t-o]),n)for(;s.length*t&7;)s+="=";return s}function li({name:r,prefix:e,bitsPerChar:t,alphabet:n}){return CF({prefix:e,name:r,encode(i){return Fle(i,n,t)},decode(i){return Ule(i,n,t,r)}})}const Zg=li({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});li({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});li({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});li({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});li({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});li({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});li({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});li({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});li({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const s8=vw({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"});vw({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});const Da=vw({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});vw({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var zle=IF,t_=128,Vle=-128,Kle=Math.pow(2,31);function IF(r,e,t){e=e||[],t=t||0;for(var n=t;r>=Kle;)e[t++]=r&255|t_,r/=128;for(;r&Vle;)e[t++]=r&255|t_,r>>>=7;return e[t]=r|0,IF.bytes=t-n+1,e}var jle=Wb,Hle=128,r_=127;function Wb(r,n){var t=0,n=n||0,i=0,s=n,o,a=r.length;do{if(s>=a)throw Wb.bytes=0,new RangeError("Could not decode varint");o=r[s++],t+=i<28?(o&r_)<<i:(o&r_)*Math.pow(2,i),i+=7}while(o>=Hle);return Wb.bytes=s-n,t}var qle=Math.pow(2,7),Wle=Math.pow(2,14),Gle=Math.pow(2,21),Qle=Math.pow(2,28),Yle=Math.pow(2,35),Jle=Math.pow(2,42),Xle=Math.pow(2,49),Zle=Math.pow(2,56),eue=Math.pow(2,63),tue=function(r){return r<qle?1:r<Wle?2:r<Gle?3:r<Qle?4:r<Yle?5:r<Jle?6:r<Xle?7:r<Zle?8:r<eue?9:10},rue={encode:zle,decode:jle,encodingLength:tue},Ty=rue;function Gb(r,e=0){return[Ty.decode(r,e),Ty.decode.bytes]}function Py(r,e,t=0){return Ty.encode(r,e,t),e}function Dy(r){return Ty.encodingLength(r)}function nue(r,e){const t=e.byteLength,n=Dy(r),i=n+Dy(t),s=new Uint8Array(i+t);return Py(r,s,0),Py(t,s,n),s.set(e,i),new qS(r,t,e,s)}function iue(r){const e=HS(r),[t,n]=Gb(e),[i,s]=Gb(e.subarray(n)),o=e.subarray(n+s);if(o.byteLength!==i)throw new Error("Incorrect length");return new qS(t,i,o,e)}function sue(r,e){if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&Dle(r.bytes,t.bytes)}}let qS=class{constructor(e,t,n,i){u(this,"code");u(this,"size");u(this,"digest");u(this,"bytes");this.code=e,this.size=t,this.digest=n,this.bytes=i}};function n_(r,e){const{bytes:t,version:n}=r;switch(n){case 0:return aue(t,Qb(r),e??Da.encoder);default:return cue(t,Qb(r),e??Zg.encoder)}}const i_=new WeakMap;function Qb(r){const e=i_.get(r);if(e==null){const t=new Map;return i_.set(r,t),t}return e}var dN;let kF=class Fr{constructor(e,t,n,i){u(this,"code");u(this,"version");u(this,"multihash");u(this,"bytes");u(this,"/");u(this,dN,"CID");this.code=t,this.version=e,this.multihash=n,this.bytes=i,this["/"]=i}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==Cf)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==lue)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return Fr.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=nue(e,t);return Fr.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return Fr.equals(this,e)}static equals(e,t){const n=t;return n!=null&&e.code===n.code&&e.version===n.version&&sue(e.multihash,n.multihash)}toString(e){return n_(this,e)}toJSON(){return{"/":n_(this)}}link(){return this}[(dN=Symbol.toStringTag,Symbol.for("nodejs.util.inspect.custom"))](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof Fr)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:i,multihash:s,bytes:o}=t;return new Fr(n,i,s,o??s_(n,i,s.bytes))}else if(t[uue]===!0){const{version:n,multihash:i,code:s}=t,o=iue(i);return Fr.create(n,s,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==Cf)throw new Error(`Version 0 CID must use dag-pb (code: ${Cf}) block encoding`);return new Fr(e,t,n,n.bytes)}case 1:{const i=s_(e,t,n.bytes);return new Fr(e,t,n,i)}default:throw new Error("Invalid version")}}static createV0(e){return Fr.create(0,Cf,e)}static createV1(e,t){return Fr.create(1,e,t)}static decode(e){const[t,n]=Fr.decodeFirst(e);if(n.length!==0)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=Fr.inspectBytes(e),n=t.size-t.multihashSize,i=HS(e.subarray(n,n+t.multihashSize));if(i.byteLength!==t.multihashSize)throw new Error("Incorrect length");const s=i.subarray(t.multihashSize-t.digestSize),o=new qS(t.multihashCode,t.digestSize,s,i);return[t.version===0?Fr.createV0(o):Fr.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[h,p]=Gb(e.subarray(t));return t+=p,h};let i=n(),s=Cf;if(i===18?(i=0,t=0):s=n(),i!==0&&i!==1)throw new RangeError(`Invalid CID version ${i}`);const o=t,a=n(),c=n(),l=t+c,d=l-o;return{version:i,codec:s,multihashCode:a,digestSize:c,multihashSize:d,size:l}}static parse(e,t){const[n,i]=oue(e,t),s=Fr.decode(i);if(s.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return Qb(s).set(n,e),s}};function oue(r,e){switch(r[0]){case"Q":{const t=e??Da;return[Da.prefix,t.decode(`${Da.prefix}${r}`)]}case Da.prefix:{const t=e??Da;return[Da.prefix,t.decode(r)]}case Zg.prefix:{const t=e??Zg;return[Zg.prefix,t.decode(r)]}case s8.prefix:{const t=e??s8;return[s8.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}}function aue(r,e,t){const{prefix:n}=t;if(n!==Da.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const i=e.get(n);if(i==null){const s=t.encode(r).slice(1);return e.set(n,s),s}else return i}function cue(r,e,t){const{prefix:n}=t,i=e.get(n);if(i==null){const s=t.encode(r);return e.set(n,s),s}else return i}const Cf=112,lue=18;function s_(r,e,t){const n=Dy(r),i=n+Dy(e),s=new Uint8Array(i+t.byteLength);return Py(r,s,0),Py(e,s,n),s.set(t,i),s}const uue=Symbol.for("@ipld/js-cid/CID"),_F=li({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6});li({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6});li({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6});li({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});function due(r){return r instanceof ArrayBuffer?new Uint8Array(r,0,r.byteLength):r}function hue(r){if(r.asCID!==r&&r["/"]!==r.bytes)return null;const e=kF.asCID(r);if(!e)return null;const t=e.toString();return[new ie(V.map,1/0,1),new ie(V.string,"/",1),new ie(V.string,t,t.length),new ie(V.break,void 0,1)]}function $y(r){const e=_F.encode(r).slice(1);return[new ie(V.map,1/0,1),new ie(V.string,"/",1),new ie(V.map,1/0,1),new ie(V.string,"bytes",5),new ie(V.string,e,e.length),new ie(V.break,void 0,1),new ie(V.break,void 0,1)]}function Hi(r){return $y(new Uint8Array(r.buffer,r.byteOffset,r.byteLength))}function fue(r){return $y(new Uint8Array(r))}function pue(){throw new Error("`undefined` is not supported by the IPLD Data Model and cannot be encoded")}function gue(r){if(Number.isNaN(r))throw new Error("`NaN` is not supported by the IPLD Data Model and cannot be encoded");if(r===1/0||r===-1/0)throw new Error("`Infinity` and `-Infinity` is not supported by the IPLD Data Model and cannot be encoded");return null}const yue={typeEncoders:{Object:hue,Buffer:$y,Uint8Array:$y,Int8Array:Hi,Uint16Array:Hi,Int16Array:Hi,Uint32Array:Hi,Int32Array:Hi,Float32Array:Hi,Float64Array:Hi,Uint8ClampedArray:Hi,BigInt64Array:Hi,BigUint64Array:Hi,DataView:Hi,ArrayBuffer:fue,undefined:pue,number:gue}};class mue extends xF{constructor(e,t){super(e,t),this.tokenBuffer=[]}done(){return this.tokenBuffer.length===0&&super.done()}_next(){return this.tokenBuffer.length>0?this.tokenBuffer.pop():super.next()}next(){const e=this._next();if(e.type===V.map){const t=this._next();if(t.type===V.string&&t.value==="/"){const n=this._next();if(n.type===V.string){if(this._next().type!==V.break)throw new Error("Invalid encoded CID form");return this.tokenBuffer.push(n),new ie(V.tag,42,0)}if(n.type===V.map){const i=this._next();if(i.type===V.string&&i.value==="bytes"){const s=this._next();if(s.type===V.string){for(let a=0;a<2;a++)if(this._next().type!==V.break)throw new Error("Invalid encoded Bytes form");const o=_F.decode(`m${s.value}`);return new ie(V.bytes,o,s.value.length)}this.tokenBuffer.push(s)}this.tokenBuffer.push(i)}this.tokenBuffer.push(n)}this.tokenBuffer.push(t)}return e}}const Yb={allowIndefinite:!1,allowUndefined:!1,allowNaN:!1,allowInfinity:!1,allowBigInt:!0,strict:!0,useMaps:!1,rejectDuplicateMapKeys:!0,tags:[]};Yb.tags[42]=kF.parse;const wue="dag-json",TF=297,PF=r=>Tle(r,yue),DF=r=>{const e=due(r),t=Object.assign(Yb,{tokenizer:new mue(e,Yb)});return Ple(e,t)},o_=r=>bue.decode(PF(r)),bue=new TextDecoder,vue=r=>DF(Eue.encode(r)),Eue=new TextEncoder,Sue=Object.freeze(Object.defineProperty({__proto__:null,code:TF,decode:DF,encode:PF,format:o_,name:wue,parse:vue,stringify:o_},Symbol.toStringTag,{value:"Module"}));function xue(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function WS(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function Aue(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var i=0;i<r.length;i++){var s=r.charAt(i),o=s.charCodeAt(0);if(t[o]!==255)throw new TypeError(s+" is ambiguous");t[o]=i}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),d=Math.log(256)/Math.log(a);function h(f){if(f instanceof Uint8Array||(ArrayBuffer.isView(f)?f=new Uint8Array(f.buffer,f.byteOffset,f.byteLength):Array.isArray(f)&&(f=Uint8Array.from(f))),!(f instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(f.length===0)return"";for(var g=0,v=0,y=0,w=f.length;y!==w&&f[y]===0;)y++,g++;for(var b=(w-y)*d+1>>>0,E=new Uint8Array(b);y!==w;){for(var A=f[y],k=0,x=b-1;(A!==0||k<v)&&x!==-1;x--,k++)A+=256*E[x]>>>0,E[x]=A%a>>>0,A=A/a>>>0;if(A!==0)throw new Error("Non-zero carry");v=k,y++}for(var I=b-v;I!==b&&E[I]===0;)I++;for(var T=c.repeat(g);I<b;++I)T+=r.charAt(E[I]);return T}function p(f){if(typeof f!="string")throw new TypeError("Expected String");if(f.length===0)return new Uint8Array;var g=0;if(f[g]!==" "){for(var v=0,y=0;f[g]===c;)v++,g++;for(var w=(f.length-g)*l+1>>>0,b=new Uint8Array(w);f[g];){var E=t[f.charCodeAt(g)];if(E===255)return;for(var A=0,k=w-1;(E!==0||A<y)&&k!==-1;k--,A++)E+=a*b[k]>>>0,b[k]=E%256>>>0,E=E/256>>>0;if(E!==0)throw new Error("Non-zero carry");y=A,g++}if(f[g]!==" "){for(var x=w-y;x!==w&&b[x]===0;)x++;for(var I=new Uint8Array(v+(w-x)),T=v;x!==w;)I[T++]=b[x++];return I}}}function m(f){var g=p(f);if(g)return g;throw new Error(`Non-${e} character`)}return{encode:h,decodeUnsafe:p,decode:m}}var Cue=Aue,Iue=Cue;let kue=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseEncode");this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},_ue=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseDecode");u(this,"prefixCodePoint");this.name=e,this.prefix=t;const i=t.codePointAt(0);if(i===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=i,this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return $F(this,e)}},Tue=class{constructor(e){u(this,"decoders");this.decoders=e}or(e){return $F(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};function $F(r,e){return new Tue({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}let Pue=class{constructor(e,t,n,i){u(this,"name");u(this,"prefix");u(this,"baseEncode");u(this,"baseDecode");u(this,"encoder");u(this,"decoder");this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=i,this.encoder=new kue(e,t,n),this.decoder=new _ue(e,t,i)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};function NF({name:r,prefix:e,encode:t,decode:n}){return new Pue(r,e,t,n)}function Ew({name:r,prefix:e,alphabet:t}){const{encode:n,decode:i}=Iue(t,r);return NF({prefix:e,name:r,encode:n,decode:s=>WS(i(s))})}function Due(r,e,t,n){const i={};for(let d=0;d<e.length;++d)i[e[d]]=d;let s=r.length;for(;r[s-1]==="=";)--s;const o=new Uint8Array(s*t/8|0);let a=0,c=0,l=0;for(let d=0;d<s;++d){const h=i[r[d]];if(h===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|h,a+=t,a>=8&&(a-=8,o[l++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o}function $ue(r,e,t){const n=e[e.length-1]==="=",i=(1<<t)-1;let s="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,s+=e[i&a>>o];if(o!==0&&(s+=e[i&a<<t-o]),n)for(;s.length*t&7;)s+="=";return s}function Zo({name:r,prefix:e,bitsPerChar:t,alphabet:n}){return NF({prefix:e,name:r,encode(i){return $ue(i,n,t)},decode(i){return Due(i,n,t,r)}})}const e2=Zo({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});Zo({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});Zo({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});Zo({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});Zo({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});Zo({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});Zo({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});Zo({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});Zo({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const o8=Ew({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"});Ew({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});const $a=Ew({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});Ew({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var Nue=MF,a_=128,Mue=-128,Oue=Math.pow(2,31);function MF(r,e,t){e=e||[],t=t||0;for(var n=t;r>=Oue;)e[t++]=r&255|a_,r/=128;for(;r&Mue;)e[t++]=r&255|a_,r>>>=7;return e[t]=r|0,MF.bytes=t-n+1,e}var Rue=Jb,Lue=128,c_=127;function Jb(r,n){var t=0,n=n||0,i=0,s=n,o,a=r.length;do{if(s>=a)throw Jb.bytes=0,new RangeError("Could not decode varint");o=r[s++],t+=i<28?(o&c_)<<i:(o&c_)*Math.pow(2,i),i+=7}while(o>=Lue);return Jb.bytes=s-n,t}var Bue=Math.pow(2,7),Uue=Math.pow(2,14),Fue=Math.pow(2,21),zue=Math.pow(2,28),Vue=Math.pow(2,35),Kue=Math.pow(2,42),jue=Math.pow(2,49),Hue=Math.pow(2,56),que=Math.pow(2,63),Wue=function(r){return r<Bue?1:r<Uue?2:r<Fue?3:r<zue?4:r<Vue?5:r<Kue?6:r<jue?7:r<Hue?8:r<que?9:10},Gue={encode:Nue,decode:Rue,encodingLength:Wue},Ny=Gue;function Xb(r,e=0){return[Ny.decode(r,e),Ny.decode.bytes]}function My(r,e,t=0){return Ny.encode(r,e,t),e}function Oy(r){return Ny.encodingLength(r)}function Que(r,e){const t=e.byteLength,n=Oy(r),i=n+Oy(t),s=new Uint8Array(i+t);return My(r,s,0),My(t,s,n),s.set(e,i),new GS(r,t,e,s)}function Yue(r){const e=WS(r),[t,n]=Xb(e),[i,s]=Xb(e.subarray(n)),o=e.subarray(n+s);if(o.byteLength!==i)throw new Error("Incorrect length");return new GS(t,i,o,e)}function Jue(r,e){if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&xue(r.bytes,t.bytes)}}let GS=class{constructor(e,t,n,i){u(this,"code");u(this,"size");u(this,"digest");u(this,"bytes");this.code=e,this.size=t,this.digest=n,this.bytes=i}};function l_(r,e){const{bytes:t,version:n}=r;switch(n){case 0:return Zue(t,Zb(r),e??$a.encoder);default:return ede(t,Zb(r),e??e2.encoder)}}const u_=new WeakMap;function Zb(r){const e=u_.get(r);if(e==null){const t=new Map;return u_.set(r,t),t}return e}var hN;let jf=class zr{constructor(e,t,n,i){u(this,"code");u(this,"version");u(this,"multihash");u(this,"bytes");u(this,"/");u(this,hN,"CID");this.code=t,this.version=e,this.multihash=n,this.bytes=i,this["/"]=i}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==If)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==tde)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return zr.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=Que(e,t);return zr.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return zr.equals(this,e)}static equals(e,t){const n=t;return n!=null&&e.code===n.code&&e.version===n.version&&Jue(e.multihash,n.multihash)}toString(e){return l_(this,e)}toJSON(){return{"/":l_(this)}}link(){return this}[(hN=Symbol.toStringTag,Symbol.for("nodejs.util.inspect.custom"))](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof zr)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:i,multihash:s,bytes:o}=t;return new zr(n,i,s,o??d_(n,i,s.bytes))}else if(t[rde]===!0){const{version:n,multihash:i,code:s}=t,o=Yue(i);return zr.create(n,s,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==If)throw new Error(`Version 0 CID must use dag-pb (code: ${If}) block encoding`);return new zr(e,t,n,n.bytes)}case 1:{const i=d_(e,t,n.bytes);return new zr(e,t,n,i)}default:throw new Error("Invalid version")}}static createV0(e){return zr.create(0,If,e)}static createV1(e,t){return zr.create(1,e,t)}static decode(e){const[t,n]=zr.decodeFirst(e);if(n.length!==0)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=zr.inspectBytes(e),n=t.size-t.multihashSize,i=WS(e.subarray(n,n+t.multihashSize));if(i.byteLength!==t.multihashSize)throw new Error("Incorrect length");const s=i.subarray(t.multihashSize-t.digestSize),o=new GS(t.multihashCode,t.digestSize,s,i);return[t.version===0?zr.createV0(o):zr.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[h,p]=Xb(e.subarray(t));return t+=p,h};let i=n(),s=If;if(i===18?(i=0,t=0):s=n(),i!==0&&i!==1)throw new RangeError(`Invalid CID version ${i}`);const o=t,a=n(),c=n(),l=t+c,d=l-o;return{version:i,codec:s,multihashCode:a,digestSize:c,multihashSize:d,size:l}}static parse(e,t){const[n,i]=Xue(e,t),s=zr.decode(i);if(s.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return Zb(s).set(n,e),s}};function Xue(r,e){switch(r[0]){case"Q":{const t=e??$a;return[$a.prefix,t.decode(`${$a.prefix}${r}`)]}case $a.prefix:{const t=e??$a;return[$a.prefix,t.decode(r)]}case e2.prefix:{const t=e??e2;return[e2.prefix,t.decode(r)]}case o8.prefix:{const t=e??o8;return[o8.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}}function Zue(r,e,t){const{prefix:n}=t;if(n!==$a.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const i=e.get(n);if(i==null){const s=t.encode(r).slice(1);return e.set(n,s),s}else return i}function ede(r,e,t){const{prefix:n}=t,i=e.get(n);if(i==null){const s=t.encode(r);return e.set(n,s),s}else return i}const If=112,tde=18;function d_(r,e,t){const n=Oy(r),i=n+Oy(e),s=new Uint8Array(i+t.byteLength);return My(r,s,0),My(e,s,n),s.set(t,i),s}const rde=Symbol.for("@ipld/js-cid/CID"),nde=new TextDecoder;function QS(r,e){let t=0;for(let n=0;;n+=7){if(n>=64)throw new Error("protobuf: varint overflow");if(e>=r.length)throw new Error("protobuf: unexpected end of data");const i=r[e++];if(t+=n<28?(i&127)<<n:(i&127)*2**n,i<128)break}return[t,e]}function Ry(r,e){let t;[t,e]=QS(r,e);const n=e+t;if(t<0||n<0)throw new Error("protobuf: invalid length");if(n>r.length)throw new Error("protobuf: unexpected end of data");return[r.subarray(e,n),n]}function OF(r,e){let t;return[t,e]=QS(r,e),[t&7,t>>3,e]}function ide(r){const e={},t=r.length;let n=0;for(;n<t;){let i,s;if([i,s,n]=OF(r,n),s===1){if(e.Hash)throw new Error("protobuf: (PBLink) duplicate Hash section");if(i!==2)throw new Error(`protobuf: (PBLink) wrong wireType (${i}) for Hash`);if(e.Name!==void 0)throw new Error("protobuf: (PBLink) invalid order, found Name before Hash");if(e.Tsize!==void 0)throw new Error("protobuf: (PBLink) invalid order, found Tsize before Hash");[e.Hash,n]=Ry(r,n)}else if(s===2){if(e.Name!==void 0)throw new Error("protobuf: (PBLink) duplicate Name section");if(i!==2)throw new Error(`protobuf: (PBLink) wrong wireType (${i}) for Name`);if(e.Tsize!==void 0)throw new Error("protobuf: (PBLink) invalid order, found Tsize before Name");let o;[o,n]=Ry(r,n),e.Name=nde.decode(o)}else if(s===3){if(e.Tsize!==void 0)throw new Error("protobuf: (PBLink) duplicate Tsize section");if(i!==0)throw new Error(`protobuf: (PBLink) wrong wireType (${i}) for Tsize`);[e.Tsize,n]=QS(r,n)}else throw new Error(`protobuf: (PBLink) invalid fieldNumber, expected 1, 2 or 3, got ${s}`)}if(n>t)throw new Error("protobuf: (PBLink) unexpected end of data");return e}function sde(r){const e=r.length;let t=0,n,i=!1,s;for(;t<e;){let a,c;if([a,c,t]=OF(r,t),a!==2)throw new Error(`protobuf: (PBNode) invalid wireType, expected 2, got ${a}`);if(c===1){if(s)throw new Error("protobuf: (PBNode) duplicate Data section");[s,t]=Ry(r,t),n&&(i=!0)}else if(c===2){if(i)throw new Error("protobuf: (PBNode) duplicate Links section");n||(n=[]);let l;[l,t]=Ry(r,t),n.push(ide(l))}else throw new Error(`protobuf: (PBNode) invalid fieldNumber, expected 1 or 2, got ${c}`)}if(t>e)throw new Error("protobuf: (PBNode) unexpected end of data");const o={};return s&&(o.Data=s),o.Links=n||[],o}const RF=new TextEncoder,h_=2**32,ode=2**31;function ade(r,e){let t=e.length;if(typeof r.Tsize=="number"){if(r.Tsize<0)throw new Error("Tsize cannot be negative");if(!Number.isSafeInteger(r.Tsize))throw new Error("Tsize too large for encoding");t=a1(e,t,r.Tsize)-1,e[t]=24}if(typeof r.Name=="string"){const n=RF.encode(r.Name);t-=n.length,e.set(n,t),t=a1(e,t,n.length)-1,e[t]=18}return r.Hash&&(t-=r.Hash.length,e.set(r.Hash,t),t=a1(e,t,r.Hash.length)-1,e[t]=10),e.length-t}function cde(r){const e=ude(r),t=new Uint8Array(e);let n=e;if(r.Data&&(n-=r.Data.length,t.set(r.Data,n),n=a1(t,n,r.Data.length)-1,t[n]=10),r.Links)for(let i=r.Links.length-1;i>=0;i--){const s=ade(r.Links[i],t.subarray(0,n));n-=s,n=a1(t,n,s)-1,t[n]=18}return t}function lde(r){let e=0;if(r.Hash){const t=r.Hash.length;e+=1+t+Ed(t)}if(typeof r.Name=="string"){const t=RF.encode(r.Name).length;e+=1+t+Ed(t)}return typeof r.Tsize=="number"&&(e+=1+Ed(r.Tsize)),e}function ude(r){let e=0;if(r.Data){const t=r.Data.length;e+=1+t+Ed(t)}if(r.Links)for(const t of r.Links){const n=lde(t);e+=1+n+Ed(n)}return e}function a1(r,e,t){e-=Ed(t);const n=e;for(;t>=ode;)r[e++]=t&127|128,t/=128;for(;t>=128;)r[e++]=t&127|128,t>>>=7;return r[e]=t,n}function Ed(r){return r%2===0&&r++,Math.floor((dde(r)+6)/7)}function dde(r){let e=0;return r>=h_&&(r=Math.floor(r/h_),e=32),r>=65536&&(r>>>=16,e+=16),r>=256&&(r>>>=8,e+=8),e+hde[r]}const hde=[0,1,2,2,3,3,3,3,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8],fde=["Data","Links"],pde=["Hash","Name","Tsize"],ev=new TextEncoder;function LF(r,e){if(r===e)return 0;const t=r.Name?ev.encode(r.Name):[],n=e.Name?ev.encode(e.Name):[];let i=t.length,s=n.length;for(let o=0,a=Math.min(i,s);o<a;++o)if(t[o]!==n[o]){i=t[o],s=n[o];break}return i<s?-1:s<i?1:0}function f_(r,e){return!Object.keys(r).some(t=>!e.includes(t))}function BF(r){if(typeof r.asCID=="object"){const t=jf.asCID(r);if(!t)throw new TypeError("Invalid DAG-PB form");return{Hash:t}}if(typeof r!="object"||Array.isArray(r))throw new TypeError("Invalid DAG-PB form");const e={};if(r.Hash){let t=jf.asCID(r.Hash);try{t||(typeof r.Hash=="string"?t=jf.parse(r.Hash):r.Hash instanceof Uint8Array&&(t=jf.decode(r.Hash)))}catch(n){throw new TypeError(`Invalid DAG-PB form: ${n.message}`)}t&&(e.Hash=t)}if(!e.Hash)throw new TypeError("Invalid DAG-PB form");return typeof r.Name=="string"&&(e.Name=r.Name),typeof r.Tsize=="number"&&(e.Tsize=r.Tsize),e}function UF(r){if((r instanceof Uint8Array||typeof r=="string")&&(r={Data:r}),typeof r!="object"||Array.isArray(r))throw new TypeError("Invalid DAG-PB form");const e={};if(r.Data!==void 0)if(typeof r.Data=="string")e.Data=ev.encode(r.Data);else if(r.Data instanceof Uint8Array)e.Data=r.Data;else throw new TypeError("Invalid DAG-PB form");if(r.Links!==void 0)if(Array.isArray(r.Links))e.Links=r.Links.map(BF),e.Links.sort(LF);else throw new TypeError("Invalid DAG-PB form");else e.Links=[];return e}function FF(r){if(!r||typeof r!="object"||Array.isArray(r)||r instanceof Uint8Array||r["/"]&&r["/"]===r.bytes)throw new TypeError("Invalid DAG-PB form");if(!f_(r,fde))throw new TypeError("Invalid DAG-PB form (extraneous properties)");if(r.Data!==void 0&&!(r.Data instanceof Uint8Array))throw new TypeError("Invalid DAG-PB form (Data must be bytes)");if(!Array.isArray(r.Links))throw new TypeError("Invalid DAG-PB form (Links must be a list)");for(let e=0;e<r.Links.length;e++){const t=r.Links[e];if(!t||typeof t!="object"||Array.isArray(t)||t instanceof Uint8Array||t["/"]&&t["/"]===t.bytes)throw new TypeError("Invalid DAG-PB form (bad link)");if(!f_(t,pde))throw new TypeError("Invalid DAG-PB form (extraneous properties on link)");if(t.Hash===void 0)throw new TypeError("Invalid DAG-PB form (link must have a Hash)");if(t.Hash==null||!t.Hash["/"]||t.Hash["/"]!==t.Hash.bytes)throw new TypeError("Invalid DAG-PB form (link Hash must be a CID)");if(t.Name!==void 0&&typeof t.Name!="string")throw new TypeError("Invalid DAG-PB form (link Name must be a string)");if(t.Tsize!==void 0){if(typeof t.Tsize!="number"||t.Tsize%1!==0)throw new TypeError("Invalid DAG-PB form (link Tsize must be an integer)");if(t.Tsize<0)throw new TypeError("Invalid DAG-PB form (link Tsize cannot be negative)")}if(e>0&&LF(t,r.Links[e-1])===-1)throw new TypeError("Invalid DAG-PB form (links must be sorted by Name bytes)")}}function gde(r,e=[]){return UF({Data:r,Links:e})}function yde(r,e,t){return BF({Hash:t,Name:r,Tsize:e})}function mde(r){return r instanceof ArrayBuffer?new Uint8Array(r,0,r.byteLength):r}const wde="dag-pb",zF=112;function bde(r){FF(r);const e={};return r.Links&&(e.Links=r.Links.map(t=>{const n={};return t.Hash&&(n.Hash=t.Hash.bytes),t.Name!==void 0&&(n.Name=t.Name),t.Tsize!==void 0&&(n.Tsize=t.Tsize),n})),r.Data&&(e.Data=r.Data),cde(e)}function vde(r){const e=mde(r),t=sde(e),n={};return t.Data&&(n.Data=t.Data),t.Links&&(n.Links=t.Links.map(i=>{const s={};try{s.Hash=jf.decode(i.Hash)}catch{}if(!s.Hash)throw new Error("Invalid Hash field found in link, expected CID");return i.Name!==void 0&&(s.Name=i.Name),i.Tsize!==void 0&&(s.Tsize=i.Tsize),s})),n}const Ede=Object.freeze(Object.defineProperty({__proto__:null,code:zF,createLink:yde,createNode:gde,decode:vde,encode:bde,name:wde,prepare:UF,validate:FF},Symbol.toStringTag,{value:"Module"})),Sde=new TextEncoder,xde=new TextDecoder,Ade="json",VF=512;function Cde(r){return Sde.encode(JSON.stringify(r))}function Ide(r){return JSON.parse(xde.decode(r))}const kde=Object.freeze(Object.defineProperty({__proto__:null,code:VF,decode:Ide,encode:Cde,name:Ade},Symbol.toStringTag,{value:"Module"})),_de="raw",KF=85;function Tde(r){return Lh(r)}function Pde(r){return Lh(r)}const Dde=Object.freeze(Object.defineProperty({__proto__:null,code:KF,decode:Pde,encode:Tde,name:_de},Symbol.toStringTag,{value:"Module"}));function YS(r){return(r==null?void 0:r.then)!=null}function $de(r=[],e){const t={[zF]:Ede,[KF]:Dde,[IL]:Np,[TF]:Sue,[VF]:kde};return r.forEach(n=>{t[n.code]=n}),async n=>{let i=t[n];if(i==null&&e!=null){const s=e(n);YS(s)?i=await s:i=s,t[i.code]=i}if(i!=null)return i;throw new SF(`Could not load codec for ${n}`)}}const jF=0,Nde="identity",HF=Lh;function Mde(r){return _y(jF,HF(r))}const p_={code:jF,name:Nde,encode:HF,digest:Mde};function qF(r){return async e=>new Uint8Array(await crypto.subtle.digest(r,e))}const g_=wF({name:"sha2-256",code:18,encode:qF("SHA-256")}),y_=wF({name:"sha2-512",code:19,encode:qF("SHA-512")});function Ode(r=[],e){const t={[g_.code]:g_,[y_.code]:y_,[p_.code]:p_};return r.forEach(n=>{t[n.code]=n}),async n=>{let i=t[n];if(i==null&&e!=null){const s=e(n);YS(s)?i=await s:i=s,t[i.code]=i}if(i!=null)return i;throw new EF(`No hasher configured for multihash code 0x${n.toString(16)}, please configure one. You can look up which hash this is at https://github.com/multiformats/multicodec/blob/master/table.csv`)}}const od=class od extends Error{constructor(t="Not Found"){super(t);u(this,"name",od.name);u(this,"code",od.code)}};u(od,"name","NotFoundError"),u(od,"code","ERR_NOT_FOUND");let J1=od;class WF{has(e,t){return Promise.reject(new Error(".has is not implemented"))}put(e,t,n){return Promise.reject(new Error(".put is not implemented"))}async*putMany(e,t){for await(const{cid:n,block:i}of e)await this.put(n,i,t),yield n}get(e,t){return Promise.reject(new Error(".get is not implemented"))}async*getMany(e,t){for await(const n of e)yield{cid:n,block:await this.get(n,t)}}delete(e,t){return Promise.reject(new Error(".delete is not implemented"))}async*deleteMany(e,t){for await(const n of e)await this.delete(n,t),yield n}async*getAll(e){throw new Error(".getAll is not implemented")}}const ig=0;class Rde extends WF{constructor(t){super();u(this,"child");this.child=t}put(t,n){return t.multihash.code===ig||this.child==null?t:this.child.put(t,n)}get(t){if(t.multihash.code===ig)return t.multihash.digest;if(this.child==null)throw new J1;return this.child.get(t)}has(t){return t.multihash.code===ig?!0:this.child==null?!1:this.child.has(t)}delete(t){if(t.code!==ig&&this.child!=null)return this.child.delete(t)}getAll(t){return this.child!=null?this.child.getAll(t):[]}}function Lde(r){return r[Symbol.asyncIterator]!=null}function sl(r,e){let t=0;if(Lde(r))return async function*(){for await(const c of r)await e(c,t++)&&(yield c)}();const n=NS(r),{value:i,done:s}=n.next();if(s===!0)return function*(){}();const o=e(i,t++);if(typeof o.then=="function")return async function*(){await o&&(yield i);for await(const c of n)await e(c,t++)&&(yield c)}();const a=e;return function*(){o===!0&&(yield i);for(const c of n)a(c,t++)&&(yield c)}()}function Bde(r){return r[Symbol.asyncIterator]!=null}function m_(r){return(r==null?void 0:r.then)!=null}function Ly(r,e){let t=0;if(Bde(r))return async function*(){for await(const c of r){const l=e(c,t++);m_(l)&&await l,yield c}}();const n=NS(r),{value:i,done:s}=n.next();if(s===!0)return function*(){}();const o=e(i,t++);if(typeof(o==null?void 0:o.then)=="function")return async function*(){yield i;for await(const c of n){const l=e(c,t++);m_(l)&&await l,yield c}}();const a=e;return function*(){yield i;for(const c of n)a(c,t++),yield c}()}class GF{constructor(e){u(this,"child");u(this,"getHasher");u(this,"log");u(this,"logger");u(this,"components");this.log=e.logger.forComponent("helia:networked-storage"),this.logger=e.logger,this.components=e,this.child=new Rde(e.blockstore),this.getHasher=e.getHasher}async put(e,t,n={}){var i,s,o;return await this.child.has(e,n)?((i=n.onProgress)==null||i.call(n,new _e("blocks:put:duplicate",e)),e):((s=n.onProgress)==null||s.call(n,new _e("blocks:put:providers:notify",e)),await Promise.all(this.components.blockBrokers.map(async a=>{var c;return(c=a.announce)==null?void 0:c.call(a,e,t,n)})),(o=n.onProgress)==null||o.call(n,new _e("blocks:put:blockstore:put",e)),this.child.put(e,t,n))}async*putMany(e,t={}){var s;const n=sl(e,async({cid:o})=>{var c;const a=await this.child.has(o,t);return a&&((c=t.onProgress)==null||c.call(t,new _e("blocks:put-many:duplicate",o))),!a}),i=Ly(n,async({cid:o,block:a})=>{var c;(c=t.onProgress)==null||c.call(t,new _e("blocks:put-many:providers:notify",o)),await Promise.all(this.components.blockBrokers.map(async l=>{var d;return(d=l.announce)==null?void 0:d.call(l,o,a,t)}))});(s=t.onProgress)==null||s.call(t,new _e("blocks:put-many:blockstore:put-many")),yield*this.child.putMany(i,t)}async get(e,t={}){var n,i,s,o;if(t.offline!==!0&&!await this.child.has(e,t)){const a=await this.getHasher(e.multihash.code);(n=t.onProgress)==null||n.call(t,new _e("blocks:get:providers:get",e));const c=await w_(e,this.components.blockBrokers,a,{...t,log:this.log});return(i=t.onProgress)==null||i.call(t,new _e("blocks:get:blockstore:put",e)),await this.child.put(e,c,t),(s=t.onProgress)==null||s.call(t,new _e("blocks:get:providers:notify",e)),await Promise.all(this.components.blockBrokers.map(async l=>{var d;return(d=l.announce)==null?void 0:d.call(l,e,c,t)})),c}return(o=t.onProgress)==null||o.call(t,new _e("blocks:get:blockstore:get",e)),this.child.get(e,t)}async*getMany(e,t={}){var n;(n=t.onProgress)==null||n.call(t,new _e("blocks:get-many:blockstore:get-many")),yield*this.child.getMany(Ly(e,async i=>{var s,o,a;if(t.offline!==!0&&!await this.child.has(i,t)){const c=await this.getHasher(i.multihash.code);(s=t.onProgress)==null||s.call(t,new _e("blocks:get-many:providers:get",i));const l=await w_(i,this.components.blockBrokers,c,{...t,log:this.log});(o=t.onProgress)==null||o.call(t,new _e("blocks:get-many:blockstore:put",i)),await this.child.put(i,l,t),(a=t.onProgress)==null||a.call(t,new _e("blocks:get-many:providers:notify",i)),await Promise.all(this.components.blockBrokers.map(async d=>{var h;return(h=d.announce)==null?void 0:h.call(d,i,l,t)}))}}))}async delete(e,t={}){var n;(n=t.onProgress)==null||n.call(t,new _e("blocks:delete:blockstore:delete",e)),await this.child.delete(e,t)}async*deleteMany(e,t={}){var n;(n=t.onProgress)==null||n.call(t,new _e("blocks:delete-many:blockstore:delete-many")),yield*this.child.deleteMany(async function*(){for await(const i of e)yield i}(),t)}async has(e,t={}){return this.child.has(e,t)}async*getAll(e={}){var t;(t=e.onProgress)==null||t.call(e,new _e("blocks:get-all:blockstore:get-many")),yield*this.child.getAll(e)}}class Ude extends GF{constructor(t){super(t);u(this,"started");this.started=!1}isStarted(){return this.started}async start(){await Vo(this.child,...this.components.blockBrokers),this.started=!0}async stop(){await Bc(this.child,...this.components.blockBrokers),this.started=!1}unwrap(){return this.child}createSession(t,n){const i=this.components.blockBrokers.map(s=>s.createSession==null?s:s.createSession(n));return new Fde({blockstore:this.child,blockBrokers:i,getHasher:this.getHasher,logger:this.logger},{root:t})}}class Fde extends GF{constructor(t,n){super(t);u(this,"closeController");this.closeController=new AbortController,this.closeController.signal,this.log=t.logger.forComponent(`helia:session-storage:${n.root}`)}close(){this.closeController.abort()}async put(t,n,i={}){const s=dt([this.closeController.signal,i.signal]);try{return await super.put(t,n,{...i,signal:s})}finally{s.clear()}}async*putMany(t,n={}){const i=dt([this.closeController.signal,n.signal]);try{yield*super.putMany(t,{...n,signal:i})}finally{i.clear()}}async get(t,n={}){const i=dt([this.closeController.signal,n.signal]);try{return await super.get(t,{...n,signal:i})}finally{i.clear()}}async*getMany(t,n={}){const i=dt([this.closeController.signal,n.signal]);try{yield*super.getMany(t,{...n,signal:i})}finally{i.clear()}}async delete(t,n={}){const i=dt([this.closeController.signal,n.signal]);try{await super.delete(t,{...n,signal:i})}finally{i.clear()}}async*deleteMany(t,n={}){const i=dt([this.closeController.signal,n.signal]);try{yield*super.deleteMany(t,{...n,signal:i})}finally{i.clear()}}async has(t,n={}){const i=dt([this.closeController.signal,n.signal]);try{return await super.has(t,{...n,signal:i})}finally{i.clear()}}async*getAll(t={}){const n=dt([this.closeController.signal,t.signal]);try{yield*super.getAll({...t,signal:n})}finally{n.clear()}}}function zde(r){return typeof r.retrieve=="function"}const Vde=(r,e)=>{if(e==null)throw new Z(`No hasher configured for multihash code 0x${r.multihash.code.toString(16)}, please configure one. You can look up which hash this is at https://github.com/multiformats/multicodec/blob/master/table.csv`);return async t=>{let n;const i=e.digest(t);if(YS(i)?n=await i:n=i,!He(n.digest,r.multihash.digest))throw new ew("Hash of downloaded block did not match multihash from passed CID")}};async function w_(r,e,t,n){const i=Vde(r,t),s=new AbortController,o=dt([s.signal,n.signal]);s.signal;const a=[];for(const c of e)zde(c)&&a.push(c);try{return await Promise.any(a.map(async c=>{try{let l=!1;const d=await c.retrieve(r,{...n,signal:o,validateFn:async h=>{await i(h),l=!0}});return l||await i(d),d}catch(l){throw n.log.error("could not retrieve verified block for %c",r,l),l}}))}finally{s.abort(),o.clear()}}const Kde=ci({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6});ci({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6});ci({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6});ci({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});class QF extends er{constructor(t,n){super();u(this,"initialPeerSearchComplete");u(this,"requests");u(this,"name");u(this,"log");u(this,"logger");u(this,"minProviders");u(this,"maxProviders");u(this,"providers");u(this,"evictionFilter");this.name=n.name,this.logger=t.logger,this.log=t.logger.forComponent(this.name),this.requests=new Map,this.minProviders=n.minProviders??gle,this.maxProviders=n.maxProviders??yle,this.providers=[],this.evictionFilter=Ql(this.maxProviders)}async retrieve(t,n={}){const i=Kde.encode(t.multihash.bytes),s=this.requests.get(i);if(s!=null)return this.log("join existing request for %c",t),s;const o=Le();if(this.requests.set(i,o.promise),this.providers.length===0){let d=!1;this.initialPeerSearchComplete==null&&(d=!0,this.log=this.logger.forComponent(`${this.name}:${t}`),this.initialPeerSearchComplete=this.findProviders(t,this.minProviders,n)),await this.initialPeerSearchComplete,d&&this.log("found initial session peers for %c",t)}let a=!1;const c=new Gl({concurrency:this.maxProviders});c.addEventListener("error",()=>{}),c.addEventListener("failure",d=>{this.log.error("error querying provider %o, evicting from session",d.detail.job.options.provider,d.detail.error),this.evict(d.detail.job.options.provider)}),c.addEventListener("success",d=>{a=!0,o.resolve(d.detail.result)}),c.addEventListener("idle",()=>{var d;a||((d=n.signal)==null?void 0:d.aborted)===!0||Promise.resolve().then(async()=>{this.log("no session peers had block for for %c, finding new providers",t);for(let h=0;h<this.minProviders&&this.providers.length!==0;h++){const p=this.providers[Math.floor(Math.random()*this.providers.length)];this.evict(p)}await this.findProviders(t,this.minProviders,n),this.log("found new providers re-retrieving %c",t),this.requests.delete(i),o.resolve(await this.retrieve(t,n))}).catch(h=>{this.log.error("could not find new providers for %c",t,h),o.reject(h)})});const l=d=>{c.add(async()=>this.queryProvider(t,d.detail,n),{provider:d.detail}).catch(h=>{var p;((p=n.signal)==null?void 0:p.aborted)!==!0&&this.log.error("error retrieving session block for %c",t,h)})};this.addEventListener("provider",l),Promise.all([...this.providers].map(async d=>c.add(async()=>this.queryProvider(t,d,n),{provider:d}))).catch(d=>{var h;((h=n.signal)==null?void 0:h.aborted)!==!0&&this.log.error("error retrieving session block for %c",t,d)});try{return await o.promise}finally{this.removeEventListener("provider",l),c.clear(),this.requests.delete(i)}}evict(t){this.evictionFilter.add(this.toEvictionKey(t));const n=this.providers.findIndex(i=>this.equals(i,t));n!==-1&&this.providers.splice(n,1)}isEvicted(t){return this.evictionFilter.has(this.toEvictionKey(t))}hasProvider(t){return!!(this.providers.find(n=>this.equals(n,t))!=null||this.isEvicted(t))}async findProviders(t,n,i){const s=Le();let o=0;return Promise.resolve().then(async()=>{var a;this.log("finding %d-%d new provider(s) for %c",n,this.maxProviders,t);for await(const c of this.findNewProviders(t,i)){if(o===this.maxProviders||((a=i.signal)==null?void 0:a.aborted)===!0)break;if(!this.hasProvider(c)&&(this.log("found %d/%d new providers",o,this.maxProviders),this.providers.push(c),this.safeDispatchEvent("provider",{detail:c}),o++,o===n&&(this.log("session is ready"),s.resolve()),this.providers.length===this.maxProviders)){this.log("found max session peers",o);break}}if(this.log("found %d/%d new session peers",o,this.maxProviders),o<n)throw new vF(`Found ${o} of ${n} ${this.name} providers for ${t}`)}).catch(a=>{this.log.error("error searching routing for potential session peers for %c",t,a.errors??a),s.reject(a)}),s.promise}}class jde{constructor(e){u(this,"blockstore");u(this,"datastore");u(this,"pins");u(this,"logger");u(this,"routing");u(this,"getCodec");u(this,"getHasher");u(this,"dns");u(this,"metrics");u(this,"log");this.logger=e.logger??ww(),this.log=this.logger.forComponent("helia"),this.getHasher=Ode(e.hashers,e.loadHasher),this.getCodec=$de(e.codecs,e.loadCodec),this.dns=e.dns??fF(),this.metrics=e.metrics;const t={blockstore:e.blockstore,datastore:e.datastore,logger:this.logger,blockBrokers:[],getHasher:this.getHasher,getCodec:this.getCodec,dns:this.dns,metrics:this.metrics,...e.components??{}};this.routing=t.routing=new wle(t,{routers:(e.routers??[]).flatMap(i=>{const s=[i];return i[jd]!=null&&s.push(i[jd]),i[Hd]!=null&&s.push(i[Hd]),s}),providerLookupConcurrency:e.providerLookupConcurrency});const n=new Ude(t);this.pins=new ple(e.datastore,n,this.getCodec),this.blockstore=new Ale(n,this.pins,{holdGcLock:e.holdGcLock??!0}),this.datastore=e.datastore,t.blockBrokers=e.blockBrokers.map(i=>i(t))}async start(){await Cle(this.datastore),await Vo(this.blockstore,this.datastore,this.routing)}async stop(){await Bc(this.blockstore,this.datastore,this.routing)}async gc(e={}){const t=await this.blockstore.lock.writeLock();try{const n=this,i=this.blockstore.unwrap();this.log("gc start"),await zo(i.deleteMany(async function*(){var s,o;for await(const{cid:a}of i.getAll())try{if(await n.pins.isPinned(a,e))continue;yield a,(s=e.onProgress)==null||s.call(e,new _e("helia:gc:deleted",a))}catch(c){n.log.error("Error during gc",c),(o=e.onProgress)==null||o.call(e,new _e("helia:gc:error",c))}}()))}finally{t()}this.log("gc finished")}}class Hde extends QF{constructor(t,n){super(t,{...n,name:"helia:bitswap:session"});u(this,"wantList");u(this,"network");this.wantList=t.wantList,this.network=t.network}async queryProvider(t,n,i){this.log("sending WANT-BLOCK for %c to %p",t,n);const s=await this.wantList.wantSessionBlock(t,n,i);if(this.log("%p %s %c",n,s.has?"has":"does not have",t),s.has&&s.block!=null)return s.block;throw new Error("Provider did not have block")}async*findNewProviders(t,n={}){for await(const i of this.network.findProviders(t,n))yield i.id}toEvictionKey(t){return t.toMultihash().bytes}equals(t,n){return t.equals(n)}}function qde(r,e){return new Hde(r,e)}class Wde{constructor(e){u(this,"blocksReceived");u(this,"duplicateBlocksReceived");u(this,"dataReceived");u(this,"duplicateDataReceived");var t,n,i,s;this.blocksReceived=(t=e.metrics)==null?void 0:t.registerMetricGroup("helia_bitswap_received_blocks"),this.duplicateBlocksReceived=(n=e.metrics)==null?void 0:n.registerMetricGroup("helia_bitswap_duplicate_received_blocks"),this.dataReceived=(i=e.metrics)==null?void 0:i.registerMetricGroup("helia_bitswap_data_received_bytes"),this.duplicateDataReceived=(s=e.metrics)==null?void 0:s.registerMetricGroup("helia_bitswap_duplicate_data_received_bytes")}updateBlocksReceived(e=1,t){var i;const n={global:e};t!=null&&(n[t.toString()]=e),(i=this.blocksReceived)==null||i.increment(n)}updateDuplicateBlocksReceived(e=1,t){var i;const n={global:e};t!=null&&(n[t.toString()]=e),(i=this.duplicateBlocksReceived)==null||i.increment(n)}updateDataReceived(e,t){var i;const n={global:e};t!=null&&(n[t.toString()]=e),(i=this.dataReceived)==null||i.increment(n)}updateDuplicateDataReceived(e,t){var i;const n={global:e};t!=null&&(n[t.toString()]=e),(i=this.duplicateDataReceived)==null||i.increment(n)}}class Gde extends Map{constructor(t){super();u(this,"metric");const{name:n,metrics:i}=t;this.metric=i.registerMetric(n),this.updateComponentMetric()}set(t,n){return super.set(t,n),this.updateComponentMetric(),this}delete(t){const n=super.delete(t);return this.updateComponentMetric(),n}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}}function YF(r){const{name:e,metrics:t}=r;let n;return t!=null?n=new Gde({name:e,metrics:t}):n=new Map,n}function Qde({name:r,code:e,encode:t}){return new Yde(r,e,t)}let Yde=class{constructor(e,t,n){u(this,"name");u(this,"code");u(this,"encode");this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?Lb(this.code,t):t.then(n=>Lb(this.code,n))}else throw Error("Unknown type, must be binary type")}};function Jde(r){return async e=>new Uint8Array(await crypto.subtle.digest(r,e))}const b_=Qde({name:"sha2-256",code:18,encode:Jde("SHA-256")});function Xde(r){if(!(r instanceof Uint8Array))throw new Error("arg needs to be a Uint8Array");const e=[];for(;r.length>0;){const t=gs(r);e.push(t),r=r.slice(gt(t))}return e}class Zde extends er{constructor(t,n={}){super();u(this,"peers");u(this,"wants");u(this,"network");u(this,"log");u(this,"sendMessagesDelay");u(this,"sendMessagesTimeout");u(this,"hashLoader");u(this,"sendingMessages");this.peers=rF({name:"helia_bitswap_peers",metrics:t.metrics}),this.wants=YF({name:"helia_bitswap_wantlist",metrics:t.metrics}),this.network=t.network,this.sendMessagesDelay=n.sendMessagesDelay??hse,this.log=t.logger.forComponent("helia:bitswap:wantlist"),this.hashLoader=n.hashLoader,this.network.addEventListener("bitswap:message",i=>{this.receiveMessage(i.detail.peer,i.detail.message).catch(s=>{this.log.error("error receiving bitswap message from %p",i.detail.peer,s)})}),this.network.addEventListener("peer:connected",i=>{this.peerConnected(i.detail).catch(s=>{this.log.error("error processing newly connected bitswap peer %p",i.detail,s)})}),this.network.addEventListener("peer:disconnected",i=>{this.peerDisconnected(i.detail)})}async addEntry(t,n){var o;const i=re(t.multihash.bytes,"base64");let s=this.wants.get(i);s==null&&(s={cid:t,priority:n.priority??1,wantType:n.wantType??cr.WantBlock,cancel:!1,sendDontHave:!0},this.wants.set(i,s)),s.wantType===cr.WantHave&&n.wantType===cr.WantBlock&&(s.wantType=cr.WantBlock),await this.sendMessagesDebounced();try{return n.wantType===cr.WantBlock?(await Ci(this,"block",n==null?void 0:n.signal,{filter:l=>He(t.multihash.digest,l.detail.cid.multihash.digest),errorMessage:"Want was aborted"})).detail:(await Ci(this,"presence",n==null?void 0:n.signal,{filter:c=>He(t.multihash.digest,c.detail.cid.multihash.digest),errorMessage:"Want was aborted"})).detail}finally{((o=n.signal)==null?void 0:o.aborted)===!0&&(this.log("want for %c was aborted, cancelling want",t),s.cancel=!0,await this.sendMessagesDebounced())}}async sendMessagesDebounced(){var t;await((t=this.sendingMessages)==null?void 0:t.promise),clearTimeout(this.sendMessagesTimeout),this.sendMessagesTimeout=setTimeout(()=>{this.sendMessages().catch(n=>{this.log("error sending messages to peers",n)})},this.sendMessagesDelay)}async sendMessages(){this.sendingMessages=Le(),await Promise.all([...this.peers.entries()].map(async([t,n])=>{const i=new Set,s=new Vf;for(const[o,a]of this.wants.entries())n.has(o)||a.cancel||(i.add(o),s.addWantlistEntry(a.cid,{cid:a.cid.bytes,priority:a.priority,wantType:a.wantType,cancel:a.cancel,sendDontHave:a.sendDontHave}));if(s.wantlist.size!==0)try{await this.network.sendMessage(t,s);for(const o of i)n.add(o)}catch(o){this.log.error("error sending full wantlist to new peer",o)}})).catch(t=>{this.log.error("error sending messages",t)});for(const[t,n]of this.wants)if(n.cancel){this.wants.delete(t);for(const i of this.peers.values())i.delete(t)}this.sendingMessages.resolve()}has(t){const n=re(t.multihash.bytes,"base64");return this.wants.has(n)}async wantSessionPresence(t,n,i={}){const s=new Vf;return s.addWantlistEntry(t,{cid:t.bytes,sendDontHave:!0,wantType:cr.WantHave,priority:1}),await this.network.sendMessage(n,s),(await Ci(this,"presence",i.signal,{filter:a=>n.equals(a.detail.sender)&&He(t.multihash.digest,a.detail.cid.multihash.digest)})).detail}async wantBlock(t,n={}){return this.addEntry(t,{...n,wantType:cr.WantBlock})}async wantSessionBlock(t,n,i={}){const s=new Vf;return s.addWantlistEntry(t,{cid:t.bytes,sendDontHave:!0,wantType:cr.WantBlock,priority:1}),await this.network.sendMessage(n,s),(await Ci(this,"presence",i.signal,{filter:a=>n.equals(a.detail.sender)&&He(t.multihash.digest,a.detail.cid.multihash.digest)})).detail}async receivedBlock(t,n){const i=re(t.multihash.bytes,"base64"),s=this.wants.get(i);s!=null&&(s.cancel=!0,await this.sendMessagesDebounced())}async receiveMessage(t,n){var s;this.log("received message from %p with %d blocks",t,n.blocks.length);let i=!1;for(const o of n.blocks){if(o.prefix==null||o.data==null)continue;const a=Xde(o.prefix),c=a[0],l=a[1],d=a[2],h=d===b_.code?b_:await((s=this.hashLoader)==null?void 0:s.getHasher(d));if(h==null){this.log.error("unknown hash algorithm",d);continue}let p=h.digest(o.data);p.then!=null&&(p=await p);const m=Ub.create(c===0?0:1,l,p);this.log("received block from %p for %c",t,m),this.safeDispatchEvent("block",{detail:{sender:t,cid:m,block:o.data}}),this.safeDispatchEvent("presence",{detail:{sender:t,cid:m,has:!0,block:o.data}});const f=re(m.multihash.bytes,"base64"),g=this.wants.get(f);g!=null&&(g.cancel=!0,i=!0)}for(const{cid:o,type:a}of n.blockPresences){const c=Ub.decode(o);this.log("received %s from %p for %c",a,t,c),this.safeDispatchEvent("presence",{detail:{sender:t,cid:c,has:a===Ks.HaveBlock}})}i&&await this.sendMessagesDebounced()}async peerConnected(t){const n=new Set,i=new Vf(!0);for(const[s,o]of this.wants.entries())o.cancel||(n.add(s),i.addWantlistEntry(o.cid,{cid:o.cid.bytes,priority:1,wantType:cr.WantBlock,cancel:!1,sendDontHave:!1}));if(i.wantlist.size===0){this.peers.set(t,n);return}try{await this.network.sendMessage(t,i),this.peers.set(t,n)}catch(s){this.log.error("error sending full wantlist to new peer %p",t,s)}}peerDisconnected(t){this.peers.delete(t)}start(){}stop(){this.peers.clear(),clearTimeout(this.sendMessagesTimeout)}}class ehe{constructor(e,t={}){u(this,"log");u(this,"logger");u(this,"stats");u(this,"network");u(this,"blockstore");u(this,"peerWantLists");u(this,"wantList");this.logger=e.logger,this.log=e.logger.forComponent("helia:bitswap"),this.blockstore=e.blockstore,this.stats=new Wde(e),this.network=new Ase(e,t),this.peerWantLists=new zae({...e,network:this.network},t),this.wantList=new Zde({...e,network:this.network},t)}createSession(e={}){return qde({wantList:this.wantList,network:this.network,logger:this.logger},e)}async want(e,t={}){const n=new AbortController,i=dt([n.signal,t.signal]);n.signal,this.network.findAndConnect(e,{...t,signal:i}).catch(s=>{n.signal.aborted||this.log.error("error during finding and connect for cid %c",e,s)});try{return(await this.wantList.wantBlock(e,{...t,signal:i})).block}finally{n.abort(),i.clear()}}async notify(e,t,n={}){await Promise.all([this.peerWantLists.receivedBlock(e,n),this.wantList.receivedBlock(e,n)])}getWantlist(){return[...this.wantList.wants.values()].filter(e=>!e.cancel).map(e=>({cid:e.cid,priority:e.priority,wantType:e.wantType}))}getPeerWantlist(e){return this.peerWantLists.wantListForPeer(e)}async start(){this.wantList.start(),await this.network.start()}async stop(){this.wantList.stop(),await this.network.stop()}}const the=(r,e={})=>new ehe(r,e);class rhe{constructor(e,t={}){u(this,"bitswap");u(this,"started");const{getHasher:n}=e;this.bitswap=the(e,{hashLoader:{getHasher:async i=>n(i)},...t}),this.started=!1}isStarted(){return this.started}async start(){await this.bitswap.start(),this.started=!0}async stop(){await this.bitswap.stop(),this.started=!1}async announce(e,t,n){await this.bitswap.notify(e,t,n)}async retrieve(e,t={}){return this.bitswap.want(e,t)}createSession(e){const t=this.bitswap.createSession(e);return{announce:async(n,i,s)=>{await this.bitswap.notify(n,i,s)},retrieve:async(n,i)=>t.retrieve(n,i)}}}function nhe(r={}){return e=>new rhe(e,r)}class ihe{constructor(){u(this,"index",0);u(this,"input","")}new(e){return this.index=0,this.input=e,this}readAtomically(e){const t=this.index,n=e();return n===void 0&&(this.index=t),n}parseWith(e){const t=e();if(this.index===this.input.length)return t}peekChar(){if(!(this.index>=this.input.length))return this.input[this.index]}readChar(){if(!(this.index>=this.input.length))return this.input[this.index++]}readGivenChar(e){return this.readAtomically(()=>{const t=this.readChar();if(t===e)return t})}readSeparator(e,t,n){return this.readAtomically(()=>{if(!(t>0&&this.readGivenChar(e)===void 0))return n()})}readNumber(e,t,n,i){return this.readAtomically(()=>{let s=0,o=0;const a=this.peekChar();if(a===void 0)return;const c=a==="0",l=2**(8*i)-1;for(;;){const d=this.readAtomically(()=>{const h=this.readChar();if(h===void 0)return;const p=Number.parseInt(h,e);if(!Number.isNaN(p))return p});if(d===void 0)break;if(s*=e,s+=d,s>l||(o+=1,t!==void 0&&o>t))return}if(o!==0)return!n&&c&&o>1?void 0:s})}readIPv4Addr(){return this.readAtomically(()=>{const e=new Uint8Array(4);for(let t=0;t<e.length;t++){const n=this.readSeparator(".",t,()=>this.readNumber(10,3,!1,1));if(n===void 0)return;e[t]=n}return e})}readIPv6Addr(){const e=t=>{for(let n=0;n<t.length/2;n++){const i=n*2;if(n<t.length-3){const o=this.readSeparator(":",n,()=>this.readIPv4Addr());if(o!==void 0)return t[i]=o[0],t[i+1]=o[1],t[i+2]=o[2],t[i+3]=o[3],[i+4,!0]}const s=this.readSeparator(":",n,()=>this.readNumber(16,4,!0,2));if(s===void 0)return[i,!1];t[i]=s>>8,t[i+1]=s&255}return[t.length,!1]};return this.readAtomically(()=>{const t=new Uint8Array(16),[n,i]=e(t);if(n===16)return t;if(i||this.readGivenChar(":")===void 0||this.readGivenChar(":")===void 0)return;const s=new Uint8Array(14),o=16-(n+2),[a]=e(s.subarray(0,o));return t.set(s.subarray(0,a),16-a),t})}readIPAddr(){return this.readIPv4Addr()??this.readIPv6Addr()}}const JF=45,she=15,th=new ihe;function XF(r){if(!(r.length>she))return th.new(r).parseWith(()=>th.readIPv4Addr())}function ZF(r){if(r.includes("%")&&(r=r.split("%")[0]),!(r.length>JF))return th.new(r).parseWith(()=>th.readIPv6Addr())}function By(r,e=!1){if(r.includes("%")&&(r=r.split("%")[0]),r.length>JF)return;const t=th.new(r).parseWith(()=>th.readIPAddr());if(t)return e&&t.length===4?Uint8Array.from([0,0,0,0,0,0,0,0,0,0,255,255,t[0],t[1],t[2],t[3]]):t}function rh(r){return!!XF(r)}function JS(r){return!!ZF(r)}function ez(r){return!!By(r)}var tz;(function(){var r,e,t,n,i,s,o,a;a=function(c){var l,d,h,p;return l=(c&255<<24)>>>24,d=(c&255<<16)>>>16,h=(c&65280)>>>8,p=c&255,[l,d,h,p].join(".")},o=function(c){var l,d,h,p,m,f;for(l=[],h=p=0;p<=3&&c.length!==0;h=++p){if(h>0){if(c[0]!==".")throw new Error("Invalid IP");c=c.substring(1)}f=e(c),m=f[0],d=f[1],c=c.substring(d),l.push(m)}if(c.length!==0)throw new Error("Invalid IP");switch(l.length){case 1:if(l[0]>4294967295)throw new Error("Invalid IP");return l[0]>>>0;case 2:if(l[0]>255||l[1]>16777215)throw new Error("Invalid IP");return(l[0]<<24|l[1])>>>0;case 3:if(l[0]>255||l[1]>255||l[2]>65535)throw new Error("Invalid IP");return(l[0]<<24|l[1]<<16|l[2])>>>0;case 4:if(l[0]>255||l[1]>255||l[2]>255||l[3]>255)throw new Error("Invalid IP");return(l[0]<<24|l[1]<<16|l[2]<<8|l[3])>>>0;default:throw new Error("Invalid IP")}},t=function(c){return c.charCodeAt(0)},n=t("0"),s=t("a"),i=t("A"),e=function(c){var l,d,h,p,m;for(p=0,l=10,d="9",h=0,c.length>1&&c[h]==="0"&&(c[h+1]==="x"||c[h+1]==="X"?(h+=2,l=16):"0"<=c[h+1]&&c[h+1]<="9"&&(h++,l=8,d="7")),m=h;h<c.length;){if("0"<=c[h]&&c[h]<=d)p=p*l+(t(c[h])-n)>>>0;else if(l===16)if("a"<=c[h]&&c[h]<="f")p=p*l+(10+t(c[h])-s)>>>0;else if("A"<=c[h]&&c[h]<="F")p=p*l+(10+t(c[h])-i)>>>0;else break;else break;if(p>4294967295)throw new Error("too large");h++}if(h===m)throw new Error("empty octet");return[p,h]},r=function(){function c(l,d){var h,p,m;if(typeof l!="string")throw new Error("Missing `net' parameter");if(d||(m=l.split("/",2),l=m[0],d=m[1]),d||(d=32),typeof d=="string"&&d.indexOf(".")>-1){try{this.maskLong=o(d)}catch{throw new Error("Invalid mask: "+d)}for(h=p=32;p>=0;h=--p)if(this.maskLong===4294967295<<32-h>>>0){this.bitmask=h;break}}else if(d||d===0)this.bitmask=parseInt(d,10),this.maskLong=0,this.bitmask>0&&(this.maskLong=4294967295<<32-this.bitmask>>>0);else throw new Error("Invalid mask: empty");try{this.netLong=(o(l)&this.maskLong)>>>0}catch{throw new Error("Invalid net address: "+l)}if(!(this.bitmask<=32))throw new Error("Invalid mask for ip4: "+d);this.size=Math.pow(2,32-this.bitmask),this.base=a(this.netLong),this.mask=a(this.maskLong),this.hostmask=a(~this.maskLong),this.first=this.bitmask<=30?a(this.netLong+1):this.base,this.last=this.bitmask<=30?a(this.netLong+this.size-2):a(this.netLong+this.size-1),this.broadcast=this.bitmask<=30?a(this.netLong+this.size-1):void 0}return c.prototype.contains=function(l){return typeof l=="string"&&(l.indexOf("/")>0||l.split(".").length!==4)&&(l=new c(l)),l instanceof c?this.contains(l.base)&&this.contains(l.broadcast||l.last):(o(l)&this.maskLong)>>>0===(this.netLong&this.maskLong)>>>0},c.prototype.next=function(l){return l==null&&(l=1),new c(a(this.netLong+this.size*l),this.mask)},c.prototype.forEach=function(l){var d,h,p;for(p=o(this.first),h=o(this.last),d=0;p<=h;)l(a(p),p,d),d++,p++},c.prototype.toString=function(){return this.base+"/"+this.bitmask},c}(),tz=r}).call(v1);const ohe=["0.0.0.0/8","10.0.0.0/8","100.64.0.0/10","127.0.0.0/8","169.254.0.0/16","172.16.0.0/12","192.0.0.0/24","192.0.0.0/29","192.0.0.8/32","192.0.0.9/32","192.0.0.10/32","192.0.0.170/32","192.0.0.171/32","192.0.2.0/24","192.31.196.0/24","192.52.193.0/24","192.88.99.0/24","192.168.0.0/16","192.175.48.0/24","198.18.0.0/15","198.51.100.0/24","203.0.113.0/24","240.0.0.0/4","255.255.255.255/32"],ahe=ohe.map(r=>new tz(r));function XS(r){for(const e of ahe)if(e.contains(r))return!0;return!1}function che(r){return/^::ffff:([0-9a-fA-F]{1,4}):([0-9a-fA-F]{1,4})$/.test(r)}function lhe(r){const e=r.split(":");if(e.length<2)return!1;const t=e[e.length-1].padStart(4,"0"),n=e[e.length-2].padStart(4,"0"),i=`${parseInt(n.substring(0,2),16)}.${parseInt(n.substring(2),16)}.${parseInt(t.substring(0,2),16)}.${parseInt(t.substring(2),16)}`;return XS(i)}function uhe(r){return/^::ffff:([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(r)}function dhe(r){const e=r.split(":"),t=e[e.length-1];return XS(t)}function hhe(r){return/^::$/.test(r)||/^::1$/.test(r)||/^64:ff9b::([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(r)||/^100::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001:2[0-9a-fA-F]:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001:db8:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2002:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^f[c-d]([0-9a-fA-F]{2,2}):/i.test(r)||/^fe[8-9a-bA-B][0-9a-fA-F]:/i.test(r)||/^ff([0-9a-fA-F]{2,2}):/i.test(r)}function zc(r){return rh(r)?XS(r):che(r)?lhe(r):uhe(r)?dhe(r):JS(r)?hhe(r):void 0}function fhe(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function phe(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var i=0;i<r.length;i++){var s=r.charAt(i),o=s.charCodeAt(0);if(t[o]!==255)throw new TypeError(s+" is ambiguous");t[o]=i}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),d=Math.log(256)/Math.log(a);function h(f){if(f instanceof Uint8Array||(ArrayBuffer.isView(f)?f=new Uint8Array(f.buffer,f.byteOffset,f.byteLength):Array.isArray(f)&&(f=Uint8Array.from(f))),!(f instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(f.length===0)return"";for(var g=0,v=0,y=0,w=f.length;y!==w&&f[y]===0;)y++,g++;for(var b=(w-y)*d+1>>>0,E=new Uint8Array(b);y!==w;){for(var A=f[y],k=0,x=b-1;(A!==0||k<v)&&x!==-1;x--,k++)A+=256*E[x]>>>0,E[x]=A%a>>>0,A=A/a>>>0;if(A!==0)throw new Error("Non-zero carry");v=k,y++}for(var I=b-v;I!==b&&E[I]===0;)I++;for(var T=c.repeat(g);I<b;++I)T+=r.charAt(E[I]);return T}function p(f){if(typeof f!="string")throw new TypeError("Expected String");if(f.length===0)return new Uint8Array;var g=0;if(f[g]!==" "){for(var v=0,y=0;f[g]===c;)v++,g++;for(var w=(f.length-g)*l+1>>>0,b=new Uint8Array(w);f[g];){var E=t[f.charCodeAt(g)];if(E===255)return;for(var A=0,k=w-1;(E!==0||A<y)&&k!==-1;k--,A++)E+=a*b[k]>>>0,b[k]=E%256>>>0,E=E/256>>>0;if(E!==0)throw new Error("Non-zero carry");y=A,g++}if(f[g]!==" "){for(var x=w-y;x!==w&&b[x]===0;)x++;for(var I=new Uint8Array(v+(w-x)),T=v;x!==w;)I[T++]=b[x++];return I}}}function m(f){var g=p(f);if(g)return g;throw new Error(`Non-${e} character`)}return{encode:h,decodeUnsafe:p,decode:m}}var ghe=phe,yhe=ghe;let mhe=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseEncode");this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},whe=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseDecode");u(this,"prefixCodePoint");this.name=e,this.prefix=t;const i=t.codePointAt(0);if(i===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=i,this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return rz(this,e)}},bhe=class{constructor(e){u(this,"decoders");this.decoders=e}or(e){return rz(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};function rz(r,e){return new bhe({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}let vhe=class{constructor(e,t,n,i){u(this,"name");u(this,"prefix");u(this,"baseEncode");u(this,"baseDecode");u(this,"encoder");u(this,"decoder");this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=i,this.encoder=new mhe(e,t,n),this.decoder=new whe(e,t,i)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};function nz({name:r,prefix:e,encode:t,decode:n}){return new vhe(r,e,t,n)}function iz({name:r,prefix:e,alphabet:t}){const{encode:n,decode:i}=yhe(t,r);return nz({prefix:e,name:r,encode:n,decode:s=>fhe(i(s))})}function Ehe(r,e,t,n){const i={};for(let d=0;d<e.length;++d)i[e[d]]=d;let s=r.length;for(;r[s-1]==="=";)--s;const o=new Uint8Array(s*t/8|0);let a=0,c=0,l=0;for(let d=0;d<s;++d){const h=i[r[d]];if(h===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|h,a+=t,a>=8&&(a-=8,o[l++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o}function She(r,e,t){const n=e[e.length-1]==="=",i=(1<<t)-1;let s="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,s+=e[i&a>>o];if(o!==0&&(s+=e[i&a<<t-o]),n)for(;s.length*t&7;)s+="=";return s}function Sw({name:r,prefix:e,bitsPerChar:t,alphabet:n}){return nz({prefix:e,name:r,encode(i){return She(i,n,t)},decode(i){return Ehe(i,n,t,r)}})}const xhe=iz({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});iz({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});Sw({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6});Sw({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6});const Ahe=Sw({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6});Sw({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});const Che=r=>r.toString().split("/").slice(1),Kp=r=>({match:e=>e.length<1?!1:r(e[0])?e.slice(1):!1,pattern:"fn"}),Je=r=>({match:e=>Kp(t=>t===r).match(e),pattern:r}),Bh=()=>({match:r=>Kp(e=>typeof e=="string").match(r),pattern:"{string}"}),xw=()=>({match:r=>Kp(e=>!isNaN(parseInt(e))).match(r),pattern:"{number}"}),yt=()=>({match:r=>{if(r.length<2||r[0]!=="p2p"&&r[0]!=="ipfs")return!1;if(r[1].startsWith("Q")||r[1].startsWith("1"))try{xhe.decode(`z${r[1]}`)}catch{return!1}else return!1;return r.slice(2)},pattern:"/p2p/{peerid}"}),Uy=()=>({match:r=>{if(r.length<2||r[0]!=="certhash")return!1;try{Ahe.decode(r[1])}catch{return!1}return r.slice(2)},pattern:"/certhash/{certhash}"}),lt=r=>({match:e=>{const t=r.match(e);return t===!1?e:t},pattern:`optional(${r.pattern})`}),fn=(...r)=>({match:e=>{let t;for(const n of r){const i=n.match(e);i!==!1&&(t==null||i.length<t.length)&&(t=i)}return t??!1},pattern:`or(${r.map(e=>e.pattern).join(", ")})`}),Ze=(...r)=>({match:e=>{for(const t of r){const n=t.match(e);if(n===!1)return!1;e=n}return e},pattern:`and(${r.map(e=>e.pattern).join(", ")})`});function It(...r){function e(i){let s=Che(i);for(const o of r){const a=o.match(s);if(a===!1)return!1;s=a}return s}function t(i){return e(i)!==!1}function n(i){const s=e(i);return s===!1?!1:s.length===0}return{matchers:r,matches:t,exactMatch:n}}const Ihe=yt(),khe=It(Ihe),Aw=Ze(Je("dns4"),Bh()),Cw=Ze(Je("dns6"),Bh()),Iw=Ze(Je("dnsaddr"),Bh()),ZS=Ze(Je("dns"),Bh());It(Aw,lt(yt()));It(Cw,lt(yt()));It(Iw,lt(yt()));const sz=It(fn(ZS,Iw,Aw,Cw),lt(yt())),oz=Ze(Je("ip4"),Kp(rh)),az=Ze(Je("ip6"),Kp(JS)),ex=fn(oz,az),Do=fn(ex,ZS,Aw,Cw,Iw),_he=It(fn(ex,Ze(fn(ZS,Iw,Aw,Cw),lt(yt())))),v_=It(oz),E_=It(az),The=It(ex),tx=Ze(Do,Je("tcp"),xw()),jp=Ze(Do,Je("udp"),xw()),Fy=It(Ze(tx,lt(yt())));It(jp);const rx=Ze(jp,Je("quic"),lt(yt())),kw=Ze(jp,Je("quic-v1"),lt(yt())),Phe=fn(rx,kw);It(rx);const Dhe=It(kw),tv=fn(Do,tx,jp,rx,kw),cz=fn(Ze(tv,Je("ws"),lt(yt()))),X1=It(cz),lz=fn(Ze(tv,Je("wss"),lt(yt())),Ze(tv,Je("tls"),lt(Ze(Je("sni"),Bh())),Je("ws"),lt(yt()))),zy=It(lz),uz=Ze(jp,Je("webrtc-direct"),lt(Uy()),lt(Uy()),lt(yt())),rv=It(uz),dz=Ze(kw,Je("webtransport"),lt(Uy()),lt(Uy()),lt(yt())),S_=It(dz),Vy=fn(cz,lz,Ze(tx,lt(yt())),Ze(Phe,lt(yt())),Ze(Do,lt(yt())),uz,dz,yt()),hz=It(Vy),$he=Ze(Vy,Je("p2p-circuit"),yt()),Ic=It($he),Nhe=fn(Ze(Vy,Je("p2p-circuit"),Je("webrtc"),lt(yt())),Ze(Vy,Je("webrtc"),lt(yt())),Ze(Je("webrtc"),lt(yt()))),nv=It(Nhe),Mhe=fn(Ze(Do,Je("tcp"),xw(),Je("http"),lt(yt())),Ze(Do,Je("http"),lt(yt()))),Ohe=It(Mhe),Rhe=fn(Ze(Do,Je("tcp"),fn(Ze(Je("443"),Je("http")),Ze(xw(),Je("https"))),lt(yt())),Ze(Do,Je("tls"),Je("http"),lt(yt())),Ze(Do,Je("https"),lt(yt()))),Lhe=It(Rhe),Bhe=fn(Ze(Je("memory"),Bh(),lt(yt())));It(Bhe);function Uhe(r,e,t){let n=0;for(const i of r)if(!(n<e)){if(n>t)break;if(i!==255)return!1;n++}return!0}function Fhe(r,e,t,n){let i=0;for(const s of r)if(!(i<t)){if(i>n)break;if(s!==e[i])return!1;i++}return!0}function zhe(r){switch(r.length){case Z1:return r.join(".");case ep:{const e=[];for(let t=0;t<r.length;t++)t%2===0&&e.push(r[t].toString(16).padStart(2,"0")+r[t+1].toString(16).padStart(2,"0"));return e.join(":")}default:throw new Error("Invalid ip length")}}function Vhe(r){let e=0;for(let[t,n]of r.entries()){if(n===255){e+=8;continue}for(;n&128;)e++,n=n<<1;if(n&128)return-1;for(let i=t+1;i<r.length;i++)if(r[i]!=0)return-1;break}return e}function Khe(r){let e="0x";for(const t of r)e+=(t>>4).toString(16)+(t&15).toString(16);return e}const Z1=4,ep=16,jhe=new Uint8Array([0,0,0,0,0,0,0,0,0,0,255,255]);function fz(r,e){e.length===ep&&r.length===Z1&&Uhe(e,0,11)&&(e=e.slice(12)),e.length===Z1&&r.length===ep&&Fhe(r,jhe,0,11)&&(r=r.slice(12));const t=r.length;if(t!=e.length)throw new Error("Failed to mask ip");const n=new Uint8Array(t);for(let i=0;i<t;i++)n[i]=r[i]&e[i];return n}function Hhe(r,e){if(typeof e=="string"&&(e=By(e)),e==null)throw new Error("Invalid ip");if(e.length!==r.network.length)return!1;for(let t=0;t<e.length;t++)if((r.network[t]&r.mask[t])!==(e[t]&r.mask[t]))return!1;return!0}function qhe(r){const[e,t]=r.split("/");if(!e||!t)throw new Error("Failed to parse given CIDR: "+r);let n=Z1,i=XF(e);if(i==null&&(n=ep,i=ZF(e),i==null))throw new Error("Failed to parse given CIDR: "+r);const s=parseInt(t,10);if(Number.isNaN(s)||String(s).length!==t.length||s<0||s>n*8)throw new Error("Failed to parse given CIDR: "+r);const o=pz(s,8*n);return{network:fz(i,o),mask:o}}function pz(r,e){if(e!==8*Z1&&e!==8*ep)throw new Error("Invalid CIDR mask");if(r<0||r>e)throw new Error("Invalid CIDR mask");const t=e/8,n=new Uint8Array(t);for(let i=0;i<t;i++){if(r>=8){n[i]=255,r-=8;continue}n[i]=255-(255>>r),r=0}return n}class gz{constructor(e,t){if(t==null)({network:this.network,mask:this.mask}=qhe(e));else{const n=By(e);if(n==null)throw new Error("Failed to parse network");t=String(t);const i=parseInt(t,10);if(Number.isNaN(i)||String(i).length!==t.length||i<0||i>n.length*8){const s=By(t);if(s==null)throw new Error("Failed to parse mask");this.mask=s}else this.mask=pz(i,8*n.length);this.network=fz(n,this.mask)}}contains(e){return Hhe({network:this.network,mask:this.mask},e)}toString(){const e=Vhe(this.mask),t=e!==-1?String(e):Khe(this.mask);return zhe(this.network)+"/"+t}}function Whe(r,e){return new gz(r).contains(e)}function Ghe(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function nx(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function Qhe(r){return new TextEncoder().encode(r)}function Yhe(r){return new TextDecoder().decode(r)}function Jhe(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var i=0;i<r.length;i++){var s=r.charAt(i),o=s.charCodeAt(0);if(t[o]!==255)throw new TypeError(s+" is ambiguous");t[o]=i}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),d=Math.log(256)/Math.log(a);function h(f){if(f instanceof Uint8Array||(ArrayBuffer.isView(f)?f=new Uint8Array(f.buffer,f.byteOffset,f.byteLength):Array.isArray(f)&&(f=Uint8Array.from(f))),!(f instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(f.length===0)return"";for(var g=0,v=0,y=0,w=f.length;y!==w&&f[y]===0;)y++,g++;for(var b=(w-y)*d+1>>>0,E=new Uint8Array(b);y!==w;){for(var A=f[y],k=0,x=b-1;(A!==0||k<v)&&x!==-1;x--,k++)A+=256*E[x]>>>0,E[x]=A%a>>>0,A=A/a>>>0;if(A!==0)throw new Error("Non-zero carry");v=k,y++}for(var I=b-v;I!==b&&E[I]===0;)I++;for(var T=c.repeat(g);I<b;++I)T+=r.charAt(E[I]);return T}function p(f){if(typeof f!="string")throw new TypeError("Expected String");if(f.length===0)return new Uint8Array;var g=0;if(f[g]!==" "){for(var v=0,y=0;f[g]===c;)v++,g++;for(var w=(f.length-g)*l+1>>>0,b=new Uint8Array(w);f[g];){var E=t[f.charCodeAt(g)];if(E===255)return;for(var A=0,k=w-1;(E!==0||A<y)&&k!==-1;k--,A++)E+=a*b[k]>>>0,b[k]=E%256>>>0,E=E/256>>>0;if(E!==0)throw new Error("Non-zero carry");y=A,g++}if(f[g]!==" "){for(var x=w-y;x!==w&&b[x]===0;)x++;for(var I=new Uint8Array(v+(w-x)),T=v;x!==w;)I[T++]=b[x++];return I}}}function m(f){var g=p(f);if(g)return g;throw new Error(`Non-${e} character`)}return{encode:h,decodeUnsafe:p,decode:m}}var Xhe=Jhe,Zhe=Xhe;let efe=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseEncode");this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},tfe=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseDecode");u(this,"prefixCodePoint");this.name=e,this.prefix=t;const i=t.codePointAt(0);if(i===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=i,this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return yz(this,e)}},rfe=class{constructor(e){u(this,"decoders");this.decoders=e}or(e){return yz(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};function yz(r,e){return new rfe({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}let nfe=class{constructor(e,t,n,i){u(this,"name");u(this,"prefix");u(this,"baseEncode");u(this,"baseDecode");u(this,"encoder");u(this,"decoder");this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=i,this.encoder=new efe(e,t,n),this.decoder=new tfe(e,t,i)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};function _w({name:r,prefix:e,encode:t,decode:n}){return new nfe(r,e,t,n)}function Hp({name:r,prefix:e,alphabet:t}){const{encode:n,decode:i}=Zhe(t,r);return _w({prefix:e,name:r,encode:n,decode:s=>nx(i(s))})}function ife(r,e,t,n){const i={};for(let d=0;d<e.length;++d)i[e[d]]=d;let s=r.length;for(;r[s-1]==="=";)--s;const o=new Uint8Array(s*t/8|0);let a=0,c=0,l=0;for(let d=0;d<s;++d){const h=i[r[d]];if(h===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|h,a+=t,a>=8&&(a-=8,o[l++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o}function sfe(r,e,t){const n=e[e.length-1]==="=",i=(1<<t)-1;let s="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,s+=e[i&a>>o];if(o!==0&&(s+=e[i&a<<t-o]),n)for(;s.length*t&7;)s+="=";return s}function Tr({name:r,prefix:e,bitsPerChar:t,alphabet:n}){return _w({prefix:e,name:r,encode(i){return sfe(i,n,t)},decode(i){return ife(i,n,t,r)}})}const Ml=Tr({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),ofe=Tr({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),afe=Tr({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),cfe=Tr({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),lfe=Tr({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),ufe=Tr({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),dfe=Tr({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),hfe=Tr({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),ffe=Tr({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),pfe=Object.freeze(Object.defineProperty({__proto__:null,base32:Ml,base32hex:lfe,base32hexpad:dfe,base32hexpadupper:hfe,base32hexupper:ufe,base32pad:afe,base32padupper:cfe,base32upper:ofe,base32z:ffe},Symbol.toStringTag,{value:"Module"})),rs=Hp({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),gfe=Hp({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),yfe=Object.freeze(Object.defineProperty({__proto__:null,base58btc:rs,base58flickr:gfe},Symbol.toStringTag,{value:"Module"})),mfe=Hp({prefix:"9",name:"base10",alphabet:"0123456789"}),wfe=Object.freeze(Object.defineProperty({__proto__:null,base10:mfe},Symbol.toStringTag,{value:"Module"})),bfe=Tr({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),vfe=Tr({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),Efe=Object.freeze(Object.defineProperty({__proto__:null,base16:bfe,base16upper:vfe},Symbol.toStringTag,{value:"Module"})),Sfe=Tr({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),xfe=Object.freeze(Object.defineProperty({__proto__:null,base2:Sfe},Symbol.toStringTag,{value:"Module"})),mz=Array.from(""),Afe=mz.reduce((r,e,t)=>(r[t]=e,r),[]),Cfe=mz.reduce((r,e,t)=>{const n=e.codePointAt(0);if(n==null)throw new Error(`Invalid character: ${e}`);return r[n]=t,r},[]);function Ife(r){return r.reduce((e,t)=>(e+=Afe[t],e),"")}function kfe(r){const e=[];for(const t of r){const n=t.codePointAt(0);if(n==null)throw new Error(`Invalid character: ${t}`);const i=Cfe[n];if(i==null)throw new Error(`Non-base256emoji character: ${t}`);e.push(i)}return new Uint8Array(e)}const _fe=_w({prefix:"",name:"base256emoji",encode:Ife,decode:kfe}),Tfe=Object.freeze(Object.defineProperty({__proto__:null,base256emoji:_fe},Symbol.toStringTag,{value:"Module"})),t2=Hp({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),Pfe=Hp({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),Dfe=Object.freeze(Object.defineProperty({__proto__:null,base36:t2,base36upper:Pfe},Symbol.toStringTag,{value:"Module"})),$fe=Tr({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),Nfe=Tr({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),Mfe=Tr({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),Ofe=Tr({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),Rfe=Object.freeze(Object.defineProperty({__proto__:null,base64:$fe,base64pad:Nfe,base64url:Mfe,base64urlpad:Ofe},Symbol.toStringTag,{value:"Module"})),Lfe=Tr({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),Bfe=Object.freeze(Object.defineProperty({__proto__:null,base8:Lfe},Symbol.toStringTag,{value:"Module"})),Ufe=_w({prefix:"\0",name:"identity",encode:r=>Yhe(r),decode:r=>Qhe(r)}),Ffe=Object.freeze(Object.defineProperty({__proto__:null,identity:Ufe},Symbol.toStringTag,{value:"Module"}));new TextEncoder;new TextDecoder;var zfe=wz,x_=128,Vfe=-128,Kfe=Math.pow(2,31);function wz(r,e,t){e=e||[],t=t||0;for(var n=t;r>=Kfe;)e[t++]=r&255|x_,r/=128;for(;r&Vfe;)e[t++]=r&255|x_,r>>>=7;return e[t]=r|0,wz.bytes=t-n+1,e}var jfe=iv,Hfe=128,A_=127;function iv(r,n){var t=0,n=n||0,i=0,s=n,o,a=r.length;do{if(s>=a)throw iv.bytes=0,new RangeError("Could not decode varint");o=r[s++],t+=i<28?(o&A_)<<i:(o&A_)*Math.pow(2,i),i+=7}while(o>=Hfe);return iv.bytes=s-n,t}var qfe=Math.pow(2,7),Wfe=Math.pow(2,14),Gfe=Math.pow(2,21),Qfe=Math.pow(2,28),Yfe=Math.pow(2,35),Jfe=Math.pow(2,42),Xfe=Math.pow(2,49),Zfe=Math.pow(2,56),e1e=Math.pow(2,63),t1e=function(r){return r<qfe?1:r<Wfe?2:r<Gfe?3:r<Qfe?4:r<Yfe?5:r<Jfe?6:r<Xfe?7:r<Zfe?8:r<e1e?9:10},r1e={encode:zfe,decode:jfe,encodingLength:t1e},Ky=r1e;function sv(r,e=0){return[Ky.decode(r,e),Ky.decode.bytes]}function jy(r,e,t=0){return Ky.encode(r,e,t),e}function Hy(r){return Ky.encodingLength(r)}function n1e(r,e){const t=e.byteLength,n=Hy(r),i=n+Hy(t),s=new Uint8Array(i+t);return jy(r,s,0),jy(t,s,n),s.set(e,i),new ix(r,t,e,s)}function bz(r){const e=nx(r),[t,n]=sv(e),[i,s]=sv(e.subarray(n)),o=e.subarray(n+s);if(o.byteLength!==i)throw new Error("Incorrect length");return new ix(t,i,o,e)}function i1e(r,e){if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&Ghe(r.bytes,t.bytes)}}let ix=class{constructor(e,t,n,i){u(this,"code");u(this,"size");u(this,"digest");u(this,"bytes");this.code=e,this.size=t,this.digest=n,this.bytes=i}};function C_(r,e){const{bytes:t,version:n}=r;switch(n){case 0:return o1e(t,ov(r),e??rs.encoder);default:return a1e(t,ov(r),e??Ml.encoder)}}const I_=new WeakMap;function ov(r){const e=I_.get(r);if(e==null){const t=new Map;return I_.set(r,t),t}return e}var fN;let vz=class Vr{constructor(e,t,n,i){u(this,"code");u(this,"version");u(this,"multihash");u(this,"bytes");u(this,"/");u(this,fN,"CID");this.code=t,this.version=e,this.multihash=n,this.bytes=i,this["/"]=i}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==kf)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==c1e)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return Vr.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=n1e(e,t);return Vr.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return Vr.equals(this,e)}static equals(e,t){const n=t;return n!=null&&e.code===n.code&&e.version===n.version&&i1e(e.multihash,n.multihash)}toString(e){return C_(this,e)}toJSON(){return{"/":C_(this)}}link(){return this}[(fN=Symbol.toStringTag,Symbol.for("nodejs.util.inspect.custom"))](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof Vr)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:i,multihash:s,bytes:o}=t;return new Vr(n,i,s,o??k_(n,i,s.bytes))}else if(t[l1e]===!0){const{version:n,multihash:i,code:s}=t,o=bz(i);return Vr.create(n,s,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==kf)throw new Error(`Version 0 CID must use dag-pb (code: ${kf}) block encoding`);return new Vr(e,t,n,n.bytes)}case 1:{const i=k_(e,t,n.bytes);return new Vr(e,t,n,i)}default:throw new Error("Invalid version")}}static createV0(e){return Vr.create(0,kf,e)}static createV1(e,t){return Vr.create(1,e,t)}static decode(e){const[t,n]=Vr.decodeFirst(e);if(n.length!==0)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=Vr.inspectBytes(e),n=t.size-t.multihashSize,i=nx(e.subarray(n,n+t.multihashSize));if(i.byteLength!==t.multihashSize)throw new Error("Incorrect length");const s=i.subarray(t.multihashSize-t.digestSize),o=new ix(t.multihashCode,t.digestSize,s,i);return[t.version===0?Vr.createV0(o):Vr.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[h,p]=sv(e.subarray(t));return t+=p,h};let i=n(),s=kf;if(i===18?(i=0,t=0):s=n(),i!==0&&i!==1)throw new RangeError(`Invalid CID version ${i}`);const o=t,a=n(),c=n(),l=t+c,d=l-o;return{version:i,codec:s,multihashCode:a,digestSize:c,multihashSize:d,size:l}}static parse(e,t){const[n,i]=s1e(e,t),s=Vr.decode(i);if(s.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return ov(s).set(n,e),s}};function s1e(r,e){switch(r[0]){case"Q":{const t=e??rs;return[rs.prefix,t.decode(`${rs.prefix}${r}`)]}case rs.prefix:{const t=e??rs;return[rs.prefix,t.decode(r)]}case Ml.prefix:{const t=e??Ml;return[Ml.prefix,t.decode(r)]}case t2.prefix:{const t=e??t2;return[t2.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}}function o1e(r,e,t){const{prefix:n}=t;if(n!==rs.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const i=e.get(n);if(i==null){const s=t.encode(r).slice(1);return e.set(n,s),s}else return i}function a1e(r,e,t){const{prefix:n}=t,i=e.get(n);if(i==null){const s=t.encode(r);return e.set(n,s),s}else return i}const kf=112,c1e=18;function k_(r,e,t){const n=Hy(r),i=n+Hy(e),s=new Uint8Array(i+t.byteLength);return jy(r,s,0),jy(e,s,n),s.set(t,i),s}const l1e=Symbol.for("@ipld/js-cid/CID"),u1e={...Ffe,...xfe,...Bfe,...wfe,...Efe,...pfe,...Dfe,...yfe,...Rfe,...Tfe},__=rh,d1e=JS,Ez=function(r){let e=0;if(r=r.toString().trim(),__(r)){const t=new Uint8Array(e+4);return r.split(/\./g).forEach(n=>{t[e++]=parseInt(n,10)&255}),t}if(d1e(r)){const t=r.split(":",8);let n;for(n=0;n<t.length;n++){const s=__(t[n]);let o;s&&(o=Ez(t[n]),t[n]=re(o.slice(0,2),"base16")),o!=null&&++n<8&&t.splice(n,0,re(o.slice(2,4),"base16"))}if(t[0]==="")for(;t.length<8;)t.unshift("0");else if(t[t.length-1]==="")for(;t.length<8;)t.push("0");else if(t.length<8){for(n=0;n<t.length&&t[n]!=="";n++);const s=[n,1];for(n=9-t.length;n>0;n--)s.push("0");t.splice.apply(t,s)}const i=new Uint8Array(e+16);for(n=0;n<t.length;n++){const s=parseInt(t[n],16);i[e++]=s>>8&255,i[e++]=s&255}return i}throw new Error("invalid ip address")},h1e=function(r,e=0,t){e=~~e,t=t??r.length-e;const n=new DataView(r.buffer);if(t===4){const i=[];for(let s=0;s<t;s++)i.push(r[e+s]);return i.join(".")}if(t===16){const i=[];for(let s=0;s<t;s+=2)i.push(n.getUint16(e+s).toString(16));return i.join(":").replace(/(^|:)0(:0)*:0(:|$)/,"$1::$3").replace(/:{3,4}/,"::")}return""},zn=-1,tp={},av={},f1e=[[4,32,"ip4"],[6,16,"tcp"],[33,16,"dccp"],[41,128,"ip6"],[42,zn,"ip6zone"],[43,8,"ipcidr"],[53,zn,"dns",!0],[54,zn,"dns4",!0],[55,zn,"dns6",!0],[56,zn,"dnsaddr",!0],[132,16,"sctp"],[273,16,"udp"],[275,0,"p2p-webrtc-star"],[276,0,"p2p-webrtc-direct"],[277,0,"p2p-stardust"],[280,0,"webrtc-direct"],[281,0,"webrtc"],[290,0,"p2p-circuit"],[301,0,"udt"],[302,0,"utp"],[400,zn,"unix",!1,!0],[421,zn,"ipfs"],[421,zn,"p2p"],[443,0,"https"],[444,96,"onion"],[445,296,"onion3"],[446,zn,"garlic64"],[448,0,"tls"],[449,zn,"sni"],[460,0,"quic"],[461,0,"quic-v1"],[465,0,"webtransport"],[466,zn,"certhash"],[477,0,"ws"],[478,0,"wss"],[479,0,"p2p-websocket-star"],[480,0,"http"],[481,zn,"http-path"],[777,zn,"memory"]];f1e.forEach(r=>{const e=p1e(...r);av[e.code]=e,tp[e.name]=e});function p1e(r,e,t,n,i){return{code:r,size:e,name:t,resolvable:!!n,path:!!i}}function ze(r){if(typeof r=="number"){if(av[r]!=null)return av[r];throw new Error(`no protocol with code: ${r}`)}else if(typeof r=="string"){if(tp[r]!=null)return tp[r];throw new Error(`no protocol with name: ${r}`)}throw new Error(`invalid protocol id type: ${typeof r}`)}const g1e=ze("ip4"),y1e=ze("ip6"),m1e=ze("ipcidr");function sx(r,e){switch(ze(r).code){case 4:case 41:return v1e(e);case 42:return l8(e);case 43:return re(e,"base10");case 6:case 273:case 33:case 132:return Sz(e).toString();case 53:case 54:case 55:case 56:case 400:case 449:case 777:return l8(e);case 421:return A1e(e);case 444:return D_(e);case 445:return D_(e);case 466:return x1e(e);case 481:return globalThis.encodeURIComponent(l8(e));default:return re(e,"base16")}}function T_(r,e){switch(ze(r).code){case 4:return P_(e);case 41:return P_(e);case 42:return c8(e);case 43:return oe(e,"base10");case 6:case 273:case 33:case 132:return ox(parseInt(e,10));case 53:case 54:case 55:case 56:case 400:case 449:case 777:return c8(e);case 421:return E1e(e);case 444:return C1e(e);case 445:return I1e(e);case 466:return S1e(e);case 481:return c8(globalThis.decodeURIComponent(e));default:return oe(e,"base16")}}function w1e(r){let e,t;if(r.stringTuples().forEach(([n,i])=>{(n===g1e.code||n===y1e.code)&&(t=i),n===m1e.code&&(e=i)}),e==null||t==null)throw new Error("Invalid multiaddr");return new gz(t,e)}const a8=Object.values(u1e).map(r=>r.decoder),b1e=function(){let r=a8[0].or(a8[1]);return a8.slice(2).forEach(e=>r=r.or(e)),r}();function P_(r){if(!ez(r))throw new Error("invalid ip address");return Ez(r)}function v1e(r){const e=h1e(r,0,r.length);if(e==null)throw new Error("ipBuff is required");if(!ez(e))throw new Error("invalid ip address");return e}function ox(r){const e=new ArrayBuffer(2);return new DataView(e).setUint16(0,r),new Uint8Array(e)}function Sz(r){return new DataView(r.buffer).getUint16(r.byteOffset)}function c8(r){const e=oe(r),t=Uint8Array.from(xr(e.length));return ir([t,e],t.length+e.length)}function l8(r){const e=gs(r);if(r=r.slice(gt(e)),r.length!==e)throw new Error("inconsistent lengths");return re(r)}function E1e(r){let e;r[0]==="Q"||r[0]==="1"?e=bz(rs.decode(`z${r}`)).bytes:e=vz.parse(r).multihash.bytes;const t=Uint8Array.from(xr(e.length));return ir([t,e],t.length+e.length)}function S1e(r){const e=b1e.decode(r),t=Uint8Array.from(xr(e.length));return ir([t,e],t.length+e.length)}function x1e(r){const e=gs(r),t=r.slice(gt(e));if(t.length!==e)throw new Error("inconsistent lengths");return"u"+re(t,"base64url")}function A1e(r){const e=gs(r),t=r.slice(gt(e));if(t.length!==e)throw new Error("inconsistent lengths");return re(t,"base58btc")}function C1e(r){const e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==16)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion address.`);const t=Ml.decode("b"+e[0]),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");const i=ox(n);return ir([t,i],t.length+i.length)}function I1e(r){const e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==56)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion3 address.`);const t=Ml.decode(`b${e[0]}`),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");const i=ox(n);return ir([t,i],t.length+i.length)}function D_(r){const e=r.slice(0,r.length-2),t=r.slice(r.length-2),n=re(e,"base32"),i=Sz(t);return`${n}:${i}`}function k1e(r){r=cv(r);const e=[],t=[];let n=null;const i=r.split("/").slice(1);if(i.length===1&&i[0]==="")return{bytes:new Uint8Array,string:"/",tuples:[],stringTuples:[],path:null};for(let s=0;s<i.length;s++){const o=i[s],a=ze(o);if(a.size===0){e.push([a.code]),t.push([a.code]);continue}if(s++,s>=i.length)throw new ax("invalid address: "+r);if(a.path===!0){n=cv(i.slice(s).join("/")),e.push([a.code,T_(a.code,n)]),t.push([a.code,n]);break}const c=T_(a.code,i[s]);e.push([a.code,c]),t.push([a.code,sx(a.code,c)])}return{string:xz(t),bytes:Az(e),tuples:e,stringTuples:t,path:n}}function $_(r){const e=[],t=[];let n=null,i=0;for(;i<r.length;){const s=gs(r,i),o=gt(s),a=ze(s),c=_1e(a,r.slice(i+o));if(c===0){e.push([s]),t.push([s]),i+=o;continue}const l=r.slice(i+o,i+o+c);if(i+=c+o,i>r.length)throw new ax("Invalid address Uint8Array: "+re(r,"base16"));e.push([s,l]);const d=sx(s,l);if(t.push([s,d]),a.path===!0){n=d;break}}return{bytes:Uint8Array.from(r),string:xz(t),tuples:e,stringTuples:t,path:n}}function xz(r){const e=[];return r.map(t=>{const n=ze(t[0]);return e.push(n.name),t.length>1&&t[1]!=null&&e.push(t[1]),null}),cv(e.join("/"))}function Az(r){return ir(r.map(e=>{const t=ze(e[0]);let n=Uint8Array.from(xr(t.code));return e.length>1&&e[1]!=null&&(n=ir([n,e[1]])),n}))}function _1e(r,e){if(r.size>0)return r.size/8;if(r.size===0)return 0;{const t=gs(e instanceof Uint8Array?e:Uint8Array.from(e));return t+gt(t)}}function cv(r){return"/"+r.trim().split("/").filter(e=>e).join("/")}class ax extends Error{constructor(t){super(`Error parsing address: ${t}`);u(this,"name","ParseError")}}u(ax,"name","ParseError");const T1e=Symbol.for("nodejs.util.inspect.custom"),Cz=Symbol.for("@multiformats/js-multiaddr/multiaddr"),P1e=[ze("dns").code,ze("dns4").code,ze("dns6").code,ze("dnsaddr").code];class D1e extends Error{constructor(e="No available resolver"){super(e),this.name="NoAvailableResolverError"}}var pN,Pd,Ha,Sp,xp;const ad=class ad{constructor(e){u(this,"bytes");Ge(this,Pd);Ge(this,Ha);Ge(this,Sp);Ge(this,xp);u(this,pN,!0);e==null&&(e="");let t;if(e instanceof Uint8Array)t=$_(e);else if(typeof e=="string"){if(e.length>0&&e.charAt(0)!=="/")throw new Error(`multiaddr "${e}" must start with a "/"`);t=k1e(e)}else if(Tw(e))t=$_(e.bytes);else throw new Error("addr must be a string, Buffer, or another Multiaddr");this.bytes=t.bytes,vt(this,Pd,t.string),vt(this,Ha,t.tuples),vt(this,Sp,t.stringTuples),vt(this,xp,t.path)}toString(){return se(this,Pd)}toJSON(){return this.toString()}toOptions(){let e,t,n,i,s="";const o=ze("tcp"),a=ze("udp"),c=ze("ip4"),l=ze("ip6"),d=ze("dns6"),h=ze("ip6zone");for(const[m,f]of this.stringTuples())m===h.code&&(s=`%${f??""}`),P1e.includes(m)&&(t=o.name==="tcp"?"tcp":"udp",i=443,n=`${f??""}${s}`,e=m===d.code?6:4),(m===o.code||m===a.code)&&(t=ze(m).name==="tcp"?"tcp":"udp",i=parseInt(f??"")),(m===c.code||m===l.code)&&(t=ze(m).name==="tcp"?"tcp":"udp",n=`${f??""}${s}`,e=m===l.code?6:4);if(e==null||t==null||n==null||i==null)throw new Error('multiaddr must have a valid format: "/{ip4, ip6, dns4, dns6, dnsaddr}/{address}/{tcp, udp}/{port}".');return{family:e,host:n,transport:t,port:i}}protos(){return se(this,Ha).map(([e])=>Object.assign({},ze(e)))}protoCodes(){return se(this,Ha).map(([e])=>e)}protoNames(){return se(this,Ha).map(([e])=>ze(e).name)}tuples(){return se(this,Ha).map(([e,t])=>t==null?[e]:[e,t])}stringTuples(){return se(this,Sp).map(([e,t])=>t==null?[e]:[e,t])}encapsulate(e){return e=new ad(e),new ad(this.toString()+e.toString())}decapsulate(e){const t=e.toString(),n=this.toString(),i=n.lastIndexOf(t);if(i<0)throw new Error(`Address ${this.toString()} does not contain subaddress: ${e.toString()}`);return new ad(n.slice(0,i))}decapsulateCode(e){const t=this.tuples();for(let n=t.length-1;n>=0;n--)if(t[n][0]===e)return new ad(Az(t.slice(0,n)));return this}getPeerId(){try{let e=[];this.stringTuples().forEach(([n,i])=>{n===tp.p2p.code&&e.push([n,i]),n===tp["p2p-circuit"].code&&(e=[])});const t=e.pop();if((t==null?void 0:t[1])!=null){const n=t[1];return n[0]==="Q"||n[0]==="1"?re(rs.decode(`z${n}`),"base58btc"):re(vz.parse(n).multihash.bytes,"base58btc")}return null}catch{return null}}getPath(){return se(this,xp)}equals(e){return He(this.bytes,e.bytes)}async resolve(e){const t=this.protos().find(s=>s.resolvable);if(t==null)return[this];const n=cx.get(t.name);if(n==null)throw new D1e(`no available resolver for ${t.name}`);return(await n(this,e)).map(s=>Re(s))}nodeAddress(){const e=this.toOptions();if(e.transport!=="tcp"&&e.transport!=="udp")throw new Error(`multiaddr must have a valid format - no protocol with name: "${e.transport}". Must have a valid transport protocol: "{tcp, udp}"`);return{family:e.family,address:e.host,port:e.port}}isThinWaistAddress(e){const t=(e??this).protos();return!(t.length!==2||t[0].code!==4&&t[0].code!==41||t[1].code!==6&&t[1].code!==273)}[(pN=Cz,T1e)](){return`Multiaddr(${se(this,Pd)})`}};Pd=new WeakMap,Ha=new WeakMap,Sp=new WeakMap,xp=new WeakMap;let lv=ad;const cx=new Map;function Tw(r){return!!(r!=null&&r[Cz])}function Re(r){return new lv(r)}const $1e=[ze("tcp").code,ze("dns").code,ze("dnsaddr").code,ze("dns4").code,ze("dns6").code];function N_(r){var e;return(e=Iz("sni",r))==null?void 0:e[1]}function M_(r){var t;const e=(t=Iz("tcp",r))==null?void 0:t[1];return e==null?"":`:${e}`}function Iz(r,e){let t;try{t=ze(r).code}catch{return}for(const[n,i]of e)if(n===t&&i!=null)return[n,i]}function O_(r){return r.some(([e,t])=>e===ze("tls").code)}function qi(r,e,t){const n=kz[ze(r).name];if(n==null)throw new Error(`Can't interpret protocol ${ze(r).name}`);const i=n(e,t);return r===ze("ip6").code?`[${i}]`:i}const kz={ip4:(r,e)=>r,ip6:(r,e)=>e.length===0?r:`[${r}]`,tcp:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`tcp://${qi(t[0],t[1]??"",e)}:${r}`},udp:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`udp://${qi(t[0],t[1]??"",e)}:${r}`},dnsaddr:(r,e)=>r,dns4:(r,e)=>r,dns6:(r,e)=>r,dns:(r,e)=>r,ipfs:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`${qi(t[0],t[1]??"",e)}`},p2p:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`${qi(t[0],t[1]??"",e)}`},http:(r,e)=>{const t=O_(e),n=N_(e),i=M_(e);if(t&&n!=null)return`https://${n}${i}`;const s=t?"https://":"http://",o=e.pop();if(o==null)throw new Error("Unexpected end of multiaddr");let a=qi(o[0],o[1]??"",e);return a=a.replace("tcp://",""),`${s}${a}`},"http-path":(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");const n=qi(t[0],t[1]??"",e),i=decodeURIComponent(r);return`${n}/${i}`},tls:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return qi(t[0],t[1]??"",e)},sni:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return qi(t[0],t[1]??"",e)},https:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");let n=qi(t[0],t[1]??"",e);return n=n.replace("tcp://",""),`https://${n}`},ws:(r,e)=>{const t=O_(e),n=N_(e),i=M_(e);if(t&&n!=null)return`wss://${n}${i}`;const s=t?"wss://":"ws://",o=e.pop();if(o==null)throw new Error("Unexpected end of multiaddr");let a=qi(o[0],o[1]??"",e);return a=a.replace("tcp://",""),`${s}${a}`},wss:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");let n=qi(t[0],t[1]??"",e);return n=n.replace("tcp://",""),`wss://${n}`}};function _z(r,e){const n=Re(r).stringTuples(),i=n.pop();if(i==null)throw new Error("Unexpected end of multiaddr");const s=ze(i[0]),o=kz[s.name];if(o==null)throw new Error(`No interpreter found for ${s.name}`);let a=o(i[1]??"",n);return $1e.includes(i[0])&&(a=a.replace(/^.*:\/\//,""),i[1]==="443"?a=`https://${a}`:a=`http://${a}`),(a.startsWith("http://")||a.startsWith("https://")||a.startsWith("ws://")||a.startsWith("wss://"))&&(a=new URL(a).toString(),a.endsWith("/")&&(a=a.substring(0,a.length-1))),a}let N1e=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseEncode");this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},M1e=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseDecode");u(this,"prefixCodePoint");this.name=e,this.prefix=t;const i=t.codePointAt(0);if(i===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=i,this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return Tz(this,e)}},O1e=class{constructor(e){u(this,"decoders");this.decoders=e}or(e){return Tz(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};function Tz(r,e){return new O1e({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}let R1e=class{constructor(e,t,n,i){u(this,"name");u(this,"prefix");u(this,"baseEncode");u(this,"baseDecode");u(this,"encoder");u(this,"decoder");this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=i,this.encoder=new N1e(e,t,n),this.decoder=new M1e(e,t,i)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};function L1e({name:r,prefix:e,encode:t,decode:n}){return new R1e(r,e,t,n)}function B1e(r,e,t,n){const i={};for(let d=0;d<e.length;++d)i[e[d]]=d;let s=r.length;for(;r[s-1]==="=";)--s;const o=new Uint8Array(s*t/8|0);let a=0,c=0,l=0;for(let d=0;d<s;++d){const h=i[r[d]];if(h===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|h,a+=t,a>=8&&(a-=8,o[l++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o}function U1e(r,e,t){const n=e[e.length-1]==="=",i=(1<<t)-1;let s="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,s+=e[i&a>>o];if(o!==0&&(s+=e[i&a<<t-o]),n)for(;s.length*t&7;)s+="=";return s}function Pw({name:r,prefix:e,bitsPerChar:t,alphabet:n}){return L1e({prefix:e,name:r,encode(i){return U1e(i,n,t)},decode(i){return B1e(i,n,t,r)}})}const F1e=Pw({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6});Pw({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6});Pw({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6});Pw({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});var Sl,xl,Dd,$d,Al,p3,Pz;class z1e{constructor(e,{logger:t,transformRequestInit:n}){Ge(this,p3);u(this,"url");Ge(this,Sl,0);Ge(this,xl,0);Ge(this,Dd,0);Ge(this,$d,0);Ge(this,Al,new Map);u(this,"log");u(this,"transformRequestInit");this.url=e instanceof URL?e:new URL(e),this.transformRequestInit=n,this.log=t.forComponent(`helia:trustless-gateway-block-broker:${this.url.hostname}`)}async getRawBlock(e,t){const n=new URL(this.url.toString());if(n.pathname=`/ipfs/${e.toString()}`,n.search="?format=raw",(t==null?void 0:t.aborted)===!0)throw new Error(`Signal to fetch raw block for CID ${e} from gateway ${this.url} was aborted prior to fetch`);const i=Ie(this,p3,Pz).call(this,e),s=new AbortController,o=()=>{s.abort()};t==null||t.addEventListener("abort",o);try{let a=se(this,Al).get(i);if(a==null){Es(this,Sl)._++;const c={signal:s.signal,headers:{Accept:"application/vnd.ipld.raw"},cache:"force-cache"},l=this.transformRequestInit!=null?await this.transformRequestInit(c):c;a=fetch(n.toString(),l).then(async d=>{if(this.log("GET %s %d",n,d.status),!d.ok)throw Es(this,xl)._++,new Error(`unable to fetch raw block for CID ${e} from gateway ${this.url}`);return Es(this,$d)._++,new Uint8Array(await d.arrayBuffer())}),se(this,Al).set(i,a)}return await a}catch{throw(t==null?void 0:t.aborted)===!0?new Error(`fetching raw block for CID ${e} from gateway ${this.url} was aborted`):(Es(this,xl)._++,new Error(`unable to fetch raw block for CID ${e}`))}finally{t==null||t.removeEventListener("abort",o),se(this,Al).delete(i)}}reliability(){return se(this,Sl)===0?1:se(this,Dd)>0?-1/0:se(this,$d)/(se(this,Sl)+se(this,xl)*3)}incrementInvalidBlocks(){Es(this,Dd)._++}getStats(){return{attempts:se(this,Sl),errors:se(this,xl),invalidBlocks:se(this,Dd),successes:se(this,$d),pendingResponses:se(this,Al).size}}}Sl=new WeakMap,xl=new WeakMap,Dd=new WeakMap,$d=new WeakMap,Al=new WeakMap,p3=new WeakSet,Pz=function(e){const t=e.multihash.bytes;return F1e.encode(t)};function V1e(r,e,t){return r.filter(n=>{if(Lhe.matches(n)||e&&Ohe.matches(n))return t||sz.matches(n)?!0:zc(n.toOptions().host)===!1;if(!e&&t){const{host:i}=n.toOptions();if(i==="127.0.0.1"||i==="localhost"||i.endsWith(".localhost"))return!0}return!1})}async function*Dz(r,e,t,n,i,s={}){for await(const o of e.findProviders(r,s)){const a=V1e(o.multiaddrs,n,i);if(a.length===0)continue;const c=_z(a[0]);yield new z1e(c,{logger:t,transformRequestInit:s.transformRequestInit})}}class K1e extends QF{constructor(t,n){super(t,{...n,name:"helia:trustless-gateway:session"});u(this,"routing");u(this,"allowInsecure");u(this,"allowLocal");u(this,"transformRequestInit");this.routing=t.routing,this.allowInsecure=n.allowInsecure??$z,this.allowLocal=n.allowLocal??Nz,this.transformRequestInit=n.transformRequestInit}async queryProvider(t,n,i){var o;this.log("fetching BLOCK for %c from %s",t,n.url);const s=await n.getRawBlock(t,i.signal);return this.log.trace("got block for %c from %s",t,n.url),await((o=i.validateFn)==null?void 0:o.call(i,s)),s}async*findNewProviders(t,n={}){yield*Dz(t,this.routing,this.logger,this.allowInsecure,this.allowLocal,{...n,transformRequestInit:this.transformRequestInit})}toEvictionKey(t){return t.url.toString()}equals(t,n){return t.url.toString()===n.url.toString()}}function j1e(r,e){return new K1e(r,e)}class H1e{constructor(e,t={}){u(this,"allowInsecure");u(this,"allowLocal");u(this,"transformRequestInit");u(this,"routing");u(this,"log");u(this,"logger");this.log=e.logger.forComponent("helia:trustless-gateway-block-broker"),this.logger=e.logger,this.routing=e.routing,this.allowInsecure=t.allowInsecure??$z,this.allowLocal=t.allowLocal??Nz,this.transformRequestInit=t.transformRequestInit}async retrieve(e,t={}){var i,s;const n=[];for await(const o of Dz(e,this.routing,this.logger,this.allowInsecure,this.allowLocal,{...t,transformRequestInit:this.transformRequestInit})){this.log("getting block for %c from %s",e,o.url);try{const a=await o.getRawBlock(e,t.signal);this.log.trace("got block for %c from %s",e,o.url);try{await((i=t.validateFn)==null?void 0:i.call(t,a))}catch(c){this.log.error("failed to validate block for %c from %s",e,o.url,c);continue}return a}catch(a){if(this.log.error("failed to get block for %c from %s",e,o.url,a),a instanceof Error?n.push(a):n.push(new Error(`Unable to fetch raw block for CID ${e} from gateway ${o.url}`)),((s=t.signal)==null?void 0:s.aborted)===!0){this.log.trace("request aborted while fetching raw block for CID %c from gateway %s",e,o.url);break}}}throw n.length>0?new AggregateError(n,`Unable to fetch raw block for CID ${e} from any gateway`):new Error(`Unable to fetch raw block for CID ${e} from any gateway`)}createSession(e={}){return j1e({logger:this.logger,routing:this.routing},{...e,allowLocal:this.allowLocal,allowInsecure:this.allowInsecure,transformRequestInit:this.transformRequestInit})}}const $z=!1,Nz=!1;function q1e(r={}){return e=>new H1e(e,r)}async function*R_(r,e={}){const t=r.getReader();try{for(;;){const n=await t.read();if(n.done)return;yield n.value}}finally{e.preventCancel!==!0&&await t.cancel(),t.releaseLock()}}var Mz={exports:{}};(function(r){(function(){r.exports=v;var e=86400,t=3200,n=146097*t/400,i=e*n,s=1e3*i,o=864e13,a=4294967296,c=1e6,l="000000000",d=Math.trunc||function(T){var L=T-T%1;return L==0&&(T<0||T===0&&1/T!=1/0)?-0:L},h=v.prototype,p=(v.fromDate=function(T){return new v(+T)},v.fromInt64BE=A(0,1,2,3,0,4),v.fromInt64LE=A(3,2,1,0,4,0),v.fromString=function(B){var L,z=new v,B=(B+="").replace(/^\s*[+\-]?\d+/,function(j){var j=+j,q=1970+(j-1970)%400;return z.year=j-q,q}).replace(/(?:Z|([+\-]\d{2}):?(\d{2}))$/,function(G,j,q){return j<0&&(q*=-1),L=6e4*(60*+j+ +q),""}).replace(/\.\d+$/,function(G){return z.nano=+(G+l).substr(1,9),""}).split(/\D+/);if(1<B.length?B[1]--:B[1]=0,z.time=L=Date.UTC.apply(Date,B)-(L||0),isNaN(L))throw new TypeError("Invalid Date");return y(z)},v.fromTimeT=function(T){return b(T,0)},h.year=0,h.time=0,h.nano=0,h.addNano=function(T){return this.nano+=+T||0,this},h.getNano=function(){var T=y(this);return(T.time%1e3*c+ +T.nano+1e9)%1e9},h.getTimeT=function(){var L=y(this),T=Math.floor(L.time/1e3),L=L.year;return L&&(T+=L*n*e/t),T},h.getYear=function(){return this.toDate().getUTCFullYear()+this.year},h.toDate=function(){return w(y(this).time)},h.toJSON=function(){return this.toString().replace(/0{1,6}Z$/,"Z")},h.toString=function(T){var L=this,z=L.toDate(),B={H:function(){return x(z.getUTCHours())},L:function(){return I(z.getUTCMilliseconds(),3)},M:function(){return x(z.getUTCMinutes())},N:function(){return I(L.getNano(),9)},S:function(){return x(z.getUTCSeconds())},Y:function(){var G=L.getYear();return 999999<G?"+"+G:9999<G?"+"+I(G,6):0<=G?I(G,4):-999999<=G?"-"+I(-G,6):G},a:function(){return f[z.getUTCDay()]},b:function(){return m[z.getUTCMonth()]},d:function(){return x(z.getUTCDate())},e:function(){return function(G){return(9<G?"":" ")+(0|G)}(z.getUTCDate())},m:function(){return x(z.getUTCMonth()+1)}};return function G(j){return j.replace(/%./g,function(q){var K=q[1],Q=g[K],K=B[K];return Q?G(Q):K?K():q})}(T||p)},h.writeInt64BE=E(0,1,2,3,0,4),h.writeInt64LE=E(3,2,1,0,4,0),"%Y-%m-%dT%H:%M:%S.%NZ"),m=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],f=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],g={"%":"%",F:"%Y-%m-%d",n:`
`,R:"%H:%M",T:"%H:%M:%S",t:"	",X:"%T",Z:"GMT",z:"+0000"};return v;function v(T,L,z){var B=this;if(!(B instanceof v))return new v(T,L,z);B.time=+T||0,B.nano=+L||0,B.year=+z||0,y(B)}function y(T){var L,z,B,G=T.year,j=T.time,q=T.nano,Q=((q<0||c<=q)&&(q-=(z=Math.floor(q/c))*c,j+=z,z=1),G%t);return(j<-864e13||o<j||Q)&&((L=d(j/s))&&(G+=L*t,j-=L*s),(B=w(j)).setUTCFullYear(Q+B.getUTCFullYear()),B=(j=+B)+(L=d((G-=Q)/t))*s,L&&-864e13<=B&&B<=o&&(G-=L*t,j=B),z=1),z&&(T.year=G,T.time=j,T.nano=q),T}function w(T){var L=new Date(0);return L.setTime(T),L}function b(G,B){G=+G||0;var z=d((B=(B|0)*a)/i)+d(G/i),B=B%i+G%i,G=d(B/i);return G&&(z+=G,B-=G*i),new v(1e3*B,0,z*t)}function E(T,L,z,B,G,j){return function(Q,K){var U=y(this);Q=Q||new Array(8),k(Q,K|=0);var W=Math.floor(U.time/1e3),U=U.year*(n*e/t),O=d(U/a)+d(W/a),U=U%a+W%a,W=Math.floor(U/a);return W&&(O+=W,U-=W*a),q(Q,K+G,O),q(Q,K+j,U),Q};function q(Q,K,O){Q[K+T]=O>>24&255,Q[K+L]=O>>16&255,Q[K+z]=O>>8&255,Q[K+B]=255&O}}function A(T,L,z,B,G,j){return function(Q,K){k(Q,K|=0);var O=q(Q,K+G);return b(q(Q,K+j),O)};function q(Q,K){return 16777216*Q[K+T]+(Q[K+L]<<16|Q[K+z]<<8|Q[K+B])}}function k(T,L){if(T=T&&T.length,T==null)throw new TypeError("Invalid Buffer");if(T<L+8)throw new RangeError("Out of range")}function x(T){return(9<T?"":"0")+(0|T)}function I(T,L){return(l+(0|T)).substr(-L)}})()})(Mz);var W1e=Mz.exports;const uv=Nc(W1e);class Ka extends Error{constructor(e="Record signature verification failed"){super(e),this.name="SignatureVerificationError"}}u(Ka,"name","SignatureVerificationError");class Oz extends Error{constructor(e="Record has expired"){super(e),this.name="RecordExpiredError"}}u(Oz,"name","RecordExpiredError");class lx extends Error{constructor(e="The validity type is unsupported"){super(e),this.name="UnsupportedValidityError"}}u(lx,"name","UnsupportedValidityError");class Rz extends Error{constructor(e="The record is too large"){super(e),this.name="RecordTooLargeError"}}u(Rz,"name","RecordTooLargeError");class Lz extends Error{constructor(e="Value must be a valid content path starting with /"){super(e),this.name="InvalidValueError"}}u(Lz,"name","InvalidValueError");class Bz extends Error{constructor(e="Invalid record data"){super(e),this.name="InvalidRecordDataError"}}u(Bz,"name","InvalidRecordDataError");class dv extends Error{constructor(e="Invalid embedded public key"){super(e),this.name="InvalidEmbeddedPublicKeyError"}}u(dv,"name","InvalidEmbeddedPublicKeyError");var ls;(function(r){(function(n){n.EOL="EOL"})(r.ValidityType||(r.ValidityType={}));let e;(function(n){n[n.EOL=0]="EOL"})(e||(e={})),function(n){n.codec=()=>On(e)}(r.ValidityType||(r.ValidityType={}));let t;r.codec=()=>(t==null&&(t=$e((n,i,s={})=>{s.lengthDelimited!==!1&&i.fork(),n.value!=null&&(i.uint32(10),i.bytes(n.value)),n.signatureV1!=null&&(i.uint32(18),i.bytes(n.signatureV1)),n.validityType!=null&&(i.uint32(24),r.ValidityType.codec().encode(n.validityType,i)),n.validity!=null&&(i.uint32(34),i.bytes(n.validity)),n.sequence!=null&&(i.uint32(40),i.uint64(n.sequence)),n.ttl!=null&&(i.uint32(48),i.uint64(n.ttl)),n.pubKey!=null&&(i.uint32(58),i.bytes(n.pubKey)),n.signatureV2!=null&&(i.uint32(66),i.bytes(n.signatureV2)),n.data!=null&&(i.uint32(74),i.bytes(n.data)),s.lengthDelimited!==!1&&i.ldelim()},(n,i,s={})=>{const o={},a=i==null?n.len:n.pos+i;for(;n.pos<a;){const c=n.uint32();switch(c>>>3){case 1:{o.value=n.bytes();break}case 2:{o.signatureV1=n.bytes();break}case 3:{o.validityType=r.ValidityType.codec().decode(n);break}case 4:{o.validity=n.bytes();break}case 5:{o.sequence=n.uint64();break}case 6:{o.ttl=n.uint64();break}case 7:{o.pubKey=n.bytes();break}case 8:{o.signatureV2=n.bytes();break}case 9:{o.data=n.bytes();break}default:{n.skipType(c&7);break}}}return o})),t),r.encode=n=>De(n,r.codec()),r.decode=(n,i)=>Pe(n,r.codec(),i)})(ls||(ls={}));function G1e(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function ux(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function Q1e(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var i=0;i<r.length;i++){var s=r.charAt(i),o=s.charCodeAt(0);if(t[o]!==255)throw new TypeError(s+" is ambiguous");t[o]=i}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),d=Math.log(256)/Math.log(a);function h(f){if(f instanceof Uint8Array||(ArrayBuffer.isView(f)?f=new Uint8Array(f.buffer,f.byteOffset,f.byteLength):Array.isArray(f)&&(f=Uint8Array.from(f))),!(f instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(f.length===0)return"";for(var g=0,v=0,y=0,w=f.length;y!==w&&f[y]===0;)y++,g++;for(var b=(w-y)*d+1>>>0,E=new Uint8Array(b);y!==w;){for(var A=f[y],k=0,x=b-1;(A!==0||k<v)&&x!==-1;x--,k++)A+=256*E[x]>>>0,E[x]=A%a>>>0,A=A/a>>>0;if(A!==0)throw new Error("Non-zero carry");v=k,y++}for(var I=b-v;I!==b&&E[I]===0;)I++;for(var T=c.repeat(g);I<b;++I)T+=r.charAt(E[I]);return T}function p(f){if(typeof f!="string")throw new TypeError("Expected String");if(f.length===0)return new Uint8Array;var g=0;if(f[g]!==" "){for(var v=0,y=0;f[g]===c;)v++,g++;for(var w=(f.length-g)*l+1>>>0,b=new Uint8Array(w);f[g];){var E=t[f.charCodeAt(g)];if(E===255)return;for(var A=0,k=w-1;(E!==0||A<y)&&k!==-1;k--,A++)E+=a*b[k]>>>0,b[k]=E%256>>>0,E=E/256>>>0;if(E!==0)throw new Error("Non-zero carry");y=A,g++}if(f[g]!==" "){for(var x=w-y;x!==w&&b[x]===0;)x++;for(var I=new Uint8Array(v+(w-x)),T=v;x!==w;)I[T++]=b[x++];return I}}}function m(f){var g=p(f);if(g)return g;throw new Error(`Non-${e} character`)}return{encode:h,decodeUnsafe:p,decode:m}}var Y1e=Q1e,J1e=Y1e;let X1e=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseEncode");this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},Z1e=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseDecode");u(this,"prefixCodePoint");this.name=e,this.prefix=t;const i=t.codePointAt(0);if(i===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=i,this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return Uz(this,e)}},epe=class{constructor(e){u(this,"decoders");this.decoders=e}or(e){return Uz(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};function Uz(r,e){return new epe({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}let tpe=class{constructor(e,t,n,i){u(this,"name");u(this,"prefix");u(this,"baseEncode");u(this,"baseDecode");u(this,"encoder");u(this,"decoder");this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=i,this.encoder=new X1e(e,t,n),this.decoder=new Z1e(e,t,i)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};function Fz({name:r,prefix:e,encode:t,decode:n}){return new tpe(r,e,t,n)}function Dw({name:r,prefix:e,alphabet:t}){const{encode:n,decode:i}=J1e(t,r);return Fz({prefix:e,name:r,encode:n,decode:s=>ux(i(s))})}function rpe(r,e,t,n){const i={};for(let d=0;d<e.length;++d)i[e[d]]=d;let s=r.length;for(;r[s-1]==="=";)--s;const o=new Uint8Array(s*t/8|0);let a=0,c=0,l=0;for(let d=0;d<s;++d){const h=i[r[d]];if(h===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|h,a+=t,a>=8&&(a-=8,o[l++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o}function npe(r,e,t){const n=e[e.length-1]==="=",i=(1<<t)-1;let s="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,s+=e[i&a>>o];if(o!==0&&(s+=e[i&a<<t-o]),n)for(;s.length*t&7;)s+="=";return s}function ea({name:r,prefix:e,bitsPerChar:t,alphabet:n}){return Fz({prefix:e,name:r,encode(i){return npe(i,n,t)},decode(i){return rpe(i,n,t,r)}})}const u8=Dw({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"});Dw({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});const r2=ea({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});ea({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});ea({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});ea({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});ea({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});ea({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});ea({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});ea({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});ea({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const Na=Dw({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});Dw({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var ipe=zz,L_=128,spe=-128,ope=Math.pow(2,31);function zz(r,e,t){e=e||[],t=t||0;for(var n=t;r>=ope;)e[t++]=r&255|L_,r/=128;for(;r&spe;)e[t++]=r&255|L_,r>>>=7;return e[t]=r|0,zz.bytes=t-n+1,e}var ape=hv,cpe=128,B_=127;function hv(r,n){var t=0,n=n||0,i=0,s=n,o,a=r.length;do{if(s>=a)throw hv.bytes=0,new RangeError("Could not decode varint");o=r[s++],t+=i<28?(o&B_)<<i:(o&B_)*Math.pow(2,i),i+=7}while(o>=cpe);return hv.bytes=s-n,t}var lpe=Math.pow(2,7),upe=Math.pow(2,14),dpe=Math.pow(2,21),hpe=Math.pow(2,28),fpe=Math.pow(2,35),ppe=Math.pow(2,42),gpe=Math.pow(2,49),ype=Math.pow(2,56),mpe=Math.pow(2,63),wpe=function(r){return r<lpe?1:r<upe?2:r<dpe?3:r<hpe?4:r<fpe?5:r<ppe?6:r<gpe?7:r<ype?8:r<mpe?9:10},bpe={encode:ipe,decode:ape,encodingLength:wpe},qy=bpe;function fv(r,e=0){return[qy.decode(r,e),qy.decode.bytes]}function Wy(r,e,t=0){return qy.encode(r,e,t),e}function Gy(r){return qy.encodingLength(r)}function vpe(r,e){const t=e.byteLength,n=Gy(r),i=n+Gy(t),s=new Uint8Array(i+t);return Wy(r,s,0),Wy(t,s,n),s.set(e,i),new dx(r,t,e,s)}function Vz(r){const e=ux(r),[t,n]=fv(e),[i,s]=fv(e.subarray(n)),o=e.subarray(n+s);if(o.byteLength!==i)throw new Error("Incorrect length");return new dx(t,i,o,e)}function Epe(r,e){if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&G1e(r.bytes,t.bytes)}}let dx=class{constructor(e,t,n,i){u(this,"code");u(this,"size");u(this,"digest");u(this,"bytes");this.code=e,this.size=t,this.digest=n,this.bytes=i}};function U_(r,e){const{bytes:t,version:n}=r;switch(n){case 0:return xpe(t,pv(r),e??Na.encoder);default:return Ape(t,pv(r),e??r2.encoder)}}const F_=new WeakMap;function pv(r){const e=F_.get(r);if(e==null){const t=new Map;return F_.set(r,t),t}return e}var gN;let z_=class Kr{constructor(e,t,n,i){u(this,"code");u(this,"version");u(this,"multihash");u(this,"bytes");u(this,"/");u(this,gN,"CID");this.code=t,this.version=e,this.multihash=n,this.bytes=i,this["/"]=i}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==_f)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==Cpe)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return Kr.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=vpe(e,t);return Kr.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return Kr.equals(this,e)}static equals(e,t){const n=t;return n!=null&&e.code===n.code&&e.version===n.version&&Epe(e.multihash,n.multihash)}toString(e){return U_(this,e)}toJSON(){return{"/":U_(this)}}link(){return this}[(gN=Symbol.toStringTag,Symbol.for("nodejs.util.inspect.custom"))](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof Kr)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:i,multihash:s,bytes:o}=t;return new Kr(n,i,s,o??V_(n,i,s.bytes))}else if(t[Ipe]===!0){const{version:n,multihash:i,code:s}=t,o=Vz(i);return Kr.create(n,s,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==_f)throw new Error(`Version 0 CID must use dag-pb (code: ${_f}) block encoding`);return new Kr(e,t,n,n.bytes)}case 1:{const i=V_(e,t,n.bytes);return new Kr(e,t,n,i)}default:throw new Error("Invalid version")}}static createV0(e){return Kr.create(0,_f,e)}static createV1(e,t){return Kr.create(1,e,t)}static decode(e){const[t,n]=Kr.decodeFirst(e);if(n.length!==0)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=Kr.inspectBytes(e),n=t.size-t.multihashSize,i=ux(e.subarray(n,n+t.multihashSize));if(i.byteLength!==t.multihashSize)throw new Error("Incorrect length");const s=i.subarray(t.multihashSize-t.digestSize),o=new dx(t.multihashCode,t.digestSize,s,i);return[t.version===0?Kr.createV0(o):Kr.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[h,p]=fv(e.subarray(t));return t+=p,h};let i=n(),s=_f;if(i===18?(i=0,t=0):s=n(),i!==0&&i!==1)throw new RangeError(`Invalid CID version ${i}`);const o=t,a=n(),c=n(),l=t+c,d=l-o;return{version:i,codec:s,multihashCode:a,digestSize:c,multihashSize:d,size:l}}static parse(e,t){const[n,i]=Spe(e,t),s=Kr.decode(i);if(s.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return pv(s).set(n,e),s}};function Spe(r,e){switch(r[0]){case"Q":{const t=e??Na;return[Na.prefix,t.decode(`${Na.prefix}${r}`)]}case Na.prefix:{const t=e??Na;return[Na.prefix,t.decode(r)]}case r2.prefix:{const t=e??r2;return[r2.prefix,t.decode(r)]}case u8.prefix:{const t=e??u8;return[u8.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}}function xpe(r,e,t){const{prefix:n}=t;if(n!==Na.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const i=e.get(n);if(i==null){const s=t.encode(r).slice(1);return e.set(n,s),s}else return i}function Ape(r,e,t){const{prefix:n}=t,i=e.get(n);if(i==null){const s=t.encode(r);return e.set(n,s),s}else return i}const _f=112,Cpe=18;function V_(r,e,t){const n=Gy(r),i=n+Gy(e),s=new Uint8Array(i+t.byteLength);return Wy(r,s,0),Wy(e,s,n),s.set(t,i),s}const Ipe=Symbol.for("@ipld/js-cid/CID"),kpe=Rh("ipns:utils"),Kz=oe("/ipns/"),_pe=0,Tpe=18;function Ppe(r){let e;if(r.pubKey!=null)try{e=Rn(r.pubKey)}catch(t){throw kpe.error(t),t}if(e!=null)return e}function Dpe(r){const e=oe("ipns-signature:");return ir([e,r])}function jz(r){return"signatureV1"in r?ls.encode({value:oe(r.value),signatureV1:r.signatureV1,validityType:r.validityType,validity:oe(r.validity),sequence:r.sequence,ttl:r.ttl,pubKey:r.pubKey,signatureV2:r.signatureV2,data:r.data}):ls.encode({pubKey:r.pubKey,signatureV2:r.signatureV2,data:r.data})}function qp(r){const e=ls.decode(r);if(e.sequence!=null&&(e.sequence=BigInt(e.sequence)),e.ttl!=null&&(e.ttl=BigInt(e.ttl)),e.signatureV2==null||e.data==null)throw new Ka("Missing data or signatureV2");const t=qz(e.data),n=$pe(t.Value),i=re(t.Validity);if(e.value!=null&&e.signatureV1!=null)return Npe(e),{value:n,validityType:ls.ValidityType.EOL,validity:i,sequence:t.Sequence,ttl:t.TTL,pubKey:e.pubKey,signatureV1:e.signatureV1,signatureV2:e.signatureV2,data:e.data};if(e.signatureV2!=null)return{value:n,validityType:ls.ValidityType.EOL,validity:i,sequence:t.Sequence,ttl:t.TTL,pubKey:e.pubKey,signatureV2:e.signatureV2,data:e.data};throw new Error("invalid record: does not include signatureV1 or signatureV2")}function Hz(r){return ir([Kz,r.bytes])}function gv(r){const e=Vz(r.slice(Kz.length));if(!yv(e,_pe)&&!yv(e,Tpe))throw new ew("Multihash in IPNS key was not identity or sha2-256");return e}function qz(r){const e=za(r);if(e.ValidityType===0)e.ValidityType=ls.ValidityType.EOL;else throw new lx("The validity type is unsupported");return Number.isInteger(e.Sequence)&&(e.Sequence=BigInt(e.Sequence)),Number.isInteger(e.TTL)&&(e.TTL=BigInt(e.TTL)),e}function $pe(r){const e=re(r).trim();if(e.startsWith("/"))return e;try{return`/ipfs/${z_.decode(r).toV1().toString()}`}catch{}try{return`/ipfs/${z_.parse(e).toV1().toString()}`}catch{}throw new Lz("Value must be a valid content path starting with /")}function Npe(r){if(r.data==null)throw new Bz("Record data is missing");const e=qz(r.data);if(!He(e.Value,r.value??new Uint8Array(0)))throw new Ka('Field "value" did not match between protobuf and CBOR');if(!He(e.Validity,r.validity??new Uint8Array(0)))throw new Ka('Field "validity" did not match between protobuf and CBOR');if(e.ValidityType!==r.validityType)throw new Ka('Field "validityType" did not match between protobuf and CBOR');if(e.Sequence!==r.sequence)throw new Ka('Field "sequence" did not match between protobuf and CBOR');if(e.TTL!==r.ttl)throw new Ka('Field "ttl" did not match between protobuf and CBOR')}function yv(r,e){return r.code===e}const sg=Rh("ipns:validator"),Mpe=1024*10,Ope=async(r,e)=>{const t=qp(e);let n;try{const i=Dpe(t.data);n=await r.verify(i,t.signatureV2)}catch{n=!1}if(!n)throw sg.error("record signature verification failed"),new Ka("Record signature verification failed");if(t.validityType===ls.ValidityType.EOL){if(uv.fromString(t.validity).toDate().getTime()<Date.now())throw sg.error("record has expired"),new Oz("record has expired")}else if(t.validityType!=null)throw sg.error("the validity type is unsupported"),new lx("The validity type is unsupported");sg("ipns record for %s is valid",t.value)};async function Wz(r,e){if(e.byteLength>Mpe)throw new Rz("The record is too large");const t=gv(r);let n;yv(t,0)&&(n=hU(t));const i=qp(e),s=Ppe(i)??n;if(s==null)throw new dv("Could not extract public key from IPNS record or routing key");const o=Hz(s.toMultihash());if(!He(o,r))throw new dv("Embedded public key did not match routing key");await Ope(s,e)}let Rpe=class extends Error{constructor(){super(...arguments);u(this,"name","InvalidMessageLengthError");u(this,"code","ERR_INVALID_MESSAGE_LENGTH")}};async function*K_(r,e={}){const t=/\r?\n/,n=new TextDecoder("utf8");let i="";for await(let s of r){if(typeof s=="string"&&(s=new TextEncoder().encode(s)),Ff(s)&&(s=s.subarray()),i+=n.decode(s,{stream:!0}),i.length>((e==null?void 0:e.maxMessageLength)??i.length))throw new Rpe("Incoming message too long");const o=i.split(t);i=o.pop()??"";for(let a=0;a<o.length;a++)yield JSON.parse(o[a])}i+=n.decode(),i!==""&&(yield JSON.parse(i))}class n2 extends Error{constructor(e="Invalid request"){super(e),this.name="InvalidRequestError"}}u(n2,"name","InvalidRequestError");class ho extends Error{constructor(e="Bad response"){super(e),this.name="BadResponseError"}}u(ho,"name","BadResponseError");function Lpe(r){return r[Symbol.asyncIterator]!=null}function Bpe(r){if(Lpe(r))return(async()=>{for await(const e of r)return e})();for(const e of r)return e}function Upe(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function hx(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function Fpe(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var i=0;i<r.length;i++){var s=r.charAt(i),o=s.charCodeAt(0);if(t[o]!==255)throw new TypeError(s+" is ambiguous");t[o]=i}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),d=Math.log(256)/Math.log(a);function h(f){if(f instanceof Uint8Array||(ArrayBuffer.isView(f)?f=new Uint8Array(f.buffer,f.byteOffset,f.byteLength):Array.isArray(f)&&(f=Uint8Array.from(f))),!(f instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(f.length===0)return"";for(var g=0,v=0,y=0,w=f.length;y!==w&&f[y]===0;)y++,g++;for(var b=(w-y)*d+1>>>0,E=new Uint8Array(b);y!==w;){for(var A=f[y],k=0,x=b-1;(A!==0||k<v)&&x!==-1;x--,k++)A+=256*E[x]>>>0,E[x]=A%a>>>0,A=A/a>>>0;if(A!==0)throw new Error("Non-zero carry");v=k,y++}for(var I=b-v;I!==b&&E[I]===0;)I++;for(var T=c.repeat(g);I<b;++I)T+=r.charAt(E[I]);return T}function p(f){if(typeof f!="string")throw new TypeError("Expected String");if(f.length===0)return new Uint8Array;var g=0;if(f[g]!==" "){for(var v=0,y=0;f[g]===c;)v++,g++;for(var w=(f.length-g)*l+1>>>0,b=new Uint8Array(w);f[g];){var E=t[f.charCodeAt(g)];if(E===255)return;for(var A=0,k=w-1;(E!==0||A<y)&&k!==-1;k--,A++)E+=a*b[k]>>>0,b[k]=E%256>>>0,E=E/256>>>0;if(E!==0)throw new Error("Non-zero carry");y=A,g++}if(f[g]!==" "){for(var x=w-y;x!==w&&b[x]===0;)x++;for(var I=new Uint8Array(v+(w-x)),T=v;x!==w;)I[T++]=b[x++];return I}}}function m(f){var g=p(f);if(g)return g;throw new Error(`Non-${e} character`)}return{encode:h,decodeUnsafe:p,decode:m}}var zpe=Fpe,Vpe=zpe;let Kpe=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseEncode");this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},jpe=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseDecode");u(this,"prefixCodePoint");this.name=e,this.prefix=t;const i=t.codePointAt(0);if(i===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=i,this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return Gz(this,e)}},Hpe=class{constructor(e){u(this,"decoders");this.decoders=e}or(e){return Gz(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};function Gz(r,e){return new Hpe({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}let qpe=class{constructor(e,t,n,i){u(this,"name");u(this,"prefix");u(this,"baseEncode");u(this,"baseDecode");u(this,"encoder");u(this,"decoder");this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=i,this.encoder=new Kpe(e,t,n),this.decoder=new jpe(e,t,i)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};function Qz({name:r,prefix:e,encode:t,decode:n}){return new qpe(r,e,t,n)}function $w({name:r,prefix:e,alphabet:t}){const{encode:n,decode:i}=Vpe(t,r);return Qz({prefix:e,name:r,encode:n,decode:s=>hx(i(s))})}function Wpe(r,e,t,n){const i={};for(let d=0;d<e.length;++d)i[e[d]]=d;let s=r.length;for(;r[s-1]==="=";)--s;const o=new Uint8Array(s*t/8|0);let a=0,c=0,l=0;for(let d=0;d<s;++d){const h=i[r[d]];if(h===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|h,a+=t,a>=8&&(a-=8,o[l++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o}function Gpe(r,e,t){const n=e[e.length-1]==="=",i=(1<<t)-1;let s="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,s+=e[i&a>>o];if(o!==0&&(s+=e[i&a<<t-o]),n)for(;s.length*t&7;)s+="=";return s}function ta({name:r,prefix:e,bitsPerChar:t,alphabet:n}){return Qz({prefix:e,name:r,encode(i){return Gpe(i,n,t)},decode(i){return Wpe(i,n,t,r)}})}const i2=ta({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});ta({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});ta({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});ta({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});ta({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});ta({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});ta({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});ta({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});ta({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const d8=$w({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"});$w({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});const Ma=$w({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});$w({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var Qpe=Yz,j_=128,Ype=-128,Jpe=Math.pow(2,31);function Yz(r,e,t){e=e||[],t=t||0;for(var n=t;r>=Jpe;)e[t++]=r&255|j_,r/=128;for(;r&Ype;)e[t++]=r&255|j_,r>>>=7;return e[t]=r|0,Yz.bytes=t-n+1,e}var Xpe=mv,Zpe=128,H_=127;function mv(r,n){var t=0,n=n||0,i=0,s=n,o,a=r.length;do{if(s>=a)throw mv.bytes=0,new RangeError("Could not decode varint");o=r[s++],t+=i<28?(o&H_)<<i:(o&H_)*Math.pow(2,i),i+=7}while(o>=Zpe);return mv.bytes=s-n,t}var e0e=Math.pow(2,7),t0e=Math.pow(2,14),r0e=Math.pow(2,21),n0e=Math.pow(2,28),i0e=Math.pow(2,35),s0e=Math.pow(2,42),o0e=Math.pow(2,49),a0e=Math.pow(2,56),c0e=Math.pow(2,63),l0e=function(r){return r<e0e?1:r<t0e?2:r<r0e?3:r<n0e?4:r<i0e?5:r<s0e?6:r<o0e?7:r<a0e?8:r<c0e?9:10},u0e={encode:Qpe,decode:Xpe,encodingLength:l0e},Qy=u0e;function wv(r,e=0){return[Qy.decode(r,e),Qy.decode.bytes]}function Yy(r,e,t=0){return Qy.encode(r,e,t),e}function Jy(r){return Qy.encodingLength(r)}function d0e(r,e){const t=e.byteLength,n=Jy(r),i=n+Jy(t),s=new Uint8Array(i+t);return Yy(r,s,0),Yy(t,s,n),s.set(e,i),new fx(r,t,e,s)}function h0e(r){const e=hx(r),[t,n]=wv(e),[i,s]=wv(e.subarray(n)),o=e.subarray(n+s);if(o.byteLength!==i)throw new Error("Incorrect length");return new fx(t,i,o,e)}function f0e(r,e){if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&Upe(r.bytes,t.bytes)}}let fx=class{constructor(e,t,n,i){u(this,"code");u(this,"size");u(this,"digest");u(this,"bytes");this.code=e,this.size=t,this.digest=n,this.bytes=i}};function q_(r,e){const{bytes:t,version:n}=r;switch(n){case 0:return g0e(t,bv(r),e??Ma.encoder);default:return y0e(t,bv(r),e??i2.encoder)}}const W_=new WeakMap;function bv(r){const e=W_.get(r);if(e==null){const t=new Map;return W_.set(r,t),t}return e}var yN;let G_=class jr{constructor(e,t,n,i){u(this,"code");u(this,"version");u(this,"multihash");u(this,"bytes");u(this,"/");u(this,yN,"CID");this.code=t,this.version=e,this.multihash=n,this.bytes=i,this["/"]=i}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==Tf)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==m0e)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return jr.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=d0e(e,t);return jr.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return jr.equals(this,e)}static equals(e,t){const n=t;return n!=null&&e.code===n.code&&e.version===n.version&&f0e(e.multihash,n.multihash)}toString(e){return q_(this,e)}toJSON(){return{"/":q_(this)}}link(){return this}[(yN=Symbol.toStringTag,Symbol.for("nodejs.util.inspect.custom"))](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof jr)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:i,multihash:s,bytes:o}=t;return new jr(n,i,s,o??Q_(n,i,s.bytes))}else if(t[w0e]===!0){const{version:n,multihash:i,code:s}=t,o=h0e(i);return jr.create(n,s,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==Tf)throw new Error(`Version 0 CID must use dag-pb (code: ${Tf}) block encoding`);return new jr(e,t,n,n.bytes)}case 1:{const i=Q_(e,t,n.bytes);return new jr(e,t,n,i)}default:throw new Error("Invalid version")}}static createV0(e){return jr.create(0,Tf,e)}static createV1(e,t){return jr.create(1,e,t)}static decode(e){const[t,n]=jr.decodeFirst(e);if(n.length!==0)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=jr.inspectBytes(e),n=t.size-t.multihashSize,i=hx(e.subarray(n,n+t.multihashSize));if(i.byteLength!==t.multihashSize)throw new Error("Incorrect length");const s=i.subarray(t.multihashSize-t.digestSize),o=new fx(t.multihashCode,t.digestSize,s,i);return[t.version===0?jr.createV0(o):jr.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[h,p]=wv(e.subarray(t));return t+=p,h};let i=n(),s=Tf;if(i===18?(i=0,t=0):s=n(),i!==0&&i!==1)throw new RangeError(`Invalid CID version ${i}`);const o=t,a=n(),c=n(),l=t+c,d=l-o;return{version:i,codec:s,multihashCode:a,digestSize:c,multihashSize:d,size:l}}static parse(e,t){const[n,i]=p0e(e,t),s=jr.decode(i);if(s.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return bv(s).set(n,e),s}};function p0e(r,e){switch(r[0]){case"Q":{const t=e??Ma;return[Ma.prefix,t.decode(`${Ma.prefix}${r}`)]}case Ma.prefix:{const t=e??Ma;return[Ma.prefix,t.decode(r)]}case i2.prefix:{const t=e??i2;return[i2.prefix,t.decode(r)]}case d8.prefix:{const t=e??d8;return[d8.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}}function g0e(r,e,t){const{prefix:n}=t;if(n!==Ma.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const i=e.get(n);if(i==null){const s=t.encode(r).slice(1);return e.set(n,s),s}else return i}function y0e(r,e,t){const{prefix:n}=t,i=e.get(n);if(i==null){const s=t.encode(r);return e.set(n,s),s}else return i}const Tf=112,m0e=18;function Q_(r,e,t){const n=Jy(r),i=n+Jy(e),s=new Uint8Array(i+t.byteLength);return Yy(r,s,0),Yy(e,s,n),s.set(t,i),s}const w0e=Symbol.for("@ipld/js-cid/CID"),Y_=oe("/ipns/");function J_(r){return He(r.subarray(0,Y_.byteLength),Y_)}class b0e{constructor(e){u(this,"client");this.client=e}async*findProviders(e,t={}){yield*Mh(this.client.getProviders(e,t),n=>({id:n.ID,multiaddrs:n.Addrs??[]}))}async provide(){}async cancelReprovide(){}async put(e,t,n){if(!J_(e))return;const i=gv(e),s=G_.createV1(114,i),o=qp(t);await this.client.putIPNS(s,o,n)}async get(e,t){if(!J_(e))throw new Zt("Not found");const n=gv(e),i=G_.createV1(114,n);try{const s=await this.client.getIPNS(i,t);return jz(s)}catch(s){throw s.name==="BadResponseError"?new Zt("Not found"):s}}}class v0e{constructor(e){u(this,"client");this.client=e}async findPeer(e,t={}){const n=await Bpe(this.client.getPeers(e,t));if(n!=null)return{id:n.ID,multiaddrs:n.Addrs??[]};throw new Zt("Not found")}async*getClosestPeers(e,t={}){}}const or=Rh("delegated-routing-v1-http-api-client"),og={concurrentRequests:4,timeout:3e4,cacheTTL:5*60*1e3,cacheName:"delegated-routing-v1-cache"};var ln,Hf,vv,qf;class E0e{constructor(e,t={}){Ge(this,ln);u(this,"started");u(this,"httpQueue");u(this,"shutDownController");u(this,"clientUrl");u(this,"timeout");u(this,"contentRouting");u(this,"peerRouting");u(this,"filterAddrs");u(this,"filterProtocols");u(this,"inFlightRequests");u(this,"cacheName");u(this,"cache");u(this,"cacheTTL");this.started=!1,this.shutDownController=new AbortController,this.shutDownController.signal,this.httpQueue=new wc({concurrency:t.concurrentRequests??og.concurrentRequests}),this.inFlightRequests=new Map,this.clientUrl=e instanceof URL?e:new URL(e),this.timeout=t.timeout??og.timeout,this.filterAddrs=t.filterAddrs,this.filterProtocols=t.filterProtocols,this.contentRouting=new b0e(this),this.peerRouting=new v0e(this),this.cacheName=t.cacheName??og.cacheName,this.cacheTTL=t.cacheTTL??og.cacheTTL}get[jd](){return this.contentRouting}get[Hd](){return this.peerRouting}isStarted(){return this.started}async start(){var e;this.started||(this.started=!0,this.cacheTTL>0&&(this.cache=await((e=globalThis.caches)==null?void 0:e.open(this.cacheName)),this.cache!=null&&or("cache enabled with ttl %d",this.cacheTTL)))}async stop(){var e;this.httpQueue.clear(),this.shutDownController.abort(),await((e=globalThis.caches)==null?void 0:e.delete(this.cacheName)),this.started=!1}async*getProviders(e,t={}){or("getProviders starts: %c",e);const n=AbortSignal.timeout(this.timeout),i=dt([this.shutDownController.signal,n,t.signal]),s=Le(),o=Le();this.httpQueue.add(async()=>(s.resolve(),o.promise));try{await s.promise;const a=new URL(`${this.clientUrl}routing/v1/providers/${e.toString()}`);Ie(this,ln,vv).call(this,a,t.filterAddrs,t.filterProtocols);const c={headers:{Accept:"application/x-ndjson"},signal:i},l=await Ie(this,ln,qf).call(this,a.toString(),c);if(l==null)throw new ho("No response received");if(!l.ok)throw l.status===404?new Zt("No matching records found"):l.status===422?new n2("Request does not conform to schema or semantic constraints"):new ho(`Unexpected status code: ${l.status}`);if(l.body==null)throw new ho("Routing response had no body");const d=l.headers.get("Content-Type");if(d==null)throw new ho("No Content-Type header received");if(d!=null&&d.startsWith("application/json")){const h=await l.json();for(const p of h.Providers){const m=Ie(this,ln,Hf).call(this,p);m!=null&&(yield m)}}else if(d.includes("application/x-ndjson"))for await(const h of K_(R_(l.body))){const p=Ie(this,ln,Hf).call(this,h);p!=null&&(yield p)}else throw new ho(`Unsupported Content-Type: ${d}`)}catch(a){or.error("getProviders errored:",a)}finally{i.clear(),o.resolve(),or("getProviders finished: %c",e)}}async*getPeers(e,t={}){or("getPeers starts: %c",e);const n=AbortSignal.timeout(this.timeout),i=dt([this.shutDownController.signal,n,t.signal]),s=Le(),o=Le();this.httpQueue.add(async()=>(s.resolve(),o.promise));try{await s.promise;const a=new URL(`${this.clientUrl}routing/v1/peers/${e.toCID().toString()}`);Ie(this,ln,vv).call(this,a,t.filterAddrs,t.filterProtocols);const c={headers:{Accept:"application/x-ndjson"},signal:i},l=await Ie(this,ln,qf).call(this,a.toString(),c);if(l.status===404)throw new Zt("No matching records found");if(l.status===422)throw new n2("Request does not conform to schema or semantic constraints");if(l.body==null)throw new ho("Routing response had no body");if(l.headers.get("Content-Type")==="application/json"){const h=await l.json();for(const p of h.Peers){const m=Ie(this,ln,Hf).call(this,p);m!=null&&(yield m)}}else for await(const h of K_(R_(l.body))){const p=Ie(this,ln,Hf).call(this,h);p!=null&&(yield p)}}catch(a){or.error("getPeers errored:",a)}finally{i.clear(),o.resolve(),or("getPeers finished: %c",e)}}async getIPNS(e,t={}){or("getIPNS starts: %s",e);const n=AbortSignal.timeout(this.timeout),i=dt([this.shutDownController.signal,n,t.signal]),s=Le(),o=Le();this.httpQueue.add(async()=>(s.resolve(),o.promise));const a=`${this.clientUrl}routing/v1/ipns/${e}`;try{await s.promise;const c={headers:{Accept:"application/vnd.ipfs.ipns-record"},signal:i},l=await Ie(this,ln,qf).call(this,a,c);if(or("getIPNS GET %s %d",a,l.status),l.status===404)throw new Zt("No matching records found");if(l.status===422)throw new n2("Request does not conform to schema or semantic constraints");if(l.body==null)throw new ho("GET ipns response had no body");const d=await l.arrayBuffer(),h=new Uint8Array(d,0,d.byteLength);return t.validate!==!1&&await Wz(Hz(e.multihash),h),qp(h)}catch(c){throw or.error("getIPNS GET %s error:",a,c),c}finally{i.clear(),o.resolve(),or("getIPNS finished: %s",e)}}async putIPNS(e,t,n={}){or("putIPNS starts: %c",e);const i=AbortSignal.timeout(this.timeout),s=dt([this.shutDownController.signal,i,n.signal]),o=Le(),a=Le();this.httpQueue.add(async()=>(o.resolve(),a.promise));const c=`${this.clientUrl}routing/v1/ipns/${e}`;try{await o.promise;const l=jz(t),d={method:"PUT",headers:{"Content-Type":"application/vnd.ipfs.ipns-record"},body:l,signal:s},h=await Ie(this,ln,qf).call(this,c,d);if(or("putIPNS PUT %s %d",c,h.status),h.status!==200)throw new ho("PUT ipns response had status other than 200")}catch(l){throw or.error("putIPNS PUT %s error:",c,l.stack),l}finally{s.clear(),a.resolve(),or("putIPNS finished: %c",e)}}}ln=new WeakSet,Hf=function(e){var t;try{const n=[],i=((t=e.Addrs)==null?void 0:t.map(Re))??[];return e.Protocols!=null&&n.push(...e.Protocols),e.Protocol!=null&&(n.push(e.Protocol),delete e.Protocol),{...e,Schema:"peer",ID:Jt(e.ID),Addrs:i,Protocols:n}}catch(n){or.error("could not conform record to peer schema",n)}},vv=function(e,t,n){var i,s;if(t!=null||this.filterAddrs!=null){const o=(t==null?void 0:t.join(","))??((i=this.filterAddrs)==null?void 0:i.join(","))??"";o!==""&&e.searchParams.set("filter-addrs",o)}if(n!=null||this.filterProtocols!=null){const o=(n==null?void 0:n.join(","))??((s=this.filterProtocols)==null?void 0:s.join(","))??"";o!==""&&e.searchParams.set("filter-protocols",o)}},qf=async function(e,t){var c,l;const n=t.method??"GET",i=`${n}-${e}`;if(n==="GET"){const d=await((c=this.cache)==null?void 0:c.match(e));if(d!=null){if(parseInt(d.headers.get("x-cache-expires")??"0",10)>Date.now())return or("returning cached response for %s",i),d;await((l=this.cache)==null?void 0:l.delete(e))}}const s=this.inFlightRequests.get(i);if(s!=null){const d=await s;return or("deduplicating outgoing request for %s",i),d.clone()}const o=fetch(e,t).then(async d=>{if(this.cache!=null&&d.ok&&n==="GET"){const h=Date.now()+this.cacheTTL,p=new Headers(d.headers);p.set("x-cache-expires",h.toString());const m=new Response(d.clone().body,{status:d.status,statusText:d.statusText,headers:p});await this.cache.put(e,m)}return d}).finally(()=>{this.inFlightRequests.delete(i)});return this.inFlightRequests.set(i,o),await o};function S0e(r,e={}){return new E0e(new URL(r),e)}function x0e(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function Nw(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function A0e(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var i=0;i<r.length;i++){var s=r.charAt(i),o=s.charCodeAt(0);if(t[o]!==255)throw new TypeError(s+" is ambiguous");t[o]=i}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),d=Math.log(256)/Math.log(a);function h(f){if(f instanceof Uint8Array||(ArrayBuffer.isView(f)?f=new Uint8Array(f.buffer,f.byteOffset,f.byteLength):Array.isArray(f)&&(f=Uint8Array.from(f))),!(f instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(f.length===0)return"";for(var g=0,v=0,y=0,w=f.length;y!==w&&f[y]===0;)y++,g++;for(var b=(w-y)*d+1>>>0,E=new Uint8Array(b);y!==w;){for(var A=f[y],k=0,x=b-1;(A!==0||k<v)&&x!==-1;x--,k++)A+=256*E[x]>>>0,E[x]=A%a>>>0,A=A/a>>>0;if(A!==0)throw new Error("Non-zero carry");v=k,y++}for(var I=b-v;I!==b&&E[I]===0;)I++;for(var T=c.repeat(g);I<b;++I)T+=r.charAt(E[I]);return T}function p(f){if(typeof f!="string")throw new TypeError("Expected String");if(f.length===0)return new Uint8Array;var g=0;if(f[g]!==" "){for(var v=0,y=0;f[g]===c;)v++,g++;for(var w=(f.length-g)*l+1>>>0,b=new Uint8Array(w);f[g];){var E=t[f.charCodeAt(g)];if(E===255)return;for(var A=0,k=w-1;(E!==0||A<y)&&k!==-1;k--,A++)E+=a*b[k]>>>0,b[k]=E%256>>>0,E=E/256>>>0;if(E!==0)throw new Error("Non-zero carry");y=A,g++}if(f[g]!==" "){for(var x=w-y;x!==w&&b[x]===0;)x++;for(var I=new Uint8Array(v+(w-x)),T=v;x!==w;)I[T++]=b[x++];return I}}}function m(f){var g=p(f);if(g)return g;throw new Error(`Non-${e} character`)}return{encode:h,decodeUnsafe:p,decode:m}}var C0e=A0e,I0e=C0e;let k0e=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseEncode");this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},_0e=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseDecode");u(this,"prefixCodePoint");this.name=e,this.prefix=t;const i=t.codePointAt(0);if(i===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=i,this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return Jz(this,e)}},T0e=class{constructor(e){u(this,"decoders");this.decoders=e}or(e){return Jz(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};function Jz(r,e){return new T0e({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}let P0e=class{constructor(e,t,n,i){u(this,"name");u(this,"prefix");u(this,"baseEncode");u(this,"baseDecode");u(this,"encoder");u(this,"decoder");this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=i,this.encoder=new k0e(e,t,n),this.decoder=new _0e(e,t,i)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};function Xz({name:r,prefix:e,encode:t,decode:n}){return new P0e(r,e,t,n)}function Mw({name:r,prefix:e,alphabet:t}){const{encode:n,decode:i}=I0e(t,r);return Xz({prefix:e,name:r,encode:n,decode:s=>Nw(i(s))})}function D0e(r,e,t,n){const i={};for(let d=0;d<e.length;++d)i[e[d]]=d;let s=r.length;for(;r[s-1]==="=";)--s;const o=new Uint8Array(s*t/8|0);let a=0,c=0,l=0;for(let d=0;d<s;++d){const h=i[r[d]];if(h===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|h,a+=t,a>=8&&(a-=8,o[l++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o}function $0e(r,e,t){const n=e[e.length-1]==="=",i=(1<<t)-1;let s="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,s+=e[i&a>>o];if(o!==0&&(s+=e[i&a<<t-o]),n)for(;s.length*t&7;)s+="=";return s}function ra({name:r,prefix:e,bitsPerChar:t,alphabet:n}){return Xz({prefix:e,name:r,encode(i){return $0e(i,n,t)},decode(i){return D0e(i,n,t,r)}})}const s2=ra({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});ra({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});ra({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});ra({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});ra({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});ra({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});ra({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});ra({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});ra({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const h8=Mw({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"});Mw({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});const Oa=Mw({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});Mw({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var N0e=Zz,X_=128,M0e=-128,O0e=Math.pow(2,31);function Zz(r,e,t){e=e||[],t=t||0;for(var n=t;r>=O0e;)e[t++]=r&255|X_,r/=128;for(;r&M0e;)e[t++]=r&255|X_,r>>>=7;return e[t]=r|0,Zz.bytes=t-n+1,e}var R0e=Ev,L0e=128,Z_=127;function Ev(r,n){var t=0,n=n||0,i=0,s=n,o,a=r.length;do{if(s>=a)throw Ev.bytes=0,new RangeError("Could not decode varint");o=r[s++],t+=i<28?(o&Z_)<<i:(o&Z_)*Math.pow(2,i),i+=7}while(o>=L0e);return Ev.bytes=s-n,t}var B0e=Math.pow(2,7),U0e=Math.pow(2,14),F0e=Math.pow(2,21),z0e=Math.pow(2,28),V0e=Math.pow(2,35),K0e=Math.pow(2,42),j0e=Math.pow(2,49),H0e=Math.pow(2,56),q0e=Math.pow(2,63),W0e=function(r){return r<B0e?1:r<U0e?2:r<F0e?3:r<z0e?4:r<V0e?5:r<K0e?6:r<j0e?7:r<H0e?8:r<q0e?9:10},G0e={encode:N0e,decode:R0e,encodingLength:W0e},Xy=G0e;function Sv(r,e=0){return[Xy.decode(r,e),Xy.decode.bytes]}function Zy(r,e,t=0){return Xy.encode(r,e,t),e}function em(r){return Xy.encodingLength(r)}function eV(r,e){const t=e.byteLength,n=em(r),i=n+em(t),s=new Uint8Array(i+t);return Zy(r,s,0),Zy(t,s,n),s.set(e,i),new px(r,t,e,s)}function Q0e(r){const e=Nw(r),[t,n]=Sv(e),[i,s]=Sv(e.subarray(n)),o=e.subarray(n+s);if(o.byteLength!==i)throw new Error("Incorrect length");return new px(t,i,o,e)}function Y0e(r,e){if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&x0e(r.bytes,t.bytes)}}let px=class{constructor(e,t,n,i){u(this,"code");u(this,"size");u(this,"digest");u(this,"bytes");this.code=e,this.size=t,this.digest=n,this.bytes=i}};function eT(r,e){const{bytes:t,version:n}=r;switch(n){case 0:return Z0e(t,xv(r),e??Oa.encoder);default:return ege(t,xv(r),e??s2.encoder)}}const tT=new WeakMap;function xv(r){const e=tT.get(r);if(e==null){const t=new Map;return tT.set(r,t),t}return e}var mN;let J0e=class Hr{constructor(e,t,n,i){u(this,"code");u(this,"version");u(this,"multihash");u(this,"bytes");u(this,"/");u(this,mN,"CID");this.code=t,this.version=e,this.multihash=n,this.bytes=i,this["/"]=i}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==Pf)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==tge)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return Hr.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=eV(e,t);return Hr.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return Hr.equals(this,e)}static equals(e,t){const n=t;return n!=null&&e.code===n.code&&e.version===n.version&&Y0e(e.multihash,n.multihash)}toString(e){return eT(this,e)}toJSON(){return{"/":eT(this)}}link(){return this}[(mN=Symbol.toStringTag,Symbol.for("nodejs.util.inspect.custom"))](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof Hr)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:i,multihash:s,bytes:o}=t;return new Hr(n,i,s,o??rT(n,i,s.bytes))}else if(t[rge]===!0){const{version:n,multihash:i,code:s}=t,o=Q0e(i);return Hr.create(n,s,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==Pf)throw new Error(`Version 0 CID must use dag-pb (code: ${Pf}) block encoding`);return new Hr(e,t,n,n.bytes)}case 1:{const i=rT(e,t,n.bytes);return new Hr(e,t,n,i)}default:throw new Error("Invalid version")}}static createV0(e){return Hr.create(0,Pf,e)}static createV1(e,t){return Hr.create(1,e,t)}static decode(e){const[t,n]=Hr.decodeFirst(e);if(n.length!==0)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=Hr.inspectBytes(e),n=t.size-t.multihashSize,i=Nw(e.subarray(n,n+t.multihashSize));if(i.byteLength!==t.multihashSize)throw new Error("Incorrect length");const s=i.subarray(t.multihashSize-t.digestSize),o=new px(t.multihashCode,t.digestSize,s,i);return[t.version===0?Hr.createV0(o):Hr.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[h,p]=Sv(e.subarray(t));return t+=p,h};let i=n(),s=Pf;if(i===18?(i=0,t=0):s=n(),i!==0&&i!==1)throw new RangeError(`Invalid CID version ${i}`);const o=t,a=n(),c=n(),l=t+c,d=l-o;return{version:i,codec:s,multihashCode:a,digestSize:c,multihashSize:d,size:l}}static parse(e,t){const[n,i]=X0e(e,t),s=Hr.decode(i);if(s.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return xv(s).set(n,e),s}};function X0e(r,e){switch(r[0]){case"Q":{const t=e??Oa;return[Oa.prefix,t.decode(`${Oa.prefix}${r}`)]}case Oa.prefix:{const t=e??Oa;return[Oa.prefix,t.decode(r)]}case s2.prefix:{const t=e??s2;return[s2.prefix,t.decode(r)]}case h8.prefix:{const t=e??h8;return[h8.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}}function Z0e(r,e,t){const{prefix:n}=t;if(n!==Oa.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const i=e.get(n);if(i==null){const s=t.encode(r).slice(1);return e.set(n,s),s}else return i}function ege(r,e,t){const{prefix:n}=t,i=e.get(n);if(i==null){const s=t.encode(r);return e.set(n,s),s}else return i}const Pf=112,tge=18;function rT(r,e,t){const n=em(r),i=n+em(e),s=new Uint8Array(i+t.byteLength);return Zy(r,s,0),Zy(e,s,n),s.set(t,i),s}const rge=Symbol.for("@ipld/js-cid/CID");function nge(){return{filterProtocols:["unknown","transport-bitswap","transport-ipfs-gateway-http"],filterAddrs:["https","webtransport","webrtc","webrtc-direct","wss","tls"]}}const nT="[a-fA-F\\d:]",Qa=r=>r&&r.includeBoundaries?`(?:(?<=\\s|^)(?=${nT})|(?<=${nT})(?=\\s|$))`:"",Zi="(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)(?:\\.(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)){3}",Yt="[a-fA-F\\d]{1,4}",Ow=`
(?:
(?:${Yt}:){7}(?:${Yt}|:)|                                    // 1:2:3:4:5:6:7::  1:2:3:4:5:6:7:8
(?:${Yt}:){6}(?:${Zi}|:${Yt}|:)|                             // 1:2:3:4:5:6::    1:2:3:4:5:6::8   1:2:3:4:5:6::8  1:2:3:4:5:6::1.2.3.4
(?:${Yt}:){5}(?::${Zi}|(?::${Yt}){1,2}|:)|                   // 1:2:3:4:5::      1:2:3:4:5::7:8   1:2:3:4:5::8    1:2:3:4:5::7:1.2.3.4
(?:${Yt}:){4}(?:(?::${Yt}){0,1}:${Zi}|(?::${Yt}){1,3}|:)| // 1:2:3:4::        1:2:3:4::6:7:8   1:2:3:4::8      1:2:3:4::6:7:1.2.3.4
(?:${Yt}:){3}(?:(?::${Yt}){0,2}:${Zi}|(?::${Yt}){1,4}|:)| // 1:2:3::          1:2:3::5:6:7:8   1:2:3::8        1:2:3::5:6:7:1.2.3.4
(?:${Yt}:){2}(?:(?::${Yt}){0,3}:${Zi}|(?::${Yt}){1,5}|:)| // 1:2::            1:2::4:5:6:7:8   1:2::8          1:2::4:5:6:7:1.2.3.4
(?:${Yt}:){1}(?:(?::${Yt}){0,4}:${Zi}|(?::${Yt}){1,6}|:)| // 1::              1::3:4:5:6:7:8   1::8            1::3:4:5:6:7:1.2.3.4
(?::(?:(?::${Yt}){0,5}:${Zi}|(?::${Yt}){1,7}|:))             // ::2:3:4:5:6:7:8  ::2:3:4:5:6:7:8  ::8             ::1.2.3.4
)(?:%[0-9a-zA-Z]{1,})?                                             // %eth0            %1
`.replace(/\s*\/\/.*$/gm,"").replace(/\n/g,"").trim(),ige=new RegExp(`(?:^${Zi}$)|(?:^${Ow}$)`),sge=new RegExp(`^${Zi}$`),oge=new RegExp(`^${Ow}$`),Rw=r=>r&&r.exact?ige:new RegExp(`(?:${Qa(r)}${Zi}${Qa(r)})|(?:${Qa(r)}${Ow}${Qa(r)})`,"g");Rw.v4=r=>r&&r.exact?sge:new RegExp(`${Qa(r)}${Zi}${Qa(r)}`,"g");Rw.v6=r=>r&&r.exact?oge:new RegExp(`${Qa(r)}${Ow}${Qa(r)}`,"g");function age(r){const e=(...t)=>r(...t);return Object.defineProperty(e,"name",{value:`functionTimeout(${r.name||"<anonymous>"})`,configurable:!0}),e}const{toString:cge}=Object.prototype;function lge(r){return cge.call(r)==="[object RegExp]"}const iT={global:"g",ignoreCase:"i",multiline:"m",dotAll:"s",sticky:"y",unicode:"u"};function uge(r,e={}){if(!lge(r))throw new TypeError("Expected a RegExp instance");const t=Object.keys(iT).map(i=>(typeof e[i]=="boolean"?e[i]:r[i])?iT[i]:"").join(""),n=new RegExp(e.source||r.source,t);return n.lastIndex=typeof e.lastIndex=="number"?e.lastIndex:r.lastIndex,n}function tV(r,e,{timeout:t}={}){try{return age(()=>uge(r).test(e),{timeout:t})()}catch(n){throw n}}const dge=15,hge=45,rV={timeout:400};function sT(r){return r.length>hge?!1:tV(Rw.v6({exact:!0}),r,rV)}function fge(r){return r.length>dge?!1:tV(Rw.v4({exact:!0}),r,rV)}const oT={http:"80",https:"443",ws:"80",wss:"443"},pge=["http","https","ws","wss"];function gge(r,e){e=e??{};const t=e.defaultDnsType??"dns4",{scheme:n,hostname:i,port:s,path:o}=yge(r),a=[mge(i,t),wge(s,n),bge(n)];o!=null&&a.push(vge(o));const c="/"+a.filter(l=>!!l).reduce((l,d)=>l.concat(d),[]).join("/");return Re(c)}function yge(r){const[e]=r.split(":");pge.includes(e)||(r="http"+r.substring(e.length));let{protocol:t,hostname:n,port:i,pathname:s,search:o}=new URL(r);if(i==null||i===""){const c=Ege(e);c!=null&&(i=c),c==null&&t==="http:"&&(i="80")}let a;return s!=null&&s!==""&&s!=="/"&&(s.startsWith("/")&&(s=s.substring(1)),a=s),o!=null&&o!==""&&(a=a??"",a+=o),{scheme:e,hostname:n,port:i,path:a}}function mge(r,e){if(!(r==null||r==="")){if(fge(r))return["ip4",r];if(sT(r))return["ip6",r];if(r[0]==="["){const t=r.substring(1,r.length-1);if(sT(t))return["ip6",t]}return[e,r]}}function wge(r,e){if(!(r==null||r===""))return e==="udp"?["udp",r]:["tcp",r]}function bge(r){if(r.match(/^tcp$|^udp$/)==null)return[r]}function vge(r){if(!(r==null||r===""))return["http-path",encodeURIComponent(r)]}function Ege(r){if(!(r==null||r===""||oT[r]==null))return oT[r]}const nV=0,Sge="identity",iV=Nw;function xge(r){return eV(nV,iV(r))}const Age={code:nV,name:Sge,encode:iV,digest:xge},Cge=["https://trustless-gateway.link","https://4everland.io"],Ige=2336;function kge(r){return r=r.toString(),{id:Oh(J0e.createV1(Ige,Age.digest(oe(r)))),multiaddrs:[gge(r)]}}class _ge{constructor(e={}){u(this,"gateways");this.gateways=(e.gateways??Cge).map(t=>kge(t))}async*findProviders(e,t){yield*this.gateways.toSorted(()=>Math.random()>.5?1:-1).map(n=>({...n,protocols:["transport-ipfs-gateway-http"]}))}}function Tge(r={}){return new _ge(r)}class Pge{constructor(e){u(this,"libp2p");this.libp2p=e}async provide(e,t){await this.libp2p.contentRouting.provide(e,t)}async cancelReprovide(e,t){await this.libp2p.contentRouting.cancelReprovide(e,t)}async*findProviders(e,t){yield*this.libp2p.contentRouting.findProviders(e,t)}async put(e,t,n){await this.libp2p.contentRouting.put(e,t,n)}async get(e,t){return this.libp2p.contentRouting.get(e,t)}async findPeer(e,t){return this.libp2p.peerRouting.findPeer(e,t)}async*getClosestPeers(e,t){yield*this.libp2p.peerRouting.getClosestPeers(e,t)}}function Dge(r){return new Pge(r)}function $ge(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function gx(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function Nge(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var i=0;i<r.length;i++){var s=r.charAt(i),o=s.charCodeAt(0);if(t[o]!==255)throw new TypeError(s+" is ambiguous");t[o]=i}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),d=Math.log(256)/Math.log(a);function h(f){if(f instanceof Uint8Array||(ArrayBuffer.isView(f)?f=new Uint8Array(f.buffer,f.byteOffset,f.byteLength):Array.isArray(f)&&(f=Uint8Array.from(f))),!(f instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(f.length===0)return"";for(var g=0,v=0,y=0,w=f.length;y!==w&&f[y]===0;)y++,g++;for(var b=(w-y)*d+1>>>0,E=new Uint8Array(b);y!==w;){for(var A=f[y],k=0,x=b-1;(A!==0||k<v)&&x!==-1;x--,k++)A+=256*E[x]>>>0,E[x]=A%a>>>0,A=A/a>>>0;if(A!==0)throw new Error("Non-zero carry");v=k,y++}for(var I=b-v;I!==b&&E[I]===0;)I++;for(var T=c.repeat(g);I<b;++I)T+=r.charAt(E[I]);return T}function p(f){if(typeof f!="string")throw new TypeError("Expected String");if(f.length===0)return new Uint8Array;var g=0;if(f[g]!==" "){for(var v=0,y=0;f[g]===c;)v++,g++;for(var w=(f.length-g)*l+1>>>0,b=new Uint8Array(w);f[g];){var E=t[f.charCodeAt(g)];if(E===255)return;for(var A=0,k=w-1;(E!==0||A<y)&&k!==-1;k--,A++)E+=a*b[k]>>>0,b[k]=E%256>>>0,E=E/256>>>0;if(E!==0)throw new Error("Non-zero carry");y=A,g++}if(f[g]!==" "){for(var x=w-y;x!==w&&b[x]===0;)x++;for(var I=new Uint8Array(v+(w-x)),T=v;x!==w;)I[T++]=b[x++];return I}}}function m(f){var g=p(f);if(g)return g;throw new Error(`Non-${e} character`)}return{encode:h,decodeUnsafe:p,decode:m}}var Mge=Nge,Oge=Mge;let Rge=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseEncode");this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},Lge=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseDecode");u(this,"prefixCodePoint");this.name=e,this.prefix=t;const i=t.codePointAt(0);if(i===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=i,this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return sV(this,e)}},Bge=class{constructor(e){u(this,"decoders");this.decoders=e}or(e){return sV(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};function sV(r,e){return new Bge({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}let Uge=class{constructor(e,t,n,i){u(this,"name");u(this,"prefix");u(this,"baseEncode");u(this,"baseDecode");u(this,"encoder");u(this,"decoder");this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=i,this.encoder=new Rge(e,t,n),this.decoder=new Lge(e,t,i)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};function oV({name:r,prefix:e,encode:t,decode:n}){return new Uge(r,e,t,n)}function Lw({name:r,prefix:e,alphabet:t}){const{encode:n,decode:i}=Oge(t,r);return oV({prefix:e,name:r,encode:n,decode:s=>gx(i(s))})}function Fge(r,e,t,n){const i={};for(let d=0;d<e.length;++d)i[e[d]]=d;let s=r.length;for(;r[s-1]==="=";)--s;const o=new Uint8Array(s*t/8|0);let a=0,c=0,l=0;for(let d=0;d<s;++d){const h=i[r[d]];if(h===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|h,a+=t,a>=8&&(a-=8,o[l++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o}function zge(r,e,t){const n=e[e.length-1]==="=",i=(1<<t)-1;let s="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,s+=e[i&a>>o];if(o!==0&&(s+=e[i&a<<t-o]),n)for(;s.length*t&7;)s+="=";return s}function na({name:r,prefix:e,bitsPerChar:t,alphabet:n}){return oV({prefix:e,name:r,encode(i){return zge(i,n,t)},decode(i){return Fge(i,n,t,r)}})}const Ao=na({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});na({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});na({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});na({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});na({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});na({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});na({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});na({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});na({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const f8=Lw({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"});Lw({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});const Ra=Lw({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});Lw({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var Vge=aV,aT=128,Kge=-128,jge=Math.pow(2,31);function aV(r,e,t){e=e||[],t=t||0;for(var n=t;r>=jge;)e[t++]=r&255|aT,r/=128;for(;r&Kge;)e[t++]=r&255|aT,r>>>=7;return e[t]=r|0,aV.bytes=t-n+1,e}var Hge=Av,qge=128,cT=127;function Av(r,n){var t=0,n=n||0,i=0,s=n,o,a=r.length;do{if(s>=a)throw Av.bytes=0,new RangeError("Could not decode varint");o=r[s++],t+=i<28?(o&cT)<<i:(o&cT)*Math.pow(2,i),i+=7}while(o>=qge);return Av.bytes=s-n,t}var Wge=Math.pow(2,7),Gge=Math.pow(2,14),Qge=Math.pow(2,21),Yge=Math.pow(2,28),Jge=Math.pow(2,35),Xge=Math.pow(2,42),Zge=Math.pow(2,49),e2e=Math.pow(2,56),t2e=Math.pow(2,63),r2e=function(r){return r<Wge?1:r<Gge?2:r<Qge?3:r<Yge?4:r<Jge?5:r<Xge?6:r<Zge?7:r<e2e?8:r<t2e?9:10},n2e={encode:Vge,decode:Hge,encodingLength:r2e},tm=n2e;function Cv(r,e=0){return[tm.decode(r,e),tm.decode.bytes]}function rm(r,e,t=0){return tm.encode(r,e,t),e}function nm(r){return tm.encodingLength(r)}function i2e(r,e){const t=e.byteLength,n=nm(r),i=n+nm(t),s=new Uint8Array(i+t);return rm(r,s,0),rm(t,s,n),s.set(e,i),new yx(r,t,e,s)}function cV(r){const e=gx(r),[t,n]=Cv(e),[i,s]=Cv(e.subarray(n)),o=e.subarray(n+s);if(o.byteLength!==i)throw new Error("Incorrect length");return new yx(t,i,o,e)}function s2e(r,e){if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&$ge(r.bytes,t.bytes)}}let yx=class{constructor(e,t,n,i){u(this,"code");u(this,"size");u(this,"digest");u(this,"bytes");this.code=e,this.size=t,this.digest=n,this.bytes=i}};function lT(r,e){const{bytes:t,version:n}=r;switch(n){case 0:return c2e(t,Iv(r),e??Ra.encoder);default:return l2e(t,Iv(r),e??Ao.encoder)}}const uT=new WeakMap;function Iv(r){const e=uT.get(r);if(e==null){const t=new Map;return uT.set(r,t),t}return e}var wN;let o2e=class qr{constructor(e,t,n,i){u(this,"code");u(this,"version");u(this,"multihash");u(this,"bytes");u(this,"/");u(this,wN,"CID");this.code=t,this.version=e,this.multihash=n,this.bytes=i,this["/"]=i}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==Df)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==u2e)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return qr.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=i2e(e,t);return qr.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return qr.equals(this,e)}static equals(e,t){const n=t;return n!=null&&e.code===n.code&&e.version===n.version&&s2e(e.multihash,n.multihash)}toString(e){return lT(this,e)}toJSON(){return{"/":lT(this)}}link(){return this}[(wN=Symbol.toStringTag,Symbol.for("nodejs.util.inspect.custom"))](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof qr)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:i,multihash:s,bytes:o}=t;return new qr(n,i,s,o??dT(n,i,s.bytes))}else if(t[d2e]===!0){const{version:n,multihash:i,code:s}=t,o=cV(i);return qr.create(n,s,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==Df)throw new Error(`Version 0 CID must use dag-pb (code: ${Df}) block encoding`);return new qr(e,t,n,n.bytes)}case 1:{const i=dT(e,t,n.bytes);return new qr(e,t,n,i)}default:throw new Error("Invalid version")}}static createV0(e){return qr.create(0,Df,e)}static createV1(e,t){return qr.create(1,e,t)}static decode(e){const[t,n]=qr.decodeFirst(e);if(n.length!==0)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=qr.inspectBytes(e),n=t.size-t.multihashSize,i=gx(e.subarray(n,n+t.multihashSize));if(i.byteLength!==t.multihashSize)throw new Error("Incorrect length");const s=i.subarray(t.multihashSize-t.digestSize),o=new yx(t.multihashCode,t.digestSize,s,i);return[t.version===0?qr.createV0(o):qr.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[h,p]=Cv(e.subarray(t));return t+=p,h};let i=n(),s=Df;if(i===18?(i=0,t=0):s=n(),i!==0&&i!==1)throw new RangeError(`Invalid CID version ${i}`);const o=t,a=n(),c=n(),l=t+c,d=l-o;return{version:i,codec:s,multihashCode:a,digestSize:c,multihashSize:d,size:l}}static parse(e,t){const[n,i]=a2e(e,t),s=qr.decode(i);if(s.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return Iv(s).set(n,e),s}};function a2e(r,e){switch(r[0]){case"Q":{const t=e??Ra;return[Ra.prefix,t.decode(`${Ra.prefix}${r}`)]}case Ra.prefix:{const t=e??Ra;return[Ra.prefix,t.decode(r)]}case Ao.prefix:{const t=e??Ao;return[Ao.prefix,t.decode(r)]}case f8.prefix:{const t=e??f8;return[f8.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}}function c2e(r,e,t){const{prefix:n}=t;if(n!==Ra.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const i=e.get(n);if(i==null){const s=t.encode(r).slice(1);return e.set(n,s),s}else return i}function l2e(r,e,t){const{prefix:n}=t,i=e.get(n);if(i==null){const s=t.encode(r);return e.set(n,s),s}else return i}const Df=112,u2e=18;function dT(r,e,t){const n=nm(r),i=n+nm(e),s=new Uint8Array(i+t.byteLength);return rm(r,s,0),rm(e,s,n),s.set(t,i),s}const d2e=Symbol.for("@ipld/js-cid/CID"),h2e=85;class f2e extends WF{constructor(){super();u(this,"data");this.data=new Map}put(t,n){return this.data.set(Ao.encode(t.multihash.bytes),n),t}get(t){const n=this.data.get(Ao.encode(t.multihash.bytes));if(n==null)throw new J1;return n}has(t){return this.data.has(Ao.encode(t.multihash.bytes))}async delete(t){this.data.delete(Ao.encode(t.multihash.bytes))}async*getAll(){for(const[t,n]of this.data.entries())yield{cid:o2e.createV1(h2e,cV(Ao.decode(t))),block:n}}}Rh("blockstore:core:tiered");const p2e="SHARDING";function g2e(r){return r[Symbol.asyncIterator]!=null}function im(r){if(g2e(r))return(async()=>{const t=[];for await(const n of r)t.push(n);return t})();const e=[];for(const t of r)e.push(t);return e}function y2e(r){return r[Symbol.asyncIterator]!=null}function hT(r,e){return y2e(r)?async function*(){yield*(await im(r)).sort(e)}():function*(){yield*im(r).sort(e)}()}class m2e{put(e,t,n){return Promise.reject(new Error(".put is not implemented"))}get(e,t){return Promise.reject(new Error(".get is not implemented"))}has(e,t){return Promise.reject(new Error(".has is not implemented"))}delete(e,t){return Promise.reject(new Error(".delete is not implemented"))}async*putMany(e,t={}){for await(const{key:n,value:i}of e)await this.put(n,i,t),yield n}async*getMany(e,t={}){for await(const n of e)yield{key:n,value:await this.get(n,t)}}async*deleteMany(e,t={}){for await(const n of e)await this.delete(n,t),yield n}batch(){let e=[],t=[];return{put(n,i){e.push({key:n,value:i})},delete(n){t.push(n)},commit:async n=>{await zo(this.putMany(e,n)),e=[],await zo(this.deleteMany(t,n)),t=[]}}}async*_all(e,t){throw new Error("._all is not implemented")}async*_allKeys(e,t){throw new Error("._allKeys is not implemented")}query(e,t){let n=this._all(e,t);if(e.prefix!=null){const i=e.prefix;n=sl(n,s=>s.key.toString().startsWith(i))}if(Array.isArray(e.filters)&&(n=e.filters.reduce((i,s)=>sl(i,s),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((i,s)=>hT(i,s),n)),e.offset!=null){let i=0;const s=e.offset;n=sl(n,()=>i++>=s)}return e.limit!=null&&(n=py(n,e.limit)),n}queryKeys(e,t){let n=this._allKeys(e,t);if(e.prefix!=null){const i=e.prefix;n=sl(n,s=>s.toString().startsWith(i))}if(Array.isArray(e.filters)&&(n=e.filters.reduce((i,s)=>sl(i,s),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((i,s)=>hT(i,s),n)),e.offset!=null){const i=e.offset;let s=0;n=sl(n,()=>s++>=i)}return e.limit!=null&&(n=py(n,e.limit)),n}}class lV extends m2e{constructor(){super();u(this,"data");this.data=new Map}put(t,n){return this.data.set(t.toString(),n),t}get(t){const n=this.data.get(t.toString());if(n==null)throw new J1;return n}has(t){return this.data.has(t.toString())}delete(t){this.data.delete(t.toString())}*_all(){for(const[t,n]of this.data.entries())yield{key:new Et(t),value:n}}*_allKeys(){for(const t of this.data.keys())yield new Et(t)}}new Et(p2e);Rh("datastore:core:tiered");class w2e extends jde{constructor(t){super({...t,components:{libp2p:t.libp2p}});u(this,"libp2p");this.libp2p=t.libp2p}async start(){await super.start(),await this.libp2p.start()}async stop(){await super.stop(),await this.libp2p.stop()}}let b2e=class{constructor(){u(this,"readNext");u(this,"haveNext");u(this,"ended");u(this,"nextResult");u(this,"error");this.ended=!1,this.readNext=Le(),this.haveNext=Le()}[Symbol.asyncIterator](){return this}async next(){if(this.nextResult==null&&await this.haveNext.promise,this.nextResult==null)throw new Error("HaveNext promise resolved but nextResult was undefined");const e=this.nextResult;return this.nextResult=void 0,this.readNext.resolve(),this.readNext=Le(),e}async throw(e){return this.ended=!0,this.error=e,e!=null&&(this.haveNext.promise.catch(()=>{}),this.haveNext.reject(e)),{done:!0,value:void 0}}async return(){const e={done:!0,value:void 0};return this.ended=!0,this.nextResult=e,this.haveNext.resolve(),e}async push(e,t){await this._push(e,t)}async end(e,t){e!=null?await this.throw(e):await this._push(void 0,t)}async _push(e,t){if(e!=null&&this.ended)throw this.error??new Error("Cannot push value onto an ended pushable");for(;this.nextResult!=null;)await this.readNext.promise;e!=null?this.nextResult={done:!1,value:e}:(this.ended=!0,this.nextResult={done:!0,value:void 0}),this.haveNext.resolve(),this.haveNext=Le(),await cn(this.readNext.promise,t==null?void 0:t.signal,t)}};function v2e(){return new b2e}let E2e=class extends Error{constructor(){super(...arguments);u(this,"name","UnexpectedEOFError");u(this,"code","ERR_UNEXPECTED_EOF")}};function sm(r,e){const t=v2e();r.sink(t).catch(async o=>{await t.end(o)}),r.sink=async o=>{for await(const a of o)await t.push(a);await t.end()};let n=r.source;r.source[Symbol.iterator]!=null?n=r.source[Symbol.iterator]():r.source[Symbol.asyncIterator]!=null&&(n=r.source[Symbol.asyncIterator]());const i=new Ue;return{read:async o=>{var c;if((c=o==null?void 0:o.signal)==null||c.throwIfAborted(),(o==null?void 0:o.bytes)==null){const{done:l,value:d}=await cn(n.next(),o==null?void 0:o.signal);return l===!0?null:d}for(;i.byteLength<o.bytes;){const{value:l,done:d}=await cn(n.next(),o==null?void 0:o.signal);if(d===!0)throw new E2e("unexpected end of input");i.append(l)}const a=i.sublist(0,o.bytes);return i.consume(o.bytes),a},write:async(o,a)=>{var c;(c=a==null?void 0:a.signal)==null||c.throwIfAborted(),o instanceof Uint8Array?await t.push(o,a):await t.push(o.subarray(),a)},unwrap:()=>{if(i.byteLength>0){const o=r.source;r.source=async function*(){(e==null?void 0:e.yieldBytes)===!1?yield i:yield*i,yield*o}()}return r}}}let S2e=class extends Error{constructor(){super(...arguments);u(this,"name","InvalidMessageLengthError");u(this,"code","ERR_INVALID_MSG_LENGTH")}},x2e=class extends Error{constructor(){super(...arguments);u(this,"name","InvalidDataLengthError");u(this,"code","ERR_MSG_DATA_TOO_LONG")}},A2e=class extends Error{constructor(){super(...arguments);u(this,"name","InvalidDataLengthLengthError");u(this,"code","ERR_MSG_LENGTH_TOO_LONG")}};function nh(r,e={}){const t=sm(r,e);e.maxDataLength!=null&&e.maxLengthLength==null&&(e.maxLengthLength=gt(e.maxDataLength));const n=(e==null?void 0:e.lengthDecoder)??gs,i=(e==null?void 0:e.lengthEncoder)??xr;return{read:async o=>{let a=-1;const c=new Ue;for(;;){c.append(await t.read({...o,bytes:1}));try{a=n(c)}catch(l){if(l instanceof RangeError)continue;throw l}if(a<0)throw new S2e("Invalid message length");if((e==null?void 0:e.maxLengthLength)!=null&&c.byteLength>e.maxLengthLength)throw new A2e("message length length too long");if(a>-1)break}if((e==null?void 0:e.maxDataLength)!=null&&a>e.maxDataLength)throw new x2e("message length too long");return t.read({...o,bytes:a})},write:async(o,a)=>{await t.write(new Ue(i(o.byteLength),o),a)},writeV:async(o,a)=>{const c=new Ue(...o.flatMap(l=>[i(l.byteLength),l]));await t.write(c,a)},unwrap:()=>t.unwrap()}}function fT(){const r=Le();let e=!1;return{sink:async t=>{if(e)throw new Error("already piped");e=!0,r.resolve(t)},source:async function*(){yield*await r.promise}()}}function C2e(){const r=fT(),e=fT();return[{source:r.source,sink:e.sink},{source:e.source,sink:r.sink}]}const rp=65535,pT=rp-16;var bN,vN;const Wp=!!((vN=(bN=globalThis.process)==null?void 0:bN.env)!=null&&vN.DUMP_SESSION_KEYS);function p8(r){if(!Number.isSafeInteger(r)||r<0)throw new Error("positive integer expected, got "+r)}function uV(r){return r instanceof Uint8Array||ArrayBuffer.isView(r)&&r.constructor.name==="Uint8Array"}function qn(r,...e){if(!uV(r))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(r.length))throw new Error("Uint8Array expected of length "+e+", got length="+r.length)}function gT(r,e=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(e&&r.finished)throw new Error("Hash#digest() has already been called")}function I2e(r,e){qn(r);const t=e.outputLen;if(r.length<t)throw new Error("digestInto() expects output buffer of length at least "+t)}function yT(r){if(typeof r!="boolean")throw new Error(`boolean expected, not ${r}`)}/*! noble-ciphers - MIT License (c) 2023 Paul Miller (paulmillr.com) */const fc=r=>new Uint32Array(r.buffer,r.byteOffset,Math.floor(r.byteLength/4)),k2e=r=>new DataView(r.buffer,r.byteOffset,r.byteLength),_2e=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;if(!_2e)throw new Error("Non little-endian hardware is not supported");function T2e(r){if(typeof r!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(r))}function kv(r){if(typeof r=="string")r=T2e(r);else if(uV(r))r=_v(r);else throw new Error("Uint8Array expected, got "+typeof r);return r}function P2e(r,e){if(e==null||typeof e!="object")throw new Error("options must be defined");return Object.assign(r,e)}function D2e(r,e){if(r.length!==e.length)return!1;let t=0;for(let n=0;n<r.length;n++)t|=r[n]^e[n];return t===0}const $2e=(r,e)=>{function t(n,...i){if(qn(n),r.nonceLength!==void 0){const d=i[0];if(!d)throw new Error("nonce / iv required");r.varSizeNonce?qn(d):qn(d,r.nonceLength)}const s=r.tagLength;s&&i[1]!==void 0&&qn(i[1]);const o=e(n,...i),a=(d,h)=>{if(h!==void 0){if(d!==2)throw new Error("cipher output not supported");qn(h)}};let c=!1;return{encrypt(d,h){if(c)throw new Error("cannot encrypt() twice with same key + nonce");return c=!0,qn(d),a(o.encrypt.length,h),o.encrypt(d,h)},decrypt(d,h){if(qn(d),s&&d.length<s)throw new Error("invalid ciphertext length: smaller than tagLength="+s);return a(o.decrypt.length,h),o.decrypt(d,h)}}}return Object.assign(t,r),t};function mT(r,e,t=!0){if(e===void 0)return new Uint8Array(r);if(e.length!==r)throw new Error("invalid output length, expected "+r+", got: "+e.length);if(t&&!N2e(e))throw new Error("invalid output, must be aligned");return e}function wT(r,e,t,n){if(typeof r.setBigUint64=="function")return r.setBigUint64(e,t,n);const i=BigInt(32),s=BigInt(4294967295),o=Number(t>>i&s),a=Number(t&s),c=4,l=0;r.setUint32(e+c,o,n),r.setUint32(e+l,a,n)}function N2e(r){return r.byteOffset%4===0}function _v(r){return Uint8Array.from(r)}function ih(...r){for(let e=0;e<r.length;e++)r[e].fill(0)}const dV=r=>Uint8Array.from(r.split("").map(e=>e.charCodeAt(0))),M2e=dV("expand 16-byte k"),O2e=dV("expand 32-byte k"),R2e=fc(M2e),L2e=fc(O2e);function nt(r,e){return r<<e|r>>>32-e}function Tv(r){return r.byteOffset%4===0}const ag=64,B2e=16,hV=2**32-1,bT=new Uint32Array;function U2e(r,e,t,n,i,s,o,a){const c=i.length,l=new Uint8Array(ag),d=fc(l),h=Tv(i)&&Tv(s),p=h?fc(i):bT,m=h?fc(s):bT;for(let f=0;f<c;o++){if(r(e,t,n,d,o,a),o>=hV)throw new Error("arx: counter overflow");const g=Math.min(ag,c-f);if(h&&g===ag){const v=f/4;if(f%4!==0)throw new Error("arx: invalid block position");for(let y=0,w;y<B2e;y++)w=v+y,m[w]=p[w]^d[y];f+=ag;continue}for(let v=0,y;v<g;v++)y=f+v,s[y]=i[y]^l[v];f+=g}}function F2e(r,e){const{allowShortKeys:t,extendNonceFn:n,counterLength:i,counterRight:s,rounds:o}=P2e({allowShortKeys:!1,counterLength:8,counterRight:!1,rounds:20},e);if(typeof r!="function")throw new Error("core must be a function");return p8(i),p8(o),yT(s),yT(t),(a,c,l,d,h=0)=>{qn(a),qn(c),qn(l);const p=l.length;if(d===void 0&&(d=new Uint8Array(p)),qn(d),p8(h),h<0||h>=hV)throw new Error("arx: counter overflow");if(d.length<p)throw new Error(`arx: output (${d.length}) is shorter than data (${p})`);const m=[];let f=a.length,g,v;if(f===32)m.push(g=_v(a)),v=L2e;else if(f===16&&t)g=new Uint8Array(32),g.set(a),g.set(a,16),v=R2e,m.push(g);else throw new Error(`arx: invalid 32-byte key, got length=${f}`);Tv(c)||m.push(c=_v(c));const y=fc(g);if(n){if(c.length!==24)throw new Error("arx: extended nonce must be 24 bytes");n(v,y,fc(c.subarray(0,16)),y),c=c.subarray(16)}const w=16-i;if(w!==c.length)throw new Error(`arx: nonce must be ${w} or 16 bytes`);if(w!==12){const E=new Uint8Array(12);E.set(c,s?0:12-c.length),c=E,m.push(c)}const b=fc(c);return U2e(r,v,y,b,l,d,h,o),ih(...m),d}}const gr=(r,e)=>r[e++]&255|(r[e++]&255)<<8;class z2e{constructor(e){this.blockLen=16,this.outputLen=16,this.buffer=new Uint8Array(16),this.r=new Uint16Array(10),this.h=new Uint16Array(10),this.pad=new Uint16Array(8),this.pos=0,this.finished=!1,e=kv(e),qn(e,32);const t=gr(e,0),n=gr(e,2),i=gr(e,4),s=gr(e,6),o=gr(e,8),a=gr(e,10),c=gr(e,12),l=gr(e,14);this.r[0]=t&8191,this.r[1]=(t>>>13|n<<3)&8191,this.r[2]=(n>>>10|i<<6)&7939,this.r[3]=(i>>>7|s<<9)&8191,this.r[4]=(s>>>4|o<<12)&255,this.r[5]=o>>>1&8190,this.r[6]=(o>>>14|a<<2)&8191,this.r[7]=(a>>>11|c<<5)&8065,this.r[8]=(c>>>8|l<<8)&8191,this.r[9]=l>>>5&127;for(let d=0;d<8;d++)this.pad[d]=gr(e,16+2*d)}process(e,t,n=!1){const i=n?0:2048,{h:s,r:o}=this,a=o[0],c=o[1],l=o[2],d=o[3],h=o[4],p=o[5],m=o[6],f=o[7],g=o[8],v=o[9],y=gr(e,t+0),w=gr(e,t+2),b=gr(e,t+4),E=gr(e,t+6),A=gr(e,t+8),k=gr(e,t+10),x=gr(e,t+12),I=gr(e,t+14);let T=s[0]+(y&8191),L=s[1]+((y>>>13|w<<3)&8191),z=s[2]+((w>>>10|b<<6)&8191),B=s[3]+((b>>>7|E<<9)&8191),G=s[4]+((E>>>4|A<<12)&8191),j=s[5]+(A>>>1&8191),q=s[6]+((A>>>14|k<<2)&8191),Q=s[7]+((k>>>11|x<<5)&8191),K=s[8]+((x>>>8|I<<8)&8191),O=s[9]+(I>>>5|i),U=0,W=U+T*a+L*(5*v)+z*(5*g)+B*(5*f)+G*(5*m);U=W>>>13,W&=8191,W+=j*(5*p)+q*(5*h)+Q*(5*d)+K*(5*l)+O*(5*c),U+=W>>>13,W&=8191;let Y=U+T*c+L*a+z*(5*v)+B*(5*g)+G*(5*f);U=Y>>>13,Y&=8191,Y+=j*(5*m)+q*(5*p)+Q*(5*h)+K*(5*d)+O*(5*l),U+=Y>>>13,Y&=8191;let H=U+T*l+L*c+z*a+B*(5*v)+G*(5*g);U=H>>>13,H&=8191,H+=j*(5*f)+q*(5*m)+Q*(5*p)+K*(5*h)+O*(5*d),U+=H>>>13,H&=8191;let ne=U+T*d+L*l+z*c+B*a+G*(5*v);U=ne>>>13,ne&=8191,ne+=j*(5*g)+q*(5*f)+Q*(5*m)+K*(5*p)+O*(5*h),U+=ne>>>13,ne&=8191;let ye=U+T*h+L*d+z*l+B*c+G*a;U=ye>>>13,ye&=8191,ye+=j*(5*v)+q*(5*g)+Q*(5*f)+K*(5*m)+O*(5*p),U+=ye>>>13,ye&=8191;let ue=U+T*p+L*h+z*d+B*l+G*c;U=ue>>>13,ue&=8191,ue+=j*a+q*(5*v)+Q*(5*g)+K*(5*f)+O*(5*m),U+=ue>>>13,ue&=8191;let ce=U+T*m+L*p+z*h+B*d+G*l;U=ce>>>13,ce&=8191,ce+=j*c+q*a+Q*(5*v)+K*(5*g)+O*(5*f),U+=ce>>>13,ce&=8191;let Ne=U+T*f+L*m+z*p+B*h+G*d;U=Ne>>>13,Ne&=8191,Ne+=j*l+q*c+Q*a+K*(5*v)+O*(5*g),U+=Ne>>>13,Ne&=8191;let Me=U+T*g+L*f+z*m+B*p+G*h;U=Me>>>13,Me&=8191,Me+=j*d+q*l+Q*c+K*a+O*(5*v),U+=Me>>>13,Me&=8191;let Xe=U+T*v+L*g+z*f+B*m+G*p;U=Xe>>>13,Xe&=8191,Xe+=j*h+q*d+Q*l+K*c+O*a,U+=Xe>>>13,Xe&=8191,U=(U<<2)+U|0,U=U+W|0,W=U&8191,U=U>>>13,Y+=U,s[0]=W,s[1]=Y,s[2]=H,s[3]=ne,s[4]=ye,s[5]=ue,s[6]=ce,s[7]=Ne,s[8]=Me,s[9]=Xe}finalize(){const{h:e,pad:t}=this,n=new Uint16Array(10);let i=e[1]>>>13;e[1]&=8191;for(let a=2;a<10;a++)e[a]+=i,i=e[a]>>>13,e[a]&=8191;e[0]+=i*5,i=e[0]>>>13,e[0]&=8191,e[1]+=i,i=e[1]>>>13,e[1]&=8191,e[2]+=i,n[0]=e[0]+5,i=n[0]>>>13,n[0]&=8191;for(let a=1;a<10;a++)n[a]=e[a]+i,i=n[a]>>>13,n[a]&=8191;n[9]-=8192;let s=(i^1)-1;for(let a=0;a<10;a++)n[a]&=s;s=~s;for(let a=0;a<10;a++)e[a]=e[a]&s|n[a];e[0]=(e[0]|e[1]<<13)&65535,e[1]=(e[1]>>>3|e[2]<<10)&65535,e[2]=(e[2]>>>6|e[3]<<7)&65535,e[3]=(e[3]>>>9|e[4]<<4)&65535,e[4]=(e[4]>>>12|e[5]<<1|e[6]<<14)&65535,e[5]=(e[6]>>>2|e[7]<<11)&65535,e[6]=(e[7]>>>5|e[8]<<8)&65535,e[7]=(e[8]>>>8|e[9]<<5)&65535;let o=e[0]+t[0];e[0]=o&65535;for(let a=1;a<8;a++)o=(e[a]+t[a]|0)+(o>>>16)|0,e[a]=o&65535;ih(n)}update(e){gT(this);const{buffer:t,blockLen:n}=this;e=kv(e);const i=e.length;for(let s=0;s<i;){const o=Math.min(n-this.pos,i-s);if(o===n){for(;n<=i-s;s+=n)this.process(e,s);continue}t.set(e.subarray(s,s+o),this.pos),this.pos+=o,s+=o,this.pos===n&&(this.process(t,0,!1),this.pos=0)}return this}destroy(){ih(this.h,this.r,this.buffer,this.pad)}digestInto(e){gT(this),I2e(e,this),this.finished=!0;const{buffer:t,h:n}=this;let{pos:i}=this;if(i){for(t[i++]=1;i<16;i++)t[i]=0;this.process(t,0,!0)}this.finalize();let s=0;for(let o=0;o<8;o++)e[s++]=n[o]>>>0,e[s++]=n[o]>>>8;return e}digest(){const{buffer:e,outputLen:t}=this;this.digestInto(e);const n=e.slice(0,t);return this.destroy(),n}}function V2e(r){const e=(n,i)=>r(i).update(kv(n)).digest(),t=r(new Uint8Array(32));return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=n=>r(n),e}const K2e=V2e(r=>new z2e(r));function j2e(r,e,t,n,i,s=20){let o=r[0],a=r[1],c=r[2],l=r[3],d=e[0],h=e[1],p=e[2],m=e[3],f=e[4],g=e[5],v=e[6],y=e[7],w=i,b=t[0],E=t[1],A=t[2],k=o,x=a,I=c,T=l,L=d,z=h,B=p,G=m,j=f,q=g,Q=v,K=y,O=w,U=b,W=E,Y=A;for(let ne=0;ne<s;ne+=2)k=k+L|0,O=nt(O^k,16),j=j+O|0,L=nt(L^j,12),k=k+L|0,O=nt(O^k,8),j=j+O|0,L=nt(L^j,7),x=x+z|0,U=nt(U^x,16),q=q+U|0,z=nt(z^q,12),x=x+z|0,U=nt(U^x,8),q=q+U|0,z=nt(z^q,7),I=I+B|0,W=nt(W^I,16),Q=Q+W|0,B=nt(B^Q,12),I=I+B|0,W=nt(W^I,8),Q=Q+W|0,B=nt(B^Q,7),T=T+G|0,Y=nt(Y^T,16),K=K+Y|0,G=nt(G^K,12),T=T+G|0,Y=nt(Y^T,8),K=K+Y|0,G=nt(G^K,7),k=k+z|0,Y=nt(Y^k,16),Q=Q+Y|0,z=nt(z^Q,12),k=k+z|0,Y=nt(Y^k,8),Q=Q+Y|0,z=nt(z^Q,7),x=x+B|0,O=nt(O^x,16),K=K+O|0,B=nt(B^K,12),x=x+B|0,O=nt(O^x,8),K=K+O|0,B=nt(B^K,7),I=I+G|0,U=nt(U^I,16),j=j+U|0,G=nt(G^j,12),I=I+G|0,U=nt(U^I,8),j=j+U|0,G=nt(G^j,7),T=T+L|0,W=nt(W^T,16),q=q+W|0,L=nt(L^q,12),T=T+L|0,W=nt(W^T,8),q=q+W|0,L=nt(L^q,7);let H=0;n[H++]=o+k|0,n[H++]=a+x|0,n[H++]=c+I|0,n[H++]=l+T|0,n[H++]=d+L|0,n[H++]=h+z|0,n[H++]=p+B|0,n[H++]=m+G|0,n[H++]=f+j|0,n[H++]=g+q|0,n[H++]=v+Q|0,n[H++]=y+K|0,n[H++]=w+O|0,n[H++]=b+U|0,n[H++]=E+W|0,n[H++]=A+Y|0}const H2e=F2e(j2e,{counterRight:!1,counterLength:4,allowShortKeys:!1}),q2e=new Uint8Array(16),vT=(r,e)=>{r.update(e);const t=e.length%16;t&&r.update(q2e.subarray(t))},W2e=new Uint8Array(32);function ET(r,e,t,n,i){const s=r(e,t,W2e),o=K2e.create(s);i&&vT(o,i),vT(o,n);const a=new Uint8Array(16),c=k2e(a);wT(c,0,BigInt(i?i.length:0),!0),wT(c,8,BigInt(n.length),!0),o.update(a);const l=o.digest();return ih(s,a),l}const G2e=r=>(e,t,n)=>({encrypt(s,o){const a=s.length;o=mT(a+16,o,!1),o.set(s);const c=o.subarray(0,-16);r(e,t,c,c,1);const l=ET(r,e,t,c,n);return o.set(l,a),ih(l),o},decrypt(s,o){o=mT(s.length-16,o,!1);const a=s.subarray(0,-16),c=s.subarray(-16),l=ET(r,e,t,a,n);if(!D2e(c,l))throw new Error("invalid tag");return o.set(s.subarray(0,-16)),r(e,t,o,o,1),ih(l),o}}),ST=$2e({blockSize:64,nonceLength:12,tagLength:16},G2e(H2e));function Q2e(r,e,t){return uw(r),t===void 0&&(t=new Uint8Array(r.outputLen)),yw(r,q1(t),q1(e))}const g8=Uint8Array.from([0]),xT=Uint8Array.of();function Y2e(r,e,t,n=32){uw(r),bd(n);const i=r.outputLen;if(n>255*i)throw new Error("Length should be <= 255*HashLen");const s=Math.ceil(n/i);t===void 0&&(t=xT);const o=new Uint8Array(s*i),a=yw.create(r,e),c=a._cloneInto(),l=new Uint8Array(a.outputLen);for(let d=0;d<s;d++)g8[0]=d+1,c.update(d===0?xT:l).update(t).update(g8).digestInto(l),o.set(l,i*d),a._cloneInto(c);return a.destroy(),c.destroy(),Hs(l,g8),o.slice(0,n)}const J2e={hashSHA256(r){return Nl(r.subarray())},getHKDF(r,e){const t=Q2e(Nl,e,r),i=Y2e(Nl,t,void 0,96),s=i.subarray(0,32),o=i.subarray(32,64),a=i.subarray(64,96);return[s,o,a]},generateX25519KeyPair(){const r=q0.utils.randomPrivateKey();return{publicKey:q0.getPublicKey(r),privateKey:r}},generateX25519KeyPairFromSeed(r){return{publicKey:q0.getPublicKey(r),privateKey:r}},generateX25519SharedKey(r,e){return q0.getSharedSecret(r.subarray(),e.subarray())},chaCha20Poly1305Encrypt(r,e,t,n){return ST(n,e,t).encrypt(r.subarray())},chaCha20Poly1305Decrypt(r,e,t,n,i){return ST(n,e,t).decrypt(r.subarray(),i)}},X2e=J2e;function Z2e(r){return{generateKeypair:r.generateX25519KeyPair,dh:(e,t)=>r.generateX25519SharedKey(e.privateKey,t).subarray(0,32),encrypt:r.chaCha20Poly1305Encrypt,decrypt:r.chaCha20Poly1305Decrypt,hash:r.hashSHA256,hkdf:r.getHKDF}}const om=r=>{const e=Mn(2);return e[0]=r>>8,e[1]=r,e};om.bytes=2;const o2=r=>{if(r.length<2)throw RangeError("Could not decode int16BE");if(r instanceof Uint8Array){let e=0;return e+=r[0]<<8,e+=r[1],e}return r.getUint16(0)};o2.bytes=2;function eye(r){return{xxHandshakeSuccesses:r.registerCounter("libp2p_noise_xxhandshake_successes_total",{help:"Total count of noise xxHandshakes successes_"}),xxHandshakeErrors:r.registerCounter("libp2p_noise_xxhandshake_error_total",{help:"Total count of noise xxHandshakes errors"}),encryptedPackets:r.registerCounter("libp2p_noise_encrypted_packets_total",{help:"Total count of noise encrypted packets successfully"}),decryptedPackets:r.registerCounter("libp2p_noise_decrypted_packets_total",{help:"Total count of noise decrypted packets"}),decryptErrors:r.registerCounter("libp2p_noise_decrypt_errors_total",{help:"Total count of noise decrypt errors"})}}function fV(r,e){!e.enabled||!Wp||(r?(e(`LOCAL_STATIC_PUBLIC_KEY ${re(r.publicKey,"hex")}`),e(`LOCAL_STATIC_PRIVATE_KEY ${re(r.privateKey,"hex")}`)):e("Missing local static keys."))}function pV(r,e){!e.enabled||!Wp||(r?(e(`LOCAL_PUBLIC_EPHEMERAL_KEY ${re(r.publicKey,"hex")}`),e(`LOCAL_PRIVATE_EPHEMERAL_KEY ${re(r.privateKey,"hex")}`)):e("Missing local ephemeral keys."))}function tye(r,e){!e.enabled||!Wp||e(r?`REMOTE_STATIC_PUBLIC_KEY ${re(r.subarray(),"hex")}`:"Missing remote static public key.")}function gV(r,e){!e.enabled||!Wp||e(r?`REMOTE_EPHEMERAL_PUBLIC_KEY ${re(r.subarray(),"hex")}`:"Missing remote ephemeral keys.")}function yV(r,e,t){!t.enabled||!Wp||(t(`CIPHER_STATE_1 ${r.n.getUint64()} ${r.k&&re(r.k,"hex")}`),t(`CIPHER_STATE_2 ${e.n.getUint64()} ${e.k&&re(e.k,"hex")}`))}function kc(r,e){if(r.length!==e.length)throw new Error("Inputs should have the same length");const t=Mn(r.length);for(let n=0;n<r.length;n++)t[n]=r[n]^e[n];return t}const g3=class g3 extends Error{constructor(t="Invalid crypto exchange"){super(t);u(this,"code");this.code=g3.code}};u(g3,"code","ERR_INVALID_CRYPTO_EXCHANGE");let c1=g3;const rye=0,nye=4294967295,iye="Cipherstate has reached maximum n, a new handshake must be performed";class sye{constructor(e=rye){u(this,"n");u(this,"bytes");u(this,"view");this.n=e,this.bytes=Ye(12),this.view=new DataView(this.bytes.buffer,this.bytes.byteOffset,this.bytes.byteLength),this.view.setUint32(4,e,!0)}increment(){this.n++,this.view.setUint32(4,this.n,!0)}getBytes(){return this.bytes}getUint64(){return this.n}assertValue(){if(this.n>nye)throw new Error(iye)}}const Sd=Ye(0);class cg{constructor(e,t=void 0,n=0){u(this,"k");u(this,"n");u(this,"crypto");this.crypto=e,this.k=t,this.n=new sye(n)}hasKey(){return!!this.k}encryptWithAd(e,t){if(!this.hasKey())return t;this.n.assertValue();const n=this.crypto.encrypt(t,this.n.getBytes(),e,this.k);return this.n.increment(),n}decryptWithAd(e,t,n){if(!this.hasKey())return t;this.n.assertValue();const i=this.crypto.decrypt(t,this.n.getBytes(),e,this.k,n);return this.n.increment(),i}}class oye{constructor(e,t){u(this,"cs");u(this,"ck");u(this,"h");u(this,"crypto");this.crypto=e;const n=oe(t,"utf-8");this.h=cye(e,n),this.ck=this.h,this.cs=new cg(e)}mixKey(e){const[t,n]=this.crypto.hkdf(this.ck,e);this.ck=t,this.cs=new cg(this.crypto,n)}mixHash(e){this.h=this.crypto.hash(new Ue(this.h,e))}encryptAndHash(e){const t=this.cs.encryptWithAd(this.h,e);return this.mixHash(t),t}decryptAndHash(e){const t=this.cs.decryptWithAd(this.h,e);return this.mixHash(e),t}split(){const[e,t]=this.crypto.hkdf(this.ck,Sd);return[new cg(this.crypto,e),new cg(this.crypto,t)]}}class aye{constructor(e){u(this,"ss");u(this,"s");u(this,"e");u(this,"rs");u(this,"re");u(this,"initiator");u(this,"crypto");const{crypto:t,protocolName:n,prologue:i,initiator:s,s:o,e:a,rs:c,re:l}=e;this.crypto=t,this.ss=new oye(t,n),this.ss.mixHash(i),this.initiator=s,this.s=o,this.e=a,this.rs=c,this.re=l}writeE(){if(this.e)throw new Error("ephemeral keypair is already set");const e=this.crypto.generateKeypair();return this.ss.mixHash(e.publicKey),this.e=e,e.publicKey}writeS(){if(!this.s)throw new Error("static keypair is not set");return this.ss.encryptAndHash(this.s.publicKey)}writeEE(){if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.re))}writeES(){if(this.initiator){if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.rs)throw new Error("remote static public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.rs))}else{if(!this.s)throw new Error("static keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.s,this.re))}}writeSE(){if(this.initiator){if(!this.s)throw new Error("static keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.s,this.re))}else{if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.rs)throw new Error("remote static public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.rs))}}readE(e,t=0){if(this.re)throw new Error("remote ephemeral public key is already set");if(e.byteLength<t+32)throw new Error("message is not long enough");this.re=e.sublist(t,t+32),this.ss.mixHash(this.re)}readS(e,t=0){if(this.rs)throw new Error("remote static public key is already set");const n=32+(this.ss.cs.hasKey()?16:0);if(e.byteLength<t+n)throw new Error("message is not long enough");const i=e.sublist(t,t+n);return this.rs=this.ss.decryptAndHash(i),n}readEE(){this.writeEE()}readES(){this.writeES()}readSE(){this.writeSE()}}class mV extends aye{writeMessageA(e){return new Ue(this.writeE(),this.ss.encryptAndHash(e))}writeMessageB(e){const t=this.writeE();this.writeEE();const n=this.writeS();return this.writeES(),new Ue(t,n,this.ss.encryptAndHash(e))}writeMessageC(e){const t=this.writeS();return this.writeSE(),new Ue(t,this.ss.encryptAndHash(e))}readMessageA(e){try{return this.readE(e),this.ss.decryptAndHash(e.sublist(32))}catch(t){throw new c1(`handshake stage 0 validation fail: ${t.message}`)}}readMessageB(e){try{this.readE(e),this.readEE();const t=this.readS(e,32);return this.readES(),this.ss.decryptAndHash(e.sublist(32+t))}catch(t){throw new c1(`handshake stage 1 validation fail: ${t.message}`)}}readMessageC(e){try{const t=this.readS(e);return this.readSE(),this.ss.decryptAndHash(e.sublist(t))}catch(t){throw new c1(`handshake stage 2 validation fail: ${t.message}`)}}}function cye(r,e){if(e.length<=32){const t=Ye(32);return t.set(e),t}else return r.hash(e)}var am;(function(r){let e;r.codec=()=>(e==null&&(e=$e((t,n,i={})=>{if(i.lengthDelimited!==!1&&n.fork(),t.webtransportCerthashes!=null)for(const s of t.webtransportCerthashes)n.uint32(10),n.bytes(s);if(t.streamMuxers!=null)for(const s of t.streamMuxers)n.uint32(18),n.string(s);i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{var a,c;const s={webtransportCerthashes:[],streamMuxers:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{if(((a=i.limits)==null?void 0:a.webtransportCerthashes)!=null&&s.webtransportCerthashes.length===i.limits.webtransportCerthashes)throw new pt('Decode error - map field "webtransportCerthashes" had too many elements');s.webtransportCerthashes.push(t.bytes());break}case 2:{if(((c=i.limits)==null?void 0:c.streamMuxers)!=null&&s.streamMuxers.length===i.limits.streamMuxers)throw new pt('Decode error - map field "streamMuxers" had too many elements');s.streamMuxers.push(t.string());break}default:{t.skipType(l&7);break}}}return s})),e),r.encode=t=>De(t,r.codec()),r.decode=(t,n)=>Pe(t,r.codec(),n)})(am||(am={}));var cm;(function(r){let e;r.codec=()=>(e==null&&(e=$e((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.identityKey!=null&&t.identityKey.byteLength>0&&(n.uint32(10),n.bytes(t.identityKey)),t.identitySig!=null&&t.identitySig.byteLength>0&&(n.uint32(18),n.bytes(t.identitySig)),t.extensions!=null&&(n.uint32(34),am.codec().encode(t.extensions,n)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{var a;const s={identityKey:Ye(0),identitySig:Ye(0)},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const c=t.uint32();switch(c>>>3){case 1:{s.identityKey=t.bytes();break}case 2:{s.identitySig=t.bytes();break}case 4:{s.extensions=am.codec().decode(t,t.uint32(),{limits:(a=i.limits)==null?void 0:a.extensions});break}default:{t.skipType(c&7);break}}}return s})),e),r.encode=t=>De(t,r.codec()),r.decode=(t,n)=>Pe(t,r.codec(),n)})(cm||(cm={}));async function wV(r,e,t){const n=await r.sign(vV(e));return cm.encode({identityKey:Pi(r.publicKey),identitySig:n,extensions:t})}async function bV(r,e,t){try{const n=cm.decode(r),i=Rn(n.identityKey);if((t==null?void 0:t.equals(i))===!1)throw new Error(`Payload identity key ${i} does not match expected remote identity key ${t}`);if(!e)throw new Error("Remote static does not exist");const s=vV(e);if(!await i.verify(s,n.identitySig))throw new Error("Invalid payload signature");return n}catch(n){throw new tB(n.message)}}function vV(r){const e=oe("noise-libp2p-static-key:");return r instanceof Uint8Array?ir([e,r],e.length+r.length):(r.prepend(e),r)}async function lye(r,e){const{log:t,connection:n,crypto:i,privateKey:s,prologue:o,s:a,remoteIdentityKey:c,extensions:l}=r,d=await wV(s,a.publicKey,l),h=new mV({crypto:i,protocolName:"Noise_XX_25519_ChaChaPoly_SHA256",initiator:!0,prologue:o,s:a});fV(h.s,t),t.trace("Stage 0 - Initiator starting to send first message."),await n.write(h.writeMessageA(Sd),e),t.trace("Stage 0 - Initiator finished sending first message."),pV(h.e,t),t.trace("Stage 1 - Initiator waiting to receive first message from responder...");const p=h.readMessageB(await n.read(e));t.trace("Stage 1 - Initiator received the message."),gV(h.re,t),tye(h.rs,t),t.trace("Initiator going to check remote's signature...");const m=await bV(p,h.rs,c);t.trace("All good with the signature!"),t.trace("Stage 2 - Initiator sending third handshake message."),await n.write(h.writeMessageC(d),e),t.trace("Stage 2 - Initiator sent message with signed payload.");const[f,g]=h.ss.split();return yV(f,g,t),{payload:m,encrypt:v=>f.encryptWithAd(Sd,v),decrypt:(v,y)=>g.decryptWithAd(Sd,v,y)}}async function uye(r,e){const{log:t,connection:n,crypto:i,privateKey:s,prologue:o,s:a,remoteIdentityKey:c,extensions:l}=r,d=await wV(s,a.publicKey,l),h=new mV({crypto:i,protocolName:"Noise_XX_25519_ChaChaPoly_SHA256",initiator:!1,prologue:o,s:a});fV(h.s,t),t.trace("Stage 0 - Responder waiting to receive first message."),h.readMessageA(await n.read(e)),t.trace("Stage 0 - Responder received first message."),gV(h.re,t),t.trace("Stage 1 - Responder sending out first message with signed payload and static key."),await n.write(h.writeMessageB(d),e),t.trace("Stage 1 - Responder sent the second handshake message with signed payload."),pV(h.e,t),t.trace("Stage 2 - Responder waiting for third handshake message...");const p=h.readMessageC(await n.read(e));t.trace("Stage 2 - Responder received the message, finished handshake.");const m=await bV(p,h.rs,c),[f,g]=h.ss.split();return yV(f,g,t),{payload:m,encrypt:v=>g.encryptWithAd(Sd,v),decrypt:(v,y)=>f.decryptWithAd(Sd,v,y)}}const AT=16;function dye(r,e){return async function*(t){for await(const n of t)for(let i=0;i<n.length;i+=pT){let s=i+pT;s>n.length&&(s=n.length);let o;n instanceof Uint8Array?o=r.encrypt(n.subarray(i,s)):o=r.encrypt(n.sublist(i,s)),e==null||e.encryptedPackets.increment(),yield new Ue(om(o.byteLength),o)}}}function hye(r,e){return async function*(t){for await(const n of t)for(let i=0;i<n.length;i+=rp){let s=i+rp;if(s>n.length&&(s=n.length),s-AT<i)throw new Error("Invalid chunk");const o=n.sublist(i,s),a=n.subarray(i,s-AT);try{const c=r.decrypt(o,a);e==null||e.decryptedPackets.increment(),yield c}catch(c){throw e==null||e.decryptErrors.increment(),c}}}}var EN,SN;SN=Symbol.toStringTag,EN=fr;class fye{constructor(e,t={}){u(this,"protocol","/noise");u(this,"crypto");u(this,"prologue");u(this,"staticKey");u(this,"extensions");u(this,"metrics");u(this,"components");u(this,SN,"@chainsafe/libp2p-noise");u(this,EN,["@libp2p/connection-encryption","@chainsafe/libp2p-noise"]);const{staticNoiseKey:n,extensions:i,crypto:s,prologueBytes:o}=t,{metrics:a}=e;this.components=e;const c=s??X2e;this.crypto=Z2e(c),this.extensions={webtransportCerthashes:[],...i},this.metrics=a?eye(a):void 0,n?this.staticKey=c.generateX25519KeyPairFromSeed(n):this.staticKey=c.generateX25519KeyPair(),this.prologue=o??Ye(0)}async secureOutbound(e,t){var a,c;const n=nh(e,{lengthEncoder:om,lengthDecoder:o2,maxDataLength:rp}),i=await this.performHandshakeInitiator(n,this.components.privateKey,(a=t==null?void 0:t.remotePeer)==null?void 0:a.publicKey,t),s=await this.createSecureConnection(n,i);e.source=s.source,e.sink=s.sink;const o=Rn(i.payload.identityKey);return{conn:e,remoteExtensions:i.payload.extensions,remotePeer:Jd(o),streamMuxer:this.getStreamMuxer((c=i.payload.extensions)==null?void 0:c.streamMuxers)}}getStreamMuxer(e){if(e==null)return;const t=this.components.upgrader.getStreamMuxers();if(t!=null)for(const n of e){const i=t.get(n);if(i!=null)return i}if(e.length)throw new LZ("Early muxer negotiation was requested but the initiator and responder had no common muxers")}async secureInbound(e,t){var a,c;const n=nh(e,{lengthEncoder:om,lengthDecoder:o2,maxDataLength:rp}),i=await this.performHandshakeResponder(n,this.components.privateKey,(a=t==null?void 0:t.remotePeer)==null?void 0:a.publicKey,t),s=await this.createSecureConnection(n,i);e.source=s.source,e.sink=s.sink;const o=Rn(i.payload.identityKey);return{conn:e,remoteExtensions:i.payload.extensions,remotePeer:Jd(o),streamMuxer:this.getStreamMuxer((c=i.payload.extensions)==null?void 0:c.streamMuxers)}}async performHandshakeInitiator(e,t,n,i){var o,a;let s;try{s=await lye({connection:e,privateKey:t,remoteIdentityKey:n,log:this.components.logger.forComponent("libp2p:noise:xxhandshake"),crypto:this.crypto,prologue:this.prologue,s:this.staticKey,extensions:{streamMuxers:[...this.components.upgrader.getStreamMuxers().keys()],webtransportCerthashes:[],...this.extensions}},i),(o=this.metrics)==null||o.xxHandshakeSuccesses.increment()}catch(c){throw(a=this.metrics)==null||a.xxHandshakeErrors.increment(),c}return s}async performHandshakeResponder(e,t,n,i){var o,a;let s;try{s=await uye({connection:e,privateKey:t,remoteIdentityKey:n,log:this.components.logger.forComponent("libp2p:noise:xxhandshake"),crypto:this.crypto,prologue:this.prologue,s:this.staticKey,extensions:{streamMuxers:[...this.components.upgrader.getStreamMuxers().keys()],webtransportCerthashes:[],...this.extensions}},i),(o=this.metrics)==null||o.xxHandshakeSuccesses.increment()}catch(c){throw(a=this.metrics)==null||a.xxHandshakeErrors.increment(),c}return s}async createSecureConnection(e,t){const[n,i]=C2e(),s=e.unwrap();return await hn(n,dye(t,this.metrics),s,o=>Yd(o,{lengthDecoder:o2}),hye(t,this.metrics),n),i}}function EV(r={}){return e=>new fye(e,r)}function SV(r){if(r!=null){if(typeof r[Symbol.iterator]=="function")return r[Symbol.iterator]();if(typeof r[Symbol.asyncIterator]=="function")return r[Symbol.asyncIterator]();if(typeof r.next=="function")return r}throw new Error("argument is not an iterator or iterable")}class wl extends Error{constructor(e="The frame was invalid"){super(e),this.name="InvalidFrameError"}}u(wl,"name","InvalidFrameError");class mx extends Error{constructor(e="Unrequested ping error"){super(e),this.name="UnrequestedPingError"}}u(mx,"name","UnrequestedPingError");class wx extends Error{constructor(e="Unrequested ping error"){super(e),this.name="NotMatchingPingError"}}u(wx,"name","NotMatchingPingError");class xV extends Error{constructor(e="Invalid state"){super(e),this.name="InvalidStateError"}}u(xV,"name","InvalidStateError");class AV extends Error{constructor(e="Strean already exists"){super(e),this.name="StreamAlreadyExistsError"}}u(AV,"name","StreamAlreadyExistsError");class CV extends Error{constructor(e="Decode invalid version"){super(e),this.name="DecodeInvalidVersionError"}}u(CV,"name","DecodeInvalidVersionError");class IV extends Error{constructor(e="Both clients"){super(e),this.name="BothClientsError"}}u(IV,"name","BothClientsError");class bx extends Error{constructor(e="Receive window exceeded"){super(e),this.name="ReceiveWindowExceededError"}}u(bx,"name","ReceiveWindowExceededError");const pye=new Set([wl.name,mx.name,wx.name,AV.name,CV.name,IV.name,bx.name]),vx=256*1024,gye=16*1024*1024,yye={enableKeepAlive:!0,keepAliveInterval:3e4,maxInboundStreams:1e3,maxOutboundStreams:1e3,initialStreamWindowSize:vx,maxStreamWindowSize:gye,maxMessageSize:64*1024};function mye(r){if(r.keepAliveInterval<=0)throw new Z("keep-alive interval must be positive");if(r.maxInboundStreams<0)throw new Z("max inbound streams must be larger or equal 0");if(r.maxOutboundStreams<0)throw new Z("max outbound streams must be larger or equal 0");if(r.initialStreamWindowSize<vx)throw new Z("InitialStreamWindowSize must be larger or equal 256 kB");if(r.maxStreamWindowSize<r.initialStreamWindowSize)throw new Z("MaxStreamWindowSize must be larger than the InitialStreamWindowSize");if(r.maxStreamWindowSize>2**32-1)throw new Z("MaxStreamWindowSize must be less than equal MAX_UINT32");if(r.maxMessageSize<1024)throw new Z("MaxMessageSize must be greater than a kilobyte")}var tr;(function(r){r[r.Data=0]="Data",r[r.WindowUpdate=1]="WindowUpdate",r[r.Ping=2]="Ping",r[r.GoAway=3]="GoAway"})(tr||(tr={}));var Vt;(function(r){r[r.SYN=1]="SYN",r[r.ACK=2]="ACK",r[r.FIN=4]="FIN",r[r.RST=8]="RST"})(Vt||(Vt={}));Object.values(Vt).filter(r=>typeof r!="string");const wye=0;var Ds;(function(r){r[r.NormalTermination=0]="NormalTermination",r[r.ProtocolError=1]="ProtocolError",r[r.InternalError=2]="InternalError"})(Ds||(Ds={}));const l1=12,CT=2**24;function bye(r){if(r[0]!==wye)throw new wl("Invalid frame version");return{type:r[1],flag:(r[2]<<8)+r[3],streamID:r[4]*CT+(r[5]<<16)+(r[6]<<8)+r[7],length:r[8]*CT+(r[9]<<16)+(r[10]<<8)+r[11]}}let vye=class{constructor(e){u(this,"source");u(this,"buffer");u(this,"frameInProgress");this.source=Eye(e),this.buffer=new Ue,this.frameInProgress=!1}async*emitFrames(){for await(const e of this.source)for(this.buffer.append(e);;){const t=this.readHeader();if(t===void 0)break;const{type:n,length:i}=t;n===tr.Data?(this.frameInProgress=!0,yield{header:t,readData:this.readBytes.bind(this,i)}):yield{header:t}}}readHeader(){if(this.frameInProgress)throw new xV("decoding frame already in progress");if(this.buffer.length<l1)return;const e=bye(this.buffer.subarray(0,l1));return this.buffer.consume(l1),e}async readBytes(e){if(this.buffer.length<e){for await(const n of this.source)if(this.buffer.append(n),this.buffer.length>=e)break}const t=this.buffer.sublist(0,e);return this.buffer.consume(e),this.frameInProgress=!1,t}};function Eye(r){if(r[Symbol.iterator]!==void 0){const e=r[Symbol.iterator]();return e.return=void 0,{[Symbol.iterator](){return e}}}else if(r[Symbol.asyncIterator]!==void 0){const e=r[Symbol.asyncIterator]();return e.return=void 0,{[Symbol.asyncIterator](){return e}}}else throw new Error("a source must be either an iterable or an async iterable")}function IT(r){const e=new Uint8Array(l1);return e[1]=r.type,e[2]=r.flag>>>8,e[3]=r.flag,e[4]=r.streamID>>>24,e[5]=r.streamID>>>16,e[6]=r.streamID>>>8,e[7]=r.streamID,e[8]=r.length>>>24,e[9]=r.length>>>16,e[10]=r.length>>>8,e[11]=r.length,e}function Sye(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}function kV(r,e){var n,i;const t=(i=(n=SV(r)).return)==null?void 0:i.call(n);Sye(t)&&t.catch(s=>{e.error("could not cause iterator to return",s)})}const xye=5e3;function y8(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}class Ex{constructor(e){u(this,"id");u(this,"direction");u(this,"timeline");u(this,"protocol");u(this,"metadata");u(this,"source");u(this,"status");u(this,"readStatus");u(this,"writeStatus");u(this,"log");u(this,"sinkController");u(this,"sinkEnd");u(this,"closed");u(this,"endErr");u(this,"streamSource");u(this,"onEnd");u(this,"onCloseRead");u(this,"onCloseWrite");u(this,"onReset");u(this,"onAbort");u(this,"sendCloseWriteTimeout");u(this,"sendingData");this.sinkController=new AbortController,this.sinkEnd=Le(),this.closed=Le(),this.log=e.log,this.status="open",this.readStatus="ready",this.writeStatus="ready",this.id=e.id,this.metadata=e.metadata??{},this.direction=e.direction,this.timeline={open:Date.now()},this.sendCloseWriteTimeout=e.sendCloseWriteTimeout??xye,this.onEnd=e.onEnd,this.onCloseRead=e==null?void 0:e.onCloseRead,this.onCloseWrite=e==null?void 0:e.onCloseWrite,this.onReset=e==null?void 0:e.onReset,this.onAbort=e==null?void 0:e.onAbort,this.source=this.streamSource=Fo({onEnd:t=>{t!=null?this.log.trace("source ended with error",t):this.log.trace("source ended"),this.onSourceEnd(t)}}),this.sink=this.sink.bind(this)}async sink(e){if(this.writeStatus!=="ready")throw new ry(`writable end state is "${this.writeStatus}" not "ready"`);try{this.writeStatus="writing";const t={signal:this.sinkController.signal};if(this.direction==="outbound"){const i=this.sendNewStream(t);y8(i)&&await i}const n=()=>{kV(e,this.log)};try{this.sinkController.signal.addEventListener("abort",n),this.log.trace("sink reading from source");for await(let i of e){i=i instanceof Uint8Array?new Ue(i):i;const s=this.sendData(i,t);y8(s)&&(this.sendingData=Le(),await s,this.sendingData.resolve(),this.sendingData=void 0)}}finally{this.sinkController.signal.removeEventListener("abort",n)}this.log.trace('sink finished reading from source, write status is "%s"',this.writeStatus),this.writeStatus==="writing"&&(this.writeStatus="closing",this.log.trace("send close write to remote"),await this.sendCloseWrite({signal:AbortSignal.timeout(this.sendCloseWriteTimeout)}),this.writeStatus="closed"),this.onSinkEnd()}catch(t){throw this.log.trace("sink ended with error, calling abort with error",t),this.abort(t),t}finally{this.log.trace("resolve sink end"),this.sinkEnd.resolve()}}onSourceEnd(e){var t;this.timeline.closeRead==null&&(this.timeline.closeRead=Date.now(),this.readStatus="closed",e!=null&&this.endErr==null&&(this.endErr=e),(t=this.onCloseRead)==null||t.call(this),this.timeline.closeWrite!=null?(this.log.trace("source and sink ended"),this.timeline.close=Date.now(),this.status!=="aborted"&&this.status!=="reset"&&(this.status="closed"),this.onEnd!=null&&this.onEnd(this.endErr),this.closed.resolve()):this.log.trace("source ended, waiting for sink to end"))}onSinkEnd(e){var t;this.timeline.closeWrite==null&&(this.timeline.closeWrite=Date.now(),this.writeStatus="closed",e!=null&&this.endErr==null&&(this.endErr=e),(t=this.onCloseWrite)==null||t.call(this),this.timeline.closeRead!=null?(this.log.trace("sink and source ended"),this.timeline.close=Date.now(),this.status!=="aborted"&&this.status!=="reset"&&(this.status="closed"),this.onEnd!=null&&this.onEnd(this.endErr),this.closed.resolve()):this.log.trace("sink ended, waiting for source to end"))}async close(e){this.status==="open"&&(this.log.trace("closing gracefully"),this.status="closing",await cn(Promise.all([this.closeWrite(e),this.closeRead(e),this.closed.promise]),e==null?void 0:e.signal),this.status="closed",this.log.trace("closed gracefully"))}async closeRead(e={}){if(this.readStatus==="closing"||this.readStatus==="closed")return;this.log.trace('closing readable end of stream with starting read status "%s"',this.readStatus);const t=this.readStatus;this.readStatus="closing",this.status!=="reset"&&this.status!=="aborted"&&this.timeline.closeRead==null&&(this.log.trace("send close read to remote"),await this.sendCloseRead(e)),t==="ready"&&(this.log.trace("ending internal source queue with %d queued bytes",this.streamSource.readableLength),this.streamSource.end()),this.log.trace("closed readable end of stream")}async closeWrite(e={}){this.writeStatus==="closing"||this.writeStatus==="closed"||(this.log.trace('closing writable end of stream with starting write status "%s"',this.writeStatus),this.writeStatus==="ready"&&(this.log.trace("sink was never sunk, sink an empty array"),await cn(this.sink([]),e.signal)),this.writeStatus==="writing"&&(this.sendingData!=null&&await cn(this.sendingData.promise,e.signal),this.log.trace("aborting source passed to .sink"),this.sinkController.abort(),await cn(this.sinkEnd.promise,e.signal)),this.writeStatus="closed",this.log.trace("closed writable end of stream"))}abort(e){var n;if(this.status==="closed"||this.status==="aborted"||this.status==="reset")return;this.log("abort with error",e),this.log("try to send reset to remote");const t=this.sendReset();y8(t)&&t.catch(i=>{this.log.error("error sending reset message",i)}),this.status="aborted",this.timeline.abort=Date.now(),this._closeSinkAndSource(e),(n=this.onAbort)==null||n.call(this,e)}reset(){var t;if(this.status==="closed"||this.status==="aborted"||this.status==="reset")return;const e=new nB("stream reset");this.status="reset",this.timeline.reset=Date.now(),this._closeSinkAndSource(e),(t=this.onReset)==null||t.call(this)}_closeSinkAndSource(e){this._closeSink(e),this._closeSource(e)}_closeSink(e){this.writeStatus==="writing"&&(this.log.trace("end sink source"),this.sinkController.abort()),this.onSinkEnd(e)}_closeSource(e){this.readStatus!=="closing"&&this.readStatus!=="closed"&&(this.log.trace("ending source with %d bytes to be read by consumer",this.streamSource.readableLength),this.readStatus="closing",this.streamSource.end(e))}remoteCloseWrite(){if(this.readStatus==="closing"||this.readStatus==="closed"){this.log("received remote close write but local source is already closed");return}this.log.trace("remote close write"),this._closeSource()}remoteCloseRead(){if(this.writeStatus==="closing"||this.writeStatus==="closed"){this.log("received remote close read but local sink is already closed");return}this.log.trace("remote close read"),this._closeSink()}destroy(){if(this.status==="closed"||this.status==="aborted"||this.status==="reset"){this.log("received destroy but we are already closed");return}this.log.trace("stream destroyed"),this._closeSinkAndSource()}sourcePush(e){this.streamSource.push(e)}sourceReadableLength(){return this.streamSource.readableLength}}var es;(function(r){r[r.Init=0]="Init",r[r.SYNSent=1]="SYNSent",r[r.SYNReceived=2]="SYNReceived",r[r.Established=3]="Established",r[r.Finished=4]="Finished"})(es||(es={}));class Aye extends Ex{constructor(t){super({...t,onEnd:n=>{var i;this.state=es.Finished,(i=t.onEnd)==null||i.call(t,n)}});u(this,"name");u(this,"state");u(this,"config");u(this,"_id");u(this,"sendWindowCapacity");u(this,"sendWindowCapacityUpdate");u(this,"recvWindow");u(this,"recvWindowCapacity");u(this,"epochStart");u(this,"getRTT");u(this,"sendFrame");this.config=t.config,this._id=parseInt(t.id,10),this.name=t.name,this.state=t.state,this.sendWindowCapacity=vx,this.recvWindow=this.config.initialStreamWindowSize,this.recvWindowCapacity=this.recvWindow,this.epochStart=Date.now(),this.getRTT=t.getRTT,this.sendFrame=t.sendFrame,this.source=Ly(this.source,()=>{this.sendWindowUpdate()})}async sendNewStream(){}async sendData(t,n={}){var i,s;for(t=t.sublist();t.byteLength!==0;){if(this.sendWindowCapacity===0&&((i=this.log)==null||i.trace("wait for send window capacity, status %s",this.status),await this.waitForSendWindowCapacity(n),this.status==="closed"||this.status==="aborted"||this.status==="reset")){(s=this.log)==null||s.trace("%s while waiting for send window capacity",this.status);return}const o=Math.min(this.sendWindowCapacity,this.config.maxMessageSize-l1,t.length),a=this.getSendFlags();this.sendFrame({type:tr.Data,flag:a,streamID:this._id,length:o},t.sublist(0,o)),this.sendWindowCapacity-=o,t.consume(o)}}async sendReset(){this.sendFrame({type:tr.WindowUpdate,flag:Vt.RST,streamID:this._id,length:0})}async sendCloseWrite(){const t=this.getSendFlags()|Vt.FIN;this.sendFrame({type:tr.WindowUpdate,flag:t,streamID:this._id,length:0})}async sendCloseRead(){}async waitForSendWindowCapacity(t={}){var o,a;if(this.sendWindowCapacity>0)return;let n,i;const s=()=>{this.status==="open"||this.status==="closing"?i(new Hl("Stream aborted")):n()};(o=t.signal)==null||o.addEventListener("abort",s);try{await new Promise((c,l)=>{this.sendWindowCapacityUpdate=()=>{c()},i=l,n=c})}finally{(a=t.signal)==null||a.removeEventListener("abort",s)}}handleWindowUpdate(t){var i,s;(i=this.log)==null||i.trace("stream received window update id=%s",this._id),this.processFlags(t.flag);const n=this.sendWindowCapacity;this.sendWindowCapacity+=t.length,n===0&&t.length>0&&((s=this.sendWindowCapacityUpdate)==null||s.call(this))}async handleData(t,n){var s;if((s=this.log)==null||s.trace("stream received data id=%s",this._id),this.processFlags(t.flag),this.recvWindowCapacity<t.length)throw new bx("Receive window exceeded");const i=await n();this.recvWindowCapacity-=t.length,this.sourcePush(i)}processFlags(t){(t&Vt.ACK)===Vt.ACK&&this.state===es.SYNSent&&(this.state=es.Established),(t&Vt.FIN)===Vt.FIN&&this.remoteCloseWrite(),(t&Vt.RST)===Vt.RST&&this.reset()}getSendFlags(){switch(this.state){case es.Init:return this.state=es.SYNSent,Vt.SYN;case es.SYNReceived:return this.state=es.Established,Vt.ACK;default:return 0}}sendWindowUpdate(){const t=this.getSendFlags(),n=Date.now(),i=this.getRTT();if(t===0&&i>-1&&n-this.epochStart<i*4&&(this.recvWindow=Math.min(this.recvWindow*2,this.config.maxStreamWindowSize)),this.recvWindowCapacity>=this.recvWindow&&t===0)return;const s=this.recvWindow-this.recvWindowCapacity;this.recvWindowCapacity=this.recvWindow,this.epochStart=n,this.sendFrame({type:tr.WindowUpdate,flag:t,streamID:this._id,length:s})}}const _V="/yamux/1.0.0",Cye=500;var xN,AN;AN=Symbol.toStringTag,xN=fr;class Iye{constructor(e,t={}){u(this,"protocol",_V);u(this,"_components");u(this,"_init");u(this,AN,"@chainsafe/libp2p-yamux");u(this,xN,["@libp2p/stream-multiplexing"]);this._components=e,this._init=t}createStreamMuxer(e){return new kye(this._components,{...this._init,...e})}}class kye{constructor(e,t){u(this,"protocol",_V);u(this,"source");u(this,"sink");u(this,"config");u(this,"log");u(this,"logger");u(this,"closeController");u(this,"nextStreamID");u(this,"_streams");u(this,"nextPingID");u(this,"activePing");u(this,"rtt");u(this,"client");u(this,"localGoAway");u(this,"remoteGoAway");u(this,"numInboundStreams");u(this,"numOutboundStreams");u(this,"onIncomingStream");u(this,"onStreamEnd");var n;this.client=t.direction==="outbound",this.config={...yye,...t},this.logger=e.logger,this.log=this.logger.forComponent("libp2p:yamux"),mye(this.config),this.closeController=new AbortController,this.closeController.signal,this.onIncomingStream=t.onIncomingStream,this.onStreamEnd=t.onStreamEnd,this._streams=new Map,this.source=Fo({onEnd:()=>{var i;(i=this.log)==null||i.trace("muxer source ended"),this._streams.forEach(s=>{s.destroy()})}}),this.sink=async i=>{var c,l,d;const s=()=>{const h=SV(i);if(h.return!=null){const p=h.return();_ye(p)&&p.catch(m=>{var f;(f=this.log)==null||f.call(this,"could not cause sink source to return",m)})}};let o,a;try{const h=new vye(i);try{this.closeController.signal.addEventListener("abort",s);for await(const p of h.emitFrames())await this.handleFrame(p.header,p.readData)}finally{this.closeController.signal.removeEventListener("abort",s)}o=Ds.NormalTermination}catch(h){pye.has(h.name)?((c=this.log)==null||c.error("protocol error in sink",h),o=Ds.ProtocolError):((l=this.log)==null||l.error("internal error in sink",h),o=Ds.InternalError),a=h}(d=this.log)==null||d.trace("muxer sink ended"),a!=null?this.abort(a,o):await this.close({reason:o})},this.numInboundStreams=0,this.numOutboundStreams=0,this.nextStreamID=this.client?1:2,this.nextPingID=0,this.rtt=-1,(n=this.log)==null||n.trace("muxer created"),this.config.enableKeepAlive&&this.keepAliveLoop().catch(i=>{var s;return(s=this.log)==null?void 0:s.error("keepalive error: %s",i)}),this.ping().catch(i=>{var s;return(s=this.log)==null?void 0:s.error("ping error: %s",i)})}get streams(){return Array.from(this._streams.values())}newStream(e){var i;if(this.remoteGoAway!==void 0)throw new al("Muxer closed remotely");if(this.localGoAway!==void 0)throw new al("Muxer closed locally");const t=this.nextStreamID;if(this.nextStreamID+=2,this.numOutboundStreams>=this.config.maxOutboundStreams)throw new tw("max outbound streams exceeded");(i=this.log)==null||i.trace("new outgoing stream id=%s",t);const n=this._newStream(t,e,es.Init,"outbound");return this._streams.set(t,n),this.numOutboundStreams++,n.sendWindowUpdate(),n}async ping(){if(this.remoteGoAway!==void 0)throw new al("Muxer closed remotely");if(this.localGoAway!==void 0)throw new al("Muxer closed locally");if(this.activePing===void 0){let e=()=>{};this.activePing={id:this.nextPingID++,promise:new Promise((i,s)=>{const o=()=>{s(new al("Muxer closed locally"))};this.closeController.signal.addEventListener("abort",o,{once:!0}),e=()=>{this.closeController.signal.removeEventListener("abort",o),i()}}),resolve:e};const t=Date.now();this.sendPing(this.activePing.id);try{await this.activePing.promise}finally{delete this.activePing}const n=Date.now();this.rtt=n-t}else await this.activePing.promise;return this.rtt}getRTT(){return this.rtt}async close(e={}){var n;if(this.closeController.signal.aborted)return;const t=(e==null?void 0:e.reason)??Ds.NormalTermination;if((n=this.log)==null||n.trace("muxer close reason=%s",t),e.signal==null){const i=AbortSignal.timeout(Cye);e={...e,signal:i}}try{await Promise.all([...this._streams.values()].map(async i=>i.close(e))),this.sendGoAway(t),this._closeMuxer()}catch(i){this.abort(i)}}abort(e,t){var n;if(!this.closeController.signal.aborted){t=t??Ds.InternalError,(n=this.log)==null||n.error("muxer abort reason=%s error=%s",t,e);for(const i of this._streams.values())i.abort(e);this.sendGoAway(t),this._closeMuxer()}}isClosed(){return this.closeController.signal.aborted}_closeMuxer(){this.closeController.abort(),this.source.end()}_newStream(e,t,n,i){if(this._streams.get(e)!=null)throw new Z("Stream already exists with that id");const s=new Aye({id:e.toString(),name:t,state:n,direction:i,sendFrame:this.sendFrame.bind(this),onEnd:()=>{var o;this.closeStream(e),(o=this.onStreamEnd)==null||o.call(this,s)},log:this.logger.forComponent(`libp2p:yamux:${i}:${e}`),config:this.config,getRTT:this.getRTT.bind(this)});return s}closeStream(e){this.client===(e%2===0)?this.numInboundStreams--:this.numOutboundStreams--,this._streams.delete(e)}async keepAliveLoop(){var t;const e=new Promise((n,i)=>{this.closeController.signal.addEventListener("abort",i,{once:!0})});for((t=this.log)==null||t.trace("muxer keepalive enabled interval=%s",this.config.keepAliveInterval);;){let n;try{await Promise.race([e,new Promise(i=>{n=setTimeout(i,this.config.keepAliveInterval)})]),this.ping().catch(i=>{var s;return(s=this.log)==null?void 0:s.error("ping error: %s",i)})}catch{clearInterval(n);return}}}async handleFrame(e,t){var o;const{streamID:n,type:i,length:s}=e;if((o=this.log)==null||o.trace("received frame %o",e),n===0)switch(i){case tr.Ping:{this.handlePing(e);return}case tr.GoAway:{this.handleGoAway(s);return}default:throw new wl("Invalid frame type")}else switch(e.type){case tr.Data:case tr.WindowUpdate:{await this.handleStreamMessage(e,t);return}default:throw new wl("Invalid frame type")}}handlePing(e){var t,n;if(e.flag===Vt.SYN)(t=this.log)==null||t.trace("received ping request pingId=%s",e.length),this.sendPing(e.length,Vt.ACK);else if(e.flag===Vt.ACK)(n=this.log)==null||n.trace("received ping response pingId=%s",e.length),this.handlePingResponse(e.length);else throw new wl("Invalid frame flag")}handlePingResponse(e){if(this.activePing===void 0)throw new mx("ping not requested");if(this.activePing.id!==e)throw new wx("ping doesn't match our id");this.activePing.resolve()}handleGoAway(e){var t;(t=this.log)==null||t.trace("received GoAway reason=%s",Ds[e]??"unknown"),this.remoteGoAway=e;for(const n of this._streams.values())n.reset();this._closeMuxer()}async handleStreamMessage(e,t){var a,c;const{streamID:n,flag:i,type:s}=e;(i&Vt.SYN)===Vt.SYN&&this.incomingStream(n);const o=this._streams.get(n);if(o===void 0){if(s===tr.Data){if((a=this.log)==null||a.call(this,"discarding data for stream id=%s",n),t===void 0)throw new Error("unreachable");await t()}else(c=this.log)==null||c.trace("frame for missing stream id=%s",n);return}switch(s){case tr.WindowUpdate:{o.handleWindowUpdate(e);return}case tr.Data:{if(t===void 0)throw new Error("unreachable");await o.handleData(e,t);return}default:throw new Error("unreachable")}}incomingStream(e){var n,i,s;if(this.client!==(e%2===0))throw new Z("Both endpoints are clients");if(this._streams.has(e))return;if((n=this.log)==null||n.trace("new incoming stream id=%s",e),this.localGoAway!==void 0){this.sendFrame({type:tr.WindowUpdate,flag:Vt.RST,streamID:e,length:0});return}if(this.numInboundStreams>=this.config.maxInboundStreams){(i=this.log)==null||i.call(this,"maxIncomingStreams exceeded, forcing stream reset"),this.sendFrame({type:tr.WindowUpdate,flag:Vt.RST,streamID:e,length:0});return}const t=this._newStream(e,void 0,es.SYNReceived,"inbound");this.numInboundStreams++,this._streams.set(e,t),(s=this.onIncomingStream)==null||s.call(this,t)}sendFrame(e,t){var n;if((n=this.log)==null||n.trace("sending frame %o",e),e.type===tr.Data){if(t===void 0)throw new wl("Invalid frame");this.source.push(new Ue(IT(e),t))}else this.source.push(IT(e))}sendPing(e,t=Vt.SYN){var n,i;t===Vt.SYN?(n=this.log)==null||n.trace("sending ping request pingId=%s",e):(i=this.log)==null||i.trace("sending ping response pingId=%s",e),this.sendFrame({type:tr.Ping,flag:t,streamID:0,length:e})}sendGoAway(e=Ds.NormalTermination){var t;(t=this.log)==null||t.call(this,"sending GoAway reason=%s",Ds[e]),this.localGoAway=e,this.sendFrame({type:tr.GoAway,flag:0,streamID:0,length:e})}}function _ye(r){return r!=null&&typeof r.then=="function"}function Tye(r={}){return e=>new Iye(e,r)}const Pye=41;function TV(r){try{const[[e,t]]=r.stringTuples();if(t==null)return!1;if(e===Pye)return Whe("2000::/3",t)}catch{}return!1}const Dye=4,$ye=41;function PV(r){try{const[[e]]=r.stringTuples();return e===Dye||e===$ye}catch{}return!1}function Zl(r){try{if(!PV(r))return!1;const[[,e]]=r.stringTuples();return e==null?!1:zc(e)??!1}catch{}return!0}function Nye(r,e,t){let n,i;function s(){const a={signal:i.signal};if((t==null?void 0:t.timeout)!=null){const c=dt([i.signal,AbortSignal.timeout(t.timeout)]);a.signal=c}Promise.resolve().then(async()=>{await r(a)}).catch(()=>{}).finally(()=>{i.signal.aborted||(n=setTimeout(s,e))})}let o=!1;return{setInterval:a=>{e=a,n!=null&&(clearTimeout(n),n=setTimeout(s,e))},setTimeout:a=>{t==null&&(t={}),t.timeout=a},start:()=>{o||(o=!0,i=new AbortController,i.signal,(t==null?void 0:t.runImmediately)===!0?queueMicrotask(()=>{s()}):n=setTimeout(s,e))},stop:()=>{clearTimeout(n),i==null||i.abort(),o=!1}}}function ti(r,e){const t=nh(r,e),n={read:async(i,s)=>{const o=await t.read(s);return i.decode(o)},write:async(i,s,o)=>{await t.write(s.encode(i),o)},writeV:async(i,s,o)=>{await t.writeV(i.map(a=>s.encode(a)),o)},pb:i=>({read:async s=>n.read(i,s),write:async(s,o)=>n.write(s,i,o),writeV:async(s,o)=>n.writeV(s,i,o),unwrap:()=>n}),unwrap:()=>t.unwrap()};return n}function Mye(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}var Oye=DV,kT=128,Rye=-128,Lye=Math.pow(2,31);function DV(r,e,t){e=e||[],t=t||0;for(var n=t;r>=Lye;)e[t++]=r&255|kT,r/=128;for(;r&Rye;)e[t++]=r&255|kT,r>>>=7;return e[t]=r|0,DV.bytes=t-n+1,e}var Bye=Pv,Uye=128,_T=127;function Pv(r,n){var t=0,n=n||0,i=0,s=n,o,a=r.length;do{if(s>=a)throw Pv.bytes=0,new RangeError("Could not decode varint");o=r[s++],t+=i<28?(o&_T)<<i:(o&_T)*Math.pow(2,i),i+=7}while(o>=Uye);return Pv.bytes=s-n,t}var Fye=Math.pow(2,7),zye=Math.pow(2,14),Vye=Math.pow(2,21),Kye=Math.pow(2,28),jye=Math.pow(2,35),Hye=Math.pow(2,42),qye=Math.pow(2,49),Wye=Math.pow(2,56),Gye=Math.pow(2,63),Qye=function(r){return r<Fye?1:r<zye?2:r<Vye?3:r<Kye?4:r<jye?5:r<Hye?6:r<qye?7:r<Wye?8:r<Gye?9:10},Yye={encode:Oye,decode:Bye,encodingLength:Qye},TT=Yye;function PT(r,e=0){return[TT.decode(r,e),TT.decode.bytes]}function Jye(r){const e=Mye(r),[t,n]=PT(e),[i,s]=PT(e.subarray(n)),o=e.subarray(n+s);if(o.byteLength!==i)throw new Error("Incorrect length");return new Xye(t,i,o,e)}let Xye=class{constructor(e,t,n,i){u(this,"code");u(this,"size");u(this,"digest");u(this,"bytes");this.code=e,this.size=t,this.digest=n,this.bytes=i}};const Zye="libp2p",eme="autonat",tme="1.0.0",rme=3e4,nme=2,ime=20,sme=80,ome=8192;var $t;(function(r){(function(i){i.DIAL="DIAL",i.DIAL_RESPONSE="DIAL_RESPONSE"})(r.MessageType||(r.MessageType={}));let e;(function(i){i[i.DIAL=0]="DIAL",i[i.DIAL_RESPONSE=1]="DIAL_RESPONSE"})(e||(e={})),function(i){i.codec=()=>On(e)}(r.MessageType||(r.MessageType={})),function(i){i.OK="OK",i.E_DIAL_ERROR="E_DIAL_ERROR",i.E_DIAL_REFUSED="E_DIAL_REFUSED",i.E_BAD_REQUEST="E_BAD_REQUEST",i.E_INTERNAL_ERROR="E_INTERNAL_ERROR"}(r.ResponseStatus||(r.ResponseStatus={}));let t;(function(i){i[i.OK=0]="OK",i[i.E_DIAL_ERROR=100]="E_DIAL_ERROR",i[i.E_DIAL_REFUSED=101]="E_DIAL_REFUSED",i[i.E_BAD_REQUEST=200]="E_BAD_REQUEST",i[i.E_INTERNAL_ERROR=300]="E_INTERNAL_ERROR"})(t||(t={})),function(i){i.codec=()=>On(t)}(r.ResponseStatus||(r.ResponseStatus={})),function(i){let s;i.codec=()=>(s==null&&(s=$e((o,a,c={})=>{if(c.lengthDelimited!==!1&&a.fork(),o.id!=null&&(a.uint32(10),a.bytes(o.id)),o.addrs!=null)for(const l of o.addrs)a.uint32(18),a.bytes(l);c.lengthDelimited!==!1&&a.ldelim()},(o,a,c={})=>{var h;const l={addrs:[]},d=a==null?o.len:o.pos+a;for(;o.pos<d;){const p=o.uint32();switch(p>>>3){case 1:{l.id=o.bytes();break}case 2:{if(((h=c.limits)==null?void 0:h.addrs)!=null&&l.addrs.length===c.limits.addrs)throw new pt('Decode error - map field "addrs" had too many elements');l.addrs.push(o.bytes());break}default:{o.skipType(p&7);break}}}return l})),s),i.encode=o=>De(o,i.codec()),i.decode=(o,a)=>Pe(o,i.codec(),a)}(r.PeerInfo||(r.PeerInfo={})),function(i){let s;i.codec=()=>(s==null&&(s=$e((o,a,c={})=>{c.lengthDelimited!==!1&&a.fork(),o.peer!=null&&(a.uint32(10),r.PeerInfo.codec().encode(o.peer,a)),c.lengthDelimited!==!1&&a.ldelim()},(o,a,c={})=>{var h;const l={},d=a==null?o.len:o.pos+a;for(;o.pos<d;){const p=o.uint32();switch(p>>>3){case 1:{l.peer=r.PeerInfo.codec().decode(o,o.uint32(),{limits:(h=c.limits)==null?void 0:h.peer});break}default:{o.skipType(p&7);break}}}return l})),s),i.encode=o=>De(o,i.codec()),i.decode=(o,a)=>Pe(o,i.codec(),a)}(r.Dial||(r.Dial={})),function(i){let s;i.codec=()=>(s==null&&(s=$e((o,a,c={})=>{c.lengthDelimited!==!1&&a.fork(),o.status!=null&&(a.uint32(8),r.ResponseStatus.codec().encode(o.status,a)),o.statusText!=null&&(a.uint32(18),a.string(o.statusText)),o.addr!=null&&(a.uint32(26),a.bytes(o.addr)),c.lengthDelimited!==!1&&a.ldelim()},(o,a,c={})=>{const l={},d=a==null?o.len:o.pos+a;for(;o.pos<d;){const h=o.uint32();switch(h>>>3){case 1:{l.status=r.ResponseStatus.codec().decode(o);break}case 2:{l.statusText=o.string();break}case 3:{l.addr=o.bytes();break}default:{o.skipType(h&7);break}}}return l})),s),i.encode=o=>De(o,i.codec()),i.decode=(o,a)=>Pe(o,i.codec(),a)}(r.DialResponse||(r.DialResponse={}));let n;r.codec=()=>(n==null&&(n=$e((i,s,o={})=>{o.lengthDelimited!==!1&&s.fork(),i.type!=null&&(s.uint32(8),r.MessageType.codec().encode(i.type,s)),i.dial!=null&&(s.uint32(18),r.Dial.codec().encode(i.dial,s)),i.dialResponse!=null&&(s.uint32(26),r.DialResponse.codec().encode(i.dialResponse,s)),o.lengthDelimited!==!1&&s.ldelim()},(i,s,o={})=>{var l,d;const a={},c=s==null?i.len:i.pos+s;for(;i.pos<c;){const h=i.uint32();switch(h>>>3){case 1:{a.type=r.MessageType.codec().decode(i);break}case 2:{a.dial=r.Dial.codec().decode(i,i.uint32(),{limits:(l=o.limits)==null?void 0:l.dial});break}case 3:{a.dialResponse=r.DialResponse.codec().decode(i,i.uint32(),{limits:(d=o.limits)==null?void 0:d.dialResponse});break}default:{i.skipType(h&7);break}}}return a})),n),r.encode=i=>De(i,r.codec()),r.decode=(i,s)=>Pe(i,r.codec(),s)})($t||($t={}));const ame=4,cme=8;var CN,IN;class lme{constructor(e,t){u(this,"components");u(this,"protocol");u(this,"timeout");u(this,"maxInboundStreams");u(this,"maxOutboundStreams");u(this,"maxMessageSize");u(this,"started");u(this,"log");u(this,"topologyId");u(this,"dialResults");u(this,"findPeers");u(this,"addressFilter");u(this,"connectionThreshold");u(this,IN,"@libp2p/autonat");u(this,CN,["@libp2p/autonat"]);this.components=e,this.log=e.logger.forComponent("libp2p:auto-nat"),this.started=!1,this.protocol=`/${t.protocolPrefix??Zye}/${eme}/${tme}`,this.timeout=t.timeout??rme,this.maxInboundStreams=t.maxInboundStreams??nme,this.maxOutboundStreams=t.maxOutboundStreams??ime,this.connectionThreshold=t.connectionThreshold??sme,this.maxMessageSize=t.maxMessageSize??ome,this.dialResults=new Map,this.findPeers=Nye(this.findRandomPeers.bind(this),6e4),this.addressFilter=Ql(1024)}get[(IN=Symbol.toStringTag,CN=fr,Ec)](){return["@libp2p/identify"]}isStarted(){return this.started}async start(){this.started||(await this.components.registrar.handle(this.protocol,e=>{this.handleIncomingAutonatStream(e).catch(t=>{this.log.error("error handling incoming autonat stream - %e",t)})},{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams}),this.topologyId=await this.components.registrar.register(this.protocol,{onConnect:(e,t)=>{this.verifyExternalAddresses(t).catch(n=>{this.log.error("could not verify addresses - %e",n)})}}),this.findPeers.start(),this.started=!0)}async stop(){await this.components.registrar.unhandle(this.protocol),this.topologyId!=null&&await this.components.registrar.unhandle(this.topologyId),this.dialResults.clear(),this.findPeers.stop(),this.started=!1}allAddressesAreVerified(){return this.components.addressManager.getAddressesWithMetadata().every(e=>e.expires>Date.now()?!0:e.verified)}async findRandomPeers(e){if(this.allAddressesAreVerified())return;const t=dt([AbortSignal.timeout(1e4),e==null?void 0:e.signal]);try{this.log("starting random walk to find peers to run AutoNAT");for await(const n of this.components.randomWalk.walk({signal:t})){if(!await this.components.connectionManager.isDialable(n.multiaddrs)){this.log.trace("random peer %p was not dialable %s",n.id,n.multiaddrs.map(i=>i.toString()).join(", "));continue}try{this.log.trace("dial random peer %p",n.id),await this.components.connectionManager.openConnection(n.multiaddrs,{signal:t})}catch{}if(this.allAddressesAreVerified()){this.log("stopping random walk, all addresses are verified");return}if(!this.hasConnectionCapacity()){this.log("stopping random walk, too close to max connections");return}}}catch{}}async handleIncomingAutonatStream(e){const t=AbortSignal.timeout(this.timeout),n=ti(e.stream,{maxDataLength:this.maxMessageSize}).pb($t);try{const i=await n.read({signal:t}),s=await this.handleAutonatMessage(i,e.connection,{signal:t});await n.write(s,{signal:t}),await n.unwrap().unwrap().close({signal:t})}catch(i){this.log.error("error handling incoming autonat stream - %e",i),e.stream.abort(i)}}async handleAutonatMessage(e,t,n){const i=this.components.addressManager.getAddresses().map(h=>h.toOptions().host),s=e.dial;if(s==null)return this.log.error("dial was missing from message"),{type:$t.MessageType.DIAL_RESPONSE,dialResponse:{status:$t.ResponseStatus.E_BAD_REQUEST,statusText:"No Dial message found in message"}};let o;const a=s.peer;if((a==null?void 0:a.id)==null)return this.log.error("PeerId missing from message"),{type:$t.MessageType.DIAL_RESPONSE,dialResponse:{status:$t.ResponseStatus.E_BAD_REQUEST,statusText:"missing peer info"}};try{const h=Jye(a.id);o=si(h)}catch(h){return this.log.error("invalid PeerId - %e",h),{type:$t.MessageType.DIAL_RESPONSE,dialResponse:{status:$t.ResponseStatus.E_BAD_REQUEST,statusText:"bad peer id"}}}if(this.log("incoming request from %p",o),!t.remotePeer.equals(o))return this.log("target peer %p did not equal sending peer %p",o,t.remotePeer),{type:$t.MessageType.DIAL_RESPONSE,dialResponse:{status:$t.ResponseStatus.E_BAD_REQUEST,statusText:"peer id mismatch"}};const c=a.addrs.map(h=>Re(h)).filter(h=>{const p=h.toOptions();return Zl(h)?!1:p.host!==t.remoteAddr.toOptions().host?(this.log.trace("not dialing %a - target host did not match remote host %a",h,t.remoteAddr),!1):i.includes(p.host)?!1:this.components.transportManager.dialTransportForMultiaddr(h)==null?(this.log.trace("not dialing %a - transport unsupported",h),!1):!0}).map(h=>(h.getPeerId()==null&&(h=h.encapsulate(`/p2p/${o.toString()}`)),h));if(c.length===0)return this.log("refused to dial all multiaddrs for %p from message",o),{type:$t.MessageType.DIAL_RESPONSE,dialResponse:{status:$t.ResponseStatus.E_DIAL_REFUSED,statusText:"no dialable addresses"}};this.log("dial multiaddrs %s for peer %p",c.map(h=>h.toString()).join(", "),o);let l="",d=c[0];for await(const h of c){let p;d=h;try{if(p=await this.components.connectionManager.openConnection(h,n),!p.remoteAddr.equals(h))throw this.log.error("tried to dial %a but dialed %a",h,p.remoteAddr),new Error("Unexpected remote address");return this.log("successfully dialed %p via %a",o,h),{type:$t.MessageType.DIAL_RESPONSE,dialResponse:{status:$t.ResponseStatus.OK,addr:p.remoteAddr.decapsulateCode(ze("p2p").code).bytes}}}catch(m){this.log.error("could not dial %p - %e",o,m),l=m.message}finally{p!=null&&await p.close()}}return{type:$t.MessageType.DIAL_RESPONSE,dialResponse:{status:$t.ResponseStatus.E_DIAL_ERROR,statusText:l,addr:d.bytes}}}getFirstUnverifiedMultiaddr(e,t){var i,s;const n=this.components.addressManager.getAddressesWithMetadata().sort((o,a)=>o.type==="observed"&&a.type!=="observed"?1:a.type==="observed"&&o.type!=="observed"?-1:0).filter(o=>!(!(o.expires<Date.now())||o.multiaddr.toOptions().family===6&&(!t||!TV(o.multiaddr))||Zl(o.multiaddr)));for(const o of n){const a=o.multiaddr.toString();let c=this.dialResults.get(a);if(c!=null){if(c.networkSegments.includes(e)){this.log.trace("%a already has a network segment result from %s",c.multiaddr,e);continue}if(c.queue.size>10){this.log.trace("%a already has enough peers queued",c.multiaddr);continue}}if(c==null){const l=o.expires<Date.now();if(l&&((s=(i=this.addressFilter).remove)==null||s.call(i,a)),this.addressFilter.has(a))continue;this.addressFilter.add(a),this.log.trace("creating dial result %s %s",l?"to revalidate":"for",a),c={multiaddr:o.multiaddr,success:0,failure:0,networkSegments:[],verifyingPeers:Voe(),queue:new Ac({concurrency:3,maxSize:50}),type:o.type,lastVerified:o.lastVerified},this.dialResults.set(a,c)}return c}}removeOutdatedMultiaddrResults(){const e=new Set(this.components.addressManager.getAddressesWithMetadata().filter(({expires:t})=>t<Date.now()).map(({multiaddr:t})=>t.toString()));for(const t of this.dialResults.keys())e.has(t)||(this.log.trace("remove results for %a",t),this.dialResults.delete(t))}async verifyExternalAddresses(e){if(!this.isStarted())return;this.removeOutdatedMultiaddrResults();const n=(await this.components.peerStore.get(e.remotePeer)).addresses.some(({multiaddr:o})=>o.toOptions().family===6),i=this.getNetworkSegment(e.remoteAddr),s=this.getFirstUnverifiedMultiaddr(i,n);if(s==null){this.log.trace("no unverified public addresses found for peer %p to verify, not requesting verification",e.remotePeer);return}if(!this.hasConnectionCapacity()){s.lastVerified!=null?(this.log("automatically re-verifying %a because we are too close to the connection limit",s.multiaddr),this.confirmAddress(s)):this.log("skipping verifying %a because we are too close to the connection limit",s.multiaddr);return}s.queue.add(async o=>{await this.askPeerToVerify(e,i,o)},{peerId:e.remotePeer,multiaddr:s.multiaddr}).catch(o=>{(s==null?void 0:s.result)==null&&this.log.error("error from %p verifying address %a - %e",e.remotePeer,s==null?void 0:s.multiaddr,o)})}async askPeerToVerify(e,t,n){let i=this.dialResults.get(n.multiaddr.toString());if(i==null){this.log("%a was verified while %p was queued",n.multiaddr,e.remotePeer);return}const s=AbortSignal.timeout(this.timeout);this.log.trace("asking %p to verify multiaddr %s",e.remotePeer,n.multiaddr);const o=await e.newStream(this.protocol,{signal:s});try{const a=ti(o).pb($t),[,c]=await Promise.all([a.write({type:$t.MessageType.DIAL,dial:{peer:{id:this.components.peerId.toMultihash().bytes,addrs:[n.multiaddr.bytes]}}},{signal:s}),a.read({signal:s})]);if(c.type!==$t.MessageType.DIAL_RESPONSE||c.dialResponse==null){this.log("invalid autonat response from %p - %j",e.remotePeer,c);return}const l=c.dialResponse.status;if(this.log.trace("autonat response from %p for %a is %s",e.remotePeer,n.multiaddr,l),l!==$t.ResponseStatus.OK&&l!==$t.ResponseStatus.E_DIAL_ERROR)return;if(i=this.dialResults.get(n.multiaddr.toString()),i==null){this.log.trace("peer reported %a as %s but there is no result object",n.multiaddr,c.dialResponse.status);return}if(i.networkSegments.includes(t)){this.log.trace("%a results included network segment %s",n.multiaddr,t);return}if(i.result!=null){this.log.trace("already resolved result for %a, ignoring response from",n.multiaddr,e.remotePeer);return}if(i.verifyingPeers.has(e.remotePeer)){this.log.trace("peer %p has already verified %a, ignoring response",e.remotePeer,n.multiaddr);return}if(i.verifyingPeers.add(e.remotePeer),i.networkSegments.push(t),l===$t.ResponseStatus.OK){if(i.success++,i.type!=="observed"){this.confirmAddress(i);return}}else l===$t.ResponseStatus.E_DIAL_ERROR&&i.failure++;this.log("%a success %d failure %d",i.multiaddr,i.success,i.failure),i.success===ame&&this.confirmAddress(i),i.failure===cme&&this.unconfirmAddress(i)}finally{try{await o.close({signal:s})}catch(a){o.abort(a)}}}hasConnectionCapacity(){const t=this.components.connectionManager.getConnections().length,n=this.components.connectionManager.getMaxConnections();return t/n*100<this.connectionThreshold}confirmAddress(e){this.log("%s address %a is externally dialable",e.type,e.multiaddr),this.components.addressManager.confirmObservedAddr(e.multiaddr),this.dialResults.delete(e.multiaddr.toString()),e.result=!0,e.queue.abort()}unconfirmAddress(e){this.log("%s address %a is not externally dialable",e.type,e.multiaddr),this.components.addressManager.removeObservedAddr(e.multiaddr),this.dialResults.delete(e.multiaddr.toString()),e.result=!1,e.queue.abort()}getNetworkSegment(e){const t=e.toOptions();return t.family===4?t.host.split(".")[0].padStart(3,"0"):t.host.split(":")[0].padStart(4,"0")}}function ume(r={}){return e=>new lme(e,r)}const dme=ge("dns4"),hme=ge("dns6"),fme=ge("dnsaddr"),eu=Gt(ge("dns"),fme,dme,hme),Bw=Gt(ge("ip4"),ge("ip6")),sh=Gt(Te(Bw,ge("tcp")),Te(eu,ge("tcp"))),Uw=Te(Bw,ge("udp")),pme=Te(Uw,ge("utp")),gme=Te(Uw,ge("quic")),yme=Te(Uw,ge("quic-v1")),Dv=Gt(Te(sh,ge("ws")),Te(eu,ge("ws"))),lm=Gt(Te(Dv,ge("p2p")),Dv),$v=Gt(Te(sh,ge("wss")),Te(eu,ge("wss")),Te(sh,ge("tls"),ge("ws")),Te(eu,ge("tls"),ge("ws"))),um=Gt(Te($v,ge("p2p")),$v),Nv=Gt(Te(sh,ge("http")),Te(Bw,ge("http")),Te(eu,ge("http"))),Mv=Gt(Te(sh,ge("https")),Te(Bw,ge("https")),Te(eu,ge("https"))),DT=Te(Uw,ge("webrtc-direct"),ge("certhash")),$V=Gt(Te(DT,ge("p2p")),DT),$T=Te(yme,ge("webtransport"),ge("certhash"),ge("certhash")),NV=Gt(Te($T,ge("p2p")),$T),MV=Gt(Te(lm,ge("p2p-webrtc-star"),ge("p2p")),Te(um,ge("p2p-webrtc-star"),ge("p2p")),Te(lm,ge("p2p-webrtc-star")),Te(um,ge("p2p-webrtc-star")));Gt(Te(lm,ge("p2p-websocket-star"),ge("p2p")),Te(um,ge("p2p-websocket-star"),ge("p2p")),Te(lm,ge("p2p-websocket-star")),Te(um,ge("p2p-websocket-star")));const OV=Gt(Te(Nv,ge("p2p-webrtc-direct"),ge("p2p")),Te(Mv,ge("p2p-webrtc-direct"),ge("p2p")),Te(Nv,ge("p2p-webrtc-direct")),Te(Mv,ge("p2p-webrtc-direct"))),tu=Gt(Dv,$v,Nv,Mv,MV,OV,sh,pme,gme,eu,$V,NV);Gt(Te(tu,ge("p2p-stardust"),ge("p2p")),Te(tu,ge("p2p-stardust")));const Ya=Gt(Te(tu,ge("p2p")),MV,OV,$V,NV,ge("p2p")),NT=Gt(Te(Ya,ge("p2p-circuit"),Ya),Te(Ya,ge("p2p-circuit")),Te(ge("p2p-circuit"),Ya),Te(tu,ge("p2p-circuit")),Te(ge("p2p-circuit"),tu),ge("p2p-circuit")),RV=()=>Gt(Te(NT,RV),NT),ul=RV(),mme=Gt(Te(ul,Ya,ul),Te(Ya,ul),Te(ul,Ya),ul,Ya);Gt(Te(ul,ge("webrtc"),ge("p2p")),Te(ul,ge("webrtc")),Te(tu,ge("webrtc"),ge("p2p")),Te(tu,ge("webrtc")),ge("webrtc"));function LV(r){function e(t){let n;try{n=Re(t)}catch{return!1}const i=r(n.protoNames());return i===null?!1:i===!0||i===!1?i:i.length===0}return e}function Te(...r){function e(t){if(t.length<r.length)return null;let n=t;return r.some(i=>(n=typeof i=="function"?i().partialMatch(t):i.partialMatch(t),Array.isArray(n)&&(t=n),n===null)),n}return{toString:function(){return"{ "+r.join(" ")+" }"},input:r,matches:LV(e),partialMatch:e}}function Gt(...r){function e(n){let i=null;return r.some(s=>{const o=typeof s=="function"?s().partialMatch(n):s.partialMatch(n);return o!=null?(i=o,!0):!1}),i}return{toString:function(){return"{ "+r.join(" ")+" }"},input:r,matches:LV(e),partialMatch:e}}function ge(r){const e=r;function t(i){let s;try{s=Re(i)}catch{return!1}const o=s.protoNames();return o.length===1&&o[0]===e}function n(i){return i.length===0?null:i[0]===e?i.slice(1):null}return{toString:function(){return e},matches:t,partialMatch:n}}const wme="bootstrap",bme=50,vme=1e3;var kN,_N,TN,PN;class BV extends(PN=er,TN=ey,_N=Symbol.toStringTag,kN=fr,PN){constructor(t,n={list:[]}){if(n.list==null||n.list.length===0)throw new Error("Bootstrap requires a list of peer addresses");super();u(this,"log");u(this,"timer");u(this,"list");u(this,"timeout");u(this,"components");u(this,"_init");u(this,TN,this);u(this,_N,"@libp2p/bootstrap");u(this,kN,["@libp2p/peer-discovery"]);this.components=t,this.log=t.logger.forComponent("libp2p:bootstrap"),this.timeout=n.timeout??vme,this.list=[];for(const i of n.list){if(!mme.matches(i)){this.log.error("Invalid multiaddr");continue}const s=Re(i),o=s.getPeerId();if(o==null){this.log.error("Invalid bootstrap multiaddr without peer id");continue}const a={id:Jt(o),multiaddrs:[s]};this.list.push(a)}this._init=n}isStarted(){return!!this.timer}start(){this.isStarted()||(this.log("Starting bootstrap node discovery, discovering peers after %s ms",this.timeout),this.timer=setTimeout(()=>{this._discoverBootstrapPeers().catch(t=>{this.log.error(t)})},this.timeout))}async _discoverBootstrapPeers(){if(this.timer!=null)for(const t of this.list){if(await this.components.peerStore.merge(t.id,{tags:{[this._init.tagName??wme]:{value:this._init.tagValue??bme,ttl:this._init.tagTTL}},multiaddrs:t.multiaddrs}),this.timer==null)return;this.safeDispatchEvent("peer",{detail:t}),this.components.connectionManager.openConnection(t.id).catch(n=>{this.log.error("could not dial bootstrap peer %p",t.id,n)})}}stop(){this.timer!=null&&clearTimeout(this.timer),this.timer=void 0}}u(BV,"tag","bootstrap");function Sx(r){return e=>new BV(e,r)}var dm;(function(r){let e;r.codec=()=>(e==null&&(e=$e((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.publicKey!=null&&t.publicKey.byteLength>0&&(n.uint32(10),n.bytes(t.publicKey)),t.payloadType!=null&&t.payloadType.byteLength>0&&(n.uint32(18),n.bytes(t.payloadType)),t.payload!=null&&t.payload.byteLength>0&&(n.uint32(26),n.bytes(t.payload)),t.signature!=null&&t.signature.byteLength>0&&(n.uint32(42),n.bytes(t.signature)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{const s={publicKey:Ye(0),payloadType:Ye(0),payload:Ye(0),signature:Ye(0)},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.publicKey=t.bytes();break}case 2:{s.payloadType=t.bytes();break}case 3:{s.payload=t.bytes();break}case 5:{s.signature=t.bytes();break}default:{t.skipType(a&7);break}}}return s})),e),r.encode=t=>De(t,r.codec()),r.decode=(t,n)=>Pe(t,r.codec(),n)})(dm||(dm={}));class Eme extends Error{constructor(e="Invalid signature"){super(e),this.name="InvalidSignatureError"}}const Ba=class Ba{constructor(e){u(this,"publicKey");u(this,"payloadType");u(this,"payload");u(this,"signature");u(this,"marshaled");const{publicKey:t,payloadType:n,payload:i,signature:s}=e;this.publicKey=t,this.payloadType=n,this.payload=i,this.signature=s}marshal(){return this.marshaled==null&&(this.marshaled=dm.encode({publicKey:Pi(this.publicKey),payloadType:this.payloadType,payload:this.payload.subarray(),signature:this.signature})),this.marshaled}equals(e){return He(this.marshal(),e.marshal())}async validate(e){const t=MT(e,this.payloadType,this.payload);return this.publicKey.verify(t.subarray(),this.signature)}};u(Ba,"createFromProtobuf",async e=>{const t=dm.decode(e),n=Rn(t.publicKey);return new Ba({publicKey:n,payloadType:t.payloadType,payload:t.payload,signature:t.signature})}),u(Ba,"seal",async(e,t)=>{if(t==null)throw new Error("Missing private key");const n=e.domain,i=e.codec,s=e.marshal(),o=MT(n,i,s),a=await t.sign(o.subarray());return new Ba({publicKey:t.publicKey,payloadType:i,payload:s,signature:a})}),u(Ba,"openAndCertify",async(e,t)=>{const n=await Ba.createFromProtobuf(e);if(!await n.validate(t))throw new Eme("Envelope signature is not valid for the given domain");return n});let _c=Ba;const MT=(r,e,t)=>{const n=oe(r),i=xr(n.byteLength),s=xr(e.length),o=xr(t.length);return new Ue(i,n,s,e,o,t)};function Sme(r,e){const t=(n,i)=>n.toString().localeCompare(i.toString());return r.length!==e.length?!1:(e.sort(t),r.sort(t).every((n,i)=>e[i].equals(n)))}function xme(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}var Ame=UV,OT=128,Cme=-128,Ime=Math.pow(2,31);function UV(r,e,t){e=e||[],t=t||0;for(var n=t;r>=Ime;)e[t++]=r&255|OT,r/=128;for(;r&Cme;)e[t++]=r&255|OT,r>>>=7;return e[t]=r|0,UV.bytes=t-n+1,e}var kme=Ov,_me=128,RT=127;function Ov(r,n){var t=0,n=n||0,i=0,s=n,o,a=r.length;do{if(s>=a)throw Ov.bytes=0,new RangeError("Could not decode varint");o=r[s++],t+=i<28?(o&RT)<<i:(o&RT)*Math.pow(2,i),i+=7}while(o>=_me);return Ov.bytes=s-n,t}var Tme=Math.pow(2,7),Pme=Math.pow(2,14),Dme=Math.pow(2,21),$me=Math.pow(2,28),Nme=Math.pow(2,35),Mme=Math.pow(2,42),Ome=Math.pow(2,49),Rme=Math.pow(2,56),Lme=Math.pow(2,63),Bme=function(r){return r<Tme?1:r<Pme?2:r<Dme?3:r<$me?4:r<Nme?5:r<Mme?6:r<Ome?7:r<Rme?8:r<Lme?9:10},Ume={encode:Ame,decode:kme,encodingLength:Bme},LT=Ume;function BT(r,e=0){return[LT.decode(r,e),LT.decode.bytes]}function Fme(r){const e=xme(r),[t,n]=BT(e),[i,s]=BT(e.subarray(n)),o=e.subarray(n+s);if(o.byteLength!==i)throw new Error("Incorrect length");return new zme(t,i,o,e)}let zme=class{constructor(e,t,n,i){u(this,"code");u(this,"size");u(this,"digest");u(this,"bytes");this.code=e,this.size=t,this.digest=n,this.bytes=i}};const Vme="libp2p-peer-record",Kme=Uint8Array.from([3,1]);var hm;(function(r){(function(t){let n;t.codec=()=>(n==null&&(n=$e((i,s,o={})=>{o.lengthDelimited!==!1&&s.fork(),i.multiaddr!=null&&i.multiaddr.byteLength>0&&(s.uint32(10),s.bytes(i.multiaddr)),o.lengthDelimited!==!1&&s.ldelim()},(i,s,o={})=>{const a={multiaddr:Ye(0)},c=s==null?i.len:i.pos+s;for(;i.pos<c;){const l=i.uint32();switch(l>>>3){case 1:{a.multiaddr=i.bytes();break}default:{i.skipType(l&7);break}}}return a})),n),t.encode=i=>De(i,t.codec()),t.decode=(i,s)=>Pe(i,t.codec(),s)})(r.AddressInfo||(r.AddressInfo={}));let e;r.codec=()=>(e==null&&(e=$e((t,n,i={})=>{if(i.lengthDelimited!==!1&&n.fork(),t.peerId!=null&&t.peerId.byteLength>0&&(n.uint32(10),n.bytes(t.peerId)),t.seq!=null&&t.seq!==0n&&(n.uint32(16),n.uint64(t.seq)),t.addresses!=null)for(const s of t.addresses)n.uint32(26),r.AddressInfo.codec().encode(s,n);i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{var a,c;const s={peerId:Ye(0),seq:0n,addresses:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{s.peerId=t.bytes();break}case 2:{s.seq=t.uint64();break}case 3:{if(((a=i.limits)==null?void 0:a.addresses)!=null&&s.addresses.length===i.limits.addresses)throw new pt('Decode error - map field "addresses" had too many elements');s.addresses.push(r.AddressInfo.codec().decode(t,t.uint32(),{limits:(c=i.limits)==null?void 0:c.addresses$}));break}default:{t.skipType(l&7);break}}}return s})),e),r.encode=t=>De(t,r.codec()),r.decode=(t,n)=>Pe(t,r.codec(),n)})(hm||(hm={}));const go=class go{constructor(e){u(this,"peerId");u(this,"multiaddrs");u(this,"seqNumber");u(this,"domain",go.DOMAIN);u(this,"codec",go.CODEC);u(this,"marshaled");const{peerId:t,multiaddrs:n,seqNumber:i}=e;this.peerId=t,this.multiaddrs=n??[],this.seqNumber=i??BigInt(Date.now())}marshal(){return this.marshaled==null&&(this.marshaled=hm.encode({peerId:this.peerId.toMultihash().bytes,seq:BigInt(this.seqNumber),addresses:this.multiaddrs.map(e=>({multiaddr:e.bytes}))})),this.marshaled}equals(e){return!(!(e instanceof go)||!this.peerId.equals(e.peerId)||this.seqNumber!==e.seqNumber||!Sme(this.multiaddrs,e.multiaddrs))}};u(go,"createFromProtobuf",e=>{const t=hm.decode(e),n=si(Fme(t.peerId)),i=(t.addresses??[]).map(o=>Re(o.multiaddr)),s=t.seq;return new go({peerId:n,multiaddrs:i,seqNumber:s})}),u(go,"DOMAIN",Vme),u(go,"CODEC",Kme);let js=go;function FV(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}var jme=zV,UT=128,Hme=-128,qme=Math.pow(2,31);function zV(r,e,t){e=e||[],t=t||0;for(var n=t;r>=qme;)e[t++]=r&255|UT,r/=128;for(;r&Hme;)e[t++]=r&255|UT,r>>>=7;return e[t]=r|0,zV.bytes=t-n+1,e}var Wme=Rv,Gme=128,FT=127;function Rv(r,n){var t=0,n=n||0,i=0,s=n,o,a=r.length;do{if(s>=a)throw Rv.bytes=0,new RangeError("Could not decode varint");o=r[s++],t+=i<28?(o&FT)<<i:(o&FT)*Math.pow(2,i),i+=7}while(o>=Gme);return Rv.bytes=s-n,t}var Qme=Math.pow(2,7),Yme=Math.pow(2,14),Jme=Math.pow(2,21),Xme=Math.pow(2,28),Zme=Math.pow(2,35),e3e=Math.pow(2,42),t3e=Math.pow(2,49),r3e=Math.pow(2,56),n3e=Math.pow(2,63),i3e=function(r){return r<Qme?1:r<Yme?2:r<Jme?3:r<Xme?4:r<Zme?5:r<e3e?6:r<t3e?7:r<r3e?8:r<n3e?9:10},s3e={encode:jme,decode:Wme,encodingLength:i3e},zT=s3e;function VT(r,e=0){return[zT.decode(r,e),zT.decode.bytes]}function o3e(r){const e=FV(r),[t,n]=VT(e),[i,s]=VT(e.subarray(n)),o=e.subarray(n+s);if(o.byteLength!==i)throw new Error("Incorrect length");return new a3e(t,i,o,e)}let a3e=class{constructor(e,t,n,i){u(this,"code");u(this,"size");u(this,"digest");u(this,"bytes");this.code=e,this.size=t,this.digest=n,this.bytes=i}};const c3e=290,l3e=1,VV=2e3,u3e=100,lg=`${J3}-circuit-relay`;BigInt(1<<17);const fm="/libp2p/circuit/relay/0.2.0/hop",KT="/libp2p/circuit/relay/0.2.0/stop",jT=300,d3e=4096,h3e=.001;var oh;(function(r){(function(n){n.RESERVE="RESERVE",n.CONNECT="CONNECT",n.STATUS="STATUS"})(r.Type||(r.Type={}));let e;(function(n){n[n.RESERVE=0]="RESERVE",n[n.CONNECT=1]="CONNECT",n[n.STATUS=2]="STATUS"})(e||(e={})),function(n){n.codec=()=>On(e)}(r.Type||(r.Type={}));let t;r.codec=()=>(t==null&&(t=$e((n,i,s={})=>{s.lengthDelimited!==!1&&i.fork(),n.type!=null&&(i.uint32(8),r.Type.codec().encode(n.type,i)),n.peer!=null&&(i.uint32(18),ah.codec().encode(n.peer,i)),n.reservation!=null&&(i.uint32(26),pm.codec().encode(n.reservation,i)),n.limit!=null&&(i.uint32(34),ch.codec().encode(n.limit,i)),n.status!=null&&(i.uint32(40),an.codec().encode(n.status,i)),s.lengthDelimited!==!1&&i.ldelim()},(n,i,s={})=>{var c,l,d;const o={},a=i==null?n.len:n.pos+i;for(;n.pos<a;){const h=n.uint32();switch(h>>>3){case 1:{o.type=r.Type.codec().decode(n);break}case 2:{o.peer=ah.codec().decode(n,n.uint32(),{limits:(c=s.limits)==null?void 0:c.peer});break}case 3:{o.reservation=pm.codec().decode(n,n.uint32(),{limits:(l=s.limits)==null?void 0:l.reservation});break}case 4:{o.limit=ch.codec().decode(n,n.uint32(),{limits:(d=s.limits)==null?void 0:d.limit});break}case 5:{o.status=an.codec().decode(n);break}default:{n.skipType(h&7);break}}}return o})),t),r.encode=n=>De(n,r.codec()),r.decode=(n,i)=>Pe(n,r.codec(),i)})(oh||(oh={}));var po;(function(r){(function(n){n.CONNECT="CONNECT",n.STATUS="STATUS"})(r.Type||(r.Type={}));let e;(function(n){n[n.CONNECT=0]="CONNECT",n[n.STATUS=1]="STATUS"})(e||(e={})),function(n){n.codec=()=>On(e)}(r.Type||(r.Type={}));let t;r.codec=()=>(t==null&&(t=$e((n,i,s={})=>{s.lengthDelimited!==!1&&i.fork(),n.type!=null&&(i.uint32(8),r.Type.codec().encode(n.type,i)),n.peer!=null&&(i.uint32(18),ah.codec().encode(n.peer,i)),n.limit!=null&&(i.uint32(26),ch.codec().encode(n.limit,i)),n.status!=null&&(i.uint32(32),an.codec().encode(n.status,i)),s.lengthDelimited!==!1&&i.ldelim()},(n,i,s={})=>{var c,l;const o={},a=i==null?n.len:n.pos+i;for(;n.pos<a;){const d=n.uint32();switch(d>>>3){case 1:{o.type=r.Type.codec().decode(n);break}case 2:{o.peer=ah.codec().decode(n,n.uint32(),{limits:(c=s.limits)==null?void 0:c.peer});break}case 3:{o.limit=ch.codec().decode(n,n.uint32(),{limits:(l=s.limits)==null?void 0:l.limit});break}case 4:{o.status=an.codec().decode(n);break}default:{n.skipType(d&7);break}}}return o})),t),r.encode=n=>De(n,r.codec()),r.decode=(n,i)=>Pe(n,r.codec(),i)})(po||(po={}));var ah;(function(r){let e;r.codec=()=>(e==null&&(e=$e((t,n,i={})=>{if(i.lengthDelimited!==!1&&n.fork(),t.id!=null&&t.id.byteLength>0&&(n.uint32(10),n.bytes(t.id)),t.addrs!=null)for(const s of t.addrs)n.uint32(18),n.bytes(s);i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{var a;const s={id:Ye(0),addrs:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const c=t.uint32();switch(c>>>3){case 1:{s.id=t.bytes();break}case 2:{if(((a=i.limits)==null?void 0:a.addrs)!=null&&s.addrs.length===i.limits.addrs)throw new pt('Decode error - map field "addrs" had too many elements');s.addrs.push(t.bytes());break}default:{t.skipType(c&7);break}}}return s})),e),r.encode=t=>De(t,r.codec()),r.decode=(t,n)=>Pe(t,r.codec(),n)})(ah||(ah={}));var pm;(function(r){let e;r.codec=()=>(e==null&&(e=$e((t,n,i={})=>{if(i.lengthDelimited!==!1&&n.fork(),t.expire!=null&&t.expire!==0n&&(n.uint32(8),n.uint64(t.expire)),t.addrs!=null)for(const s of t.addrs)n.uint32(18),n.bytes(s);t.voucher!=null&&(n.uint32(26),ym.codec().encode(t.voucher,n)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{var a,c;const s={expire:0n,addrs:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{s.expire=t.uint64();break}case 2:{if(((a=i.limits)==null?void 0:a.addrs)!=null&&s.addrs.length===i.limits.addrs)throw new pt('Decode error - map field "addrs" had too many elements');s.addrs.push(t.bytes());break}case 3:{s.voucher=ym.codec().decode(t,t.uint32(),{limits:(c=i.limits)==null?void 0:c.voucher});break}default:{t.skipType(l&7);break}}}return s})),e),r.encode=t=>De(t,r.codec()),r.decode=(t,n)=>Pe(t,r.codec(),n)})(pm||(pm={}));var ch;(function(r){let e;r.codec=()=>(e==null&&(e=$e((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.duration!=null&&(n.uint32(8),n.uint32(t.duration)),t.data!=null&&(n.uint32(16),n.uint64(t.data)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{const s={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.duration=t.uint32();break}case 2:{s.data=t.uint64();break}default:{t.skipType(a&7);break}}}return s})),e),r.encode=t=>De(t,r.codec()),r.decode=(t,n)=>Pe(t,r.codec(),n)})(ch||(ch={}));var an;(function(r){r.UNUSED="UNUSED",r.OK="OK",r.RESERVATION_REFUSED="RESERVATION_REFUSED",r.RESOURCE_LIMIT_EXCEEDED="RESOURCE_LIMIT_EXCEEDED",r.PERMISSION_DENIED="PERMISSION_DENIED",r.CONNECTION_FAILED="CONNECTION_FAILED",r.NO_RESERVATION="NO_RESERVATION",r.MALFORMED_MESSAGE="MALFORMED_MESSAGE",r.UNEXPECTED_MESSAGE="UNEXPECTED_MESSAGE"})(an||(an={}));var Lv;(function(r){r[r.UNUSED=0]="UNUSED",r[r.OK=100]="OK",r[r.RESERVATION_REFUSED=200]="RESERVATION_REFUSED",r[r.RESOURCE_LIMIT_EXCEEDED=201]="RESOURCE_LIMIT_EXCEEDED",r[r.PERMISSION_DENIED=202]="PERMISSION_DENIED",r[r.CONNECTION_FAILED=203]="CONNECTION_FAILED",r[r.NO_RESERVATION=204]="NO_RESERVATION",r[r.MALFORMED_MESSAGE=400]="MALFORMED_MESSAGE",r[r.UNEXPECTED_MESSAGE=401]="UNEXPECTED_MESSAGE"})(Lv||(Lv={}));(function(r){r.codec=()=>On(Lv)})(an||(an={}));var gm;(function(r){let e;r.codec=()=>(e==null&&(e=$e((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.relay!=null&&t.relay.byteLength>0&&(n.uint32(10),n.bytes(t.relay)),t.peer!=null&&t.peer.byteLength>0&&(n.uint32(18),n.bytes(t.peer)),t.expiration!=null&&t.expiration!==0n&&(n.uint32(24),n.uint64(t.expiration)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{const s={relay:Ye(0),peer:Ye(0),expiration:0n},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.relay=t.bytes();break}case 2:{s.peer=t.bytes();break}case 3:{s.expiration=t.uint64();break}default:{t.skipType(a&7);break}}}return s})),e),r.encode=t=>De(t,r.codec()),r.decode=(t,n)=>Pe(t,r.codec(),n)})(gm||(gm={}));var ym;(function(r){let e;r.codec=()=>(e==null&&(e=$e((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.publicKey!=null&&t.publicKey.byteLength>0&&(n.uint32(10),n.bytes(t.publicKey)),t.payloadType!=null&&t.payloadType.byteLength>0&&(n.uint32(18),n.bytes(t.payloadType)),t.payload!=null&&(n.uint32(26),gm.codec().encode(t.payload,n)),t.signature!=null&&t.signature.byteLength>0&&(n.uint32(42),n.bytes(t.signature)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{var a;const s={publicKey:Ye(0),payloadType:Ye(0),signature:Ye(0)},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const c=t.uint32();switch(c>>>3){case 1:{s.publicKey=t.bytes();break}case 2:{s.payloadType=t.bytes();break}case 3:{s.payload=gm.codec().decode(t,t.uint32(),{limits:(a=i.limits)==null?void 0:a.payload});break}case 5:{s.signature=t.bytes();break}default:{t.skipType(c&7);break}}}return s})),e),r.encode=t=>De(t,r.codec()),r.decode=(t,n)=>Pe(t,r.codec(),n)})(ym||(ym={}));function f3e(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var i=0;i<r.length;i++){var s=r.charAt(i),o=s.charCodeAt(0);if(t[o]!==255)throw new TypeError(s+" is ambiguous");t[o]=i}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),d=Math.log(256)/Math.log(a);function h(f){if(f instanceof Uint8Array||(ArrayBuffer.isView(f)?f=new Uint8Array(f.buffer,f.byteOffset,f.byteLength):Array.isArray(f)&&(f=Uint8Array.from(f))),!(f instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(f.length===0)return"";for(var g=0,v=0,y=0,w=f.length;y!==w&&f[y]===0;)y++,g++;for(var b=(w-y)*d+1>>>0,E=new Uint8Array(b);y!==w;){for(var A=f[y],k=0,x=b-1;(A!==0||k<v)&&x!==-1;x--,k++)A+=256*E[x]>>>0,E[x]=A%a>>>0,A=A/a>>>0;if(A!==0)throw new Error("Non-zero carry");v=k,y++}for(var I=b-v;I!==b&&E[I]===0;)I++;for(var T=c.repeat(g);I<b;++I)T+=r.charAt(E[I]);return T}function p(f){if(typeof f!="string")throw new TypeError("Expected String");if(f.length===0)return new Uint8Array;var g=0;if(f[g]!==" "){for(var v=0,y=0;f[g]===c;)v++,g++;for(var w=(f.length-g)*l+1>>>0,b=new Uint8Array(w);f[g];){var E=t[f.charCodeAt(g)];if(E===255)return;for(var A=0,k=w-1;(E!==0||A<y)&&k!==-1;k--,A++)E+=a*b[k]>>>0,b[k]=E%256>>>0,E=E/256>>>0;if(E!==0)throw new Error("Non-zero carry");y=A,g++}if(f[g]!==" "){for(var x=w-y;x!==w&&b[x]===0;)x++;for(var I=new Uint8Array(v+(w-x)),T=v;x!==w;)I[T++]=b[x++];return I}}}function m(f){var g=p(f);if(g)return g;throw new Error(`Non-${e} character`)}return{encode:h,decodeUnsafe:p,decode:m}}var p3e=f3e,g3e=p3e;let y3e=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseEncode");this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},m3e=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseDecode");u(this,"prefixCodePoint");this.name=e,this.prefix=t;const i=t.codePointAt(0);if(i===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=i,this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return KV(this,e)}},w3e=class{constructor(e){u(this,"decoders");this.decoders=e}or(e){return KV(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};function KV(r,e){return new w3e({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}let b3e=class{constructor(e,t,n,i){u(this,"name");u(this,"prefix");u(this,"baseEncode");u(this,"baseDecode");u(this,"encoder");u(this,"decoder");this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=i,this.encoder=new y3e(e,t,n),this.decoder=new m3e(e,t,i)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};function jV({name:r,prefix:e,encode:t,decode:n}){return new b3e(r,e,t,n)}function Fw({name:r,prefix:e,alphabet:t}){const{encode:n,decode:i}=g3e(t,r);return jV({prefix:e,name:r,encode:n,decode:s=>FV(i(s))})}function v3e(r,e,t,n){const i={};for(let d=0;d<e.length;++d)i[e[d]]=d;let s=r.length;for(;r[s-1]==="=";)--s;const o=new Uint8Array(s*t/8|0);let a=0,c=0,l=0;for(let d=0;d<s;++d){const h=i[r[d]];if(h===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|h,a+=t,a>=8&&(a-=8,o[l++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o}function E3e(r,e,t){const n=e[e.length-1]==="=",i=(1<<t)-1;let s="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,s+=e[i&a>>o];if(o!==0&&(s+=e[i&a<<t-o]),n)for(;s.length*t&7;)s+="=";return s}function ia({name:r,prefix:e,bitsPerChar:t,alphabet:n}){return jV({prefix:e,name:r,encode(i){return E3e(i,n,t)},decode(i){return v3e(i,n,t,r)}})}ia({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});ia({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});ia({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});ia({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});ia({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});ia({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});ia({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});ia({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});ia({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});Fw({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"});Fw({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});Fw({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});Fw({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});class Bv extends Error{constructor(){super(...arguments);u(this,"name","HadEnoughRelaysError")}}u(Bv,"name","HadEnoughRelaysError");class HV extends Error{constructor(){super(...arguments);u(this,"name","DoubleRelayError")}}u(HV,"name","DoubleRelayError");class qV extends Error{constructor(){super(...arguments);u(this,"name","RelayQueueFullError")}}u(qV,"name","RelayQueueFullError");function HT(r){const e=r*BigInt(1e3),t=new Date().getTime();return Number(e-BigInt(t))}class qT{constructor(e){u(this,"expires");u(this,"bytes");(e==null?void 0:e.duration)!=null&&(e==null?void 0:e.duration)!==0&&(this.expires=Date.now()+e.duration*1e3),this.bytes=e==null?void 0:e.data,this.bytes===0n&&(this.bytes=void 0),this.onData=this.onData.bind(this)}onData(e){this.bytes!=null&&(this.bytes-=BigInt(e.byteLength),this.bytes<0n&&(this.bytes=0n))}getLimits(){if(this.expires==null&&this.bytes==null)return;const e={};if(this.bytes!=null){const t=this;Object.defineProperty(e,"bytes",{get(){return t.bytes}})}if(this.expires!=null){const t=this;Object.defineProperty(e,"seconds",{get(){return Math.round(((t.expires??0)-Date.now())/1e3)}})}return e}}const WV=It(Ze(hz.matchers[0],Je("p2p-circuit"))),GV=It(Je("p2p-circuit"));function WT(r){const{stream:e,remoteAddr:t,logger:n,onDataRead:i,onDataWrite:s}=r,o=n.forComponent("libp2p:stream:converter");let a=!1,c=!1;const l=e.close.bind(e);e.close=async f=>{await l(f),m(!0)};const d=e.abort.bind(e);e.abort=f=>{d(f),m(!0)};const h=e.sink.bind(e);e.sink=async f=>{try{await h(hn(f,g=>Ly(g,v=>s==null?void 0:s(v))))}catch(g){g.type!=="aborted"&&o.error("%s error in sink",t,g)}finally{c=!0,m()}};const p={log:o,sink:e.sink,source:async function*(){try{for await(const f of e.source)i==null||i(f),yield f}finally{a=!0,m()}}(),remoteAddr:t,timeline:{open:Date.now(),close:void 0},close:e.close,abort:e.abort};function m(f){f===!0&&(a=!0,c=!0),a&&c&&p.timeline.close==null&&(p.timeline.close=Date.now())}return p}class S3e extends er{constructor(t,n={}){super();u(this,"peerStore");u(this,"registrar");u(this,"connectionManager");u(this,"randomWalk");u(this,"started");u(this,"running");u(this,"topologyId");u(this,"log");u(this,"discoveryController");u(this,"filter");u(this,"queue");this.log=t.logger.forComponent("libp2p:circuit-relay:discover-relays"),this.started=!1,this.running=!1,this.peerStore=t.peerStore,this.registrar=t.registrar,this.connectionManager=t.connectionManager,this.randomWalk=t.randomWalk,this.filter=n.filter,this.discoveryController=new AbortController,this.discoveryController.signal}isStarted(){return this.started}async start(){this.topologyId=await this.registrar.register(fm,{filter:this.filter,onConnect:t=>{var n,i;this.log.trace("discovered relay %p queue (length: %d, active %d)",t,(n=this.queue)==null?void 0:n.size,(i=this.queue)==null?void 0:i.running),this.safeDispatchEvent("relay:discover",{detail:t})}}),this.started=!0}stop(){var t;this.topologyId!=null&&this.registrar.unregister(this.topologyId),(t=this.discoveryController)==null||t.abort(),this.started=!1}startDiscovery(){this.running||(this.log("start discovery"),this.running=!0,this.discoveryController=new AbortController,this.discoveryController.signal,Promise.resolve().then(async()=>{var i;this.log("searching peer store for relays");const t=await this.peerStore.all({filters:[s=>s.protocols.includes(fm)],orders:[()=>Math.random()<.5?1:-1,(s,o)=>{const a=GT(s),c=GT(o);return a>c?-1:c>a?1:0}]});for(const s of t)this.log.trace("found relay peer %p in peer store",s.id),this.safeDispatchEvent("relay:discover",{detail:s.id});this.log("found %d relay peers in peer store",t.length);const n=this.queue=new Ac({concurrency:5});this.log("start random walk");for await(const s of this.randomWalk.walk({signal:this.discoveryController.signal})){if(this.log.trace("found random peer %p",s.id),n.has(s.id)){this.log.trace("random peer %p was already in queue",s.id);continue}if(((i=this.connectionManager.getConnections(s.id))==null?void 0:i.length)>0){this.log.trace("random peer %p was already connected",s.id);continue}if(!await this.connectionManager.isDialable(s.multiaddrs)){this.log.trace("random peer %p was not dialable",s.id,s.multiaddrs.map(o=>o.toString()));continue}n.queued>10&&(this.log.trace("wait for space in queue for %p",s.id),await n.onSizeLessThan(10,{signal:this.discoveryController.signal})),this.log("adding random peer %p to dial queue (length: %d, active %d)",s.id,n.size,n.running),n.add(async()=>{const o=dt([this.discoveryController.signal,AbortSignal.timeout(5e3)]);try{await this.connectionManager.openConnection(s.id,{signal:o})}finally{o.clear()}},{peerId:s.id,signal:this.discoveryController.signal}).catch(o=>{this.log.error("error opening connection to random peer %p",s.id,o)})}this.log("stop random walk"),await n.onIdle()}).catch(t=>{this.discoveryController.signal.aborted||this.log.error("failed when finding relays on the network",t)}))}stopDiscovery(){var t;this.log("stop discovery"),this.running=!1,(t=this.discoveryController)==null||t.abort()}}function GT(r){const e=r.metadata.get("last-dial-success");return e==null?0:new Date(re(e)).getTime()}class x3e extends er{constructor(t,n={}){super();u(this,"connectionManager");u(this,"addressManager");u(this,"reservationStore");u(this,"listeningAddrs");u(this,"log");u(this,"listenTimeout");u(this,"reservationId");u(this,"relay");u(this,"_onRemoveRelayPeer",t=>{var n,i;this.log("relay removed %p our relay %p",t.detail.relay,this.relay,(n=this.relay)==null?void 0:n.equals(t.detail.relay)),((i=this.relay)==null?void 0:i.equals(t.detail.relay))===!0&&(this.log("relay peer removed %p",t.detail.relay),this.listeningAddrs.forEach(s=>{this.addressManager.removeObservedAddr(s)}),this.listeningAddrs=[],this.safeDispatchEvent("listening"))});u(this,"_onAddRelayPeer",t=>{const{details:n}=t.detail;n.type!=="configured"&&n.id===this.reservationId&&this.addedRelay(t.detail)});this.log=t.logger.forComponent("libp2p:circuit-relay:transport:listener"),this.connectionManager=t.connectionManager,this.addressManager=t.addressManager,this.reservationStore=t.reservationStore,this.listeningAddrs=[],this.listenTimeout=n.listenTimeout??VV,this.reservationStore.addEventListener("relay:removed",this._onRemoveRelayPeer),this.reservationStore.addEventListener("relay:created-reservation",this._onAddRelayPeer)}async listen(t){if(GV.exactMatch(t))this.log("searching for circuit relay servers"),this.reservationId=this.reservationStore.reserveRelay();else if(WV.exactMatch(t)){this.log("listen on specific relay server %a",t);const n=AbortSignal.timeout(this.listenTimeout),i=t.decapsulate("/p2p-circuit"),s=await this.connectionManager.openConnection(i,{signal:n});if(!this.reservationStore.hasReservation(s.remotePeer)){this.log("making reservation on peer %p",s.remotePeer);const o=await this.reservationStore.addRelay(s.remotePeer,"configured");this.addedRelay(o)}}else throw new ny(`Could not listen on p2p-circuit address "${t}"`)}getAddrs(){return[...this.listeningAddrs.values()].flat()}updateAnnounceAddrs(){}async close(){this.reservationStore.cancelReservations(),this.listeningAddrs=[],this.reservationStore.removeEventListener("relay:removed",this._onRemoveRelayPeer),queueMicrotask(()=>{this.safeDispatchEvent("close")})}addedRelay(t){this.log("relay peer added %p",t.relay),this.relay=t.relay,this.listeningAddrs=t.details.reservation.addrs.map(n=>Re(n).encapsulate("/p2p-circuit")),this.listeningAddrs.forEach(n=>{this.addressManager.confirmObservedAddr(n,{type:"transport"})}),queueMicrotask(()=>{this.safeDispatchEvent("listening")})}}function A3e(r){return new x3e(r)}const C3e="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";let I3e=(r=21)=>{let e="",t=crypto.getRandomValues(new Uint8Array(r|=0));for(;r--;)e+=C3e[t[r]&63];return e};const k3e=60*1e3*10,_3e=60*1e3*5,T3e=30*1e3;var _n,QV,Wf,Gf;class P3e extends er{constructor(t,n){super();Ge(this,_n);u(this,"peerId");u(this,"connectionManager");u(this,"peerStore");u(this,"events");u(this,"reserveQueue");u(this,"reservations");u(this,"pendingReservations");u(this,"maxReservationQueueLength");u(this,"reservationCompletionTimeout");u(this,"started");u(this,"log");u(this,"relayFilter");this.log=t.logger.forComponent("libp2p:circuit-relay:transport:reservation-store"),this.peerId=t.peerId,this.connectionManager=t.connectionManager,this.peerStore=t.peerStore,this.events=t.events,this.reservations=new Fc,this.pendingReservations=[],this.maxReservationQueueLength=(n==null?void 0:n.maxReservationQueueLength)??u3e,this.reservationCompletionTimeout=(n==null?void 0:n.reservationCompletionTimeout)??VV,this.started=!1,this.relayFilter=Ql(100),this.reserveQueue=new Ac({concurrency:(n==null?void 0:n.reservationConcurrency)??l3e,metricName:"libp2p_relay_reservation_queue",metrics:t.metrics}),this.events.addEventListener("connection:close",i=>{[...this.reservations.values()].find(o=>o.connection===i.detail.id)!=null&&Ie(this,_n,Wf).call(this,i.detail.remotePeer).catch(o=>{this.log("could not remove relay %p - %e",i.detail,o)})})}isStarted(){return this.started}start(){this.started=!0}afterStart(){Promise.resolve().then(async()=>{const t=await this.peerStore.all({filters:[n=>n.tags.has(lg)]});this.log("removing tag from %d old relays",t.length),await Promise.all(t.map(async n=>{await this.peerStore.merge(n.id,{tags:{[lg]:void 0}})})),this.log("redialing %d old relays",t.length),await Promise.all(t.map(async n=>this.addRelay(n.id,"discovered"))),Ie(this,_n,Gf).call(this)}).catch(t=>{this.log.error(t)})}stop(){this.reserveQueue.clear(),this.reservations.forEach(({timeout:t})=>{clearTimeout(t)}),this.reservations.clear(),this.started=!1}reserveRelay(){const t=I3e();return this.pendingReservations.push(t),Ie(this,_n,Gf).call(this),t}async addRelay(t,n){if(this.peerId.equals(t))throw this.log.trace("not trying to use self as relay"),new ny("Cannot use self as relay");if(this.reserveQueue.size>this.maxReservationQueueLength)throw new qV("The reservation queue is full");const i=this.reserveQueue.find(t);if(i!=null)return this.log.trace("potential relay peer %p is already in the reservation queue",t),i.join();if(this.relayFilter.has(t.toMultihash().bytes))throw new ny("The relay was previously invalid");return this.log.trace("try to reserve relay slot with %p",t),this.reserveQueue.add(async()=>{const s=Date.now();try{const o=this.reservations.get(t);if(o!=null){const g=this.connectionManager.getConnections(t);let v=!1;if(g.length===0&&this.log("already have relay reservation with %p but we are no longer connected",t),g.map(y=>y.id).includes(o.connection)&&(this.log("already have relay reservation with %p and the original connection is still open",t),v=!0),v&&HT(o.reservation.expire)>k3e)return this.log("already have relay reservation with %p but we are still connected and it does not expire soon",t),{relay:t,details:o};await Ie(this,_n,Wf).call(this,t)}if(n==="discovered"&&this.pendingReservations.length===0)throw new Bv("Not making reservation on discovered relay because we do not need any more relays");const a=AbortSignal.timeout(this.reservationCompletionTimeout);const c=await this.connectionManager.openConnection(t,{signal:a});if(Ic.matches(c.remoteAddr))throw new HV("not creating reservation over relayed connection");const l=await Ie(this,_n,QV).call(this,c,{signal:a}),d=HT(l.expire);this.log("created reservation on relay peer %p, expiry date is %s",t,new Date(Date.now()+d).toString());const h=Math.min(Math.max(d-_3e,T3e),Math.pow(2,31)-1),p=setTimeout(()=>{this.log("refresh reservation to relay %p",t),this.addRelay(t,n).catch(async g=>{this.log.error("could not refresh reservation to relay %p - %e",t,g),await Ie(this,_n,Wf).call(this,t)}).catch(g=>{this.log.error("could not remove expired reservation to relay %p - %e",t,g)})},h);let m;if(n==="discovered"){const g=this.pendingReservations.pop();if(g==null)throw new Bv("Made reservation on relay but did not need any more discovered relays");m={timeout:p,reservation:l,type:n,connection:c.id,id:g}}else m={timeout:p,reservation:l,type:n,connection:c.id};this.reservations.set(t,m),await this.peerStore.merge(t,{tags:{[lg]:{value:1,ttl:d}}}),Ie(this,_n,Gf).call(this);const f={relay:t,details:m};return this.safeDispatchEvent("relay:created-reservation",{detail:f}),f}catch(o){throw n==="discovered"&&o.name==="HadEnoughRelaysError"||this.log.error("could not reserve slot on %p after %dms - %e",t,Date.now()-s,o),(o.name==="DialError"||o.name==="UnsupportedProtocolError")&&this.relayFilter.add(t.toMultihash().bytes),Ie(this,_n,Wf).call(this,t).catch(a=>{this.log.error("could not remove reservation on %p after reserving slot failed - %e",t,a)}),o}},{peerId:t})}hasReservation(t){return this.reservations.has(t)}getReservation(t){var n;return(n=this.reservations.get(t))==null?void 0:n.reservation}reservationCount(t){return t==null?this.reservations.size:[...this.reservations.values()].reduce((n,i)=>(i.type===t&&n++,n),0)}cancelReservations(){[...this.reservations.values()].forEach(t=>{clearTimeout(t.timeout)}),this.reservations.clear()}}_n=new WeakSet,QV=async function(t,n){var l;(l=n.signal)==null||l.throwIfAborted(),this.log("requesting reservation from %p",t.remotePeer);const i=await t.newStream(fm,n),o=ti(i).pb(oh);this.log.trace("send RESERVE to %p",t.remotePeer),await o.write({type:oh.Type.RESERVE},n);let a;try{this.log.trace("reading response from %p",t.remotePeer),a=await o.read(n)}catch(d){throw i.abort(d),d}finally{i.status!=="closed"&&await i.close(n)}if(this.log.trace("read response %o",a),a.status===an.OK&&a.reservation!=null){const d=new Set;d.add(t.remoteAddr.toString());for(const h of a.reservation.addrs){let p=Re(h);p.getPeerId()==null&&(p=p.encapsulate(`/p2p/${t.remotePeer}`)),p=Re(p.toString().replace(`/p2p/${t.remotePeer}/p2p/${t.remotePeer}`,`/p2p/${t.remotePeer}`)),d.add(p.toString())}return a.reservation.addrs=[...d].map(h=>Re(h).bytes),a.reservation}const c=`reservation failed with status ${a.status??"undefined"}`;throw this.log.error(c),new Error(c)},Wf=async function(t){const n=this.reservations.get(t);n!=null&&(this.log("removing relay reservation with %p from local store",t),clearTimeout(n.timeout),this.reservations.delete(t),n.type==="discovered"&&this.pendingReservations.push(n.id),await this.peerStore.merge(t,{tags:{[lg]:void 0}}),this.safeDispatchEvent("relay:removed",{detail:{relay:t,details:n}}),Ie(this,_n,Gf).call(this))},Gf=function(){if(this.pendingReservations.length===0){this.log.trace("have discovered enough relays"),this.reserveQueue.clear(),this.safeDispatchEvent("relay:found-enough-relays");return}this.relayFilter=Ql(100),this.log("not discovered enough relays %d/%d",this.reservations.size,this.pendingReservations.length),this.safeDispatchEvent("relay:not-enough-relays")};const D3e=r=>{if(r.peer==null)return!1;try{r.peer.addrs.forEach(Re)}catch{return!1}return!0},QT={maxInboundStopStreams:jT,maxOutboundStopStreams:jT};var DN,$N,NN,MN;class $3e{constructor(e,t={}){u(this,"discovery");u(this,"registrar");u(this,"peerStore");u(this,"connectionManager");u(this,"transportManager");u(this,"peerId");u(this,"upgrader");u(this,"addressManager");u(this,"connectionGater");u(this,"reservationStore");u(this,"logger");u(this,"maxInboundStopStreams");u(this,"maxOutboundStopStreams");u(this,"started");u(this,"log");u(this,"shutdownController");u(this,MN,"@libp2p/circuit-relay-v2-transport");u(this,NN,["@libp2p/transport","@libp2p/circuit-relay-v2-transport"]);u(this,DN,!0);this.log=e.logger.forComponent("libp2p:circuit-relay:transport"),this.registrar=e.registrar,this.peerStore=e.peerStore,this.connectionManager=e.connectionManager,this.transportManager=e.transportManager,this.logger=e.logger,this.peerId=e.peerId,this.upgrader=e.upgrader,this.addressManager=e.addressManager,this.connectionGater=e.connectionGater,this.maxInboundStopStreams=t.maxInboundStopStreams??QT.maxInboundStopStreams,this.maxOutboundStopStreams=t.maxOutboundStopStreams??QT.maxOutboundStopStreams,this.shutdownController=new AbortController,this.discovery=new S3e(e,{filter:t.discoveryFilter??iae(d3e,h3e)}),this.discovery.addEventListener("relay:discover",n=>{this.reservationStore.addRelay(n.detail,"discovered").catch(i=>{i.name!=="HadEnoughRelaysError"&&i.name!=="RelayQueueFullError"&&this.log.error("could not add discovered relay %p",n.detail,i)})}),this.reservationStore=new P3e(e,t),this.reservationStore.addEventListener("relay:not-enough-relays",()=>{var n;(n=this.discovery)==null||n.startDiscovery()}),this.reservationStore.addEventListener("relay:found-enough-relays",()=>{var n;(n=this.discovery)==null||n.stopDiscovery()}),this.started=!1}get[(MN=Symbol.toStringTag,NN=fr,$N=Ec,DN=X3,$N)](){return this.discovery!=null?["@libp2p/identify"]:[]}isStarted(){return this.started}async start(){this.shutdownController=new AbortController,await this.registrar.handle(KT,e=>{const t=this.upgrader.createInboundAbortSignal(this.shutdownController.signal);this.onStop(e,t).catch(n=>{this.log.error("error while handling STOP protocol",n),e.stream.abort(n)}).finally(()=>{t.clear()})},{maxInboundStreams:this.maxInboundStopStreams,maxOutboundStreams:this.maxOutboundStopStreams,runOnLimitedConnection:!0}),await Vo(this.discovery,this.reservationStore),this.started=!0}async stop(){this.shutdownController.abort(),await Bc(this.discovery,this.reservationStore),await this.registrar.unhandle(KT),this.started=!1}async dial(e,t){var m,f,g,v,y,w;if(e.protoCodes().filter(b=>b===c3e).length!==1){const b="Invalid circuit relay address";throw this.log.error(b,e),new gd(b)}const n=e.toString().split("/p2p-circuit"),i=Re(n[0]),s=Re(n[n.length-1]),o=i.getPeerId(),a=s.getPeerId();if(o==null||a==null){const b=`ircuit relay dial to ${e.toString()} failed as address did not have both relay and destination PeerIDs`;throw this.log.error(`c${b}`),new gd(`C${b}`)}const c=Jt(o),l=Jt(a);let h=this.connectionManager.getConnections(c)[0];h==null?(await this.peerStore.merge(c,{multiaddrs:[i]}),(m=t.onProgress)==null||m.call(t,new _e("circuit-relay:open-connection")),h=await this.connectionManager.openConnection(c,t)):(f=t.onProgress)==null||f.call(t,new _e("circuit-relay:reuse-connection"));let p;try{(g=t.onProgress)==null||g.call(t,new _e("circuit-relay:open-hop-stream")),p=await h.newStream(fm,t);const b=ti(p),E=b.pb(oh);(v=t.onProgress)==null||v.call(t,new _e("circuit-relay:write-connect-message")),await E.write({type:oh.Type.CONNECT,peer:{id:l.toMultihash().bytes,addrs:[Re(s).bytes]}},t),(y=t.onProgress)==null||y.call(t,new _e("circuit-relay:read-connect-response"));const A=await E.read(t);if(A.status!==an.OK)throw new xt(`failed to connect via relay with status ${((w=A==null?void 0:A.status)==null?void 0:w.toString())??"undefined"}`);const k=new qT(A.limit),x=WT({stream:b.unwrap(),remoteAddr:e,localAddr:i.encapsulate(`/p2p-circuit/p2p/${this.peerId.toString()}`),logger:this.logger,onDataRead:k.onData,onDataWrite:k.onData});return this.log("new outbound relayed connection %a",x.remoteAddr),await this.upgrader.upgradeOutbound(x,{...t,limits:k.getLimits()})}catch(b){throw this.log.error("circuit relay dial to destination %p via relay %p failed",l,c,b),p==null||p.abort(b),b}}createListener(e){return A3e({peerId:this.peerId,connectionManager:this.connectionManager,addressManager:this.addressManager,reservationStore:this.reservationStore,logger:this.logger})}listenFilter(e){return e=Array.isArray(e)?e:[e],e.filter(t=>WV.exactMatch(t)||GV.exactMatch(t))}dialFilter(e){return e=Array.isArray(e)?e:[e],e.filter(t=>Ic.exactMatch(t))}async onStop({connection:e,stream:t},n){var d,h;if(!this.reservationStore.hasReservation(e.remotePeer))try{this.log("dialed via relay we did not have a reservation on, start listening on that relay address"),await this.transportManager.listen([e.remoteAddr.encapsulate("/p2p-circuit")])}catch(p){this.log.error("failed to listen on a relay peer we were dialed via but did not have a reservation on",p)}const i=ti(t).pb(po),s=await i.read({signal:n});if(this.log("new circuit relay v2 stop stream from %p with type %s",e.remotePeer,s.type),(s==null?void 0:s.type)===void 0){this.log.error("type was missing from circuit v2 stop protocol request from %s",e.remotePeer),await i.write({type:po.Type.STATUS,status:an.MALFORMED_MESSAGE},{signal:n}),await t.close();return}if(s.type!==po.Type.CONNECT){this.log.error("invalid stop connect request via peer %p",e.remotePeer),await i.write({type:po.Type.STATUS,status:an.UNEXPECTED_MESSAGE},{signal:n}),await t.close();return}if(!D3e(s)){this.log.error("invalid stop connect request via peer %p",e.remotePeer),await i.write({type:po.Type.STATUS,status:an.MALFORMED_MESSAGE},{signal:n}),await t.close({signal:n});return}const o=si(o3e(s.peer.id));if(await((h=(d=this.connectionGater).denyInboundRelayedConnection)==null?void 0:h.call(d,e.remotePeer,o))===!0){this.log.error("connection gater denied inbound relayed connection from %p",e.remotePeer),await i.write({type:po.Type.STATUS,status:an.PERMISSION_DENIED},{signal:n}),await t.close({signal:n});return}this.log.trace("sending success response to %p",e.remotePeer),await i.write({type:po.Type.STATUS,status:an.OK},{signal:n});const a=new qT(s.limit),c=e.remoteAddr.encapsulate(`/p2p-circuit/p2p/${o.toString()}`);this.addressManager.getAddresses()[0];const l=WT({stream:i.unwrap().unwrap(),remoteAddr:c,logger:this.logger,onDataRead:a.onData,onDataWrite:a.onData});this.log("new inbound relayed connection %a",l.remoteAddr),await this.upgrader.upgradeInbound(l,{limits:a.getLimits(),signal:n}),this.log("%s connection %a upgraded","inbound",l.remoteAddr)}}function xx(r={}){return e=>new $3e(e,r)}const YT=()=>{const r=new Error("Delay aborted");return r.name="AbortError",r},N3e=new WeakMap;function M3e({clearTimeout:r,setTimeout:e}={}){return(t,{value:n,signal:i}={})=>{if(i!=null&&i.aborted)return Promise.reject(YT());let s,o,a;const c=r??clearTimeout,l=()=>{c(s),a(YT())},d=()=>{i&&i.removeEventListener("abort",l)},h=new Promise((p,m)=>{o=()=>{d(),p(n)},a=m,s=(e??setTimeout)(o,t)});return i&&i.addEventListener("abort",l,{once:!0}),N3e.set(h,()=>{c(s),s=null,o()}),h}}const YV=M3e();var $s;(function(r){(function(n){n.UNUSED="UNUSED",n.CONNECT="CONNECT",n.SYNC="SYNC"})(r.Type||(r.Type={}));let e;(function(n){n[n.UNUSED=0]="UNUSED",n[n.CONNECT=100]="CONNECT",n[n.SYNC=300]="SYNC"})(e||(e={})),function(n){n.codec=()=>On(e)}(r.Type||(r.Type={}));let t;r.codec=()=>(t==null&&(t=$e((n,i,s={})=>{if(s.lengthDelimited!==!1&&i.fork(),n.type!=null&&(i.uint32(8),r.Type.codec().encode(n.type,i)),n.observedAddresses!=null)for(const o of n.observedAddresses)i.uint32(18),i.bytes(o);s.lengthDelimited!==!1&&i.ldelim()},(n,i,s={})=>{var c;const o={observedAddresses:[]},a=i==null?n.len:n.pos+i;for(;n.pos<a;){const l=n.uint32();switch(l>>>3){case 1:{o.type=r.Type.codec().decode(n);break}case 2:{if(((c=s.limits)==null?void 0:c.observedAddresses)!=null&&o.observedAddresses.length===s.limits.observedAddresses)throw new pt('Decode error - map field "observedAddresses" had too many elements');o.observedAddresses.push(n.bytes());break}default:{n.skipType(l&7);break}}}return o})),t),r.encode=n=>De(n,r.codec()),r.decode=(n,i)=>Pe(n,r.codec(),i)})($s||($s={}));function JT(r,e){return Ic.matches(r)||e.dialTransportForMultiaddr(r)==null?!1:sz.matches(r)?!0:The.matches(r)?zc(r.toOptions().host)===!1:!1}const XT=1024*4,ZT=100,ug={timeout:5e3,retries:3,maxInboundStreams:1,maxOutboundStreams:1};var ON,RN;RN=Symbol.toStringTag,ON=Ec;class O3e{constructor(e,t){u(this,"started");u(this,"timeout");u(this,"retries");u(this,"maxInboundStreams");u(this,"maxOutboundStreams");u(this,"peerStore");u(this,"registrar");u(this,"connectionManager");u(this,"addressManager");u(this,"transportManager");u(this,"topologyId");u(this,"log");u(this,RN,"@libp2p/dcutr");u(this,ON,["@libp2p/identify"]);this.log=e.logger.forComponent("libp2p:dcutr"),this.started=!1,this.peerStore=e.peerStore,this.registrar=e.registrar,this.addressManager=e.addressManager,this.connectionManager=e.connectionManager,this.transportManager=e.transportManager,this.timeout=t.timeout??ug.timeout,this.retries=t.retries??ug.retries,this.maxInboundStreams=t.maxInboundStreams??ug.maxInboundStreams,this.maxOutboundStreams=t.maxOutboundStreams??ug.maxOutboundStreams}isStarted(){return this.started}async start(){this.started||(this.topologyId=await this.registrar.register(dg,{notifyOnLimitedConnection:!0,onConnect:(e,t)=>{Ic.exactMatch(t.remoteAddr)&&t.direction==="inbound"&&this.upgradeInbound(t).catch(n=>{this.log.error("error during outgoing DCUtR attempt",n)})}}),await this.registrar.handle(dg,e=>{this.handleIncomingUpgrade(e.stream,e.connection).catch(t=>{this.log.error("error during incoming DCUtR attempt",t),e.stream.abort(t)})},{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:!0}),this.started=!0)}async stop(){await this.registrar.unhandle(dg),this.topologyId!=null&&this.registrar.unregister(this.topologyId),this.started=!1}async upgradeInbound(e){if(await this.attemptUnilateralConnectionUpgrade(e))return;let t;for(let n=0;n<this.retries;n++){const i={signal:AbortSignal.timeout(this.timeout)};try{t=await e.newStream([dg],{signal:i.signal,runOnLimitedConnection:!0});const s=ti(t,{maxDataLength:XT}).pb($s);this.log("B sending connect to %p",e.remotePeer);const o=Date.now();await s.write({type:$s.Type.CONNECT,observedAddresses:this.addressManager.getAddresses().map(h=>h.bytes)},i),this.log("B receiving connect from %p",e.remotePeer);const a=await s.read(i);if(a.type!==$s.Type.CONNECT)throw this.log("A sent wrong message type"),new xt("DCUtR message type was incorrect");const c=this.getDialableMultiaddrs(a.observedAddresses);if(c.length===0)throw this.log("A did not have any dialable multiaddrs"),new xt("DCUtR connect message had no multiaddrs");const l=Date.now()-o;this.log("A sending sync, rtt %dms",l),await s.write({type:$s.Type.SYNC,observedAddresses:[]},i),this.log("A waiting for half RTT"),await YV(l/2),this.log("B dialing",c);const d=await this.connectionManager.openConnection(c,{signal:i.signal,priority:ZT,force:!0,initiator:!1});this.log("DCUtR to %p succeeded to address %a, closing relayed connection",e.remotePeer,d.remoteAddr),await e.close(i);break}catch(s){if(this.log.error("error while attempting DCUtR on attempt %d of %d",n+1,this.retries,s),t==null||t.abort(s),n===this.retries)throw s}finally{t!=null&&await t.close(i)}}}async attemptUnilateralConnectionUpgrade(e){const n=(await this.peerStore.get(e.remotePeer)).addresses.map(i=>{const s=i.multiaddr;return s.getPeerId()==null?s.encapsulate(`/p2p/${e.remotePeer}`):s}).filter(i=>JT(i,this.transportManager));if(n.length>0){const i=AbortSignal.timeout(this.timeout);try{this.log("attempting unilateral connection upgrade to %a",n);const s=await this.connectionManager.openConnection(n,{signal:i,force:!0});if(Ic.exactMatch(s.remoteAddr))throw new Error("Could not open a new, non-limited, connection");return this.log("unilateral connection upgrade to %p succeeded via %a, closing relayed connection",e.remotePeer,s.remoteAddr),await e.close({signal:i}),!0}catch(s){this.log.error("unilateral connection upgrade to %p on addresses %a failed",e.remotePeer,n,s)}}else this.log("peer %p has no public addresses, not attempting unilateral connection upgrade",e.remotePeer);return!1}async handleIncomingUpgrade(e,t){const n={signal:AbortSignal.timeout(this.timeout)};try{const i=ti(e,{maxDataLength:XT}).pb($s);this.log("A receiving connect");const s=await i.read(n);if(s.type!==$s.Type.CONNECT)throw this.log("B sent wrong message type"),new xt("DCUtR message type was incorrect");if(s.observedAddresses.length===0)throw this.log("B sent no multiaddrs"),new xt("DCUtR connect message had no multiaddrs");const o=this.getDialableMultiaddrs(s.observedAddresses);if(o.length===0)throw this.log("B had no dialable multiaddrs"),new xt("DCUtR connect message had no dialable multiaddrs");if(this.log("A sending connect"),await i.write({type:$s.Type.CONNECT,observedAddresses:this.addressManager.getAddresses().map(l=>l.bytes)}),this.log("A receiving sync"),(await i.read(n)).type!==$s.Type.SYNC)throw new xt("DCUtR message type was incorrect");this.log("A dialing",o);const c=await this.connectionManager.openConnection(o,{signal:n.signal,priority:ZT,force:!0});this.log("DCUtR to %p succeeded via %a, closing relayed connection",t.remotePeer,c.remoteAddr),await t.close(n)}catch(i){this.log.error("incoming DCUtR from %p failed",t.remotePeer,i),e.abort(i)}finally{await e.close(n)}}getDialableMultiaddrs(e){const t=[];for(const n of e)if(!(n==null||n.length===0))try{const i=Re(n);if(!JT(i,this.transportManager))continue;t.push(i)}catch{}return t}}const dg="/libp2p/dcutr";function R3e(r={}){return e=>new O3e(e,r)}const hg=globalThis.CustomEvent??Event;async function*Gp(r,e={}){let t=e.concurrency??1/0;t<1&&(t=1/0);const n=e.ordered??!1,i=new EventTarget,s=[];let o=Le(),a=Le(),c=!1,l,d=!1;i.addEventListener("task-complete",()=>{a.resolve()}),Promise.resolve().then(async()=>{try{for await(const f of r){if(s.length===t&&(o=Le(),await o.promise),d)break;const g={done:!1};s.push(g),f().then(v=>{g.done=!0,g.ok=!0,g.value=v,i.dispatchEvent(new hg("task-complete"))},v=>{g.done=!0,g.err=v,i.dispatchEvent(new hg("task-complete"))})}c=!0,i.dispatchEvent(new hg("task-complete"))}catch(f){l=f,i.dispatchEvent(new hg("task-complete"))}});function h(){var f;return n?(f=s[0])==null?void 0:f.done:!!s.find(g=>g.done)}function*p(){for(;s.length>0&&s[0].done;){const f=s[0];if(s.shift(),f.ok)yield f.value;else throw d=!0,o.resolve(),f.err;o.resolve()}}function*m(){for(;h();)for(let f=0;f<s.length;f++)if(s[f].done){const g=s[f];if(s.splice(f,1),f--,g.ok)yield g.value;else throw d=!0,o.resolve(),g.err;o.resolve()}}for(;;){if(h()||(a=Le(),await a.promise),l!=null)throw l;if(n?yield*p():yield*m(),c&&s.length===0)break}}const L3e="0.1.0",B3e="id",U3e="id/push",F3e="1.0.0",z3e="1.0.0",V3e=1024*8,K3e=32;var lh;(function(r){let e;r.codec=()=>(e==null&&(e=$e((t,n,i={})=>{if(i.lengthDelimited!==!1&&n.fork(),t.protocolVersion!=null&&(n.uint32(42),n.string(t.protocolVersion)),t.agentVersion!=null&&(n.uint32(50),n.string(t.agentVersion)),t.publicKey!=null&&(n.uint32(10),n.bytes(t.publicKey)),t.listenAddrs!=null)for(const s of t.listenAddrs)n.uint32(18),n.bytes(s);if(t.observedAddr!=null&&(n.uint32(34),n.bytes(t.observedAddr)),t.protocols!=null)for(const s of t.protocols)n.uint32(26),n.string(s);t.signedPeerRecord!=null&&(n.uint32(66),n.bytes(t.signedPeerRecord)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{var a,c;const s={listenAddrs:[],protocols:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 5:{s.protocolVersion=t.string();break}case 6:{s.agentVersion=t.string();break}case 1:{s.publicKey=t.bytes();break}case 2:{if(((a=i.limits)==null?void 0:a.listenAddrs)!=null&&s.listenAddrs.length===i.limits.listenAddrs)throw new pt('Decode error - map field "listenAddrs" had too many elements');s.listenAddrs.push(t.bytes());break}case 4:{s.observedAddr=t.bytes();break}case 3:{if(((c=i.limits)==null?void 0:c.protocols)!=null&&s.protocols.length===i.limits.protocols)throw new pt('Decode error - map field "protocols" had too many elements');s.protocols.push(t.string());break}case 8:{s.signedPeerRecord=t.bytes();break}default:{t.skipType(l&7);break}}}return s})),e),r.encode=t=>De(t,r.codec()),r.decode=(t,n)=>Pe(t,r.codec(),n)})(lh||(lh={}));const wi={protocolPrefix:"ipfs",timeout:5e3,maxInboundStreams:1,maxOutboundStreams:1,maxObservedAddresses:10,maxMessageSize:V3e,runOnConnectionOpen:!0,runOnSelfUpdate:!0,runOnLimitedConnection:!0,concurrency:K3e};function j3e(r){if(r!=null&&r.length>0)try{return Re(r)}catch{}}function H3e(r,e){return e??r.userAgent}async function JV(r,e,t,n,i){if(t("received identify from %p",n.remotePeer),i==null)throw new xt("message was null or undefined");const s={};if(i.listenAddrs.length>0&&(s.addresses=i.listenAddrs.map(c=>({isCertified:!1,multiaddr:Re(c)}))),i.protocols.length>0&&(s.protocols=i.protocols),i.publicKey!=null){const c=Rn(i.publicKey);if(!Jd(c).equals(n.remotePeer))throw new xt("public key did not match remote PeerId");s.publicKey=c}let o;if(i.signedPeerRecord!=null){t.trace("received signedPeerRecord from %p",n.remotePeer);let c=i.signedPeerRecord;const l=await _c.openAndCertify(c,js.DOMAIN);let d=js.createFromProtobuf(l.payload);const h=Oh(l.publicKey.toCID());if(!d.peerId.equals(h))throw new xt("signing key does not match PeerId in the PeerRecord");if(!n.remotePeer.equals(d.peerId))throw new xt("signing key does not match remote PeerId");let p;try{p=await r.get(d.peerId)}catch(m){if(m.name!=="NotFoundError")throw m}if(p!=null&&(s.metadata=p.metadata,p.peerRecordEnvelope!=null)){const m=await _c.createFromProtobuf(p.peerRecordEnvelope),f=js.createFromProtobuf(m.payload);f.seqNumber>=d.seqNumber&&(t("sequence number was lower or equal to existing sequence number - stored: %d received: %d",f.seqNumber,d.seqNumber),d=f,c=p.peerRecordEnvelope)}s.peerRecordEnvelope=c,s.addresses=d.multiaddrs.map(m=>({isCertified:!0,multiaddr:m})),o={seq:d.seqNumber,addresses:d.multiaddrs}}else t("%p did not send a signed peer record",n.remotePeer);if(t.trace("patching %p with",n.remotePeer,s),await r.patch(n.remotePeer,s),i.agentVersion!=null||i.protocolVersion!=null){const c={};i.agentVersion!=null&&(c.AgentVersion=oe(i.agentVersion)),i.protocolVersion!=null&&(c.ProtocolVersion=oe(i.protocolVersion)),t.trace("merging %p metadata",n.remotePeer,c),await r.merge(n.remotePeer,{metadata:c})}const a={peerId:n.remotePeer,protocolVersion:i.protocolVersion,agentVersion:i.agentVersion,publicKey:i.publicKey,listenAddrs:i.listenAddrs.map(c=>Re(c)),observedAddr:i.observedAddr==null?void 0:Re(i.observedAddr),protocols:i.protocols,signedPeerRecord:o,connection:n};return e.safeDispatchEvent("peer:identify",{detail:a}),a}class XV{constructor(e,t){u(this,"host");u(this,"protocol");u(this,"started");u(this,"timeout");u(this,"peerId");u(this,"privateKey");u(this,"peerStore");u(this,"registrar");u(this,"addressManager");u(this,"maxInboundStreams");u(this,"maxOutboundStreams");u(this,"maxMessageSize");u(this,"maxObservedAddresses");u(this,"events");u(this,"runOnLimitedConnection");u(this,"log");this.protocol=t.protocol,this.started=!1,this.peerId=e.peerId,this.privateKey=e.privateKey,this.peerStore=e.peerStore,this.registrar=e.registrar,this.addressManager=e.addressManager,this.events=e.events,this.log=t.log,this.timeout=t.timeout??wi.timeout,this.maxInboundStreams=t.maxInboundStreams??wi.maxInboundStreams,this.maxOutboundStreams=t.maxOutboundStreams??wi.maxOutboundStreams,this.maxMessageSize=t.maxMessageSize??wi.maxMessageSize,this.maxObservedAddresses=t.maxObservedAddresses??wi.maxObservedAddresses,this.runOnLimitedConnection=t.runOnLimitedConnection??wi.runOnLimitedConnection,this.host={protocolVersion:`${t.protocolPrefix??wi.protocolPrefix}/${L3e}`,agentVersion:H3e(e.nodeInfo,t.agentVersion)}}isStarted(){return this.started}async start(){this.started||(await this.peerStore.merge(this.peerId,{metadata:{AgentVersion:oe(this.host.agentVersion),ProtocolVersion:oe(this.host.protocolVersion)}}),await this.registrar.handle(this.protocol,e=>{this.handleProtocol(e).catch(t=>{this.log.error(t)})},{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:this.runOnLimitedConnection}),this.started=!0)}async stop(){await this.registrar.unhandle(this.protocol),this.started=!1}}var LN,BN;class q3e extends(BN=XV,LN=fr,BN){constructor(t,n={}){super(t,{...n,protocol:`/${n.protocolPrefix??wi.protocolPrefix}/${U3e}/${z3e}`,log:t.logger.forComponent("libp2p:identify-push")});u(this,"connectionManager");u(this,"concurrency");u(this,LN,["@libp2p/identify-push"]);this.connectionManager=t.connectionManager,this.concurrency=n.concurrency??wi.concurrency,(n.runOnSelfUpdate??wi.runOnSelfUpdate)&&t.events.addEventListener("self:peer:update",i=>{this.push().catch(s=>{this.log.error(s)})})}async push(){if(!this.isStarted())return;const t=this.addressManager.getAddresses().map(h=>h.decapsulateCode(ze("p2p").code)),n=new js({peerId:this.peerId,multiaddrs:t}),i=await _c.seal(n,this.privateKey),s=this.registrar.getProtocols(),o=await this.peerStore.get(this.peerId),a=re(o.metadata.get("AgentVersion")??oe(this.host.agentVersion)),c=re(o.metadata.get("ProtocolVersion")??oe(this.host.protocolVersion)),l=this;async function*d(){for(const h of l.connectionManager.getConnections())(await l.peerStore.get(h.remotePeer)).protocols.includes(l.protocol)&&(yield async()=>{let m;const f=AbortSignal.timeout(l.timeout);try{m=await h.newStream(l.protocol,{signal:f,runOnLimitedConnection:l.runOnLimitedConnection}),await ti(m,{maxDataLength:l.maxMessageSize}).pb(lh).write({listenAddrs:t.map(v=>v.bytes),signedPeerRecord:i.marshal(),protocols:s,agentVersion:a,protocolVersion:c},{signal:f}),await m.close({signal:f})}catch(g){l.log.error("could not push identify update to peer",g),m==null||m.abort(g)}})}await zo(Gp(d(),{concurrency:this.concurrency}))}async handleProtocol(t){const{connection:n,stream:i}=t;try{if(this.peerId.equals(n.remotePeer))throw new Error("received push from ourselves?");const s={signal:AbortSignal.timeout(this.timeout)},a=await ti(i,{maxDataLength:this.maxMessageSize}).pb(lh).read(s);await i.close(s),await JV(this.peerStore,this.events,this.log,n,a)}catch(s){this.log.error("received invalid message",s),i.abort(s);return}this.log.trace("handled push from %p",n.remotePeer)}}const W3e=41;var UN,FN;class G3e extends(FN=XV,UN=fr,FN){constructor(t,n={}){super(t,{...n,protocol:`/${n.protocolPrefix??wi.protocolPrefix}/${B3e}/${F3e}`,log:t.logger.forComponent("libp2p:identify")});u(this,UN,["@libp2p/identify"]);(n.runOnConnectionOpen??wi.runOnConnectionOpen)&&t.events.addEventListener("connection:open",i=>{const s=i.detail;this.identify(s).catch(o=>{o.name!==Lp.name&&this.log.error("error during identify trigged by connection:open",o)})})}async _identify(t,n={}){let i;if(n.signal==null){const s=AbortSignal.timeout(this.timeout);n={...n,signal:s}}try{i=await t.newStream(this.protocol,{...n,runOnLimitedConnection:this.runOnLimitedConnection});const o=await ti(i,{maxDataLength:this.maxMessageSize}).pb(lh).read(n);return await i.close(n),o}catch(s){throw i==null||i.abort(s),s}}async identify(t,n={}){const i=await this._identify(t,n),{publicKey:s,protocols:o,observedAddr:a}=i;if(s==null)throw new xt("public key was missing from identify message");const c=Rn(s),l=Oh(c.toCID());if(!t.remotePeer.equals(l))throw new xt("identified peer does not match the expected peer");if(this.peerId.equals(l))throw new xt("identified peer is our own peer id?");return this.maybeAddObservedAddress(a),this.log("identify completed for peer %p and protocols %o",l,o),JV(this.peerStore,this.events,this.log,t,i)}maybeAddObservedAddress(t){const n=j3e(t);if(n==null)return;if(this.log.trace("our observed address was %a",n),Zl(n)){this.log.trace("our observed address was private");return}if(n.stringTuples()[0][0]===W3e&&!TV(n)){this.log.trace("our observed address was IPv6 but not a global unicast address");return}Fy.exactMatch(n)||(this.log.trace("storing the observed address"),this.addressManager.addObservedAddr(n))}async handleProtocol(t){const{connection:n,stream:i}=t,s=AbortSignal.timeout(this.timeout);try{const o=await this.peerStore.get(this.peerId),a=this.addressManager.getAddresses().map(h=>h.decapsulateCode(ze("p2p").code));let c=o.peerRecordEnvelope;if(a.length>0&&c==null){const h=new js({peerId:this.peerId,multiaddrs:a});c=(await _c.seal(h,this.privateKey)).marshal().subarray()}let l=n.remoteAddr.bytes;_he.matches(n.remoteAddr)||(l=void 0),await ti(i).pb(lh).write({protocolVersion:this.host.protocolVersion,agentVersion:this.host.agentVersion,publicKey:Pi(this.privateKey.publicKey),listenAddrs:a.map(h=>h.bytes),signedPeerRecord:c,observedAddr:l,protocols:o.protocols},{signal:s}),await i.close({signal:s})}catch(o){this.log.error("could not respond to identify request",o),i.abort(o)}}}function Ax(r={}){return e=>new G3e(e,r)}function Q3e(r={}){return e=>new q3e(e,r)}const Qp=1e3,Cx=60*Qp,zw=60*Cx,Y3e=36*zw,J3e="/ipfs/kad/1.0.0",X3e=48*zw,Z3e=24*zw,ewe=10,twe=16384,rwe=zw,ZV=20,Ix=3,nwe=5*Cx,iwe=Qp,swe=5*Qp,owe=5*Cx,awe=30*Qp,cwe=180*Qp,eP=`${J3}-kad-dht`;var mm;(function(r){let e;r.codec=()=>(e==null&&(e=$e((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.key!=null&&t.key.byteLength>0&&(n.uint32(10),n.bytes(t.key)),t.value!=null&&t.value.byteLength>0&&(n.uint32(18),n.bytes(t.value)),t.timeReceived!=null&&t.timeReceived!==""&&(n.uint32(42),n.string(t.timeReceived)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{const s={key:Ye(0),value:Ye(0),timeReceived:""},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.key=t.bytes();break}case 2:{s.value=t.bytes();break}case 5:{s.timeReceived=t.string();break}default:{t.skipType(a&7);break}}}return s})),e),r.encode=t=>De(t,r.codec()),r.decode=(t,n)=>Pe(t,r.codec(),n)})(mm||(mm={}));function lwe(r){const e=r.getUTCFullYear(),t=String(r.getUTCMonth()+1).padStart(2,"0"),n=String(r.getUTCDate()).padStart(2,"0"),i=String(r.getUTCHours()).padStart(2,"0"),s=String(r.getUTCMinutes()).padStart(2,"0"),o=String(r.getUTCSeconds()).padStart(2,"0"),a=r.getUTCMilliseconds(),c=String(a*1e3*1e3).padStart(9,"0");return`${e}-${t}-${n}T${i}:${s}:${o}.${c}Z`}function uwe(r){const e=new RegExp("(\\d{4})-(\\d{2})-(\\d{2})T(\\d{2}):(\\d{2}):(\\d{2})\\.(\\d+)Z"),t=String(r).trim().match(e);if(t==null)throw new Error("Invalid format");const n=parseInt(t[1],10),i=parseInt(t[2],10)-1,s=parseInt(t[3],10),o=parseInt(t[4],10),a=parseInt(t[5],10),c=parseInt(t[6],10),l=parseInt(t[7].slice(0,-6),10);return new Date(Date.UTC(n,i,s,o,a,c,l))}class Di{constructor(e,t,n){u(this,"key");u(this,"value");u(this,"timeReceived");if(!(e instanceof Uint8Array))throw new Error("key must be a Uint8Array");if(!(t instanceof Uint8Array))throw new Error("value must be a Uint8Array");this.key=e,this.value=t,this.timeReceived=n}serialize(){return mm.encode(this.prepareSerialize())}prepareSerialize(){return{key:this.key,value:this.value,timeReceived:lwe(this.timeReceived)}}static deserialize(e){const t=mm.decode(e);return new Di(t.key,t.value,new Date(t.timeReceived))}static fromDeserialized(e){const t=uwe(e.timeReceived);if(e.key==null)throw new Error("key missing from deserialized object");if(e.value==null)throw new Error("value missing from deserialized object");return new Di(e.key,e.value,t)}}class wm extends Error{constructor(e="Query error"){super(e),this.name="QueryError"}}class dwe extends Error{constructor(e="Query aborted"){super(e),this.name="QueryAbortedError"}}class hwe extends Error{constructor(e="Invalid record"){super(e),this.name="InvalidRecordError"}}class fwe extends Error{constructor(e="No selector function configured for prefix"){super(e),this.name="MissingSelectorError"}}var tP;(function(r){let e;r.codec=()=>(e==null&&(e=$e((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.key!=null&&(n.uint32(10),n.bytes(t.key)),t.value!=null&&(n.uint32(18),n.bytes(t.value)),t.author!=null&&(n.uint32(26),n.bytes(t.author)),t.signature!=null&&(n.uint32(34),n.bytes(t.signature)),t.timeReceived!=null&&(n.uint32(42),n.string(t.timeReceived)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{const s={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.key=t.bytes();break}case 2:{s.value=t.bytes();break}case 3:{s.author=t.bytes();break}case 4:{s.signature=t.bytes();break}case 5:{s.timeReceived=t.string();break}default:{t.skipType(a&7);break}}}return s})),e),r.encode=t=>De(t,r.codec()),r.decode=(t,n)=>Pe(t,r.codec(),n)})(tP||(tP={}));var At;(function(r){r.PUT_VALUE="PUT_VALUE",r.GET_VALUE="GET_VALUE",r.ADD_PROVIDER="ADD_PROVIDER",r.GET_PROVIDERS="GET_PROVIDERS",r.FIND_NODE="FIND_NODE",r.PING="PING"})(At||(At={}));var bm;(function(r){r[r.PUT_VALUE=0]="PUT_VALUE",r[r.GET_VALUE=1]="GET_VALUE",r[r.ADD_PROVIDER=2]="ADD_PROVIDER",r[r.GET_PROVIDERS=3]="GET_PROVIDERS",r[r.FIND_NODE=4]="FIND_NODE",r[r.PING=5]="PING"})(bm||(bm={}));(function(r){r.codec=()=>On(bm)})(At||(At={}));var uh;(function(r){r.NOT_CONNECTED="NOT_CONNECTED",r.CONNECTED="CONNECTED",r.CAN_CONNECT="CAN_CONNECT",r.CANNOT_CONNECT="CANNOT_CONNECT"})(uh||(uh={}));var Uv;(function(r){r[r.NOT_CONNECTED=0]="NOT_CONNECTED",r[r.CONNECTED=1]="CONNECTED",r[r.CAN_CONNECT=2]="CAN_CONNECT",r[r.CANNOT_CONNECT=3]="CANNOT_CONNECT"})(Uv||(Uv={}));(function(r){r.codec=()=>On(Uv)})(uh||(uh={}));var nd;(function(r){let e;r.codec=()=>(e==null&&(e=$e((t,n,i={})=>{if(i.lengthDelimited!==!1&&n.fork(),t.id!=null&&t.id.byteLength>0&&(n.uint32(10),n.bytes(t.id)),t.multiaddrs!=null)for(const s of t.multiaddrs)n.uint32(18),n.bytes(s);t.connection!=null&&(n.uint32(24),uh.codec().encode(t.connection,n)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{var a;const s={id:Ye(0),multiaddrs:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const c=t.uint32();switch(c>>>3){case 1:{s.id=t.bytes();break}case 2:{if(((a=i.limits)==null?void 0:a.multiaddrs)!=null&&s.multiaddrs.length===i.limits.multiaddrs)throw new pt('Decode error - map field "multiaddrs" had too many elements');s.multiaddrs.push(t.bytes());break}case 3:{s.connection=uh.codec().decode(t);break}default:{t.skipType(c&7);break}}}return s})),e),r.encode=t=>De(t,r.codec()),r.decode=(t,n)=>Pe(t,r.codec(),n)})(nd||(nd={}));var Ol;(function(r){let e;r.codec=()=>(e==null&&(e=$e((t,n,i={})=>{if(i.lengthDelimited!==!1&&n.fork(),t.type!=null&&bm[t.type]!==0&&(n.uint32(8),At.codec().encode(t.type,n)),t.clusterLevel!=null&&(n.uint32(80),n.int32(t.clusterLevel)),t.key!=null&&(n.uint32(18),n.bytes(t.key)),t.record!=null&&(n.uint32(26),n.bytes(t.record)),t.closer!=null)for(const s of t.closer)n.uint32(66),nd.codec().encode(s,n);if(t.providers!=null)for(const s of t.providers)n.uint32(74),nd.codec().encode(s,n);i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{var a,c,l,d;const s={type:At.PUT_VALUE,closer:[],providers:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const h=t.uint32();switch(h>>>3){case 1:{s.type=At.codec().decode(t);break}case 10:{s.clusterLevel=t.int32();break}case 2:{s.key=t.bytes();break}case 3:{s.record=t.bytes();break}case 8:{if(((a=i.limits)==null?void 0:a.closer)!=null&&s.closer.length===i.limits.closer)throw new pt('Decode error - map field "closer" had too many elements');s.closer.push(nd.codec().decode(t,t.uint32(),{limits:(c=i.limits)==null?void 0:c.closer$}));break}case 9:{if(((l=i.limits)==null?void 0:l.providers)!=null&&s.providers.length===i.limits.providers)throw new pt('Decode error - map field "providers" had too many elements');s.providers.push(nd.codec().decode(t,t.uint32(),{limits:(d=i.limits)==null?void 0:d.providers$}));break}default:{t.skipType(h&7);break}}}return s})),e),r.encode=t=>De(t,r.codec()),r.decode=(t,n)=>Pe(t,r.codec(),n)})(Ol||(Ol={}));function rP(r,e={}){var n;const t={...r,name:"SEND_QUERY",type:0,messageName:r.type,messageType:r.type};return(n=e.onProgress)==null||n.call(e,new CustomEvent("kad-dht:query:send-query",{detail:t})),t}function Fv(r,e={}){var n;const t={...r,name:"PEER_RESPONSE",type:1,messageName:r.messageType,closer:r.closer??[],providers:r.providers??[]};return(n=e.onProgress)==null||n.call(e,new CustomEvent("kad-dht:query:peer-response",{detail:t})),t}function m8(r,e={}){var n;const t={...r,name:"FINAL_PEER",type:2};return(n=e.onProgress)==null||n.call(e,new CustomEvent("kad-dht:query:final-peer",{detail:t})),t}function Tc(r,e={}){var n;const t={...r,name:"QUERY_ERROR",type:3};return(n=e.onProgress)==null||n.call(e,new CustomEvent("kad-dht:query:query-error",{detail:t})),t}function nP(r,e={}){var n;const t={...r,name:"PROVIDER",type:4};return(n=e.onProgress)==null||n.call(e,new CustomEvent("kad-dht:query:provider",{detail:t})),t}function zv(r,e={}){var n;const t={...r,name:"VALUE",type:5};return(n=e.onProgress)==null||n.call(e,new CustomEvent("kad-dht:query:value",{detail:t})),t}function iP(r,e={}){var n;const t={...r,name:"DIAL_PEER",type:7};return(n=e.onProgress)==null||n.call(e,new CustomEvent("kad-dht:query:dial-peer",{detail:t})),t}function pwe(r,e,t){if(t.length===0)throw new Z("No records given");const i=re(e).split("/");if(i.length<3)throw new Z("Record key does not have a selector function");const s=r[i[1].toString()];if(s==null)throw new fwe(`No selector function configured for key type "${i[1]}"`);return t.length===1?0:s(e,t)}function gwe(r,e){return 0}const ywe={pk:gwe};async function kx(r,e){const t=e.key,i=re(t).split("/");if(i.length<3)return;const s=r[i[1].toString()];if(s==null)throw new Z(`No validator available for key type "${i[1]}"`);await s(t,e.value)}const mwe=async(r,e)=>{if(!(r instanceof Uint8Array))throw new Z('"key" must be a Uint8Array');if(r.byteLength<5)throw new Z("Invalid public key record");if(re(r.subarray(0,4))!=="/pk/")throw new Z("key was not prefixed with /pk/");const n=Rn(e),i=r.slice(4);if(!He(i,n.toMultihash().bytes))throw new Z("public key does not match passed in key")},wwe={pk:mwe};function bwe(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function _x(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function vwe(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var i=0;i<r.length;i++){var s=r.charAt(i),o=s.charCodeAt(0);if(t[o]!==255)throw new TypeError(s+" is ambiguous");t[o]=i}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),d=Math.log(256)/Math.log(a);function h(f){if(f instanceof Uint8Array||(ArrayBuffer.isView(f)?f=new Uint8Array(f.buffer,f.byteOffset,f.byteLength):Array.isArray(f)&&(f=Uint8Array.from(f))),!(f instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(f.length===0)return"";for(var g=0,v=0,y=0,w=f.length;y!==w&&f[y]===0;)y++,g++;for(var b=(w-y)*d+1>>>0,E=new Uint8Array(b);y!==w;){for(var A=f[y],k=0,x=b-1;(A!==0||k<v)&&x!==-1;x--,k++)A+=256*E[x]>>>0,E[x]=A%a>>>0,A=A/a>>>0;if(A!==0)throw new Error("Non-zero carry");v=k,y++}for(var I=b-v;I!==b&&E[I]===0;)I++;for(var T=c.repeat(g);I<b;++I)T+=r.charAt(E[I]);return T}function p(f){if(typeof f!="string")throw new TypeError("Expected String");if(f.length===0)return new Uint8Array;var g=0;if(f[g]!==" "){for(var v=0,y=0;f[g]===c;)v++,g++;for(var w=(f.length-g)*l+1>>>0,b=new Uint8Array(w);f[g];){var E=t[f.charCodeAt(g)];if(E===255)return;for(var A=0,k=w-1;(E!==0||A<y)&&k!==-1;k--,A++)E+=a*b[k]>>>0,b[k]=E%256>>>0,E=E/256>>>0;if(E!==0)throw new Error("Non-zero carry");y=A,g++}if(f[g]!==" "){for(var x=w-y;x!==w&&b[x]===0;)x++;for(var I=new Uint8Array(v+(w-x)),T=v;x!==w;)I[T++]=b[x++];return I}}}function m(f){var g=p(f);if(g)return g;throw new Error(`Non-${e} character`)}return{encode:h,decodeUnsafe:p,decode:m}}var Ewe=vwe,Swe=Ewe;let xwe=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseEncode");this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},Awe=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseDecode");u(this,"prefixCodePoint");this.name=e,this.prefix=t;const i=t.codePointAt(0);if(i===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=i,this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return eK(this,e)}},Cwe=class{constructor(e){u(this,"decoders");this.decoders=e}or(e){return eK(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};function eK(r,e){return new Cwe({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}let Iwe=class{constructor(e,t,n,i){u(this,"name");u(this,"prefix");u(this,"baseEncode");u(this,"baseDecode");u(this,"encoder");u(this,"decoder");this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=i,this.encoder=new xwe(e,t,n),this.decoder=new Awe(e,t,i)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};function tK({name:r,prefix:e,encode:t,decode:n}){return new Iwe(r,e,t,n)}function Vw({name:r,prefix:e,alphabet:t}){const{encode:n,decode:i}=Swe(t,r);return tK({prefix:e,name:r,encode:n,decode:s=>_x(i(s))})}function kwe(r,e,t,n){const i={};for(let d=0;d<e.length;++d)i[e[d]]=d;let s=r.length;for(;r[s-1]==="=";)--s;const o=new Uint8Array(s*t/8|0);let a=0,c=0,l=0;for(let d=0;d<s;++d){const h=i[r[d]];if(h===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|h,a+=t,a>=8&&(a-=8,o[l++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o}function _we(r,e,t){const n=e[e.length-1]==="=",i=(1<<t)-1;let s="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,s+=e[i&a>>o];if(o!==0&&(s+=e[i&a<<t-o]),n)for(;s.length*t&7;)s+="=";return s}function sa({name:r,prefix:e,bitsPerChar:t,alphabet:n}){return tK({prefix:e,name:r,encode(i){return _we(i,n,t)},decode(i){return kwe(i,n,t,r)}})}const a2=sa({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});sa({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});sa({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});sa({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});sa({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});sa({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});sa({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});sa({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});sa({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const w8=Vw({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"});Vw({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});const La=Vw({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});Vw({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var Twe=rK,sP=128,Pwe=-128,Dwe=Math.pow(2,31);function rK(r,e,t){e=e||[],t=t||0;for(var n=t;r>=Dwe;)e[t++]=r&255|sP,r/=128;for(;r&Pwe;)e[t++]=r&255|sP,r>>>=7;return e[t]=r|0,rK.bytes=t-n+1,e}var $we=Vv,Nwe=128,oP=127;function Vv(r,n){var t=0,n=n||0,i=0,s=n,o,a=r.length;do{if(s>=a)throw Vv.bytes=0,new RangeError("Could not decode varint");o=r[s++],t+=i<28?(o&oP)<<i:(o&oP)*Math.pow(2,i),i+=7}while(o>=Nwe);return Vv.bytes=s-n,t}var Mwe=Math.pow(2,7),Owe=Math.pow(2,14),Rwe=Math.pow(2,21),Lwe=Math.pow(2,28),Bwe=Math.pow(2,35),Uwe=Math.pow(2,42),Fwe=Math.pow(2,49),zwe=Math.pow(2,56),Vwe=Math.pow(2,63),Kwe=function(r){return r<Mwe?1:r<Owe?2:r<Rwe?3:r<Lwe?4:r<Bwe?5:r<Uwe?6:r<Fwe?7:r<zwe?8:r<Vwe?9:10},jwe={encode:Twe,decode:$we,encodingLength:Kwe},vm=jwe;function Kv(r,e=0){return[vm.decode(r,e),vm.decode.bytes]}function Em(r,e,t=0){return vm.encode(r,e,t),e}function Sm(r){return vm.encodingLength(r)}function jv(r,e){const t=e.byteLength,n=Sm(r),i=n+Sm(t),s=new Uint8Array(i+t);return Em(r,s,0),Em(t,s,n),s.set(e,i),new Tx(r,t,e,s)}function Su(r){const e=_x(r),[t,n]=Kv(e),[i,s]=Kv(e.subarray(n)),o=e.subarray(n+s);if(o.byteLength!==i)throw new Error("Incorrect length");return new Tx(t,i,o,e)}function Hwe(r,e){if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&bwe(r.bytes,t.bytes)}}let Tx=class{constructor(e,t,n,i){u(this,"code");u(this,"size");u(this,"digest");u(this,"bytes");this.code=e,this.size=t,this.digest=n,this.bytes=i}};function aP(r,e){const{bytes:t,version:n}=r;switch(n){case 0:return Wwe(t,Hv(r),e??La.encoder);default:return Gwe(t,Hv(r),e??a2.encoder)}}const cP=new WeakMap;function Hv(r){const e=cP.get(r);if(e==null){const t=new Map;return cP.set(r,t),t}return e}var zN;let Px=class Wr{constructor(e,t,n,i){u(this,"code");u(this,"version");u(this,"multihash");u(this,"bytes");u(this,"/");u(this,zN,"CID");this.code=t,this.version=e,this.multihash=n,this.bytes=i,this["/"]=i}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==$f)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==Qwe)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return Wr.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=jv(e,t);return Wr.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return Wr.equals(this,e)}static equals(e,t){const n=t;return n!=null&&e.code===n.code&&e.version===n.version&&Hwe(e.multihash,n.multihash)}toString(e){return aP(this,e)}toJSON(){return{"/":aP(this)}}link(){return this}[(zN=Symbol.toStringTag,Symbol.for("nodejs.util.inspect.custom"))](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof Wr)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:i,multihash:s,bytes:o}=t;return new Wr(n,i,s,o??lP(n,i,s.bytes))}else if(t[Ywe]===!0){const{version:n,multihash:i,code:s}=t,o=Su(i);return Wr.create(n,s,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==$f)throw new Error(`Version 0 CID must use dag-pb (code: ${$f}) block encoding`);return new Wr(e,t,n,n.bytes)}case 1:{const i=lP(e,t,n.bytes);return new Wr(e,t,n,i)}default:throw new Error("Invalid version")}}static createV0(e){return Wr.create(0,$f,e)}static createV1(e,t){return Wr.create(1,e,t)}static decode(e){const[t,n]=Wr.decodeFirst(e);if(n.length!==0)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=Wr.inspectBytes(e),n=t.size-t.multihashSize,i=_x(e.subarray(n,n+t.multihashSize));if(i.byteLength!==t.multihashSize)throw new Error("Incorrect length");const s=i.subarray(t.multihashSize-t.digestSize),o=new Tx(t.multihashCode,t.digestSize,s,i);return[t.version===0?Wr.createV0(o):Wr.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[h,p]=Kv(e.subarray(t));return t+=p,h};let i=n(),s=$f;if(i===18?(i=0,t=0):s=n(),i!==0&&i!==1)throw new RangeError(`Invalid CID version ${i}`);const o=t,a=n(),c=n(),l=t+c,d=l-o;return{version:i,codec:s,multihashCode:a,digestSize:c,multihashSize:d,size:l}}static parse(e,t){const[n,i]=qwe(e,t),s=Wr.decode(i);if(s.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return Hv(s).set(n,e),s}};function qwe(r,e){switch(r[0]){case"Q":{const t=e??La;return[La.prefix,t.decode(`${La.prefix}${r}`)]}case La.prefix:{const t=e??La;return[La.prefix,t.decode(r)]}case a2.prefix:{const t=e??a2;return[a2.prefix,t.decode(r)]}case w8.prefix:{const t=e??w8;return[w8.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}}function Wwe(r,e,t){const{prefix:n}=t;if(n!==La.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const i=e.get(n);if(i==null){const s=t.encode(r).slice(1);return e.set(n,s),s}else return i}function Gwe(r,e,t){const{prefix:n}=t,i=e.get(n);if(i==null){const s=t.encode(r);return e.set(n,s),s}else return i}const $f=112,Qwe=18;function lP(r,e,t){const n=Sm(r),i=n+Sm(e),s=new Uint8Array(i+t.byteLength);return Em(r,s,0),Em(e,s,n),s.set(t,i),s}const Ywe=Symbol.for("@ipld/js-cid/CID"),Jwe=85;function Xwe({name:r,code:e,encode:t}){return new Zwe(r,e,t)}let Zwe=class{constructor(e,t,n){u(this,"name");u(this,"code");u(this,"encode");this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?jv(this.code,t):t.then(n=>jv(this.code,n))}else throw Error("Unknown type, must be binary type")}};function e4e(r){return async e=>new Uint8Array(await crypto.subtle.digest(r,e))}const nK=Xwe({name:"sha2-256",code:18,encode:e4e("SHA-256")}),t4e=oe("/pk/");function r4e(r){return{...r,multiaddrs:r.multiaddrs.filter(e=>{const[[t,n]]=e.stringTuples();if(t===53||t===54||t===55)return n!=="localhost";if(t!==4&&t!==6||n==null)return!1;const i=zc(n);return i==null?!0:!i})}}async function np(r){return(await nK.digest(r)).digest}async function ps(r){return np(r.toMultihash().bytes)}function u1(r,e){return new Et(`${r}/${re(e,"base32")}`,!1)}function n4e(r){return ir([t4e,r.toMultihash().bytes])}function i4e(r){return re(r.subarray(0,4))==="/pk/"}function s4e(r){const e=Su(r.subarray(4));return si(e)}function uP(r,e){const t=new Date;return new Di(r,e,t).serialize()}const o4e=290,a4e=54,c4e=55,l4e=56,u4e=4,d4e=41;function h4e(r){const e=r.stringTuples();for(const t of e)if(t[0]===o4e)return!1;if(e[0][0]===a4e||e[0][0]===c4e||e[0][0]===l4e)return!0;if(e[0][0]===u4e||e[0][0]===d4e){const t=zc(`${e[0][1]}`);return t==null||!t}return!1}function iK(r){const e=r.toString().split("/"),t=e.pop(),n=e.pop();if(t==null||n==null)throw new Error(`incorrectly formatted provider entry key in datastore: ${r.toString()}`);return{cid:Px.createV1(Jwe,Su(oe(n,"base32"))),peerId:Jt(t)}}function b8(r,e,t){const n=typeof e=="string"?e:re(e.multihash.bytes,"base32"),i=[r,n];return t!=null&&i.push(t.toString()),new Et(i.join("/"))}function sK(r){return new Date(gs(r))}function Fu(r,e,t){return async function*(...n){var a,c,l,d,h;const i=(a=e.queryTime)==null?void 0:a.timer(t),s=(c=e.errorTime)==null?void 0:c.timer(t);let o=!1;try{(l=e.queries)==null||l.increment({[t]:!0}),yield*r(...n)}catch(p){throw o=!0,s==null||s(),(d=e.errors)==null||d.increment({[t]:!0}),p}finally{(h=e.queries)==null||h.decrement({[t]:!0}),o||i==null||i()}}}function oK(r,e,t){return async function(...n){var a,c,l,d,h;const i=(a=e==null?void 0:e.queryTime)==null?void 0:a.timer(t),s=(c=e==null?void 0:e.errorTime)==null?void 0:c.timer(t);let o=!1;try{return(l=e.queries)==null||l.increment({[t]:!0}),await r(...n)}catch(p){throw o=!0,s==null||s(),(d=e.errors)==null||d.increment({[t]:!0}),p}finally{(h=e.queries)==null||h.decrement({[t]:!0}),o||i==null||i()}}}class f4e{constructor(e,t){u(this,"log");u(this,"components");u(this,"validators");u(this,"selectors");u(this,"peerRouting");u(this,"queryManager");u(this,"network");u(this,"datastorePrefix");var l,d;const{validators:n,selectors:i,peerRouting:s,queryManager:o,network:a,logPrefix:c}=t;this.components=e,this.log=e.logger.forComponent(`${c}:content-fetching`),this.datastorePrefix=`${t.datastorePrefix}/record`,this.validators=n,this.selectors=i,this.peerRouting=s,this.queryManager=o,this.network=a,this.get=((l=e.metrics)==null?void 0:l.traceFunction("libp2p.kadDHT.get",this.get.bind(this),{optionsIndex:1}))??this.get,this.put=((d=e.metrics)==null?void 0:d.traceFunction("libp2p.kadDHT.put",this.put.bind(this),{optionsIndex:2}))??this.put}async getLocal(e){this.log("getLocal %b",e);const t=u1(this.datastorePrefix,e);this.log("fetching record for key %k",t);const n=await this.components.datastore.get(t);this.log("found %k in local datastore",t);const i=Di.deserialize(n);return await kx(this.validators,i),i}async*sendCorrectionRecord(e,t,n,i={}){this.log("sendCorrection for %b",e);const s=uP(e,n);for(const{value:o,from:a}of t){if(He(o,n)){this.log("record was ok");continue}if(this.components.peerId.equals(a)){try{const d=u1(this.datastorePrefix,e);this.log(`Storing corrected record for key ${d.toString()}`),await this.components.datastore.put(d,s.subarray())}catch(d){this.log.error("Failed error correcting self",d)}continue}let c=!1;const l={type:At.PUT_VALUE,key:e,record:s};for await(const d of this.network.sendRequest(a,l,i))d.name==="PEER_RESPONSE"&&d.record!=null&&He(d.record.value,Di.deserialize(s).value)&&(c=!0),yield d;c||(yield Tc({from:a,error:new wm("Value not put correctly")},i)),this.log.error("Failed error correcting entry")}}async*put(e,t,n={}){this.log("put key %b value %b",e,t);const i=uP(e,t),s=u1(this.datastorePrefix,e);this.log(`storing record for key ${s.toString()}`),await this.components.datastore.put(s,i.subarray()),yield*hn(this.peerRouting.getClosestPeers(e,{...n,signal:n.signal}),o=>Mh(o,a=>async()=>{if(a.name!=="FINAL_PEER")return[a];const c=[],l={type:At.PUT_VALUE,key:e,record:i};this.log("send put to %p",a.peer.id);for await(const d of this.network.sendRequest(a.peer.id,l,n))c.push(d),d.name==="PEER_RESPONSE"&&(d.record!=null&&He(d.record.value,Di.deserialize(i).value)||c.push(Tc({from:a.peer.id,error:new wm("Value not put correctly")},n)));return c}),o=>Gp(o,{ordered:!1,concurrency:Ix}),async function*(o){for await(const a of o)yield*a})}async*get(e,t={}){this.log("get %b",e);const n=[];for await(const a of this.getMany(e,t))a.name==="VALUE"&&n.push(a),yield a;if(n.length===0)return;const i=n.map(a=>a.value);let s=0;try{s=pwe(this.selectors,e,i)}catch(a){if(a.name!=="InvalidParametersError")throw a}const o=i[s];if(this.log("GetValue %b %b",e,o),o==null)throw new Zt("Best value was not found");yield*this.sendCorrectionRecord(e,n,o,t),yield n[s]}async*getMany(e,t={}){this.log("getMany values for %b",e);try{const s=await this.getLocal(e);yield zv({value:s.value,from:this.components.peerId},t)}catch(s){this.log("error getting local value for %b",e,s)}const n=this,i=async function*({peer:s,signal:o}){for await(const a of n.peerRouting.getValueOrPeers(s,e,{...t,signal:o}))yield a,a.name==="PEER_RESPONSE"&&a.record!=null&&(yield zv({from:s,value:a.record.value},t))};yield*this.queryManager.run(e,i,t)}}function p4e(r,e){return{id:r.id.toMultihash().bytes,multiaddrs:(r.multiaddrs??[]).map(n=>n.bytes),connection:e}}function fg(r){if(r.id==null)throw new Error("Invalid peer in message");const e=Su(r.id);return{id:si(e),multiaddrs:(r.multiaddrs??[]).map(t=>Re(t))}}class g4e{constructor(e,t){u(this,"log");u(this,"components");u(this,"network");u(this,"peerRouting");u(this,"queryManager");u(this,"routingTable");u(this,"providers");var l,d;const{network:n,peerRouting:i,queryManager:s,routingTable:o,providers:a,logPrefix:c}=t;this.components=e,this.log=e.logger.forComponent(`${c}:content-routing`),this.network=n,this.peerRouting=i,this.queryManager=s,this.routingTable=o,this.providers=a,this.findProviders=((l=e.metrics)==null?void 0:l.traceFunction("libp2p.kadDHT.findProviders",this.findProviders.bind(this),{optionsIndex:1,getAttributesFromYieldedValue:(h,p)=>(h.name==="PROVIDER"&&(p.providers??(p.providers=[]),p.providers.push(...h.providers.map(m=>m.id.toString()))),p)}))??this.findProviders,this.provide=((d=e.metrics)==null?void 0:d.traceFunction("libp2p.kadDHT.provide",this.provide.bind(this),{optionsIndex:1,getAttributesFromYieldedValue:(h,p)=>(h.name==="PEER_RESPONSE"&&h.messageName==="ADD_PROVIDER"&&(p.providers??(p.providers=[]),p.providers.push(h.from.toString())),p)}))??this.provide}async*provide(e,t,n={}){this.log("provide %s",e);const i=e.multihash.bytes;await this.providers.addProvider(e,this.components.peerId);const s={type:At.ADD_PROVIDER,key:i,providers:[p4e({id:this.components.peerId,multiaddrs:t})]};let o=0;const a=c=>async()=>{if(c.name!=="FINAL_PEER")return[c];const l=[];this.log("putProvider %s to %p",e,c.peer.id);try{this.log("sending provider record for %s to %p",e,c.peer.id);for await(const d of this.network.sendMessage(c.peer.id,s,n))d.name==="PEER_RESPONSE"&&(this.log("sent provider record for %s to %p",e,c.peer.id),o++),l.push(d)}catch(d){this.log.error("error sending provide record to peer %p",c.peer.id,d),l.push(Tc({from:c.peer.id,error:d},n))}return l};yield*hn(this.peerRouting.getClosestPeers(i,n),c=>Mh(c,l=>a(l)),c=>Gp(c,{ordered:!1,concurrency:Ix}),async function*(c){for await(const l of c)yield*l}),this.log("sent provider records to %d peers",o)}async*findProviders(e,t){const n=this.routingTable.kBucketSize;let i=0;const s=e.multihash.bytes,o=this;this.log("findProviders %c",e);const a=await this.providers.getProviders(e);if(a.length>0){const d=[];for(const h of a.slice(0,n))try{const p=await this.components.peerStore.get(h);d.push({id:h,multiaddrs:p.addresses.map(({multiaddr:m})=>m)})}catch(p){if(p.name!=="NotFoundError")throw p;this.log("no peer store entry for %p",h)}if(yield Fv({from:this.components.peerId,messageType:At.GET_PROVIDERS,providers:d},t),yield nP({from:this.components.peerId,providers:d},t),i+=d.length,i>=n)return}const c=async function*({peer:d,signal:h}){const p={type:At.GET_PROVIDERS,key:s};yield*o.network.sendRequest(d,p,{...t,signal:h})},l=new cs(a);for await(const d of this.queryManager.run(s,c,t))if(yield d,d.name==="PEER_RESPONSE"){this.log("Found %d provider entries for %c and %d closer peers",d.providers.length,e,d.closer.length);const h=[];for(const p of d.providers)l.has(p.id)||(l.add(p.id),h.push(p));if(h.length>0&&(yield nP({from:d.from,providers:h},t),i+=h.length,i>=n))return}}}class v8{constructor(e){u(this,"movingAverage");u(this,"variance");u(this,"deviation");u(this,"forecast");u(this,"timeSpan");u(this,"previousTime");this.timeSpan=e,this.movingAverage=0,this.variance=0,this.deviation=0,this.forecast=0}alpha(e,t){return 1-Math.exp(-(e-t)/this.timeSpan)}push(e,t=Date.now()){if(this.previousTime!=null){const n=this.alpha(t,this.previousTime),i=e-this.movingAverage,s=n*i;this.movingAverage=n*e+(1-n)*this.movingAverage,this.variance=(1-n)*(this.variance+i*s),this.deviation=Math.sqrt(this.variance),this.forecast=this.movingAverage+n*i}else this.movingAverage=e;this.previousTime=t}}const y4e=1.2,m4e=2,w4e=2e3;class ip{constructor(e={}){u(this,"success");u(this,"failure");u(this,"next");u(this,"metric");u(this,"timeoutMultiplier");u(this,"failureMultiplier");u(this,"minTimeout");var t;this.success=new v8(e.interval??5e3),this.failure=new v8(e.interval??5e3),this.next=new v8(e.interval??5e3),this.failureMultiplier=e.failureMultiplier??m4e,this.timeoutMultiplier=e.timeoutMultiplier??y4e,this.minTimeout=e.minTimeout??w4e,e.metricName!=null&&(this.metric=(t=e.metrics)==null?void 0:t.registerMetricGroup(e.metricName))}getTimeoutSignal(e={}){const t=Math.max(Math.round(this.next.movingAverage*(e.timeoutFactor??this.timeoutMultiplier)),this.minTimeout),n=AbortSignal.timeout(t),i=dt([e.signal,n]);return i.start=Date.now(),i.timeout=t,i}cleanUp(e){var n,i;const t=Date.now()-e.start;e.aborted?(this.failure.push(t),this.next.push(t*this.failureMultiplier),(n=this.metric)==null||n.update({failureMovingAverage:this.failure.movingAverage,failureDeviation:this.failure.deviation,failureForecast:this.failure.forecast,failureVariance:this.failure.variance,failure:t})):(this.success.push(t),this.next.push(t),(i=this.metric)==null||i.update({successMovingAverage:this.success.movingAverage,successDeviation:this.success.deviation,successForecast:this.success.forecast,successVariance:this.success.variance,success:t}))}}class b4e{constructor(){u(this,"readNext");u(this,"haveNext");u(this,"ended");u(this,"nextResult");this.ended=!1,this.readNext=Le(),this.haveNext=Le()}[Symbol.asyncIterator](){return this}async next(){if(this.nextResult==null&&await this.haveNext.promise,this.nextResult==null)throw new Error("HaveNext promise resolved but nextResult was undefined");const e=this.nextResult;return this.nextResult=void 0,this.readNext.resolve(),this.readNext=Le(),e}async throw(e){return this.ended=!0,e!=null&&(this.haveNext.promise.catch(()=>{}),this.haveNext.reject(e)),{done:!0,value:void 0}}async return(){const e={done:!0,value:void 0};return this.ended=!0,this.nextResult=e,this.haveNext.resolve(),e}async push(e,t){await this._push(e,t)}async end(e,t){e!=null?await this.throw(e):await this._push(void 0,t)}async _push(e,t){if(e!=null&&this.ended)throw new Error("Cannot push value onto an ended pushable");for(;this.nextResult!=null;)await this.readNext.promise;e!=null?this.nextResult={done:!1,value:e}:(this.ended=!0,this.nextResult={done:!0,value:void 0}),this.haveNext.resolve(),this.haveNext=Le(),await cn(this.readNext.promise,t==null?void 0:t.signal,t)}}function v4e(){return new b4e}let E4e=class extends Error{constructor(){super(...arguments);u(this,"name","UnexpectedEOFError");u(this,"code","ERR_UNEXPECTED_EOF")}};class S4e extends Error{constructor(t,n){super(t);u(this,"code");this.code=n}}let x4e=class extends S4e{constructor(t){super(t,"ABORT_ERR");u(this,"type");this.type="aborted",this.name="AbortError"}};function A4e(r,e){const t=v4e();r.sink(t).catch(async o=>{await t.end(o)}),r.sink=async o=>{for await(const a of o)await t.push(a);await t.end()};let n=r.source;r.source[Symbol.iterator]!=null?n=r.source[Symbol.iterator]():r.source[Symbol.asyncIterator]!=null&&(n=r.source[Symbol.asyncIterator]());const i=new Ue;return{read:async(o,a)=>{var d,h;(d=a==null?void 0:a.signal)==null||d.throwIfAborted();let c;const l=new Promise((p,m)=>{var f;c=()=>{m(new x4e("Read aborted"))},(f=a==null?void 0:a.signal)==null||f.addEventListener("abort",c)});try{if(o==null){const{done:m,value:f}=await Promise.race([n.next(),l]);return m===!0?new Ue:f}for(;i.byteLength<o;){const{value:m,done:f}=await Promise.race([n.next(),l]);if(f===!0)throw new E4e("unexpected end of input");i.append(m)}const p=i.sublist(0,o);return i.consume(o),p}finally{c!=null&&((h=a==null?void 0:a.signal)==null||h.removeEventListener("abort",c))}},write:async(o,a)=>{var c;(c=a==null?void 0:a.signal)==null||c.throwIfAborted(),o instanceof Uint8Array?await t.push(o,a):await t.push(o.subarray(),a)},unwrap:()=>{if(i.byteLength>0){const o=r.source;r.source=async function*(){(e==null?void 0:e.yieldBytes)===!1?yield i:yield*i,yield*o}()}return r}}}let C4e=class extends Error{constructor(){super(...arguments);u(this,"name","InvalidMessageLengthError");u(this,"code","ERR_INVALID_MSG_LENGTH")}},I4e=class extends Error{constructor(){super(...arguments);u(this,"name","InvalidDataLengthError");u(this,"code","ERR_MSG_DATA_TOO_LONG")}},k4e=class extends Error{constructor(){super(...arguments);u(this,"name","InvalidDataLengthLengthError");u(this,"code","ERR_MSG_LENGTH_TOO_LONG")}};function _4e(r,e={}){const t=A4e(r,e);e.maxDataLength!=null&&e.maxLengthLength==null&&(e.maxLengthLength=gt(e.maxDataLength));const n=(e==null?void 0:e.lengthDecoder)??gs,i=(e==null?void 0:e.lengthEncoder)??xr;return{read:async o=>{let a=-1;const c=new Ue;for(;;){c.append(await t.read(1,o));try{a=n(c)}catch(l){if(l instanceof RangeError)continue;throw l}if(a<0)throw new C4e("Invalid message length");if((e==null?void 0:e.maxLengthLength)!=null&&c.byteLength>e.maxLengthLength)throw new k4e("message length length too long");if(a>-1)break}if((e==null?void 0:e.maxDataLength)!=null&&a>e.maxDataLength)throw new I4e("message length too long");return t.read(a,o)},write:async(o,a)=>{await t.write(new Ue(i(o.byteLength),o),a)},writeV:async(o,a)=>{const c=new Ue(...o.flatMap(l=>[i(l.byteLength),l]));await t.write(c,a)},unwrap:()=>t.unwrap()}}function dP(r,e){const t=_4e(r,e),n={read:async(i,s)=>{const o=await t.read(s);return i.decode(o)},write:async(i,s,o)=>{await t.write(s.encode(i),o)},writeV:async(i,s,o)=>{await t.writeV(i.map(a=>s.encode(a)),o)},pb:i=>({read:async s=>n.read(i,s),write:async(s,o)=>n.write(s,i,o),writeV:async(s,o)=>n.writeV(s,i,o),unwrap:()=>n}),unwrap:()=>t.unwrap()};return n}class T4e extends er{constructor(t,n){var i,s,o,a;super();u(this,"log");u(this,"protocol");u(this,"running");u(this,"components");u(this,"timeout");u(this,"metrics");this.components=t,this.log=t.logger.forComponent(`${n.logPrefix}:network`),this.running=!1,this.protocol=n.protocol,this.timeout=new ip({...n.timeout??{},metrics:t.metrics,metricName:`${n.metricsPrefix}_network_message_send_times_milliseconds`}),this.metrics={operations:(i=t.metrics)==null?void 0:i.registerCounterGroup(`${n.metricsPrefix}_outbound_rpc_requests_total`),errors:(s=t.metrics)==null?void 0:s.registerCounterGroup(`${n.metricsPrefix}_outbound_rpc_errors_total`)},this.sendRequest=((o=t.metrics)==null?void 0:o.traceFunction("libp2p.kadDHT.sendRequest",this.sendRequest.bind(this),{optionsIndex:2,getAttributesFromArgs([c,l],d){return{...d,to:c.toString(),"message type":`${l.type}`}},getAttributesFromYieldedValue:(c,l)=>(c.name==="PEER_RESPONSE"&&(c.providers.length>0&&c.providers.forEach((d,h)=>{l[`providers-${h}`]=d.id.toString()}),c.closer.length>0&&c.closer.forEach((d,h)=>{l[`closer-${h}`]=d.id.toString()})),l)}))??this.sendRequest,this.sendMessage=((a=t.metrics)==null?void 0:a.traceFunction("libp2p.kadDHT.sendMessage",this.sendMessage.bind(this),{optionsIndex:2,getAttributesFromArgs([c,l],d){return{...d,to:c.toString(),"message type":`${l.type}`}},getAttributesFromYieldedValue:(c,l)=>(c.name==="PEER_RESPONSE"&&(c.providers.length>0&&c.providers.forEach((d,h)=>{l[`providers-${h}`]=d.id.toString()}),c.closer.length>0&&c.closer.forEach((d,h)=>{l[`closer-${h}`]=d.id.toString()})),l)}))??this.sendMessage}async start(){this.running||(this.running=!0)}async stop(){this.running=!1}isStarted(){return this.running}async*sendRequest(t,n,i={}){var c,l,d;if(!this.running)return;const s=n.type;if(s==null)throw new Z("Message type was missing");this.log("sending %s to %p",n.type,t),yield iP({peer:t},i),yield rP({to:t,type:s},i);let o;const a=this.timeout.getTimeoutSignal(i);i={...i,signal:a};try{(c=this.metrics.operations)==null||c.increment({[s]:!0}),o=await(await this.components.connectionManager.openConnection(t,i)).newStream(this.protocol,i);const p=await this._writeReadMessage(o,n,i);o.close(i).catch(m=>{this.log.error("error closing stream to %p",t,m),o==null||o.abort(m)}),yield Fv({from:t,messageType:p.type,closer:p.closer.map(fg),providers:p.providers.map(fg),record:p.record==null?void 0:Di.deserialize(p.record)},i)}catch(h){(l=this.metrics.errors)==null||l.increment({[s]:!0}),o==null||o.abort(h),((d=i.signal)==null?void 0:d.aborted)!==!0&&this.log.error("could not send %s to %p - %e",n.type,t,h),yield Tc({from:t,error:h},i)}finally{this.timeout.cleanUp(a)}}async*sendMessage(t,n,i={}){var c,l;if(!this.running)return;const s=n.type;if(s==null)throw new Z("Message type was missing");this.log("sending %s to %p",n.type,t),yield iP({peer:t},i),yield rP({to:t,type:s},i);let o;const a=this.timeout.getTimeoutSignal(i);i={...i,signal:a};try{(c=this.metrics.operations)==null||c.increment({[s]:!0}),o=await(await this.components.connectionManager.openConnection(t,i)).newStream(this.protocol,i),await this._writeMessage(o,n,i),o.close(i).catch(h=>{this.log.error("error closing stream to %p",t,h),o==null||o.abort(h)}),yield Fv({from:t,messageType:s},i)}catch(d){(l=this.metrics.errors)==null||l.increment({[s]:!0}),o==null||o.abort(d),yield Tc({from:t,error:d},i)}finally{this.timeout.cleanUp(a)}}async _writeMessage(t,n,i){await dP(t).write(n,Ol,i)}async _writeReadMessage(t,n,i){const s=dP(t);await s.write(n,Ol,i);const o=await s.read(Ol,i);return o.closer.forEach(a=>{this.safeDispatchEvent("peer",{detail:fg(a)})}),o.providers.forEach(a=>{this.safeDispatchEvent("peer",{detail:fg(a)})}),o}}function sp(r,e){if(r.byteLength!==e.byteLength)throw new Error("Inputs should have the same length");for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return r[t]<e[t]?-1:1;return 0}class Dx{constructor(e,t){u(this,"originDhtKey");u(this,"capacity");u(this,"peerDistances");this.originDhtKey=e,this.capacity=t,this.peerDistances=[]}get length(){return this.peerDistances.length}get peers(){return this.peerDistances.map(e=>e.peer)}async add(e){const t=await ps(e.id);this.addWithKadId(e,t)}addWithKadId(e,t){if(this.peerDistances.find(s=>s.peer.id.equals(e.id))!=null)return;const n={peer:e,distance:kc(this.originDhtKey,t)};let i=!1;for(let s=0;s<this.peerDistances.length;s++){const o=sp(this.peerDistances[s].distance,n.distance);if(o===0||o===1){i=!0,this.peerDistances.splice(s,0,n);break}}i||this.peerDistances.push(n),this.peerDistances=this.peerDistances.slice(0,this.capacity)}async isCloser(e){if(this.length===0)return!0;const t=await ps(e),n=kc(t,this.originDhtKey),i=this.peerDistances[this.peerDistances.length-1].distance;return sp(n,i)===-1}async anyCloser(e){return e.length===0?!1:Promise.any(e.map(async t=>this.isCloser(t)))}}class P4e{constructor(e,t){u(this,"log");u(this,"routingTable");u(this,"network");u(this,"validators");u(this,"queryManager");u(this,"peerStore");u(this,"peerId");var n,i;this.routingTable=t.routingTable,this.network=t.network,this.validators=t.validators,this.queryManager=t.queryManager,this.peerStore=e.peerStore,this.peerId=e.peerId,this.log=e.logger.forComponent(`${t.logPrefix}:peer-routing`),this.findPeer=((n=e.metrics)==null?void 0:n.traceFunction("libp2p.kadDHT.findPeer",this.findPeer.bind(this),{optionsIndex:1}))??this.findPeer,this.getClosestPeers=((i=e.metrics)==null?void 0:i.traceFunction("libp2p.kadDHT.getClosestPeers",this.getClosestPeers.bind(this),{optionsIndex:1}))??this.getClosestPeers}async findPeerLocal(e){let t;const n=await this.routingTable.find(e);if(n!=null){this.log("findPeerLocal found %p in routing table",e);try{t=await this.peerStore.get(n)}catch(i){if(i.name!=="NotFoundError")throw i}}if(t==null)try{t=await this.peerStore.get(e)}catch(i){if(i.name!=="NotFoundError")throw i}if(t!=null)return this.log("findPeerLocal found %p in peer store",e),{id:t.id,multiaddrs:t.addresses.map(i=>i.multiaddr)}}async*_getValueSingle(e,t,n={}){const i={type:At.GET_VALUE,key:t};yield*this.network.sendRequest(e,i,n)}async*getPublicKeyFromNode(e,t={}){const n=n4e(e);for await(const i of this._getValueSingle(e,n,t))if(yield i,i.name==="PEER_RESPONSE"&&i.record!=null){const s=Rn(i.record.value),o=Jd(s);if(!o.equals(e))throw new F1("public key does not match id");if(o.publicKey==null)throw new F1("public key missing");yield zv({from:e,value:i.record.value},t)}throw new wm(`Node not responding with its public key: ${e.toString()}`)}async*findPeer(e,t={}){if(this.log("findPeer %p",e),t.useCache!==!1){const i=await this.findPeerLocal(e);if(i!=null){this.log("found local"),yield m8({from:this.peerId,peer:i},t);return}}let n=!1;if(t.useNetwork!==!1){const i=this,s=async function*({peer:o,signal:a}){const c={type:At.FIND_NODE,key:e.toMultihash().bytes};for await(const l of i.network.sendRequest(o,c,{...t,signal:a}))if(yield l,l.name==="PEER_RESPONSE"){const d=l.closer.find(h=>h.id.equals(e));d!=null&&(yield m8({from:l.from,peer:d},t))}};for await(const o of this.queryManager.run(e.toMultihash().bytes,s,t))o.name==="FINAL_PEER"&&(n=!0),yield o}n||(yield Tc({from:this.peerId,error:new Zt("Not found")},t))}async*getClosestPeers(e,t={}){this.log("getClosestPeers to %b",e);const n=await np(e),i=this.routingTable.closestPeers(n),s=this,o=new Dx(n,this.routingTable.kBucketSize);await Promise.all(i.map(async c=>{await o.add({id:c,multiaddrs:[]})}));const a=async function*({peer:c,signal:l}){s.log("closerPeersSingle %s from %p",re(e,"base32"),c);const d={type:At.FIND_NODE,key:e};yield*s.network.sendRequest(c,d,{...t,signal:l})};for await(const c of this.queryManager.run(e,a,t))c.name==="PEER_RESPONSE"&&await Promise.all(c.closer.map(async l=>{await o.add(l)})),yield c;this.log("found %d peers close to %b",o.length,e);for(const c of o.peers)yield m8({from:this.peerId,peer:c},t)}async*getValueOrPeers(e,t,n={}){for await(const i of this._getValueSingle(e,t,n)){if(i.name==="PEER_RESPONSE"&&i.record!=null)try{await this._verifyRecordOnline(i.record)}catch{const o="invalid record received, discarded";this.log(o),yield Tc({from:i.from,error:new wm(o)},n);continue}yield i}}async _verifyRecordOnline(e){if(e.timeReceived==null)throw new hwe("invalid record received");await kx(this.validators,new Di(e.key,e.value,e.timeReceived))}async getCloserPeersOffline(e,t){const n=[];try{const c=Su(e),l=si(c),d=await this.peerStore.get(l);n.push({id:d.id,multiaddrs:d.addresses.map(({multiaddr:h})=>h)})}catch{}const i=await np(e),s=this.routingTable.closestPeers(i),o=await ps(t),a=kc(o,i);for(const c of s){const l=await ps(c),d=kc(l,i);if(sp(d,a)===-1)try{const h=await this.peerStore.get(c);n.push({id:c,multiaddrs:h.addresses.map(({multiaddr:p})=>p)})}catch(h){if(h.name!=="NotFoundError")throw h}}return n.length>0?this.log("getCloserPeersOffline found %d peer(s) closer to %b than %p",n.length,e,t):this.log("getCloserPeersOffline could not find peer closer to %b than %p with %d peers in the routing table",e,t,this.routingTable.size),n}}class D4e{constructor(e,t){u(this,"log");u(this,"datastore");u(this,"datastorePrefix");u(this,"lock");this.log=e.logger.forComponent(`${t.logPrefix}:providers`),this.datastorePrefix=`${t.datastorePrefix}/provider`,this.datastore=e.datastore,this.lock=t.lock}async addProvider(e,t){const n=await this.lock.readLock();try{this.log("%p provides %s",t,e),await this.writeProviderEntry(e,t)}finally{n()}}async removeProvider(e,t){const n=await this.lock.writeLock();try{const i=b8(this.datastorePrefix,e,t);this.log("%p no longer provides %s",t,e),await this.datastore.delete(i)}finally{n()}}async getProviders(e){const t=await this.lock.readLock();try{this.log("get providers for %c",e);const n=await this.loadProviders(e);return this.log("got %d providers for %c",n.size,e),[...n.keys()]}finally{t()}}async writeProviderEntry(e,t,n=new Date){const i=b8(this.datastorePrefix,e,t),s=xr(n.getTime());await this.datastore.put(i,s)}async loadProviders(e){const t=new Fc,n=b8(this.datastorePrefix,e);for await(const i of this.datastore.query({prefix:n.toString()})){const{peerId:s}=iK(i.key);t.set(s,sK(i.value))}return t}}async function*$4e(r){const{key:e,startingPeer:t,ourPeerId:n,signal:i,query:s,alpha:o,pathIndex:a,numPaths:c,queryFuncTimeout:l,log:d,peersSeen:h,connectionManager:p}=r,m=new Gl({concurrency:o,sort:(v,y)=>sp(v.options.distance,y.options.distance)}),f=await np(e);function g(v,y){if(v==null)return;h.add(v);const w=kc(y,f);m.add(async()=>{const b=[i];l!=null&&b.push(AbortSignal.timeout(l));const E=dt(b);try{for await(const A of s({...r,key:e,peer:v,signal:E,pathIndex:a,numPaths:c})){if(E.aborted)return;if(A.name==="PEER_RESPONSE")for(const k of A.closer){if(h.has(k.id)){d.trace("already seen %p in query",k.id);continue}if(n.equals(k.id)){d("not querying ourselves");continue}if(!await p.isDialable(k.multiaddrs)){d("not querying undialable peer");continue}const x=await ps(k.id),I=kc(x,f);if(sp(I,w)!==-1){d.trace("skipping %p as they are not closer to %b than %p",k.id,e,v);continue}d.trace("querying closer peer %p",k.id),g(k.id,x)}m.safeDispatchEvent("completed",{detail:A})}}catch(A){if(!i.aborted)return Tc({from:v,error:A},r)}finally{E.clear()}},{distance:w}).catch(b=>{d.error(b)})}g(t,await ps(t));try{for await(const v of m.toGenerator({signal:i}))v!=null&&(yield v)}catch(v){throw i.aborted?new dwe("Query aborted"):v}}class N4e{constructor(e,t){u(this,"disjointPaths");u(this,"alpha");u(this,"shutDownController");u(this,"running");u(this,"logger");u(this,"peerId");u(this,"connectionManager");u(this,"routingTable");u(this,"initialQuerySelfHasRun");u(this,"logPrefix");this.logPrefix=t.logPrefix,this.disjointPaths=t.disjointPaths??ZV,this.alpha=t.alpha??Ix,this.initialQuerySelfHasRun=t.initialQuerySelfHasRun,this.routingTable=t.routingTable,this.logger=e.logger,this.peerId=e.peerId,this.connectionManager=e.connectionManager,this.shutDownController=new AbortController,this.shutDownController.signal,this.running=!1}isStarted(){return this.running}async start(){this.running||(this.running=!0,this.shutDownController=new AbortController,this.shutDownController.signal,void 0)}async stop(){this.running=!1,this.shutDownController.abort()}async*run(e,t,n={}){if(!this.running)throw new Error("QueryManager not started");if(n.signal==null){const c=AbortSignal.timeout(cwe);n={...n,signal:c}}const i=new AbortController,s=dt([this.shutDownController.signal,i.signal,n.signal]);i.signal;const o=this.logger.forComponent(`${this.logPrefix}:query:`+re(e,"base58btc"));let a=!1;try{n.isSelfQuery!==!0&&this.initialQuerySelfHasRun!=null&&(o("waiting for initial query-self query before continuing"),await cn(this.initialQuerySelfHasRun.promise,s),this.initialQuerySelfHasRun=void 0),o("query:start");const c=await np(e),l=this.routingTable.closestPeers(c),d=l.slice(0,Math.min(this.disjointPaths,l.length));if(l.length===0){o.error("Running query with no peers");return}const h=new cs,p=d.map((m,f)=>$4e({...n,key:e,startingPeer:m,ourPeerId:this.peerId,signal:s,query:t,pathIndex:f,numPaths:d.length,alpha:this.alpha,queryFuncTimeout:n.queryFuncTimeout,log:o,peersSeen:h,onProgress:n.onProgress,connectionManager:this.connectionManager}));for await(const m of cc(...p)){if(m.name==="QUERY_ERROR"&&o.error("query error",m.error),m.name==="PEER_RESPONSE")for(const f of[...m.closer,...m.providers])await this.connectionManager.isDialable(f.multiaddrs)&&await this.routingTable.add(f.id);yield m}a=!0}catch(c){if(!(!this.running&&c.name==="QueryAbortedError"))throw c}finally{a||(o("query exited early"),i.abort()),s.clear(),o("query:done")}}}function M4e(r){return r[Symbol.asyncIterator]!=null}function aK(r){if(M4e(r))return(async()=>{let e=0;for await(const t of r)e++;return e})();{let e=0;for(const t of r)e++;return e}}const O4e=r=>{const e=r.addEventListener||r.on||r.addListener,t=r.removeEventListener||r.off||r.removeListener;if(!e||!t)throw new TypeError("Emitter is not compatible");return{addListener:e.bind(r),removeListener:t.bind(r)}};function R4e(r,e,t){let n;const i=new Promise((s,o)=>{var m;if(t={rejectionEvents:["error"],multiArgs:!1,resolveImmediately:!1,...t},!(t.count>=0&&(t.count===Number.POSITIVE_INFINITY||Number.isInteger(t.count))))throw new TypeError("The `count` option should be at least 0 or more");(m=t.signal)==null||m.throwIfAborted();const a=[e].flat(),c=[],{addListener:l,removeListener:d}=O4e(r),h=(...f)=>{const g=t.multiArgs?f:f[0];t.filter&&!t.filter(g)||(c.push(g),t.count===c.length&&(n(),s(c)))},p=f=>{n(),o(f)};n=()=>{for(const f of a)d(f,h);for(const f of t.rejectionEvents)d(f,p)};for(const f of a)l(f,h);for(const f of t.rejectionEvents)l(f,p);t.signal&&t.signal.addEventListener("abort",()=>{p(t.signal.reason)},{once:!0}),t.resolveImmediately&&s(c)});if(i.cancel=n,typeof t.timeout=="number"){const s=Pp(i,{milliseconds:t.timeout});return s.cancel=n,s}return i}function L4e(r,e,t){typeof t=="function"&&(t={filter:t}),t={...t,count:1,resolveImmediately:!1};const n=R4e(r,e,t),i=n.then(s=>s[0]);return i.cancel=n.cancel,i}class B4e{constructor(e,t){u(this,"log");u(this,"peerId");u(this,"peerRouting");u(this,"routingTable");u(this,"count");u(this,"interval");u(this,"initialInterval");u(this,"queryTimeout");u(this,"running");u(this,"timeoutId");u(this,"controller");u(this,"initialQuerySelfHasRun");u(this,"querySelfPromise");this.peerId=e.peerId,this.log=e.logger.forComponent(`${t.logPrefix}:query-self`),this.running=!1,this.peerRouting=t.peerRouting,this.routingTable=t.routingTable,this.count=t.count??ZV,this.interval=t.interval??nwe,this.initialInterval=t.initialInterval??iwe,this.queryTimeout=t.queryTimeout??swe,this.initialQuerySelfHasRun=t.initialQuerySelfHasRun,this.querySelf=oK(this.querySelf.bind(this),t.operationMetrics,"SELF_QUERY")}isStarted(){return this.running}start(){this.running||(this.running=!0,clearTimeout(this.timeoutId),this.timeoutId=setTimeout(()=>{this.querySelf().catch(e=>{this.log.error("error running self-query",e)})},this.initialInterval))}stop(){this.running=!1,this.timeoutId!=null&&clearTimeout(this.timeoutId),this.controller!=null&&this.controller.abort()}async querySelf(){if(!this.running){this.log("skip self-query because we are not started");return}if(this.querySelfPromise!=null)return this.log("joining existing self query"),this.querySelfPromise.promise;if(this.querySelfPromise=Le(),this.running){this.controller=new AbortController;const e=[this.controller.signal];if(this.initialQuerySelfHasRun==null){const n=AbortSignal.timeout(this.queryTimeout);e.push(n)}const t=dt(e);this.controller.signal;try{this.routingTable.size===0&&(this.log("routing table was empty, waiting for some peers before running query"),await L4e(this.routingTable,"peer:add",{signal:t,filter:s=>!this.peerId.equals(s.detail)}),this.log("routing table has peers, continuing with query")),this.log("run self-query, look for %d peers timing out after %dms",this.count,this.queryTimeout);const n=Date.now(),i=await hn(this.peerRouting.getClosestPeers(this.peerId.toMultihash().bytes,{signal:t,isSelfQuery:!0}),s=>py(s,this.count),async s=>aK(s));this.log("self-query found %d peers in %dms",i,Date.now()-n)}catch(n){this.log.error("self-query error",n)}finally{t.clear(),this.initialQuerySelfHasRun!=null&&(this.initialQuerySelfHasRun.resolve(),this.initialQuerySelfHasRun=void 0)}}this.querySelfPromise.resolve(),this.querySelfPromise=void 0,this.running&&(this.timeoutId=setTimeout(()=>{this.querySelf().catch(e=>{this.log.error("error running self-query",e)})},this.interval))}}class U4e extends er{constructor(t,n){super();u(this,"log");u(this,"reprovideQueue");u(this,"maxQueueSize");u(this,"datastore");u(this,"timeout");u(this,"reprovideTimeout");u(this,"running");u(this,"shutdownController");u(this,"reprovideThreshold");u(this,"contentRouting");u(this,"datastorePrefix");u(this,"addressManager");u(this,"validity");u(this,"interval");u(this,"lock");u(this,"peerId");this.log=t.logger.forComponent(`${n.logPrefix}:reprovider`),this.peerId=t.peerId,this.reprovideQueue=new Gl({concurrency:n.concurrency??ewe,metrics:t.metrics,metricName:`${n.metricsPrefix}_reprovide_queue`}),this.reprovideTimeout=new ip({...n.timeout??{},metrics:t.metrics,metricName:`${n.metricsPrefix}_reprovide_timeout_milliseconds`}),this.datastore=t.datastore,this.addressManager=t.addressManager,this.datastorePrefix=`${n.datastorePrefix}/provider`,this.reprovideThreshold=n.threshold??Z3e,this.maxQueueSize=n.maxQueueSize??twe,this.validity=n.validity??X3e,this.interval=n.interval??rwe,this.contentRouting=n.contentRouting,this.lock=n.lock,this.running=!1,this.reprovide=oK(this.reprovide.bind(this),n.operationMetrics,"PROVIDE")}start(){this.running||(this.running=!0,this.shutdownController=new AbortController,this.shutdownController.signal,this.timeout=setTimeout(()=>{this.cleanUp().catch(t=>{this.log.error("error running reprovide/cleanup - %e",t)})},this.interval))}stop(){var t;this.running=!1,this.reprovideQueue.clear(),clearTimeout(this.timeout),(t=this.shutdownController)==null||t.abort()}async cleanUp(){const t=await this.lock.writeLock();try{this.safeDispatchEvent("reprovide:start");for await(const n of this.datastore.query({prefix:this.datastorePrefix}))try{const{cid:i,peerId:s}=iK(n.key),o=sK(n.value).getTime(),a=o+this.validity,c=Date.now(),l=c>a;this.log.trace("comparing: %d < %d = %s %s",o,c-this.validity,l,l?"(expired)":""),l&&await this.datastore.delete(n.key),this.peerId.equals(s)&&c-a<this.reprovideThreshold&&this.queueReprovide(i).catch(d=>{this.log.error("could not reprovide %c - %e",i,d)})}catch(i){this.log.error("error processing datastore key %s - %e",n.key,i.message)}this.log("reprovide/cleanup successful")}finally{t(),this.safeDispatchEvent("reprovide:end"),this.running&&(this.timeout=setTimeout(()=>{this.cleanUp().catch(n=>{this.log.error("error running re-provide - %e",n)})},this.interval))}}async queueReprovide(t){var i;if(!this.running)return;this.log.trace("waiting for queue capacity before adding %c to re-provide queue",t),await this.reprovideQueue.onSizeLessThan(this.maxQueueSize);const n=this.reprovideQueue.queue.find(s=>s.options.cid.equals(t));if(n!=null)return this.log.trace("not adding %c to re-provide queue - already in queue",t),n.join();this.log.trace("adding %c to re-provide queue",t),this.reprovideQueue.add(async s=>{var a;if((a=s.signal)==null||a.throwIfAborted(),!this.running)return;this.log.trace("re-providing %c",t);const o=this.reprovideTimeout.getTimeoutSignal(s);try{await this.reprovide(s.cid,s)}finally{this.reprovideTimeout.cleanUp(o)}this.log.trace("re-provided %c",t)},{signal:(i=this.shutdownController)==null?void 0:i.signal,cid:t}).catch(s=>{this.log.error("could not re-provide key %c - %e",t,s)})}async reprovide(t,n){await zo(this.contentRouting.provide(t,this.addressManager.getAddresses(),n))}}const F4e=20,z4e=5e3,V4e="kad-close",K4e=50;class j4e{constructor(e,t){u(this,"routingTable");u(this,"components");u(this,"closestPeers");u(this,"newPeers");u(this,"refreshInterval");u(this,"peerSetSize");u(this,"timeout");u(this,"closeTagName");u(this,"closeTagValue");u(this,"log");u(this,"running");this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:routing-table`),this.routingTable=t.routingTable,this.refreshInterval=t.refreshInterval??z4e,this.peerSetSize=t.peerSetSize??F4e,this.closeTagName=t.closeTagName??V4e,this.closeTagValue=t.closeTagValue??K4e,this.closestPeers=new cs,this.onPeerPing=this.onPeerPing.bind(this),this.running=!1}async start(){if(this.running)return;this.running=!0;const e=await ps(this.components.peerId);this.newPeers=new Dx(e,this.peerSetSize),this.routingTable.addEventListener("peer:ping",this.onPeerPing),this.timeout=setInterval(()=>{this.updatePeerTags().catch(t=>{this.log.error("error updating peer tags - %e",t)})},this.refreshInterval)}stop(){this.running=!1,this.routingTable.removeEventListener("peer:ping",this.onPeerPing),clearTimeout(this.timeout)}onPeerPing(e){var t;(t=this.newPeers)==null||t.add({id:e.detail,multiaddrs:[]}).catch(n=>{this.log.error("error adding peer to distance list - %e",n)})}async updatePeerTags(){var i;const e=new cs((i=this.newPeers)==null?void 0:i.peers.map(s=>s.id)),t=e.difference(this.closestPeers),n=this.closestPeers.difference(e);this.closestPeers=e,await Promise.all([...[...t].map(async s=>{await this.components.peerStore.merge(s,{tags:{[this.closeTagName]:{value:this.closeTagValue},[eP]:{value:1}}})}),...[...n].map(async s=>{await this.components.peerStore.merge(s,{tags:{[this.closeTagName]:void 0,[eP]:void 0}})})])}}function c2(r){return Array.isArray(r==null?void 0:r.peers)}class H4e{constructor(e){u(this,"root");u(this,"localPeer");u(this,"prefixLength");u(this,"splitThreshold");u(this,"kBucketSize");u(this,"numberOfNodesToPing");u(this,"lastPingThreshold");u(this,"ping");u(this,"verify");u(this,"onAdd");u(this,"onRemove");u(this,"onMove");u(this,"addingPeerMap");this.prefixLength=e.prefixLength??G4e,this.kBucketSize=e.kBucketSize??cK,this.splitThreshold=e.splitThreshold??this.kBucketSize,this.numberOfNodesToPing=e.numberOfOldContactsToPing??J4e,this.lastPingThreshold=e.lastPingThreshold??t5e,this.ping=e.ping,this.verify=e.verify,this.onAdd=e.onAdd,this.onRemove=e.onRemove,this.addingPeerMap=new Fc,this.root={prefix:"",depth:0,peers:[]}}async addSelfPeer(e){this.localPeer={peerId:e,kadId:await ps(e),lastPing:Date.now()}}async add(e,t){const n={peerId:e,kadId:await ps(e),lastPing:0},i=this.addingPeerMap.get(e);if(i!=null)return i;try{const s=this._add(n,t);this.addingPeerMap.set(e,s),await s}finally{this.addingPeerMap.delete(e)}}async _add(e,t){var o;const n=this._determineBucket(e.kadId);if(this._indexOf(n,e.kadId)>-1)return;if(n.peers.length===this.splitThreshold&&n.depth<this.prefixLength){await this._split(n),await this._add(e,t);return}if(n.peers.length<this.kBucketSize){if(!W4e(e,this.lastPingThreshold)){n.peers.push(e),await((o=this.onAdd)==null?void 0:o.call(this,e,n));return}await this.verify(e,t)&&(e.lastPing=Date.now(),await this._add(e,t));return}const i=n.peers.filter(a=>{var c;return!(a.peerId.equals((c=this.localPeer)==null?void 0:c.peerId)||a.lastPing>Date.now()-this.lastPingThreshold)}).sort((a,c)=>a.lastPing<c.lastPing?-1:a.lastPing>c.lastPing?1:0).slice(0,this.numberOfNodesToPing);let s=!1;for await(const a of this.ping(i,t))s=!0,await this.remove(a.kadId);s&&await this._add(e,t)}*closest(e,t=this.kBucketSize){const n=new Dx(e,t);for(const i of this.toIterable())n.addWithKadId({id:i.peerId,multiaddrs:[]},i.kadId);yield*Mh(n.peers,i=>i.id)}count(){function e(t){if(c2(t))return t.peers.length;let n=0;return t.left!=null&&(n+=e(t.left)),t.right!=null&&(n+=e(t.right)),n}return e(this.root)}get(e){const t=this._determineBucket(e),n=this._indexOf(t,e);return t.peers[n]}async remove(e){var i;const t=this._determineBucket(e),n=this._indexOf(t,e);if(n>-1){const s=t.peers.splice(n,1)[0];await((i=this.onRemove)==null?void 0:i.call(this,s,t))}}*toIterable(){function*e(t){if(c2(t)){yield*t.peers;return}yield*e(t.left),yield*e(t.right)}yield*e(this.root)}distance(e,t){return BigInt("0x"+re(kc(e,t),"base16"))}_determineBucket(e){const t=re(e,"base2");function n(i,s=0){return c2(i)?i:t[s]==="0"?n(i.left,s+1):n(i.right,s+1)}return n(this.root)}_indexOf(e,t){return e.peers.findIndex(n=>He(n.kadId,t))}async _split(e){var i,s;const t={prefix:"0",depth:e.depth+1,peers:[]},n={prefix:"1",depth:e.depth+1,peers:[]};for(const o of e.peers)re(o.kadId,"base2")[e.depth]==="0"?(t.peers.push(o),await((i=this.onMove)==null?void 0:i.call(this,o,e,t))):(n.peers.push(o),await((s=this.onMove)==null?void 0:s.call(this,o,e,n)));q4e(e,t,n)}}function q4e(r,e,t){return delete r.peers,r.left=e,r.right=t,r.prefix===""&&(delete r.depth,delete r.prefix),!0}function W4e(r,e){return r.lastPing<Date.now()-e}const cK=20,G4e=6,Q4e=20,Y4e=100,J4e=3,X4e=20,Z4e=100,hP="kad-peer",e5e=1,t5e=6e5,r5e=!0,n5e=1e3;class i5e extends er{constructor(t,n){super();u(this,"kBucketSize");u(this,"kb");u(this,"network");u(this,"closestPeerTagger");u(this,"log");u(this,"components");u(this,"running");u(this,"pingNewContactTimeout");u(this,"pingNewContactQueue");u(this,"pingOldContactTimeout");u(this,"pingOldContactQueue");u(this,"populateFromDatastoreOnStart");u(this,"populateFromDatastoreLimit");u(this,"protocol");u(this,"peerTagName");u(this,"peerTagValue");u(this,"metrics");this.components=t,this.log=t.logger.forComponent(`${n.logPrefix}:routing-table`),this.kBucketSize=n.kBucketSize??cK,this.running=!1,this.protocol=n.protocol,this.network=n.network,this.peerTagName=n.peerTagName??hP,this.peerTagValue=n.peerTagValue??e5e,this.pingOldContacts=this.pingOldContacts.bind(this),this.verifyNewContact=this.verifyNewContact.bind(this),this.peerAdded=this.peerAdded.bind(this),this.peerRemoved=this.peerRemoved.bind(this),this.populateFromDatastoreOnStart=n.populateFromDatastoreOnStart??r5e,this.populateFromDatastoreLimit=n.populateFromDatastoreLimit??n5e,this.pingOldContactQueue=new Ac({concurrency:n.pingOldContactConcurrency??X4e,metricName:`${n.metricsPrefix}_ping_old_contact_queue`,metrics:this.components.metrics,maxSize:n.pingOldContactMaxQueueSize??Z4e}),this.pingOldContactTimeout=new ip({...n.pingOldContactTimeout??{},metrics:this.components.metrics,metricName:`${n.metricsPrefix}_routing_table_ping_old_contact_time_milliseconds`}),this.pingNewContactQueue=new Ac({concurrency:n.pingNewContactConcurrency??Q4e,metricName:`${n.metricsPrefix}_ping_new_contact_queue`,metrics:this.components.metrics,maxSize:n.pingNewContactMaxQueueSize??Y4e}),this.pingNewContactTimeout=new ip({...n.pingNewContactTimeout??{},metrics:this.components.metrics,metricName:`${n.metricsPrefix}_routing_table_ping_new_contact_time_milliseconds`}),this.kb=new H4e({kBucketSize:n.kBucketSize,prefixLength:n.prefixLength,splitThreshold:n.splitThreshold,numberOfOldContactsToPing:n.numberOfOldContactsToPing,lastPingThreshold:n.lastPingThreshold,ping:this.pingOldContacts,verify:this.verifyNewContact,onAdd:this.peerAdded,onRemove:this.peerRemoved}),this.closestPeerTagger=new j4e(this.components,{logPrefix:n.logPrefix,routingTable:this,peerSetSize:n.closestPeerSetSize,refreshInterval:n.closestPeerSetRefreshInterval,closeTagName:n.closeTagName,closeTagValue:n.closeTagValue}),this.components.metrics!=null&&(this.metrics={routingTableSize:this.components.metrics.registerMetric(`${n.metricsPrefix}_routing_table_size`),routingTableKadBucketTotal:this.components.metrics.registerMetric(`${n.metricsPrefix}_routing_table_kad_bucket_total`),routingTableKadBucketAverageOccupancy:this.components.metrics.registerMetric(`${n.metricsPrefix}_routing_table_kad_bucket_average_occupancy`),routingTableKadBucketMinOccupancy:this.components.metrics.registerMetric(`${n.metricsPrefix}_routing_table_kad_bucket_min_occupancy`),routingTableKadBucketMaxOccupancy:this.components.metrics.registerMetric(`${n.metricsPrefix}_routing_table_kad_bucket_max_occupancy`),routingTableKadBucketMaxDepth:this.components.metrics.registerMetric(`${n.metricsPrefix}_routing_table_kad_bucket_max_depth`),kadBucketEvents:this.components.metrics.registerCounterGroup(`${n.metricsPrefix}_kad_bucket_events_total`)})}isStarted(){return this.running}async start(){this.running||(this.running=!0,await Vo(this.closestPeerTagger),await this.kb.addSelfPeer(this.components.peerId))}async afterStart(){Promise.resolve().then(async()=>{if(!this.populateFromDatastoreOnStart)return;let t=0;for(const n of await this.components.peerStore.all({filters:[i=>i.protocols.includes(this.protocol)&&i.tags.has(hP)],limit:this.populateFromDatastoreLimit})){if(!this.running)return;try{await this.add(n.id),t++}catch{this.log("failed to add peer %p to routing table, removing kad-dht peer tags - %e"),await this.components.peerStore.merge(n.id,{tags:{[this.peerTagName]:void 0}})}}this.log("added %d peer store peers to the routing table",t)}).catch(t=>{this.log.error("error adding peer store peers to the routing table %e",t)})}async stop(){this.running=!1,await Bc(this.closestPeerTagger),this.pingOldContactQueue.abort(),this.pingNewContactQueue.abort()}async peerAdded(t,n){var i;this.components.peerId.equals(t.peerId)||await this.components.peerStore.merge(t.peerId,{tags:{[this.peerTagName]:{value:this.peerTagValue}}}),this.updateMetrics(),(i=this.metrics)==null||i.kadBucketEvents.increment({peer_added:!0}),this.safeDispatchEvent("peer:add",{detail:t.peerId})}async peerRemoved(t,n){var i;this.components.peerId.equals(t.peerId)||await this.components.peerStore.merge(t.peerId,{tags:{[this.peerTagName]:void 0}}),this.updateMetrics(),(i=this.metrics)==null||i.kadBucketEvents.increment({peer_removed:!0}),this.safeDispatchEvent("peer:remove",{detail:t.peerId})}async*pingOldContacts(t,n){var s;if(!this.running)return;const i=[];for(const o of t){if(this.kb.get(o.kadId)==null){this.log("asked to ping contact %p that was not in routing table",o.peerId);continue}(s=this.metrics)==null||s.kadBucketEvents.increment({ping_old_contact:!0}),i.push(async()=>{const a=this.pingOldContactQueue.find(o.peerId);if(a!=null)return this.log("asked to ping contact %p was already being pinged",o.peerId),await a.join(n)?void 0:o;if(!await this.pingOldContactQueue.add(async l=>{var p;const d=this.pingOldContactTimeout.getTimeoutSignal(),h=dt([d,l==null?void 0:l.signal]);try{return await this.pingContact(o,l)}catch{return(p=this.metrics)==null||p.kadBucketEvents.increment({ping_old_contact_error:!0}),!0}finally{this.pingOldContactTimeout.cleanUp(d),h.clear()}},{peerId:o.peerId,signal:n==null?void 0:n.signal}))return o})}for await(const o of Gp(i))o!=null&&(yield o)}async verifyNewContact(t,n){var o;const i=this.pingNewContactTimeout.getTimeoutSignal(),s=dt([i,n==null?void 0:n.signal]);try{const a=this.pingNewContactQueue.find(t.peerId);return a!=null?(this.log("joining existing ping to add new peer %p to routing table",t.peerId),await a.join({signal:s})):await this.pingNewContactQueue.add(async c=>{var l;return(l=this.metrics)==null||l.kadBucketEvents.increment({ping_new_contact:!0}),this.log("pinging new peer %p before adding to routing table",t.peerId),this.pingContact(t,c)},{peerId:t.peerId,signal:s})}catch{return this.log.trace("tried to add peer %p but they were not online",t.peerId),(o=this.metrics)==null||o.kadBucketEvents.increment({ping_new_contact_error:!0}),!1}finally{this.pingNewContactTimeout.cleanUp(i),s.clear()}}async pingContact(t,n){try{this.log("pinging contact %p",t.peerId);for await(const i of this.network.sendRequest(t.peerId,{type:At.PING},n))if(i.type===qv.PEER_RESPONSE)return i.messageType===At.PING?(this.log("contact %p ping ok",t.peerId),this.safeDispatchEvent("peer:ping",{detail:t.peerId}),!0):!1;return!1}catch(i){return this.log("error pinging old contact %p - %e",t.peerId,i),!1}}get size(){return this.kb==null?0:this.kb.count()}async find(t){var i;const n=await ps(t);return(i=this.kb.get(n))==null?void 0:i.peerId}closestPeer(t){const n=this.closestPeers(t,1);if(n.length>0)return n[0]}closestPeers(t,n=this.kBucketSize){return this.kb==null?[]:[...this.kb.closest(t,n)]}async add(t,n){if(this.kb==null)throw new Error("RoutingTable is not started");await this.kb.add(t,n)}async remove(t){if(this.kb==null)throw new Error("RoutingTable is not started");const n=await ps(t);await this.kb.remove(n)}updateMetrics(){if(this.metrics==null||this.kb==null)return;let t=0,n=0,i=0,s=20,o=0;function a(c){if(c2(c)){c.depth>i&&(i=c.depth),n++,t+=c.peers.length,c.peers.length<s&&(s=c.peers.length),c.peers.length>o&&(o=c.peers.length);return}a(c.left),a(c.right)}a(this.kb.root),this.metrics.routingTableSize.update(t),this.metrics.routingTableKadBucketTotal.update(n),this.metrics.routingTableKadBucketAverageOccupancy.update(Math.round(t/n)),this.metrics.routingTableKadBucketMinOccupancy.update(s),this.metrics.routingTableKadBucketMaxOccupancy.update(o),this.metrics.routingTableKadBucketMaxDepth.update(i)}}const s5e=[77591,22417,43971,28421,740,29829,71467,228973,196661,78537,27689,36431,44415,14362,19456,106025,96308,2882,49509,21149,87173,131409,75844,23676,121838,30291,17492,2953,7564,110620,129477,127283,53113,72417,165166,109690,21200,102125,24049,71504,90342,25307,72039,26812,26715,32264,133800,71161,88956,171987,51779,24425,16671,30251,186294,247761,14202,2121,8465,35024,4876,85917,169730,3638,256836,96184,943,18678,6583,52907,35807,112254,214097,18796,11595,9243,23554,887,268203,382004,24590,111335,11625,16619,29039,102425,69006,97976,92362,32552,63717,41433,128974,137630,59943,10019,13986,35430,33665,108037,43799,43280,38195,29078,58629,18265,14425,46832,235538,40830,77881,110717,58937,3463,325358,51300,47623,117252,19007,10170,20540,91237,294813,4951,79841,56232,36270,128547,69209,66275,100156,32063,73531,34439,80937,28892,44466,88595,216307,32583,49620,16605,82127,45807,21630,78726,20235,40163,111007,96926,5567,72083,21665,58844,39419,179767,48328,42662,51550,5251,37811,49608,81056,50854,55513,20922,18891,197409,164656,32593,71449,220474,58919,85682,67854,13758,35066,3565,61905,214793,119572,141419,21504,10302,27354,67003,46131,32668,15165,64871,34450,17821,2757,11452,34189,5160,12257,85523,560,53385,65887,119549,135620,312353,115979,122356,10867,193231,124537,54783,90675,120791,4715,142253,50943,17271,43358,25331,4917,120566,34580,12878,33786,160528,32523,4869,301307,104817,81491,23276,8832,97911,31265,52065,7998,49622,9715,43998,34091,84587,20664,69041,29419,53205,10838,58288,116145,6185,5154,141795,35924,21307,144738,43730,12085,8279,10002,119,133779,199668,72938,31768,39176,67875,38453,9700,44144,4121,116048,41733,12868,82669,92308,128,34262,11332,7712,90764,36141,13553,71312,77470,117314,96549,49135,23602,54468,28605,6327,62308,17171,67531,21319,14105,894,107722,46157,8503,51069,100472,45138,15246,14577,35609,191464,1757,13364,161349,32067,91705,81144,52339,5408,91066,21983,14157,100545,4372,26630,129112,1423,29676,213626,4397,88436,99190,6877,49958,26122,114348,60661,29818,293118,50042,179738,16400,163423,89627,31040,43973,36638,45952,5153,1894,109322,1898,134021,12402,112077,68309,190269,69866,31938,107383,11522,105232,11248,14868,39852,71707,186525,16530,38162,106212,11700,5130,16608,26998,59586,108399,230033,43683,48135,82179,2073,5015,196684,189293,16378,23452,8301,35640,11632,214551,29240,57644,33137,91949,55157,52384,117313,5090,17717,89668,49363,82238,241035,66216,29066,184088,97206,62820,26595,4241,135635,173672,8202,459,71355,146294,29587,3008,135385,141203,14803,6634,45094,69362,50925,546,51884,62011,83296,234584,44515,56050,89476,87751,19373,12691,149923,19794,13833,35846,87557,58339,2884,19145,25647,12224,11024,77338,64608,122297,53025,7205,36189,36294,170779,21750,7739,173883,75192,35664,224240,113121,30181,26267,27036,117827,92015,106516,55628,203549,67949,60462,60844,35911,20457,1820,920,19773,8738,73173,181993,38521,98254,76257,46008,92796,5384,26868,151566,22124,2411,15919,186872,180021,28099,152961,78811,80237,62352,102653,74259,184890,16792,123702,224945,29940,19512,75283,14059,112691,92811,233329,20411,138569,53341,109802,50600,134528,66747,5529,166531,31578,64732,67189,1596,126357,967,167999,206598,109752,119431,207825,78791,91938,10301,27311,24233,252343,28831,32812,66002,112267,90895,8786,8095,16824,22866,21813,60507,174833,19549,130985,117051,52110,6938,81923,123864,38061,919,18680,53534,46739,112893,161529,85429,26761,11900,81121,91968,15390,217947,56524,1713,6654,37089,85630,138866,61850,16491,75577,16884,98296,73523,6140,44645,6062,36366,29844,57946,37932,42472,5266,20834,19309,33753,127182,134259,35810,41805,45878,312001,14881,47757,49251,120050,44252,3708,25856,107864,120347,1228,36550,41682,34496,47025,8393,173365,246526,12894,161607,35670,90785,126572,2095,124731,157033,58694,554,12786,9642,4817,16136,47864,174698,66992,4639,69284,10625,40710,27763,51738,30404,264105,137904,109882,52487,42824,57514,2740,10479,146799,107390,16586,88038,174951,9410,16185,44158,5568,40658,46108,12763,97385,26175,108859,664,230732,67470,46663,14395,50750,141320,93140,15361,47997,55784,6791,307840,118569,107326,18056,58281,260415,54691,8790,73332,45633,7511,45674,143373,14031,11799,94491,35646,96544,14560,26049,32983,25791,83814,42094,231370,63955,139212,2359,169908,3108,183486,105867,28197,32941,124968,26402,88267,149768,23053,3078,19091,52924,25383,19209,111548,97361,3959,24880,235061,9099,24921,161254,151405,20508,7159,34381,20133,11434,74036,19974,34769,36585,1076,22454,17354,38727,235160,111547,96454,117448,156940,91330,37299,7310,26915,117060,51369,22620,61861,322264,106850,111694,15091,2624,40345,300446,177064,1707,27389,54792,327783,132669,183543,59003,17744,20603,151134,106923,53084,71803,279424,319816,11579,21946,16728,38274,72711,5085,83391,88646,40159,25027,34680,10752,12988,54126,30365,18338,100445,230674,44874,84974,143877,123253,139372,28082,91477,144002,13096,219729,46016,50029,42377,14601,6660,58244,58978,23918,88206,113611,64452,17541,41032,10942,12021,49189,10978,40175,37156,10947,71709,106894,112538,57007,137486,150608,152719,40615,7746,279716,13101,19524,28708,40578,72320,1096,182051,94527,51275,22833,45164,81917,77519,48508,5421,140302,37845,149830,5587,27579,5357,428725,248187,6326,206760,39814,32585,89923,44341,288753,284443,96368,31201,94189,119504,20359,52073,103216,179,27934,32801,96035,34111,34309,101326,18198,20704,210266,37643,27880,141873,106e3,19414,56614,167714,66483,107885,86602,4379,20796,75467,4987,5017,118857,26003,34308,114428,29198,6686,29697,73632,3739,69795,16798,41504,7207,30722,21436,36735,28067,28545,3239,11221,36031,41889,100010,19247,317673,29495,174554,6424,129725,53845,94986,7955,59676,2604,191497,19735,102214,62954,23844,11872,179525,261436,34492,428,78404,142035,16747,17246,27578,37021,33672,57944,26056,135760,2369,61674,122066,31327,19374,157065,40553,130982,69619,71290,38855,72100,92903,95940,51422,165999,65713,57873,50726,7288,20272,2081,42326,22624,81120,57914,79352,19447,1684,72302,11774,302559,161481,96396,13692,414988,3721,79066,56627,46883,21150,11747,12184,5856,113458,176117,84416,52079,27933,3354,59765,141359,2212,216309,2555,23458,196722,142463,45701,44548,28798,19418,215,29916,9396,10574,114226,84475,13520,18694,34056,4524,90302,62930,13539,19407,77209,7728,38088,9535,2263,23875,183945,17750,26274,67172,10585,28042,22199,7478,51331,66030,26774,192929,31434,25850,50197,52926,178158,4679,181256,70184,229600,9959,105594,72158,73974,2726,35085,78087,23284,35568,51713,155676,5401,27254,11966,17569,223253,71993,103357,111477,55722,30504,26034,46774,35392,36285,214814,41143,163465,1051,16094,81044,6636,76489,179102,20712,39178,35683,125177,54219,30617,52994,25324,50123,2543,87529,58995,10688,125199,12388,60158,125481,131646,7642,133350,65874,3438,97277,101450,10075,56344,116821,50778,60547,98016,106135,13859,14255,16300,77373,173521,8285,45932,37426,4054,114295,55947,7703,39114,52,51119,128135,19714,60715,9554,50492,88180,2823,118271,52993,122625,97919,23859,37895,25040,33614,32102,20431,3577,9275,15686,43031,157741,110358,1884,40291,125391,13736,5008,64881,87336,77381,70711,43032,49155,118587,70494,4318,10168,30126,12580,10524,280104,104001,145413,2862,84140,6603,106005,13566,12780,11251,42830,571,179910,82443,13146,469,42714,32591,265217,424024,92553,54721,134100,6007,15242,114681,59030,16718,85465,200214,85982,55174,165013,23493,56964,82529,109150,32706,27568,82442,5350,14976,13165,44890,60021,21343,33978,17264,4655,22328,27819,75730,16567,55483,14510,17926,45827,150609,3704,7385,272531,161543,76904,122163,52405,2039,19165,41623,14423,228354,3369,176360,85491,7122,35789,303724,4465,13628,2233,55311,118771,20713,10006,221519,45115,71021,35650,29775,7337,10864,20665,21142,1746,15080,1624,32449,10905,105743,229797,7701,3940,22997,178467,57208,389057,39683,59403,63344,63125,54847,69691,18336,56448,3362,37202,18282,29648,138224,35867,10495,5911,28814,26653,31514,176702,26550,45621,11734,4525,40543,73944,121080,27858,155561,14887,44670,30742,8796,107455,113472,56369,75581,183777,240095,133699,153299,8768,160464,26058,49078,103971,21875,71486,44888,17156,9678,89541,123019,102337,3972,83930,21245,87852,109660,287918,183019,686,10100,39177,283941,11274,24736,26793,26214,25995,77011,141580,4070,23742,46285,46632,30700,26669,19056,35951,115575,174034,56097,35463,87425,24575,44245,38701,82317,85922,281616,100333,147697,61503,7730,84330,8530,59917,61597,17173,9092,32658,90288,193136,39023,20381,56654,31132,7779,1919,1375,117128,30819,11169,40938,23935,115201,101155,151034,4835,11231,74550,89388,59951,91704,107312,167882,115062,12732,72738,88703,464019,158267,57995,60496,737,14371,123867,4174,243339,159946,7568,16025,134556,110916,38103,191,80226,88794,29688,27230,10454,76308,57647,77409,113483,66864,14745,19808,12023,46583,84805,16015,17102,2231,20611,3547,95740,250131,34559,108894,8498,15853,159169,148920,20942,2813,93160,45188,210613,45531,52587,149062,39782,28194,57849,60965,84954,89766,84453,100927,16501,27658,165311,103841,54192,207341,19558,20084,319622,5672,205467,98462,61849,36279,13609,147177,24726,165015,209489,59591,31157,6551,117580,75060,141146,277310,21072,22023,106474,63041,137443,122965,68371,5383,42146,98961,113467,30863,23794,4843,99630,30392,82679,13699,241612,33601,93146,24319,18643,32155,95669,40440,15333,34089,67799,142144,58245,38633,114531,117400,77861,188726,5507,2568,8853,10987,107222,2663,2421,11530,13345,30075,41785,118661,104786,17459,12490,16281,71936,193555,17431,5944,71758,26485,77317,20803,367167,158,7362,93430,11735,172445,46002,11532,54482,930,62911,2235,23004,179236,4764,101859,208113,22477,55163,95579,14098,67320,162556,90709,156949,3826,57492,4025,34092,87442,104565,6718,186015,28214,14209,10039,107186,233912,58877,81637,55265,39828,6194,145813,50831,105849,4974,88319,122296,10272,197216,95714,51540,72418,23324,91555,8743,140452,250249,51666,34124,7229,38592,129641,78169,174242,22464,149964,51450,14034,10026,95376,26190,120062,14401,8700,265,31386,143573,7203,229889,61567,4227,140981,2466,72052,10787,10062,30958,6099,38471,30103,23202,208101,70847,467,58934,32271,32984,36637,24107,30771,17109,73353,13650,2098,157040,67366,66904,106018,265380,107238,18535,44025,32681,144983,62505,91295,56120,3082,77508,10322,63023,36700,81885,224127,16721,45023,239261,111272,13852,7866,149243,204199,32309,22084,42029,38316,126644,104973,14406,43454,67322,61310,15789,40285,24026,181047,6301,70927,23319,115823,27248,66693,115875,278566,63007,146844,56841,59007,87368,180001,22370,42114,80605,12022,10374,308,25079,14689,12618,63368,7936,264973,212291,136713,95999,105801,18965,32075,48700,52230,35119,96912,32992,8586,16606,101333,101812,14969,39930,759,193090,27387,42914,12937,5058,62646,64528,38624,25743,37502,3716,4435,30352,178687,26461,132611,42002,138442,35833,59582,16345,8048,60319,49349,309,47800,49739,90482,26405,34470,63786,32479,85028,39866,47846,11649,23934,29466,2816,42864,31828,7410,74885,49632,47629,111801,90749,19536,18767,105764,59606,21223,10746,76298,22220,39408,7190,79654,64856,11602,82156,272765,17079,70089,245473,51813,184407,384678,1576,122249,5064,27481,6188,25790,74361,27541,318284,45430,31488,620,93579,45723,192118,22670,51913,4162,70244,35966,26397,16199,50899,209613,121702,287507,2993,36101,132229,67345,33062,76295,118628,78705,52316,34375,107083,107454,44863,127561,33964,3073,154010,190914,55967,39074,6272,31047,5550,41123,26154,98638,47110,19998,148091,50229,31329,59900,195442,19106,61347,73497,70015,682,45850,25776,38022,148951,6288,37411,232526,109277,27286,32342,9262,5220,16651,23175,46740,129438,78614,121925,66914,88710,127952,5563,21500,34521,10739,14863,191006,62956,17359,16749,67027,56284,69134,43301,35039,58883,54466,60823,404451,75743,59856,86979,7923,34273,83785,32142,7693,268986,197428,282681,17049,22346,22990,92245,107180,3357,37104,96724,49153,7683,31197,43267,82231,164276,23696,20848,188364,22309,24821,158707,1018,22514,70922,27792,45589,59709,10765,736,35218,63479,51987,24275,63588,55361,92929,81964,4658,20122,12330,44058,13065,311456,72224,8337,211229,38979,22590,138478,52757,32595,133600,8838,31549,94412,43391,90056,1585,94802,127271,6223,31889,137038,132910,2165,57616,230152,6080,10748,36737,74579,134062,50525,180532,119270,34556,76155,82394,52595,29258,31435,87820,67996,26943,183878,38007,2410,13526,180297,69856,3503,187396,167700,7838,16701,9199,56267,3661,37407,65994,23767,5708,62508,221700,67088,86978,46776,84434,32088,5612,9149,88244,21685,95151,46750,189612,2979,506311,2594,3628,40074,105039,78243,28523,6651,38058,71999,30992,12764,68261,108991,6165,26450,61961,13400,22426,7490,60890,109623,2070,12958,50355,67979,257096,7213,42578,52121,35716,65461,7516,124758,39268,302,64712,14977,1467,219452,2840,34229,11121,21602,19270,63574,8024,1532,17331,79839,78885,52029,180767,57957,6069,91265,61380,55767,8927,32881,287603,22149,35029,68876,6428,199567,46926,13412,104132,21434,366616,45060,110046,81924,128910,45886,52821,130416,29416,77342,21762,67329,121432,79924,11724,38625,81006,102033,28338,13326,3250,82056,82526,38212,21112,12382,111495,3263,7414,86274,93490,40844,30224,45212,24019,48411,71367,24941,76729,57776,3769,38114,202019,197745,31953,237533,33270,201580,255648,100798,44741,32241,98468,106931,10085,15090,170358,33154,66787,18819,69760,25061,234005,82660,6295,131975,16874,9076,4094,25005,17740,40908,19533,220019,44330,99792,50040,19619,13950,55228,24423,31253,95308,103177,184795,28590,82285,5059,3210,75525,49894,70007,56178,10580,36051,139681,21617,98736,3555,106306,164189,37352,63915,47824,24883,145530,61904,28444,11483,19837,145446,30420,112972,85939,11835,191233,2262,20705,58630,1753,148334,1197,144714,6887,11223,107667,60879,77914,4151,57417,81594,96681,169430,1784,20444,95138,254041,27038,596,7117,72808,13759,3353,126776,21074,55322,27081,36942,39547,139830,179275,4453,713,8722,71399,19204,25785,22794,23923,104114,11291,25458,102309,88396,75288,230440,206396,104551,58447,130857,37247,94734,31548,176529,226077,65159,20104,10096,66881,94191,237909,27109,37404,1520,27421,25220,113003,23423,24884,50585,6286,231877,150800,11789,3226,90004,60642,5053,202400,61442,132531,175329,57138,30116,103847,9973,75367,16452,32360,59119,21246,10191,164804,23305,61051,37348,154530,13214,5468,50403,66754,130976,50559,80515,14436,155492,84017,5472,43107,41240,2890,90431,70188,382,76234,48040,50211,281038,237007,32115,142178,1536,22761,96429,1811,31243,1679,49143,55209,17402,235054,61494,7462,77030,34925,87609,78002,9499,9027,73289,201078,101379,63544,27666,5469,10642,30029,49816,132979,95620,58086,351930,116300,2110,2043,30845,6154,11279,16727,4122,2277,27281,4971,3650,39060,61970,65951,39674,75686,38151,11370,130809,177895,32665,63725,122267,7857,39618,118483,44792,157755,178624,136994,24260,41308,22471,12404,21707,12486,30473,52781,50246,20247,39065,909,56825,103158,128603,31542,1089,41935,32744,12428,37963,84420,33134,72921,208449,42622,168151,127335,147107,46699,38216,12591,94342,85814,31423,24944,2605,87542,67473,192551,4496,56321,91819,17630,6300,256183,114569,202090,33209,35289,34897,24967,40520,43470,5344,10199,34810,14283,10381,10017,62923,49924,23233,64539,13051,35686,19698,11570,135555,120868,44924,87065,52318,52335,47586,140906,245885,109834,78668,9065,46990,25258,72022,61243,40838,4545,146387,10537,11557,17470,36930,68104,46711,24264,79401,81043,18225,120488,24746,84338,81652,28266,13776,21878,46973,1047,230465,73357,95777,24973,210160,62210,58404,110633,169651,6937,41870,9909,26822,191062,76553,27519,96256,239070,2478,205678,67955,58532,20601,50120,19148,78501,195724,110740,8249,109665,27446,30568,57631,31425,49752,32820,65504,50079,3663,102256,219898,23849,211315,14645,4359,91767,9528,12449,49366,7941,49763,107848,8930,27086,50686,9744,10447,81935,39513,46514,1670,29229,6172,22312,137280,97759,9806,14445,22976,56458,73391,34983,93760,174219,52573,33149,59747,2429,136277,75123,165263,91040,7446,57632,48633,97140,246081,84766,151684,79918,93268,120346,54059,54875,77858,32996,103590,45276,11968,19600,25849,17159,132907,42828,16817,4913,99462,103303,27395,5737,74184,20749,21160,14377,77062,131403,158735,10999,27799,77785,9320,34366,51593,61070,33746,47048,29268,36675,30262,53297,9832,82e3,20188,122292,39917,7331,18160,68301,185935,134830,15031,4935,10004,165845,185534,46923,30109,44134,122631,18874,22903,112790,26561,18549,348902,82871,140345,255565,135390,63556,103747,145055,179600,145662,296111,61661,211987,23952,52342,126343,48450,32919,44277,82185,9591,62139,205363,376969,394874,108461,18040,120885,14798,39863,16571,16794,58271,81025,55206,14640,118656,6361,44092,85970,6262,153863,108244,180200,72264,79947,38044,10050,5735,61221,80712,5471,115689,11391,11661,184257,20010,60116,30320,19327,134598,45455,27542,18004,125092,452272,1549,91523,46567,180063,156026,2608,11174,58848,37788,65907,80194,30490,5786,40775,119519,106241,11323,156297,8425,61495,2617,29675,2425,59886,112582,49142,59618,4863,50597,86710,50650,168632,27693,85641,83643,18993,25768,84284,28090,93592,36627,312804,43381,9887,9402,100931,97165,3311,173330,66805,28935,4963,184460,3201,78102,19126,21607,37496,24938,22615,16153,32862,134792,153318,61120,6067,2812,12826,12792,23825,37559,64662,202250,102694,155488,85881,149193,46233,65383,15521,106982,11358,176786,25752,39717,34208,24510,32464,77742,39371,72028,138229,60688,71386,102834,132477,2208,11548,63670,271279,28351,30338,38620,32491,99845,143885,152266,13252,2825,178663,108097,1775,78201,14897,113573,163346,62292,171129,22183,96598,38733,64971,166776,117445,9968,146393,44677,74867,20908,97328,12761,25656,26785,9148,112344,26115,99176,110121,22437,49547,6180,79320,5835,31392,43328,33377,75870,119860,69497,80273,7325,155219,43167,111173,28347,20222,3763,71752,55041,47252,14618,28088,15012,97805,194698,54636,2036,41349,6173,96604,61530,51859,43782,13361,24334,22668,24792,7070,23441,16789,3209,36211,208475,26242,32880,122181,182407,21444,31060,88459,29929,77907,12716,10934,97005,20599,31690,8403,58445,30303,22700,10336,86731,103115,337709,72556,46788,112566,47684,67089,53548,36874,56487,41387,125985,26893,40071,106683,73712,18787,40105,72992,67246,137276,50802,36790,70328,138827,22466,39263,183295,29858,50975,9322,57397,10654,24364,30383,55799,41600,23584,127295,296610,129078,143558,244131,86397,36049,1085,80677,3820,108139,5476,34767,24683,7758,13060,7239,131671,250593,59556,103392,29810,4188,252323,39404,116877,7651,43600,40338,13554,157253,39196,25978,144387,61211,234,50104,6129,10449,93777,9240,356378,274148,4439,72970,3724,147770,78680,62570,115877,40027,40547,36817,224392,64609,34795,165027,67440,2477,37206,23431,50754,164797,46018,94995,170982,27051,7957,22767,3674,27900,56419,18930,60701,41302,2692,84749,339721,61996,111094,80221,50129,1045,8153,62945,19202,8250,37208,37418,32560,79477,41106,88569,33963,36693,5892,30570,1581,66471,49647,11922,160717,29442,5643,114865,82962,95982,132098,22633,22838,94726,54556,28566,205039,162340,33216,16849,35847,221339,94851,26533,71469,1805,3804,12935,45483,71020,36310,65381,192960,34240,35165,59773,1248,46954,155332,96864,4246,388800,16129,57133,74592,44807,442014,38203,42574,80818,91592,26377,36424,65760,977,77387,22628,147610,28018,30561,98454,6969,119628,63648,18170,36854,26601,64018,22027,37279,51395,152934,21153,9430,58760,194742,5330,55115,34158,28917,174111,13171,122326,1526,43896,66094,25325,4234,148354,11450,275,18999,112191,44365,22723,68409,8733,57746,96565,75007,14196,108844,29475,88599,177563,100792,106156,86323,93726,14248,135341,194131,40126,47099,14779,8272,39597,95983,171398,65882,28052,10393,47213,40689,22120,72212,106829,34964,109146,753,648,21660,30047,17527,181025,5619,145357,4085,216883,9359,186951,24779,53931,24545,36197,223296,62628,168101,4243,107313,30321,26642,13049,51059,31027,107912,807,73550,26551,84369,122422,165872,49754,74213,234264,33151,52014,33100,87183,22365,52500,40013,23302,5652,72723,21404,26107,48434,587,94049,168493,96418,32871,70860,31709,25128,443,71597,166253,15670,70994,26341,133675,28280,75491,54756,47955,56028,26182,11952,113272,472197,64640,110753,17919,337,50642,22576,142,87371,53391,93210,126694,15285,19642,85667,14148,1506,42092,52962,33243,11970,20734,135843,57044,58880,13002,219134,22876,64754,232519,4257,43120,321573,24799,64526,124728,52579,81472,70831,276848,17403,74359,23021,182101,74597,23744,148267,12055,7976,5349,11772,67540,167347,65318,18720,127832,108238,22828,90233,9987,259080,118185,73209,79270,13775,90100,137742,90799,70569,15699,19961,9087,67475,57872,39731,8810,134897,131868,146849,19898,3334,2281,167061,91073,60356,467742,74712,188,53179,137679,92769,29241,9537,132595,80119,1041,88962,5976,40171,44911,102859,139059,104558,98987,47761,19272,71472,113864,175377,73338,10857,23402,23758,1591,139864,5644,4076,118760,16427,134198,18853,20291,100849,37423,22038,36677,19071,195521,57445,11069,31869,55718,66882,148490,44,41296,75242,49704,166810,9906,20943,122258,49112,105667,15969,10344,6408,187694,21399,72742,58970,14867,14376,81889,41856,23225,15042,56993,16074,131389,74276,72407,53875,383108,53597,37363,68993,44854,122548,430927,198279,38430,80409,12245,2981,628,2818,17760,37437,238229,7968,46892,2200,3730,34190,65983,37959,112291,87850,70827,6522,20750,73913,111621,41652,19587,2780,58668,25916,85259,18200,168962,95781,42445,102050,7776,57662,103313,47742,96358,41964,66174,100396,29069,204735,19679,27978,7479,40264,22534,61183,36081,107436,58223,14680,23002,101311,24716,124108,12908,5646,31750,40380,14215,232799,102772,14122,96775,61398,50917,12096,149880,67833,598749,124194,155871,49216,790,14677,65319,56917,7440,145744,95701,12206,49405,129269,76199,45732,9767,11058,9047,210885,11051,7392,26307,2130,8132,147526,20802,232698,115660,50060,59789,57344,107623,80343,112676,23291,9866,160971,34032,118291,15719,59730,164911,28975,2659,58046,78480,21854,66209,53863,109085,116045,29021,46481,107552,22130,18764,70254,31272,11300,52460,43933,84738,20721,53869,190840,79673,105300,7561,321817,66924,13940,33281,101046,183181,32176,71878,5678,62924,79535,56646,40303,19559,27703,93042,73368,42187,3670,37376,46440,7023,36816,109628,20680,5940,276440,275233,170848,112093,136996,14984,20226,111441,77693,112960,48577,39370,55707,50314,123404,26570,54281,61372,123391,4857,35928,246740,132507,106646,44241,7196,92258,9825,37688,51197,303141,5590,15476,132986,10955,85782,34486,26696,7991,28813,18858,39546,11703,11365,38185,5716,93555,11925,40121,60002,6985,10976,171384,3887,43394,13337,56346,6381,252336,39573,75042,53711,1028,31781,44295,95925,131713,7214,68125,43571,70954,213234,1628,8760,13391,65485,17320,56038,1710,25248,60803,57399,19839,3870,326,281556,50945,72400,21460,316244,75619,56246,98775,481,13513,55765,50427,7388,123519,32929,57908,27124,61316,101097,57467,30228,48792,10788,20402,37318,50526,155730,34456,158065,145305,17832,43733,64052,4506,35072,205355,177028,184004,187081,68616,35938,83703,10367,36892,93186,260137,51934,89970,4985,23445,26755,21558,7948,78741,23376,124405,85594,68596,57536,49351,12619,56593,132668,99924,109728,71844,71935,196018,65464,17617,14987,89701,143773,33997,8687,22701,33258,2914,4436,72108,85610,9671,49067,2327,82988,1361,1672,44033,35777,30269,24057,10605,82236,616,15793,13919,47249,112086,116698,9484,80207,90574,33304,68624,93127,56101,42210,160929,4827,38995,38095,4701,125119,5027,33680,9236,231236,14135,87837,23318,70261,78893,30151,81482,14332,1084,74256,27532,46644,79185,3148,62615,6981,55672,31668,36825,1849,14536,37446,14738,23779,43058,162749,72199,1168,21346,5592,85932,85302,9668,18351,57135,150360,2080,228015,77953,34670,119302,151751,31009,106725,84265,45214,59289,74178,113071,263206,111009,4021,44449,188119,192629,123592,392506,292847,114487,12831,205858,9852,20780,79648,75767,357014,97721,18166,21005,67950,33226,204009,16536,2987,11335,66717,144910,47950,17262,55060,15063,2934,51038,26775,178497,66008,3427,49433,128592,20036,157553,63861,3089,23015,51210,28696,35933,49942,71135,231518,99620,17248,21835,176536,20676,16944,38700,165831,233253,295625,36723,13023,52745,10907,19423,67972,125868,95473,82875,1183,108455,52685,33417,64095,21433,52438,33191,127809,44505,211823,7810,2752,95548,162031,7185,91196,47563,61721,33359,17897,23682,42806,178101,22874,49707,199897,75419,82456,8618,11171,79712,116847,18783,44190,46564,5346,59046,95032,7893,14916,3214,26800,24172,121453,34362,10250,17408,18888,4840,68696,22831,13162,36005,32512,14800,62357,41723,45046,27247,37486,5372,2564,34261,298500,66509,133920,89138,31305,117697,19097,108304,81386,84106,23802,46411,63304,946,51417,41777,41041,19501,115864,60743,294354,37955,94165,18116,1156,17937,20645,57114,90804,58042,48643,92288,9861,2557,88546,61333,101008,12853,5148,87856,4152,144503,73841,18718,9789,147565,10846,42085,12789,30223,8993,56352,67203,2448,28215,6052,23540,126319,75933,36689,80235,23231,23561,21383,38800,77548,102798,21234,31468,158608,46188,63960,191679,8051,67014,11185,170078,42186,28827,34777,41930,212079,12421,34750,24111,110344,73918,45171,70826,141949,40063,23979,24254,37309,26724,27179,24718,83648,54938,14591,17425,29525,102675,48975,48654,12316,8929,60640,41709,50168,63264,89812,50716,48632,38755,138583,160123,55579,71829,24230,233277,46322,39650,166388,34718,24108,98252,7031,106695,62498,18258,35062,217827,78731,34824,33354,19520,60852,2432,60224,8587,2836,62955,702,20227,42285,40560,95592,62486,11094,53035,143291,18842,46177,77994,1770,9657,107422,172915,32655,128716,25886,25164,156740,119928,165875,85817,11007,89110,33956,12652,65156,180266,8494,36889,19958,20955,96,1264,118288,135769,44754,86671,5632,19026,168220,289120,33569,93821,66144,70635,7687,5642,2714,55445,56636,71545,184182,93133,7332,37389,12643,52315,22729,11014,158742,17050,152889,50178,34601,41945,52136,9948,26914,63548,95721,115951,40759,8960,158258,38938,49232,48325,42234,81523,253019,66128,40978,20048,238048,38760,62928,122560,118532,43687,137472,163689,26680,9878,17448,51035,16211,60834,36749,29178,14241,59868,150086,2305,26477,42422,34342,165341,83279,33894,14257,29928,12743,13957,125571,89134,66712,10952,16507,147839,30146,7249,16565,45399,39874,114565,215780,31990,230881,171477,102,196546,44538,10880,84948,281705,86651,10617,31395,2342,453658,43569,60561,132901,21845,17727,58556,258242,22262,58728,4008,77997,11806,37431,30599,81375,109137,185787,114085,217292,97453,169085,30593,60212,11544,102056,65580,2384,91655,4855,95725,7295,157994,16228,20669,53276,141590,105246,17334,25440,76067,17967,39321,38911,11362,28559,63807,21627,26468,85816,40120,1025,15234,58319,69516,66512,124548,75845,78873,22137,46681,51242,85683,32909,76747,35555,43396,101465,1765,73094,1077,2962,39028,66777,57831,42048,15828,13962,36041,63657,52412,5242,58846,2141,5506,219012,134451,3936,182230,17558,17153,152237,22621,49377,170216,35257,68233,65374,6510,11126,212151,7184,2480,22517,3437,33073,30156,16557,3768,55067,86829,91e3,12350,148650,66017,79424,70885,49066,28250,21369,51213,34533,11510,3258,18176,18465,84413,6315,36411,163765,4346,356,107618,598,13727,285026,162695,8749,14583,7132,63521,184253,32378,25991,5604,30961,53675,4874,84693,5086,34811,26978,56564,7904,33519,51221,113942,69253,6664,125563,22055,220680,102008,742,51930,19494,176108,44424,35123,13025,75685,11759,74335,22250,181453,131147,16984,132115,154311,11991,76452,52609,85351,196,30969,9198,74919,2529,56838,71779,29187,116304,3504,62330,41190,86153,28393,254926,104228,105189,13264,84359,3574,12415,8534,57147,10175,188174,59504,60932,66318,16407,107921,17638,99103,49278,28403,39786,145865,8462,3558,43406,142271,29139,21989,36552,93955,72365,7176,13556,106185,37957,321774,17782,129017,51154,27938,24952,1935,39366,2791,33489,41582,56078,24558,9311,5449,218786,27808,190429,68013,36020,86003,29735,3404,87348,119357,115714,2324,86796,81973,40992,43376,93621,28784,16808,36367,2517,2909,191926,24978,55303,53308,205724,60068,3098,21375,64784,23949,26579,63121,12319,80145,39967,97861,6757,70143,67642,37082,34698,69140,122883,46151,62187,80934,429,19437,135071,137885,222647,13331,154065,327,61778,74257,40116,37493,14855,85079,237641,42342,102164,199965,71204,4662,29368,5042,113914,122214,8955,13149,102503,43173,5659,163787,69003,307084,63392,171080,21390,81918,86666,36622,24126,28887,5736,28054,207170,163428,79891,346467,95363,38980,111806,80828,9200,19288,294896,114468,87405,111715,141705,7015,72754,68463,48738,243147,33397,101210,37051,98801,82847,20397,4940,185559,18716,54718,83491,11725,40803,1128,12128,23060,5174,7745,67007,46701,1571,27807,180186,256996,18975,16837,7877,212758,250379,15440,87954,57755,24719,124057,83461,258,50864,8874,29038,71289,31627,15429,9005,4061,113851,107716,82819,13651,79656,117851,17539,111446,12938,39724,190787,4352,15402,21070,62708,8539,23777,73853,13552,38810,86117,16285,56400,1718,75342,142863,29033,378,110113,180321,32586,23606,26393,160984,207987,23783,8406,16904,24596,47274,11693,46539,60524,78595,48423,31718,20170,9009,146268,15183,191060,172765,1349,138436,37365,10970,40509,225817,20021,70394,152138,21541,66559,66544,89352,2725,17258,91345,7313,3815,115868,8660,40362,4071,103524,39388,118275,21950,6549,38226,32754,209574,29201,43495,18028,20296,40597,18370,47520,202450,24134,2219,8195,69545,38041,136934,46374,19041,159811,84865,58620,846,98749,13569,30714,97246,32186,4479,27355,92973,35214,151491,75963,37631,1561,27200,238083,23182,60756,12291,25766,39355,102333,87362,65741,59906,19538,201575,48772,102938,24438,292580,39964,66366,9004,61379,50548,37622,38732,28379,68180,76622,17488,69849,5963,7219,48143,43413,55358,540,58691,29506,19245,52193,48621,5518,13048,118625,44755,191081,42061,89197,2259,60665,66994,71210,51232,3585,142096,55024,7892,8345,58653,463307,65658,64319,137941,136323,53499,12746,43492,6978,95163,29925,60175,5128,7352,41463,184756,121146,20473,18426,4598,5309,54580,14277,121151,10691,56711,43880,63409,76682,11830,172218,264898,32632,66536,81062,31649,25788,92774,60222,11100,63159,9432,224657,25240,53613,152,138620,163829,2397,85345,12501,37507,64932,38575,43522,65789,80198,78796,35226,3851,108891,73311,3060,28391,93671,39663,46142,30982,66041,37281,68157,26553,71872,81142,211527,39747,118119,22695,2859,11066,20232,168911,7933,197005,17066,111071,44434,133994,120798,12766,227798,45756,132852,29917,36076,55352,65281,129800,41958,18944,84678,18580,168093,132621,39997,54092,27740,32354,3770,114118,103242,43918,15899,18574,145944,3190,123469,219903,24169,100571,62403,16776,92779,14535,17168,16475,14304,37231,1712,28218,242754,61688,28980,1318,51359,222657,99200,67989,31772,23932,35351,201251,49041,27306,19128,40135,3986,77333,19649,120683,151927,21081,7076,78375,77501,101599,8011,89585,96715,58179,5378,102138,106793,26051,217276,4197,16297,27014,46721,13322,22806,5278,29629,70632,9647,71519,58818,40603,128530,8903,36770,56900,31483,26935,43845,34265,34920,87658,6114,84767,64250,47318,50720,19264,162514,33357,13117,6705,46696,75032,71054,87004,42035,69138,11903,99854,102328,19611,34525,69312,6431,49842,101600,133178,108751,41829,89939,225664,48916,99556,9195,130387,5960,36857,116724,53518,94002,39077,53996,6945,22261,64291,8314,152785,57588,16522,9091,5048,87671,35441,39509,1945,12423,158923,178413,37549,14095,1475,73188,62878,4819,24012,68534,42606,4010,120809,57497,59564,101758,103718,32701,80116,12345,95834,46918,21468,53213,15665,31200,3867,5140,96013,250744,21016,10069,13968,35449,180829,27683,39704,59956,22893,3115,26293,32785,75934,62445,141162,62720,2018,83638,19949,114012,95006,3330,99829,130935,309272,9565,55874,121727,37017,23586,319858,40970,27602,8625,112329,61060,100088,118525,25922,16232,1907,60671,51583,44553,80993,5262,94679,8676,940,20736,11823,3020,16476,12340,152600,97416,3703,25744,66826,16245,16876,46446,84798,74227,176020,45192,61955,75496,23946,23626,40372,26036,6149,11822,30582,16541,41914,82385,232823,40921,80773,14930,3631,7517,39619,4348,36180,126106,138939,62611,1477,113512,47321,25052,14546,118881,29060,23589,128322,36795,18401,137921,104699,267929,36194,172791,18113,4766,188215,30083,332586,94089,5805,77909,22194,68234,154976,43220,40660,70001,184893,138095,11128,103010,22663,5108,212615,8485,5565,49222,54614,26530,42639,16319,55062,152662,105595,21114,22216,10294,68158,10436,86950,7206,62115,3977,3657,59874,456,118617,18156,106663,112229,80992,17442,8217,55551,5133,34344,251927,51153,39364,201321,7816,66803,23057,156724,145664,14276,95705,979,2796,6875,13429,212525,50602,26276,28284,3424,19465,52397,46963,31420,51399,206476,92317,48851,637,100820,83349,10317,60227,21972,6908,282439,32857,224767,95629,83882,42106,87338,69757,29840,68709,37665,45244,114577,49188,175943,54009,186746,106158,70168,3358,234002,50555,9221,129338,9562,20118,32923,78479,118280,65752,4977,10474,102174,60947,129006,10570,83451,8598,8078,159367,123785,80438,16742,5905,5281,181513,42402,6977,163136,93179,42191,14968,50421,112401,105440,33456,57347,121611,4221,94954,36517,24046,27796,6255,33394,72990,135408,116627,1233,57874,25654,95419,68156,401399,313338,55208,45573,93124,119251,47200,38196,11909,130667,45391,73904,64964,167846,4137,115606,52036,62214,7969,160925,7187,1132,134835,40309,73195,64494,80472,444841,61111,26500,45323,40743,53625,52797,22659,15631,29739,36706,28841,39147,102836,26794,10536,14845,87305,45874,12241,127587,83833,57183,79722,30844,41304,84655,20825,92500,3722,25655,27811,10157,81634,31362,34088,92487,70123,22190,185100,72658,139035,192523,88241,2078,230490,44528,85638,100198,22088,29982,291233,241062,13865,4445,137791,37835,107218,31726,19718,38234,72528,23046,19177,66695,5109,17251,28077,5617,21554,47839,72425,133825,1486,73065,181275,141508,21768,62971,63082,2512,34200,9904,120309,6392,91243,68416,268253,41199,116757,138551,185526,41246,28986,4093,19057,17295,4148,245766,122360,35356,112075,20301,75441,10998,7977,19769,62922,937,63547,100196,26427,157820,20983,236696,22935,8140,90315,156004,47204,140973,7726,45097,52725,22636,23436,257282,105247,522,88389,216031,202204,46812,211666,19693,68828,81691,45925,11256,30292,372,5236,167826,88328,232776,151611,5360,82104,18841,80393,25465,18285,20320,72377,31730,33160,45803,38715,27705,37379,24163,18360,103586,4015,32305,269494,91252,20080,36567,54650,7797,57073,12650,31164,42209,6375,261663,105528,81661,106002,2800,5375,17247,43151,4442,15727,194619,100855,144898,62320,78465,39929,16454,1967,28311,61363,17219,9395,8745,121445,76939,80385,162380,22009,54191,44248,16299,122830,48151,74429,78291,64755,14238,44966,2511,17712,67954,93583,829,105899,49935,84750,11591,33185,85447,42717,27409,208542,28965,62052,52525,5597,25694,65594,16343,63224,276188,12475,9331,127507,38522,57287,24128,133161,79723,105548,133695,48917,27558,43278,46520,13778,141954,110785,83366,17715,46317,105763,66298,147013,41086,94180,16478,220447,44611,730,19722,78975,117889,125643,26254,16574,18480,65006,15806,38549,246418,46052,36056,8440,34984,30170,3163,59800,4458,115442,4283,41970,33507,104078,1653,22,121158,276486,3655,6338,24048,133421,23641,2161,24422,36006,8086,10675,181474,12307,29514,59143,14729,52509,87128,122470,19446,80852,33314,24573,119864,14237,9652,57779,6612,51851,15284,98871,90581,124466,156831,21190,22015,71380,161906,87247,69201,18392,17908,108470,72962,40719,14338,17911,95260,43339,20610,78916,20710,72451,11315,31448,17263,58853,178878,48111,116002,45497,80506,82605,85880,36300,121755,25215,36118,301929,88728,405223,276136,553,34704,212438,49970,78329,922,20711,25036,257130,38295,145369,18128,15385,30829,55656,48345,8012,3561,28004,122041,192900,58338,112508,41085,29976,87040,47117,23905,4336,92061,138880,97407,42083,172121,6256,25192,172671,5,93568,1420,12677,31605,56743,40620,6015,78415,231077,31298,80026,13902,19048,24924,170586,32955,176119,87859,36731,6773,27711,24658,26475,115216,133207,93250,95820,88522,8317,5714,124047,55219,86860,19677,23961,22928,162209,8904,225992,359835,56084,96201,29392,96558,86071,93643,55114,13347,8183,95129,82012,2017,123336,34219,115554,157159,47747,101684,41008,18735,193781,104151,226906,7552,179874,124113,31159,21162,44010,14771,51268,166128,31382,73124,77438,92830,205709,12113,1292,38937,13114,1334,2118,15597,69581,14449,21934,76618,48728,67038,14967,51495,24243,87736,147249,26720,11119,46063,43749,5843,44147,152629,133428,65703,14269,45604,57982,28672,55616,45957,8438,95433,37698,220862,132034,39456,61870,4161,26501,73560,56418,9845,4654,20916,10456,88920,119358,9015,65931,96507,48029,38534,21676,109081,43078,34943,25089,6131,28766,23665,5477,10255,16695,67,45778,42443,42770,29534,23733,100513,62617,42630,48746,14191,43753,50295,26007,8792,57243,43119,54725,164253,58250,112304,131796,25165,4651,3188,24831,47748,3705,19540,13211,102095,5593,18699,23666,32005,117571,33541,60584,74573,86311,99443,25172,27222,168938,7143,11853,53560,18834,19960,86522,28217,53266,117700,72989,34323,18721,66450,34346,74056,47217,202002,46269,9429,68582,75458,37823,82843,96652,32549,145144,27958,19820,158086,31955,201406,135379,31207,192545,12950,51704,9094,248263,76147,64028,110009,79407,89345,99284,223492,47966,26848,15359,201137,2861,110507,71231,72297,31851,118777,71039,151051,240855,16333,50766,14727,7939,4149,80908,418780,88378,59276,1327,7284,38576,79814,65820,42199,84860,49574,62596,12396,70598,40117,8648,7994,16836,7630,14047,359699,106878,525,29037,28064,13380,11675,50669,74216,103539,180314,27449,56299,172344,19274,7301,246099,32043,19422,36506,129317,6806,30140,4614,46639,66926,932,86600,6322,27847,233103,10541,39025,34887,3517,12972,26220,2031,66561,115015,48658,47596,12714,33845,3893,16165,35237,89983,14769,11962,147224,47018,29977,27979,5552,82338,86023,131368,1218,24853,237840,132193,15455,40873,3668,65351,53388,15229,59889,272245,47934,11858,34347,18038,90853,86981,300602,19343,114181,29362,84921,6095,106059,79472,38015,1206,48741,6208,8e4,21916,17423,6002,108083,24479,34931,56661,9511,26995,100694,163853,35997,81254,58321,18919,171890,86877,91341,74503,70477,53412,7027,59281,39892,131302,5864,15947,61301,67466,162369,47956,27874,35624,282324,21270,111847,102548,41482,30955,116737,28264,8592,55458,22301,75090,29821,30697,51709,3041,19208,8038,24634,30467,87509,126428,19389,18814,152686,20701,83474,45832,80891,105808,11378,153223,120770,98186,150633,49838,9141,12755,30962,5260,74490,21256,31678,65062,33326,289838,187831,20595,89768,2805,58535,10844,70085,12090,2451,138068,98544,24461,4511,6754,41684,28203,3383,65355,82833,30161,83924,234361,128424,28921,222594,33975,125491,34069,11508,67464,144226,41850,98703,34371,7901,21254,38398,65651,23549,53883,213340,123269,12028,71764,177701,28758,2623,68395,11549,15232,68603,9660,63116,36079,57093,31198,20475,48467,89984,35619,186847,107469,31389,43631,73867,41949,68841,114250,1605,30564,63403,17588,27680,99533,12641,70325,50428,73426,78379,11855,91651,72081,91720,60198,15743,12065,83398,140046,6761,46598,45900,5068,886,62448,148968,37347,19405,9680,15819,43496,63370,75667,163700,37639,3633,22774,34341,183131,134335,37200,23915,7054,14194,12970,26438,13350,285521,25594,8219,104410,91039,168804,138480,149734,15907,33818,61132,60082,4622,110187,56736,13551,73571,3945,73463,65498,17758,263266,17593,2710,27585,54469,38200,45367,63754,28881,3473,12791,98287,31895,65787,4463,94536,24951,36332,59901,28803,52130,86403,7668,181822,74831,18977,9850,177206,145485,109798,7292,31421,26280,77211,58511,12507,127004,11113,147,8729,56208,43066,79926,129937,31345,83947,39915,46146,98763,42566,1337,13192,18323,105163,80570,117753,16555,72883,11077,159438,40764,70933,83329,26066,12276,72059,21655,173836,126713,69454,153482,91585,70644,102558,110483,6764,127864,190133,3961,101798,20945,71138,82402,90884,69669,44753,923,16939,59700,164258,25969,27082,31399,43846,6306,246093,51342,6153,151581,202801,182731,56475,162188,89426,141356,14355,121815,27536,28023,65257,77523,106668,127314,24947,12790,38796,169698,23555,10725,44573,183083,42088,62716,43265,105958,32050,44067,50118,1668,3874,6243,318411,16599,1691,94999,52378,28671,216728,123258,2059,34969,69225,5913,136280,171443,141515,91662,22175,135282,80020,92270,1663,4808,4482,3495,34691,5226,109830,108512,17342,107488,11606,123190,100247,29666,146527,113014,15794,30894,13224,39585,243192,22351,9903,7836,47699,11078,25468,122291,48821,26780,122679,75521,81450,630,4895,92900,55074,74293,17441,3563,111657,103102,51613,12318,52370,36191,68245,34269,40445,41354,122901,168604,182500,62012,42557,11259,24428,115113,86345,12362,3909,78430,86852,134602,20459,47853,93879,22577,7659,3688,38555,13349,17381,56715,91639,12493,10895,92438,3142,37057,28928,2004,36427,32268,34222,209974,10432,67436,41989,173518,107930,27079,62729,30908,55558,5828,45031,14902,53546,8204,144263,60255,14520,88212,86582,109589,69356,8064,47449,8505,66558,16886,4844,52817,111260,215129,12941,91118,650,20770,6273,73089,40618,62790,2873,35002,14023,97208,19386,102646,36993,143736,135457,35385,113601,17893,32627,84439,100619,56016,6581,57264,172160,45452,111710,203627,70131,24100,322787,1996,35665,70078,22358,90922,83658,4097,63200,58499,14542,99153,52159,6615,12414,63415,31986,16823,1579,65405,137809,8841,16898,48082,259,33014,42375,12260,179850,73667,91389,98882,29532,17311,326251,41092,5928,20742,44964,48019,43505,9317,49265,6643,192712,48424,163487,19861,20113,70848,31928,105333,23685,78563,14638,54755,7158,24142,44018,20774,125255,20331,24280,10163,1285,2336,39851,4299,117269,46714,63816,87779,159624,11731,9971,990,137317,108831,50994,74554,162680,23640,131597,146962,170620,34829,91205,21184,1913,63616,18427,93136,156592,17519,67565,115882,138220,78622,88535,18115,2711,33554,109492,54298,971,24914,25863,36363,45715,27099,194995,14299,178181,111488,72395,322385,157719,130787,11897,81843,83999,11369,49280,118604,40922,61332,110343,53407,75639,40582,300440,54722,25637,13694,48248,48278,194521,56203,52779,48783,72627,10953,376,16733,280238,26351,230789,15132,25168,137270,3588,63704,73376,94031,74284,19443,159557,9697,39901,13351,119050,15406,146455,3460,29556,75195,37673,102524,92329,47289,98413,15311,100684,56345,7116,95480,11590,7200,167,23610,58426,17730,136656,27944,53151,2701,8824,103124,3017,90744,113588,53216,79736,65940,26931,498,29568,80540,143543,21292,1740,59268,16561,180816,42323,50174,40890,52866,10703,57169,4700,17191,4424,93511,49698,166650,26972,48631,165169,82879,69326,202970,4007,2376,231325,139592,22119,62851,37504,68816,58345,67398,186643,43331,277416,53749,15746,23102,17432,4793,151138,48822,54265,48203,198688,14305,54287,2291,18018,113378,123260,7180,97549,87027,120085,2920,76080,8190,102005,5641,64580,14955,59802,54028,58884,19367,81779,412567,85957,97053,103637,78871,29364,27637,141728,4767,30686,112738,130146,42745,12730,105040,14844,232,210944,36581,152317,135543,29744,3129,55647,58149,46319,27265,17499,28005,59948,7170,34138,5702,293047,110892,408,91760,218674,18469,46095,81403,14389,4610,35672,73060,11006,74848,104820,118143,190357,20043,105358,141735,5115,27093,45924,123073,52599,29433,9616,238350,78610,24851,58858,26769,31969,24613,18294,4982,32735,39639,143563,112073,202205,12567,4873,88601,44897,81503,101648,81362,34662,85277,17574,48173,21435,221188,40215,39576,80786,26544,64668,81841,10731,37733,247986,149188,127703,495,18382,54388,72446,43071,30974,198723,89608,41360,190,33045,8386,31658,19992,237838,119015,137622,50890,100913,6460,116233,267230,26621,104129,65114,14190,41542,14888,85962,23342,23041,26453,43725,71809,45186,4770,46452,53894,56616,221286,18973,9038,109299,55365,19366,26863,18808,60909,69353,41738,83463,12100,68561,72860,3980,13796,49340,12332,31311,27418,4255,53430,18976,45523,510,14224,30477,26581,4530,3651,101663,139840,22709,150861,31996,63923,120623,262522,3076,10528,2929,14672,130238,18087,9816,121894,100308,25085,55111,14565,18952,53293,2042,369988,23674,61789,133529,28783,108293,35477,47119,36448,71049,40015,33055,78598,198442,1833,159937,40654,77444,189245,113153,8621,18599,38553,35223,166072,2375,11659,21786,89523,6032,12116,63046,159398,18454,3678,32521,47626,11411,103527,38896,42946,15696,26370,10185,8413,37080,165583,4331,63555,14907,72220,50056,6623,62236,36565,49783,10049,17503,100581,55951,146244,24724,9626,17969,25524,109300,173965,99994,101056,46459,43647,53737,277968,8347,123521,74858,33829,44762,77574,877,81377,222525,123532,30602,43881,53145,2973,16284,81940,61281,127044,63620,9875,14756,114829,19032,9202,52759,119141,23928,120551,19607,3599,33401,76821,73233,117430,39968,36539,7071,5446,121735,194059,15206,45283,6706,15603,65615,1207,165723,92275,34773,104447,8396,32353,205240,164323,13600,60555,79205,25532,22907,33410,57480,107111,69630,32137,47832,70913,33161,20321,2371,117348,10714,86246,1625,11763,17900,268,78457,99175,97940,101092,86660,32221,14041,128504,125080,53744,124263,31017,13897,403,31859,21964,5633,111630,5547,77329,17961,18241,84995,25984,12983,67491,62168,47262,5241,297,51191,7351,8967,147212,82060,16821,782,11033,82431,62957,5026,43459,77963,203477,53528,6247,191852,87774,74164,215654,13467,1522,219964,28589,244104,16242,117821,67725,72570,156792,17186,15979,26990,44128,193014,35276,57125,16212,166451,68017,6905,77608,16364,53777,75921,76426,37975,26203,269296,64099,84122,12077,38533,830,4407,20139,963,43028,38902,42911,37503,83343,85045,16979,1165,60835,137387,58380,86990,110066,134540,56331,193845,81238,17922,163093,38744,110641,12502,56404,34862,26865,125964,12965,111648,25547,7771,27196,136980,9555,29551,107158,57885,18831,37705,35505,101742,13970,102109,62548,124657,23328,11124,89592,146376,248050,6241,22033,18337,80685,29898,11908,216623,67721,106162,146610,21377,15085,91552,42041,62560,122532,125336,102365,121537,142559,29693,223919,11515,110495,18776,22494,5895,185059,103592,229351,51220,100102,37027,257855,29359,54123,36066,106493,12244,79258,32002,432,56205,94836,90182,6726,14762,29391,48938,26864,38083,60364,3310,60192,14766,205567,57504,110760,22649,24666,46333,21517,3430,13135,28873,27052,158809,11597,20529,6695,23138,22960,37137,45574,6545,305877,43423,26153,24769,59844,14501,10430,134352,56169,13213,103432,49523,35181,13435,12408,129475,64620,230854,77390,51990,15653,83248,33466,44571,117828,51481,2187,10559,68019,18021,54895,48247,18354,33737,4554,108595,37288,39767,116707,9175,3726,108877,21616,83684,49862,1938,8543,276466,20134,108498,48770,102254,31914,131520,185291,100559,51890,209,19526,76471,50544,71814,99351,8172,198526,28816,20419,9109,98389,136777,76479,75596,30635,165417,48216,120220,25955,211071,39314,24308,32164,2559,146280,43403,9233,17947,90585,1786,86920,125662,2457,64741,32152,32918,122882,78538,44001,31723,56426,23375,103172,88177,145697,52506,49319,68016,31664,41488,18486,110400,7030,28241,986,109199,19900,42147,56864,65287,49183,7858,24e3,30453,840,16673,25907,68916,89927,6309,158335,36407,199737,130464,13137,59603,201778,195292,21015,42466,179062,172561,89492,11075,180407,31868,72493,20998,60217,9865,19530,39274,130266,54539,21623,12535,13505,40641,73375,4087,85633,2153,3117,70680,55788,92096,47509,98493,37490,271936,151475,3032,16171,96642,34106,78425,125761,19591,3366,19316,54508,24183,50786,194248,91528,33253,34622,108355,41741,705,3814,3883,108929,13203,67831,10142,59754,68208,29128,84820,56880,38794,24972,48571,40821,40476,18137,164254,24064,236309,79181,11282,395,39169,2013,51587,28551,9645,701,109513,115899,113566,12762,62045,58322,103726,41343,40866,244102,143816,2490,70346,40973,52618,15412,30720,104315,38917,42027,93676,17513,107418,20706,123890,13399,97727,24044,87962,65606,44250,98044,65276,74790,101473,19350,91570,1326,87790,172042,7577,100813,86896,85891,41512,108130,27794,14875,71431,12835,156250,58135,3759,22476,42176,115873,34686,56523,73643,108505,51491,20838,12721,32863,45700,29496,13700,34294,55360,29206,155942,123812,7706,163234,203,132720,49358,144431,8130,175788,35818,3270,76832,25710,54095,97274,28779,94621,74396,19092,128242,58067,20885,14670,93255,15107,63291,23654,126900,129421,59294,262659,9798,3251,67344,28600,44629,50672,29072,26999,31526,23183,49175,165843,175455,17282,175411,32022,45989,30298,90690,78118,83156,23749,35636,31317,7069,80381,94561,133756,14960,97404,6138,41065,78041,32843,16601,34123,9559,146529,123377,96395,54441,42012,84257,123541,10745,22139,106459,11720,150883,172651,154996,110538,4728,53447,25704,2009,71152,119354,21166,66604,1429,216162,8637,122250,63520,27180,29172,36124,276428,107787,77184,4680,14952,104903,24418,14793,51561,52931,8371,26342,48526,7118,92066,67280,40653,8847,34597,105438,14198,50163,61188,146286,50315,41205,170829,161496,585,197359,95056,1687,365794,91349,48507,5804,49263,5146,104902,96365,117343,132222,46084,96919,16875,8073,262381,79982,52663,13928,16056,153908,15145,109256,132308,18763,24904,167644,13618,40750,18686,147124,114709,150038,52849,2938,12568,48617,8778,5459,44202,44591,74914,17183,248689,13878,7822,80060,23116,194037,18487,2067,7798,43077,33678,244028,31320,74273,2794,19466,8218,36280,183997,48124,19416,29656,19280,98734,7715,18311,30701,133602,150307,126956,7378,2933,79903,13178,12593,86571,26604,92446,13574,44205,65699,427599,21118,8245,14407,27877,47936,33542,7916,26460,117762,21596,37818,2249,127359,209394,60044,47677,308089,36791,154971,31417,6998,150042,174360,12255,43009,29335,48739,3912,101398,53340,2580,146939,151295,45360,125275,15273,45383,27456,48761,23314,8750,60801,85823,104759,27894,123685,66968,39480,26917,55290,83305,2696,98390,57569,145853,340733,4919,20024,52268,30884,7413,203685,70989,112855,4129,50536,349518,68205,332641,159581,135361,236026,37563,176404,64899,6578,122033,63871,1850,85234,82089,66124,74145,121098,107351,12687,36881,117334,13136,14698,85933,93866,18047,32620,310,15094,46e3,88451,23632,36645,27940,87618,80520,58892,20976,27702,140090,96075,67841,103292,238964,87778,107338,17019,83427,67522,7302,8261,47570,116787,8730,80484,61772,174422,56005,131193,52875,14588,28471,59817,9586,15720,158155,51307,109734,15196,11025,59331,3884,52626,102602,84797,25158,27314,4437,20488,76214,189248,35023,114952,157376,2827,62439,102878,129749,36405,10329,109339,108633,36662,1254,13267,5470,87105,58004,15397,10434,159667,21864,52022,179464,3013,32147,31496,116832,18494,105502,129227,107267,50033,13481,9954,24267,22141,16257,116154,36185,950,115685,11305,176708,2048,178671,112573,287867,162328,497663,95170,50979,193861,50987,30368,136257,31830,46549,15119,169876,23788,17462,249887,57377,1949,35448,14791,43769,210091,3783,34612,282103,88380,245190,5457,20491,98908,11402,86899,117916,16028,162584,60644,320177,156096,31065,55876,22e3,77655,9992,23397,13757,317623,63978,215255,2443,17648,93231,27388,104529,93807,55505,140477,12046,112040,70887,40152,94365,112353,25063,114679,266061,71248,119555,15589,2244,617,14129,211431,70110,100652,7777,4383,85911,89221,21010,120615,58357,86405,37554,41647,18,15143,69662,60491,14714,186134,148344,42347,5410,168175,44535,42449,343894,129417,99682,20659,27272,140483,63455,222159,17536,13722,42637,62324,11976,114691,148109,2283,32057,182393,4295,147364,33705,2075,44303,30274,28331,63740,69740,29148,10346,44862,33716,73937,153333,12930,38784,247159,2515,41053,20256,83368,256189,54639,115240,5096,24661,175419,153552,26516,141,138176,63885,34115,47222,55709,2765,28479,38875,236608,12229,22921,77291,54426,45388,2860,57787,114579,295139,105782,17826,71066,19119,54364,69385,16568,12323,28057,33346,34919,124763,155533,101386,31644,8627,49001,303600,29868,63213,9103,77280,71333,9696,138789,37059,24823,5057,21352,32368,114208,56803,19424,10445,58514,8661,209508,26187,171838,10460,63454,14016,122504,41328,21329,46618,32493,38225,7855,31763,7945,29876,8734,6438,24205,97490,139977,130740,47323,33195,85390,57194,13813,60600,21313,96251,7699,27584,170521,139271,1363,4402,336738,129223,84983,69150,13147,3590,163929,207225,155260,55916,20288,4503,8398,98490,11773,27512,37113,84976,86558,28365,11756,116005,182148,13733,115313,47644,67208,85069,9347,14995,226141,14704,101835,41159,35314,13113,63526,214039,29978,50446,83339,17440,129441,72522,118641,97816,24907,73844,15717,118884,167255,96509,162793,30847,36849,51297,78974,77793,10427,1873,2972,9999,35074,28190,64297,146836,46298,60038,163007,108919,61219,2403,75022,127339,4233,110389,69022,9833,128097,88016,79390,222936,22570,94657,28462,56956,38803,81536,30474,152794,19566,16481,147408,74574,81895,20731,1918,1366,76367,187321,54494,24366,21690,61696,33283,107477,77499,31112,414383,74362,18463,218441,120929,59848,258629,201924,69269,454,19989,13054,59894,3623,58908,20681,35723,78523,102680,38988,184112,108087,50944,132704,52966,21699,18860,96349,201411,82697,85395,95658,5093,6427,177894,44191,32755,26961,155739,6249,31310,81030,26574,84311,120155,86730,113535,7424,48888,13516,45747,98098,20077,183995,81945,43210,26704,40420,75831,45648,11180,6855,57927,65528,124096,34851,2598,156633,107572,127352,38169,123845,60142,62722,105584,232364,23211,68120,1601,22169,89299,747,258039,80572,7258,152249,11862,101204,8834,121434,33761,19175,133142,46343,40178,48723,3589,41977,30210,38868,62257,10087,82658,87827,90646,16415,47552,351723,28298,72225,91146,272760,1701,11295,1652,109651,300747,51863,198800,29446,11794,32345,37538,22356,33102,37590,113544,37970,11478,179743,25454,103417,59905,221970,105196,145604,7817,164809,102360,16974,75840,255333,56902,6659,1954,645,59400,67769,7689,18675,5215,13793,20536,27852,3387,29523,259718,16860,94625,43143,29245,15848,233581,22685,63631,78557,22836,133302,84513,1348,51826,47129,98836,58284,1830,1749,94642,10933,6145,12506,10975,13879,103781,144434,10268,28409,32346,52968,121567,107374,77268,23686,35097,10501,155275,15303,47136,21102,168741,55332,90385,15996,84817,681,137803,25054,142275,6163,38175,8056,124296,240642,65621,4934,178205,16101,62803,60964,18230,100622,76465,44689,14545,9543,47514,16852,93380,28048,12047,107106,37575,101485,77047,57326,34819,96137,76916,6469,46264,115983,75768,87668,69942,13027,165,8373,114231,26434,52844,42799,182044,23580,146254,38081,43236,33883,146220,382894,14606,46035,36481,166621,35417,95382,2957,59384,60428,36358,66343,75378,22267,22950,83528,17577,56474,25285,4619,179691,75355,95836,53295,34588,171410,4487,14679,84208,44015,18562,109133,54101,11531,86052,174479,303157,28095,9953,35642,14564,39802,16145,77606,117406,53038,121117,53624,22062,1212,7632,127157,237292,189087,10478,127345,102515,181997,86752,87623,10966,121602,68783,68681,83042,114380,138349,191305,67176,50085,39016,1427,42384,1412,67118,122616,72389,25260,2237,13576,137346,19938,20304,2191,68759,5373,61364,238507,75814,23931,69565,38993,131741,38364,12528,87762,5679,129853,5310,186831,32653,90338,260176,389531,108118,26843,43985,50175,30563,25106,56965,18130,140428,4542,165503,117991,24219,229605,1819,129663,1240,3797,76093,18398,71339,51919,93043,27175,47060,216257,6483,35051,1217,16512,80798,129064,13225,69339,8548,237079,72298,2575,34280,51379,117910,55671,53345,247552,29486,39328,140821,34681,57045,60177,5004,90269,78522,2479,322607,48474,61296,13057,31558,4678,59271,6699,27044,31988,35944,12503,83480,4389,136508,3781,114121,70279,4488,155829,42214,2898,68191,75695,305850,45041,74344,106509,30087,17429,93292,12477,290,23080,114802,35714,18751,26554,105424,17775,2144,2412,100610,65192,113975,52975,180272,135050,129815,76238,106483,21440,63186,4260,46189,9711,28249,4169,23429,23390,8324,141585,63809,67668,38457,38063,39226,59972,1189,203916,62368,14403,16949,61767,85801,1739,40147,35049,76757,33124,62102,15780,103593,103009,53484,22952,67973,114645,6566,5245,50462,7601,8288,3513,194571,80276,1908,54592,5124,58571,2513,6800,273997,193904,1119,17991,117245,2508,129156,82366,26278,71465,63341,56943,39662,106116,94966,156875,9736,2204,122308,94418,27134,1280,24539,49022,45314,3764,50904,46424,30699,28087,293839,9400,33646,40165,822,147499,50263,116179,29085,11863,31314,5578,17797,5104,12454,1604,15342,219206,10232,67800,94261,25872,13565,90339,78971,75377,26649,41184,47695,11514,35369,20767,14227,41953,309396,148270,147938,33074,14453,27499,109019,39018,25738,240196,158931,52820,8612,95853,21524,137010,84901,70869,70021,116794,48404,38771,6732,1070,70990,187297,49140,5238,576,3564,253975,16027,16483,2811,37775,19034,25259,4053,2e3,70083,95774,19713,33431,92703,91314,42381,288770,48194,95985,3991,77418,13406,241328,245086,56533,35275,62725,9246,51924,70181,95331,16163,31410,79016,39312,120878,119371,275987,80124,27712,9186,220,23598,146167,85209,68238,282190,57048,31273,30555,80913,17594,75779,59160,135002,101219,189377,29225,96735,60126,62522,104e3,27620,86814,17240,147533,11001,5425,43682,410,49460,87270,69480,46315,59448,1816,76201,9431,11788,87960,29063,65539,47347,11678,33846,7008,196704,9895,6753,8633,120892,59970,572824,115934,6646,202559,892,48351,37611,251282,57823,67263,57750,26527,34485,90747,7685,88370,6144,64182,1709,41969,21458,62327,181657,49247,225330,122600,114574,107124,85361,111833,63243,71420,15655,191178,72430,18063,51425,54002,12364,53225,86557,18193,97580,41232,138398,67821,128724,8944,233212,101353,52099,42127,14006,120107,32789,32132,3498,18123,33758,56058,5779,128760,59888,98869,18445,84702,51911,13234,218379,20093,39031,8074,70195,20708,23462,24355,131384,60189,26390,10403,41060,7140,10781,49410,42261,87202,82566,41663,43105,60276,2768,5733,74176,28329,2297,145430,131632,83615,122915,105441,655,224102,5284,136426,67763,16294,188511,32538,61049,27893,3394,13951,159099,28542,17930,145360,9492,190122,32285,78855,26440,13570,58648,73908,4239,124561,2444,74172,53131,11468,10794,73566,11623,35343,64710,30481,4163,10328,38309,29901,10538,154377,76132,92405,24839,11679,3465,13449,11637,7824,2337,57754,1260,14458,41118,19878,38661,13416,159180,37074,163164,54137,28627,52134,184900,8520,40385,29546,30502,22386,66527,107458,6850,24022,47983,30603,35083,8934,304066,39500,9,28261,33026,77251,9374,44833,116312,34990,29236,63563,125639,135405,165398,159055,55690,88141,69643,236964,31983,25572,20436,36746,60896,31850,16179,11828,5888,3043,66368,9750,31167,7915,53111,36430,1333,64344,93659,20061,60596,180191,51630,6792,30244,43509,101058,22409,420,44210,109783,43223,27030,72477,72831,32679,29235,7675,47556,12258,39907,149412,84926,118247,24692,71717,105038,86009,45941,41189,89453,29856,52543,30627,226798,67303,59230,67415,34408,1367,99685,16867,128419,52147,4111,125381,117881,16173,44093,102224,31575,23234,24870,83790,127407,239098,3200,994,1255,100903,242275,117266,55116,38205,16140,29662,11307,40414,208793,123355,56470,4862,75600,30119,58218,70828,24075,26974,7802,192353,4851,5475,78720,66596,3409,28573,64396,30381,30690,59859,88256,5406,99945,103064,34463,37727,24238,86643,60088,4057,23741,5967,162904,38240,28356,93858,25510,122879,6897,3278,7057,11971,4400,35461,211413,21395,59615,39471,87233,55795,128426,3051,22470,41950,14705,3974,180108,80476,78442,204996,91987,15634,67610,139015,142373,35611,51134,10387,4353,153456,57749,181039,14183,68447,151532,21107,36452,20551,3186,46247,46383,129666,88736,140662,146243,2066,8360,7978,64818,106963,17896,47801,10723,114821,223295,74192,3293,3393,16987,74064,11277,91622,4270,29828,27951,387869,103235,1374,61988,120083,477,145892,128378,11779,211263,61354,18221,17869,46530,83061,108538,157981,90608,67199,95080,49064,195814,12302,66307,10348,231346,160732,112859,63633,146558,21271,31037,198802,47622,12862,95710,3910,77850,73961,85585,34752,61e3,4082,24595,103679,71107,8208,79568,150019,16615,24961,139857,32664,197366,4559,54735,32696,4126,162019,75698,13916,70108,159638,19834,9349,24675,175560,49643,18206,52459,27992,10809,88865,401975,133172,29e3,34558,30915,3658,25834,42430,36562,125265,18182,10155,40149,97082,208980,19575,60853,90529,66545,9600,789,46420,2317,88593,55595,98980,115302,5742,169155,1073,177901,3472,11189,63711,78643,65472,50459,127979,93,42202,67053,21720,157650,11145,141378,42033,22824,85705,79114,35584,15974,1510,54172,28562,12451,104226,19190,97151,73024,20948,5151,81741,21499,29006,84183,198074,54003,45120,170125,26240,35177,28389,64863,79974,60778,176915,232183,45342,2038,80253,41564,40703,32689,5430,100689,5366,23007,134279,14266,26712,73993,24934,64242,52113,102887,61801,46415,201049,54251,62133,122757,164883,30815,139966,2319,30842,766,13362,10287,134518,86111,81665,82440,28333,43019,18963,8804,161944,23439,102144,101145,80029,39052,248708,30350,117340,11878,128467,974,138625,63961,5237,74778,61834,67040,43814,13690,65947,33809,232476,115258,181745,28824,94013,9510,10246,93722,81976,7217,114383,3493,16014,69045,72692,12145,80981,9507,6692,1620,60820,330444,35474,33962,4797,7053,295463,46445,27026,12491,77988,49524,35675,90947,29114,166705,101385,133782,32704,6186,84595,176031,185623,45966,151302,63069,1699,107491,947,15458,74452,196212,6046,10498,12163,10239,35191,243951,9277,9090,29539,54460,22820,26514,112549,60372,51753,48756,21812,70861,260326,41,44222,10441,16961,48148,138771,216194,5914,52153,53400,212036,56519,26245,10117,45888,15294,138019,90913,26368,43842,42111,23348,6082,194845,161089,156206,51546,11647,30759,302912,262094,8635,78876,26535,35283,54183,31183,85484,147873,12989,5197,6356,72894,65347,20150,27370,73787,1493,45918,12366,190217,20724,13858,10981,67449,81213,7553,14115,72242,271517,11842,48310,88743,143726,22177,3290,243231,58452,62937,12592,1654,40066,33477,13751,9921,128442,15868,7106,75236,83773,10775,36938,10482,170465,17368,17469,161508,32752,98340,800,19824,264456,3901,87319,2867,26782,9630,113102,185815,24197,44584,86366,40224,3636,140916,31731,267731,9567,53678,72984,29389,27963,17106,50282,284911,60170,8322,12608,23374,89652,5268,39044,229766,8869,151350,31436,177342,12269,183212,120418,116270,2843,78888,69192,7865,184099,1086,129897,18383,70508,20242,18508,229924,124569,35749,50589,55626,9884,83115,40971,30671,18135,14452,38861,17844,201826,5549,26413,17189,13561,38539,10679,143331,3314,36785,171194,49685,187713,67506,4618,104039,17060,195080,50648,33159,19238,67559,134840,28599,157523,17130,38064,117398,94355,31918,13575,34538,40326,13997,3494,348283,62481,26862,3603,104426,244363,153709,112487,304612,199674,41239,35545,54869,293005,28223,26277,26899,4533,18518,15492,38587,80488,70485,160395,263,60162,11382,222152,4696,250751,51921,182609,10707,48463,46243,1227,49111,111564,46502,33342,56846,68541,63559,858,139927,16654,229375,76759,26478,33205,95828,23399,92945,2637,35630,28470,143992,50214,14174,21456,166191,65665,1711,21594,78019,97599,111701,36,147151,110246,189022,43021,30397,40757,131935,42065,73335,48039,26596,28984,15102,2361,7421,202167,69744,43766,52826,3642,83304,33873,75140,63169,192389,36551,92748,13039,123959,233220,21738,84447,77230,20228,187852,19095,25799,92136,108774,29237,53947,2299,118106,2687,8830,42331,202924,33667,2023,73763,30704,19363,19779,16737,35629,48081,24068,101013,162338,291912,13749,24745,328289,167679,70086,48299,23306,16732,17801,43322,54589,3586,63653,43624,53474,925,109177,251316,43805,13082,19511,86565,142182,92461,17117,101033,103319,64589,4022,4351,235897,5352,82705,107142,46391,156084,5860,61365,10558,13045,7717,18357,33922,12590,33065,6928,46993,783,46937,67846,8952,26295,6107,119656,18799,17458,50747,4229,179559,112727,118080,20683,41464,125468,51560,49749,44231,7359,35339,62988,136487,67015,5208,29150,24956,105186,48858,6143,18097,6972,16404,73489,58742,97196,36357,164616,5834,32267,13746,147733,15113,132091,34127,106298,39729,106426,22294,9780,15602,36213,71502,42808,66802,599,60755,5851,39120,67363,108623,126368,72770,91263,32486,30596,151717,7951,52002,43103,11768,68942,40901,39344,24037,127500,116890,48403,16926,86750,17745,48648,159545,34460,58419,5634,114317,67865,31462,23352,24010,98185,125708,69686,68337,13610,26271,70691,2980,4768,27225,102402,75453,28106,8104,6931,1176,6274,6475,112635,22498,6176,238686,26832,28893,90319,14441,15682,15087,39517,45270,109134,104440,45965,47645,81772,7876,52683,87720,12898,4505,185665,2769,113401,15664,57592,105229,137381,97059,119268,6876,43309,33886,128363,35476,144249,67013,143587,83367,25703,91436,59347,53236,2289,16519,19844,46309,58558,99834,23313,218816,231303,36388,51333,183535,109792,139277,54306,90139,18235,8275,32710,37677,82464,86025,92204,88842,117723,37570,128723,234242,76350,73795,34896,148247,58424,11105,11744,45746,63372,17118,49772,199520,81902,38004,22911,33752,3125,1995,53792,4689,26909,108150,146062,69674,41811,161444,84855,8999,28561,16731,93937,3189,21967,24890,22943,1356,145300,51569,28802,517,118679,31703,40607,48098,108854,25003,10233,73969,177495,5248,24516,215347,146192,48712,60626,69188,40735,5866,586,101541,6509,47590,52129,5969,222045,110933,25733,24223,65339,62812,2414,155418,35819,16022,78423,43138,20995,128255,240673,46745,236093,72176,57085,97841,61248,107,36068,193177,105427,55726,215229,20446,47228,100420,87091,14429,121708,23605,21157,187721,21880,2997,203976,99166,95068,25877,7724,98925,83401,4829,13182,18229,13718,239662,38653,116505,153497,30589,89029,38962,181302,43853,78872,180301,4786,248240,7401,106136,112590,77745,19731,60880,77789,125748,135487,5975,48627,34084,12419,215770,47557,254582,10364,106495,21856,67539,88981,38805,21428,48732,42316,12149,16078,52808,25327,51322,33850,51147,12253,122354,46077,56483,254553,115417,81834,150991,94662,86668,7381,12841,100650,18218,15741,22372,68294,50705,15535,84660,61887,22553,72299,31361,24824,17743,46820,64288,31582,77006,111674,116384,30760,80920,86149,77192,51979,79691,60342,122805,103800,240873,160744,233114,78962,54920,8608,3484,316104,72548,24337,5088,230040,21926,10172,36838,26,86221,83458,102176,12062,17571,41929,41170,28428,68239,41750,103930,2634,18313,53019,34825,97837,63115,24606,73157,152474,14715,91439,37033,109806,140259,30668,174760,380,135597,95673,136073,65073,134249,13829,17279,122305,4420,46444,10237,64848,203623,70728,10349,182885,65075,24519,25783,40318,34139,22222,63394,55266,102764,41422,20126,65100,90408,53640,35128,48932,11192,38935,96839,34782,39492,19396,41332,6250,5511,19492,51304,25936,104466,54099,73771,86115,5080,7669,30891,111700,13931,25276,72289,135447,14820,258641,25265,31005,281179,75286,393,95359,14623,13584,6680,101227,80173,44933,76666,54542,13244,39348,458,25379,109451,134348,81143,6959,65554,12027,51311,8716,57589,140731,28467,23316,17272,30458,25980,55229,77197,83798,28302,114784,7428,34548,26241,14712,39336,103304,18928,54080,12870,334,87722,15208,16895,142098,114262,39820,83913,57817,28682,7721,14900,108672,11250,62246,42849,415188,1724,26555,24549,25505,26443,107450,145899,61035,43528,6901,60726,65906,267741,21338,147590,42079,18924,73017,135236,15393,5206,4026,84185,1531,5988,113890,82647,303391,7386,69844,71611,189865,76523,31877,13315,19314,198575,32821,1928,67641,25913,104475,103489,3297,70391,18406,15446,113347,19295,93790,27856,1792,167471,116449,8541,4408,41757,63233,25765,86680,64501,27034,24816,34975,6079,4486,49693,36229,16917,21581,62426,27862,11612,54284,35702,194034,355,24277,48262,87411,70504,310164,118018,12516,47559,43502,57433,107139,9290,66533,80863,14634,34312,91725,28606,21342,67241,72355,43244,375789,37402,174015,105070,8342,44167,67494,1890,16365,11723,271002,1865,47918,8350,45564,27742,25110,125803,8553,49504,81925,62211,4534,15491,19011,80373,206920,667,102405,128623,245524,5553,113309,192739,65766,19567,22832,261958,29679,21293,71134,20962,105123,24721,860,21752,33448,18372,157167,94822,35770,173224,232737,75729,28937,46828,28062,25453,5207,140366,36665,30652,6169,67920,150458,92040,23186,184604,92330,20891,176492,49427,27828,38305,42495,143982,49560,25503,90043,29747,65328,47830,12932,11068,77721,9003,25213,94205,140426,46090,89945,138173,192691,33329,112232,129905,35709,27514,1841,19957,31411,127476,53572,17497,173549,55063,175135,19841,69314,5192,237921,117660,150697,4060,273045,50414,98940,65348,153665,164423,58804,156695,48994,213928,86036,28608,8355,39574,34540,16927,135680,18374,151587,10830,53805,16878,16623,4282,48030,8537,14986,46102,13062,72897,72,33050,108227,39451,45935,651,113320,40535,95176,57450,48843,5003,19019,10407,211163,3848,1068,4988,32091,30095,41692,15099,43602,107434,50744,7627,171349,16313,150832,352665,207750,33937,38256,51091,156e3,87889,90663,84175,24908,114900,50365,31494,83829,5398,169342,47521,54818,18935,8356,43094,41212,174536,10082,92550,6678,60614,23355,69721,14796,34149,128830,58187,3179,208,40325,28399,225029,401412,51150,31580,207268,6657,10993,69818,64282,289845,23308,12961,38447,6681,52944,31855,2572,47646,120728,179148,37240,45196,218274,4816,3695,21961,50084,35209,18073,51452,27004,6100,33941,1377,84831,171214,85,141510,9078,99227,32610,6417,11718,49868,65579,87902,73018,49062,46280,61742,21512,40862,107733,15941,29168,157765,144919,14487,5767,158014,140070,7241,573,71584,16921,223566,40331,179473,35081,47926,140885,41508,52104,59180,42310,32811,29048,123517,102413,80208,10104,14746,12649,153641,126022,37965,113017,4171,83,142592,2809,6362,50416,71323,116894,260776,16204,1524,5760,30351,12658,20703,54403,36083,45408,74772,4946,14485,50759,111222,10890,2195,167147,92962,130534,16283,177256,35016,15472,210156,151187,73922,117691,43250,52051,37392,24811,24358,30830,5775,818,21969,1476,127322,151783,58392,31021,106913,65215,89407,90802,28531,11690,20234,95249,44602,37256,18707,11928,5161,4410,26571,51903,49768,22008,25252,65780,209499,68769,203726,13249,137363,48845,86823,6658,5674,31881,1083,1823,108676,34518,166752,13791,14287,91576,91429,8665,11529,26401,16191,91972,30964,5254,28486,54697,79613,66520,18447,22870,45203,194466,22822,51703,12278,76716,44595,73455,33546,12235,144843,36154,51247,11116,33040,3180,225753,60864,1972,28469,12891,28879,10338,144157,56294,353058,38302,41447,87532,110616,27065,168438,6557,1213,50804,144643,24817,2390,136531,38174,247513,16190,4059,122791,131994,137430,39506,57650,16305,5188,54309,106128,20628,88071,67394,395446,250285,66176,91254,1399,114196,43915,60230,44853,27206,106353,43013,18733,345105,226453,51202,16607,57106,117175,35492,10476,89598,127439,15187,39624,13688,61570,10615,31111,59370,6238,175252,32143,224492,41388,95408,34384,148238,78307,38959,9340,160091,61443,15737,11216,41244,170,38299,102443,113097,26382,14027,33707,3957,76300,66160,19431,18900,6952,1717,108656,82206,188021,257335,27295,43999,41210,31777,46956,57457,12657,11489,15697,48060,204748,53583,82422,284790,30503,137341,8120,19615,220311,15991,10217,63424,9808,67431,70976,98221,4491,15177,28535,144789,751,13230,2394,1504,33977,132104,30316,22230,931,97193,185240,24826,22687,174322,15307,22988,1390,188745,180325,29580,59068,74903,18994,29195,79,15436,7622,38462,11566,138710,44828,45774,37768,99236,68137,84083,19282,22698,17134,74807,126662,173497,46248,16938,119735,3212,28292,213652,49013,9975,32180,45660,86250,4801,68788,95490,77482,113751,11994,44624,94452,46839,128497,100316,5798,58588,73184,202987,65417,37790,88524,1606,43156,97964,105717,34947,11203,100060,37742,130074,93653,107799,94311,196106,41347,8035,10780,16390,27883,118236,167395,1979,25006,19375,31628,18916,144723,78502,114047,103107,86492,107686,5844,20934,206963,23556,22591,16562,146333,20167,10471,117434,33085,2863,9740,36669,41849,37271,22790,18209,28979,8231,12952,54408,21731,25130,45208,55748,138120,75826,414,29593,9925,292865,25999,683,123149,7036,92159,86055,61827,103680,23176,54918,58466,57578,13305,5709,86479,16697,31064,17660,200919,10770,49793,33423,32370,52047,16488,62555,6459,8426,83493,7763,59725,82812,18628,67760,79405,68557,9612,7673,28102,56517,69620,171797,32458,29541,15870,81109,32080,207644,71495,21202,11039,91036,61230,2810,130800,32260,4613,60590,37112,75214,33979,126402,155062,30642,63875,12810,194463,82799,47664,16725,36685,43367,61099,449,172150,102867,21691,301838,36745,7130,18671,57316,34852,38034,54182,35578,65900,99486,19771,3456,2658,16914,99866,28390,28109,8262,21147,34353,20006,4228,137085,1675,203023,283196,198286,214375,163329,290603,152574,40471,83506,30068,14730,23177,131539,34759,27668,32178,71896,104799,116305,85430,119262,42860,25160,8911,23428,49437,105322,6519,16203,6349,74711,1230,38045,8540,75165,44736,25909,51026,317034,4984,32281,91312,27060,44431,17817,45363,155937,239085,35697,59784,91993,29531,126740,213757,76560,167776,285273,24262,8237,65030,41160,74437,48804,118916,13159,37842,1031,75349,1478,11655,108777,23435,277425,101734,67469,70231,124711,43532,28514,65526,54956,1e3,21882,17728,25302,40952,52214,149632,1999,2111,3259,63362,89961,220561,39777,26335,9063,10572,12416,34551,34623,38604,24723,5947,15588,69927,66252,119177,69173,46629,28714,70715,212408,20521,406913,74380,11716,50659,50862,37009,88460,130101,7210,53853,538,65120,151950,55806,163748,52837,13153,21100,16674,64536,6091,138201,44837,58547,3723,163,2177,32288,85454,34033,8497,14282,25742,10535,10741,79559,117493,243787,49337,100718,79495,40139,42956,7551,55433,15421,31509,23034,45081,547,61176,53434,328001,8470,36263,30145,4519,74173,53935,11845,73774,60211,78025,3,4102,73782,109293,315332,48412,26683,13714,6865,20128,18490,104141,325,39470,171970,115860,15707,7268,73301,74336,31370,2368,111827,107757,136231,142844,97138,96638,84053,38691,23801,1588,10573,122098,77039,240,186135,146101,11996,18143,112963,46171,155836,348769,47795,121213,116266,132515,3344,144804,31286,99187,255838,129694,35894,48779,55235,148582,71967,65282,15174,13920,47080,6147,108242,157593,125025,7136,1286,28957,127956,28402,98813,20805,7532,109417,40610,5041,32958,15142,18408,108596,33543,50517,27748,80114,233434,91447,487,37094,100048,30541,43477,10639,89862,155868,37667,8726,60684,237903,73408,99589,12190,38739,97348,3914,13594,2680,149016,13907,30171,28343,23530,115225,61104,35821,147679,14337,4297,244282,24085,326976,56428,7851,21303,131620,71446,83253,68692,111870,5224,15813,38197,49026,45057,13660,3306,76345,40671,27905,91072,996,68527,62085,91351,122634,55109,168209,2024,27560,112707,17352,8306,167115,169921,166958,5031,46020,11844,67284,19130,76185,6920,32849,5450,14610,22451,21002,17392,31872,66682,84796,13709,40210,59898,12029,8719,53564,21462,91884,21647,88379,194428,12754,37797,132826,160016,22567,54383,53186,77611,31107,8339,4694,19185,90355,23597,17222,140675,28442,23668,55977,9128,61555,28774,155229,17658,9390,24379,69357,15752,127381,239631,62460,93181,55913,45133,140155,18676,25249,33164,29581,82837,67223,22362,29975,7317,52813,1943,29613,20012,207130,49617,49651,5636,15334,36313,29226,28084,95247,72072,19e3,224932,15811,114,32127,38097,37508,88507,37225,27359,91626,12193,69279,20608,11055,88156,92808,2152,57259,55275,72789,24475,104414,1708,9882,3818,48661,66897,1631,34806,227930,85815,87753,18321,250664,72733,25107,206797,50891,8082,196411,92596,96764,152823,65514,22819,387277,62176,51225,40329,15563,189,3659,73670,64357,51793,275136,33482,86653,74615,67058,11318,125720,15388,22388,8267,1730,102663,170910,40784,7144,85373,13040,7088,94309,583,44224,140424,77439,18496,164026,36578,4722,9151,5824,63365,26510,35199,40500,79277,32495,44614,35233,9566,203293,152144,7097,2330,183480,98629,13423,330887,44130,68600,30939,97829,31012,345465,56747,94879,4939,160027,149761,99423,46099,32251,15332,8761,96094,128555,5763,235318,222223,55729,30241,55420,201746,3987,81382,8259,49325,23287,7719,24633,251100,92311,18591,110533,64759,170260,393860,7175,21144,132887,3593,75346,101277,91109,16387,259187,11627,57459,173829,44694,55780,49797,89192,120443,62622,3904,14814,23887,1027,112258,64955,99800,11132,66353,36202,48624,18158,88481,96882,43059,11040,2455,7077,21651,181159,99126,100434,61388,68186,19161,110468,120052,8819,55324,41494,7014,37689,3618,87729,92615,207943,9823,128657,12587,15857,6379,67628,51216,71775,157617,63244,1503,3864,218754,110864,5769,21492,7243,1192,87921,85529,31512,18537,42698,35350,73510,84474,34301,8991,21013,35034,566,38832,19838,35586,37216,39413,55006,12178,59742,856,84563,6900,25632,17437,49786,30723,13847,70845,4044,7843,23944,235976,55530,48942,6518,20939,73769,192653,52936,95207,23895,132542,142982,22632,87452,48042,54018,178468,10728,26230,23559,363,81269,142012,5718,346258,31456,84333,246476,51018,66692,101804,120570,39962,30373,70593,2864,60541,19425,54209,104092,7201,31545,48018,25865,15442,46257,40443,8328,6451,111782,47527,97754,33046,470,245116,31095,39,91934,87208,73470,36708,36521,12801,70624,36272,8892,79768,12427,55454,103756,5908,52390,62962,22720,141138,94634,41689,128402,126390,6628,106394,35527,134394,82727,254651,194502,148064,89549,3202,28359,957,21954,27906,49840,142747,8307,24206,48978,1186,71728,133038,71474,91306,6333,110959,74600,70387,18983,62609,56057,22970,1147,135850,1321,28834,3578,59715,102227,32827,81415,99952,55636,257598,390,22702,35701,85872,402916,39216,189795,14929,19467,10112,144422,61514,5279,63421,134686,41436,8424,51925,10598,132295,124416,4604,194739,210929,57866,31829,51626,50007,9976,91878,61906,56168,81906,60918,61859,40017,23059,16887,40927,62064,12785,32893,32913,21782,93965,20169,44387,79084,38463,11457,93950,27127,157050,2697,337088,5116,54128,48255,33279,8821,27352,25515,124022,65710,28906,38557,33390,1722,104435,72215,38551,12094,30978,25113,6671,37355,175109,42862,98024,65406,221276,59624,118012,64637,78760,86697,21426,1639,40350,12584,67193,84144,31396,7863,143011,69629,63112,9454,28666,65798,46372,134721,6314,51402,30837,151922,2847,38676,38008,92823,136245,17540,5504,109295,205242,37606,5211,214892,1586,20670,208711,137743,19328,40652,16995,20023,14657,154919,34422,12996,13918,38221,47690,16398,2959,37680,89122,6721,198469,91876,172043,83898,101992,26084,94570,3635,76958,22853,76497,38266,176590,168403,44464,142840,79180,184594,1984,41806,83147,11985,6546,366068,59732,24533,271505,8736,39084,222992,93429,28962,58985,86665,8432,30028,14548,32439,54424,165029,55175,27458,69046,121277,46168,33732,20661,24581,135574,123110,37556,79260,72611,16957,12939,46162,58238,44907,72936,253758,41324,32518,96480,11949,124438,65280,43256,34107,53533,43531,37037,28366,45970,32741,173438,6121,194202,62969,26355,30314,58370,28455,1848,50519,82830,90393,21761,295490,10936,256940,133568,44050,20269,4089,27457,21610,219460,36743,14821,101388,52005,13124,30979,140816,167362,26054,18458,60789,34917,40447,26606,33422,9066,3452,83614,5761,20263,137238,25038,91310,101,52322,74548,42572,38084,214054,186568,31802,17665,30620,141936,37730,14420,4265,187218,49640,188208,51441,55388,96452,66659,40869,42039,60967,221027,19234,178581,29105,96050,9165,196118,157335,3738,40354,117436,2965,34136,59659,15570,50843,230035,31444,71260,43886,18316,5387,38500,168508,17406,32174,8828,103373,143806,90367,3560,18719,122310,16508,26719,2541,105429,6645,37998,73190,10591,235916,49737,87112,233941,53188,32193,79154,4544,52905,126477,7580,63501,57314,3216,31337,6541,103083,60846,49,9756,15481,1355,43840,14319,13743,27486,10222,73114,230718,418644,16706,6674,279748,23058,45273,295831,86306,2743,5535,88773,21829,35253,120938,31153,3169,16839,42847,8751,80974,33942,36867,35514,16485,26474,77775,56877,5391,48346,3882,108713,31403,27804,55248,26235,43821,136104,40118,175507,28034,203908,18732,1788,34030,106427,36958,54359,7251,44936,15356,69139,455,157915,22173,140291,50348,43275,82066,49621,54952,15216,36226,96695,66855,6936,1987,8227,196087,4631,68827,99004,47541,110265,17953,147605,110242,58520,31312,38724,329975,642,3155,34497,75937,6207,73843,6120,17249,51429,117746,3218,910,68961,319671,14938,29555,34700,1649,66673,72268,9655,76800,153087,6941,210168,27130,35398,1780,73242,3135,56689,19556,165307,8765,35967,121458,13333,70453,17350,117253,22265,13340,44265,39869,441,3742,135025,23581,33309,16543,17731,13291,157637,283005,21408,101360,63887,52312,83873,5338,233779,23759,186949,34531,177320,38069,156465,91004,19353,59852,68160,14891,1338,1072,29823,1950,28901,81407,313445,73038,84807,162348,240257,37162,138934,16111,58013,41253,102951,16457,96056,19541,56402,67217,41638,94381,89674,29481,37456,80815,151579,13937,13683,132537,19699,134545,67020,29816,222341,141235,427578,48868,129557,233342,23077,87871,16213,18728,16184,9469,37913,19680,2798,171356,178328,13216,50049,72690,71904,124644,55455,7504,29052,41036,266546,19899,30391,188755,8659,59469,16,104298,112943,53865,76203,138226,68857,139953,14125,107625,119795,173133,4398,50273,48808,54390,16466,122086,31835,67035,50971,48859,7508,46427,66477,73021,84615,39985,83076,46779,201569,53336,36443,60865,168164,143810,51393,25548,169307,32896,24485,38424,21837,29087,275813,51674,6714,64883,46169,187369,55186,76192,12852,12018,62134,31067,118303,16542,12125,10579,4928,26291,43854,7091,10946,253716,109062,39283,17261,113012,258512,47764,125126,32646,55892,80279,201623,149872,3192,385,1208,48750,5376,58738,22335,5427,82416,47811,32435,143086,38930,94128,59975,156037,37977,38224,62485,7698,50405,71027,16462,21559,136153,34131,107506,162069,63703,3101,215029,40407,4178,3774,9187,80019,17880,97926,67579,2600,18405,8351,47924,86638,70820,92206,86453,29610,42241,119200,3198,15466,67813,57863,35454,4779,99518,4649,104641,144269,33730,38073,65864,6838,109456,193298,154007,5623,45741,30846,182578,25573,157224,1543,58575,138703,146140,44971,49356,18275,59064,20300,13122,11848,24453,11973,9797,86843,2919,25530,49210,1130,161220,76788,75373,85604,34926,36014,17777,17255,51533,11676,92226,51845,119859,21525,5936,18507,28050,1140,31418,14857,34207,47859,10750,36382,32079,106909,59426,87757,38393,110042,15965,97104,33757,35344,97993,53979,33651,45407,41884,82515,173089,7177,58371,35365,47543,51927,35587,10670,23544,29306,84233,39976,76076,62097,9007,8668,28119,78281,120790,19835,143020,54968,18670,64959,20649,34469,42570,33001,136570,87796,120044,1106,58700,63951,127623,12805,83057,40212,31773,49850,7361,54336,347524,101314,23751,19569,48791,29174,49369,20467,7465,75842,38281,623,112457,60210,28849,51003,94720,6426,90047,85560,43761,3579,85105,34607,90410,118528,7224,42907,111163,18168,6960,161135,191298,5247,100584,127552,171568,20121,91173,12636,54615,20199,63730,98105,2396,40387,14438,125012,4765,33235,12865,45299,37728,82098,77872,114037,59253,19675,24838,398016,102561,11446,17069,57508,178277,65836,99941,26114,2585,271882,136866,50126,11027,155648,118367,14585,8910,123015,335383,40434,41016,53021,14439,87098,176860,201543,121888,2358,9286,5739,22666,54270,37884,169381,33984,93859,16124,89364,72207,51639,76366,99029,65812,2198,12147,174891,194289,6986,30252,88822,21284,11445,288337,160821,33034,100869,43852,25761,52882,1144,103809,1924,84458,86079,43411,13542,139276,18141,34978,41298,7276,26481,173800,33210,17951,142652,33616,33677,2210,19941,98568,2486,192414,80136,12058,235883,50963,249638,29572,27221,47034,6124,72107,63346,97620,158513,299699,40388,23235,37176,224244,198386,121323,67992,23827,63170,17838,106622,158590,26807,5345,23489,91891,55474,74834,37981,13058,5977,72552,34706,26828,145172,19904,21367,34043,960,77092,91381,4733,47446,7680,41697,5170,16960,14741,46101,13656,473,51842,37433,11103,11551,121951,13191,97536,165932,50397,51628,129028,9069,44885,6590,59195,47045,32940,225472,90345,21833,13303,29407,96615,141951,5198,6028,18395,7181,3861,14966,156358,167182,36529,55253,25942,173153,30959,27261,50691,150176,162201,38467,48462,80602,42163,118482,168,108756,26011,17166,54149,456538,22512,91374,13816,90358,131615,18132,226707,1824,28139,26860,42253,93877,77351,65575,8980,80574,22020,27948,40422,91324,76376,13528,39281,91685,82215,122541,144066,1983,193851,17283,26320,2739,194978,4790,26845,42627,61300,65815,174612,55133,4200,191130,79771,158321,52280,166796,221620,62461,11278,4067,88152,83409,31717,121367,13522,47325,37945,10406,174348,249321,154101,64912,29938,51775,17220,15776,166138,78890,84425,54121,42861,16368,24572,291647,10197,32073,22651,11677,97509,26952,35787,18424,41910,71614,94977,72318,41594,70024,275419,37702,60199,7335,39107,61315,18271,18394,33768,87884,104277,123724,7277,56288,71981,189803,49320,3352,6798,14240,8954,69220,94433,57372,28620,68863,193727,85575,42309,41667,67689,42081,22543,44824,12719,28540,114236,101553,27638,27296,4300,5353,4663,19379,94098,3758,95888,95144,80344,87320,28447,259518,12718,71391,152731,37063,24132,31911,104896,15672,103782,1521,4945,72541,23717,122632,15619,87175,206120,29428,189780,61416,28350,44457,972,1175,47233,198738,95789,41907,21953,97034,59341,22864,53713,16873,32971,20693,20954,31336,21477,16169,38370,16412,9019,3841,24599,21938,17085,6484,81198,76413,5849,72514,12320,65247,276175,37234,59796,52642,16312,57349,198507,94148,46134,18958,125552,1747,18725,151873,14901,5490,68287,29470,3689,64794,40814,26018,25692,54450,2703,88278,124886,173087,174e3,24159,179477,24276,46004,201876,209202,445,52876,31948,30206,157610,39180,18439,44124,50469,5774,96278,222758,200216,50290,45486,20435,46986,46276,140133,142326,15569,13363,47522,92583,2182,7135,16853,22998,30272,4952,63263,35623,39096,53789,44864,20053,110392,124213,4630,16087,28221,127787,25839,77481,44693,13464,113146,6983,27069,55717,50102,4760,7107,26186,66507,59145,36032,104182,71328,29425,64317,50781,47465,94298,69706,74899,22754,120756,25108,93077,56834,73286,39928,16218,41699,176763,7555,70819,50083,26895,23315,26014,16773,123079,41712,5719,31516,90427,158540,85051,183128,40864,27505,55392,9058,45224,96857,30901,136622,96557,56304,120061,11501,151448,5773,89743,7769,86069,2935,18471,41628,10114,33660,110170,49479,26745,92846,33221,26731,18795,87076,8550,2100,29972,120289,3077,72490,33784,2630,208722,50861,63483,79029,6419,39467,14302,45286,64207,9686,67513,44170,1050,77246,59266,17055,53801,7150,11111,42432,4278,94579,362117,36175,42902,41933,39002,98489,22913,74161,84773,57036,17556,162288,74485,178760,93867,73635,128860,50362,261,67455,80001,46080,35662,4368,25247,19230,74393,22588,1822,27682,235324,13798,85998,13194,235067,23514,71669,147632,23191,134748,214683,105101,1518,25489,247114,7380,54842,26922,3971,26361,20844,68642,170517,77339,123255,8963,77818,150998,48466,36806,2732,23261,11741,236162,18243,126216,28690,50546,16385,92760,197383,246558,201295,88255,67588,71687,176076,172653,169058,33906,63747,24835,157621,43338,30050,46152,132741,2770,51371,94835,6614,15112,11749,56936,1250,19027,399017,58036,100215,23388,55815,308768,124152,94803,9521,64186,8971,28,30427,62163,7616,103838,35079,29203,131235,7743,17389,10882,37420,61460,228512,85363,41581,131077,62822,119647,10130,54445,26925,19968,29016,24446,74028,24176,61448,67185,9254,8563,119129,9771,99184,37716,39514,10532,221512,258753,218630,55980,23394,32141,61924,66749,32411,3741,36475,26678,77010,44946,91203,128749,116953,20476,49625,53116,13735,102335,29376,51946,83407,67892,59212,34685,21083,1546,112982,32972,74397,1078,190545,16082,86140,58591,89611,101531,10061,105104,76319,20035,17551,52611,169061,190842,100780,23907,90413,115619,9675,34710,193435,49443,129734,11183,258877,16318,136182,126808,44635,27304,192375,2599,125648,47051,12091,23814,721,58800,40137,66726,97930,60877,74487,7942,54326,9841,41428,13762,8211,85383,6950,99177,79806,201786,296464,124087,13144,29741,41721,47634,55088,254286,106408,17041,99064,12942,64086,45233,14005,2612,55827,255,7984,13980,38574,12776,46654,73499,249951,2101,26676,25996,132326,116415,119062,50449,31033,23038,11589,179252,20007,14860,129270,21143,17796,144715,60106,70758,69842,34674,282133,44014,16774,57268,38528,24053,46373,201667,28327,471023,51889,102667,21193,114909,84132,69317,96723,67969,16134,68145,15058,28765,32035,2524,101089,98664,25045,76571,14957,86040,118506,262428,154764,81573,39681,283900,73287,127825,544,80448,52347,38512,175971,15180,45467,33086,46552,48894,81107,43213,36672,54025,76703,8053,7608,13299,56619,20752,238099,54164,105133,1444,32942,953,37564,8e3,66316,119463,106817,404,13667,149108,128597,31267,10269,49836,106150,1484,52330,76965,160486,171648,38456,31263,22424,37738,66245,67467,143369,60471,75610,20895,115528,86070,60854,40796,49347,18989,15030,11371,37578,15779,79867,10187,86462,46402,155626,93200,40229,7090,57547,108053,99598,11088,47505,41218,206017,2173,20988,30219,22919,80563,57566,42369,93141,41675,2407,182519,120495,27154,16702,29456,14349,7958,16688,117177,140375,42467,261919,74916,153569,10836,34742,49526,7621,105997,12212,2270,392377,7755,17959,25086,232152,138791,33847,13860,35316,5811,1344,71259,50452,207539,92635,50359,5821,33674,30255,2086,2587,96264,17543,42,6029,9580,43007,139248,82831,12917,29607,25786,51467,42137,85161,100698,31561,88989,121990,278500,3602,109344,37982,15279,116442,28936,30880,87894,58079,128661,126731,67392,28051,146885,4861,16216,97344,42827,147561,153948,22684,21335,47685,1853,43349,15185,59642,10229,25520,187921,108972,5579,98037,24945,6697,19193,63734,137934,75056,89740,19767,224268,56138,63643,151661,39313,70618,84031,89723,84074,13703,85626,35460,8867,64845,3439,57906,99776,63968,49270,81130,34356,16210,23547,36446,34090,140028,72439,2221,22163,57058,363492,113754,18913,95451,48663,54464,54037,176097,68425,3023,34906,29482,117389,341780,80431,58330,16753,92616,60907,94846,147486,4498,48646,7773,46801,7778,18946,464978,47558,33223,177444,7328,15626,63337,94700,11743,9351,255024,39098,16447,42647,96230,39769,58840,10068,63439,35800,65843,58823,413844,9156,51258,7434,61791,85018,6872,3692,28096,7121,33024,6009,75532,31997,192535,9661,3304,9547,14753,31987,25314,55689,15896,20430,39472,31340,99744,25398,115569,54883,28719,205423,23071,57855,64638,149867,25671,82403,37616,20668,39989,77996,74948,140555,175248,64810,36515,46595,4958,248773,24045,28728,136673,168704,20804,114833,100325,27135,21205,96151,153134,45992,7093,13992,76047,1980,19432,145001,75159,87462,17710,1013,45556,34297,144882,20648,26061,11319,129567,108555,18872,464580,33386,22717,65948,167189,5603,135042,79542,8801,202632,18114,91882,5973,5239,67315,4431,60916,47819,71693,32597,32606,18183,45072,80329,76385,24749,51305,40314,156514,14693,130345,13168,66214,18029,12858,34801,27628,14544,10823,40522,40185,33739,148694,23548,9923,61012,28859,17933,19442,34364,99849,164107,141167,30629,21054,6744,36491,8096,42474,41706,155060,30650,10600,163442,1143,96655,61390,52359,7559,51568,64256,203854,4467,22453,14504,436398,7878,6980,8293,63610,293747,16167,35763,19627,147603,15419,18032,110744,51346,33681,54571,40472,48615,39073,21604,13754,173027,92560,11083,47299,63062,11813,52007,29883,9734,139722,15953,1550,20651,13616,49306,16113,90089,92326,7584,30712,72424,164858,6831,152871,55746,197721,34167,196442,6022,112107,55215,7538,123381,4920,43539,77165,8939,50392,34192,20225,79762,22505,58667,40770,29788,97180,82835,4568,8579,13273,363569,35898,49983,436,36598,3237,131691,62418,35591,8101,4073,379438,65218,76072,33887,2968,27573,212619,288680,68278,72851,150504,217896,6913,121339,22017,35340,51072,43616,75043,31437,10833,81487,4364,22968,41454,106687,85446,19863,109625,149241,524,141850,214404,54376,657,237023,9401,108137,53800,32474,49712,53334,126876,27337,45552,177696,8269,15036,12097,42240,2328,125374,119295,99715,2500,19624,39441,27220,102691,60957,94543,39101,18566,67362,13975,78230,25017,34017,239007,90027,39351,41681,35354,43822,1043,916,58587,141983,94818,38799,75459,41114,67432,16195,36606,59568,22272,126769,31424,68659,12287,134302,257977,5756,207285,95637,47248,117689,19583,77451,22373,12200,54993,117118,34244,29386,34562,53819,71267,64172,77665,49368,7716,59301,25749,45426,194789,17297,2650,1766,32501,45198,20403,20984,6600,14171,94604,19037,5402,29896,9938,59935,109708,88081,145182,44844,39167,352626,164173,35374,45982,6122,154,73419,220487,53834,53601,17992,8609,229321,5610,68098,66815,71012,95069,140968,27396,8957,134489,24656,86659,56598,134852,17316,123838,255436,6613,41610,138033,81452,32023,32396,123687,63398,8693,29712,30407,19296,121188,3551,36099,20032,111948,56624,16547,27453,35916,15378,52039,56849,13489,22214,73177,53097,277349,2157,14029,187886,10260,141743,246460,91880,50869,3788,49486,133566,54950,33120,129337,53768,18333,9525,26902,312251,10297,9020,70759,16647,112432,59260,84609,9818,82766,73569,468,46001,75780,55028,52106,11498,43645,108069,17150,17753,29417,16705,31799,9606,289,122254,115975,8620,6133,255357,56908,14456,133464,43554,79224,11247,29630,160,12756,25464,65960,350428,62521,321796,100359,67358,35169,46172,113128,48988,88868,31094,33266,6847,60887,98188,49659,69117,92977,220228,13947,80181,35103,62170,97351,13475,2440,199768,19498,36597,46971,25234,67806,62881,84717,73648,181966,10488,94149,21550,26655,63436,48375,14405,165650,9621,24439,28043,42735,4490,29963,56674,45373,1934,262446,50855,67098,26898,5261,52696,40644,33900,9440,180286,87162,22940,19704,26936,69769,10254,101759,27406,12243,48e3,73926,113215,54935,5726,192787,4312,106216,9366,11550,52949,23457,212271,277152,133895,108374,6191,96477,29980,218916,58024,54696,40853,91124,65894,91170,65908,252552,6793,29212,15389,44516,122515,52617,35058,9017,103536,39510,49136,19242,130652,662077,74699,47024,31422,8517,73351,24399,13867,128360,4810,4434,61779,111983,61036,17798,110240,59722,102960,39688,10001,23803,23039,176498,56659,44814,134295,17188,77577,74466,226175,102472,154333,63900,111747,18062,41171,79669,32773,408933,42562,28931,30907,107388,43487,2946,240310,23938,24354,319,184983,7927,6488,1422,10790,68809,68209,64775,4361,202,17123,59634,51200,44391,18188,17843,2619,74278,3230,9540,47187,21702,36274,56894,43907,16310,34790,16866,6150,5561,13587,107545,108873,126867,86986,28640,33427,19017,5762,80637,17430,46903,2047,131055,25958,13558,5444,47152,13900,44563,122857,45348,70863,39593,54332,38068,33637,318,40310,143467,18502,24520,11377,62013,28942,27246,28269,83545,17999,59015,90707,30065,15161,34720,1263,37008,2012,6060,98575,92933,5721,299,199555,24578,29223,2985,743,115825,109523,136657,47454,26378,53586,3733,174945,93340,244456,5693,37386,28782,89767,27545,23573,18798,136425,34320,84778,20041,48453,38215,7477,71958,40621,8773,5874,187927,105965,51100,43533,18083,8443,10180,43597,2003,183999,69689,12216,129696,146188,62389,34044,68410,12765,43273,26949,266807,3345,34477,79197,5688,47539,213110,21634,22257,50092,32222,42346,39530,63668,98,134978,74022,5152,59088,174145,37220,9934,9545,118937,5724,87240,19875,15784,40143,23263,87513,181654,285152,37881,263241,4966,43934,10433,186657,6470,74416,225854,25908,142677,246262,32280,6192,75890,45546,143264,135305,29742,47013,77787,11732,126658,8763,37950,21806,57557,113464,89465,108995,164574,23894,22996,23169,15369,23117,17642,130607,40503,36239,280990,44666,9981,40427,147487,26869,168452,32886,32991,46798,240839,15111,70502,65697,88548,44145,28701,48767,31139,206777,35659,181164,166262,14554,171445,31786,66523,76607,17956,6507,31279,90476,116611,167918,6560,1243,115324,80128,41867,55897,187323,37069,32596,189444,145931,13390,105530,65709,26805,6999,55714,41300,22915,68951,22138,21120,22264,10058,19945,33635,56123,99085,10032,5818,6016,46649,57476,35264,94413,112522,262288,93686,83038,14341,23204,28807,66084,77987,6101,126673,7133,38126,5923,122091,170240,97772,46874,215746,43948,41622,3272,55596,8332,146411,251315,13533,8561,81521,115449,48616,175175,2063,186556,3036,134537,75772,29728,82360,22973,186559,86348,89100,38388,82297,45610,2613,87082,9986,177812,57884,23591,47485,42543,33582,44713,74439,257444,252451,31825,35631,38540,33066,5147,13973,4343,51830,70378,22827,26448,95560,36896,241741,48067,203953,298860,61620,20450,3220,67272,6586,107662,100160,108684,6929,57226,4762,7457,1320,40404,77204,99309,62750,208653,59977,44e3,74315,34332,5819,172217,64904,114077,18147,84012,1791,98456,90930,21446,116669,103938,7422,85140,59713,5768,326211,16239,75411,13229,29398,10758,236107,1539,112472,95979,152154,151294,306,21196,38146,10700,6891,84282,109646,56492,40539,6589,119491,51354,30685,140209,136906,29622,73617,49553,70525,51671,166869,139616,74395,37439,49595,45678,11959,33211,86560,52434,9282,62690,112155,130810,5243,108261,99970,265613,72551,80049,6391,33365,90721,66737,69872,87011,1860,9032,112544,60905,37371,89015,140351,19076,850,373531,2802,36725,218795,72062,28990,16550,24614,7815,6187,26336,33373,32162,42791,73555,32062,23386,10244,56392,49442,27076,136262,12412,14883,1134,33675,97153,199281,15608,100152,74072,47942,254301,36451,16026,10687,65067,56708,254030,30290,50490,13864,57941,259331,35588,23485,43486,24869,21620,92971,22072,88645,1048,182050,13343,32452,14825,19509,3325,216938,45740,99716,189082,53740,78245,25609,24311,176777,47340,308354,40669,66085,14102,125339,9225,128709,97207,1271,200933,78439,113451,88975,18324,46521,11819,18570,141756,72512,170020,52754,63550,118515,103073,93330,32736,50499,14722,31600,68452,398867,29316,172786,18417,104924,2606,5670,84818,16288,67106,59580,82929,607401,291,85829,359,15897,35830,50696,65630,52672,22115,356968,29895,40837,231192,34024,38957,26722,406,23335,124952,72068,68804,13268,147101,164740,276569,162596,66943,11569,26654,66358,4777,23229,102127,5848,978,2921,59666,5371,28212,90108,42938,39320,2499,4271,108792,33510,125072,71653,65239,38250,66357,38577,13964,86251,35708,50755,36010,29448,12209,3844,38222,206337,100876,67827,137088,14167,252225,84163,195270,1306,5703,54198,779,46802,22028,51124,86759,70560,113164,35685,162145,45471,34561,422,2611,6464,47486,19223,38246,9191,18331,89942,243642,212364,15893,17518,22617,6409,30046,126182,59716,36560,104428,18846,26592,19458,50793,147333,30826,1388,27647,10922,14495,33545,19269,135828,39727,41601,46931,233379,49169,131130,182112,16276,82381,118209,142445,128310,19672,28740,82907,33436,3118,102206,28723,24819,41937,38854,5157,3881,111491,1142,9776,421673,152241,29309,14961,87854,6054,15424,3796,82656,54996,2108,55367,239450,154525,9643,118103,106041,64601,68549,48707,30266,25772,18740,9462,229669,91798,112152,191327,14493,72828,8175,66636,236474,25817,87351,129027,76653,20422,22983,71240,27846,44661,12399,46158,77704,53101,35032,11072,17300,109294,33638,24408,1895,11241,760,17584,82479,125877,63150,141075,34259,23274,81698,15732,43577,48340,91584,14688,16379,24481,150280,96420,262050,48635,43727,61819,56268,72003,88178,17281,79912,13218,122519,125295,166396,11811,2171,118930,67746,17636,178278,174656,95661,173039,83845,79689,17473,98555,127696,203415,54730,22925,232239,9309,12136,175026,20740,180188,10747,39816,314017,266131,10040,175732,112550,220651,31974,37393,888,23008,86799,4303,64905,148467,75337,251,3284,370102,50264,9835,5438,23655,4481,29851,329,12855,7162,64931,78141,12804,42372,296771,83547,18624,34874,86271,3360,48665,77735,88767,11463,63527,28889,22258,29140,194315,113924,25499,6406,31334,1845,4802,49184,43455,35469,127594,92970,61038,115005,38840,87761,106838,8811,20572,55637,11162,96721,132425,108925,2948,125457,36356,3502,75270,27622,127192,2561,123095,49394,61155,16897,110064,9699,89448,53356,19628,220310,21622,83036,9885,112214,6087,26713,17901,161912,91492,3440,68594,9266,92238,8087,6866,150194,72175,80701,13459,31836,43243,239700,95846,44749,50647,21945,230538,120612,132371,244604,5193,105637,34661,41341,68775,85393,1874,8771,33718,49672,77403,595452,99507,6490,58895,128742,7704,39239,73217,43816,62824,37804,199976,22361,80005,87514,94832,14089,4574,139975,59142,75523,100268,43906,53442,15152,2547,186002,17011,19513,204282,3343,60568,128318,119250,4298,51871,41336,71759,21921,45074,98169,145889,99427,11350,1237,5520,28799,7803,53702,21026,136352,38293,128690,12158,90132,44600,10184,26957,39459,126025,78904,82999,59373,39301,150198,120529,153042,20177,50089,14764,271571,30530,123161,38975,101562,22941,5648,124654,109243,69817,71675,49162,106884,21241,107795,30258,16572,188262,141456,7688,60718,8271,11044,32440,104608,103419,236109,93156,43293,128929,42107,67180,25201,115254,185488,130954,72813,167547,20537,39969,38432,22582,184022,1139,27199,5655,17767,97412,122606,209377,27070,35871,326617,188954,42680,73512,80911,22629,3011,95021,315242,157737,383,41821,41808,19335,27950,15674,25677,110950,35375,76835,59108,57370,35262,16569,160415,37706,78086,32041,49691,137143,9782,172080,50148,77917,6323,10110,69172,17711,21795,59511,76184,135114,31046,132319,59105,157578,20549,80778,57649,158421,65143,4575,72235,21899,10797,92745,34035,106079,80159,4508,78304,25350,75457,46458,32937,25623,47,8531,104751,84953,8138,36508,187199,66310,115274,13253,32461,38536,1916,42007,187160,35055,26325,84394,35963,94216,45590,97782],pg=15;class o5e{constructor(e,t){u(this,"log");u(this,"peerRouting");u(this,"routingTable");u(this,"refreshInterval");u(this,"refreshQueryTimeout");u(this,"commonPrefixLengthRefreshedAt");u(this,"refreshTimeoutId");const{peerRouting:n,routingTable:i,refreshInterval:s,refreshQueryTimeout:o,logPrefix:a}=t;this.log=e.logger.forComponent(`${a}:routing-table:refresh`),this.peerRouting=n,this.routingTable=i,this.refreshInterval=s??owe,this.refreshQueryTimeout=o??awe,this.commonPrefixLengthRefreshedAt=[],this.refreshTable=this.refreshTable.bind(this)}async afterStart(){this.log(`refreshing routing table every ${this.refreshInterval}ms`),this.refreshTable(!0)}async stop(){this.refreshTimeoutId!=null&&clearTimeout(this.refreshTimeoutId)}refreshTable(e=!1){this.log("refreshing routing table");const t=this._maxCommonPrefix(),n=this._getTrackedCommonPrefixLengthsForRefresh(t);this.log(`max common prefix length ${t}`),this.log(`tracked CPLs [ ${n.map(i=>i.toISOString()).join(", ")} ]`),Promise.all(n.map(async(i,s)=>{try{if(await this._refreshCommonPrefixLength(s,i,e),this._numPeersForCpl(t)===0){const o=Math.min(2*(s+1),n.length-1);for(let a=s+1;a<o+1;a++)try{await this._refreshCommonPrefixLength(a,i,e)}catch(c){this.log.error(c)}}}catch(o){this.log.error(o)}})).catch(i=>{this.log.error(i)}).then(()=>{this.refreshTimeoutId=setTimeout(this.refreshTable,this.refreshInterval),this.refreshTimeoutId.unref!=null&&this.refreshTimeoutId.unref()}).catch(i=>{this.log.error(i)})}async _refreshCommonPrefixLength(e,t,n){if(!n&&t.getTime()>Date.now()-this.refreshInterval){this.log("not running refresh for cpl %s as time since last refresh not above interval",e);return}const i=await this._generateRandomPeerId(e);this.log("starting refreshing cpl %s with key %p (routing table size was %s)",e,i,this.routingTable.size);const s=AbortSignal.timeout(this.refreshQueryTimeout),o=await aK(this.peerRouting.getClosestPeers(i.toMultihash().bytes,{signal:s}));this.log(`found ${o} peers that were close to imaginary peer %p`,i),this.log("finished refreshing cpl %s with key %p (routing table size is now %s)",e,i,this.routingTable.size)}_getTrackedCommonPrefixLengthsForRefresh(e){e>pg&&(e=pg);const t=[];for(let n=0;n<=e;n++)t[n]=this.commonPrefixLengthRefreshedAt[n]??new Date;return t}async _generateRandomPeerId(e){if(this.routingTable.kb==null)throw new Error("Routing table not started");if(this.routingTable.kb.localPeer==null)throw new Error("Local peer not set");const t=xc(2),n=(t[1]<<8)+t[0],i=await this._makePeerId(this.routingTable.kb.localPeer.kadId,n,e),s=Su(i);return si(s)}async _makePeerId(e,t,n){if(n>pg)throw new Error(`Cannot generate peer ID for common prefix length greater than ${pg}`);const o=new DataView(e.buffer,e.byteOffset,e.byteLength).getUint16(0,!1)^32768>>n,a=65535<<16-(n+1),c=o&a|t&~a,l=s5e[c],d=new ArrayBuffer(34),h=new DataView(d,0,d.byteLength);return h.setUint8(0,nK.code),h.setUint8(1,32),h.setUint32(2,l,!1),new Uint8Array(h.buffer,h.byteOffset,h.byteLength)}_maxCommonPrefix(){let e=0;for(const t of this._prefixLengths())t>e&&(e=t);return e}_numPeersForCpl(e){let t=0;for(const n of this._prefixLengths())n===e&&t++;return t}*_prefixLengths(){var e;if(((e=this.routingTable.kb)==null?void 0:e.localPeer)!=null)for(const{kadId:t}of this.routingTable.kb.toIterable()){const n=kc(this.routingTable.kb.localPeer.kadId,t);let i=0;for(const s of n)if(s===0)i++;else break;yield i}}}class a5e{constructor(e,t){u(this,"peerId");u(this,"providers");u(this,"peerStore");u(this,"log");this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:add-provider`),this.peerId=e.peerId,this.providers=t.providers,this.peerStore=e.peerStore}async handle(e,t){if(t.key==null||t.key.length===0)throw new xt("Missing key");let n;try{n=Px.decode(t.key)}catch{throw new xt("Invalid CID")}(t.providers==null||t.providers.length===0)&&this.log.error("no providers found in message"),this.log("%p asked us, %p to store provider record for for %c",e,this.peerId,n),await Promise.all(t.providers.map(async i=>{const s=Su(i.id),o=si(s),a=i.multiaddrs.map(c=>Re(c));if(!e.equals(o)){this.log("invalid provider peer %p from %p",i.id,e);return}if(i.multiaddrs.length<1){this.log("no valid addresses for provider %p. Ignore",e);return}this.log.trace("received provider %p for %s (addrs %s)",e,n,a),await this.providers.addProvider(n,o),await this.peerStore.merge(o,{multiaddrs:a})}))}}class c5e{constructor(e,t){u(this,"peerRouting");u(this,"peerInfoMapper");u(this,"peerId");u(this,"addressManager");u(this,"log");const{peerRouting:n,logPrefix:i}=t;this.log=e.logger.forComponent(`${i}:rpc:handlers:find-node`),this.peerId=e.peerId,this.addressManager=e.addressManager,this.peerRouting=n,this.peerInfoMapper=t.peerInfoMapper}async handle(e,t){if(this.log("incoming request from %p for peers closer to %b",e,t.key),t.key==null)throw new xt("Invalid FIND_NODE message received - key was missing");const n=await this.peerRouting.getCloserPeersOffline(t.key,e);He(this.peerId.toMultihash().bytes,t.key)&&n.push({id:this.peerId,multiaddrs:this.addressManager.getAddresses().map(s=>s.decapsulateCode(ze("p2p").code))});const i={type:At.FIND_NODE,clusterLevel:t.clusterLevel,closer:n.map(this.peerInfoMapper).filter(({multiaddrs:s})=>s.length).map(s=>({id:s.id.toMultihash().bytes,multiaddrs:s.multiaddrs.map(o=>o.bytes)})),providers:[]};return i.closer.length===0&&this.log("could not find any peers closer to %b than %p",t.key,e),i}}class l5e{constructor(e,t){u(this,"peerId");u(this,"peerRouting");u(this,"providers");u(this,"peerStore");u(this,"peerInfoMapper");u(this,"log");const{peerRouting:n,providers:i,logPrefix:s}=t;this.log=e.logger.forComponent(`${s}:rpc:handlers:get-providers`),this.peerId=e.peerId,this.peerStore=e.peerStore,this.peerRouting=n,this.providers=i,this.peerInfoMapper=t.peerInfoMapper}async handle(e,t){if(t.key==null)throw new xt("Invalid GET_PROVIDERS message received - key was missing");let n;try{n=Px.decode(t.key)}catch{throw new xt("Invalid CID")}this.log("%p asking for providers for %s",e,n);const[i,s]=await Promise.all([im(Mh(await this.providers.getProviders(n),async a=>{const c=await this.peerStore.get(a);return{id:c.id,multiaddrs:c.addresses.map(({multiaddr:d})=>d)}})),this.peerRouting.getCloserPeersOffline(t.key,this.peerId)]),o={type:At.GET_PROVIDERS,key:t.key,clusterLevel:t.clusterLevel,closer:s.map(this.peerInfoMapper).filter(({id:a,multiaddrs:c})=>c.length>0).map(a=>({id:a.id.toMultihash().bytes,multiaddrs:a.multiaddrs.map(c=>c.bytes)})),providers:i.map(this.peerInfoMapper).filter(({id:a,multiaddrs:c})=>c.length>0).map(a=>({id:a.id.toMultihash().bytes,multiaddrs:a.multiaddrs.map(c=>c.bytes)}))};return this.log("got %s providers %s closerPeers",o.providers.length,o.closer.length),o}async _getAddresses(e){return[]}}class u5e{constructor(e,t){u(this,"peerStore");u(this,"datastore");u(this,"peerRouting");u(this,"log");u(this,"datastorePrefix");this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:get-value`),this.datastorePrefix=`${t.datastorePrefix}/record`,this.peerStore=e.peerStore,this.datastore=e.datastore,this.peerRouting=t.peerRouting}async handle(e,t){const n=t.key;if(this.log("%p asked for key %b",e,n),n==null||n.length===0)throw new xt("Invalid key");const i={type:At.GET_VALUE,key:n,clusterLevel:t.clusterLevel,closer:[],providers:[]};if(i4e(n)){this.log("is public key");const a=s4e(n);let c;try{const l=await this.peerStore.get(a);if(l.id.publicKey==null)throw new Zt("No public key found in key book");c=Pi(l.id.publicKey)}catch(l){if(l.name!=="NotFoundError")throw l}if(c!=null)return this.log("returning found public key"),i.record=new Di(n,c,new Date).serialize(),i}const[s,o]=await Promise.all([this._checkLocalDatastore(n),this.peerRouting.getCloserPeersOffline(n,e)]);return s!=null&&(this.log("had record for %b in local datastore",n),i.record=s.serialize()),o.length>0&&(this.log("had %s closer peers in routing table",o.length),i.closer=o.map(a=>({id:a.id.toMultihash().bytes,multiaddrs:a.multiaddrs.map(c=>c.bytes)}))),i}async _checkLocalDatastore(e){this.log("checkLocalDatastore looking for %b",e);const t=u1(this.datastorePrefix,e);let n;try{n=await this.datastore.get(t)}catch(s){if(s.name==="NotFoundError")return;throw s}const i=Di.deserialize(n);if(i.timeReceived==null||Date.now()-i.timeReceived.getTime()>Y3e){await this.datastore.delete(t);return}return i}}class d5e{constructor(e,t){u(this,"log");this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:ping`)}async handle(e,t){return this.log("ping from %p",e),t}}class h5e{constructor(e,t){u(this,"components");u(this,"validators");u(this,"log");u(this,"datastorePrefix");const{validators:n}=t;this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:put-value`),this.datastorePrefix=`${t.datastorePrefix}/record`,this.validators=n}async handle(e,t){const n=t.key;if(this.log("%p asked us to store value for key %b",e,n),t.record==null){const i=`Empty record from: ${e.toString()}`;throw this.log.error(i),new xt(i)}try{const i=Di.deserialize(t.record);await kx(this.validators,i),i.timeReceived=new Date;const s=u1(this.datastorePrefix,i.key);await this.components.datastore.put(s,i.serialize().subarray()),this.log("put record for %b into datastore under key %k",n,s)}catch(i){this.log("did not put record for key %b into datastore %o",n,i)}return t}}let f5e=class{constructor(e,t){u(this,"handlers");u(this,"routingTable");u(this,"log");u(this,"metrics");var n,i;this.metrics={operations:(n=e.metrics)==null?void 0:n.registerCounterGroup(`${t.metricsPrefix}_inbound_rpc_requests_total`),errors:(i=e.metrics)==null?void 0:i.registerCounterGroup(`${t.metricsPrefix}_inbound_rpc_errors_total`)},this.log=e.logger.forComponent(`${t.logPrefix}:rpc`),this.routingTable=t.routingTable,this.handlers={[At.GET_VALUE.toString()]:new u5e(e,t),[At.PUT_VALUE.toString()]:new h5e(e,t),[At.FIND_NODE.toString()]:new c5e(e,t),[At.ADD_PROVIDER.toString()]:new a5e(e,t),[At.GET_PROVIDERS.toString()]:new l5e(e,t),[At.PING.toString()]:new d5e(e,t)}}async handleMessage(e,t){var i,s;const n=this.handlers[t.type];if(n==null){this.log.error(`no handler found for message type: ${t.type}`);return}try{return(i=this.metrics.operations)==null||i.increment({[t.type]:!0}),await n.handle(e,t)}catch{(s=this.metrics.errors)==null||s.increment({[t.type]:!0})}}onIncomingStream(e){let t="unknown";Promise.resolve().then(async()=>{const{stream:n,connection:i}=e,s=i.remotePeer,o=this;await hn(n,a=>Yd(a),async function*(a){for await(const c of a){const l=Ol.decode(c);t=l.type,o.log("incoming %s from %p",l.type,s);const d=await o.handleMessage(s,l);d!=null&&(yield Ol.encode(d))}},a=>Qd(a),n)}).catch(n=>{this.log.error("error handling %s RPC message from %p - %e",t,e.connection.remotePeer,n)})}};class p5e extends er{constructor(t,n){super();u(this,"log");u(this,"components");u(this,"protocol");u(this,"running");u(this,"registrarId");const{protocol:i,logPrefix:s}=n;this.components=t,this.log=t.logger.forComponent(`${s}:topology-listener`),this.running=!1,this.protocol=i}isStarted(){return this.running}async start(){this.running||(this.running=!0,this.registrarId=await this.components.registrar.register(this.protocol,{onConnect:t=>{this.log("observed peer %p with protocol %s",t,this.protocol),this.dispatchEvent(new CustomEvent("peer",{detail:t}))}}))}async stop(){this.running=!1,this.registrarId!=null&&(this.components.registrar.unregister(this.registrarId),this.registrarId=void 0)}}class g5e{constructor(e){u(this,"dht");this.dht=e}async provide(e,t={}){await zo(this.dht.provide(e,t))}async cancelReprovide(e){await this.dht.cancelReprovide(e)}async*findProviders(e,t={}){for await(const n of this.dht.findProviders(e,t))n.name==="PROVIDER"&&(yield*n.providers)}async put(e,t,n){await zo(this.dht.put(e,t,n))}async get(e,t){for await(const n of this.dht.get(e,t))if(n.name==="VALUE")return n.value;throw new Zt("Could not find value for key")}}class y5e{constructor(e){u(this,"dht");this.dht=e}async findPeer(e,t={}){for await(const n of this.dht.findPeer(e,t))if(n.name==="FINAL_PEER")return n.peer;throw new Zt("Peer not found")}async*getClosestPeers(e,t={}){for await(const n of this.dht.getClosestPeers(e,t))n.name==="FINAL_PEER"&&(yield n.peer)}}const m5e=32,w5e=64;var VN,KN,jN;class b5e extends er{constructor(t,n={}){var d,h,p,m;super();u(this,"protocol");u(this,"routingTable");u(this,"providers");u(this,"network");u(this,"peerRouting");u(this,"components");u(this,"log");u(this,"running");u(this,"kBucketSize");u(this,"clientMode");u(this,"validators");u(this,"selectors");u(this,"queryManager");u(this,"contentFetching");u(this,"contentRouting");u(this,"routingTableRefresh");u(this,"rpc");u(this,"topologyListener");u(this,"querySelf");u(this,"maxInboundStreams");u(this,"maxOutboundStreams");u(this,"dhtContentRouting");u(this,"dhtPeerRouting");u(this,"peerInfoMapper");u(this,"reprovider");u(this,jN,"@libp2p/kad-dht");u(this,KN,["@libp2p/content-routing","@libp2p/peer-routing","@libp2p/peer-discovery"]);u(this,VN,["@libp2p/identify"]);const i=n.logPrefix??"libp2p:kad-dht",s=n.datastorePrefix??"/dht",o=n.metricsPrefix??"libp2p_kad_dht",a={queries:(d=t.metrics)==null?void 0:d.registerMetricGroup(`${o}_operations_total`,{label:"operation"}),errors:(h=t.metrics)==null?void 0:h.registerCounterGroup(`${o}_operation_errors_total`,{label:"operation"}),queryTime:(p=t.metrics)==null?void 0:p.registerMetricGroup(`${o}_operation_time_seconds`,{label:"operation"}),errorTime:(m=t.metrics)==null?void 0:m.registerMetricGroup(`${o}_operation_error_time_seconds`,{label:"operation"})};this.running=!1,this.components=t,this.log=t.logger.forComponent(i),this.protocol=n.protocol??J3e,this.kBucketSize=n.kBucketSize??20,this.clientMode=n.clientMode??!0,this.maxInboundStreams=n.maxInboundStreams??m5e,this.maxOutboundStreams=n.maxOutboundStreams??w5e,this.peerInfoMapper=n.peerInfoMapper??r4e;const c=jS();this.providers=new D4e(t,{...n.providers,logPrefix:i,datastorePrefix:s,lock:c}),this.validators={...wwe,...n.validators},this.selectors={...ywe,...n.selectors},this.network=new T4e(t,{protocol:this.protocol,logPrefix:i,metricsPrefix:o}),this.routingTable=new i5e(t,{kBucketSize:n.kBucketSize,pingOldContactTimeout:n.pingOldContactTimeout,pingOldContactConcurrency:n.pingOldContactConcurrency,pingOldContactMaxQueueSize:n.pingOldContactMaxQueueSize,pingNewContactTimeout:n.pingNewContactTimeout,pingNewContactConcurrency:n.pingNewContactConcurrency,pingNewContactMaxQueueSize:n.pingNewContactMaxQueueSize,protocol:this.protocol,logPrefix:i,metricsPrefix:o,prefixLength:n.prefixLength,splitThreshold:n.kBucketSplitThreshold,network:this.network});const l=Le();n.allowQueryWithZeroPeers===!0&&l.resolve(),this.queryManager=new N4e(t,{disjointPaths:Math.ceil(this.kBucketSize/2),logPrefix:i,metricsPrefix:o,initialQuerySelfHasRun:l,routingTable:this.routingTable}),this.peerRouting=new P4e(t,{routingTable:this.routingTable,network:this.network,validators:this.validators,queryManager:this.queryManager,logPrefix:i}),this.contentFetching=new f4e(t,{validators:this.validators,selectors:this.selectors,peerRouting:this.peerRouting,queryManager:this.queryManager,network:this.network,logPrefix:i,datastorePrefix:s}),this.contentRouting=new g4e(t,{network:this.network,peerRouting:this.peerRouting,queryManager:this.queryManager,routingTable:this.routingTable,providers:this.providers,logPrefix:i}),this.routingTableRefresh=new o5e(t,{peerRouting:this.peerRouting,routingTable:this.routingTable,logPrefix:i}),this.rpc=new f5e(t,{routingTable:this.routingTable,providers:this.providers,peerRouting:this.peerRouting,validators:this.validators,logPrefix:i,metricsPrefix:o,datastorePrefix:s,peerInfoMapper:this.peerInfoMapper}),this.topologyListener=new p5e(t,{protocol:this.protocol,logPrefix:i}),this.querySelf=new B4e(t,{peerRouting:this.peerRouting,interval:n.querySelfInterval,initialInterval:n.initialQuerySelfInterval,logPrefix:i,initialQuerySelfHasRun:l,routingTable:this.routingTable,operationMetrics:a}),this.reprovider=new U4e(t,{...n.reprovide,logPrefix:i,metricsPrefix:o,datastorePrefix:s,contentRouting:this.contentRouting,lock:c,operationMetrics:a}),this.network.addEventListener("peer",f=>{const g=f.detail;this.onPeerConnect(g).catch(v=>{this.log.error("could not add %p to routing table",g.id,v)}),this.dispatchEvent(new CustomEvent("peer",{detail:g}))}),this.topologyListener.addEventListener("peer",f=>{const g=f.detail;Promise.resolve().then(async()=>{const v=await this.components.peerStore.get(g),y={id:g,multiaddrs:v.addresses.map(({multiaddr:w})=>w),protocols:v.protocols};await this.onPeerConnect(y)}).catch(v=>{this.log.error("could not add %p to routing table - %e",g,v)})}),this.dhtPeerRouting=new y5e(this),this.dhtContentRouting=new g5e(this),n.clientMode==null&&t.events.addEventListener("self:peer:update",f=>{this.log("received update of self-peer info"),Promise.resolve().then(async()=>{const g=f.detail.peer.addresses.some(({multiaddr:y})=>h4e(y)),v=this.getMode();g&&v==="client"?await this.setMode("server"):v==="server"&&!g&&await this.setMode("client")}).catch(g=>{this.log.error("error setting dht server mode",g)})}),this.get=Fu(this.get.bind(this),a,"GET_VALUE"),this.findProviders=Fu(this.findProviders.bind(this),a,"FIND_PROVIDERS"),this.findPeer=Fu(this.findPeer.bind(this),a,"FIND_PEER"),this.getClosestPeers=Fu(this.getClosestPeers.bind(this),a,"GET_CLOSEST_PEERS"),this.provide=Fu(this.provide.bind(this),a,"PROVIDE"),this.put=Fu(this.put.bind(this),a,"PUT_VALUE")}get[(jN=Symbol.toStringTag,KN=fr,VN=Ec,jd)](){return this.dhtContentRouting}get[Hd](){return this.dhtPeerRouting}get[ey](){return this}async onPeerConnect(t){if(this.log.trace("peer %p connected",t.id),t=this.peerInfoMapper(t),t.multiaddrs.length===0){this.log.trace("ignoring %p as there were no valid addresses in %s after filtering",t.id,t.multiaddrs.map(n=>n.toString()));return}try{await this.routingTable.add(t.id)}catch(n){this.log.error("could not add %p to routing table",t.id,n)}}isStarted(){return this.running}getMode(){return this.clientMode?"client":"server"}async setMode(t,n=!1){if(t===this.getMode()&&!n){this.log("already in %s mode",t);return}if(await this.components.registrar.unhandle(this.protocol),t===this.getMode()&&!n){this.log("already in %s mode",t);return}t==="client"?(this.log("enabling client mode while in %s mode",this.getMode()),this.clientMode=!0):(this.log("enabling server mode while in %s mode",this.getMode()),this.clientMode=!1,await this.components.registrar.handle(this.protocol,this.rpc.onIncomingStream.bind(this.rpc),{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams}))}async start(){this.running||(this.running=!0,await this.setMode(this.clientMode?"client":"server",!0),await Vo(this.routingTable,this.queryManager,this.network,this.topologyListener,this.routingTableRefresh,this.reprovider),await Vo(this.querySelf))}async stop(){this.running=!1,await Bc(this.querySelf,this.queryManager,this.network,this.routingTable,this.routingTableRefresh,this.topologyListener,this.reprovider)}async*put(t,n,i={}){yield*this.contentFetching.put(t,n,i)}async*get(t,n={}){yield*this.contentFetching.get(t,n)}async*provide(t,n={}){yield*this.contentRouting.provide(t,this.components.addressManager.getAddresses(),n)}async cancelReprovide(t){await this.providers.removeProvider(t,this.components.peerId)}async*findProviders(t,n={}){yield*this.contentRouting.findProviders(t,n)}async*findPeer(t,n={}){yield*this.peerRouting.findPeer(t,n)}async*getClosestPeers(t,n={}){yield*this.peerRouting.getClosestPeers(t,n)}async refreshRoutingTable(){this.routingTableRefresh.refreshTable(!0)}}var qv;(function(r){r[r.SEND_QUERY=0]="SEND_QUERY",r[r.PEER_RESPONSE=1]="PEER_RESPONSE",r[r.FINAL_PEER=2]="FINAL_PEER",r[r.QUERY_ERROR=3]="QUERY_ERROR",r[r.PROVIDER=4]="PROVIDER",r[r.VALUE=5]="VALUE",r[r.ADD_PEER=6]="ADD_PEER",r[r.DIAL_PEER=7]="DIAL_PEER"})(qv||(qv={}));function v5e(r={}){return e=>new b5e(e,r)}var E5e=r=>{if(Object.prototype.toString.call(r)!=="[object Object]")return!1;const e=Object.getPrototypeOf(r);return e===null||e===Object.prototype};const xm=E5e,{hasOwnProperty:lK}=Object.prototype,{propertyIsEnumerable:S5e}=Object,dh=(r,e,t)=>Object.defineProperty(r,e,{value:t,writable:!0,enumerable:!0,configurable:!0}),x5e=v1,fP={concatArrays:!1,ignoreUndefined:!1},Kw=r=>{const e=[];for(const t in r)lK.call(r,t)&&e.push(t);if(Object.getOwnPropertySymbols){const t=Object.getOwnPropertySymbols(r);for(const n of t)S5e.call(r,n)&&e.push(n)}return e};function Uh(r){return Array.isArray(r)?A5e(r):xm(r)?C5e(r):r}function A5e(r){const e=r.slice(0,0);return Kw(r).forEach(t=>{dh(e,t,Uh(r[t]))}),e}function C5e(r){const e=Object.getPrototypeOf(r)===null?Object.create(null):{};return Kw(r).forEach(t=>{dh(e,t,Uh(r[t]))}),e}const uK=(r,e,t,n)=>(t.forEach(i=>{typeof e[i]>"u"&&n.ignoreUndefined||(i in r&&r[i]!==Object.getPrototypeOf(r)?dh(r,i,Wv(r[i],e[i],n)):dh(r,i,Uh(e[i])))}),r),I5e=(r,e,t)=>{let n=r.slice(0,0),i=0;return[r,e].forEach(s=>{const o=[];for(let a=0;a<s.length;a++)lK.call(s,a)&&(o.push(String(a)),s===r?dh(n,i++,s[a]):dh(n,i++,Uh(s[a])));n=uK(n,s,Kw(s).filter(a=>!o.includes(a)),t)}),n};function Wv(r,e,t){return t.concatArrays&&Array.isArray(r)&&Array.isArray(e)?I5e(r,e,t):!xm(e)||!xm(r)?Uh(e):uK(r,e,Kw(e),t)}var k5e=function(...r){const e=Wv(Uh(fP),this!==x5e&&this||{},fP);let t={_:{}};for(const n of r)if(n!==void 0){if(!xm(n))throw new TypeError("`"+n+"` is not an Option Object");t=Wv(t,{_:n},e)}return t._};const $x=Nc(k5e);function _5e(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function T5e(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var i=0;i<r.length;i++){var s=r.charAt(i),o=s.charCodeAt(0);if(t[o]!==255)throw new TypeError(s+" is ambiguous");t[o]=i}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),d=Math.log(256)/Math.log(a);function h(f){if(f instanceof Uint8Array||(ArrayBuffer.isView(f)?f=new Uint8Array(f.buffer,f.byteOffset,f.byteLength):Array.isArray(f)&&(f=Uint8Array.from(f))),!(f instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(f.length===0)return"";for(var g=0,v=0,y=0,w=f.length;y!==w&&f[y]===0;)y++,g++;for(var b=(w-y)*d+1>>>0,E=new Uint8Array(b);y!==w;){for(var A=f[y],k=0,x=b-1;(A!==0||k<v)&&x!==-1;x--,k++)A+=256*E[x]>>>0,E[x]=A%a>>>0,A=A/a>>>0;if(A!==0)throw new Error("Non-zero carry");v=k,y++}for(var I=b-v;I!==b&&E[I]===0;)I++;for(var T=c.repeat(g);I<b;++I)T+=r.charAt(E[I]);return T}function p(f){if(typeof f!="string")throw new TypeError("Expected String");if(f.length===0)return new Uint8Array;var g=0;if(f[g]!==" "){for(var v=0,y=0;f[g]===c;)v++,g++;for(var w=(f.length-g)*l+1>>>0,b=new Uint8Array(w);f[g];){var E=t[f.charCodeAt(g)];if(E===255)return;for(var A=0,k=w-1;(E!==0||A<y)&&k!==-1;k--,A++)E+=a*b[k]>>>0,b[k]=E%256>>>0,E=E/256>>>0;if(E!==0)throw new Error("Non-zero carry");y=A,g++}if(f[g]!==" "){for(var x=w-y;x!==w&&b[x]===0;)x++;for(var I=new Uint8Array(v+(w-x)),T=v;x!==w;)I[T++]=b[x++];return I}}}function m(f){var g=p(f);if(g)return g;throw new Error(`Non-${e} character`)}return{encode:h,decodeUnsafe:p,decode:m}}var P5e=T5e,D5e=P5e;let $5e=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseEncode");this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},N5e=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseDecode");u(this,"prefixCodePoint");this.name=e,this.prefix=t;const i=t.codePointAt(0);if(i===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=i,this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return dK(this,e)}},M5e=class{constructor(e){u(this,"decoders");this.decoders=e}or(e){return dK(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};function dK(r,e){return new M5e({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}let O5e=class{constructor(e,t,n,i){u(this,"name");u(this,"prefix");u(this,"baseEncode");u(this,"baseDecode");u(this,"encoder");u(this,"decoder");this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=i,this.encoder=new $5e(e,t,n),this.decoder=new N5e(e,t,i)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};function hK({name:r,prefix:e,encode:t,decode:n}){return new O5e(r,e,t,n)}function fK({name:r,prefix:e,alphabet:t}){const{encode:n,decode:i}=D5e(t,r);return hK({prefix:e,name:r,encode:n,decode:s=>_5e(i(s))})}function R5e(r,e,t,n){const i={};for(let d=0;d<e.length;++d)i[e[d]]=d;let s=r.length;for(;r[s-1]==="=";)--s;const o=new Uint8Array(s*t/8|0);let a=0,c=0,l=0;for(let d=0;d<s;++d){const h=i[r[d]];if(h===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|h,a+=t,a>=8&&(a-=8,o[l++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o}function L5e(r,e,t){const n=e[e.length-1]==="=",i=(1<<t)-1;let s="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,s+=e[i&a>>o];if(o!==0&&(s+=e[i&a<<t-o]),n)for(;s.length*t&7;)s+="=";return s}function jw({name:r,prefix:e,bitsPerChar:t,alphabet:n}){return hK({prefix:e,name:r,encode(i){return L5e(i,n,t)},decode(i){return R5e(i,n,t,r)}})}const B5e=fK({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});fK({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var U5e=pK,pP=128,F5e=-128,z5e=Math.pow(2,31);function pK(r,e,t){e=e||[],t=t||0;for(var n=t;r>=z5e;)e[t++]=r&255|pP,r/=128;for(;r&F5e;)e[t++]=r&255|pP,r>>>=7;return e[t]=r|0,pK.bytes=t-n+1,e}var V5e=Gv,K5e=128,gP=127;function Gv(r,n){var t=0,n=n||0,i=0,s=n,o,a=r.length;do{if(s>=a)throw Gv.bytes=0,new RangeError("Could not decode varint");o=r[s++],t+=i<28?(o&gP)<<i:(o&gP)*Math.pow(2,i),i+=7}while(o>=K5e);return Gv.bytes=s-n,t}var j5e=Math.pow(2,7),H5e=Math.pow(2,14),q5e=Math.pow(2,21),W5e=Math.pow(2,28),G5e=Math.pow(2,35),Q5e=Math.pow(2,42),Y5e=Math.pow(2,49),J5e=Math.pow(2,56),X5e=Math.pow(2,63),Z5e=function(r){return r<j5e?1:r<H5e?2:r<q5e?3:r<W5e?4:r<G5e?5:r<Q5e?6:r<Y5e?7:r<J5e?8:r<X5e?9:10},e8e={encode:U5e,decode:V5e,encodingLength:Z5e},gK=e8e;function yP(r,e,t=0){return gK.encode(r,e,t),e}function mP(r){return gK.encodingLength(r)}function wP(r,e){const t=e.byteLength,n=mP(r),i=n+mP(t),s=new Uint8Array(i+t);return yP(r,s,0),yP(t,s,n),s.set(e,i),new t8e(r,t,e,s)}let t8e=class{constructor(e,t,n,i){u(this,"code");u(this,"size");u(this,"digest");u(this,"bytes");this.code=e,this.size=t,this.digest=n,this.bytes=i}};function r8e({name:r,code:e,encode:t}){return new n8e(r,e,t)}let n8e=class{constructor(e,t,n){u(this,"name");u(this,"code");u(this,"encode");this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?wP(this.code,t):t.then(n=>wP(this.code,n))}else throw Error("Unknown type, must be binary type")}};function i8e(r){return async e=>new Uint8Array(await crypto.subtle.digest(r,e))}const s8e=r8e({name:"sha2-256",code:18,encode:i8e("SHA-256")});function o8e(r){return r>=55296&&r<=56319}function a8e(r){return r>=56320&&r<=57343}var c8e=function(e,t,n){if(typeof t!="string")throw new Error("Input must be string");for(var i=t.length,s=0,o,a,c=0;c<i;c+=1){if(o=t.charCodeAt(c),a=t[c],o8e(o)&&a8e(t.charCodeAt(c+1))&&(c+=1,a+=t[c]),s+=e(a),s===n)return t.slice(0,c+1);if(s>n)return t.slice(0,c-a.length+1)}return t};function l8e(r){return r>=55296&&r<=56319}function u8e(r){return r>=56320&&r<=57343}var d8e=function(e){if(typeof e!="string")throw new Error("Input must be string");for(var t=e.length,n=0,i=null,s=null,o=0;o<t;o++)i=e.charCodeAt(o),u8e(i)?s!=null&&l8e(s)?n+=1:n+=3:i<=127?n+=1:i>=128&&i<=2047?n+=2:i>=2048&&i<=65535&&(n+=3),s=i;return n},h8e=c8e,f8e=d8e,p8e=h8e.bind(null,f8e),g8e=p8e,y8e=/[\/\?<>\\:\*\|"]/g,m8e=/[\x00-\x1f\x80-\x9f]/g,w8e=/^\.+$/,b8e=/^(con|prn|aux|nul|com[0-9]|lpt[0-9])(\..*)?$/i,v8e=/[\. ]+$/;function bP(r,e){if(typeof r!="string")throw new Error("Input must be string");var t=r.replace(y8e,e).replace(m8e,e).replace(w8e,e).replace(b8e,e).replace(v8e,e);return g8e(t,255)}var E8e=function(r,e){var t=e&&e.replacement||"",n=bP(r,t);return t===""?n:bP(n,"")};const S8e=Nc(E8e),E8={alg:"A128GCM",ext:!0,k:"scm9jmO_4BJAgdwWGVulLg",key_ops:["encrypt","decrypt"],kty:"oct"};function yK(r){const e="AES-GCM";let t=16;const n=12,i="SHA-256",s=16,o=32767,a=qs.get();t*=8;async function c(h,p){const m=a.getRandomValues(new Uint8Array(s)),f=a.getRandomValues(new Uint8Array(n)),g={name:e,iv:f};typeof p=="string"&&(p=oe(p));let v;if(p.length===0){v=await a.subtle.importKey("jwk",E8,{name:"AES-GCM"},!0,["encrypt"]);try{const w={name:"PBKDF2",salt:m,iterations:o,hash:{name:i}},b=await a.subtle.importKey("raw",p,{name:"PBKDF2"},!1,["deriveKey"]);v=await a.subtle.deriveKey(w,b,{name:e,length:t},!0,["encrypt"])}catch{v=await a.subtle.importKey("jwk",E8,{name:"AES-GCM"},!0,["encrypt"])}}else{const w={name:"PBKDF2",salt:m,iterations:o,hash:{name:i}},b=await a.subtle.importKey("raw",p,{name:"PBKDF2"},!1,["deriveKey"]);v=await a.subtle.deriveKey(w,b,{name:e,length:t},!0,["encrypt"])}const y=await a.subtle.encrypt(g,v,h);return ir([m,g.iv,new Uint8Array(y)])}async function l(h,p){const m=h.subarray(0,s),f=h.subarray(s,s+n),g=h.subarray(s+n),v={name:e,iv:f};typeof p=="string"&&(p=oe(p));let y;if(p.length===0)try{const b={name:"PBKDF2",salt:m,iterations:o,hash:{name:i}},E=await a.subtle.importKey("raw",p,{name:"PBKDF2"},!1,["deriveKey"]);y=await a.subtle.deriveKey(b,E,{name:e,length:t},!0,["decrypt"])}catch{y=await a.subtle.importKey("jwk",E8,{name:"AES-GCM"},!0,["decrypt"])}else{const b={name:"PBKDF2",salt:m,iterations:o,hash:{name:i}},E=await a.subtle.importKey("raw",p,{name:"PBKDF2"},!1,["deriveKey"]);y=await a.subtle.deriveKey(b,E,{name:e,length:t},!0,["decrypt"])}const w=await a.subtle.decrypt(v,y,g);return new Uint8Array(w)}return{encrypt:c,decrypt:l}}/*!
 * MIT License
 * 
 * Copyright (c) 2017-2024 Peculiar Ventures, LLC
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 * 
 */const x8e="[object ArrayBuffer]";class de{static isArrayBuffer(e){return Object.prototype.toString.call(e)===x8e}static toArrayBuffer(e){return this.isArrayBuffer(e)?e:e.byteLength===e.buffer.byteLength||e.byteOffset===0&&e.byteLength===e.buffer.byteLength?e.buffer:this.toUint8Array(e.buffer).slice(e.byteOffset,e.byteOffset+e.byteLength).buffer}static toUint8Array(e){return this.toView(e,Uint8Array)}static toView(e,t){if(e.constructor===t)return e;if(this.isArrayBuffer(e))return new t(e);if(this.isArrayBufferView(e))return new t(e.buffer,e.byteOffset,e.byteLength);throw new TypeError("The provided value is not of type '(ArrayBuffer or ArrayBufferView)'")}static isBufferSource(e){return this.isArrayBufferView(e)||this.isArrayBuffer(e)}static isArrayBufferView(e){return ArrayBuffer.isView(e)||e&&this.isArrayBuffer(e.buffer)}static isEqual(e,t){const n=de.toUint8Array(e),i=de.toUint8Array(t);if(n.length!==i.byteLength)return!1;for(let s=0;s<n.length;s++)if(n[s]!==i[s])return!1;return!0}static concat(...e){let t;Array.isArray(e[0])&&!(e[1]instanceof Function)||Array.isArray(e[0])&&e[1]instanceof Function?t=e[0]:e[e.length-1]instanceof Function?t=e.slice(0,e.length-1):t=e;let n=0;for(const o of t)n+=o.byteLength;const i=new Uint8Array(n);let s=0;for(const o of t){const a=this.toUint8Array(o);i.set(a,s),s+=a.length}return e[e.length-1]instanceof Function?this.toView(i,e[e.length-1]):i.buffer}}const S8="string",A8e=/^[0-9a-f\s]+$/i,C8e=/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/,I8e=/^[a-zA-Z0-9-_]+$/;class vP{static fromString(e){const t=unescape(encodeURIComponent(e)),n=new Uint8Array(t.length);for(let i=0;i<t.length;i++)n[i]=t.charCodeAt(i);return n.buffer}static toString(e){const t=de.toUint8Array(e);let n="";for(let s=0;s<t.length;s++)n+=String.fromCharCode(t[s]);return decodeURIComponent(escape(n))}}class _s{static toString(e,t=!1){const n=de.toArrayBuffer(e),i=new DataView(n);let s="";for(let o=0;o<n.byteLength;o+=2){const a=i.getUint16(o,t);s+=String.fromCharCode(a)}return s}static fromString(e,t=!1){const n=new ArrayBuffer(e.length*2),i=new DataView(n);for(let s=0;s<e.length;s++)i.setUint16(s*2,e.charCodeAt(s),t);return n}}class Se{static isHex(e){return typeof e===S8&&A8e.test(e)}static isBase64(e){return typeof e===S8&&C8e.test(e)}static isBase64Url(e){return typeof e===S8&&I8e.test(e)}static ToString(e,t="utf8"){const n=de.toUint8Array(e);switch(t.toLowerCase()){case"utf8":return this.ToUtf8String(n);case"binary":return this.ToBinary(n);case"hex":return this.ToHex(n);case"base64":return this.ToBase64(n);case"base64url":return this.ToBase64Url(n);case"utf16le":return _s.toString(n,!0);case"utf16":case"utf16be":return _s.toString(n);default:throw new Error(`Unknown type of encoding '${t}'`)}}static FromString(e,t="utf8"){if(!e)return new ArrayBuffer(0);switch(t.toLowerCase()){case"utf8":return this.FromUtf8String(e);case"binary":return this.FromBinary(e);case"hex":return this.FromHex(e);case"base64":return this.FromBase64(e);case"base64url":return this.FromBase64Url(e);case"utf16le":return _s.fromString(e,!0);case"utf16":case"utf16be":return _s.fromString(e);default:throw new Error(`Unknown type of encoding '${t}'`)}}static ToBase64(e){const t=de.toUint8Array(e);if(typeof btoa<"u"){const n=this.ToString(t,"binary");return btoa(n)}else return Buffer.from(t).toString("base64")}static FromBase64(e){const t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!Se.isBase64(t))throw new TypeError("Argument 'base64Text' is not Base64 encoded");return typeof atob<"u"?this.FromBinary(atob(t)):new Uint8Array(Buffer.from(t,"base64")).buffer}static FromBase64Url(e){const t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!Se.isBase64Url(t))throw new TypeError("Argument 'base64url' is not Base64Url encoded");return this.FromBase64(this.Base64Padding(t.replace(/\-/g,"+").replace(/\_/g,"/")))}static ToBase64Url(e){return this.ToBase64(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/\=/g,"")}static FromUtf8String(e,t=Se.DEFAULT_UTF8_ENCODING){switch(t){case"ascii":return this.FromBinary(e);case"utf8":return vP.fromString(e);case"utf16":case"utf16be":return _s.fromString(e);case"utf16le":case"usc2":return _s.fromString(e,!0);default:throw new Error(`Unknown type of encoding '${t}'`)}}static ToUtf8String(e,t=Se.DEFAULT_UTF8_ENCODING){switch(t){case"ascii":return this.ToBinary(e);case"utf8":return vP.toString(e);case"utf16":case"utf16be":return _s.toString(e);case"utf16le":case"usc2":return _s.toString(e,!0);default:throw new Error(`Unknown type of encoding '${t}'`)}}static FromBinary(e){const t=e.length,n=new Uint8Array(t);for(let i=0;i<t;i++)n[i]=e.charCodeAt(i);return n.buffer}static ToBinary(e){const t=de.toUint8Array(e);let n="";for(let i=0;i<t.length;i++)n+=String.fromCharCode(t[i]);return n}static ToHex(e){const t=de.toUint8Array(e);let n="";const i=t.length;for(let s=0;s<i;s++){const o=t[s];o<16&&(n+="0"),n+=o.toString(16)}return n}static FromHex(e){let t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!Se.isHex(t))throw new TypeError("Argument 'hexString' is not HEX encoded");t.length%2&&(t=`0${t}`);const n=new Uint8Array(t.length/2);for(let i=0;i<t.length;i=i+2){const s=t.slice(i,i+2);n[i/2]=parseInt(s,16)}return n.buffer}static ToUtf16String(e,t=!1){return _s.toString(e,t)}static FromUtf16String(e,t=!1){return _s.fromString(e,t)}static Base64Padding(e){const t=4-e.length%4;if(t<4)for(let n=0;n<t;n++)e+="=";return e}static formatString(e){return(e==null?void 0:e.replace(/[\n\r\t ]/g,""))||""}}Se.DEFAULT_UTF8_ENCODING="utf8";function k8e(...r){const e=r.map(i=>i.byteLength).reduce((i,s)=>i+s),t=new Uint8Array(e);let n=0;return r.map(i=>new Uint8Array(i)).forEach(i=>{for(const s of i)t[n++]=s}),t.buffer}function mK(r,e){if(!(r&&e)||r.byteLength!==e.byteLength)return!1;const t=new Uint8Array(r),n=new Uint8Array(e);for(let i=0;i<r.byteLength;i++)if(t[i]!==n[i])return!1;return!0}/*!
 Copyright (c) Peculiar Ventures, LLC
*/function hh(r,e){let t=0;if(r.length===1)return r[0];for(let n=r.length-1;n>=0;n--)t+=r[r.length-1-n]*Math.pow(2,e*n);return t}function ru(r,e,t=-1){const n=t;let i=r,s=0,o=Math.pow(2,e);for(let a=1;a<8;a++){if(r<o){let c;if(n<0)c=new ArrayBuffer(a),s=a;else{if(n<a)return new ArrayBuffer(0);c=new ArrayBuffer(n),s=n}const l=new Uint8Array(c);for(let d=a-1;d>=0;d--){const h=Math.pow(2,d*e);l[s-d-1]=Math.floor(i/h),i-=l[s-d-1]*h}return c}o*=Math.pow(2,e)}return new ArrayBuffer(0)}function Qv(...r){let e=0,t=0;for(const s of r)e+=s.length;const n=new ArrayBuffer(e),i=new Uint8Array(n);for(const s of r)i.set(s,t),t+=s.length;return i}function wK(){const r=new Uint8Array(this.valueHex);if(this.valueHex.byteLength>=2){const a=r[0]===255&&r[1]&128,c=r[0]===0&&(r[1]&128)===0;(a||c)&&this.warnings.push("Needlessly long format")}const e=new ArrayBuffer(this.valueHex.byteLength),t=new Uint8Array(e);for(let a=0;a<this.valueHex.byteLength;a++)t[a]=0;t[0]=r[0]&128;const n=hh(t,8),i=new ArrayBuffer(this.valueHex.byteLength),s=new Uint8Array(i);for(let a=0;a<this.valueHex.byteLength;a++)s[a]=r[a];return s[0]&=127,hh(s,8)-n}function _8e(r){const e=r<0?r*-1:r;let t=128;for(let n=1;n<8;n++){if(e<=t){if(r<0){const o=t-e,a=ru(o,8,n),c=new Uint8Array(a);return c[0]|=128,a}let i=ru(e,8,n),s=new Uint8Array(i);if(s[0]&128){const o=i.slice(0),a=new Uint8Array(o);i=new ArrayBuffer(i.byteLength+1),s=new Uint8Array(i);for(let c=0;c<o.byteLength;c++)s[c+1]=a[c];s[0]=0}return i}t*=Math.pow(2,8)}return new ArrayBuffer(0)}function T8e(r,e){if(r.byteLength!==e.byteLength)return!1;const t=new Uint8Array(r),n=new Uint8Array(e);for(let i=0;i<t.length;i++)if(t[i]!==n[i])return!1;return!0}function Wn(r,e){const t=r.toString(10);if(e<t.length)return"";const n=e-t.length,i=new Array(n);for(let o=0;o<n;o++)i[o]="0";return i.join("").concat(t)}/*!
 * Copyright (c) 2014, GMO GlobalSign
 * Copyright (c) 2015-2022, Peculiar Ventures
 * All rights reserved.
 * 
 * Author 2014-2019, Yury Strozhevsky
 * 
 * Redistribution and use in source and binary forms, with or without modification,
 * are permitted provided that the following conditions are met:
 * 
 * * Redistributions of source code must retain the above copyright notice, this
 *   list of conditions and the following disclaimer.
 * 
 * * Redistributions in binary form must reproduce the above copyright notice, this
 *   list of conditions and the following disclaimer in the documentation and/or
 *   other materials provided with the distribution.
 * 
 * * Neither the name of the copyright holder nor the names of its
 *   contributors may be used to endorse or promote products derived from
 *   this software without specific prior written permission.
 * 
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR
 * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
 * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 * 
 */function Am(){if(typeof BigInt>"u")throw new Error("BigInt is not defined. Your environment doesn't implement BigInt.")}function Nx(r){let e=0,t=0;for(let i=0;i<r.length;i++){const s=r[i];e+=s.byteLength}const n=new Uint8Array(e);for(let i=0;i<r.length;i++){const s=r[i];n.set(new Uint8Array(s),t),t+=s.byteLength}return n.buffer}function oa(r,e,t,n){return e instanceof Uint8Array?e.byteLength?t<0?(r.error="Wrong parameter: inputOffset less than zero",!1):n<0?(r.error="Wrong parameter: inputLength less than zero",!1):e.byteLength-t-n<0?(r.error="End of input reached before message was fully decoded (inconsistent offset and length values)",!1):!0:(r.error="Wrong parameter: inputBuffer has zero length",!1):(r.error="Wrong parameter: inputBuffer must be 'Uint8Array'",!1)}class Hw{constructor(){this.items=[]}write(e){this.items.push(e)}final(){return Nx(this.items)}}const Nf=[new Uint8Array([1])],EP="0123456789",x8="name",SP="valueHexView",P8e="isHexOnly",D8e="idBlock",$8e="tagClass",N8e="tagNumber",M8e="isConstructed",O8e="fromBER",R8e="toBER",L8e="local",xn="",ys=new ArrayBuffer(0),qw=new Uint8Array(0),op="EndOfContent",bK="OCTET STRING",vK="BIT STRING";function Xs(r){var e;return e=class extends r{get valueHex(){return this.valueHexView.slice().buffer}set valueHex(n){this.valueHexView=new Uint8Array(n)}constructor(...n){var i;super(...n);const s=n[0]||{};this.isHexOnly=(i=s.isHexOnly)!==null&&i!==void 0?i:!1,this.valueHexView=s.valueHex?de.toUint8Array(s.valueHex):qw}fromBER(n,i,s){const o=n instanceof ArrayBuffer?new Uint8Array(n):n;if(!oa(this,o,i,s))return-1;const a=i+s;return this.valueHexView=o.subarray(i,a),this.valueHexView.length?(this.blockLength=s,a):(this.warnings.push("Zero buffer length"),i)}toBER(n=!1){return this.isHexOnly?n?new ArrayBuffer(this.valueHexView.byteLength):this.valueHexView.byteLength===this.valueHexView.buffer.byteLength?this.valueHexView.buffer:this.valueHexView.slice().buffer:(this.error="Flag 'isHexOnly' is not set, abort",ys)}toJSON(){return{...super.toJSON(),isHexOnly:this.isHexOnly,valueHex:Se.ToHex(this.valueHexView)}}},e.NAME="hexBlock",e}class xu{static blockName(){return this.NAME}get valueBeforeDecode(){return this.valueBeforeDecodeView.slice().buffer}set valueBeforeDecode(e){this.valueBeforeDecodeView=new Uint8Array(e)}constructor({blockLength:e=0,error:t=xn,warnings:n=[],valueBeforeDecode:i=qw}={}){this.blockLength=e,this.error=t,this.warnings=n,this.valueBeforeDecodeView=de.toUint8Array(i)}toJSON(){return{blockName:this.constructor.NAME,blockLength:this.blockLength,error:this.error,warnings:this.warnings,valueBeforeDecode:Se.ToHex(this.valueBeforeDecodeView)}}}xu.NAME="baseBlock";class yn extends xu{fromBER(e,t,n){throw TypeError("User need to make a specific function in a class which extends 'ValueBlock'")}toBER(e,t){throw TypeError("User need to make a specific function in a class which extends 'ValueBlock'")}}yn.NAME="valueBlock";class EK extends Xs(xu){constructor({idBlock:e={}}={}){var t,n,i,s;super(),e?(this.isHexOnly=(t=e.isHexOnly)!==null&&t!==void 0?t:!1,this.valueHexView=e.valueHex?de.toUint8Array(e.valueHex):qw,this.tagClass=(n=e.tagClass)!==null&&n!==void 0?n:-1,this.tagNumber=(i=e.tagNumber)!==null&&i!==void 0?i:-1,this.isConstructed=(s=e.isConstructed)!==null&&s!==void 0?s:!1):(this.tagClass=-1,this.tagNumber=-1,this.isConstructed=!1)}toBER(e=!1){let t=0;switch(this.tagClass){case 1:t|=0;break;case 2:t|=64;break;case 3:t|=128;break;case 4:t|=192;break;default:return this.error="Unknown tag class",ys}if(this.isConstructed&&(t|=32),this.tagNumber<31&&!this.isHexOnly){const i=new Uint8Array(1);if(!e){let s=this.tagNumber;s&=31,t|=s,i[0]=t}return i.buffer}if(!this.isHexOnly){const i=ru(this.tagNumber,7),s=new Uint8Array(i),o=i.byteLength,a=new Uint8Array(o+1);if(a[0]=t|31,!e){for(let c=0;c<o-1;c++)a[c+1]=s[c]|128;a[o]=s[o-1]}return a.buffer}const n=new Uint8Array(this.valueHexView.byteLength+1);if(n[0]=t|31,!e){const i=this.valueHexView;for(let s=0;s<i.length-1;s++)n[s+1]=i[s]|128;n[this.valueHexView.byteLength]=i[i.length-1]}return n.buffer}fromBER(e,t,n){const i=de.toUint8Array(e);if(!oa(this,i,t,n))return-1;const s=i.subarray(t,t+n);if(s.length===0)return this.error="Zero buffer length",-1;switch(s[0]&192){case 0:this.tagClass=1;break;case 64:this.tagClass=2;break;case 128:this.tagClass=3;break;case 192:this.tagClass=4;break;default:return this.error="Unknown tag class",-1}this.isConstructed=(s[0]&32)===32,this.isHexOnly=!1;const a=s[0]&31;if(a!==31)this.tagNumber=a,this.blockLength=1;else{let c=1,l=this.valueHexView=new Uint8Array(255),d=255;for(;s[c]&128;){if(l[c-1]=s[c]&127,c++,c>=s.length)return this.error="End of input reached before message was fully decoded",-1;if(c===d){d+=255;const p=new Uint8Array(d);for(let m=0;m<l.length;m++)p[m]=l[m];l=this.valueHexView=new Uint8Array(d)}}this.blockLength=c+1,l[c-1]=s[c]&127;const h=new Uint8Array(c);for(let p=0;p<c;p++)h[p]=l[p];l=this.valueHexView=new Uint8Array(c),l.set(h),this.blockLength<=9?this.tagNumber=hh(l,7):(this.isHexOnly=!0,this.warnings.push("Tag too long, represented as hex-coded"))}if(this.tagClass===1&&this.isConstructed)switch(this.tagNumber){case 1:case 2:case 5:case 6:case 9:case 13:case 14:case 23:case 24:case 31:case 32:case 33:case 34:return this.error="Constructed encoding used for primitive type",-1}return t+this.blockLength}toJSON(){return{...super.toJSON(),tagClass:this.tagClass,tagNumber:this.tagNumber,isConstructed:this.isConstructed}}}EK.NAME="identificationBlock";class SK extends xu{constructor({lenBlock:e={}}={}){var t,n,i;super(),this.isIndefiniteForm=(t=e.isIndefiniteForm)!==null&&t!==void 0?t:!1,this.longFormUsed=(n=e.longFormUsed)!==null&&n!==void 0?n:!1,this.length=(i=e.length)!==null&&i!==void 0?i:0}fromBER(e,t,n){const i=de.toUint8Array(e);if(!oa(this,i,t,n))return-1;const s=i.subarray(t,t+n);if(s.length===0)return this.error="Zero buffer length",-1;if(s[0]===255)return this.error="Length block 0xFF is reserved by standard",-1;if(this.isIndefiniteForm=s[0]===128,this.isIndefiniteForm)return this.blockLength=1,t+this.blockLength;if(this.longFormUsed=!!(s[0]&128),this.longFormUsed===!1)return this.length=s[0],this.blockLength=1,t+this.blockLength;const o=s[0]&127;if(o>8)return this.error="Too big integer",-1;if(o+1>s.length)return this.error="End of input reached before message was fully decoded",-1;const a=t+1,c=i.subarray(a,a+o);return c[o-1]===0&&this.warnings.push("Needlessly long encoded length"),this.length=hh(c,8),this.longFormUsed&&this.length<=127&&this.warnings.push("Unnecessary usage of long length form"),this.blockLength=o+1,t+this.blockLength}toBER(e=!1){let t,n;if(this.length>127&&(this.longFormUsed=!0),this.isIndefiniteForm)return t=new ArrayBuffer(1),e===!1&&(n=new Uint8Array(t),n[0]=128),t;if(this.longFormUsed){const i=ru(this.length,8);if(i.byteLength>127)return this.error="Too big length",ys;if(t=new ArrayBuffer(i.byteLength+1),e)return t;const s=new Uint8Array(i);n=new Uint8Array(t),n[0]=i.byteLength|128;for(let o=0;o<i.byteLength;o++)n[o+1]=s[o];return t}return t=new ArrayBuffer(1),e===!1&&(n=new Uint8Array(t),n[0]=this.length),t}toJSON(){return{...super.toJSON(),isIndefiniteForm:this.isIndefiniteForm,longFormUsed:this.longFormUsed,length:this.length}}}SK.NAME="lengthBlock";const we={};class Cr extends xu{constructor({name:e=xn,optional:t=!1,primitiveSchema:n,...i}={},s){super(i),this.name=e,this.optional=t,n&&(this.primitiveSchema=n),this.idBlock=new EK(i),this.lenBlock=new SK(i),this.valueBlock=s?new s(i):new yn(i)}fromBER(e,t,n){const i=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?n:this.lenBlock.length);return i===-1?(this.error=this.valueBlock.error,i):(this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),i)}toBER(e,t){const n=t||new Hw;t||xK(this);const i=this.idBlock.toBER(e);if(n.write(i),this.lenBlock.isIndefiniteForm)n.write(new Uint8Array([128]).buffer),this.valueBlock.toBER(e,n),n.write(new ArrayBuffer(2));else{const s=this.valueBlock.toBER(e);this.lenBlock.length=s.byteLength;const o=this.lenBlock.toBER(e);n.write(o),n.write(s)}return t?ys:n.final()}toJSON(){const e={...super.toJSON(),idBlock:this.idBlock.toJSON(),lenBlock:this.lenBlock.toJSON(),valueBlock:this.valueBlock.toJSON(),name:this.name,optional:this.optional};return this.primitiveSchema&&(e.primitiveSchema=this.primitiveSchema.toJSON()),e}toString(e="ascii"){return e==="ascii"?this.onAsciiEncoding():Se.ToHex(this.toBER())}onAsciiEncoding(){const e=this.constructor.NAME,t=Se.ToHex(this.valueBlock.valueBeforeDecodeView);return`${e} : ${t}`}isEqual(e){if(this===e)return!0;if(!(e instanceof this.constructor))return!1;const t=this.toBER(),n=e.toBER();return T8e(t,n)}}Cr.NAME="BaseBlock";function xK(r){var e;if(r instanceof we.Constructed)for(const t of r.valueBlock.value)xK(t)&&(r.lenBlock.isIndefiniteForm=!0);return!!(!((e=r.lenBlock)===null||e===void 0)&&e.isIndefiniteForm)}class Mx extends Cr{getValue(){return this.valueBlock.value}setValue(e){this.valueBlock.value=e}constructor({value:e=xn,...t}={},n){super(t,n),e&&this.fromString(e)}fromBER(e,t,n){const i=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?n:this.lenBlock.length);return i===-1?(this.error=this.valueBlock.error,i):(this.fromBuffer(this.valueBlock.valueHexView),this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),i)}onAsciiEncoding(){return`${this.constructor.NAME} : '${this.valueBlock.value}'`}}Mx.NAME="BaseStringBlock";class AK extends Xs(yn){constructor({isHexOnly:e=!0,...t}={}){super(t),this.isHexOnly=e}}AK.NAME="PrimitiveValueBlock";var CK;class Yp extends Cr{constructor(e={}){super(e,AK),this.idBlock.isConstructed=!1}}CK=Yp;we.Primitive=CK;Yp.NAME="PRIMITIVE";function B8e(r,e){if(r instanceof e)return r;const t=new e;return t.idBlock=r.idBlock,t.lenBlock=r.lenBlock,t.warnings=r.warnings,t.valueBeforeDecodeView=r.valueBeforeDecodeView,t}function Fh(r,e=0,t=r.length){const n=e;let i=new Cr({},yn);const s=new xu;if(!oa(s,r,e,t))return i.error=s.error,{offset:-1,result:i};if(!r.subarray(e,e+t).length)return i.error="Zero buffer length",{offset:-1,result:i};let a=i.idBlock.fromBER(r,e,t);if(i.idBlock.warnings.length&&i.warnings.concat(i.idBlock.warnings),a===-1)return i.error=i.idBlock.error,{offset:-1,result:i};if(e=a,t-=i.idBlock.blockLength,a=i.lenBlock.fromBER(r,e,t),i.lenBlock.warnings.length&&i.warnings.concat(i.lenBlock.warnings),a===-1)return i.error=i.lenBlock.error,{offset:-1,result:i};if(e=a,t-=i.lenBlock.blockLength,!i.idBlock.isConstructed&&i.lenBlock.isIndefiniteForm)return i.error="Indefinite length form used for primitive encoding form",{offset:-1,result:i};let c=Cr;switch(i.idBlock.tagClass){case 1:if(i.idBlock.tagNumber>=37&&i.idBlock.isHexOnly===!1)return i.error="UNIVERSAL 37 and upper tags are reserved by ASN.1 standard",{offset:-1,result:i};switch(i.idBlock.tagNumber){case 0:if(i.idBlock.isConstructed&&i.lenBlock.length>0)return i.error="Type [UNIVERSAL 0] is reserved",{offset:-1,result:i};c=we.EndOfContent;break;case 1:c=we.Boolean;break;case 2:c=we.Integer;break;case 3:c=we.BitString;break;case 4:c=we.OctetString;break;case 5:c=we.Null;break;case 6:c=we.ObjectIdentifier;break;case 10:c=we.Enumerated;break;case 12:c=we.Utf8String;break;case 13:c=we.RelativeObjectIdentifier;break;case 14:c=we.TIME;break;case 15:return i.error="[UNIVERSAL 15] is reserved by ASN.1 standard",{offset:-1,result:i};case 16:c=we.Sequence;break;case 17:c=we.Set;break;case 18:c=we.NumericString;break;case 19:c=we.PrintableString;break;case 20:c=we.TeletexString;break;case 21:c=we.VideotexString;break;case 22:c=we.IA5String;break;case 23:c=we.UTCTime;break;case 24:c=we.GeneralizedTime;break;case 25:c=we.GraphicString;break;case 26:c=we.VisibleString;break;case 27:c=we.GeneralString;break;case 28:c=we.UniversalString;break;case 29:c=we.CharacterString;break;case 30:c=we.BmpString;break;case 31:c=we.DATE;break;case 32:c=we.TimeOfDay;break;case 33:c=we.DateTime;break;case 34:c=we.Duration;break;default:{const l=i.idBlock.isConstructed?new we.Constructed:new we.Primitive;l.idBlock=i.idBlock,l.lenBlock=i.lenBlock,l.warnings=i.warnings,i=l}}break;case 2:case 3:case 4:default:c=i.idBlock.isConstructed?we.Constructed:we.Primitive}return i=B8e(i,c),a=i.fromBER(r,e,i.lenBlock.isIndefiniteForm?t:i.lenBlock.length),i.valueBeforeDecodeView=r.subarray(n,n+i.blockLength),{offset:a,result:i}}function $o(r){if(!r.byteLength){const e=new Cr({},yn);return e.error="Input buffer has zero length",{offset:-1,result:e}}return Fh(de.toUint8Array(r).slice(),0,r.byteLength)}function U8e(r,e){return r?1:e}class pc extends yn{constructor({value:e=[],isIndefiniteForm:t=!1,...n}={}){super(n),this.value=e,this.isIndefiniteForm=t}fromBER(e,t,n){const i=de.toUint8Array(e);if(!oa(this,i,t,n))return-1;if(this.valueBeforeDecodeView=i.subarray(t,t+n),this.valueBeforeDecodeView.length===0)return this.warnings.push("Zero buffer length"),t;let s=t;for(;U8e(this.isIndefiniteForm,n)>0;){const o=Fh(i,s,n);if(o.offset===-1)return this.error=o.result.error,this.warnings.concat(o.result.warnings),-1;if(s=o.offset,this.blockLength+=o.result.blockLength,n-=o.result.blockLength,this.value.push(o.result),this.isIndefiniteForm&&o.result.constructor.NAME===op)break}return this.isIndefiniteForm&&(this.value[this.value.length-1].constructor.NAME===op?this.value.pop():this.warnings.push("No EndOfContent block encoded")),s}toBER(e,t){const n=t||new Hw;for(let i=0;i<this.value.length;i++)this.value[i].toBER(e,n);return t?ys:n.final()}toJSON(){const e={...super.toJSON(),isIndefiniteForm:this.isIndefiniteForm,value:[]};for(const t of this.value)e.value.push(t.toJSON());return e}}pc.NAME="ConstructedValueBlock";var IK;class $n extends Cr{constructor(e={}){super(e,pc),this.idBlock.isConstructed=!0}fromBER(e,t,n){this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm;const i=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?n:this.lenBlock.length);return i===-1?(this.error=this.valueBlock.error,i):(this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),i)}onAsciiEncoding(){const e=[];for(const n of this.valueBlock.value)e.push(n.toString("ascii").split(`
`).map(i=>`  ${i}`).join(`
`));const t=this.idBlock.tagClass===3?`[${this.idBlock.tagNumber}]`:this.constructor.NAME;return e.length?`${t} :
${e.join(`
`)}`:`${t} :`}}IK=$n;we.Constructed=IK;$n.NAME="CONSTRUCTED";class kK extends yn{fromBER(e,t,n){return t}toBER(e){return ys}}kK.override="EndOfContentValueBlock";var _K;class Ox extends Cr{constructor(e={}){super(e,kK),this.idBlock.tagClass=1,this.idBlock.tagNumber=0}}_K=Ox;we.EndOfContent=_K;Ox.NAME=op;var TK;class Ko extends Cr{constructor(e={}){super(e,yn),this.idBlock.tagClass=1,this.idBlock.tagNumber=5}fromBER(e,t,n){return this.lenBlock.length>0&&this.warnings.push("Non-zero length of value block for Null type"),this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.blockLength+=n,t+n>e.byteLength?(this.error="End of input reached before message was fully decoded (inconsistent offset and length values)",-1):t+n}toBER(e,t){const n=new ArrayBuffer(2);if(!e){const i=new Uint8Array(n);i[0]=5,i[1]=0}return t&&t.write(n),n}onAsciiEncoding(){return`${this.constructor.NAME}`}}TK=Ko;we.Null=TK;Ko.NAME="NULL";class PK extends Xs(yn){get value(){for(const e of this.valueHexView)if(e>0)return!0;return!1}set value(e){this.valueHexView[0]=e?255:0}constructor({value:e,...t}={}){super(t),t.valueHex?this.valueHexView=de.toUint8Array(t.valueHex):this.valueHexView=new Uint8Array(1),e&&(this.value=e)}fromBER(e,t,n){const i=de.toUint8Array(e);return oa(this,i,t,n)?(this.valueHexView=i.subarray(t,t+n),n>1&&this.warnings.push("Boolean value encoded in more then 1 octet"),this.isHexOnly=!0,wK.call(this),this.blockLength=n,t+n):-1}toBER(){return this.valueHexView.slice()}toJSON(){return{...super.toJSON(),value:this.value}}}PK.NAME="BooleanValueBlock";var DK;let Ww=class extends Cr{getValue(){return this.valueBlock.value}setValue(e){this.valueBlock.value=e}constructor(e={}){super(e,PK),this.idBlock.tagClass=1,this.idBlock.tagNumber=1}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.getValue}`}};DK=Ww;we.Boolean=DK;Ww.NAME="BOOLEAN";class $K extends Xs(pc){constructor({isConstructed:e=!1,...t}={}){super(t),this.isConstructed=e}fromBER(e,t,n){let i=0;if(this.isConstructed){if(this.isHexOnly=!1,i=pc.prototype.fromBER.call(this,e,t,n),i===-1)return i;for(let s=0;s<this.value.length;s++){const o=this.value[s].constructor.NAME;if(o===op){if(this.isIndefiniteForm)break;return this.error="EndOfContent is unexpected, OCTET STRING may consists of OCTET STRINGs only",-1}if(o!==bK)return this.error="OCTET STRING may consists of OCTET STRINGs only",-1}}else this.isHexOnly=!0,i=super.fromBER(e,t,n),this.blockLength=n;return i}toBER(e,t){return this.isConstructed?pc.prototype.toBER.call(this,e,t):e?new ArrayBuffer(this.valueHexView.byteLength):this.valueHexView.slice().buffer}toJSON(){return{...super.toJSON(),isConstructed:this.isConstructed}}}$K.NAME="OctetStringValueBlock";var Rx;let ns=class extends Cr{constructor({idBlock:e={},lenBlock:t={},...n}={}){var i,s;(i=n.isConstructed)!==null&&i!==void 0||(n.isConstructed=!!(!((s=n.value)===null||s===void 0)&&s.length)),super({idBlock:{isConstructed:n.isConstructed,...e},lenBlock:{...t,isIndefiniteForm:!!n.isIndefiniteForm},...n},$K),this.idBlock.tagClass=1,this.idBlock.tagNumber=4}fromBER(e,t,n){if(this.valueBlock.isConstructed=this.idBlock.isConstructed,this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm,n===0)return this.idBlock.error.length===0&&(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length===0&&(this.blockLength+=this.lenBlock.blockLength),t;if(!this.valueBlock.isConstructed){const s=(e instanceof ArrayBuffer?new Uint8Array(e):e).subarray(t,t+n);try{if(s.byteLength){const o=Fh(s,0,s.byteLength);o.offset!==-1&&o.offset===n&&(this.valueBlock.value=[o.result])}}catch{}}return super.fromBER(e,t,n)}onAsciiEncoding(){if(this.valueBlock.isConstructed||this.valueBlock.value&&this.valueBlock.value.length)return $n.prototype.onAsciiEncoding.call(this);const e=this.constructor.NAME,t=Se.ToHex(this.valueBlock.valueHexView);return`${e} : ${t}`}getValue(){if(!this.idBlock.isConstructed)return this.valueBlock.valueHexView.slice().buffer;const e=[];for(const t of this.valueBlock.value)t instanceof Rx&&e.push(t.valueBlock.valueHexView);return de.concat(e)}};Rx=ns;we.OctetString=Rx;ns.NAME=bK;class NK extends Xs(pc){constructor({unusedBits:e=0,isConstructed:t=!1,...n}={}){super(n),this.unusedBits=e,this.isConstructed=t,this.blockLength=this.valueHexView.byteLength}fromBER(e,t,n){if(!n)return t;let i=-1;if(this.isConstructed){if(i=pc.prototype.fromBER.call(this,e,t,n),i===-1)return i;for(const a of this.value){const c=a.constructor.NAME;if(c===op){if(this.isIndefiniteForm)break;return this.error="EndOfContent is unexpected, BIT STRING may consists of BIT STRINGs only",-1}if(c!==vK)return this.error="BIT STRING may consists of BIT STRINGs only",-1;const l=a.valueBlock;if(this.unusedBits>0&&l.unusedBits>0)return this.error='Using of "unused bits" inside constructive BIT STRING allowed for least one only',-1;this.unusedBits=l.unusedBits}return i}const s=de.toUint8Array(e);if(!oa(this,s,t,n))return-1;const o=s.subarray(t,t+n);if(this.unusedBits=o[0],this.unusedBits>7)return this.error="Unused bits for BitString must be in range 0-7",-1;if(!this.unusedBits){const a=o.subarray(1);try{if(a.byteLength){const c=Fh(a,0,a.byteLength);c.offset!==-1&&c.offset===n-1&&(this.value=[c.result])}}catch{}}return this.valueHexView=o.subarray(1),this.blockLength=o.length,t+n}toBER(e,t){if(this.isConstructed)return pc.prototype.toBER.call(this,e,t);if(e)return new ArrayBuffer(this.valueHexView.byteLength+1);if(!this.valueHexView.byteLength)return ys;const n=new Uint8Array(this.valueHexView.length+1);return n[0]=this.unusedBits,n.set(this.valueHexView,1),n.buffer}toJSON(){return{...super.toJSON(),unusedBits:this.unusedBits,isConstructed:this.isConstructed}}}NK.NAME="BitStringValueBlock";var MK;let Rl=class extends Cr{constructor({idBlock:e={},lenBlock:t={},...n}={}){var i,s;(i=n.isConstructed)!==null&&i!==void 0||(n.isConstructed=!!(!((s=n.value)===null||s===void 0)&&s.length)),super({idBlock:{isConstructed:n.isConstructed,...e},lenBlock:{...t,isIndefiniteForm:!!n.isIndefiniteForm},...n},NK),this.idBlock.tagClass=1,this.idBlock.tagNumber=3}fromBER(e,t,n){return this.valueBlock.isConstructed=this.idBlock.isConstructed,this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm,super.fromBER(e,t,n)}onAsciiEncoding(){if(this.valueBlock.isConstructed||this.valueBlock.value&&this.valueBlock.value.length)return $n.prototype.onAsciiEncoding.call(this);{const e=[],t=this.valueBlock.valueHexView;for(const o of t)e.push(o.toString(2).padStart(8,"0"));const n=e.join(""),i=this.constructor.NAME,s=n.substring(0,n.length-this.valueBlock.unusedBits);return`${i} : ${s}`}}};MK=Rl;we.BitString=MK;Rl.NAME=vK;var OK;function F8e(r,e){const t=new Uint8Array([0]),n=new Uint8Array(r),i=new Uint8Array(e);let s=n.slice(0);const o=s.length-1,a=i.slice(0),c=a.length-1;let l=0;const d=c<o?o:c;let h=0;for(let p=d;p>=0;p--,h++){switch(!0){case h<a.length:l=s[o-h]+a[c-h]+t[0];break;default:l=s[o-h]+t[0]}switch(t[0]=l/10,!0){case h>=s.length:s=Qv(new Uint8Array([l%10]),s);break;default:s[o-h]=l%10}}return t[0]>0&&(s=Qv(t,s)),s}function xP(r){if(r>=Nf.length)for(let e=Nf.length;e<=r;e++){const t=new Uint8Array([0]);let n=Nf[e-1].slice(0);for(let i=n.length-1;i>=0;i--){const s=new Uint8Array([(n[i]<<1)+t[0]]);t[0]=s[0]/10,n[i]=s[0]%10}t[0]>0&&(n=Qv(t,n)),Nf.push(n)}return Nf[r]}function z8e(r,e){let t=0;const n=new Uint8Array(r),i=new Uint8Array(e),s=n.slice(0),o=s.length-1,a=i.slice(0),c=a.length-1;let l,d=0;for(let h=c;h>=0;h--,d++)switch(l=s[o-d]-a[c-d]-t,!0){case l<0:t=1,s[o-d]=l+10;break;default:t=0,s[o-d]=l}if(t>0)for(let h=o-c+1;h>=0;h--,d++)if(l=s[o-d]-t,l<0)t=1,s[o-d]=l+10;else{t=0,s[o-d]=l;break}return s.slice()}class Lx extends Xs(yn){setValueHex(){this.valueHexView.length>=4?(this.warnings.push("Too big Integer for decoding, hex only"),this.isHexOnly=!0,this._valueDec=0):(this.isHexOnly=!1,this.valueHexView.length>0&&(this._valueDec=wK.call(this)))}constructor({value:e,...t}={}){super(t),this._valueDec=0,t.valueHex&&this.setValueHex(),e!==void 0&&(this.valueDec=e)}set valueDec(e){this._valueDec=e,this.isHexOnly=!1,this.valueHexView=new Uint8Array(_8e(e))}get valueDec(){return this._valueDec}fromDER(e,t,n,i=0){const s=this.fromBER(e,t,n);if(s===-1)return s;const o=this.valueHexView;return o[0]===0&&o[1]&128?this.valueHexView=o.subarray(1):i!==0&&o.length<i&&(i-o.length>1&&(i=o.length+1),this.valueHexView=o.subarray(i-o.length)),s}toDER(e=!1){const t=this.valueHexView;switch(!0){case(t[0]&128)!==0:{const n=new Uint8Array(this.valueHexView.length+1);n[0]=0,n.set(t,1),this.valueHexView=n}break;case(t[0]===0&&(t[1]&128)===0):this.valueHexView=this.valueHexView.subarray(1);break}return this.toBER(e)}fromBER(e,t,n){const i=super.fromBER(e,t,n);return i===-1||this.setValueHex(),i}toBER(e){return e?new ArrayBuffer(this.valueHexView.length):this.valueHexView.slice().buffer}toJSON(){return{...super.toJSON(),valueDec:this.valueDec}}toString(){const e=this.valueHexView.length*8-1;let t=new Uint8Array(this.valueHexView.length*8/3),n=0,i;const s=this.valueHexView;let o="",a=!1;for(let c=s.byteLength-1;c>=0;c--){i=s[c];for(let l=0;l<8;l++){if((i&1)===1)switch(n){case e:t=z8e(xP(n),t),o="-";break;default:t=F8e(t,xP(n))}n++,i>>=1}}for(let c=0;c<t.length;c++)t[c]&&(a=!0),a&&(o+=EP.charAt(t[c]));return a===!1&&(o+=EP.charAt(0)),o}}OK=Lx;Lx.NAME="IntegerValueBlock";Object.defineProperty(OK.prototype,"valueHex",{set:function(r){this.valueHexView=new Uint8Array(r),this.setValueHex()},get:function(){return this.valueHexView.slice().buffer}});var d1;class No extends Cr{constructor(e={}){super(e,Lx),this.idBlock.tagClass=1,this.idBlock.tagNumber=2}toBigInt(){return Am(),BigInt(this.valueBlock.toString())}static fromBigInt(e){Am();const t=BigInt(e),n=new Hw,i=t.toString(16).replace(/^-/,""),s=new Uint8Array(Se.FromHex(i));if(t<0){const a=new Uint8Array(s.length+(s[0]&128?1:0));a[0]|=128;const l=BigInt(`0x${Se.ToHex(a)}`)+t,d=de.toUint8Array(Se.FromHex(l.toString(16)));d[0]|=128,n.write(d)}else s[0]&128&&n.write(new Uint8Array([0])),n.write(s);return new d1({valueHex:n.final()})}convertToDER(){const e=new d1({valueHex:this.valueBlock.valueHexView});return e.valueBlock.toDER(),e}convertFromDER(){return new d1({valueHex:this.valueBlock.valueHexView[0]===0?this.valueBlock.valueHexView.subarray(1):this.valueBlock.valueHexView})}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()}`}}d1=No;we.Integer=d1;No.NAME="INTEGER";var RK;class Gw extends No{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=10}}RK=Gw;we.Enumerated=RK;Gw.NAME="ENUMERATED";class Yv extends Xs(yn){constructor({valueDec:e=-1,isFirstSid:t=!1,...n}={}){super(n),this.valueDec=e,this.isFirstSid=t}fromBER(e,t,n){if(!n)return t;const i=de.toUint8Array(e);if(!oa(this,i,t,n))return-1;const s=i.subarray(t,t+n);this.valueHexView=new Uint8Array(n);for(let a=0;a<n&&(this.valueHexView[a]=s[a]&127,this.blockLength++,!!(s[a]&128));a++);const o=new Uint8Array(this.blockLength);for(let a=0;a<this.blockLength;a++)o[a]=this.valueHexView[a];return this.valueHexView=o,s[this.blockLength-1]&128?(this.error="End of input reached before message was fully decoded",-1):(this.valueHexView[0]===0&&this.warnings.push("Needlessly long format of SID encoding"),this.blockLength<=8?this.valueDec=hh(this.valueHexView,7):(this.isHexOnly=!0,this.warnings.push("Too big SID for decoding, hex only")),t+this.blockLength)}set valueBigInt(e){Am();let t=BigInt(e).toString(2);for(;t.length%7;)t="0"+t;const n=new Uint8Array(t.length/7);for(let i=0;i<n.length;i++)n[i]=parseInt(t.slice(i*7,i*7+7),2)+(i+1<n.length?128:0);this.fromBER(n.buffer,0,n.length)}toBER(e){if(this.isHexOnly){if(e)return new ArrayBuffer(this.valueHexView.byteLength);const i=this.valueHexView,s=new Uint8Array(this.blockLength);for(let o=0;o<this.blockLength-1;o++)s[o]=i[o]|128;return s[this.blockLength-1]=i[this.blockLength-1],s.buffer}const t=ru(this.valueDec,7);if(t.byteLength===0)return this.error="Error during encoding SID value",ys;const n=new Uint8Array(t.byteLength);if(!e){const i=new Uint8Array(t),s=t.byteLength-1;for(let o=0;o<s;o++)n[o]=i[o]|128;n[s]=i[s]}return n}toString(){let e="";if(this.isHexOnly)e=Se.ToHex(this.valueHexView);else if(this.isFirstSid){let t=this.valueDec;this.valueDec<=39?e="0.":this.valueDec<=79?(e="1.",t-=40):(e="2.",t-=80),e+=t.toString()}else e=this.valueDec.toString();return e}toJSON(){return{...super.toJSON(),valueDec:this.valueDec,isFirstSid:this.isFirstSid}}}Yv.NAME="sidBlock";class LK extends yn{constructor({value:e=xn,...t}={}){super(t),this.value=[],e&&this.fromString(e)}fromBER(e,t,n){let i=t;for(;n>0;){const s=new Yv;if(i=s.fromBER(e,i,n),i===-1)return this.blockLength=0,this.error=s.error,i;this.value.length===0&&(s.isFirstSid=!0),this.blockLength+=s.blockLength,n-=s.blockLength,this.value.push(s)}return i}toBER(e){const t=[];for(let n=0;n<this.value.length;n++){const i=this.value[n].toBER(e);if(i.byteLength===0)return this.error=this.value[n].error,ys;t.push(i)}return Nx(t)}fromString(e){this.value=[];let t=0,n=0,i="",s=!1;do if(n=e.indexOf(".",t),n===-1?i=e.substring(t):i=e.substring(t,n),t=n+1,s){const o=this.value[0];let a=0;switch(o.valueDec){case 0:break;case 1:a=40;break;case 2:a=80;break;default:this.value=[];return}const c=parseInt(i,10);if(isNaN(c))return;o.valueDec=c+a,s=!1}else{const o=new Yv;if(i>Number.MAX_SAFE_INTEGER){Am();const a=BigInt(i);o.valueBigInt=a}else if(o.valueDec=parseInt(i,10),isNaN(o.valueDec))return;this.value.length||(o.isFirstSid=!0,s=!0),this.value.push(o)}while(n!==-1)}toString(){let e="",t=!1;for(let n=0;n<this.value.length;n++){t=this.value[n].isHexOnly;let i=this.value[n].toString();n!==0&&(e=`${e}.`),t?(i=`{${i}}`,this.value[n].isFirstSid?e=`2.{${i} - 80}`:e+=i):e+=i}return e}toJSON(){const e={...super.toJSON(),value:this.toString(),sidArray:[]};for(let t=0;t<this.value.length;t++)e.sidArray.push(this.value[t].toJSON());return e}}LK.NAME="ObjectIdentifierValueBlock";var BK;class Co extends Cr{getValue(){return this.valueBlock.toString()}setValue(e){this.valueBlock.fromString(e)}constructor(e={}){super(e,LK),this.idBlock.tagClass=1,this.idBlock.tagNumber=6}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()||"empty"}`}toJSON(){return{...super.toJSON(),value:this.getValue()}}}BK=Co;we.ObjectIdentifier=BK;Co.NAME="OBJECT IDENTIFIER";class Jv extends Xs(xu){constructor({valueDec:e=0,...t}={}){super(t),this.valueDec=e}fromBER(e,t,n){if(n===0)return t;const i=de.toUint8Array(e);if(!oa(this,i,t,n))return-1;const s=i.subarray(t,t+n);this.valueHexView=new Uint8Array(n);for(let a=0;a<n&&(this.valueHexView[a]=s[a]&127,this.blockLength++,!!(s[a]&128));a++);const o=new Uint8Array(this.blockLength);for(let a=0;a<this.blockLength;a++)o[a]=this.valueHexView[a];return this.valueHexView=o,s[this.blockLength-1]&128?(this.error="End of input reached before message was fully decoded",-1):(this.valueHexView[0]===0&&this.warnings.push("Needlessly long format of SID encoding"),this.blockLength<=8?this.valueDec=hh(this.valueHexView,7):(this.isHexOnly=!0,this.warnings.push("Too big SID for decoding, hex only")),t+this.blockLength)}toBER(e){if(this.isHexOnly){if(e)return new ArrayBuffer(this.valueHexView.byteLength);const i=this.valueHexView,s=new Uint8Array(this.blockLength);for(let o=0;o<this.blockLength-1;o++)s[o]=i[o]|128;return s[this.blockLength-1]=i[this.blockLength-1],s.buffer}const t=ru(this.valueDec,7);if(t.byteLength===0)return this.error="Error during encoding SID value",ys;const n=new Uint8Array(t.byteLength);if(!e){const i=new Uint8Array(t),s=t.byteLength-1;for(let o=0;o<s;o++)n[o]=i[o]|128;n[s]=i[s]}return n.buffer}toString(){let e="";return this.isHexOnly?e=Se.ToHex(this.valueHexView):e=this.valueDec.toString(),e}toJSON(){return{...super.toJSON(),valueDec:this.valueDec}}}Jv.NAME="relativeSidBlock";class UK extends yn{constructor({value:e=xn,...t}={}){super(t),this.value=[],e&&this.fromString(e)}fromBER(e,t,n){let i=t;for(;n>0;){const s=new Jv;if(i=s.fromBER(e,i,n),i===-1)return this.blockLength=0,this.error=s.error,i;this.blockLength+=s.blockLength,n-=s.blockLength,this.value.push(s)}return i}toBER(e,t){const n=[];for(let i=0;i<this.value.length;i++){const s=this.value[i].toBER(e);if(s.byteLength===0)return this.error=this.value[i].error,ys;n.push(s)}return Nx(n)}fromString(e){this.value=[];let t=0,n=0,i="";do{n=e.indexOf(".",t),n===-1?i=e.substring(t):i=e.substring(t,n),t=n+1;const s=new Jv;if(s.valueDec=parseInt(i,10),isNaN(s.valueDec))return!0;this.value.push(s)}while(n!==-1);return!0}toString(){let e="",t=!1;for(let n=0;n<this.value.length;n++){t=this.value[n].isHexOnly;let i=this.value[n].toString();n!==0&&(e=`${e}.`),t&&(i=`{${i}}`),e+=i}return e}toJSON(){const e={...super.toJSON(),value:this.toString(),sidArray:[]};for(let t=0;t<this.value.length;t++)e.sidArray.push(this.value[t].toJSON());return e}}UK.NAME="RelativeObjectIdentifierValueBlock";var FK;class Bx extends Cr{getValue(){return this.valueBlock.toString()}setValue(e){this.valueBlock.fromString(e)}constructor(e={}){super(e,UK),this.idBlock.tagClass=1,this.idBlock.tagNumber=13}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()||"empty"}`}toJSON(){return{...super.toJSON(),value:this.getValue()}}}FK=Bx;we.RelativeObjectIdentifier=FK;Bx.NAME="RelativeObjectIdentifier";var zK;class lr extends $n{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=16}}zK=lr;we.Sequence=zK;lr.NAME="SEQUENCE";var VK;let Mo=class extends $n{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=17}};VK=Mo;we.Set=VK;Mo.NAME="SET";class KK extends Xs(yn){constructor({...e}={}){super(e),this.isHexOnly=!0,this.value=xn}toJSON(){return{...super.toJSON(),value:this.value}}}KK.NAME="StringValueBlock";class jK extends KK{}jK.NAME="SimpleStringValueBlock";class ui extends Mx{constructor({...e}={}){super(e,jK)}fromBuffer(e){this.valueBlock.value=String.fromCharCode.apply(null,de.toUint8Array(e))}fromString(e){const t=e.length,n=this.valueBlock.valueHexView=new Uint8Array(t);for(let i=0;i<t;i++)n[i]=e.charCodeAt(i);this.valueBlock.value=e}}ui.NAME="SIMPLE STRING";class HK extends ui{fromBuffer(e){this.valueBlock.valueHexView=de.toUint8Array(e);try{this.valueBlock.value=Se.ToUtf8String(e)}catch(t){this.warnings.push(`Error during "decodeURIComponent": ${t}, using raw string`),this.valueBlock.value=Se.ToBinary(e)}}fromString(e){this.valueBlock.valueHexView=new Uint8Array(Se.FromUtf8String(e)),this.valueBlock.value=e}}HK.NAME="Utf8StringValueBlock";var qK;class aa extends HK{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=12}}qK=aa;we.Utf8String=qK;aa.NAME="UTF8String";class WK extends ui{fromBuffer(e){this.valueBlock.value=Se.ToUtf16String(e),this.valueBlock.valueHexView=de.toUint8Array(e)}fromString(e){this.valueBlock.value=e,this.valueBlock.valueHexView=new Uint8Array(Se.FromUtf16String(e))}}WK.NAME="BmpStringValueBlock";var GK;class Qw extends WK{constructor({...e}={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=30}}GK=Qw;we.BmpString=GK;Qw.NAME="BMPString";class QK extends ui{fromBuffer(e){const t=ArrayBuffer.isView(e)?e.slice().buffer:e.slice(0),n=new Uint8Array(t);for(let i=0;i<n.length;i+=4)n[i]=n[i+3],n[i+1]=n[i+2],n[i+2]=0,n[i+3]=0;this.valueBlock.value=String.fromCharCode.apply(null,new Uint32Array(t))}fromString(e){const t=e.length,n=this.valueBlock.valueHexView=new Uint8Array(t*4);for(let i=0;i<t;i++){const s=ru(e.charCodeAt(i),8),o=new Uint8Array(s);if(o.length>4)continue;const a=4-o.length;for(let c=o.length-1;c>=0;c--)n[i*4+c+a]=o[c]}this.valueBlock.value=e}}QK.NAME="UniversalStringValueBlock";var YK;class Yw extends QK{constructor({...e}={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=28}}YK=Yw;we.UniversalString=YK;Yw.NAME="UniversalString";var JK;class Jw extends ui{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=18}}JK=Jw;we.NumericString=JK;Jw.NAME="NumericString";var XK;class Xw extends ui{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=19}}XK=Xw;we.PrintableString=XK;Xw.NAME="PrintableString";var ZK;class Zw extends ui{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=20}}ZK=Zw;we.TeletexString=ZK;Zw.NAME="TeletexString";var ej;class e4 extends ui{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=21}}ej=e4;we.VideotexString=ej;e4.NAME="VideotexString";var tj;class t4 extends ui{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=22}}tj=t4;we.IA5String=tj;t4.NAME="IA5String";var rj;class r4 extends ui{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=25}}rj=r4;we.GraphicString=rj;r4.NAME="GraphicString";var nj;class Jp extends ui{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=26}}nj=Jp;we.VisibleString=nj;Jp.NAME="VisibleString";var ij;class n4 extends ui{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=27}}ij=n4;we.GeneralString=ij;n4.NAME="GeneralString";var sj;class i4 extends ui{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=29}}sj=i4;we.CharacterString=sj;i4.NAME="CharacterString";var oj;class Xp extends Jp{constructor({value:e,valueDate:t,...n}={}){if(super(n),this.year=0,this.month=0,this.day=0,this.hour=0,this.minute=0,this.second=0,e){this.fromString(e),this.valueBlock.valueHexView=new Uint8Array(e.length);for(let i=0;i<e.length;i++)this.valueBlock.valueHexView[i]=e.charCodeAt(i)}t&&(this.fromDate(t),this.valueBlock.valueHexView=new Uint8Array(this.toBuffer())),this.idBlock.tagClass=1,this.idBlock.tagNumber=23}fromBuffer(e){this.fromString(String.fromCharCode.apply(null,de.toUint8Array(e)))}toBuffer(){const e=this.toString(),t=new ArrayBuffer(e.length),n=new Uint8Array(t);for(let i=0;i<e.length;i++)n[i]=e.charCodeAt(i);return t}fromDate(e){this.year=e.getUTCFullYear(),this.month=e.getUTCMonth()+1,this.day=e.getUTCDate(),this.hour=e.getUTCHours(),this.minute=e.getUTCMinutes(),this.second=e.getUTCSeconds()}toDate(){return new Date(Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second))}fromString(e){const n=/(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})Z/ig.exec(e);if(n===null){this.error="Wrong input string for conversion";return}const i=parseInt(n[1],10);i>=50?this.year=1900+i:this.year=2e3+i,this.month=parseInt(n[2],10),this.day=parseInt(n[3],10),this.hour=parseInt(n[4],10),this.minute=parseInt(n[5],10),this.second=parseInt(n[6],10)}toString(e="iso"){if(e==="iso"){const t=new Array(7);return t[0]=Wn(this.year<2e3?this.year-1900:this.year-2e3,2),t[1]=Wn(this.month,2),t[2]=Wn(this.day,2),t[3]=Wn(this.hour,2),t[4]=Wn(this.minute,2),t[5]=Wn(this.second,2),t[6]="Z",t.join("")}return super.toString(e)}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.toDate().toISOString()}`}toJSON(){return{...super.toJSON(),year:this.year,month:this.month,day:this.day,hour:this.hour,minute:this.minute,second:this.second}}}oj=Xp;we.UTCTime=oj;Xp.NAME="UTCTime";var aj;class s4 extends Xp{constructor(e={}){var t;super(e),(t=this.millisecond)!==null&&t!==void 0||(this.millisecond=0),this.idBlock.tagClass=1,this.idBlock.tagNumber=24}fromDate(e){super.fromDate(e),this.millisecond=e.getUTCMilliseconds()}toDate(){const e=Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second,this.millisecond);return new Date(e)}fromString(e){let t=!1,n="",i="",s=0,o,a=0,c=0;if(e[e.length-1]==="Z")n=e.substring(0,e.length-1),t=!0;else{const h=new Number(e[e.length-1]);if(isNaN(h.valueOf()))throw new Error("Wrong input string for conversion");n=e}if(t){if(n.indexOf("+")!==-1)throw new Error("Wrong input string for conversion");if(n.indexOf("-")!==-1)throw new Error("Wrong input string for conversion")}else{let h=1,p=n.indexOf("+"),m="";if(p===-1&&(p=n.indexOf("-"),h=-1),p!==-1){if(m=n.substring(p+1),n=n.substring(0,p),m.length!==2&&m.length!==4)throw new Error("Wrong input string for conversion");let f=parseInt(m.substring(0,2),10);if(isNaN(f.valueOf()))throw new Error("Wrong input string for conversion");if(a=h*f,m.length===4){if(f=parseInt(m.substring(2,4),10),isNaN(f.valueOf()))throw new Error("Wrong input string for conversion");c=h*f}}}let l=n.indexOf(".");if(l===-1&&(l=n.indexOf(",")),l!==-1){const h=new Number(`0${n.substring(l)}`);if(isNaN(h.valueOf()))throw new Error("Wrong input string for conversion");s=h.valueOf(),i=n.substring(0,l)}else i=n;switch(!0){case i.length===8:if(o=/(\d{4})(\d{2})(\d{2})/ig,l!==-1)throw new Error("Wrong input string for conversion");break;case i.length===10:if(o=/(\d{4})(\d{2})(\d{2})(\d{2})/ig,l!==-1){let h=60*s;this.minute=Math.floor(h),h=60*(h-this.minute),this.second=Math.floor(h),h=1e3*(h-this.second),this.millisecond=Math.floor(h)}break;case i.length===12:if(o=/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})/ig,l!==-1){let h=60*s;this.second=Math.floor(h),h=1e3*(h-this.second),this.millisecond=Math.floor(h)}break;case i.length===14:if(o=/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})/ig,l!==-1){const h=1e3*s;this.millisecond=Math.floor(h)}break;default:throw new Error("Wrong input string for conversion")}const d=o.exec(i);if(d===null)throw new Error("Wrong input string for conversion");for(let h=1;h<d.length;h++)switch(h){case 1:this.year=parseInt(d[h],10);break;case 2:this.month=parseInt(d[h],10);break;case 3:this.day=parseInt(d[h],10);break;case 4:this.hour=parseInt(d[h],10)+a;break;case 5:this.minute=parseInt(d[h],10)+c;break;case 6:this.second=parseInt(d[h],10);break;default:throw new Error("Wrong input string for conversion")}if(t===!1){const h=new Date(this.year,this.month,this.day,this.hour,this.minute,this.second,this.millisecond);this.year=h.getUTCFullYear(),this.month=h.getUTCMonth(),this.day=h.getUTCDay(),this.hour=h.getUTCHours(),this.minute=h.getUTCMinutes(),this.second=h.getUTCSeconds(),this.millisecond=h.getUTCMilliseconds()}}toString(e="iso"){if(e==="iso"){const t=[];return t.push(Wn(this.year,4)),t.push(Wn(this.month,2)),t.push(Wn(this.day,2)),t.push(Wn(this.hour,2)),t.push(Wn(this.minute,2)),t.push(Wn(this.second,2)),this.millisecond!==0&&(t.push("."),t.push(Wn(this.millisecond,3))),t.push("Z"),t.join("")}return super.toString(e)}toJSON(){return{...super.toJSON(),millisecond:this.millisecond}}}aj=s4;we.GeneralizedTime=aj;s4.NAME="GeneralizedTime";var cj;class Ux extends aa{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=31}}cj=Ux;we.DATE=cj;Ux.NAME="DATE";var lj;class Fx extends aa{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=32}}lj=Fx;we.TimeOfDay=lj;Fx.NAME="TimeOfDay";var uj;class zx extends aa{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=33}}uj=zx;we.DateTime=uj;zx.NAME="DateTime";var dj;class Vx extends aa{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=34}}dj=Vx;we.Duration=dj;Vx.NAME="Duration";var hj;class Kx extends aa{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=14}}hj=Kx;we.TIME=hj;Kx.NAME="TIME";class nu{constructor({name:e=xn,optional:t=!1}={}){this.name=e,this.optional=t}}class jx extends nu{constructor({value:e=[],...t}={}){super(t),this.value=e}}class Cm extends nu{constructor({value:e=new nu,local:t=!1,...n}={}){super(n),this.value=e,this.local=t}}class V8e{get data(){return this.dataView.slice().buffer}set data(e){this.dataView=de.toUint8Array(e)}constructor({data:e=qw}={}){this.dataView=de.toUint8Array(e)}fromBER(e,t,n){const i=t+n;return this.dataView=de.toUint8Array(e).subarray(t,i),i}toBER(e){return this.dataView.slice().buffer}}function bl(r,e,t){if(t instanceof jx){for(const s of t.value)if(bl(r,e,s).verified)return{verified:!0,result:r};{const s={verified:!1,result:{error:"Wrong values for Choice type"}};return t.hasOwnProperty(x8)&&(s.name=t.name),s}}if(t instanceof nu)return t.hasOwnProperty(x8)&&(r[t.name]=e),{verified:!0,result:r};if(!(r instanceof Object))return{verified:!1,result:{error:"Wrong root object"}};if(!(e instanceof Object))return{verified:!1,result:{error:"Wrong ASN.1 data"}};if(!(t instanceof Object))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(!(D8e in t))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(!(O8e in t.idBlock))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(!(R8e in t.idBlock))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};const n=t.idBlock.toBER(!1);if(n.byteLength===0)return{verified:!1,result:{error:"Error encoding idBlock for ASN.1 schema"}};if(t.idBlock.fromBER(n,0,n.byteLength)===-1)return{verified:!1,result:{error:"Error decoding idBlock for ASN.1 schema"}};if(t.idBlock.hasOwnProperty($8e)===!1)return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(t.idBlock.tagClass!==e.idBlock.tagClass)return{verified:!1,result:r};if(t.idBlock.hasOwnProperty(N8e)===!1)return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(t.idBlock.tagNumber!==e.idBlock.tagNumber)return{verified:!1,result:r};if(t.idBlock.hasOwnProperty(M8e)===!1)return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(t.idBlock.isConstructed!==e.idBlock.isConstructed)return{verified:!1,result:r};if(!(P8e in t.idBlock))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(t.idBlock.isHexOnly!==e.idBlock.isHexOnly)return{verified:!1,result:r};if(t.idBlock.isHexOnly){if(!(SP in t.idBlock))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};const s=t.idBlock.valueHexView,o=e.idBlock.valueHexView;if(s.length!==o.length)return{verified:!1,result:r};for(let a=0;a<s.length;a++)if(s[a]!==o[1])return{verified:!1,result:r}}if(t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,xn),t.name&&(r[t.name]=e)),t instanceof we.Constructed){let s=0,o={verified:!1,result:{error:"Unknown error"}},a=t.valueBlock.value.length;if(a>0&&t.valueBlock.value[0]instanceof Cm&&(a=e.valueBlock.value.length),a===0)return{verified:!0,result:r};if(e.valueBlock.value.length===0&&t.valueBlock.value.length!==0){let c=!0;for(let l=0;l<t.valueBlock.value.length;l++)c=c&&(t.valueBlock.value[l].optional||!1);return c?{verified:!0,result:r}:(t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,xn),t.name&&delete r[t.name]),r.error="Inconsistent object length",{verified:!1,result:r})}for(let c=0;c<a;c++)if(c-s>=e.valueBlock.value.length){if(t.valueBlock.value[c].optional===!1){const l={verified:!1,result:r};return r.error="Inconsistent length between ASN.1 data and schema",t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,xn),t.name&&(delete r[t.name],l.name=t.name)),l}}else if(t.valueBlock.value[0]instanceof Cm){if(o=bl(r,e.valueBlock.value[c],t.valueBlock.value[0].value),o.verified===!1)if(t.valueBlock.value[0].optional)s++;else return t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,xn),t.name&&delete r[t.name]),o;if(x8 in t.valueBlock.value[0]&&t.valueBlock.value[0].name.length>0){let l={};L8e in t.valueBlock.value[0]&&t.valueBlock.value[0].local?l=e:l=r,typeof l[t.valueBlock.value[0].name]>"u"&&(l[t.valueBlock.value[0].name]=[]),l[t.valueBlock.value[0].name].push(e.valueBlock.value[c])}}else if(o=bl(r,e.valueBlock.value[c-s],t.valueBlock.value[c]),o.verified===!1)if(t.valueBlock.value[c].optional)s++;else return t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,xn),t.name&&delete r[t.name]),o;if(o.verified===!1){const c={verified:!1,result:r};return t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,xn),t.name&&(delete r[t.name],c.name=t.name)),c}return{verified:!0,result:r}}if(t.primitiveSchema&&SP in e.valueBlock){const s=Fh(e.valueBlock.valueHexView);if(s.offset===-1){const o={verified:!1,result:s.result};return t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,xn),t.name&&(delete r[t.name],o.name=t.name)),o}return bl(r,s.result,t.primitiveSchema)}return{verified:!0,result:r}}function K8e(r,e){if(!(e instanceof Object))return{verified:!1,result:{error:"Wrong ASN.1 schema type"}};const t=Fh(de.toUint8Array(r));return t.offset===-1?{verified:!1,result:t.result}:bl(t.result,t.result,e)}const fj=Object.freeze(Object.defineProperty({__proto__:null,Any:nu,BaseBlock:Cr,BaseStringBlock:Mx,BitString:Rl,BmpString:Qw,Boolean:Ww,CharacterString:i4,Choice:jx,Constructed:$n,DATE:Ux,DateTime:zx,Duration:Vx,EndOfContent:Ox,Enumerated:Gw,GeneralString:n4,GeneralizedTime:s4,GraphicString:r4,HexBlock:Xs,IA5String:t4,Integer:No,Null:Ko,NumericString:Jw,ObjectIdentifier:Co,OctetString:ns,Primitive:Yp,PrintableString:Xw,RawData:V8e,RelativeObjectIdentifier:Bx,Repeated:Cm,Sequence:lr,Set:Mo,TIME:Kx,TeletexString:Zw,TimeOfDay:Fx,UTCTime:Xp,UniversalString:Yw,Utf8String:aa,ValueBlock:yn,VideotexString:e4,ViewWriter:Hw,VisibleString:Jp,compareSchema:bl,fromBER:$o,verifySchema:K8e},Symbol.toStringTag,{value:"Module"})),pj=jw({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6});jw({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6});jw({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6});jw({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});const j8e=16,Xv=32,Zv=1e4;async function o4(r,e){const n=await yK().encrypt(r,e);return pj.encode(n)}async function AP(r,e,t){if(r.type==="RSA")return G8e(r,e,t);if(r.type==="Ed25519")return H8e(r,e,t);if(r.type==="secp256k1")return q8e(r,e,t);if(r.type==="ECDSA")return W8e(r,e,t);throw new Eu}async function H8e(r,e,t="libp2p-key"){if(t==="libp2p-key")return o4(Vp(r),e);throw new Z(`export format '${t}' is not supported`)}async function q8e(r,e,t="libp2p-key"){if(t==="libp2p-key")return o4(Vp(r),e);throw new Z("Export format is not supported")}async function W8e(r,e,t="libp2p-key"){if(t==="libp2p-key")return o4(Vp(r),e);throw new Z(`export format '${t}' is not supported`)}async function G8e(r,e,t="pkcs-8"){if(t==="pkcs-8")return Q8e(r,e);if(t==="libp2p-key")return o4(Vp(r),e);throw new Z("Export format is not supported")}async function Q8e(r,e){const t=qs.get(),i=new lr({value:[new No({value:0}),new lr({value:[new Co({value:"1.2.840.113549.1.1.1"}),new Ko]}),new ns({valueHex:r.raw})]}).toBER(),s=new Uint8Array(i,0,i.byteLength),o=xc(j8e),a=await XU(BS,e,o,{c:Zv,dkLen:Xv}),c=xc(16),l=await t.subtle.importKey("raw",a,"AES-CBC",!1,["encrypt"]),d=await t.subtle.encrypt({name:"AES-CBC",iv:c},l,s),h=new lr({value:[new ns({valueHex:o}),new No({value:Zv}),new No({value:Xv}),new lr({value:[new Co({value:"1.2.840.113549.2.11"}),new Ko]})]}),p=new lr({value:[new Co({value:"1.2.840.113549.1.5.13"}),new lr({value:[new lr({value:[new Co({value:"1.2.840.113549.1.5.12"}),h]}),new lr({value:[new Co({value:"2.16.840.1.101.3.4.1.42"}),new ns({valueHex:c})]})]})]}),f=new lr({value:[p,new ns({valueHex:d})]}).toBER(),g=new Uint8Array(f,0,f.byteLength);return["-----BEGIN ENCRYPTED PRIVATE KEY-----",...re(g,"base64pad").split(/(.{64})/).filter(Boolean),"-----END ENCRYPTED PRIVATE KEY-----"].join(`
`)}async function CP(r,e){try{const t=await Y8e(r,e);return kie(t)}catch{}if(!r.includes("BEGIN"))throw new Z("Encrypted key was not a libp2p-key or a PEM file");return J8e(r,e)}async function Y8e(r,e){const t=pj.decode(r);return yK().decrypt(t,e)}async function J8e(r,e){const t=qs.get();let n;if(r.includes("-----BEGIN ENCRYPTED PRIVATE KEY-----")){const s=oe(r.replace("-----BEGIN ENCRYPTED PRIVATE KEY-----","").replace("-----END ENCRYPTED PRIVATE KEY-----","").replace(/\n/g,"").trim(),"base64pad"),{result:o}=$o(s),{iv:a,salt:c,iterations:l,keySize:d,cipherText:h}=X8e(o),p=await XU(BS,e,c,{c:l,dkLen:d}),m=await t.subtle.importKey("raw",p,"AES-CBC",!1,["decrypt"]),f=h1(await t.subtle.decrypt({name:"AES-CBC",iv:a},m,h)),{result:g}=$o(f);n=IP(g)}else if(r.includes("-----BEGIN PRIVATE KEY-----")){const s=oe(r.replace("-----BEGIN PRIVATE KEY-----","").replace("-----END PRIVATE KEY-----","").replace(/\n/g,"").trim(),"base64pad"),{result:o}=$o(s);n=IP(o)}else throw new Z("Could not parse private key from PEM data");const i=kb(n);if(i.type!=="RSA")throw new Z("Could not parse RSA private key from PEM data");return i}function X8e(r){const e=r.valueBlock.value[0];if(e.valueBlock.value[0].toString()!=="OBJECT IDENTIFIER : 1.2.840.113549.1.5.13")throw new Z("Only pkcs5PBES2 encrypted private keys are supported");const n=e.valueBlock.value[1].valueBlock.value[0];if(n.valueBlock.value[0].toString()!=="OBJECT IDENTIFIER : 1.2.840.113549.1.5.12")throw new Z("Only pkcs5PBKDF2 key derivation functions are supported");const s=n.valueBlock.value[1],o=h1(s.valueBlock.value[0].getValue());let a=Zv,c=Xv;if(s.valueBlock.value.length===3)a=Number(s.valueBlock.value[1].toBigInt()),c=Number(s.valueBlock.value[2].toBigInt());else if(s.valueBlock.value.length===2)throw new Z("Could not derive key size and iterations from PEM file - please use @libp2p/rsa to re-import your key");const l=e.valueBlock.value[1].valueBlock.value[1],d=l.valueBlock.value[0].toString();if(d!=="OBJECT IDENTIFIER : 1.2.840.113549.3.7"){if(d!=="OBJECT IDENTIFIER : 1.3.14.3.2.7"){if(d!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.2"){if(d!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.22"){if(d!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.42")throw new Z("Only AES-CBC encryption schemes are supported")}}}}const h=h1(l.valueBlock.value[1].getValue());return{cipherText:h1(r.valueBlock.value[1].getValue()),salt:o,iterations:a,keySize:c,iv:h}}function IP(r){return h1(r.valueBlock.value[2].getValue())}function h1(r){return new Uint8Array(r,0,r.byteLength)}const Z8e="/pkcs8/",e7="/info/",Mf=new WeakMap,tl={minKeyLength:112/8,minSaltLength:128/8,minIterationCount:1e3},A8={dek:{keyLength:512/8,iterationCount:1e4,salt:"you should override this value with a crypto secure random number",hash:"sha2-512"}};function zu(r){return r==null||typeof r!="string"?!1:r===S8e(r.trim())&&r.length>0}async function yr(){const t=Math.random()*800+200;await new Promise(n=>setTimeout(n,t))}function rl(r){return new Et(Z8e+r)}function Vu(r){return new Et(e7+r)}async function e6e(r){const e=Vp(r),t=await s8e.digest(e);return B5e.encode(t.bytes).substring(1)}var HN,qN;qN=Symbol.toStringTag,HN=fr;class t6e{constructor(e,t){u(this,"components");u(this,"init");u(this,"log");u(this,"self");u(this,qN,"@libp2p/keychain");u(this,HN,["@libp2p/keychain"]);var i,s,o,a,c,l,d,h,p,m;if(this.components=e,this.log=e.logger.forComponent("libp2p:keychain"),this.init=$x(A8,t),this.self=t.selfKey??"self",this.init.pass!=null&&((i=this.init.pass)==null?void 0:i.length)<20)throw new Error("pass must be least 20 characters");if(((s=this.init.dek)==null?void 0:s.keyLength)!=null&&this.init.dek.keyLength<tl.minKeyLength)throw new Error(`dek.keyLength must be least ${tl.minKeyLength} bytes`);if(((a=(o=this.init.dek)==null?void 0:o.salt)==null?void 0:a.length)!=null&&this.init.dek.salt.length<tl.minSaltLength)throw new Error(`dek.saltLength must be least ${tl.minSaltLength} bytes`);if(((c=this.init.dek)==null?void 0:c.iterationCount)!=null&&this.init.dek.iterationCount<tl.minIterationCount)throw new Error(`dek.iterationCount must be least ${tl.minIterationCount}`);const n=this.init.pass!=null&&((l=this.init.dek)==null?void 0:l.salt)!=null?Tk(this.init.pass,(d=this.init.dek)==null?void 0:d.salt,(h=this.init.dek)==null?void 0:h.iterationCount,(p=this.init.dek)==null?void 0:p.keyLength,(m=this.init.dek)==null?void 0:m.hash):"";Mf.set(this,{dek:n})}static generateOptions(){const e=Object.assign({},A8),t=Math.ceil(tl.minSaltLength/3)*3;return e.dek.salt=re(xc(t),"base64"),e}static get options(){return A8}async findKeyByName(e){if(!zu(e))throw await yr(),new Z(`Invalid key name '${e}'`);const t=Vu(e);try{const n=await this.components.datastore.get(t);return JSON.parse(re(n))}catch(n){throw await yr(),this.log.error(n),new Zt(`Key '${e}' does not exist.`)}}async findKeyById(e){try{const t={prefix:e7};for await(const n of this.components.datastore.query(t)){const i=JSON.parse(re(n.value));if(i.id===e)return i}throw new Z(`Key with id '${e}' does not exist.`)}catch(t){throw await yr(),t}}async importKey(e,t){if(!zu(e))throw await yr(),new Z(`Invalid key name '${e}'`);if(t==null)throw await yr(),new Z("Key is required");const n=rl(e);if(await this.components.datastore.has(n))throw await yr(),new Z(`Key '${e}' already exists`);let s,o;try{s=await e6e(t);const l=Mf.get(this);if(l==null)throw new Z("dek missing");const d=l.dek;o=await AP(t,d,t.type==="RSA"?"pkcs-8":"libp2p-key")}catch(l){throw await yr(),l}const a={name:e,id:s},c=this.components.datastore.batch();return c.put(n,oe(o)),c.put(Vu(e),oe(JSON.stringify(a))),await c.commit(),a}async exportKey(e){if(!zu(e))throw await yr(),new Z(`Invalid key name '${e}'`);const t=rl(e);try{const n=await this.components.datastore.get(t),i=re(n),s=Mf.get(this);if(s==null)throw new Z("dek missing");const o=s.dek;return await CP(i,o)}catch(n){throw await yr(),n}}async removeKey(e){if(!zu(e)||e===this.self)throw await yr(),new Z(`Invalid key name '${e}'`);const t=rl(e),n=await this.findKeyByName(e),i=this.components.datastore.batch();return i.delete(t),i.delete(Vu(e)),await i.commit(),n}async listKeys(){const e={prefix:e7},t=[];for await(const n of this.components.datastore.query(e))t.push(JSON.parse(re(n.value)));return t}async renameKey(e,t){if(!zu(e)||e===this.self)throw await yr(),new Z(`Invalid old key name '${e}'`);if(!zu(t)||t===this.self)throw await yr(),new Z(`Invalid new key name '${t}'`);const n=rl(e),i=rl(t),s=Vu(e),o=Vu(t);if(await this.components.datastore.has(i))throw await yr(),new Z(`Key '${t}' already exists`);try{const c=await this.components.datastore.get(n),l=await this.components.datastore.get(s),d=JSON.parse(re(l));d.name=t;const h=this.components.datastore.batch();return h.put(i,c),h.put(o,oe(JSON.stringify(d))),h.delete(n),h.delete(s),await h.commit(),d}catch(c){throw await yr(),c}}async rotateKeychainPass(e,t){var a,c,l,d;if(typeof e!="string")throw await yr(),new Z(`Invalid old pass type '${typeof e}'`);if(typeof t!="string")throw await yr(),new Z(`Invalid new pass type '${typeof t}'`);if(t.length<20)throw await yr(),new Z(`Invalid pass length ${t.length}`);this.log("recreating keychain");const n=Mf.get(this);if(n==null)throw new Z("dek missing");const i=n.dek;this.init.pass=t;const s=t!=null&&((a=this.init.dek)==null?void 0:a.salt)!=null?Tk(t,this.init.dek.salt,(c=this.init.dek)==null?void 0:c.iterationCount,(l=this.init.dek)==null?void 0:l.keyLength,(d=this.init.dek)==null?void 0:d.hash):"";Mf.set(this,{dek:s});const o=await this.listKeys();for(const h of o){const p=await this.components.datastore.get(rl(h.name)),m=re(p),f=await CP(m,i),g=s.toString(),v=await AP(f,g,f.type==="RSA"?"pkcs-8":"libp2p-key"),y=this.components.datastore.batch(),w={name:h.name,id:h.id};y.put(rl(h.name),oe(v)),y.put(Vu(h.name),oe(JSON.stringify(w))),await y.commit()}this.log("keychain reconstructed")}}function gj(r={}){return e=>new t6e(e,r)}class yj{constructor(e={}){u(this,"memoryStorage");u(this,"points");u(this,"duration");u(this,"blockDuration");u(this,"execEvenly");u(this,"execEvenlyMinDelayMs");u(this,"keyPrefix");this.points=e.points??4,this.duration=e.duration??1,this.blockDuration=e.blockDuration??0,this.execEvenly=e.execEvenly??!1,this.execEvenlyMinDelayMs=e.execEvenlyMinDelayMs??this.duration*1e3/this.points,this.keyPrefix=e.keyPrefix??"rlflx",this.memoryStorage=new r6e}async consume(e,t=1,n={}){const i=this.getKey(e),s=this._getKeySecDuration(n);let o=this.memoryStorage.incrby(i,t,s);if(o.remainingPoints=Math.max(this.points-o.consumedPoints,0),o.consumedPoints>this.points)throw this.blockDuration>0&&o.consumedPoints<=this.points+t&&(o=this.memoryStorage.set(i,o.consumedPoints,this.blockDuration)),new Zie("Rate limit exceeded",o);if(this.execEvenly&&o.msBeforeNext>0&&!o.isFirstInDuration){let a=Math.ceil(o.msBeforeNext/(o.remainingPoints+2));a<this.execEvenlyMinDelayMs&&(a=o.consumedPoints*this.execEvenlyMinDelayMs),await YV(a)}return o}penalty(e,t=1,n={}){const i=this.getKey(e),s=this._getKeySecDuration(n),o=this.memoryStorage.incrby(i,t,s);return o.remainingPoints=Math.max(this.points-o.consumedPoints,0),o}reward(e,t=1,n={}){const i=this.getKey(e),s=this._getKeySecDuration(n),o=this.memoryStorage.incrby(i,-t,s);return o.remainingPoints=Math.max(this.points-o.consumedPoints,0),o}block(e,t){const n=t*1e3,i=this.points+1;return this.memoryStorage.set(this.getKey(e),i,t),{remainingPoints:0,msBeforeNext:n===0?-1:n,consumedPoints:i,isFirstInDuration:!1}}set(e,t,n=0){const i=(n>=0?n:this.duration)*1e3;return this.memoryStorage.set(this.getKey(e),t,n),{remainingPoints:0,msBeforeNext:i===0?-1:i,consumedPoints:t,isFirstInDuration:!1}}get(e){const t=this.memoryStorage.get(this.getKey(e));return t!=null&&(t.remainingPoints=Math.max(this.points-t.consumedPoints,0)),t}delete(e){this.memoryStorage.delete(this.getKey(e))}_getKeySecDuration(e){return(e==null?void 0:e.customDuration)!=null&&e.customDuration>=0?e.customDuration:this.duration}getKey(e){return this.keyPrefix.length>0?`${this.keyPrefix}:${e}`:e}parseKey(e){return e.substring(this.keyPrefix.length)}}class r6e{constructor(){u(this,"storage");this.storage=new Map}incrby(e,t,n){const i=this.storage.get(e);if(i!=null){const s=i.expiresAt!=null?i.expiresAt.getTime()-new Date().getTime():-1;return i.expiresAt==null||s>0?(i.value+=t,{remainingPoints:0,msBeforeNext:s,consumedPoints:i.value,isFirstInDuration:!1}):this.set(e,t,n)}return this.set(e,t,n)}set(e,t,n){const i=n*1e3,s=this.storage.get(e);s!=null&&clearTimeout(s.timeoutId);const o={value:t,expiresAt:i>0?new Date(Date.now()+i):void 0};return this.storage.set(e,o),i>0&&(o.timeoutId=setTimeout(()=>{this.storage.delete(e)},i),o.timeoutId.unref!=null&&o.timeoutId.unref()),{remainingPoints:0,msBeforeNext:i===0?-1:i,consumedPoints:o.value,isFirstInDuration:!0}}get(e){const t=this.storage.get(e);if(t!=null)return{remainingPoints:0,msBeforeNext:t.expiresAt!=null?t.expiresAt.getTime()-new Date().getTime():-1,consumedPoints:t.value,isFirstInDuration:!1}}delete(e){const t=this.storage.get(e);return t!=null?(t.timeoutId!=null&&clearTimeout(t.timeoutId),this.storage.delete(e),!0):!1}}var it;(function(r){r[r.NEW_STREAM=0]="NEW_STREAM",r[r.MESSAGE_RECEIVER=1]="MESSAGE_RECEIVER",r[r.MESSAGE_INITIATOR=2]="MESSAGE_INITIATOR",r[r.CLOSE_RECEIVER=3]="CLOSE_RECEIVER",r[r.CLOSE_INITIATOR=4]="CLOSE_INITIATOR",r[r.RESET_RECEIVER=5]="RESET_RECEIVER",r[r.RESET_INITIATOR=6]="RESET_INITIATOR"})(it||(it={}));const Hx=Object.freeze({0:"NEW_STREAM",1:"MESSAGE_RECEIVER",2:"MESSAGE_INITIATOR",3:"CLOSE_RECEIVER",4:"CLOSE_INITIATOR",5:"RESET_RECEIVER",6:"RESET_INITIATOR"}),kP=Object.freeze({NEW_STREAM:it.NEW_STREAM,MESSAGE:it.MESSAGE_INITIATOR,CLOSE:it.CLOSE_INITIATOR,RESET:it.RESET_INITIATOR}),n6e=Object.freeze({MESSAGE:it.MESSAGE_RECEIVER,CLOSE:it.CLOSE_RECEIVER,RESET:it.RESET_RECEIVER}),mj=1<<20,i6e=4<<20;let s6e=class{constructor(e=mj,t=i6e){u(this,"_buffer");u(this,"_headerInfo");u(this,"_maxMessageSize");u(this,"_maxUnprocessedMessageQueueSize");this._buffer=new Ue,this._headerInfo=null,this._maxMessageSize=e,this._maxUnprocessedMessageQueueSize=t}write(e){if(e==null||e.length===0)return[];if(this._buffer.append(e),this._buffer.byteLength>this._maxUnprocessedMessageQueueSize)throw new xt("Unprocessed message queue size too large!");const t=[];for(;this._buffer.length!==0;){if(this._headerInfo==null)try{this._headerInfo=this._decodeHeader(this._buffer)}catch(l){if(l.name==="InvalidMessageError")throw l;break}const{id:n,type:i,length:s,offset:o}=this._headerInfo;if(this._buffer.length-o<s)break;const c={id:n,type:i};(i===it.NEW_STREAM||i===it.MESSAGE_INITIATOR||i===it.MESSAGE_RECEIVER)&&(c.data=this._buffer.sublist(o,o+s)),t.push(c),this._buffer.consume(o+s),this._headerInfo=null}return t}_decodeHeader(e){const{value:t,offset:n}=TP(e),{value:i,offset:s}=TP(e,n),o=t&7;if(Hx[o]==null)throw new Error(`Invalid type received: ${o}`);if(i>this._maxMessageSize)throw new xt("Message size too large");return{id:t>>3,type:o,offset:n+s,length:i}}};const o6e=128,_P=127;function TP(r,e=0){let t=0,n=0,i=e,s;const o=r.length;do{if(i>=o||n>49)throw e=0,new RangeError("Could not decode varint");s=r.get(i++),t+=n<28?(s&_P)<<n:(s&_P)*Math.pow(2,n),n+=7}while(s>=o6e);return e=i-e,{value:t,offset:e}}const C8=10*1024;let a6e=class{constructor(){u(this,"_pool");u(this,"_poolOffset");this._pool=Mn(C8),this._poolOffset=0}write(e,t){const n=this._pool;let i=this._poolOffset;xr(e.id<<3|e.type,n,i),i+=gt(e.id<<3|e.type),(e.type===it.NEW_STREAM||e.type===it.MESSAGE_INITIATOR||e.type===it.MESSAGE_RECEIVER)&&e.data!=null?(xr(e.data.length,n,i),i+=gt(e.data.length)):(xr(0,n,i),i+=gt(0));const s=n.subarray(this._poolOffset,i);C8-i<100?(this._pool=Mn(C8),this._poolOffset=0):this._poolOffset=i,t.append(s),(e.type===it.NEW_STREAM||e.type===it.MESSAGE_INITIATOR||e.type===it.MESSAGE_RECEIVER)&&e.data!=null&&t.append(e.data)}};const c6e=new a6e;async function*l6e(r){for await(const e of r){const t=new Ue;c6e.write(e,t),yield t}}class u6e extends Error{constructor(e="Stream input buffer error"){super(e),this.name="StreamInputBufferError"}}class d6e extends Ex{constructor(t){super(t);u(this,"name");u(this,"streamId");u(this,"send");u(this,"types");u(this,"maxDataSize");this.types=t.direction==="outbound"?kP:n6e,this.send=t.send,this.name=t.name,this.streamId=t.streamId,this.maxDataSize=t.maxDataSize}async sendNewStream(){await this.send({id:this.streamId,type:kP.NEW_STREAM,data:new Ue(oe(this.name))})}async sendData(t){for(t=t.sublist();t.byteLength>0;){const n=Math.min(t.byteLength,this.maxDataSize);await this.send({id:this.streamId,type:this.types.MESSAGE,data:t.sublist(0,n)}),t.consume(n)}}async sendReset(){await this.send({id:this.streamId,type:this.types.RESET})}async sendCloseWrite(){await this.send({id:this.streamId,type:this.types.CLOSE})}async sendCloseRead(){}}function h6e(r){const{id:e,name:t,send:n,onEnd:i,type:s="initiator",maxMsgSize:o=mj}=r;return new d6e({id:s==="initiator"?`i${e}`:`r${e}`,streamId:e,name:`${t??e}`,direction:s==="initiator"?"outbound":"inbound",maxDataSize:o,onEnd:i,send:n,log:r.logger.forComponent(`libp2p:mplex:stream:${s}:${e}`)})}const f6e=1024,p6e=1024,g6e=1024*1024*4,y6e=5,m6e=500;function PP(r){const e={...r,type:`${Hx[r.type]} (${r.type})`};return r.type===it.NEW_STREAM&&(e.data=re(r.data instanceof Uint8Array?r.data:r.data.subarray())),(r.type===it.MESSAGE_INITIATOR||r.type===it.MESSAGE_RECEIVER)&&(e.data=re(r.data instanceof Uint8Array?r.data:r.data.subarray(),"base16")),e}class w6e{constructor(e,t){u(this,"protocol","/mplex/6.7.0");u(this,"sink");u(this,"source");u(this,"log");u(this,"_streamId");u(this,"_streams");u(this,"_init");u(this,"_source");u(this,"closeController");u(this,"rateLimiter");u(this,"closeTimeout");u(this,"logger");t=t??{},this.log=e.logger.forComponent("libp2p:mplex"),this.logger=e.logger,this._streamId=0,this._streams={initiators:new Map,receivers:new Map},this._init=t,this.closeTimeout=t.closeTimeout??m6e,this.sink=this._createSink(),this._source=Fo({objectMode:!0,onEnd:()=>{for(const n of this._streams.initiators.values())n.destroy();for(const n of this._streams.receivers.values())n.destroy()}}),this.source=hn(this._source,n=>l6e(n)),this.closeController=new AbortController,this.rateLimiter=new yj({points:t.disconnectThreshold??y6e,duration:1})}get streams(){const e=[];for(const t of this._streams.initiators.values())e.push(t);for(const t of this._streams.receivers.values())e.push(t);return e}newStream(e){if(this.closeController.signal.aborted)throw new al("Muxer already closed");const t=this._streamId++;e=e==null?t.toString():e.toString();const n=this._streams.initiators;return this._newStream({id:t,name:e,type:"initiator",registry:n})}async close(e){if(this.closeController.signal.aborted)return;const t=(e==null?void 0:e.signal)??AbortSignal.timeout(this.closeTimeout);try{await Promise.all(this.streams.map(async n=>n.close({signal:t}))),this._source.end(),await this._source.onEmpty({signal:t}),this.closeController.abort()}catch(n){this.abort(n)}}abort(e){this.closeController.signal.aborted||(this.streams.forEach(t=>{t.abort(e)}),this.closeController.abort(e))}_newReceiverStream(e){const{id:t,name:n}=e,i=this._streams.receivers;return this._newStream({id:t,name:n,type:"receiver",registry:i})}_newStream(e){const{id:t,name:n,type:i,registry:s}=e;if(this.log("new %s stream %s",i,t),i==="initiator"&&this._streams.initiators.size===(this._init.maxOutboundStreams??p6e))throw new tw("Too many outbound streams open");if(s.has(t))throw new Error(`${i} stream ${t} already exists!`);const c=h6e({id:t,name:n,send:async l=>{this.log.enabled&&this.log.trace("%s stream %s send",i,t,PP(l)),this._source.push(l)},type:i,onEnd:()=>{this.log("%s stream with id %s and protocol %s ended",i,t,c.protocol),s.delete(t),this._init.onStreamEnd!=null&&this._init.onStreamEnd(c)},maxMsgSize:this._init.maxMsgSize,logger:this.logger});return s.set(t,c),c}_createSink(){return async t=>{const n=()=>{kV(t,this.log)};this.closeController.signal.addEventListener("abort",n);try{const i=new s6e(this._init.maxMsgSize,this._init.maxUnprocessedMessageQueueSize);for await(const s of t)for(const o of i.write(s))await this._handleIncoming(o);this._source.end()}catch(i){this.log("error in sink",i),this._source.end(i)}finally{this.closeController.signal.removeEventListener("abort",n)}}}async _handleIncoming(e){const{id:t,type:n}=e;if(this.log.enabled&&this.log.trace("incoming message",PP(e)),e.type===it.NEW_STREAM){if(this._streams.receivers.size===(this._init.maxInboundStreams??f6e)){this.log("too many inbound streams open"),this._source.push({id:t,type:it.RESET_RECEIVER});try{await this.rateLimiter.consume("new-stream",1)}catch{this.log("rate limit hit when opening too many new streams over the inbound stream limit - closing remote connection"),this.abort(new Error("Too many open streams"));return}return}const a=this._newReceiverStream({id:t,name:re(e.data instanceof Uint8Array?e.data:e.data.subarray())});this._init.onIncomingStream!=null&&this._init.onIncomingStream(a);return}const s=((n&1)===1?this._streams.initiators:this._streams.receivers).get(t);if(s==null){this.log("missing stream %s for message type %s",t,Hx[n]);try{await this.rateLimiter.consume("missing-stream",1)}catch{this.log("rate limit hit when receiving messages for streams that do not exist - closing remote connection"),this.abort(new Error("Too many messages for missing streams"));return}return}const o=this._init.maxStreamBufferSize??g6e;try{switch(n){case it.MESSAGE_INITIATOR:case it.MESSAGE_RECEIVER:if(s.sourceReadableLength()>o)throw this._source.push({id:e.id,type:n===it.MESSAGE_INITIATOR?it.RESET_RECEIVER:it.RESET_INITIATOR}),new u6e("Input buffer full - increase Mplex maxBufferSize to accommodate slow consumers");s.sourcePush(e.data);break;case it.CLOSE_INITIATOR:case it.CLOSE_RECEIVER:s.remoteCloseWrite();break;case it.RESET_INITIATOR:case it.RESET_RECEIVER:s.reset();break;default:this.log("unknown message type %s",n)}}catch(a){this.log.error("error while processing message",a),s.abort(a)}}}var WN,GN;GN=Symbol.toStringTag,WN=fr;class b6e{constructor(e,t={}){u(this,"protocol","/mplex/6.7.0");u(this,"_init");u(this,"components");u(this,GN,"@libp2p/mplex");u(this,WN,["@libp2p/stream-multiplexing"]);this.components=e,this._init=t}createStreamMuxer(e={}){return new w6e(this.components,{...e,...this._init})}}function v6e(r={}){return e=>new b6e(e,r)}const I8=32,E6e="1.0.0",S6e="ping",x6e="ipfs",A6e=1e4,C6e=2,I6e=1;var QN,YN;YN=Symbol.toStringTag,QN=fr;class k6e{constructor(e,t={}){u(this,"protocol");u(this,"components");u(this,"started");u(this,"timeout");u(this,"maxInboundStreams");u(this,"maxOutboundStreams");u(this,"runOnLimitedConnection");u(this,"log");u(this,YN,"@libp2p/ping");u(this,QN,["@libp2p/ping"]);this.components=e,this.log=e.logger.forComponent("libp2p:ping"),this.started=!1,this.protocol=`/${t.protocolPrefix??x6e}/${S6e}/${E6e}`,this.timeout=t.timeout??A6e,this.maxInboundStreams=t.maxInboundStreams??C6e,this.maxOutboundStreams=t.maxOutboundStreams??I6e,this.runOnLimitedConnection=t.runOnLimitedConnection??!0,this.handleMessage=this.handleMessage.bind(this)}async start(){await this.components.registrar.handle(this.protocol,this.handleMessage,{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:this.runOnLimitedConnection}),this.started=!0}async stop(){await this.components.registrar.unhandle(this.protocol),this.started=!1}isStarted(){return this.started}handleMessage(e){this.log("incoming ping from %p",e.connection.remotePeer);const{stream:t}=e,n=Date.now(),i=sm(t);let s=!1;Promise.resolve().then(async()=>{for(;;){const o=AbortSignal.timeout(this.timeout);o.addEventListener("abort",()=>{t==null||t.abort(new Bp("ping timeout"))});const a=await i.read({bytes:I8,signal:o});await i.write(a,{signal:o}),s=!0}}).catch(o=>{s&&o.name==="UnexpectedEOFError"&&t.readStatus!=="ready"||(this.log.error("incoming ping from %p failed with error - %e",e.connection.remotePeer,o),t==null||t.abort(o))}).finally(()=>{const o=Date.now()-n;this.log("incoming ping from %p complete in %dms",e.connection.remotePeer,o);const a=AbortSignal.timeout(this.timeout);t.close({signal:a}).catch(c=>{this.log.error("error closing ping stream from %p - %e",e.connection.remotePeer,c),t==null||t.abort(c)})})}async ping(e,t={}){this.log("pinging %p",e);const n=Date.now(),i=xc(I8),s=await this.components.connectionManager.openConnection(e,t);let o;if(t.signal==null){const a=AbortSignal.timeout(this.timeout);t={...t,signal:a}}try{o=await s.newStream(this.protocol,{...t,runOnLimitedConnection:this.runOnLimitedConnection});const a=sm(o),[,c]=await Promise.all([a.write(i,t),a.read({...t,bytes:I8})]),l=Date.now()-n;if(!He(i,c.subarray()))throw new sB(`Received wrong ping ack after ${l}ms`);return this.log("ping %p complete in %dms",s.remotePeer,l),l}catch(a){throw this.log.error("error while pinging %p",s.remotePeer,a),o==null||o.abort(a),a}finally{o!=null&&await o.close(t)}}}function _6e(r={}){return e=>new k6e(e,r)}var bn;(function(r){(function(n){n.FIN="FIN",n.STOP_SENDING="STOP_SENDING",n.RESET="RESET",n.FIN_ACK="FIN_ACK"})(r.Flag||(r.Flag={}));let e;(function(n){n[n.FIN=0]="FIN",n[n.STOP_SENDING=1]="STOP_SENDING",n[n.RESET=2]="RESET",n[n.FIN_ACK=3]="FIN_ACK"})(e||(e={})),function(n){n.codec=()=>On(e)}(r.Flag||(r.Flag={}));let t;r.codec=()=>(t==null&&(t=$e((n,i,s={})=>{s.lengthDelimited!==!1&&i.fork(),n.flag!=null&&(i.uint32(8),r.Flag.codec().encode(n.flag,i)),n.message!=null&&(i.uint32(18),i.bytes(n.message)),s.lengthDelimited!==!1&&i.ldelim()},(n,i,s={})=>{const o={},a=i==null?n.len:n.pos+i;for(;n.pos<a;){const c=n.uint32();switch(c>>>3){case 1:{o.flag=r.Flag.codec().decode(n);break}case 2:{o.message=n.bytes();break}default:{n.skipType(c&7);break}}}return o})),t),r.encode=n=>De(n,r.codec()),r.decode=(n,i)=>Pe(n,r.codec(),i)})(bn||(bn={}));const T6e=["stun:stun.l.google.com:19302","stun:global.stun.twilio.com:3478","stun:stun.cloudflare.com:3478","stun:stun.services.mozilla.com:3478"],DP=Array.from("abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890"),P6e="libp2p+webrtc+v1/",D6e=466,$6e=2*1024*1024,N6e=30*1e3,a4=16*1024;function M6e(r=a4){const e=gt(r-gt(r)),t=1+gt(Object.keys(bn.Flag).length-1),n=1,i=r-e-t-n,s=gt(i);return e+t+n+s}const O6e=M6e(),R6e=5e3,L6e=5e3,B6e=3e4,wj="/webrtc",t7="/webrtc-signaling/0.0.1",U6e="/libp2p/webrtc-direct/certificate",F6e="webrtc-direct-certificate-private-key",z6e=12096e5,$P=864e5;var NP=function(r,e,t){if(t||arguments.length===2)for(var n=0,i=e.length,s;n<i;n++)(s||!(n in e))&&(s||(s=Array.prototype.slice.call(e,0,n)),s[n]=e[n]);return r.concat(s||Array.prototype.slice.call(e))},V6e=function(){function r(e,t,n){this.name=e,this.version=t,this.os=n,this.type="browser"}return r}(),K6e=function(){function r(e){this.version=e,this.type="node",this.name="node",this.os=process.platform}return r}(),j6e=function(){function r(e,t,n,i){this.name=e,this.version=t,this.os=n,this.bot=i,this.type="bot-device"}return r}(),H6e=function(){function r(){this.type="bot",this.bot=!0,this.name="bot",this.version=null,this.os=null}return r}(),q6e=function(){function r(){this.type="react-native",this.name="react-native",this.version=null,this.os=null}return r}(),W6e=/alexa|bot|crawl(er|ing)|facebookexternalhit|feedburner|google web preview|nagios|postrank|pingdom|slurp|spider|yahoo!|yandex/,G6e=/(nuhk|curl|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask\ Jeeves\/Teoma|ia_archiver)/,MP=3,Q6e=[["aol",/AOLShield\/([0-9\._]+)/],["edge",/Edge\/([0-9\._]+)/],["edge-ios",/EdgiOS\/([0-9\._]+)/],["yandexbrowser",/YaBrowser\/([0-9\._]+)/],["kakaotalk",/KAKAOTALK\s([0-9\.]+)/],["samsung",/SamsungBrowser\/([0-9\.]+)/],["silk",/\bSilk\/([0-9._-]+)\b/],["miui",/MiuiBrowser\/([0-9\.]+)$/],["beaker",/BeakerBrowser\/([0-9\.]+)/],["edge-chromium",/EdgA?\/([0-9\.]+)/],["chromium-webview",/(?!Chrom.*OPR)wv\).*Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],["chrome",/(?!Chrom.*OPR)Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],["phantomjs",/PhantomJS\/([0-9\.]+)(:?\s|$)/],["crios",/CriOS\/([0-9\.]+)(:?\s|$)/],["firefox",/Firefox\/([0-9\.]+)(?:\s|$)/],["fxios",/FxiOS\/([0-9\.]+)/],["opera-mini",/Opera Mini.*Version\/([0-9\.]+)/],["opera",/Opera\/([0-9\.]+)(?:\s|$)/],["opera",/OPR\/([0-9\.]+)(:?\s|$)/],["pie",/^Microsoft Pocket Internet Explorer\/(\d+\.\d+)$/],["pie",/^Mozilla\/\d\.\d+\s\(compatible;\s(?:MSP?IE|MSInternet Explorer) (\d+\.\d+);.*Windows CE.*\)$/],["netfront",/^Mozilla\/\d\.\d+.*NetFront\/(\d.\d)/],["ie",/Trident\/7\.0.*rv\:([0-9\.]+).*\).*Gecko$/],["ie",/MSIE\s([0-9\.]+);.*Trident\/[4-7].0/],["ie",/MSIE\s(7\.0)/],["bb10",/BB10;\sTouch.*Version\/([0-9\.]+)/],["android",/Android\s([0-9\.]+)/],["ios",/Version\/([0-9\._]+).*Mobile.*Safari.*/],["safari",/Version\/([0-9\._]+).*Safari/],["facebook",/FB[AS]V\/([0-9\.]+)/],["instagram",/Instagram\s([0-9\.]+)/],["ios-webview",/AppleWebKit\/([0-9\.]+).*Mobile/],["ios-webview",/AppleWebKit\/([0-9\.]+).*Gecko\)$/],["curl",/^curl\/([0-9\.]+)$/],["searchbot",W6e]],OP=[["iOS",/iP(hone|od|ad)/],["Android OS",/Android/],["BlackBerry OS",/BlackBerry|BB10/],["Windows Mobile",/IEMobile/],["Amazon OS",/Kindle/],["Windows 3.11",/Win16/],["Windows 95",/(Windows 95)|(Win95)|(Windows_95)/],["Windows 98",/(Windows 98)|(Win98)/],["Windows 2000",/(Windows NT 5.0)|(Windows 2000)/],["Windows XP",/(Windows NT 5.1)|(Windows XP)/],["Windows Server 2003",/(Windows NT 5.2)/],["Windows Vista",/(Windows NT 6.0)/],["Windows 7",/(Windows NT 6.1)/],["Windows 8",/(Windows NT 6.2)/],["Windows 8.1",/(Windows NT 6.3)/],["Windows 10",/(Windows NT 10.0)/],["Windows ME",/Windows ME/],["Windows CE",/Windows CE|WinCE|Microsoft Pocket Internet Explorer/],["Open BSD",/OpenBSD/],["Sun OS",/SunOS/],["Chrome OS",/CrOS/],["Linux",/(Linux)|(X11)/],["Mac OS",/(Mac_PowerPC)|(Macintosh)/],["QNX",/QNX/],["BeOS",/BeOS/],["OS/2",/OS\/2/]];function Y6e(r){return typeof document>"u"&&typeof navigator<"u"&&navigator.product==="ReactNative"?new q6e:typeof navigator<"u"?X6e(navigator.userAgent):ebe()}function J6e(r){return r!==""&&Q6e.reduce(function(e,t){var n=t[0],i=t[1];if(e)return e;var s=i.exec(r);return!!s&&[n,s]},!1)}function X6e(r){var e=J6e(r);if(!e)return null;var t=e[0],n=e[1];if(t==="searchbot")return new H6e;var i=n[1]&&n[1].split(".").join("_").split("_").slice(0,3);i?i.length<MP&&(i=NP(NP([],i,!0),tbe(MP-i.length),!0)):i=[];var s=i.join("."),o=Z6e(r),a=G6e.exec(r);return a&&a[1]?new j6e(t,s,o,a[1]):new V6e(t,s,o)}function Z6e(r){for(var e=0,t=OP.length;e<t;e++){var n=OP[e],i=n[0],s=n[1],o=s.exec(r);if(o)return i}return null}function ebe(){var r=typeof process<"u"&&process.version;return r?new K6e(process.version.slice(1)):null}function tbe(r){for(var e=[],t=0;t<r;t++)e.push("0");return e}const RP=Y6e(),qx=RP!=null&&RP.name==="firefox",bj=async function*(){},vj=async r=>{};function rbe(r,e,t=B6e,n){r.readyState==="open"&&Promise.resolve().then(async()=>{if(r.bufferedAmount>0){n.log("%s drain channel with %d buffered bytes",e,r.bufferedAmount);const i=Le();let s=!1;r.bufferedAmountLowThreshold=0;const o=()=>{s||(n.log("%s drain channel closed before drain",e),i.resolve())};r.addEventListener("close",o,{once:!0}),r.addEventListener("bufferedamountlow",()=>{s=!0,r.removeEventListener("close",o),i.resolve()}),await Pp(i.promise,{milliseconds:t})}}).then(async()=>{r.readyState==="open"&&r.close()}).catch(i=>{n.log.error("error closing outbound stream",i)})}async function LP(r){return r=r??{},typeof r=="function"&&(r=await r()),r.iceServers=r.iceServers??T6e.map(e=>({urls:[e]})),r}const nbe=(r=32)=>P6e+[...Array(r)].map(()=>DP.at(Math.floor(Math.random()*DP.length))).join("");class r7{constructor(e,t){u(this,"log");u(this,"peerConnection");u(this,"remoteAddr");u(this,"timeline");u(this,"metrics");u(this,"source",bj());u(this,"sink",vj);this.log=e.logger.forComponent("libp2p:webrtc:maconn"),this.remoteAddr=t.remoteAddr,this.timeline=t.timeline,this.peerConnection=t.peerConnection;const n=this.peerConnection,i=n.connectionState;this.peerConnection.onconnectionstatechange=()=>{this.log.trace("peer connection state change",n.connectionState,"initial state",i),(n.connectionState==="disconnected"||n.connectionState==="failed"||n.connectionState==="closed")&&(this.timeline.close=Date.now())}}async close(e){var t;this.log.trace("closing connection"),this.peerConnection.close(),this.timeline.close=Date.now(),(t=this.metrics)==null||t.increment({close:!0})}abort(e){var t;this.log.error("closing connection due to error",e),this.peerConnection.close(),this.timeline.close=Date.now(),(t=this.metrics)==null||t.increment({abort:!0})}}class ibe extends Ex{constructor(t){const n=t.onEnd;t.onEnd=s=>{this.log.trace('readable and writeable ends closed with status "%s"',this.status),Promise.resolve(async()=>{if(!(this.timeline.abort!=null||this.timeline.reset!==null))try{await Pp(this.receiveFinAck.promise,{milliseconds:this.finAckTimeout})}catch(o){this.log.error("error receiving FIN_ACK",o)}}).then(()=>{this.incomingData.end(),n==null||n(s)}).catch(o=>{this.log.error("error ending stream",o)}).finally(()=>{this.channel.close()})};super(t);u(this,"channel");u(this,"incomingData");u(this,"maxBufferedAmount");u(this,"bufferedAmountLowEventTimeout");u(this,"maxMessageSize");u(this,"receiveFinAck");u(this,"finAckTimeout");u(this,"openTimeout");u(this,"closeController");switch(this.channel=t.channel,this.channel.binaryType="arraybuffer",this.incomingData=Fo(),this.bufferedAmountLowEventTimeout=t.bufferedAmountLowEventTimeout??N6e,this.maxBufferedAmount=t.maxBufferedAmount??$6e,this.maxMessageSize=(t.maxMessageSize??a4)-O6e,this.receiveFinAck=Le(),this.finAckTimeout=t.closeTimeout??R6e,this.openTimeout=t.openTimeout??L6e,this.closeController=new AbortController,this.channel.readyState){case"open":this.timeline.open=new Date().getTime();break;case"closed":case"closing":(this.timeline.close===void 0||this.timeline.close===0)&&(this.timeline.close=Date.now());break;case"connecting":break;default:throw this.log.error("unknown datachannel state %s",this.channel.readyState),new ry("Unknown datachannel state")}this.channel.onopen=s=>{this.timeline.open=new Date().getTime()},this.channel.onclose=s=>{this.log.trace("received onclose event"),this.closeController.abort(),this.receiveFinAck.resolve(),this.close().catch(o=>{this.log.error("error closing stream after channel closed",o)})},this.channel.onerror=s=>{this.log.trace("received onerror event"),this.closeController.abort();const o=s.error;this.abort(o)},this.channel.onmessage=async s=>{const{data:o}=s;o===null||o.byteLength===0||this.incomingData.push(new Uint8Array(o,0,o.byteLength))};const i=this;Promise.resolve().then(async()=>{for await(const s of Yd(this.incomingData)){const o=i.processIncomingProtobuf(s);o!=null&&i.sourcePush(new Ue(o))}}).catch(s=>{this.log.error("error processing incoming data channel messages",s)})}sendNewStream(){}async _sendMessage(t,n=!0){if(this.channel.readyState==="closed"||this.channel.readyState==="closing")throw new ry(`Invalid datachannel state - ${this.channel.readyState}`);if(this.channel.readyState!=="open"){const i=AbortSignal.timeout(this.openTimeout),s=dt([this.closeController.signal,i]);try{this.log('channel state is "%s" and not "open", waiting for "open" event before sending data',this.channel.readyState),await Ci(this.channel,"open",s)}finally{s.clear()}this.log('channel state is now "%s", sending data',this.channel.readyState)}if(n&&this.channel.bufferedAmount>this.maxBufferedAmount){const i=AbortSignal.timeout(this.bufferedAmountLowEventTimeout),s=dt([this.closeController.signal,i]);try{this.log('channel buffer is %d, wait for "bufferedamountlow" event',this.channel.bufferedAmount),await Ci(this.channel,"bufferedamountlow",s)}catch(o){throw i.aborted?new Bp(`Timed out waiting for DataChannel buffer to clear after ${this.bufferedAmountLowEventTimeout}ms`):o}finally{s.clear()}}try{this.log.trace('sending message, channel state "%s"',this.channel.readyState),this.channel.send(t.subarray())}catch(i){this.log.error("error while sending message",i)}}async sendData(t){const n=t.byteLength;for(t=t.sublist();t.byteLength>0;){const i=Math.min(t.byteLength,this.maxMessageSize),s=t.subarray(0,i),o=bn.encode({message:s}),a=Qd.single(o);this.log.trace("sending %d/%d bytes on channel",s.byteLength,n),await this._sendMessage(a),t.consume(i)}this.log.trace('finished sending data, channel state "%s"',this.channel.readyState)}async sendReset(){try{await this._sendFlag(bn.Flag.RESET)}catch(t){this.log.error("failed to send reset - %e",t)}finally{this.channel.close()}}async sendCloseWrite(t){if(this.channel.readyState!=="open"){this.receiveFinAck.resolve();return}if(await this._sendFlag(bn.Flag.FIN)){this.log.trace("awaiting FIN_ACK");try{await cn(this.receiveFinAck.promise,t==null?void 0:t.signal,{errorMessage:"sending close-write was aborted before FIN_ACK was received",errorName:"FinAckNotReceivedError"})}catch(i){this.log.error("failed to await FIN_ACK",i)}}else this.log.trace("sending FIN failed, not awaiting FIN_ACK");this.receiveFinAck.resolve()}async sendCloseRead(){this.channel.readyState==="open"&&await this._sendFlag(bn.Flag.STOP_SENDING)}processIncomingProtobuf(t){const n=bn.decode(t);if(n.flag!==void 0&&(this.log.trace('incoming flag %s, write status "%s", read status "%s"',n.flag,this.writeStatus,this.readStatus),n.flag===bn.Flag.FIN&&(this.remoteCloseWrite(),this.log.trace("sending FIN_ACK"),this._sendFlag(bn.Flag.FIN_ACK).catch(i=>{this.log.error("error sending FIN_ACK immediately",i)})),n.flag===bn.Flag.RESET&&this.reset(),n.flag===bn.Flag.STOP_SENDING&&this.remoteCloseRead(),n.flag===bn.Flag.FIN_ACK&&(this.log.trace("received FIN_ACK"),this.receiveFinAck.resolve())),this.readStatus==="ready")return n.message}async _sendFlag(t){if(this.channel.readyState!=="open")return this.log.trace('not sending flag %s because channel is "%s" and not "open"',t.toString(),this.channel.readyState),!1;this.log.trace("sending flag %s",t.toString());const n=bn.encode({flag:t}),i=Qd.single(n);try{return await this._sendMessage(i,!1),!0}catch(s){this.log.error("could not send flag %s - %e",t.toString(),s)}return!1}}function Im(r){const{channel:e,direction:t,handshake:n}=r;return new ibe({id:`${e.id}`,log:r.logger.forComponent(`libp2p:webrtc:stream:${n===!0?"handshake":t}:${e.id}`),...r})}class Wx{constructor(e,t){u(this,"protocol");u(this,"peerConnection");u(this,"bufferedStreams",[]);u(this,"metrics");u(this,"dataChannelOptions");u(this,"components");u(this,"log");this.components=e,this.peerConnection=t.peerConnection,this.metrics=t.metrics,this.protocol=t.protocol??wj,this.dataChannelOptions=t.dataChannelOptions??{},this.log=e.logger.forComponent("libp2p:webrtc:muxerfactory"),this.peerConnection.ondatachannel=({channel:n})=>{if(this.log.trace('incoming early datachannel with channel id %d and label "%s"',n.id),n.label==="init"){this.log.trace("closing early init channel"),n.close();return}const i={},s=Im({channel:n,direction:"inbound",onEnd:o=>{i.onEnd(o)},logger:e.logger,...this.dataChannelOptions});i.stream=s,i.channel=n,i.onEnd=()=>{this.bufferedStreams=this.bufferedStreams.filter(o=>o.stream.id!==s.id)},this.bufferedStreams.push(i)}}createStreamMuxer(e){return new sbe(this.components,{...e,peerConnection:this.peerConnection,dataChannelOptions:this.dataChannelOptions,metrics:this.metrics,streams:this.bufferedStreams,protocol:this.protocol})}}var Nd,l2;class sbe{constructor(e,t){Ge(this,Nd);u(this,"init");u(this,"streams");u(this,"protocol");u(this,"log");u(this,"peerConnection");u(this,"dataChannelOptions");u(this,"metrics");u(this,"logger");u(this,"source",bj());u(this,"sink",vj);this.init=t,this.log=e.logger.forComponent("libp2p:webrtc:muxer"),this.logger=e.logger,this.streams=t.streams.map(n=>n.stream),this.peerConnection=t.peerConnection,this.protocol=t.protocol??wj,this.metrics=t.metrics,this.dataChannelOptions=t.dataChannelOptions??{},this.peerConnection.ondatachannel=({channel:n})=>{var o,a;if(this.log.trace("incoming datachannel with channel id %d",n.id),n.label==="init"){this.log.trace("closing init channel"),n.close();return}const i=n.id,s=Im({channel:n,direction:"inbound",onEnd:()=>{Ie(this,Nd,l2).call(this,s,n),this.log("incoming channel %s ended",i)},logger:this.logger,...this.dataChannelOptions});this.streams.push(s),(o=this.metrics)==null||o.increment({incoming_stream:!0}),(a=t==null?void 0:t.onIncomingStream)==null||a.call(t,s)},this.init.streams.length>0&&queueMicrotask(()=>{this.init.streams.forEach(n=>{var i,s,o;n.onEnd=()=>{this.log("incoming early channel %s ended with state %s",n.channel.id,n.channel.readyState),Ie(this,Nd,l2).call(this,n.stream,n.channel)},(i=this.metrics)==null||i.increment({incoming_stream:!0}),(o=(s=this.init)==null?void 0:s.onIncomingStream)==null||o.call(s,n.stream)})})}async close(e){try{await Promise.all(this.streams.map(async t=>t.close(e)))}catch(t){this.abort(t)}}abort(e){for(const t of this.streams)t.abort(e)}newStream(){var i;const e=this.peerConnection.createDataChannel(""),t=e.id;this.log.trace("opened outgoing datachannel with channel id %s",t);const n=Im({channel:e,direction:"outbound",onEnd:()=>{Ie(this,Nd,l2).call(this,n,e),this.log("outgoing channel %s ended",t)},logger:this.logger,...this.dataChannelOptions});return this.streams.push(n),(i=this.metrics)==null||i.increment({outgoing_stream:!0}),n}}Nd=new WeakSet,l2=function(e,t){var n,i,s;this.log.trace("stream %s %s %s onEnd",e.direction,e.id,e.protocol),rbe(t,`${e.direction} ${e.id} ${e.protocol}`,this.dataChannelOptions.drainTimeout,{log:this.log}),this.streams=this.streams.filter(o=>o.id!==e.id),(n=this.metrics)==null||n.increment({stream_end:!0}),(s=(i=this.init)==null?void 0:i.onStreamEnd)==null||s.call(i,e)};const Ej=globalThis.RTCPeerConnection,Sj=globalThis.RTCSessionDescription,obe=globalThis.RTCIceCandidate;class Zp extends Error{constructor(e){super(`WebRTC transport error: ${e}`),this.name="WebRTCTransportError"}}class Ja extends Zp{constructor(e="SDP handshake failed"){super(e),this.name="SDPHandshakeFailedError"}}class abe extends Zp{constructor(e,t){super(`Invalid fingerprint "${e}" within ${t}`),this.name="WebRTC/InvalidFingerprintError"}}class cbe extends Zp{constructor(e){super(`A method (${e}) was called though it has been intentionally left unimplemented.`),this.name="WebRTC/UnimplementedError"}}class lbe extends Zp{constructor(e){super(`unsupported hash algorithm code: ${e} please see the codes at https://github.com/multiformats/multicodec/blob/master/table.csv `),this.name="WebRTC/UnsupportedHashAlgorithmError"}}var is;(function(r){(function(n){n.SDP_OFFER="SDP_OFFER",n.SDP_ANSWER="SDP_ANSWER",n.ICE_CANDIDATE="ICE_CANDIDATE"})(r.Type||(r.Type={}));let e;(function(n){n[n.SDP_OFFER=0]="SDP_OFFER",n[n.SDP_ANSWER=1]="SDP_ANSWER",n[n.ICE_CANDIDATE=2]="ICE_CANDIDATE"})(e||(e={})),function(n){n.codec=()=>On(e)}(r.Type||(r.Type={}));let t;r.codec=()=>(t==null&&(t=$e((n,i,s={})=>{s.lengthDelimited!==!1&&i.fork(),n.type!=null&&(i.uint32(8),r.Type.codec().encode(n.type,i)),n.data!=null&&(i.uint32(18),i.string(n.data)),s.lengthDelimited!==!1&&i.ldelim()},(n,i,s={})=>{const o={},a=i==null?n.len:n.pos+i;for(;n.pos<a;){const c=n.uint32();switch(c>>>3){case 1:{o.type=r.Type.codec().decode(n);break}case 2:{o.data=n.string();break}default:{n.skipType(c&7);break}}}return o})),t),r.encode=n=>De(n,r.codec()),r.decode=(n,i)=>Pe(n,r.codec(),i)})(is||(is={}));const xj=async(r,e,t)=>{var n,i,s,o;try{const a=Le();for(ube(r,a);;){const c=await Promise.race([a.promise,e.read({signal:t.signal}).catch(()=>{})]);if(c==null){(n=t.signal)==null||n.throwIfAborted();break}if(c.type!==is.Type.ICE_CANDIDATE)throw new xt("ICE candidate message expected");const l=JSON.parse(c.data??"null");if(l===""||l===null){(i=t.onProgress)==null||i.call(t,new _e("webrtc:end-of-ice-candidates")),t.log.trace("end-of-candidates received");continue}const d=new obe(l);t.log.trace("%s received new ICE candidate %o",t.direction,l);try{(s=t.onProgress)==null||s.call(t,new _e("webrtc:add-ice-candidate",d.candidate)),await r.addIceCandidate(d)}catch(h){t.log.error("%s bad candidate received",t.direction,l,h)}}}catch(a){if(t.log.error("%s error parsing ICE candidate",t.direction,a),((o=t.signal)==null?void 0:o.aborted)===!0&&Gx(r)!=="connected")throw a}};function Gx(r){return qx?r.iceConnectionState:r.connectionState}function ube(r,e){r[qx?"oniceconnectionstatechange":"onconnectionstatechange"]=t=>{switch(Gx(r)){case"connected":e.resolve();break;case"failed":case"disconnected":case"closed":e.reject(new nS("RTCPeerConnection was closed"));break}}}async function dbe({rtcConfiguration:r,dataChannel:e,signal:t,metrics:n,multiaddr:i,connectionManager:s,transportManager:o,log:a,logger:c,onProgress:l}){const{baseAddr:d}=pbe(i);n==null||n.dialerEvents.increment({open:!0}),a.trace("dialing base address: %a",d);const h=d.getPeerId();if(h==null)throw new Z("Relay peer was missing");const p=s.getConnections(Jt(h));let m,f=!1;p.length===0?(l==null||l(new _e("webrtc:dial-relay")),m=await o.dial(d,{signal:t,onProgress:l}),f=!0):(l==null||l(new _e("webrtc:reuse-relay-connection")),m=p[0]);try{l==null||l(new _e("webrtc:open-signaling-stream"));const g=await m.newStream(t7,{signal:t,runOnLimitedConnection:!0}),v=ti(g).pb(is),y=new Ej(r),w=new Wx({logger:c},{peerConnection:y,dataChannelOptions:e});try{const b=y.createDataChannel("init");y.onicecandidate=({candidate:x})=>{const I=JSON.stringify((x==null?void 0:x.toJSON())??null);a.trace("initiator sending ICE candidate %o",x),v.write({type:is.Type.ICE_CANDIDATE,data:I},{signal:t}).catch(T=>{a.error("error sending ICE candidate",T)})},y.onicecandidateerror=x=>{a.error("initiator ICE candidate error",x)};const E=await y.createOffer().catch(x=>{throw a.error("could not execute createOffer",x),new Ja("Failed to set createOffer")});a.trace("initiator send SDP offer %s",E.sdp),l==null||l(new _e("webrtc:send-sdp-offer")),await v.write({type:is.Type.SDP_OFFER,data:E.sdp},{signal:t}),await y.setLocalDescription(E).catch(x=>{throw a.error("could not execute setLocalDescription",x),new Ja("Failed to set localDescription")}),l==null||l(new _e("webrtc:read-sdp-answer")),a.trace("initiator read SDP answer");const A=await v.read({signal:t});if(A.type!==is.Type.SDP_ANSWER)throw new Ja("Remote should send an SDP answer");a.trace("initiator received SDP answer %s",A.data);const k=new Sj({type:"answer",sdp:A.data});return await y.setRemoteDescription(k).catch(x=>{throw a.error("could not execute setRemoteDescription",x),new Ja("Failed to set remoteDescription")}),a.trace("initiator read candidates until connected"),l==null||l(new _e("webrtc:read-ice-candidates")),await xj(y,v,{direction:"initiator",signal:t,log:a,onProgress:l}),a.trace("initiator connected, closing init channel"),b.close(),l==null||l(new _e("webrtc:close-signaling-stream")),a.trace("closing signaling channel"),await g.close({signal:t}),a.trace("initiator connected to remote address %s",i),{remoteAddress:i,peerConnection:y,muxerFactory:w}}catch(b){throw a.error("outgoing signaling error",b),y.close(),g.abort(b),b}finally{y.onicecandidate=null,y.onicecandidateerror=null}}finally{if(f)try{await m.close({signal:t})}catch(g){m.abort(g)}}}const BP=It(hz.matchers[0],Je("p2p-circuit"));class Qx extends er{constructor(t,n){super();u(this,"transportManager");u(this,"shutdownController");u(this,"events");this.transportManager=t.transportManager,this.events=t.events,this.shutdownController=n.shutdownController,this.onTransportListening=this.onTransportListening.bind(this)}async listen(){this.events.addEventListener("transport:listening",this.onTransportListening)}onTransportListening(t){t.detail.getAddrs().filter(i=>BP.exactMatch(i)).map(i=>i.encapsulate("/webrtc")).length>0&&this.safeDispatchEvent("listening")}getAddrs(){return this.transportManager.getListeners().filter(t=>!(t instanceof Qx)).map(t=>t.getAddrs().filter(n=>BP.exactMatch(n)).map(n=>n.encapsulate("/webrtc"))).flat()}updateAnnounceAddrs(){}async close(){this.events.removeEventListener("transport:listening",this.onTransportListening),this.shutdownController.abort(),queueMicrotask(()=>{this.safeDispatchEvent("close")})}}async function hbe({peerConnection:r,stream:e,signal:t,connection:n,log:i}){i.trace("new inbound signaling stream");const s=ti(e).pb(is);try{r.onicecandidate=({candidate:d})=>{const h=JSON.stringify((d==null?void 0:d.toJSON())??null);i.trace("recipient sending ICE candidate %s",h),s.write({type:is.Type.ICE_CANDIDATE,data:h},{signal:t}).catch(p=>{i.error("error sending ICE candidate",p)})},i.trace("recipient read SDP offer");const a=await s.read({signal:t});if(a.type!==is.Type.SDP_OFFER)throw new Ja(`expected message type SDP_OFFER, received: ${a.type??"undefined"} `);i.trace("recipient received SDP offer %s",a.data);const c=new Sj({type:"offer",sdp:a.data});await r.setRemoteDescription(c).catch(d=>{throw i.error("could not execute setRemoteDescription",d),new Ja("Failed to set remoteDescription")});const l=await r.createAnswer().catch(d=>{throw i.error("could not execute createAnswer",d),new Ja("Failed to create answer")});i.trace("recipient send SDP answer %s",l.sdp),await s.write({type:is.Type.SDP_ANSWER,data:l.sdp},{signal:t}),await r.setLocalDescription(l).catch(d=>{throw i.error("could not execute setLocalDescription",d),new Ja("Failed to set localDescription")}),i.trace("recipient read candidates until connected"),await xj(r,s,{direction:"recipient",signal:t,log:i})}catch(a){if(Gx(r)!=="connected")throw i.error("error while handling signaling stream from peer %a",n.remoteAddr,a),r.close(),a;i("error while handling signaling stream from peer %a, ignoring as the RTCPeerConnection is already connected",n.remoteAddr,a)}const o=Re(`/webrtc/p2p/${n.remoteAddr.getPeerId()}`);return i.trace("recipient connected to remote address %s",o),{remoteAddress:o}}var JN,XN,ZN,eM;eM=X3,ZN=Symbol.toStringTag,XN=fr,JN=Ec;class fbe{constructor(e,t={}){u(this,"components");u(this,"init");u(this,"log");u(this,"_started",!1);u(this,"metrics");u(this,"shutdownController");u(this,eM,!0);u(this,ZN,"@libp2p/webrtc");u(this,XN,["@libp2p/transport"]);u(this,JN,["@libp2p/identify","@libp2p/circuit-relay-v2-transport"]);this.components=e,this.init=t,this.log=e.logger.forComponent("libp2p:webrtc"),this.shutdownController=new AbortController,this.shutdownController.signal,e.metrics!=null&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_webrtc_dialer_events_total",{label:"event",help:"Total count of WebRTC dialer events by type"}),listenerEvents:e.metrics.registerCounterGroup("libp2p_webrtc_listener_events_total",{label:"event",help:"Total count of WebRTC listener events by type"})})}isStarted(){return this._started}async start(){await this.components.registrar.handle(t7,e=>{const t=this.components.upgrader.createInboundAbortSignal(this.shutdownController.signal);this._onProtocol(e,t).catch(n=>{this.log.error("failed to handle incoming connect from %p",e.connection.remotePeer,n)}).finally(()=>{t.clear()})},{runOnLimitedConnection:!0}),this._started=!0}async stop(){await this.components.registrar.unhandle(t7),this._started=!1}createListener(e){return new Qx(this.components,{shutdownController:this.shutdownController})}listenFilter(e){return e.filter(nv.exactMatch)}dialFilter(e){return this.listenFilter(e)}async dial(e,t){var c;this.log.trace("dialing address: %a",e);const{remoteAddress:n,peerConnection:i,muxerFactory:s}=await dbe({rtcConfiguration:await LP(this.init.rtcConfiguration),dataChannel:this.init.dataChannel,multiaddr:e,dataChannelOptions:this.init.dataChannel,signal:t.signal,connectionManager:this.components.connectionManager,transportManager:this.components.transportManager,log:this.log,logger:this.components.logger,onProgress:t.onProgress}),o=new r7(this.components,{peerConnection:i,timeline:{open:Date.now()},remoteAddr:n,metrics:(c=this.metrics)==null?void 0:c.dialerEvents}),a=await t.upgrader.upgradeOutbound(o,{skipProtection:!0,skipEncryption:!0,muxerFactory:s,onProgress:t.onProgress,signal:t.signal});return this._closeOnShutdown(i,o),a}async _onProtocol({connection:e,stream:t},n){var o;const i=new Ej(await LP(this.init.rtcConfiguration)),s=new Wx(this.components,{peerConnection:i,dataChannelOptions:this.init.dataChannel});try{const{remoteAddress:a}=await hbe({peerConnection:i,connection:e,stream:t,signal:n,log:this.log});await t.close({signal:n});const c=new r7(this.components,{peerConnection:i,timeline:{open:new Date().getTime()},remoteAddr:a,metrics:(o=this.metrics)==null?void 0:o.listenerEvents});await this.components.upgrader.upgradeInbound(c,{skipEncryption:!0,skipProtection:!0,muxerFactory:s,signal:n}),this._closeOnShutdown(i,c)}catch(a){throw this.log.error("incoming signaling error",a),i.close(),t.abort(a),a}}_closeOnShutdown(e,t){const n=()=>{t.close().catch(i=>{this.log.error("could not close WebRTCMultiaddrConnection",i)})};this.shutdownController.signal.addEventListener("abort",n),e.addEventListener("close",()=>{this.shutdownController.signal.removeEventListener("abort",n)})}}function pbe(r){const e=r.toString().split("/webrtc/");if(e.length!==2)throw new Z("webrtc protocol was not present in multiaddr");if(!e[0].includes("/p2p-circuit"))throw new Z("p2p-circuit protocol was not present in multiaddr");let t=Re(e[0]);const i=Re("/"+e[1]).getPeerId();if(i==null)throw new Z("destination peer id was missing");const s=t.protos().pop();if(s===void 0)throw new Z("invalid multiaddr");return s.name!=="p2p"&&(t=t.encapsulate(`/p2p/${i}`)),{baseAddr:t,peerId:Jt(i)}}/*! *****************************************************************************
Copyright (C) Microsoft. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */var UP;(function(r){(function(e){var t=typeof globalThis=="object"?globalThis:typeof v1=="object"?v1:typeof self=="object"?self:typeof this=="object"?this:a(),n=i(r);typeof t.Reflect<"u"&&(n=i(t.Reflect,n)),e(n,t),typeof t.Reflect>"u"&&(t.Reflect=r);function i(c,l){return function(d,h){Object.defineProperty(c,d,{configurable:!0,writable:!0,value:h}),l&&l(d,h)}}function s(){try{return Function("return this;")()}catch{}}function o(){try{return(0,eval)("(function() { return this; })()")}catch{}}function a(){return s()||o()}})(function(e,t){var n=Object.prototype.hasOwnProperty,i=typeof Symbol=="function",s=i&&typeof Symbol.toPrimitive<"u"?Symbol.toPrimitive:"@@toPrimitive",o=i&&typeof Symbol.iterator<"u"?Symbol.iterator:"@@iterator",a=typeof Object.create=="function",c={__proto__:[]}instanceof Array,l=!a&&!c,d={create:a?function(){return M(Object.create(null))}:c?function(){return M({__proto__:null})}:function(){return M({})},has:l?function(P,N){return n.call(P,N)}:function(P,N){return N in P},get:l?function(P,N){return n.call(P,N)?P[N]:void 0}:function(P,N){return P[N]}},h=Object.getPrototypeOf(Function),p=typeof Map=="function"&&typeof Map.prototype.entries=="function"?Map:D(),m=typeof Set=="function"&&typeof Set.prototype.entries=="function"?Set:S(),f=typeof WeakMap=="function"?WeakMap:C(),g=i?Symbol.for("@reflect-metadata:registry"):void 0,v=ua(),y=z4(v);function w(P,N,R,J){if(H(R)){if(!wt(P))throw new TypeError;if(!kt(N))throw new TypeError;return B(P,N)}else{if(!wt(P))throw new TypeError;if(!ue(N))throw new TypeError;if(!ue(J)&&!H(J)&&!ne(J))throw new TypeError;return ne(J)&&(J=void 0),R=tt(R),G(P,N,R,J)}}e("decorate",w);function b(P,N){function R(J,he){if(!ue(J))throw new TypeError;if(!H(he)&&!Qt(he))throw new TypeError;O(P,N,J,he)}return R}e("metadata",b);function E(P,N,R,J){if(!ue(R))throw new TypeError;return H(J)||(J=tt(J)),O(P,N,R,J)}e("defineMetadata",E);function A(P,N,R){if(!ue(N))throw new TypeError;return H(R)||(R=tt(R)),j(P,N,R)}e("hasMetadata",A);function k(P,N,R){if(!ue(N))throw new TypeError;return H(R)||(R=tt(R)),q(P,N,R)}e("hasOwnMetadata",k);function x(P,N,R){if(!ue(N))throw new TypeError;return H(R)||(R=tt(R)),Q(P,N,R)}e("getMetadata",x);function I(P,N,R){if(!ue(N))throw new TypeError;return H(R)||(R=tt(R)),K(P,N,R)}e("getOwnMetadata",I);function T(P,N){if(!ue(P))throw new TypeError;return H(N)||(N=tt(N)),U(P,N)}e("getMetadataKeys",T);function L(P,N){if(!ue(P))throw new TypeError;return H(N)||(N=tt(N)),W(P,N)}e("getOwnMetadataKeys",L);function z(P,N,R){if(!ue(N))throw new TypeError;if(H(R)||(R=tt(R)),!ue(N))throw new TypeError;H(R)||(R=tt(R));var J=Hc(N,R,!1);return H(J)?!1:J.OrdinaryDeleteMetadata(P,N,R)}e("deleteMetadata",z);function B(P,N){for(var R=P.length-1;R>=0;--R){var J=P[R],he=J(N);if(!H(he)&&!ne(he)){if(!kt(he))throw new TypeError;N=he}}return N}function G(P,N,R,J){for(var he=P.length-1;he>=0;--he){var Oe=P[he],Fe=Oe(N,R,J);if(!H(Fe)&&!ne(Fe)){if(!ue(Fe))throw new TypeError;J=Fe}}return J}function j(P,N,R){var J=q(P,N,R);if(J)return!0;var he=zi(N);return ne(he)?!1:j(P,he,R)}function q(P,N,R){var J=Hc(N,R,!1);return H(J)?!1:Me(J.OrdinaryHasOwnMetadata(P,N,R))}function Q(P,N,R){var J=q(P,N,R);if(J)return K(P,N,R);var he=zi(N);if(!ne(he))return Q(P,he,R)}function K(P,N,R){var J=Hc(N,R,!1);if(!H(J))return J.OrdinaryGetOwnMetadata(P,N,R)}function O(P,N,R,J){var he=Hc(R,J,!0);he.OrdinaryDefineOwnMetadata(P,N,R,J)}function U(P,N){var R=W(P,N),J=zi(P);if(J===null)return R;var he=U(J,N);if(he.length<=0)return R;if(R.length<=0)return he;for(var Oe=new m,Fe=[],Ee=0,pe=R;Ee<pe.length;Ee++){var be=pe[Ee],xe=Oe.has(be);xe||(Oe.add(be),Fe.push(be))}for(var Ce=0,We=he;Ce<We.length;Ce++){var be=We[Ce],xe=Oe.has(be);xe||(Oe.add(be),Fe.push(be))}return Fe}function W(P,N){var R=Hc(P,N,!1);return R?R.OrdinaryOwnMetadataKeys(P,N):[]}function Y(P){if(P===null)return 1;switch(typeof P){case"undefined":return 0;case"boolean":return 2;case"string":return 3;case"symbol":return 4;case"number":return 5;case"object":return P===null?1:6;default:return 6}}function H(P){return P===void 0}function ne(P){return P===null}function ye(P){return typeof P=="symbol"}function ue(P){return typeof P=="object"?P!==null:typeof P=="function"}function ce(P,N){switch(Y(P)){case 0:return P;case 1:return P;case 2:return P;case 3:return P;case 4:return P;case 5:return P}var R="string",J=to(P,s);if(J!==void 0){var he=J.call(P,R);if(ue(he))throw new TypeError;return he}return Ne(P)}function Ne(P,N){var R,J,he;{var Oe=P.toString;if(bt(Oe)){var J=Oe.call(P);if(!ue(J))return J}var R=P.valueOf;if(bt(R)){var J=R.call(P);if(!ue(J))return J}}throw new TypeError}function Me(P){return!!P}function Xe(P){return""+P}function tt(P){var N=ce(P);return ye(N)?N:Xe(N)}function wt(P){return Array.isArray?Array.isArray(P):P instanceof Object?P instanceof Array:Object.prototype.toString.call(P)==="[object Array]"}function bt(P){return typeof P=="function"}function kt(P){return typeof P=="function"}function Qt(P){switch(Y(P)){case 3:return!0;case 4:return!0;default:return!1}}function pr(P,N){return P===N||P!==P&&N!==N}function to(P,N){var R=P[N];if(R!=null){if(!bt(R))throw new TypeError;return R}}function ws(P){var N=to(P,o);if(!bt(N))throw new TypeError;var R=N.call(P);if(!ue(R))throw new TypeError;return R}function fe(P){return P.value}function Fi(P){var N=P.next();return N.done?!1:N}function bs(P){var N=P.return;N&&N.call(P)}function zi(P){var N=Object.getPrototypeOf(P);if(typeof P!="function"||P===h||N!==h)return N;var R=P.prototype,J=R&&Object.getPrototypeOf(R);if(J==null||J===Object.prototype)return N;var he=J.constructor;return typeof he!="function"||he===P?N:he}function tn(){var P;!H(g)&&typeof t.Reflect<"u"&&!(g in t.Reflect)&&typeof t.Reflect.defineMetadata=="function"&&(P=vs(t.Reflect));var N,R,J,he=new f,Oe={registerProvider:Fe,getProvider:pe,setProvider:xe};return Oe;function Fe(Ce){if(!Object.isExtensible(Oe))throw new Error("Cannot add provider to a frozen registry.");switch(!0){case P===Ce:break;case H(N):N=Ce;break;case N===Ce:break;case H(R):R=Ce;break;case R===Ce:break;default:J===void 0&&(J=new m),J.add(Ce);break}}function Ee(Ce,We){if(!H(N)){if(N.isProviderFor(Ce,We))return N;if(!H(R)){if(R.isProviderFor(Ce,We))return N;if(!H(J))for(var _t=ws(J);;){var Ht=Fi(_t);if(!Ht)return;var Vi=fe(Ht);if(Vi.isProviderFor(Ce,We))return bs(_t),Vi}}}if(!H(P)&&P.isProviderFor(Ce,We))return P}function pe(Ce,We){var _t=he.get(Ce),Ht;return H(_t)||(Ht=_t.get(We)),H(Ht)&&(Ht=Ee(Ce,We),H(Ht)||(H(_t)&&(_t=new p,he.set(Ce,_t)),_t.set(We,Ht))),Ht}function be(Ce){if(H(Ce))throw new TypeError;return N===Ce||R===Ce||!H(J)&&J.has(Ce)}function xe(Ce,We,_t){if(!be(_t))throw new Error("Metadata provider not registered.");var Ht=pe(Ce,We);if(Ht!==_t){if(!H(Ht))return!1;var Vi=he.get(Ce);H(Vi)&&(Vi=new p,he.set(Ce,Vi)),Vi.set(We,_t)}return!0}}function ua(){var P;return!H(g)&&ue(t.Reflect)&&Object.isExtensible(t.Reflect)&&(P=t.Reflect[g]),H(P)&&(P=tn()),!H(g)&&ue(t.Reflect)&&Object.isExtensible(t.Reflect)&&Object.defineProperty(t.Reflect,g,{enumerable:!1,configurable:!1,writable:!1,value:P}),P}function z4(P){var N=new f,R={isProviderFor:function(be,xe){var Ce=N.get(be);return H(Ce)?!1:Ce.has(xe)},OrdinaryDefineOwnMetadata:Fe,OrdinaryHasOwnMetadata:he,OrdinaryGetOwnMetadata:Oe,OrdinaryOwnMetadataKeys:Ee,OrdinaryDeleteMetadata:pe};return v.registerProvider(R),R;function J(be,xe,Ce){var We=N.get(be),_t=!1;if(H(We)){if(!Ce)return;We=new p,N.set(be,We),_t=!0}var Ht=We.get(xe);if(H(Ht)){if(!Ce)return;if(Ht=new p,We.set(xe,Ht),!P.setProvider(be,xe,R))throw We.delete(xe),_t&&N.delete(be),new Error("Wrong provider for target.")}return Ht}function he(be,xe,Ce){var We=J(xe,Ce,!1);return H(We)?!1:Me(We.has(be))}function Oe(be,xe,Ce){var We=J(xe,Ce,!1);if(!H(We))return We.get(be)}function Fe(be,xe,Ce,We){var _t=J(Ce,We,!0);_t.set(be,xe)}function Ee(be,xe){var Ce=[],We=J(be,xe,!1);if(H(We))return Ce;for(var _t=We.keys(),Ht=ws(_t),Vi=0;;){var LA=Fi(Ht);if(!LA)return Ce.length=Vi,Ce;var tq=fe(LA);try{Ce[Vi]=tq}catch(rq){try{bs(Ht)}finally{throw rq}}Vi++}}function pe(be,xe,Ce){var We=J(xe,Ce,!1);if(H(We)||!We.delete(be))return!1;if(We.size===0){var _t=N.get(xe);H(_t)||(_t.delete(Ce),_t.size===0&&N.delete(_t))}return!0}}function vs(P){var N=P.defineMetadata,R=P.hasOwnMetadata,J=P.getOwnMetadata,he=P.getOwnMetadataKeys,Oe=P.deleteMetadata,Fe=new f,Ee={isProviderFor:function(pe,be){var xe=Fe.get(pe);return!H(xe)&&xe.has(be)?!0:he(pe,be).length?(H(xe)&&(xe=new m,Fe.set(pe,xe)),xe.add(be),!0):!1},OrdinaryDefineOwnMetadata:N,OrdinaryHasOwnMetadata:R,OrdinaryGetOwnMetadata:J,OrdinaryOwnMetadataKeys:he,OrdinaryDeleteMetadata:Oe};return Ee}function Hc(P,N,R){var J=v.getProvider(P,N);if(!H(J))return J;if(R){if(v.setProvider(P,N,y))return y;throw new Error("Illegal state.")}}function D(){var P={},N=[],R=function(){function Ee(pe,be,xe){this._index=0,this._keys=pe,this._values=be,this._selector=xe}return Ee.prototype["@@iterator"]=function(){return this},Ee.prototype[o]=function(){return this},Ee.prototype.next=function(){var pe=this._index;if(pe>=0&&pe<this._keys.length){var be=this._selector(this._keys[pe],this._values[pe]);return pe+1>=this._keys.length?(this._index=-1,this._keys=N,this._values=N):this._index++,{value:be,done:!1}}return{value:void 0,done:!0}},Ee.prototype.throw=function(pe){throw this._index>=0&&(this._index=-1,this._keys=N,this._values=N),pe},Ee.prototype.return=function(pe){return this._index>=0&&(this._index=-1,this._keys=N,this._values=N),{value:pe,done:!0}},Ee}(),J=function(){function Ee(){this._keys=[],this._values=[],this._cacheKey=P,this._cacheIndex=-2}return Object.defineProperty(Ee.prototype,"size",{get:function(){return this._keys.length},enumerable:!0,configurable:!0}),Ee.prototype.has=function(pe){return this._find(pe,!1)>=0},Ee.prototype.get=function(pe){var be=this._find(pe,!1);return be>=0?this._values[be]:void 0},Ee.prototype.set=function(pe,be){var xe=this._find(pe,!0);return this._values[xe]=be,this},Ee.prototype.delete=function(pe){var be=this._find(pe,!1);if(be>=0){for(var xe=this._keys.length,Ce=be+1;Ce<xe;Ce++)this._keys[Ce-1]=this._keys[Ce],this._values[Ce-1]=this._values[Ce];return this._keys.length--,this._values.length--,pr(pe,this._cacheKey)&&(this._cacheKey=P,this._cacheIndex=-2),!0}return!1},Ee.prototype.clear=function(){this._keys.length=0,this._values.length=0,this._cacheKey=P,this._cacheIndex=-2},Ee.prototype.keys=function(){return new R(this._keys,this._values,he)},Ee.prototype.values=function(){return new R(this._keys,this._values,Oe)},Ee.prototype.entries=function(){return new R(this._keys,this._values,Fe)},Ee.prototype["@@iterator"]=function(){return this.entries()},Ee.prototype[o]=function(){return this.entries()},Ee.prototype._find=function(pe,be){if(!pr(this._cacheKey,pe)){this._cacheIndex=-1;for(var xe=0;xe<this._keys.length;xe++)if(pr(this._keys[xe],pe)){this._cacheIndex=xe;break}}return this._cacheIndex<0&&be&&(this._cacheIndex=this._keys.length,this._keys.push(pe),this._values.push(void 0)),this._cacheIndex},Ee}();return J;function he(Ee,pe){return Ee}function Oe(Ee,pe){return pe}function Fe(Ee,pe){return[Ee,pe]}}function S(){var P=function(){function N(){this._map=new p}return Object.defineProperty(N.prototype,"size",{get:function(){return this._map.size},enumerable:!0,configurable:!0}),N.prototype.has=function(R){return this._map.has(R)},N.prototype.add=function(R){return this._map.set(R,R),this},N.prototype.delete=function(R){return this._map.delete(R)},N.prototype.clear=function(){this._map.clear()},N.prototype.keys=function(){return this._map.keys()},N.prototype.values=function(){return this._map.keys()},N.prototype.entries=function(){return this._map.entries()},N.prototype["@@iterator"]=function(){return this.keys()},N.prototype[o]=function(){return this.keys()},N}();return P}function C(){var P=16,N=d.create(),R=J();return function(){function pe(){this._key=J()}return pe.prototype.has=function(be){var xe=he(be,!1);return xe!==void 0?d.has(xe,this._key):!1},pe.prototype.get=function(be){var xe=he(be,!1);return xe!==void 0?d.get(xe,this._key):void 0},pe.prototype.set=function(be,xe){var Ce=he(be,!0);return Ce[this._key]=xe,this},pe.prototype.delete=function(be){var xe=he(be,!1);return xe!==void 0?delete xe[this._key]:!1},pe.prototype.clear=function(){this._key=J()},pe}();function J(){var pe;do pe="@@WeakMap@@"+Ee();while(d.has(N,pe));return N[pe]=!0,pe}function he(pe,be){if(!n.call(pe,R)){if(!be)return;Object.defineProperty(pe,R,{value:d.create()})}return pe[R]}function Oe(pe,be){for(var xe=0;xe<be;++xe)pe[xe]=Math.random()*255|0;return pe}function Fe(pe){if(typeof Uint8Array=="function"){var be=new Uint8Array(pe);return typeof crypto<"u"?crypto.getRandomValues(be):typeof msCrypto<"u"?msCrypto.getRandomValues(be):Oe(be,pe),be}return Oe(new Array(pe),pe)}function Ee(){var pe=Fe(P);pe[6]=pe[6]&79|64,pe[8]=pe[8]&191|128;for(var be="",xe=0;xe<P;++xe){var Ce=pe[xe];(xe===4||xe===6||xe===8)&&(be+="-"),Ce<16&&(be+="0"),be+=Ce.toString(16).toLowerCase()}return be}}function M(P){return P.__=void 0,delete P.__,P}})})(UP||(UP={}));var X;(function(r){r[r.Sequence=0]="Sequence",r[r.Set=1]="Set",r[r.Choice=2]="Choice"})(X||(X={}));var F;(function(r){r[r.Any=1]="Any",r[r.Boolean=2]="Boolean",r[r.OctetString=3]="OctetString",r[r.BitString=4]="BitString",r[r.Integer=5]="Integer",r[r.Enumerated=6]="Enumerated",r[r.ObjectIdentifier=7]="ObjectIdentifier",r[r.Utf8String=8]="Utf8String",r[r.BmpString=9]="BmpString",r[r.UniversalString=10]="UniversalString",r[r.NumericString=11]="NumericString",r[r.PrintableString=12]="PrintableString",r[r.TeletexString=13]="TeletexString",r[r.VideotexString=14]="VideotexString",r[r.IA5String=15]="IA5String",r[r.GraphicString=16]="GraphicString",r[r.VisibleString=17]="VisibleString",r[r.GeneralString=18]="GeneralString",r[r.CharacterString=19]="CharacterString",r[r.UTCTime=20]="UTCTime",r[r.GeneralizedTime=21]="GeneralizedTime",r[r.DATE=22]="DATE",r[r.TimeOfDay=23]="TimeOfDay",r[r.DateTime=24]="DateTime",r[r.Duration=25]="Duration",r[r.TIME=26]="TIME",r[r.Null=27]="Null"})(F||(F={}));class c4{constructor(e,t=0){if(this.unusedBits=0,this.value=new ArrayBuffer(0),e)if(typeof e=="number")this.fromNumber(e);else if(de.isBufferSource(e))this.unusedBits=t,this.value=de.toArrayBuffer(e);else throw TypeError("Unsupported type of 'params' argument for BitString")}fromASN(e){if(!(e instanceof Rl))throw new TypeError("Argument 'asn' is not instance of ASN.1 BitString");return this.unusedBits=e.valueBlock.unusedBits,this.value=e.valueBlock.valueHex,this}toASN(){return new Rl({unusedBits:this.unusedBits,valueHex:this.value})}toSchema(e){return new Rl({name:e})}toNumber(){let e="";const t=new Uint8Array(this.value);for(const n of t)e+=n.toString(2).padStart(8,"0");return e=e.split("").reverse().join(""),this.unusedBits&&(e=e.slice(this.unusedBits).padStart(this.unusedBits,"0")),parseInt(e,2)}fromNumber(e){let t=e.toString(2);const n=t.length+7>>3;this.unusedBits=(n<<3)-t.length;const i=new Uint8Array(n);t=t.padStart(n<<3,"0").split("").reverse().join("");let s=0;for(;s<n;)i[s]=parseInt(t.slice(s<<3,(s<<3)+8),2),s++;this.value=i.buffer}}class et{get byteLength(){return this.buffer.byteLength}get byteOffset(){return 0}constructor(e){typeof e=="number"?this.buffer=new ArrayBuffer(e):de.isBufferSource(e)?this.buffer=de.toArrayBuffer(e):Array.isArray(e)?this.buffer=new Uint8Array(e):this.buffer=new ArrayBuffer(0)}fromASN(e){if(!(e instanceof ns))throw new TypeError("Argument 'asn' is not instance of ASN.1 OctetString");return this.buffer=e.valueBlock.valueHex,this}toASN(){return new ns({valueHex:this.buffer})}toSchema(e){return new ns({name:e})}}const gbe={fromASN:r=>r instanceof Ko?null:r.valueBeforeDecodeView,toASN:r=>{if(r===null)return new Ko;const e=$o(r);if(e.result.error)throw new Error(e.result.error);return e.result}},ybe={fromASN:r=>r.valueBlock.valueHexView.byteLength>=4?r.valueBlock.toString():r.valueBlock.valueDec,toASN:r=>new No({value:+r})},mbe={fromASN:r=>r.valueBlock.valueDec,toASN:r=>new Gw({value:r})},Dt={fromASN:r=>r.valueBlock.valueHexView,toASN:r=>new No({valueHex:r})},wbe={fromASN:r=>r.valueBlock.valueHexView,toASN:r=>new Rl({valueHex:r})},bbe={fromASN:r=>r.valueBlock.toString(),toASN:r=>new Co({value:r})},vbe={fromASN:r=>r.valueBlock.value,toASN:r=>new Ww({value:r})},km={fromASN:r=>r.valueBlock.valueHexView,toASN:r=>new ns({valueHex:r})},Ebe={fromASN:r=>new et(r.getValue()),toASN:r=>r.toASN()};function Li(r){return{fromASN:e=>e.valueBlock.value,toASN:e=>new r({value:e})}}const Aj=Li(aa),Sbe=Li(Qw),xbe=Li(Yw),Abe=Li(Jw),Cbe=Li(Xw),Ibe=Li(Zw),kbe=Li(e4),_be=Li(t4),Tbe=Li(r4),Pbe=Li(Jp),Dbe=Li(n4),$be=Li(i4),Nbe={fromASN:r=>r.toDate(),toASN:r=>new Xp({valueDate:r})},Mbe={fromASN:r=>r.toDate(),toASN:r=>new s4({valueDate:r})},Obe={fromASN:()=>null,toASN:()=>new Ko};function Yx(r){switch(r){case F.Any:return gbe;case F.BitString:return wbe;case F.BmpString:return Sbe;case F.Boolean:return vbe;case F.CharacterString:return $be;case F.Enumerated:return mbe;case F.GeneralString:return Dbe;case F.GeneralizedTime:return Mbe;case F.GraphicString:return Tbe;case F.IA5String:return _be;case F.Integer:return ybe;case F.Null:return Obe;case F.NumericString:return Abe;case F.ObjectIdentifier:return bbe;case F.OctetString:return km;case F.PrintableString:return Cbe;case F.TeletexString:return Ibe;case F.UTCTime:return Nbe;case F.UniversalString:return xbe;case F.Utf8String:return Aj;case F.VideotexString:return kbe;case F.VisibleString:return Pbe;default:return null}}function _o(r){return typeof r=="function"&&r.prototype?r.prototype.toASN&&r.prototype.fromASN?!0:_o(r.prototype):!!(r&&typeof r=="object"&&"toASN"in r&&"fromASN"in r)}function Cj(r){var e;if(r){const t=Object.getPrototypeOf(r);return((e=t==null?void 0:t.prototype)===null||e===void 0?void 0:e.constructor)===Array?!0:Cj(t)}return!1}function Rbe(r,e){if(!(r&&e)||r.byteLength!==e.byteLength)return!1;const t=new Uint8Array(r),n=new Uint8Array(e);for(let i=0;i<r.byteLength;i++)if(t[i]!==n[i])return!1;return!0}class Lbe{constructor(){this.items=new WeakMap}has(e){return this.items.has(e)}get(e,t=!1){const n=this.items.get(e);if(!n)throw new Error(`Cannot get schema for '${e.prototype.constructor.name}' target`);if(t&&!n.schema)throw new Error(`Schema '${e.prototype.constructor.name}' doesn't contain ASN.1 schema. Call 'AsnSchemaStorage.cache'.`);return n}cache(e){const t=this.get(e);t.schema||(t.schema=this.create(e,!0))}createDefault(e){const t={type:X.Sequence,items:{}},n=this.findParentSchema(e);return n&&(Object.assign(t,n),t.items=Object.assign({},t.items,n.items)),t}create(e,t){const n=this.items.get(e)||this.createDefault(e),i=[];for(const s in n.items){const o=n.items[s],a=t?s:"";let c;if(typeof o.type=="number"){const d=F[o.type],h=fj[d];if(!h)throw new Error(`Cannot get ASN1 class by name '${d}'`);c=new h({name:a})}else _o(o.type)?c=new o.type().toSchema(a):o.optional?this.get(o.type).type===X.Choice?c=new nu({name:a}):(c=this.create(o.type,!1),c.name=a):c=new nu({name:a});const l=!!o.optional||o.defaultValue!==void 0;if(o.repeated){c.name="";const d=o.repeated==="set"?Mo:lr;c=new d({name:"",value:[new Cm({name:a,value:c})]})}if(o.context!==null&&o.context!==void 0)if(o.implicit)if(typeof o.type=="number"||_o(o.type)){const d=o.repeated?$n:Yp;i.push(new d({name:a,optional:l,idBlock:{tagClass:3,tagNumber:o.context}}))}else{this.cache(o.type);const d=!!o.repeated;let h=d?c:this.get(o.type,!0).schema;h="valueBlock"in h?h.valueBlock.value:h.value,i.push(new $n({name:d?"":a,optional:l,idBlock:{tagClass:3,tagNumber:o.context},value:h}))}else i.push(new $n({optional:l,idBlock:{tagClass:3,tagNumber:o.context},value:[c]}));else c.optional=l,i.push(c)}switch(n.type){case X.Sequence:return new lr({value:i,name:""});case X.Set:return new Mo({value:i,name:""});case X.Choice:return new jx({value:i,name:""});default:throw new Error("Unsupported ASN1 type in use")}}set(e,t){return this.items.set(e,t),this}findParentSchema(e){const t=Object.getPrototypeOf(e);return t?this.items.get(t)||this.findParentSchema(t):null}}const Ii=new Lbe,te=r=>e=>{let t;Ii.has(e)?t=Ii.get(e):(t=Ii.createDefault(e),Ii.set(e,t)),Object.assign(t,r)},$=r=>(e,t)=>{let n;Ii.has(e.constructor)?n=Ii.get(e.constructor):(n=Ii.createDefault(e.constructor),Ii.set(e.constructor,n));const i=Object.assign({},r);if(typeof i.type=="number"&&!i.converter){const s=Yx(r.type);if(!s)throw new Error(`Cannot get default converter for property '${t}' of ${e.constructor.name}`);i.converter=s}n.items[t]=i};class FP extends Error{constructor(){super(...arguments),this.schemas=[]}}class Bbe{static parse(e,t){const n=$o(e);if(n.result.error)throw new Error(n.result.error);return this.fromASN(n.result,t)}static fromASN(e,t){var n;try{if(_o(t))return new t().fromASN(e);const i=Ii.get(t);Ii.cache(t);let s=i.schema;if(e.constructor===$n&&i.type!==X.Choice){s=new $n({idBlock:{tagClass:3,tagNumber:e.idBlock.tagNumber},value:i.schema.valueBlock.value});for(const c in i.items)delete e[c]}const o=bl({},e,s);if(!o.verified)throw new FP(`Data does not match to ${t.name} ASN1 schema. ${o.result.error}`);const a=new t;if(Cj(t)){if(!("value"in e.valueBlock&&Array.isArray(e.valueBlock.value)))throw new Error("Cannot get items from the ASN.1 parsed value. ASN.1 object is not constructed.");const c=i.itemType;if(typeof c=="number"){const l=Yx(c);if(!l)throw new Error(`Cannot get default converter for array item of ${t.name} ASN1 schema`);return t.from(e.valueBlock.value,d=>l.fromASN(d))}else return t.from(e.valueBlock.value,l=>this.fromASN(l,c))}for(const c in i.items){const l=o.result[c];if(!l)continue;const d=i.items[c],h=d.type;if(typeof h=="number"||_o(h)){const p=(n=d.converter)!==null&&n!==void 0?n:_o(h)?new h:null;if(!p)throw new Error("Converter is empty");if(d.repeated)if(d.implicit){const m=d.repeated==="sequence"?lr:Mo,f=new m;f.valueBlock=l.valueBlock;const g=$o(f.toBER(!1));if(g.offset===-1)throw new Error(`Cannot parse the child item. ${g.result.error}`);if(!("value"in g.result.valueBlock&&Array.isArray(g.result.valueBlock.value)))throw new Error("Cannot get items from the ASN.1 parsed value. ASN.1 object is not constructed.");const v=g.result.valueBlock.value;a[c]=Array.from(v,y=>p.fromASN(y))}else a[c]=Array.from(l,m=>p.fromASN(m));else{let m=l;if(d.implicit){let f;if(_o(h))f=new h().toSchema("");else{const g=F[h],v=fj[g];if(!v)throw new Error(`Cannot get '${g}' class from asn1js module`);f=new v}f.valueBlock=m.valueBlock,m=$o(f.toBER(!1)).result}a[c]=p.fromASN(m)}}else if(d.repeated){if(!Array.isArray(l))throw new Error("Cannot get list of items from the ASN.1 parsed value. ASN.1 value should be iterable.");a[c]=Array.from(l,p=>this.fromASN(p,h))}else a[c]=this.fromASN(l,h)}return a}catch(i){throw i instanceof FP&&i.schemas.push(t.name),i}}}class Jx{static serialize(e){return e instanceof Cr?e.toBER(!1):this.toASN(e).toBER(!1)}static toASN(e){if(e&&typeof e=="object"&&_o(e))return e.toASN();if(!(e&&typeof e=="object"))throw new TypeError("Parameter 1 should be type of Object.");const t=e.constructor,n=Ii.get(t);Ii.cache(t);let i=[];if(n.itemType){if(!Array.isArray(e))throw new TypeError("Parameter 1 should be type of Array.");if(typeof n.itemType=="number"){const o=Yx(n.itemType);if(!o)throw new Error(`Cannot get default converter for array item of ${t.name} ASN1 schema`);i=e.map(a=>o.toASN(a))}else i=e.map(o=>this.toAsnItem({type:n.itemType},"[]",t,o))}else for(const o in n.items){const a=n.items[o],c=e[o];if(c===void 0||a.defaultValue===c||typeof a.defaultValue=="object"&&typeof c=="object"&&Rbe(this.serialize(a.defaultValue),this.serialize(c)))continue;const l=Jx.toAsnItem(a,o,t,c);if(typeof a.context=="number")if(a.implicit)if(!a.repeated&&(typeof a.type=="number"||_o(a.type))){const d={};d.valueHex=l instanceof Ko?l.valueBeforeDecodeView:l.valueBlock.toBER(),i.push(new Yp({optional:a.optional,idBlock:{tagClass:3,tagNumber:a.context},...d}))}else i.push(new $n({optional:a.optional,idBlock:{tagClass:3,tagNumber:a.context},value:l.valueBlock.value}));else i.push(new $n({optional:a.optional,idBlock:{tagClass:3,tagNumber:a.context},value:[l]}));else a.repeated?i=i.concat(l):i.push(l)}let s;switch(n.type){case X.Sequence:s=new lr({value:i});break;case X.Set:s=new Mo({value:i});break;case X.Choice:if(!i[0])throw new Error(`Schema '${t.name}' has wrong data. Choice cannot be empty.`);s=i[0];break}return s}static toAsnItem(e,t,n,i){let s;if(typeof e.type=="number"){const o=e.converter;if(!o)throw new Error(`Property '${t}' doesn't have converter for type ${F[e.type]} in schema '${n.name}'`);if(e.repeated){if(!Array.isArray(i))throw new TypeError("Parameter 'objProp' should be type of Array.");const a=Array.from(i,l=>o.toASN(l)),c=e.repeated==="sequence"?lr:Mo;s=new c({value:a})}else s=o.toASN(i)}else if(e.repeated){if(!Array.isArray(i))throw new TypeError("Parameter 'objProp' should be type of Array.");const o=Array.from(i,c=>this.toASN(c)),a=e.repeated==="sequence"?lr:Mo;s=new a({value:o})}else s=this.toASN(i);return s}}class ut extends Array{constructor(e=[]){if(typeof e=="number")super(e);else{super();for(const t of e)this.push(t)}}}class ae{static serialize(e){return Jx.serialize(e)}static parse(e,t){return Bbe.parse(e,t)}static toString(e){const t=de.isBufferSource(e)?de.toArrayBuffer(e):ae.serialize(e),n=$o(t);if(n.offset===-1)throw new Error(`Cannot decode ASN.1 data. ${n.result.error}`);return n.result.toString()}}function _(r,e,t,n){var i=arguments.length,s=i<3?e:n===null?n=Object.getOwnPropertyDescriptor(e,t):n,o;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(r,e,t,n);else for(var a=r.length-1;a>=0;a--)(o=r[a])&&(s=(i<3?o(s):i>3?o(e,t,s):o(e,t))||s);return i>3&&s&&Object.defineProperty(e,t,s),s}class zP{static isIPv4(e){return/^(\d{1,3}\.){3}\d{1,3}$/.test(e)}static parseIPv4(e){const t=e.split(".");if(t.length!==4)throw new Error("Invalid IPv4 address");return t.map(n=>{const i=parseInt(n,10);if(isNaN(i)||i<0||i>255)throw new Error("Invalid IPv4 address part");return i})}static parseIPv6(e){const n=this.expandIPv6(e).split(":");if(n.length!==8)throw new Error("Invalid IPv6 address");return n.reduce((i,s)=>{const o=parseInt(s,16);if(isNaN(o)||o<0||o>65535)throw new Error("Invalid IPv6 address part");return i.push(o>>8&255),i.push(o&255),i},[])}static expandIPv6(e){if(!e.includes("::"))return e;const t=e.split("::");if(t.length>2)throw new Error("Invalid IPv6 address");const n=t[0]?t[0].split(":"):[],i=t[1]?t[1].split(":"):[],s=8-(n.length+i.length);if(s<0)throw new Error("Invalid IPv6 address");return[...n,...Array(s).fill("0"),...i].join(":")}static formatIPv6(e){const t=[];for(let n=0;n<16;n+=2)t.push((e[n]<<8|e[n+1]).toString(16));return this.compressIPv6(t.join(":"))}static compressIPv6(e){const t=e.split(":");let n=-1,i=0,s=-1,o=0;for(let a=0;a<t.length;a++)t[a]==="0"?(s===-1&&(s=a),o++):(o>i&&(n=s,i=o),s=-1,o=0);if(o>i&&(n=s,i=o),i>1){const a=t.slice(0,n).join(":"),c=t.slice(n+i).join(":");return`${a}::${c}`}return e}static parseCIDR(e){const[t,n]=e.split("/"),i=parseInt(n,10);if(this.isIPv4(t)){if(i<0||i>32)throw new Error("Invalid IPv4 prefix length");return[this.parseIPv4(t),i]}else{if(i<0||i>128)throw new Error("Invalid IPv6 prefix length");return[this.parseIPv6(t),i]}}static decodeIP(e){if(e.length===64&&parseInt(e,16)===0)return"::/0";if(e.length!==16)return e;const t=parseInt(e.slice(8),16).toString(2).split("").reduce((i,s)=>i+ +s,0);let n=e.slice(0,8).replace(/(.{2})/g,i=>`${parseInt(i,16)}.`);return n=n.slice(0,-1),`${n}/${t}`}static toString(e){const t=new Uint8Array(e);if(t.length===4)return Array.from(t).join(".");if(t.length===16)return this.formatIPv6(t);if(t.length===8||t.length===32){const n=t.length/2,i=t.slice(0,n),s=t.slice(n);if(t.every(c=>c===0))return t.length===8?"0.0.0.0/0":"::/0";const a=s.reduce((c,l)=>c+(l.toString(2).match(/1/g)||[]).length,0);return t.length===8?`${Array.from(i).join(".")}/${a}`:`${this.formatIPv6(i)}/${a}`}return this.decodeIP(Se.ToHex(e))}static fromString(e){if(e.includes("/")){const[n,i]=this.parseCIDR(e),s=new Uint8Array(n.length);let o=i;for(let c=0;c<s.length;c++)o>=8?(s[c]=255,o-=8):o>0&&(s[c]=255<<8-o,o=0);const a=new Uint8Array(n.length*2);return a.set(n,0),a.set(s,n.length),a.buffer}const t=this.isIPv4(e)?this.parseIPv4(e):this.parseIPv6(e);return new Uint8Array(t).buffer}}var n7,i7,s7;let Ir=class{constructor(e={}){Object.assign(this,e)}toString(){return this.bmpString||this.printableString||this.teletexString||this.universalString||this.utf8String||""}};_([$({type:F.TeletexString})],Ir.prototype,"teletexString",void 0);_([$({type:F.PrintableString})],Ir.prototype,"printableString",void 0);_([$({type:F.UniversalString})],Ir.prototype,"universalString",void 0);_([$({type:F.Utf8String})],Ir.prototype,"utf8String",void 0);_([$({type:F.BmpString})],Ir.prototype,"bmpString",void 0);Ir=_([te({type:X.Choice})],Ir);let fh=class extends Ir{constructor(e={}){super(e),Object.assign(this,e)}toString(){return this.ia5String||(this.anyValue?Se.ToHex(this.anyValue):super.toString())}};_([$({type:F.IA5String})],fh.prototype,"ia5String",void 0);_([$({type:F.Any})],fh.prototype,"anyValue",void 0);fh=_([te({type:X.Choice})],fh);class l4{constructor(e={}){this.type="",this.value=new fh,Object.assign(this,e)}}_([$({type:F.ObjectIdentifier})],l4.prototype,"type",void 0);_([$({type:fh})],l4.prototype,"value",void 0);let ph=n7=class extends ut{constructor(e){super(e),Object.setPrototypeOf(this,n7.prototype)}};ph=n7=_([te({type:X.Set,itemType:l4})],ph);let o7=i7=class extends ut{constructor(e){super(e),Object.setPrototypeOf(this,i7.prototype)}};o7=i7=_([te({type:X.Sequence,itemType:ph})],o7);let Wt=s7=class extends o7{constructor(e){super(e),Object.setPrototypeOf(this,s7.prototype)}};Wt=s7=_([te({type:X.Sequence})],Wt);const Ube={fromASN:r=>zP.toString(km.fromASN(r)),toASN:r=>km.toASN(zP.fromString(r))};class ap{constructor(e={}){this.typeId="",this.value=new ArrayBuffer(0),Object.assign(this,e)}}_([$({type:F.ObjectIdentifier})],ap.prototype,"typeId",void 0);_([$({type:F.Any,context:0})],ap.prototype,"value",void 0);class Xx{constructor(e={}){this.partyName=new Ir,Object.assign(this,e)}}_([$({type:Ir,optional:!0,context:0,implicit:!0})],Xx.prototype,"nameAssigner",void 0);_([$({type:Ir,context:1,implicit:!0})],Xx.prototype,"partyName",void 0);let Be=class{constructor(e={}){Object.assign(this,e)}};_([$({type:ap,context:0,implicit:!0})],Be.prototype,"otherName",void 0);_([$({type:F.IA5String,context:1,implicit:!0})],Be.prototype,"rfc822Name",void 0);_([$({type:F.IA5String,context:2,implicit:!0})],Be.prototype,"dNSName",void 0);_([$({type:F.Any,context:3,implicit:!0})],Be.prototype,"x400Address",void 0);_([$({type:Wt,context:4,implicit:!1})],Be.prototype,"directoryName",void 0);_([$({type:Xx,context:5})],Be.prototype,"ediPartyName",void 0);_([$({type:F.IA5String,context:6,implicit:!0})],Be.prototype,"uniformResourceIdentifier",void 0);_([$({type:F.OctetString,context:7,implicit:!0,converter:Ube})],Be.prototype,"iPAddress",void 0);_([$({type:F.ObjectIdentifier,context:8,implicit:!0})],Be.prototype,"registeredID",void 0);Be=_([te({type:X.Choice})],Be);const Zx="1.3.6.1.5.5.7",Fbe=`${Zx}.1`,zh=`${Zx}.3`,u4=`${Zx}.48`,VP=`${u4}.1`,KP=`${u4}.2`,jP=`${u4}.3`,HP=`${u4}.5`,Vc="2.5.29";var a7;const c7=`${Fbe}.1`;class e0{constructor(e={}){this.accessMethod="",this.accessLocation=new Be,Object.assign(this,e)}}_([$({type:F.ObjectIdentifier})],e0.prototype,"accessMethod",void 0);_([$({type:Be})],e0.prototype,"accessLocation",void 0);let id=a7=class extends ut{constructor(e){super(e),Object.setPrototypeOf(this,a7.prototype)}};id=a7=_([te({type:X.Sequence,itemType:e0})],id);const l7=`${Vc}.35`;class eA extends et{}class vl{constructor(e={}){e&&Object.assign(this,e)}}_([$({type:eA,context:0,optional:!0,implicit:!0})],vl.prototype,"keyIdentifier",void 0);_([$({type:Be,context:1,optional:!0,implicit:!0,repeated:"sequence"})],vl.prototype,"authorityCertIssuer",void 0);_([$({type:F.Integer,context:2,optional:!0,implicit:!0,converter:Dt})],vl.prototype,"authorityCertSerialNumber",void 0);const Ij=`${Vc}.19`;class _m{constructor(e={}){this.cA=!1,Object.assign(this,e)}}_([$({type:F.Boolean,defaultValue:!1})],_m.prototype,"cA",void 0);_([$({type:F.Integer,optional:!0})],_m.prototype,"pathLenConstraint",void 0);var u7;let dn=u7=class extends ut{constructor(e){super(e),Object.setPrototypeOf(this,u7.prototype)}};dn=u7=_([te({type:X.Sequence,itemType:Be})],dn);var d7;let qP=d7=class extends dn{constructor(e){super(e),Object.setPrototypeOf(this,d7.prototype)}};qP=d7=_([te({type:X.Sequence})],qP);var h7;const kj=`${Vc}.32`;let jo=class{constructor(e={}){Object.assign(this,e)}toString(){return this.ia5String||this.visibleString||this.bmpString||this.utf8String||""}};_([$({type:F.IA5String})],jo.prototype,"ia5String",void 0);_([$({type:F.VisibleString})],jo.prototype,"visibleString",void 0);_([$({type:F.BmpString})],jo.prototype,"bmpString",void 0);_([$({type:F.Utf8String})],jo.prototype,"utf8String",void 0);jo=_([te({type:X.Choice})],jo);class tA{constructor(e={}){this.organization=new jo,this.noticeNumbers=[],Object.assign(this,e)}}_([$({type:jo})],tA.prototype,"organization",void 0);_([$({type:F.Integer,repeated:"sequence"})],tA.prototype,"noticeNumbers",void 0);class rA{constructor(e={}){Object.assign(this,e)}}_([$({type:tA,optional:!0})],rA.prototype,"noticeRef",void 0);_([$({type:jo,optional:!0})],rA.prototype,"explicitText",void 0);let Tm=class{constructor(e={}){Object.assign(this,e)}};_([$({type:F.IA5String})],Tm.prototype,"cPSuri",void 0);_([$({type:rA})],Tm.prototype,"userNotice",void 0);Tm=_([te({type:X.Choice})],Tm);class nA{constructor(e={}){this.policyQualifierId="",this.qualifier=new ArrayBuffer(0),Object.assign(this,e)}}_([$({type:F.ObjectIdentifier})],nA.prototype,"policyQualifierId",void 0);_([$({type:F.Any})],nA.prototype,"qualifier",void 0);class d4{constructor(e={}){this.policyIdentifier="",Object.assign(this,e)}}_([$({type:F.ObjectIdentifier})],d4.prototype,"policyIdentifier",void 0);_([$({type:nA,repeated:"sequence",optional:!0})],d4.prototype,"policyQualifiers",void 0);let Pm=h7=class extends ut{constructor(e){super(e),Object.setPrototypeOf(this,h7.prototype)}};Pm=h7=_([te({type:X.Sequence,itemType:d4})],Pm);let Dm=class{constructor(e=0){this.value=e}};_([$({type:F.Integer})],Dm.prototype,"value",void 0);Dm=_([te({type:X.Choice})],Dm);let WP=class extends Dm{};WP=_([te({type:X.Choice})],WP);var f7;const p7=`${Vc}.31`;var Qi;(function(r){r[r.unused=1]="unused",r[r.keyCompromise=2]="keyCompromise",r[r.cACompromise=4]="cACompromise",r[r.affiliationChanged=8]="affiliationChanged",r[r.superseded=16]="superseded",r[r.cessationOfOperation=32]="cessationOfOperation",r[r.certificateHold=64]="certificateHold",r[r.privilegeWithdrawn=128]="privilegeWithdrawn",r[r.aACompromise=256]="aACompromise"})(Qi||(Qi={}));class _j extends c4{toJSON(){const e=[],t=this.toNumber();return t&Qi.aACompromise&&e.push("aACompromise"),t&Qi.affiliationChanged&&e.push("affiliationChanged"),t&Qi.cACompromise&&e.push("cACompromise"),t&Qi.certificateHold&&e.push("certificateHold"),t&Qi.cessationOfOperation&&e.push("cessationOfOperation"),t&Qi.keyCompromise&&e.push("keyCompromise"),t&Qi.privilegeWithdrawn&&e.push("privilegeWithdrawn"),t&Qi.superseded&&e.push("superseded"),t&Qi.unused&&e.push("unused"),e}toString(){return`[${this.toJSON().join(", ")}]`}}let iu=class{constructor(e={}){Object.assign(this,e)}};_([$({type:Be,context:0,repeated:"sequence",implicit:!0})],iu.prototype,"fullName",void 0);_([$({type:ph,context:1,implicit:!0})],iu.prototype,"nameRelativeToCRLIssuer",void 0);iu=_([te({type:X.Choice})],iu);class Vh{constructor(e={}){Object.assign(this,e)}}_([$({type:iu,context:0,optional:!0})],Vh.prototype,"distributionPoint",void 0);_([$({type:_j,context:1,optional:!0,implicit:!0})],Vh.prototype,"reasons",void 0);_([$({type:Be,context:2,optional:!0,repeated:"sequence",implicit:!0})],Vh.prototype,"cRLIssuer",void 0);let xd=f7=class extends ut{constructor(e){super(e),Object.setPrototypeOf(this,f7.prototype)}};xd=f7=_([te({type:X.Sequence,itemType:Vh})],xd);var g7;let GP=g7=class extends xd{constructor(e){super(e),Object.setPrototypeOf(this,g7.prototype)}};GP=g7=_([te({type:X.Sequence,itemType:Vh})],GP);class Zr{constructor(e={}){this.onlyContainsUserCerts=Zr.ONLY,this.onlyContainsCACerts=Zr.ONLY,this.indirectCRL=Zr.ONLY,this.onlyContainsAttributeCerts=Zr.ONLY,Object.assign(this,e)}}Zr.ONLY=!1;_([$({type:iu,context:0,optional:!0})],Zr.prototype,"distributionPoint",void 0);_([$({type:F.Boolean,context:1,defaultValue:Zr.ONLY,implicit:!0})],Zr.prototype,"onlyContainsUserCerts",void 0);_([$({type:F.Boolean,context:2,defaultValue:Zr.ONLY,implicit:!0})],Zr.prototype,"onlyContainsCACerts",void 0);_([$({type:_j,context:3,optional:!0,implicit:!0})],Zr.prototype,"onlySomeReasons",void 0);_([$({type:F.Boolean,context:4,defaultValue:Zr.ONLY,implicit:!0})],Zr.prototype,"indirectCRL",void 0);_([$({type:F.Boolean,context:5,defaultValue:Zr.ONLY,implicit:!0})],Zr.prototype,"onlyContainsAttributeCerts",void 0);var f1;(function(r){r[r.unspecified=0]="unspecified",r[r.keyCompromise=1]="keyCompromise",r[r.cACompromise=2]="cACompromise",r[r.affiliationChanged=3]="affiliationChanged",r[r.superseded=4]="superseded",r[r.cessationOfOperation=5]="cessationOfOperation",r[r.certificateHold=6]="certificateHold",r[r.removeFromCRL=8]="removeFromCRL",r[r.privilegeWithdrawn=9]="privilegeWithdrawn",r[r.aACompromise=10]="aACompromise"})(f1||(f1={}));let y7=class{constructor(e=f1.unspecified){this.reason=f1.unspecified,this.reason=e}toJSON(){return f1[this.reason]}toString(){return this.toJSON()}};_([$({type:F.Enumerated})],y7.prototype,"reason",void 0);y7=_([te({type:X.Choice})],y7);var m7;const Tj=`${Vc}.37`;let $m=m7=class extends ut{constructor(e){super(e),Object.setPrototypeOf(this,m7.prototype)}};$m=m7=_([te({type:X.Sequence,itemType:F.ObjectIdentifier})],$m);const zbe=`${zh}.1`,Vbe=`${zh}.2`,Kbe=`${zh}.3`,jbe=`${zh}.4`,Hbe=`${zh}.8`,qbe=`${zh}.9`;let w7=class{constructor(e=new ArrayBuffer(0)){this.value=e}};_([$({type:F.Integer,converter:Dt})],w7.prototype,"value",void 0);w7=_([te({type:X.Choice})],w7);let b7=class{constructor(e){this.value=new Date,e&&(this.value=e)}};_([$({type:F.GeneralizedTime})],b7.prototype,"value",void 0);b7=_([te({type:X.Choice})],b7);var v7;let QP=v7=class extends dn{constructor(e){super(e),Object.setPrototypeOf(this,v7.prototype)}};QP=v7=_([te({type:X.Sequence})],QP);const Pj=`${Vc}.15`;var Yi;(function(r){r[r.digitalSignature=1]="digitalSignature",r[r.nonRepudiation=2]="nonRepudiation",r[r.keyEncipherment=4]="keyEncipherment",r[r.dataEncipherment=8]="dataEncipherment",r[r.keyAgreement=16]="keyAgreement",r[r.keyCertSign=32]="keyCertSign",r[r.cRLSign=64]="cRLSign",r[r.encipherOnly=128]="encipherOnly",r[r.decipherOnly=256]="decipherOnly"})(Yi||(Yi={}));class k8 extends c4{toJSON(){const e=this.toNumber(),t=[];return e&Yi.cRLSign&&t.push("crlSign"),e&Yi.dataEncipherment&&t.push("dataEncipherment"),e&Yi.decipherOnly&&t.push("decipherOnly"),e&Yi.digitalSignature&&t.push("digitalSignature"),e&Yi.encipherOnly&&t.push("encipherOnly"),e&Yi.keyAgreement&&t.push("keyAgreement"),e&Yi.keyCertSign&&t.push("keyCertSign"),e&Yi.keyEncipherment&&t.push("keyEncipherment"),e&Yi.nonRepudiation&&t.push("nonRepudiation"),t}toString(){return`[${this.toJSON().join(", ")}]`}}var E7;class h4{constructor(e={}){this.base=new Be,this.minimum=0,Object.assign(this,e)}}_([$({type:Be})],h4.prototype,"base",void 0);_([$({type:F.Integer,context:0,defaultValue:0,implicit:!0})],h4.prototype,"minimum",void 0);_([$({type:F.Integer,context:1,optional:!0,implicit:!0})],h4.prototype,"maximum",void 0);let Nm=E7=class extends ut{constructor(e){super(e),Object.setPrototypeOf(this,E7.prototype)}};Nm=E7=_([te({type:X.Sequence,itemType:h4})],Nm);class Dj{constructor(e={}){Object.assign(this,e)}}_([$({type:Nm,context:0,optional:!0,implicit:!0})],Dj.prototype,"permittedSubtrees",void 0);_([$({type:Nm,context:1,optional:!0,implicit:!0})],Dj.prototype,"excludedSubtrees",void 0);class $j{constructor(e={}){Object.assign(this,e)}}_([$({type:F.Integer,context:0,implicit:!0,optional:!0,converter:Dt})],$j.prototype,"requireExplicitPolicy",void 0);_([$({type:F.Integer,context:1,implicit:!0,optional:!0,converter:Dt})],$j.prototype,"inhibitPolicyMapping",void 0);var S7;class iA{constructor(e={}){this.issuerDomainPolicy="",this.subjectDomainPolicy="",Object.assign(this,e)}}_([$({type:F.ObjectIdentifier})],iA.prototype,"issuerDomainPolicy",void 0);_([$({type:F.ObjectIdentifier})],iA.prototype,"subjectDomainPolicy",void 0);let YP=S7=class extends ut{constructor(e){super(e),Object.setPrototypeOf(this,S7.prototype)}};YP=S7=_([te({type:X.Sequence,itemType:iA})],YP);var x7;const Nj=`${Vc}.17`;let A7=x7=class extends dn{constructor(e){super(e),Object.setPrototypeOf(this,x7.prototype)}};A7=x7=_([te({type:X.Sequence})],A7);let Ho=class{constructor(e={}){this.type="",this.values=[],Object.assign(this,e)}};_([$({type:F.ObjectIdentifier})],Ho.prototype,"type",void 0);_([$({type:F.Any,repeated:"set"})],Ho.prototype,"values",void 0);var C7;let JP=C7=class extends ut{constructor(e){super(e),Object.setPrototypeOf(this,C7.prototype)}};JP=C7=_([te({type:X.Sequence,itemType:Ho})],JP);const Mj=`${Vc}.14`;class gc extends eA{}class Oj{constructor(e={}){Object.assign(this,e)}}_([$({type:F.GeneralizedTime,context:0,implicit:!0,optional:!0})],Oj.prototype,"notBefore",void 0);_([$({type:F.GeneralizedTime,context:1,implicit:!0,optional:!0})],Oj.prototype,"notAfter",void 0);var p1;(function(r){r[r.keyUpdateAllowed=1]="keyUpdateAllowed",r[r.newExtensions=2]="newExtensions",r[r.pKIXCertificate=4]="pKIXCertificate"})(p1||(p1={}));class Rj extends c4{toJSON(){const e=[],t=this.toNumber();return t&p1.pKIXCertificate&&e.push("pKIXCertificate"),t&p1.newExtensions&&e.push("newExtensions"),t&p1.keyUpdateAllowed&&e.push("keyUpdateAllowed"),e}toString(){return`[${this.toJSON().join(", ")}]`}}class Lj{constructor(e={}){this.entrustVers="",this.entrustInfoFlags=new Rj,Object.assign(this,e)}}_([$({type:F.GeneralString})],Lj.prototype,"entrustVers",void 0);_([$({type:Rj})],Lj.prototype,"entrustInfoFlags",void 0);var I7;let XP=I7=class extends ut{constructor(e){super(e),Object.setPrototypeOf(this,I7.prototype)}};XP=I7=_([te({type:X.Sequence,itemType:e0})],XP);class me{constructor(e={}){this.algorithm="",Object.assign(this,e)}isEqual(e){return e instanceof me&&e.algorithm==this.algorithm&&(e.parameters&&this.parameters&&mK(e.parameters,this.parameters)||e.parameters===this.parameters)}}_([$({type:F.ObjectIdentifier})],me.prototype,"algorithm",void 0);_([$({type:F.Any,optional:!0})],me.prototype,"parameters",void 0);class ss{constructor(e={}){this.algorithm=new me,this.subjectPublicKey=new ArrayBuffer(0),Object.assign(this,e)}}_([$({type:me})],ss.prototype,"algorithm",void 0);_([$({type:F.BitString})],ss.prototype,"subjectPublicKey",void 0);let Er=class{constructor(e){if(e)if(typeof e=="string"||typeof e=="number"||e instanceof Date){const t=new Date(e);t.getUTCFullYear()>2049?this.generalTime=t:this.utcTime=t}else Object.assign(this,e)}getTime(){const e=this.utcTime||this.generalTime;if(!e)throw new Error("Cannot get time from CHOICE object");return e}};_([$({type:F.UTCTime})],Er.prototype,"utcTime",void 0);_([$({type:F.GeneralizedTime})],Er.prototype,"generalTime",void 0);Er=_([te({type:X.Choice})],Er);class t0{constructor(e){this.notBefore=new Er(new Date),this.notAfter=new Er(new Date),e&&(this.notBefore=new Er(e.notBefore),this.notAfter=new Er(e.notAfter))}}_([$({type:Er})],t0.prototype,"notBefore",void 0);_([$({type:Er})],t0.prototype,"notAfter",void 0);var k7;let Mi=class Bj{constructor(e={}){this.extnID="",this.critical=Bj.CRITICAL,this.extnValue=new et,Object.assign(this,e)}};Mi.CRITICAL=!1;_([$({type:F.ObjectIdentifier})],Mi.prototype,"extnID",void 0);_([$({type:F.Boolean,defaultValue:Mi.CRITICAL})],Mi.prototype,"critical",void 0);_([$({type:et})],Mi.prototype,"extnValue",void 0);let Pc=k7=class extends ut{constructor(e){super(e),Object.setPrototypeOf(this,k7.prototype)}};Pc=k7=_([te({type:X.Sequence,itemType:Mi})],Pc);var su;(function(r){r[r.v1=0]="v1",r[r.v2=1]="v2",r[r.v3=2]="v3"})(su||(su={}));class di{constructor(e={}){this.version=su.v1,this.serialNumber=new ArrayBuffer(0),this.signature=new me,this.issuer=new Wt,this.validity=new t0,this.subject=new Wt,this.subjectPublicKeyInfo=new ss,Object.assign(this,e)}}_([$({type:F.Integer,context:0,defaultValue:su.v1})],di.prototype,"version",void 0);_([$({type:F.Integer,converter:Dt})],di.prototype,"serialNumber",void 0);_([$({type:me})],di.prototype,"signature",void 0);_([$({type:Wt})],di.prototype,"issuer",void 0);_([$({type:t0})],di.prototype,"validity",void 0);_([$({type:Wt})],di.prototype,"subject",void 0);_([$({type:ss})],di.prototype,"subjectPublicKeyInfo",void 0);_([$({type:F.BitString,context:1,implicit:!0,optional:!0})],di.prototype,"issuerUniqueID",void 0);_([$({type:F.BitString,context:2,implicit:!0,optional:!0})],di.prototype,"subjectUniqueID",void 0);_([$({type:Pc,context:3,optional:!0})],di.prototype,"extensions",void 0);class ou{constructor(e={}){this.tbsCertificate=new di,this.signatureAlgorithm=new me,this.signatureValue=new ArrayBuffer(0),Object.assign(this,e)}}_([$({type:di})],ou.prototype,"tbsCertificate",void 0);_([$({type:me})],ou.prototype,"signatureAlgorithm",void 0);_([$({type:F.BitString})],ou.prototype,"signatureValue",void 0);class f4{constructor(e={}){this.userCertificate=new ArrayBuffer(0),this.revocationDate=new Er,Object.assign(this,e)}}_([$({type:F.Integer,converter:Dt})],f4.prototype,"userCertificate",void 0);_([$({type:Er})],f4.prototype,"revocationDate",void 0);_([$({type:Mi,optional:!0,repeated:"sequence"})],f4.prototype,"crlEntryExtensions",void 0);class ca{constructor(e={}){this.signature=new me,this.issuer=new Wt,this.thisUpdate=new Er,Object.assign(this,e)}}_([$({type:F.Integer,optional:!0})],ca.prototype,"version",void 0);_([$({type:me})],ca.prototype,"signature",void 0);_([$({type:Wt})],ca.prototype,"issuer",void 0);_([$({type:Er})],ca.prototype,"thisUpdate",void 0);_([$({type:Er,optional:!0})],ca.prototype,"nextUpdate",void 0);_([$({type:f4,repeated:"sequence",optional:!0})],ca.prototype,"revokedCertificates",void 0);_([$({type:Mi,optional:!0,context:0,repeated:"sequence"})],ca.prototype,"crlExtensions",void 0);class sA{constructor(e={}){this.tbsCertList=new ca,this.signatureAlgorithm=new me,this.signature=new ArrayBuffer(0),Object.assign(this,e)}}_([$({type:ca})],sA.prototype,"tbsCertList",void 0);_([$({type:me})],sA.prototype,"signatureAlgorithm",void 0);_([$({type:F.BitString})],sA.prototype,"signature",void 0);class Kh{constructor(e={}){this.issuer=new Wt,this.serialNumber=new ArrayBuffer(0),Object.assign(this,e)}}_([$({type:Wt})],Kh.prototype,"issuer",void 0);_([$({type:F.Integer,converter:Dt})],Kh.prototype,"serialNumber",void 0);let gh=class{constructor(e={}){Object.assign(this,e)}};_([$({type:gc,context:0,implicit:!0})],gh.prototype,"subjectKeyIdentifier",void 0);_([$({type:Kh})],gh.prototype,"issuerAndSerialNumber",void 0);gh=_([te({type:X.Choice})],gh);var qo;(function(r){r[r.v0=0]="v0",r[r.v1=1]="v1",r[r.v2=2]="v2",r[r.v3=3]="v3",r[r.v4=4]="v4",r[r.v5=5]="v5"})(qo||(qo={}));let cp=class extends me{};cp=_([te({type:X.Sequence})],cp);let Mm=class extends me{};Mm=_([te({type:X.Sequence})],Mm);let Gs=class extends me{};Gs=_([te({type:X.Sequence})],Gs);let Om=class extends me{};Om=_([te({type:X.Sequence})],Om);let ZP=class extends me{};ZP=_([te({type:X.Sequence})],ZP);let _7=class extends me{};_7=_([te({type:X.Sequence})],_7);let jh=class{constructor(e={}){this.attrType="",this.attrValues=[],Object.assign(this,e)}};_([$({type:F.ObjectIdentifier})],jh.prototype,"attrType",void 0);_([$({type:F.Any,repeated:"set"})],jh.prototype,"attrValues",void 0);var T7;class Zs{constructor(e={}){this.version=qo.v0,this.sid=new gh,this.digestAlgorithm=new cp,this.signatureAlgorithm=new Mm,this.signature=new et,Object.assign(this,e)}}_([$({type:F.Integer})],Zs.prototype,"version",void 0);_([$({type:gh})],Zs.prototype,"sid",void 0);_([$({type:cp})],Zs.prototype,"digestAlgorithm",void 0);_([$({type:jh,repeated:"set",context:0,implicit:!0,optional:!0})],Zs.prototype,"signedAttrs",void 0);_([$({type:Mm})],Zs.prototype,"signatureAlgorithm",void 0);_([$({type:et})],Zs.prototype,"signature",void 0);_([$({type:jh,repeated:"set",context:1,implicit:!0,optional:!0})],Zs.prototype,"unsignedAttrs",void 0);let Rm=T7=class extends ut{constructor(e){super(e),Object.setPrototypeOf(this,T7.prototype)}};Rm=T7=_([te({type:X.Set,itemType:Zs})],Rm);let eD=class extends Er{};eD=_([te({type:X.Choice})],eD);let tD=class extends Zs{};tD=_([te({type:X.Sequence})],tD);class oA{constructor(e={}){this.acIssuer=new Be,this.acSerial=0,this.attrs=[],Object.assign(this,e)}}_([$({type:Be})],oA.prototype,"acIssuer",void 0);_([$({type:F.Integer})],oA.prototype,"acSerial",void 0);_([$({type:Ho,repeated:"sequence"})],oA.prototype,"attrs",void 0);var P7;let Lm=P7=class extends ut{constructor(e){super(e),Object.setPrototypeOf(this,P7.prototype)}};Lm=P7=_([te({type:X.Sequence,itemType:F.ObjectIdentifier})],Lm);class p4{constructor(e={}){this.permitUnSpecified=!0,Object.assign(this,e)}}_([$({type:F.Integer,optional:!0})],p4.prototype,"pathLenConstraint",void 0);_([$({type:Lm,implicit:!0,context:0,optional:!0})],p4.prototype,"permittedAttrs",void 0);_([$({type:Lm,implicit:!0,context:1,optional:!0})],p4.prototype,"excludedAttrs",void 0);_([$({type:F.Boolean,defaultValue:!0})],p4.prototype,"permitUnSpecified",void 0);class Au{constructor(e={}){this.issuer=new dn,this.serial=new ArrayBuffer(0),this.issuerUID=new ArrayBuffer(0),Object.assign(this,e)}}_([$({type:dn})],Au.prototype,"issuer",void 0);_([$({type:F.Integer,converter:Dt})],Au.prototype,"serial",void 0);_([$({type:F.BitString,optional:!0})],Au.prototype,"issuerUID",void 0);var D7;(function(r){r[r.publicKey=0]="publicKey",r[r.publicKeyCert=1]="publicKeyCert",r[r.otherObjectTypes=2]="otherObjectTypes"})(D7||(D7={}));class Cu{constructor(e={}){this.digestedObjectType=D7.publicKey,this.digestAlgorithm=new me,this.objectDigest=new ArrayBuffer(0),Object.assign(this,e)}}_([$({type:F.Enumerated})],Cu.prototype,"digestedObjectType",void 0);_([$({type:F.ObjectIdentifier,optional:!0})],Cu.prototype,"otherObjectTypeID",void 0);_([$({type:me})],Cu.prototype,"digestAlgorithm",void 0);_([$({type:F.BitString})],Cu.prototype,"objectDigest",void 0);class g4{constructor(e={}){Object.assign(this,e)}}_([$({type:dn,optional:!0})],g4.prototype,"issuerName",void 0);_([$({type:Au,context:0,implicit:!0,optional:!0})],g4.prototype,"baseCertificateID",void 0);_([$({type:Cu,context:1,implicit:!0,optional:!0})],g4.prototype,"objectDigestInfo",void 0);let yh=class{constructor(e={}){Object.assign(this,e)}};_([$({type:Be,repeated:"sequence"})],yh.prototype,"v1Form",void 0);_([$({type:g4,context:0,implicit:!0})],yh.prototype,"v2Form",void 0);yh=_([te({type:X.Choice})],yh);class y4{constructor(e={}){this.notBeforeTime=new Date,this.notAfterTime=new Date,Object.assign(this,e)}}_([$({type:F.GeneralizedTime})],y4.prototype,"notBeforeTime",void 0);_([$({type:F.GeneralizedTime})],y4.prototype,"notAfterTime",void 0);class r0{constructor(e={}){Object.assign(this,e)}}_([$({type:Au,implicit:!0,context:0,optional:!0})],r0.prototype,"baseCertificateID",void 0);_([$({type:dn,implicit:!0,context:1,optional:!0})],r0.prototype,"entityName",void 0);_([$({type:Cu,implicit:!0,context:2,optional:!0})],r0.prototype,"objectDigestInfo",void 0);var $7;(function(r){r[r.v2=1]="v2"})($7||($7={}));class ms{constructor(e={}){this.version=$7.v2,this.holder=new r0,this.issuer=new yh,this.signature=new me,this.serialNumber=new ArrayBuffer(0),this.attrCertValidityPeriod=new y4,this.attributes=[],Object.assign(this,e)}}_([$({type:F.Integer})],ms.prototype,"version",void 0);_([$({type:r0})],ms.prototype,"holder",void 0);_([$({type:yh})],ms.prototype,"issuer",void 0);_([$({type:me})],ms.prototype,"signature",void 0);_([$({type:F.Integer,converter:Dt})],ms.prototype,"serialNumber",void 0);_([$({type:y4})],ms.prototype,"attrCertValidityPeriod",void 0);_([$({type:Ho,repeated:"sequence"})],ms.prototype,"attributes",void 0);_([$({type:F.BitString,optional:!0})],ms.prototype,"issuerUniqueID",void 0);_([$({type:Pc,optional:!0})],ms.prototype,"extensions",void 0);class m4{constructor(e={}){this.acinfo=new ms,this.signatureAlgorithm=new me,this.signatureValue=new ArrayBuffer(0),Object.assign(this,e)}}_([$({type:ms})],m4.prototype,"acinfo",void 0);_([$({type:me})],m4.prototype,"signatureAlgorithm",void 0);_([$({type:F.BitString})],m4.prototype,"signatureValue",void 0);var Bm;(function(r){r[r.unmarked=1]="unmarked",r[r.unclassified=2]="unclassified",r[r.restricted=4]="restricted",r[r.confidential=8]="confidential",r[r.secret=16]="secret",r[r.topSecret=32]="topSecret"})(Bm||(Bm={}));class N7 extends c4{}class aA{constructor(e={}){this.type="",this.value=new ArrayBuffer(0),Object.assign(this,e)}}_([$({type:F.ObjectIdentifier,implicit:!0,context:0})],aA.prototype,"type",void 0);_([$({type:F.Any,implicit:!0,context:1})],aA.prototype,"value",void 0);class cA{constructor(e={}){this.policyId="",this.classList=new N7(Bm.unclassified),Object.assign(this,e)}}_([$({type:F.ObjectIdentifier})],cA.prototype,"policyId",void 0);_([$({type:N7,defaultValue:new N7(Bm.unclassified)})],cA.prototype,"classList",void 0);_([$({type:aA,repeated:"set"})],cA.prototype,"securityCategories",void 0);class w4{constructor(e={}){Object.assign(this,e)}}_([$({type:et})],w4.prototype,"cotets",void 0);_([$({type:F.ObjectIdentifier})],w4.prototype,"oid",void 0);_([$({type:F.Utf8String})],w4.prototype,"string",void 0);class Uj{constructor(e={}){this.values=[],Object.assign(this,e)}}_([$({type:dn,implicit:!0,context:0,optional:!0})],Uj.prototype,"policyAuthority",void 0);_([$({type:w4,repeated:"sequence"})],Uj.prototype,"values",void 0);var M7;class b4{constructor(e={}){this.targetCertificate=new Au,Object.assign(this,e)}}_([$({type:Au})],b4.prototype,"targetCertificate",void 0);_([$({type:Be,optional:!0})],b4.prototype,"targetName",void 0);_([$({type:Cu,optional:!0})],b4.prototype,"certDigestInfo",void 0);let mh=class{constructor(e={}){Object.assign(this,e)}};_([$({type:Be,context:0,implicit:!0})],mh.prototype,"targetName",void 0);_([$({type:Be,context:1,implicit:!0})],mh.prototype,"targetGroup",void 0);_([$({type:b4,context:2,implicit:!0})],mh.prototype,"targetCert",void 0);mh=_([te({type:X.Choice})],mh);let O7=M7=class extends ut{constructor(e){super(e),Object.setPrototypeOf(this,M7.prototype)}};O7=M7=_([te({type:X.Sequence,itemType:mh})],O7);var R7;let rD=R7=class extends ut{constructor(e){super(e),Object.setPrototypeOf(this,R7.prototype)}};rD=R7=_([te({type:X.Sequence,itemType:O7})],rD);class Fj{constructor(e={}){Object.assign(this,e)}}_([$({type:dn,implicit:!0,context:0,optional:!0})],Fj.prototype,"roleAuthority",void 0);_([$({type:Be,implicit:!0,context:1})],Fj.prototype,"roleName",void 0);class lA{constructor(e={}){this.service=new Be,this.ident=new Be,Object.assign(this,e)}}_([$({type:Be})],lA.prototype,"service",void 0);_([$({type:Be})],lA.prototype,"ident",void 0);_([$({type:et,optional:!0})],lA.prototype,"authInfo",void 0);var L7;class uA{constructor(e={}){this.otherCertFormat="",this.otherCert=new ArrayBuffer(0),Object.assign(this,e)}}_([$({type:F.ObjectIdentifier})],uA.prototype,"otherCertFormat",void 0);_([$({type:F.Any})],uA.prototype,"otherCert",void 0);let wh=class{constructor(e={}){Object.assign(this,e)}};_([$({type:ou})],wh.prototype,"certificate",void 0);_([$({type:m4,context:2,implicit:!0})],wh.prototype,"v2AttrCert",void 0);_([$({type:uA,context:3,implicit:!0})],wh.prototype,"other",void 0);wh=_([te({type:X.Choice})],wh);let Um=L7=class extends ut{constructor(e){super(e),Object.setPrototypeOf(this,L7.prototype)}};Um=L7=_([te({type:X.Set,itemType:wh})],Um);class Hh{constructor(e={}){this.contentType="",this.content=new ArrayBuffer(0),Object.assign(this,e)}}_([$({type:F.ObjectIdentifier})],Hh.prototype,"contentType",void 0);_([$({type:F.Any,context:0})],Hh.prototype,"content",void 0);let lp=class{constructor(e={}){Object.assign(this,e)}};_([$({type:et})],lp.prototype,"single",void 0);_([$({type:F.Any})],lp.prototype,"any",void 0);lp=_([te({type:X.Choice})],lp);class v4{constructor(e={}){this.eContentType="",Object.assign(this,e)}}_([$({type:F.ObjectIdentifier})],v4.prototype,"eContentType",void 0);_([$({type:lp,context:0,optional:!0})],v4.prototype,"eContent",void 0);let up=class{constructor(e={}){Object.assign(this,e)}};_([$({type:et,context:0,implicit:!0,optional:!0})],up.prototype,"value",void 0);_([$({type:et,converter:Ebe,context:0,implicit:!0,optional:!0,repeated:"sequence"})],up.prototype,"constructedValue",void 0);up=_([te({type:X.Choice})],up);class n0{constructor(e={}){this.contentType="",this.contentEncryptionAlgorithm=new Om,Object.assign(this,e)}}_([$({type:F.ObjectIdentifier})],n0.prototype,"contentType",void 0);_([$({type:Om})],n0.prototype,"contentEncryptionAlgorithm",void 0);_([$({type:up,optional:!0})],n0.prototype,"encryptedContent",void 0);class E4{constructor(e={}){this.keyAttrId="",Object.assign(this,e)}}_([$({type:F.ObjectIdentifier})],E4.prototype,"keyAttrId",void 0);_([$({type:F.Any,optional:!0})],E4.prototype,"keyAttr",void 0);var B7;class S4{constructor(e={}){this.subjectKeyIdentifier=new gc,Object.assign(this,e)}}_([$({type:gc})],S4.prototype,"subjectKeyIdentifier",void 0);_([$({type:F.GeneralizedTime,optional:!0})],S4.prototype,"date",void 0);_([$({type:E4,optional:!0})],S4.prototype,"other",void 0);let bh=class{constructor(e={}){Object.assign(this,e)}};_([$({type:S4,context:0,implicit:!0,optional:!0})],bh.prototype,"rKeyId",void 0);_([$({type:Kh,optional:!0})],bh.prototype,"issuerAndSerialNumber",void 0);bh=_([te({type:X.Choice})],bh);class dA{constructor(e={}){this.rid=new bh,this.encryptedKey=new et,Object.assign(this,e)}}_([$({type:bh})],dA.prototype,"rid",void 0);_([$({type:et})],dA.prototype,"encryptedKey",void 0);let Fm=B7=class extends ut{constructor(e){super(e),Object.setPrototypeOf(this,B7.prototype)}};Fm=B7=_([te({type:X.Sequence,itemType:dA})],Fm);class hA{constructor(e={}){this.algorithm=new me,this.publicKey=new ArrayBuffer(0),Object.assign(this,e)}}_([$({type:me})],hA.prototype,"algorithm",void 0);_([$({type:F.BitString})],hA.prototype,"publicKey",void 0);let au=class{constructor(e={}){Object.assign(this,e)}};_([$({type:gc,context:0,implicit:!0,optional:!0})],au.prototype,"subjectKeyIdentifier",void 0);_([$({type:hA,context:1,implicit:!0,optional:!0})],au.prototype,"originatorKey",void 0);_([$({type:Kh,optional:!0})],au.prototype,"issuerAndSerialNumber",void 0);au=_([te({type:X.Choice})],au);class qh{constructor(e={}){this.version=qo.v3,this.originator=new au,this.keyEncryptionAlgorithm=new Gs,this.recipientEncryptedKeys=new Fm,Object.assign(this,e)}}_([$({type:F.Integer})],qh.prototype,"version",void 0);_([$({type:au,context:0})],qh.prototype,"originator",void 0);_([$({type:et,context:1,optional:!0})],qh.prototype,"ukm",void 0);_([$({type:Gs})],qh.prototype,"keyEncryptionAlgorithm",void 0);_([$({type:Fm})],qh.prototype,"recipientEncryptedKeys",void 0);let vh=class{constructor(e={}){Object.assign(this,e)}};_([$({type:gc,context:0,implicit:!0})],vh.prototype,"subjectKeyIdentifier",void 0);_([$({type:Kh})],vh.prototype,"issuerAndSerialNumber",void 0);vh=_([te({type:X.Choice})],vh);class i0{constructor(e={}){this.version=qo.v0,this.rid=new vh,this.keyEncryptionAlgorithm=new Gs,this.encryptedKey=new et,Object.assign(this,e)}}_([$({type:F.Integer})],i0.prototype,"version",void 0);_([$({type:vh})],i0.prototype,"rid",void 0);_([$({type:Gs})],i0.prototype,"keyEncryptionAlgorithm",void 0);_([$({type:et})],i0.prototype,"encryptedKey",void 0);class s0{constructor(e={}){this.keyIdentifier=new et,Object.assign(this,e)}}_([$({type:et})],s0.prototype,"keyIdentifier",void 0);_([$({type:F.GeneralizedTime,optional:!0})],s0.prototype,"date",void 0);_([$({type:E4,optional:!0})],s0.prototype,"other",void 0);class o0{constructor(e={}){this.version=qo.v4,this.kekid=new s0,this.keyEncryptionAlgorithm=new Gs,this.encryptedKey=new et,Object.assign(this,e)}}_([$({type:F.Integer})],o0.prototype,"version",void 0);_([$({type:s0})],o0.prototype,"kekid",void 0);_([$({type:Gs})],o0.prototype,"keyEncryptionAlgorithm",void 0);_([$({type:et})],o0.prototype,"encryptedKey",void 0);class a0{constructor(e={}){this.version=qo.v0,this.keyEncryptionAlgorithm=new Gs,this.encryptedKey=new et,Object.assign(this,e)}}_([$({type:F.Integer})],a0.prototype,"version",void 0);_([$({type:_7,context:0,optional:!0})],a0.prototype,"keyDerivationAlgorithm",void 0);_([$({type:Gs})],a0.prototype,"keyEncryptionAlgorithm",void 0);_([$({type:et})],a0.prototype,"encryptedKey",void 0);class fA{constructor(e={}){this.oriType="",this.oriValue=new ArrayBuffer(0),Object.assign(this,e)}}_([$({type:F.ObjectIdentifier})],fA.prototype,"oriType",void 0);_([$({type:F.Any})],fA.prototype,"oriValue",void 0);let Dc=class{constructor(e={}){Object.assign(this,e)}};_([$({type:i0,optional:!0})],Dc.prototype,"ktri",void 0);_([$({type:qh,context:1,implicit:!0,optional:!0})],Dc.prototype,"kari",void 0);_([$({type:o0,context:2,implicit:!0,optional:!0})],Dc.prototype,"kekri",void 0);_([$({type:a0,context:3,implicit:!0,optional:!0})],Dc.prototype,"pwri",void 0);_([$({type:fA,context:4,implicit:!0,optional:!0})],Dc.prototype,"ori",void 0);Dc=_([te({type:X.Choice})],Dc);var U7;let zm=U7=class extends ut{constructor(e){super(e),Object.setPrototypeOf(this,U7.prototype)}};zm=U7=_([te({type:X.Set,itemType:Dc})],zm);var F7;class x4{constructor(e={}){this.otherRevInfoFormat="",this.otherRevInfo=new ArrayBuffer(0),Object.assign(this,e)}}_([$({type:F.ObjectIdentifier})],x4.prototype,"otherRevInfoFormat",void 0);_([$({type:F.Any})],x4.prototype,"otherRevInfo",void 0);let Vm=class{constructor(e={}){this.other=new x4,Object.assign(this,e)}};_([$({type:x4,context:1,implicit:!0})],Vm.prototype,"other",void 0);Vm=_([te({type:X.Choice})],Vm);let Km=F7=class extends ut{constructor(e){super(e),Object.setPrototypeOf(this,F7.prototype)}};Km=F7=_([te({type:X.Set,itemType:Vm})],Km);class pA{constructor(e={}){Object.assign(this,e)}}_([$({type:Um,context:0,implicit:!0,optional:!0})],pA.prototype,"certs",void 0);_([$({type:Km,context:1,implicit:!0,optional:!0})],pA.prototype,"crls",void 0);var z7;let V7=z7=class extends ut{constructor(e){super(e),Object.setPrototypeOf(this,z7.prototype)}};V7=z7=_([te({type:X.Set,itemType:jh})],V7);class c0{constructor(e={}){this.version=qo.v0,this.recipientInfos=new zm,this.encryptedContentInfo=new n0,Object.assign(this,e)}}_([$({type:F.Integer})],c0.prototype,"version",void 0);_([$({type:pA,context:0,implicit:!0,optional:!0})],c0.prototype,"originatorInfo",void 0);_([$({type:zm})],c0.prototype,"recipientInfos",void 0);_([$({type:n0})],c0.prototype,"encryptedContentInfo",void 0);_([$({type:V7,context:1,implicit:!0,optional:!0})],c0.prototype,"unprotectedAttrs",void 0);const Wbe="1.2.840.113549.1.7.2";var K7;let jm=K7=class extends ut{constructor(e){super(e),Object.setPrototypeOf(this,K7.prototype)}};jm=K7=_([te({type:X.Set,itemType:cp})],jm);class Wh{constructor(e={}){this.version=qo.v0,this.digestAlgorithms=new jm,this.encapContentInfo=new v4,this.signerInfos=new Rm,Object.assign(this,e)}}_([$({type:F.Integer})],Wh.prototype,"version",void 0);_([$({type:jm})],Wh.prototype,"digestAlgorithms",void 0);_([$({type:v4})],Wh.prototype,"encapContentInfo",void 0);_([$({type:Um,context:0,implicit:!0,optional:!0})],Wh.prototype,"certificates",void 0);_([$({type:Km,context:1,implicit:!0,optional:!0})],Wh.prototype,"crls",void 0);_([$({type:Rm})],Wh.prototype,"signerInfos",void 0);const dp="1.2.840.10045.2.1",gA="1.2.840.10045.4.1",zj="1.2.840.10045.4.3.1",yA="1.2.840.10045.4.3.2",mA="1.2.840.10045.4.3.3",wA="1.2.840.10045.4.3.4",nD="1.2.840.10045.3.1.7",iD="1.3.132.0.34",sD="1.3.132.0.35";function l0(r){return new me({algorithm:r})}const Gbe=l0(gA);l0(zj);const Qbe=l0(yA),Ybe=l0(mA),Jbe=l0(wA);let hp=class{constructor(e={}){Object.assign(this,e)}};_([$({type:F.ObjectIdentifier})],hp.prototype,"fieldType",void 0);_([$({type:F.Any})],hp.prototype,"parameters",void 0);hp=_([te({type:X.Sequence})],hp);class Xbe extends et{}let Eh=class{constructor(e={}){Object.assign(this,e)}};_([$({type:F.OctetString})],Eh.prototype,"a",void 0);_([$({type:F.OctetString})],Eh.prototype,"b",void 0);_([$({type:F.BitString,optional:!0})],Eh.prototype,"seed",void 0);Eh=_([te({type:X.Sequence})],Eh);var j7;(function(r){r[r.ecpVer1=1]="ecpVer1"})(j7||(j7={}));let Wo=class{constructor(e={}){this.version=j7.ecpVer1,Object.assign(this,e)}};_([$({type:F.Integer})],Wo.prototype,"version",void 0);_([$({type:hp})],Wo.prototype,"fieldID",void 0);_([$({type:Eh})],Wo.prototype,"curve",void 0);_([$({type:Xbe})],Wo.prototype,"base",void 0);_([$({type:F.Integer,converter:Dt})],Wo.prototype,"order",void 0);_([$({type:F.Integer,optional:!0})],Wo.prototype,"cofactor",void 0);Wo=_([te({type:X.Sequence})],Wo);let $c=class{constructor(e={}){Object.assign(this,e)}};_([$({type:F.ObjectIdentifier})],$c.prototype,"namedCurve",void 0);_([$({type:F.Null})],$c.prototype,"implicitCurve",void 0);_([$({type:Wo})],$c.prototype,"specifiedCurve",void 0);$c=_([te({type:X.Choice})],$c);class A4{constructor(e={}){this.version=1,this.privateKey=new et,Object.assign(this,e)}}_([$({type:F.Integer})],A4.prototype,"version",void 0);_([$({type:et})],A4.prototype,"privateKey",void 0);_([$({type:$c,context:0,optional:!0})],A4.prototype,"parameters",void 0);_([$({type:F.BitString,context:1,optional:!0})],A4.prototype,"publicKey",void 0);class Hm{constructor(e={}){this.r=new ArrayBuffer(0),this.s=new ArrayBuffer(0),Object.assign(this,e)}}_([$({type:F.Integer,converter:Dt})],Hm.prototype,"r",void 0);_([$({type:F.Integer,converter:Dt})],Hm.prototype,"s",void 0);const Bn="1.2.840.113549.1.1",cu=`${Bn}.1`,Zbe=`${Bn}.7`,eve=`${Bn}.9`,g1=`${Bn}.10`,tve=`${Bn}.2`,rve=`${Bn}.4`,qm=`${Bn}.5`,nve=`${Bn}.14`,H7=`${Bn}.11`,Wm=`${Bn}.12`,Gm=`${Bn}.13`,Vj=`${Bn}.15`,Kj=`${Bn}.16`,Qm="1.3.14.3.2.26",jj="2.16.840.1.101.3.4.2.4",Ym="2.16.840.1.101.3.4.2.1",Jm="2.16.840.1.101.3.4.2.2",Xm="2.16.840.1.101.3.4.2.3",ive="2.16.840.1.101.3.4.2.5",sve="2.16.840.1.101.3.4.2.6",ove="1.2.840.113549.2.2",ave="1.2.840.113549.2.5",C4=`${Bn}.8`;function sr(r){return new me({algorithm:r,parameters:null})}sr(ove);sr(ave);const lu=sr(Qm);sr(jj);sr(Ym);sr(Jm);sr(Xm);sr(ive);sr(sve);const Hj=new me({algorithm:C4,parameters:ae.serialize(lu)}),qj=new me({algorithm:eve,parameters:ae.serialize(km.toASN(new Uint8Array([218,57,163,238,94,107,75,13,50,85,191,239,149,96,24,144,175,216,7,9]).buffer))});sr(cu);sr(tve);sr(rve);sr(qm);sr(Vj);sr(Kj);sr(Wm);sr(Gm);sr(Vj);sr(Kj);class I4{constructor(e={}){this.hashAlgorithm=new me(lu),this.maskGenAlgorithm=new me({algorithm:C4,parameters:ae.serialize(lu)}),this.pSourceAlgorithm=new me(qj),Object.assign(this,e)}}_([$({type:me,context:0,defaultValue:lu})],I4.prototype,"hashAlgorithm",void 0);_([$({type:me,context:1,defaultValue:Hj})],I4.prototype,"maskGenAlgorithm",void 0);_([$({type:me,context:2,defaultValue:qj})],I4.prototype,"pSourceAlgorithm",void 0);new me({algorithm:Zbe,parameters:ae.serialize(new I4)});class uu{constructor(e={}){this.hashAlgorithm=new me(lu),this.maskGenAlgorithm=new me({algorithm:C4,parameters:ae.serialize(lu)}),this.saltLength=20,this.trailerField=1,Object.assign(this,e)}}_([$({type:me,context:0,defaultValue:lu})],uu.prototype,"hashAlgorithm",void 0);_([$({type:me,context:1,defaultValue:Hj})],uu.prototype,"maskGenAlgorithm",void 0);_([$({type:F.Integer,context:2,defaultValue:20})],uu.prototype,"saltLength",void 0);_([$({type:F.Integer,context:3,defaultValue:1})],uu.prototype,"trailerField",void 0);new me({algorithm:g1,parameters:ae.serialize(new uu)});class k4{constructor(e={}){this.digestAlgorithm=new me,this.digest=new et,Object.assign(this,e)}}_([$({type:me})],k4.prototype,"digestAlgorithm",void 0);_([$({type:et})],k4.prototype,"digest",void 0);var q7;class _4{constructor(e={}){this.prime=new ArrayBuffer(0),this.exponent=new ArrayBuffer(0),this.coefficient=new ArrayBuffer(0),Object.assign(this,e)}}_([$({type:F.Integer,converter:Dt})],_4.prototype,"prime",void 0);_([$({type:F.Integer,converter:Dt})],_4.prototype,"exponent",void 0);_([$({type:F.Integer,converter:Dt})],_4.prototype,"coefficient",void 0);let W7=q7=class extends ut{constructor(e){super(e),Object.setPrototypeOf(this,q7.prototype)}};W7=q7=_([te({type:X.Sequence,itemType:_4})],W7);class eo{constructor(e={}){this.version=0,this.modulus=new ArrayBuffer(0),this.publicExponent=new ArrayBuffer(0),this.privateExponent=new ArrayBuffer(0),this.prime1=new ArrayBuffer(0),this.prime2=new ArrayBuffer(0),this.exponent1=new ArrayBuffer(0),this.exponent2=new ArrayBuffer(0),this.coefficient=new ArrayBuffer(0),Object.assign(this,e)}}_([$({type:F.Integer})],eo.prototype,"version",void 0);_([$({type:F.Integer,converter:Dt})],eo.prototype,"modulus",void 0);_([$({type:F.Integer,converter:Dt})],eo.prototype,"publicExponent",void 0);_([$({type:F.Integer,converter:Dt})],eo.prototype,"privateExponent",void 0);_([$({type:F.Integer,converter:Dt})],eo.prototype,"prime1",void 0);_([$({type:F.Integer,converter:Dt})],eo.prototype,"prime2",void 0);_([$({type:F.Integer,converter:Dt})],eo.prototype,"exponent1",void 0);_([$({type:F.Integer,converter:Dt})],eo.prototype,"exponent2",void 0);_([$({type:F.Integer,converter:Dt})],eo.prototype,"coefficient",void 0);_([$({type:W7,optional:!0})],eo.prototype,"otherPrimeInfos",void 0);class bA{constructor(e={}){this.modulus=new ArrayBuffer(0),this.publicExponent=new ArrayBuffer(0),Object.assign(this,e)}}_([$({type:F.Integer,converter:Dt})],bA.prototype,"modulus",void 0);_([$({type:F.Integer,converter:Dt})],bA.prototype,"publicExponent",void 0);var G7;(function(r){r[r.Transient=0]="Transient",r[r.Singleton=1]="Singleton",r[r.ResolutionScoped=2]="ResolutionScoped",r[r.ContainerScoped=3]="ContainerScoped"})(G7||(G7={}));const mn=G7;/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */var Q7=function(r,e){return Q7=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var i in n)n.hasOwnProperty(i)&&(t[i]=n[i])},Q7(r,e)};function vA(r,e){Q7(r,e);function t(){this.constructor=r}r.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}function cve(r,e,t,n){function i(s){return s instanceof t?s:new t(function(o){o(s)})}return new(t||(t=Promise))(function(s,o){function a(d){try{l(n.next(d))}catch(h){o(h)}}function c(d){try{l(n.throw(d))}catch(h){o(h)}}function l(d){d.done?s(d.value):i(d.value).then(a,c)}l((n=n.apply(r,[])).next())})}function lve(r,e){var t={label:0,sent:function(){if(s[0]&1)throw s[1];return s[1]},trys:[],ops:[]},n,i,s,o;return o={next:a(0),throw:a(1),return:a(2)},typeof Symbol=="function"&&(o[Symbol.iterator]=function(){return this}),o;function a(l){return function(d){return c([l,d])}}function c(l){if(n)throw new TypeError("Generator is already executing.");for(;t;)try{if(n=1,i&&(s=l[0]&2?i.return:l[0]?i.throw||((s=i.return)&&s.call(i),0):i.next)&&!(s=s.call(i,l[1])).done)return s;switch(i=0,s&&(l=[l[0]&2,s.value]),l[0]){case 0:case 1:s=l;break;case 4:return t.label++,{value:l[1],done:!1};case 5:t.label++,i=l[1],l=[0];continue;case 7:l=t.ops.pop(),t.trys.pop();continue;default:if(s=t.trys,!(s=s.length>0&&s[s.length-1])&&(l[0]===6||l[0]===2)){t=0;continue}if(l[0]===3&&(!s||l[1]>s[0]&&l[1]<s[3])){t.label=l[1];break}if(l[0]===6&&t.label<s[1]){t.label=s[1],s=l;break}if(s&&t.label<s[2]){t.label=s[2],t.ops.push(l);break}s[2]&&t.ops.pop(),t.trys.pop();continue}l=e.call(r,t)}catch(d){l=[6,d],i=0}finally{n=s=0}if(l[0]&5)throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}}function gg(r){var e=typeof Symbol=="function"&&Symbol.iterator,t=e&&r[e],n=0;if(t)return t.call(r);if(r&&typeof r.length=="number")return{next:function(){return r&&n>=r.length&&(r=void 0),{value:r&&r[n++],done:!r}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function Zm(r,e){var t=typeof Symbol=="function"&&r[Symbol.iterator];if(!t)return r;var n=t.call(r),i,s=[],o;try{for(;(e===void 0||e-- >0)&&!(i=n.next()).done;)s.push(i.value)}catch(a){o={error:a}}finally{try{i&&!i.done&&(t=n.return)&&t.call(n)}finally{if(o)throw o.error}}return s}function dl(){for(var r=[],e=0;e<arguments.length;e++)r=r.concat(Zm(arguments[e]));return r}var uve="injectionTokens";function dve(r){var e=Reflect.getMetadata("design:paramtypes",r)||[],t=Reflect.getOwnMetadata(uve,r)||{};return Object.keys(t).forEach(function(n){e[+n]=t[n]}),e}function Wj(r){return!!r.useClass}function Y7(r){return!!r.useFactory}var Gj=function(){function r(e){this.wrap=e,this.reflectMethods=["get","getPrototypeOf","setPrototypeOf","getOwnPropertyDescriptor","defineProperty","has","set","deleteProperty","apply","construct","ownKeys"]}return r.prototype.createProxy=function(e){var t=this,n={},i=!1,s,o=function(){return i||(s=e(t.wrap()),i=!0),s};return new Proxy(n,this.createHandler(o))},r.prototype.createHandler=function(e){var t={},n=function(i){t[i]=function(){for(var s=[],o=0;o<arguments.length;o++)s[o]=arguments[o];s[0]=e();var a=Reflect[i];return a.apply(void 0,dl(s))}};return this.reflectMethods.forEach(n),t},r}();function Ku(r){return typeof r=="string"||typeof r=="symbol"}function hve(r){return typeof r=="object"&&"token"in r&&"multiple"in r}function oD(r){return typeof r=="object"&&"token"in r&&"transform"in r}function fve(r){return typeof r=="function"||r instanceof Gj}function u2(r){return!!r.useToken}function d2(r){return r.useValue!=null}function pve(r){return Wj(r)||d2(r)||u2(r)||Y7(r)}var EA=function(){function r(){this._registryMap=new Map}return r.prototype.entries=function(){return this._registryMap.entries()},r.prototype.getAll=function(e){return this.ensure(e),this._registryMap.get(e)},r.prototype.get=function(e){this.ensure(e);var t=this._registryMap.get(e);return t[t.length-1]||null},r.prototype.set=function(e,t){this.ensure(e),this._registryMap.get(e).push(t)},r.prototype.setAll=function(e,t){this._registryMap.set(e,t)},r.prototype.has=function(e){return this.ensure(e),this._registryMap.get(e).length>0},r.prototype.clear=function(){this._registryMap.clear()},r.prototype.ensure=function(e){this._registryMap.has(e)||this._registryMap.set(e,[])},r}(),gve=function(r){vA(e,r);function e(){return r!==null&&r.apply(this,arguments)||this}return e}(EA),yg=function(){function r(){this.scopedResolutions=new Map}return r}();function yve(r,e){if(r===null)return"at position #"+e;var t=r.split(",")[e].trim();return'"'+t+'" at position #'+e}function mve(r,e,t){return t===void 0&&(t="    "),dl([r],e.message.split(`
`).map(function(n){return t+n})).join(`
`)}function wve(r,e,t){var n=Zm(r.toString().match(/constructor\(([\w, ]+)\)/)||[],2),i=n[1],s=i===void 0?null:i,o=yve(s,e);return mve("Cannot inject the dependency "+o+' of "'+r.name+'" constructor. Reason:',t)}function bve(r){if(typeof r.dispose!="function")return!1;var e=r.dispose;return!(e.length>0)}var vve=function(r){vA(e,r);function e(){return r!==null&&r.apply(this,arguments)||this}return e}(EA),Eve=function(r){vA(e,r);function e(){return r!==null&&r.apply(this,arguments)||this}return e}(EA),Sve=function(){function r(){this.preResolution=new vve,this.postResolution=new Eve}return r}(),Qj=new Map,xve=function(){function r(e){this.parent=e,this._registry=new gve,this.interceptors=new Sve,this.disposed=!1,this.disposables=new Set}return r.prototype.register=function(e,t,n){n===void 0&&(n={lifecycle:mn.Transient}),this.ensureNotDisposed();var i;if(pve(t)?i=t:i={useClass:t},u2(i))for(var s=[e],o=i;o!=null;){var a=o.useToken;if(s.includes(a))throw new Error("Token registration cycle detected! "+dl(s,[a]).join(" -> "));s.push(a);var c=this._registry.get(a);c&&u2(c.provider)?o=c.provider:o=null}if((n.lifecycle===mn.Singleton||n.lifecycle==mn.ContainerScoped||n.lifecycle==mn.ResolutionScoped)&&(d2(i)||Y7(i)))throw new Error('Cannot use lifecycle "'+mn[n.lifecycle]+'" with ValueProviders or FactoryProviders');return this._registry.set(e,{provider:i,options:n}),this},r.prototype.registerType=function(e,t){return this.ensureNotDisposed(),Ku(t)?this.register(e,{useToken:t}):this.register(e,{useClass:t})},r.prototype.registerInstance=function(e,t){return this.ensureNotDisposed(),this.register(e,{useValue:t})},r.prototype.registerSingleton=function(e,t){if(this.ensureNotDisposed(),Ku(e)){if(Ku(t))return this.register(e,{useToken:t},{lifecycle:mn.Singleton});if(t)return this.register(e,{useClass:t},{lifecycle:mn.Singleton});throw new Error('Cannot register a type name as a singleton without a "to" token')}var n=e;return t&&!Ku(t)&&(n=t),this.register(e,{useClass:n},{lifecycle:mn.Singleton})},r.prototype.resolve=function(e,t,n){t===void 0&&(t=new yg),n===void 0&&(n=!1),this.ensureNotDisposed();var i=this.getRegistration(e);if(!i&&Ku(e)){if(n)return;throw new Error('Attempted to resolve unregistered dependency token: "'+e.toString()+'"')}if(this.executePreResolutionInterceptor(e,"Single"),i){var s=this.resolveRegistration(i,t);return this.executePostResolutionInterceptor(e,s,"Single"),s}if(fve(e)){var s=this.construct(e,t);return this.executePostResolutionInterceptor(e,s,"Single"),s}throw new Error("Attempted to construct an undefined constructor. Could mean a circular dependency problem. Try using `delay` function.")},r.prototype.executePreResolutionInterceptor=function(e,t){var n,i;if(this.interceptors.preResolution.has(e)){var s=[];try{for(var o=gg(this.interceptors.preResolution.getAll(e)),a=o.next();!a.done;a=o.next()){var c=a.value;c.options.frequency!="Once"&&s.push(c),c.callback(e,t)}}catch(l){n={error:l}}finally{try{a&&!a.done&&(i=o.return)&&i.call(o)}finally{if(n)throw n.error}}this.interceptors.preResolution.setAll(e,s)}},r.prototype.executePostResolutionInterceptor=function(e,t,n){var i,s;if(this.interceptors.postResolution.has(e)){var o=[];try{for(var a=gg(this.interceptors.postResolution.getAll(e)),c=a.next();!c.done;c=a.next()){var l=c.value;l.options.frequency!="Once"&&o.push(l),l.callback(e,t,n)}}catch(d){i={error:d}}finally{try{c&&!c.done&&(s=a.return)&&s.call(a)}finally{if(i)throw i.error}}this.interceptors.postResolution.setAll(e,o)}},r.prototype.resolveRegistration=function(e,t){if(this.ensureNotDisposed(),e.options.lifecycle===mn.ResolutionScoped&&t.scopedResolutions.has(e))return t.scopedResolutions.get(e);var n=e.options.lifecycle===mn.Singleton,i=e.options.lifecycle===mn.ContainerScoped,s=n||i,o;return d2(e.provider)?o=e.provider.useValue:u2(e.provider)?o=s?e.instance||(e.instance=this.resolve(e.provider.useToken,t)):this.resolve(e.provider.useToken,t):Wj(e.provider)?o=s?e.instance||(e.instance=this.construct(e.provider.useClass,t)):this.construct(e.provider.useClass,t):Y7(e.provider)?o=e.provider.useFactory(this):o=this.construct(e.provider,t),e.options.lifecycle===mn.ResolutionScoped&&t.scopedResolutions.set(e,o),o},r.prototype.resolveAll=function(e,t,n){var i=this;t===void 0&&(t=new yg),n===void 0&&(n=!1),this.ensureNotDisposed();var s=this.getAllRegistrations(e);if(!s&&Ku(e)){if(n)return[];throw new Error('Attempted to resolve unregistered dependency token: "'+e.toString()+'"')}if(this.executePreResolutionInterceptor(e,"All"),s){var o=s.map(function(c){return i.resolveRegistration(c,t)});return this.executePostResolutionInterceptor(e,o,"All"),o}var a=[this.construct(e,t)];return this.executePostResolutionInterceptor(e,a,"All"),a},r.prototype.isRegistered=function(e,t){return t===void 0&&(t=!1),this.ensureNotDisposed(),this._registry.has(e)||t&&(this.parent||!1)&&this.parent.isRegistered(e,!0)},r.prototype.reset=function(){this.ensureNotDisposed(),this._registry.clear(),this.interceptors.preResolution.clear(),this.interceptors.postResolution.clear()},r.prototype.clearInstances=function(){var e,t;this.ensureNotDisposed();try{for(var n=gg(this._registry.entries()),i=n.next();!i.done;i=n.next()){var s=Zm(i.value,2),o=s[0],a=s[1];this._registry.setAll(o,a.filter(function(c){return!d2(c.provider)}).map(function(c){return c.instance=void 0,c}))}}catch(c){e={error:c}}finally{try{i&&!i.done&&(t=n.return)&&t.call(n)}finally{if(e)throw e.error}}},r.prototype.createChildContainer=function(){var e,t;this.ensureNotDisposed();var n=new r(this);try{for(var i=gg(this._registry.entries()),s=i.next();!s.done;s=i.next()){var o=Zm(s.value,2),a=o[0],c=o[1];c.some(function(l){var d=l.options;return d.lifecycle===mn.ContainerScoped})&&n._registry.setAll(a,c.map(function(l){return l.options.lifecycle===mn.ContainerScoped?{provider:l.provider,options:l.options}:l}))}}catch(l){e={error:l}}finally{try{s&&!s.done&&(t=i.return)&&t.call(i)}finally{if(e)throw e.error}}return n},r.prototype.beforeResolution=function(e,t,n){n===void 0&&(n={frequency:"Always"}),this.interceptors.preResolution.set(e,{callback:t,options:n})},r.prototype.afterResolution=function(e,t,n){n===void 0&&(n={frequency:"Always"}),this.interceptors.postResolution.set(e,{callback:t,options:n})},r.prototype.dispose=function(){return cve(this,void 0,void 0,function(){var e;return lve(this,function(t){switch(t.label){case 0:return this.disposed=!0,e=[],this.disposables.forEach(function(n){var i=n.dispose();i&&e.push(i)}),[4,Promise.all(e)];case 1:return t.sent(),[2]}})})},r.prototype.getRegistration=function(e){return this.isRegistered(e)?this._registry.get(e):this.parent?this.parent.getRegistration(e):null},r.prototype.getAllRegistrations=function(e){return this.isRegistered(e)?this._registry.getAll(e):this.parent?this.parent.getAllRegistrations(e):null},r.prototype.construct=function(e,t){var n=this;if(e instanceof Gj)return e.createProxy(function(s){return n.resolve(s,t)});var i=function(){var s=Qj.get(e);if(!s||s.length===0){if(e.length===0)return new e;throw new Error('TypeInfo not known for "'+e.name+'"')}var o=s.map(n.resolveParams(t,e));return new(e.bind.apply(e,dl([void 0],o)))}();return bve(i)&&this.disposables.add(i),i},r.prototype.resolveParams=function(e,t){var n=this;return function(i,s){var o,a,c;try{return hve(i)?oD(i)?i.multiple?(o=n.resolve(i.transform)).transform.apply(o,dl([n.resolveAll(i.token,new yg,i.isOptional)],i.transformArgs)):(a=n.resolve(i.transform)).transform.apply(a,dl([n.resolve(i.token,e,i.isOptional)],i.transformArgs)):i.multiple?n.resolveAll(i.token,new yg,i.isOptional):n.resolve(i.token,e,i.isOptional):oD(i)?(c=n.resolve(i.transform,e)).transform.apply(c,dl([n.resolve(i.token,e)],i.transformArgs)):n.resolve(i,e)}catch(l){throw new Error(wve(t,s,l))}}},r.prototype.ensureNotDisposed=function(){if(this.disposed)throw new Error("This container has been disposed, you cannot interact with a disposed container")},r}(),kr=new xve;function T4(r){return function(e){Qj.set(e,dve(e))}}if(typeof Reflect>"u"||!Reflect.getMetadata)throw new Error(`tsyringe requires a reflect polyfill. Please add 'import "reflect-metadata"' to the top of your entry point.`);var J7;class P4{constructor(e={}){this.attrId="",this.attrValues=[],Object.assign(e)}}_([$({type:F.ObjectIdentifier})],P4.prototype,"attrId",void 0);_([$({type:F.Any,repeated:"set"})],P4.prototype,"attrValues",void 0);let aD=J7=class extends ut{constructor(e){super(e),Object.setPrototypeOf(this,J7.prototype)}};aD=J7=_([te({type:X.Sequence,itemType:P4})],aD);var X7;let cD=X7=class extends ut{constructor(e){super(e),Object.setPrototypeOf(this,X7.prototype)}};cD=X7=_([te({type:X.Sequence,itemType:Hh})],cD);class Yj{constructor(e={}){this.certId="",this.certValue=new ArrayBuffer(0),Object.assign(this,e)}}_([$({type:F.ObjectIdentifier})],Yj.prototype,"certId",void 0);_([$({type:F.Any,context:0})],Yj.prototype,"certValue",void 0);class Jj{constructor(e={}){this.crlId="",this.crltValue=new ArrayBuffer(0),Object.assign(this,e)}}_([$({type:F.ObjectIdentifier})],Jj.prototype,"crlId",void 0);_([$({type:F.Any,context:0})],Jj.prototype,"crltValue",void 0);class Xj extends et{}let D4=class{constructor(e={}){this.encryptionAlgorithm=new me,this.encryptedData=new Xj,Object.assign(this,e)}};_([$({type:me})],D4.prototype,"encryptionAlgorithm",void 0);_([$({type:Xj})],D4.prototype,"encryptedData",void 0);var Z7,e9;(function(r){r[r.v1=0]="v1"})(e9||(e9={}));class Zj extends et{}let t9=Z7=class extends ut{constructor(e){super(e),Object.setPrototypeOf(this,Z7.prototype)}};t9=Z7=_([te({type:X.Sequence,itemType:Ho})],t9);class u0{constructor(e={}){this.version=e9.v1,this.privateKeyAlgorithm=new me,this.privateKey=new Zj,Object.assign(this,e)}}_([$({type:F.Integer})],u0.prototype,"version",void 0);_([$({type:me})],u0.prototype,"privateKeyAlgorithm",void 0);_([$({type:Zj})],u0.prototype,"privateKey",void 0);_([$({type:t9,implicit:!0,context:0,optional:!0})],u0.prototype,"attributes",void 0);let lD=class extends u0{};lD=_([te({type:X.Sequence})],lD);let uD=class extends D4{};uD=_([te({type:X.Sequence})],uD);class eH{constructor(e={}){this.secretTypeId="",this.secretValue=new ArrayBuffer(0),Object.assign(this,e)}}_([$({type:F.ObjectIdentifier})],eH.prototype,"secretTypeId",void 0);_([$({type:F.Any,context:0})],eH.prototype,"secretValue",void 0);class d0{constructor(e={}){this.mac=new k4,this.macSalt=new et,this.iterations=1,Object.assign(this,e)}}_([$({type:k4})],d0.prototype,"mac",void 0);_([$({type:et})],d0.prototype,"macSalt",void 0);_([$({type:F.Integer,defaultValue:1})],d0.prototype,"iterations",void 0);class $4{constructor(e={}){this.version=3,this.authSafe=new Hh,this.macData=new d0,Object.assign(this,e)}}_([$({type:F.Integer})],$4.prototype,"version",void 0);_([$({type:Hh})],$4.prototype,"authSafe",void 0);_([$({type:d0,optional:!0})],$4.prototype,"macData",void 0);var r9;class N4{constructor(e={}){this.bagId="",this.bagValue=new ArrayBuffer(0),Object.assign(this,e)}}_([$({type:F.ObjectIdentifier})],N4.prototype,"bagId",void 0);_([$({type:F.Any,context:0})],N4.prototype,"bagValue",void 0);_([$({type:P4,repeated:"set",optional:!0})],N4.prototype,"bagAttributes",void 0);let dD=r9=class extends ut{constructor(e){super(e),Object.setPrototypeOf(this,r9.prototype)}};dD=r9=_([te({type:X.Sequence,itemType:N4})],dD);var n9,i9,s9;const tH="1.2.840.113549.1.9",rH=`${tH}.7`,SA=`${tH}.14`;let e3=class extends Ir{constructor(e={}){super(e)}toString(){return this.ia5String||super.toString()}};_([$({type:F.IA5String})],e3.prototype,"ia5String",void 0);e3=_([te({type:X.Choice})],e3);let hD=class extends Hh{};hD=_([te({type:X.Sequence})],hD);let fD=class extends $4{};fD=_([te({type:X.Sequence})],fD);let pD=class extends D4{};pD=_([te({type:X.Sequence})],pD);let o9=class{constructor(e=""){this.value=e}toString(){return this.value}};_([$({type:F.IA5String})],o9.prototype,"value",void 0);o9=_([te({type:X.Choice})],o9);let gD=class extends e3{};gD=_([te({type:X.Choice})],gD);let yD=class extends Ir{};yD=_([te({type:X.Choice})],yD);let a9=class{constructor(e=new Date){this.value=e}};_([$({type:F.GeneralizedTime})],a9.prototype,"value",void 0);a9=_([te({type:X.Choice})],a9);let mD=class extends Ir{};mD=_([te({type:X.Choice})],mD);let c9=class{constructor(e="M"){this.value=e}toString(){return this.value}};_([$({type:F.PrintableString})],c9.prototype,"value",void 0);c9=_([te({type:X.Choice})],c9);let t3=class{constructor(e=""){this.value=e}toString(){return this.value}};_([$({type:F.PrintableString})],t3.prototype,"value",void 0);t3=_([te({type:X.Choice})],t3);let wD=class extends t3{};wD=_([te({type:X.Choice})],wD);let bD=class extends Ir{};bD=_([te({type:X.Choice})],bD);let l9=class{constructor(e=""){this.value=e}toString(){return this.value}};_([$({type:F.ObjectIdentifier})],l9.prototype,"value",void 0);l9=_([te({type:X.Choice})],l9);let vD=class extends Er{};vD=_([te({type:X.Choice})],vD);let u9=class{constructor(e=0){this.value=e}toString(){return this.value.toString()}};_([$({type:F.Integer})],u9.prototype,"value",void 0);u9=_([te({type:X.Choice})],u9);let ED=class extends Zs{};ED=_([te({type:X.Sequence})],ED);let r3=class extends Ir{};r3=_([te({type:X.Choice})],r3);let SD=n9=class extends Pc{constructor(e){super(e),Object.setPrototypeOf(this,n9.prototype)}};SD=n9=_([te({type:X.Sequence})],SD);let xD=i9=class extends ut{constructor(e){super(e),Object.setPrototypeOf(this,i9.prototype)}};xD=i9=_([te({type:X.Set,itemType:jh})],xD);let d9=class{constructor(e=""){this.value=e}toString(){return this.value}};_([$({type:F.BmpString})],d9.prototype,"value",void 0);d9=_([te({type:X.Choice})],d9);let h9=class extends me{};h9=_([te({type:X.Sequence})],h9);let AD=s9=class extends ut{constructor(e){super(e),Object.setPrototypeOf(this,s9.prototype)}};AD=s9=_([te({type:X.Sequence,itemType:h9})],AD);var f9;let n3=f9=class extends ut{constructor(e){super(e),Object.setPrototypeOf(this,f9.prototype)}};n3=f9=_([te({type:X.Sequence,itemType:Ho})],n3);class Gh{constructor(e={}){this.version=0,this.subject=new Wt,this.subjectPKInfo=new ss,this.attributes=new n3,Object.assign(this,e)}}_([$({type:F.Integer})],Gh.prototype,"version",void 0);_([$({type:Wt})],Gh.prototype,"subject",void 0);_([$({type:ss})],Gh.prototype,"subjectPKInfo",void 0);_([$({type:n3,implicit:!0,context:0})],Gh.prototype,"attributes",void 0);class fp{constructor(e={}){this.certificationRequestInfo=new Gh,this.signatureAlgorithm=new me,this.signature=new ArrayBuffer(0),Object.assign(this,e)}}_([$({type:Gh})],fp.prototype,"certificationRequestInfo",void 0);_([$({type:me})],fp.prototype,"signatureAlgorithm",void 0);_([$({type:F.BitString})],fp.prototype,"signature",void 0);/*!
 * MIT License
 * 
 * Copyright (c) Peculiar Ventures. All rights reserved.
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 * 
 */const h0="crypto.algorithm";class Ave{getAlgorithms(){return kr.resolveAll(h0)}toAsnAlgorithm(e){({...e});for(const t of this.getAlgorithms()){const n=t.toAsnAlgorithm(e);if(n)return n}if(/^[0-9.]+$/.test(e.name)){const t=new me({algorithm:e.name});if("parameters"in e){const n=e;t.parameters=n.parameters}return t}throw new Error("Cannot convert WebCrypto algorithm to ASN.1 algorithm")}toWebAlgorithm(e){for(const n of this.getAlgorithms()){const i=n.toWebAlgorithm(e);if(i)return i}return{name:e.algorithm,parameters:e.parameters}}}const du="crypto.algorithmProvider";kr.registerSingleton(du,Ave);var h2;const Un="1.3.36.3.3.2.8.1.1",CD=`${Un}.1`,ID=`${Un}.2`,kD=`${Un}.3`,_D=`${Un}.4`,TD=`${Un}.5`,PD=`${Un}.6`,DD=`${Un}.7`,$D=`${Un}.8`,ND=`${Un}.9`,MD=`${Un}.10`,OD=`${Un}.11`,RD=`${Un}.12`,LD=`${Un}.13`,BD=`${Un}.14`,UD="brainpoolP160r1",FD="brainpoolP160t1",zD="brainpoolP192r1",VD="brainpoolP192t1",KD="brainpoolP224r1",jD="brainpoolP224t1",HD="brainpoolP256r1",qD="brainpoolP256t1",WD="brainpoolP320r1",GD="brainpoolP320t1",QD="brainpoolP384r1",YD="brainpoolP384t1",JD="brainpoolP512r1",XD="brainpoolP512t1",Ot="ECDSA";let pp=h2=class{toAsnAlgorithm(e){switch(e.name.toLowerCase()){case Ot.toLowerCase():if("hash"in e)switch((typeof e.hash=="string"?e.hash:e.hash.name).toLowerCase()){case"sha-1":return Gbe;case"sha-256":return Qbe;case"sha-384":return Ybe;case"sha-512":return Jbe}else if("namedCurve"in e){let t="";switch(e.namedCurve){case"P-256":t=nD;break;case"K-256":t=h2.SECP256K1;break;case"P-384":t=iD;break;case"P-521":t=sD;break;case UD:t=CD;break;case FD:t=ID;break;case zD:t=kD;break;case VD:t=_D;break;case KD:t=TD;break;case jD:t=PD;break;case HD:t=DD;break;case qD:t=$D;break;case WD:t=ND;break;case GD:t=MD;break;case QD:t=OD;break;case YD:t=RD;break;case JD:t=LD;break;case XD:t=BD;break}if(t)return new me({algorithm:dp,parameters:ae.serialize(new $c({namedCurve:t}))})}}return null}toWebAlgorithm(e){switch(e.algorithm){case gA:return{name:Ot,hash:{name:"SHA-1"}};case yA:return{name:Ot,hash:{name:"SHA-256"}};case mA:return{name:Ot,hash:{name:"SHA-384"}};case wA:return{name:Ot,hash:{name:"SHA-512"}};case dp:{if(!e.parameters)throw new TypeError("Cannot get required parameters from EC algorithm");switch(ae.parse(e.parameters,$c).namedCurve){case nD:return{name:Ot,namedCurve:"P-256"};case h2.SECP256K1:return{name:Ot,namedCurve:"K-256"};case iD:return{name:Ot,namedCurve:"P-384"};case sD:return{name:Ot,namedCurve:"P-521"};case CD:return{name:Ot,namedCurve:UD};case ID:return{name:Ot,namedCurve:FD};case kD:return{name:Ot,namedCurve:zD};case _D:return{name:Ot,namedCurve:VD};case TD:return{name:Ot,namedCurve:KD};case PD:return{name:Ot,namedCurve:jD};case DD:return{name:Ot,namedCurve:HD};case $D:return{name:Ot,namedCurve:qD};case ND:return{name:Ot,namedCurve:WD};case MD:return{name:Ot,namedCurve:GD};case OD:return{name:Ot,namedCurve:QD};case RD:return{name:Ot,namedCurve:YD};case LD:return{name:Ot,namedCurve:JD};case BD:return{name:Ot,namedCurve:XD}}}}return null}};pp.SECP256K1="1.3.132.0.10";pp=h2=_([T4()],pp);kr.registerSingleton(h0,pp);const nH=Symbol("name"),iH=Symbol("value");class st{constructor(e,t={},n=""){this[nH]=e,this[iH]=n;for(const i in t)this[i]=t[i]}}st.NAME=nH;st.VALUE=iH;class Cve{static toTextObject(e){const t=new st("Algorithm Identifier",{},Kc.toString(e.algorithm));if(e.parameters)switch(e.algorithm){case dp:{const n=new pp().toWebAlgorithm(e);n&&"namedCurve"in n?t["Named Curve"]=n.namedCurve:t.Parameters=e.parameters;break}default:t.Parameters=e.parameters}return t}}class Kc{static toString(e){const t=this.items[e];return t||e}}Kc.items={[Qm]:"sha1",[jj]:"sha224",[Ym]:"sha256",[Jm]:"sha384",[Xm]:"sha512",[cu]:"rsaEncryption",[qm]:"sha1WithRSAEncryption",[nve]:"sha224WithRSAEncryption",[H7]:"sha256WithRSAEncryption",[Wm]:"sha384WithRSAEncryption",[Gm]:"sha512WithRSAEncryption",[dp]:"ecPublicKey",[gA]:"ecdsaWithSHA1",[zj]:"ecdsaWithSHA224",[yA]:"ecdsaWithSHA256",[mA]:"ecdsaWithSHA384",[wA]:"ecdsaWithSHA512",[zbe]:"TLS WWW server authentication",[Vbe]:"TLS WWW client authentication",[Kbe]:"Code Signing",[jbe]:"E-mail Protection",[Hbe]:"Time Stamping",[qbe]:"OCSP Signing",[Wbe]:"Signed Data"};class hu{static serialize(e){return this.serializeObj(e).join(`
`)}static pad(e=0){return"".padStart(2*e," ")}static serializeObj(e,t=0){const n=[];let i=this.pad(t++),s="";const o=e[st.VALUE];o&&(s=` ${o}`),n.push(`${i}${e[st.NAME]}:${s}`),i=this.pad(t);for(const a in e){if(typeof a=="symbol")continue;const c=e[a],l=a?`${a}: `:"";if(typeof c=="string"||typeof c=="number"||typeof c=="boolean")n.push(`${i}${l}${c}`);else if(c instanceof Date)n.push(`${i}${l}${c.toUTCString()}`);else if(Array.isArray(c))for(const d of c)d[st.NAME]=a,n.push(...this.serializeObj(d,t));else if(c instanceof st)c[st.NAME]=a,n.push(...this.serializeObj(c,t));else if(de.isBufferSource(c))a?(n.push(`${i}${l}`),n.push(...this.serializeBufferSource(c,t+1))):n.push(...this.serializeBufferSource(c,t));else if("toTextObject"in c){const d=c.toTextObject();d[st.NAME]=a,n.push(...this.serializeObj(d,t))}else throw new TypeError("Cannot serialize data in text format. Unsupported type.")}return n}static serializeBufferSource(e,t=0){const n=this.pad(t),i=de.toUint8Array(e),s=[];for(let o=0;o<i.length;){const a=[];for(let c=0;c<16&&o<i.length;c++){c===8&&a.push("");const l=i[o++].toString(16).padStart(2,"0");a.push(l)}s.push(`${n}${a.join(" ")}`)}return s}static serializeAlgorithm(e){return this.algorithmSerializer.toTextObject(e)}}hu.oidSerializer=Kc;hu.algorithmSerializer=Cve;class jc{constructor(...e){if(e.length===1){const t=e[0];this.rawData=ae.serialize(t),this.onInit(t)}else{const t=ae.parse(e[0],e[1]);this.rawData=de.toArrayBuffer(e[0]),this.onInit(t)}}equal(e){return e instanceof jc?mK(e.rawData,this.rawData):!1}toString(e="text"){switch(e){case"asn":return ae.toString(this.rawData);case"text":return hu.serialize(this.toTextObject());case"hex":return Se.ToHex(this.rawData);case"base64":return Se.ToBase64(this.rawData);case"base64url":return Se.ToBase64Url(this.rawData);default:throw TypeError("Argument 'format' is unsupported value")}}getTextName(){return this.constructor.NAME}toTextObject(){const e=this.toTextObjectEmpty();return e[""]=this.rawData,e}toTextObjectEmpty(e){return new st(this.getTextName(),{},e)}}jc.NAME="ASN";class Bi extends jc{constructor(...e){let t;de.isBufferSource(e[0])?t=de.toArrayBuffer(e[0]):t=ae.serialize(new Mi({extnID:e[0],critical:e[1],extnValue:new et(de.toArrayBuffer(e[2]))})),super(t,Mi)}onInit(e){this.type=e.extnID,this.critical=e.critical,this.value=e.extnValue.buffer}toTextObject(){const e=this.toTextObjectWithoutValue();return e[""]=this.value,e}toTextObjectWithoutValue(){const e=this.toTextObjectEmpty(this.critical?"critical":void 0);return e[st.NAME]===Bi.NAME&&(e[st.NAME]=Kc.toString(this.type)),e}}var sH;class Xa{static isCryptoKeyPair(e){return e&&e.privateKey&&e.publicKey}static isCryptoKey(e){return e&&e.usages&&e.type&&e.algorithm&&e.extractable!==void 0}constructor(){this.items=new Map,this[sH]="CryptoProvider",typeof self<"u"&&typeof crypto<"u"?this.set(Xa.DEFAULT,crypto):typeof global<"u"&&global.crypto&&global.crypto.subtle&&this.set(Xa.DEFAULT,global.crypto)}clear(){this.items.clear()}delete(e){return this.items.delete(e)}forEach(e,t){return this.items.forEach(e,t)}has(e){return this.items.has(e)}get size(){return this.items.size}entries(){return this.items.entries()}keys(){return this.items.keys()}values(){return this.items.values()}[Symbol.iterator](){return this.items[Symbol.iterator]()}get(e=Xa.DEFAULT){const t=this.items.get(e.toLowerCase());if(!t)throw new Error(`Cannot get Crypto by name '${e}'`);return t}set(e,t){if(typeof e=="string"){if(!t)throw new TypeError("Argument 'value' is required");this.items.set(e.toLowerCase(),t)}else this.items.set(Xa.DEFAULT,e);return this}}sH=Symbol.toStringTag;Xa.DEFAULT="default";const br=new Xa,Ive=/^[0-2](?:\.[1-9][0-9]*)+$/;function kve(r){return new RegExp(Ive).test(r)}class oH{constructor(e={}){this.items={};for(const t in e)this.register(t,e[t])}get(e){return this.items[e]||null}findId(e){return kve(e)?e:this.get(e)}register(e,t){this.items[e]=t,this.items[t]=e}}const Ln=new oH;Ln.register("CN","2.5.4.3");Ln.register("L","2.5.4.7");Ln.register("ST","2.5.4.8");Ln.register("O","2.5.4.10");Ln.register("OU","2.5.4.11");Ln.register("C","2.5.4.6");Ln.register("DC","0.9.2342.19200300.100.1.25");Ln.register("E","1.2.840.113549.1.9.1");Ln.register("G","2.5.4.42");Ln.register("I","2.5.4.43");Ln.register("SN","2.5.4.4");Ln.register("T","2.5.4.12");function _ve(r,e){return`\\${Se.ToHex(Se.FromUtf8String(e)).toUpperCase()}`}function Tve(r){return r.replace(/([,+"\\<>;])/g,"\\$1").replace(/^([ #])/,"\\$1").replace(/([ ]$)/,"\\$1").replace(/([\r\n\t])/,_ve)}class ki{static isASCII(e){for(let t=0;t<e.length;t++)if(e.charCodeAt(t)>255)return!1;return!0}static isPrintableString(e){return/^[A-Za-z0-9 '()+,-./:=?]*$/g.test(e)}constructor(e,t={}){this.extraNames=new oH,this.asn=new Wt;for(const n in t)if(Object.prototype.hasOwnProperty.call(t,n)){const i=t[n];this.extraNames.register(n,i)}typeof e=="string"?this.asn=this.fromString(e):e instanceof Wt?this.asn=e:de.isBufferSource(e)?this.asn=ae.parse(e,Wt):this.asn=this.fromJSON(e)}getField(e){const t=this.extraNames.findId(e)||Ln.findId(e),n=[];for(const i of this.asn)for(const s of i)s.type===t&&n.push(s.value.toString());return n}getName(e){return this.extraNames.get(e)||Ln.get(e)}toString(){return this.asn.map(e=>e.map(t=>{const n=this.getName(t.type)||t.type,i=t.value.anyValue?`#${Se.ToHex(t.value.anyValue)}`:Tve(t.value.toString());return`${n}=${i}`}).join("+")).join(", ")}toJSON(){var e;const t=[];for(const n of this.asn){const i={};for(const s of n){const o=this.getName(s.type)||s.type;(e=i[o])!==null&&e!==void 0||(i[o]=[]),i[o].push(s.value.anyValue?`#${Se.ToHex(s.value.anyValue)}`:s.value.toString())}t.push(i)}return t}fromString(e){const t=new Wt,n=/(\d\.[\d.]*\d|[A-Za-z]+)=((?:"")|(?:".*?[^\\]")|(?:[^,+].*?(?:[^\\][,+]))|(?:))([,+])?/g;let i=null,s=",";for(;i=n.exec(`${e},`);){let[,o,a]=i;const c=a[a.length-1];(c===","||c==="+")&&(a=a.slice(0,a.length-1),i[3]=c);const l=i[3];o=this.getTypeOid(o);const d=this.createAttribute(o,a);s==="+"?t[t.length-1].push(d):t.push(new ph([d])),s=l}return t}fromJSON(e){const t=new Wt;for(const n of e){const i=new ph;for(const s in n){const o=this.getTypeOid(s),a=n[s];for(const c of a){const l=this.createAttribute(o,c);i.push(l)}}t.push(i)}return t}getTypeOid(e){if(/[\d.]+/.test(e)||(e=this.getName(e)||""),!e)throw new Error(`Cannot get OID for name type '${e}'`);return e}createAttribute(e,t){const n=new l4({type:e});if(typeof t=="object")for(const i in t)switch(i){case"ia5String":n.value.ia5String=t[i];break;case"utf8String":n.value.utf8String=t[i];break;case"universalString":n.value.universalString=t[i];break;case"bmpString":n.value.bmpString=t[i];break;case"printableString":n.value.printableString=t[i];break}else if(t[0]==="#")n.value.anyValue=Se.FromHex(t.slice(1));else{const i=this.processStringValue(t);e===this.getName("E")||e===this.getName("DC")?n.value.ia5String=i:ki.isPrintableString(i)?n.value.printableString=i:n.value.utf8String=i}return n}processStringValue(e){const t=/"(.*?[^\\])?"/.exec(e);return t&&(e=t[1]),e.replace(/\\0a/ig,`
`).replace(/\\0d/ig,"\r").replace(/\\0g/ig,"	").replace(/\\(.)/g,"$1")}toArrayBuffer(){return ae.serialize(this.asn)}async getThumbprint(...e){var t;let n,i="SHA-1";return e.length>=1&&!(!((t=e[0])===null||t===void 0)&&t.subtle)?(i=e[0]||i,n=e[1]||br.get()):n=e[0]||br.get(),await n.subtle.digest(i,this.toArrayBuffer())}}const aH="Cannot initialize GeneralName from ASN.1 data.",ZD=`${aH} Unsupported string format in use.`,Pve=`${aH} Value doesn't match to GUID regular expression.`,e$=/^([0-9a-f]{8})-?([0-9a-f]{4})-?([0-9a-f]{4})-?([0-9a-f]{4})-?([0-9a-f]{12})$/i,t$="1.3.6.1.4.1.311.25.1",r$="1.3.6.1.4.1.311.20.2.3",_8="dns",T8="dn",P8="email",D8="ip",$8="url",N8="guid",M8="upn",mg="id";class Za extends jc{constructor(...e){let t;if(e.length===2)switch(e[0]){case T8:{const n=new ki(e[1]).toArrayBuffer(),i=ae.parse(n,Wt);t=new Be({directoryName:i});break}case _8:t=new Be({dNSName:e[1]});break;case P8:t=new Be({rfc822Name:e[1]});break;case N8:{const n=new RegExp(e$,"i").exec(e[1]);if(!n)throw new Error("Cannot parse GUID value. Value doesn't match to regular expression");const i=n.slice(1).map((s,o)=>o<3?Se.ToHex(new Uint8Array(Se.FromHex(s)).reverse()):s).join("");t=new Be({otherName:new ap({typeId:t$,value:ae.serialize(new et(Se.FromHex(i)))})});break}case D8:t=new Be({iPAddress:e[1]});break;case mg:t=new Be({registeredID:e[1]});break;case M8:{t=new Be({otherName:new ap({typeId:r$,value:ae.serialize(Aj.toASN(e[1]))})});break}case $8:t=new Be({uniformResourceIdentifier:e[1]});break;default:throw new Error("Cannot create GeneralName. Unsupported type of the name")}else de.isBufferSource(e[0])?t=ae.parse(e[0],Be):t=e[0];super(t)}onInit(e){if(e.dNSName!=null)this.type=_8,this.value=e.dNSName;else if(e.rfc822Name!=null)this.type=P8,this.value=e.rfc822Name;else if(e.iPAddress!=null)this.type=D8,this.value=e.iPAddress;else if(e.uniformResourceIdentifier!=null)this.type=$8,this.value=e.uniformResourceIdentifier;else if(e.registeredID!=null)this.type=mg,this.value=e.registeredID;else if(e.directoryName!=null)this.type=T8,this.value=new ki(e.directoryName).toString();else if(e.otherName!=null)if(e.otherName.typeId===t$){this.type=N8;const t=ae.parse(e.otherName.value,et),n=new RegExp(e$,"i").exec(Se.ToHex(t));if(!n)throw new Error(Pve);this.value=n.slice(1).map((i,s)=>s<3?Se.ToHex(new Uint8Array(Se.FromHex(i)).reverse()):i).join("-")}else if(e.otherName.typeId===r$)this.type=M8,this.value=ae.parse(e.otherName.value,Ir).toString();else throw new Error(ZD);else throw new Error(ZD)}toJSON(){return{type:this.type,value:this.value}}toTextObject(){let e;switch(this.type){case T8:case _8:case N8:case D8:case mg:case M8:case $8:e=this.type.toUpperCase();break;case P8:e="Email";break;default:throw new Error("Unsupported GeneralName type")}let t=this.value;return this.type===mg&&(t=Kc.toString(t)),new st(e,void 0,t)}}class gp extends jc{constructor(e){let t;if(e instanceof dn)t=e;else if(Array.isArray(e)){const n=[];for(const i of e)if(i instanceof Be)n.push(i);else{const s=ae.parse(new Za(i.type,i.value).rawData,Be);n.push(s)}t=new dn(n)}else if(de.isBufferSource(e))t=ae.parse(e,dn);else throw new Error("Cannot initialize GeneralNames. Incorrect incoming arguments");super(t)}onInit(e){const t=[];for(const n of e){let i=null;try{i=new Za(n)}catch{continue}t.push(i)}this.items=t}toJSON(){return this.items.map(e=>e.toJSON())}toTextObject(){const e=super.toTextObjectEmpty();for(const t of this.items){const n=t.toTextObject();let i=e[n[st.NAME]];Array.isArray(i)||(i=[],e[n[st.NAME]]=i),i.push(n)}return e}}gp.NAME="GeneralNames";const y1="-{5}",yp="\\n",Dve=`[^${yp}]+`,$ve=`${y1}BEGIN (${Dve}(?=${y1}))${y1}`,Nve=`${y1}END \\1${y1}`,Sh="\\n",Mve=`[^:${yp}]+`,Ove=`(?:[^${yp}]+${Sh}(?: +[^${yp}]+${Sh})*)`,Rve="[a-zA-Z0-9=+/]+",Lve=`(?:${Rve}${Sh})+`,n$=`${$ve}${Sh}(?:((?:${Mve}: ${Ove})+))?${Sh}?(${Lve})${Nve}`;class Yn{static isPem(e){return typeof e=="string"&&new RegExp(n$,"g").test(e)}static decodeWithHeaders(e){e=e.replace(/\r/g,"");const t=new RegExp(n$,"g"),n=[];let i=null;for(;i=t.exec(e);){const s=i[3].replace(new RegExp(`[${yp}]+`,"g"),""),o={type:i[1],headers:[],rawData:Se.FromBase64(s)},a=i[2];if(a){const c=a.split(new RegExp(Sh,"g"));let l=null;for(const d of c){const[h,p]=d.split(/:(.*)/);if(p===void 0){if(!l)throw new Error("Cannot parse PEM string. Incorrect header value");l.value+=h.trim()}else l&&o.headers.push(l),l={key:h,value:p.trim()}}l&&o.headers.push(l)}n.push(o)}return n}static decode(e){return this.decodeWithHeaders(e).map(n=>n.rawData)}static decodeFirst(e){const t=this.decode(e);if(!t.length)throw new RangeError("PEM string doesn't contain any objects");return t[0]}static encode(e,t){if(Array.isArray(e)){const n=new Array;return t?e.forEach(i=>{if(!de.isBufferSource(i))throw new TypeError("Cannot encode array of BufferSource in PEM format. Not all items of the array are BufferSource");n.push(this.encodeStruct({type:t,rawData:de.toArrayBuffer(i)}))}):e.forEach(i=>{if(!("type"in i))throw new TypeError("Cannot encode array of PemStruct in PEM format. Not all items of the array are PemStrut");n.push(this.encodeStruct(i))}),n.join(`
`)}else{if(!t)throw new Error("Required argument 'tag' is missed");return this.encodeStruct({type:t,rawData:de.toArrayBuffer(e)})}}static encodeStruct(e){var t;const n=e.type.toLocaleUpperCase(),i=[];if(i.push(`-----BEGIN ${n}-----`),!((t=e.headers)===null||t===void 0)&&t.length){for(const l of e.headers)i.push(`${l.key}: ${l.value}`);i.push("")}const s=Se.ToBase64(e.rawData);let o,a=0;const c=Array();for(;a<s.length&&(s.length-a<64?o=s.substring(a):(o=s.substring(a,a+64),a+=64),o.length!==0);)if(c.push(o),o.length<64)break;return i.push(...c),i.push(`-----END ${n}-----`),i.join(`
`)}}Yn.CertificateTag="CERTIFICATE";Yn.CrlTag="CRL";Yn.CertificateRequestTag="CERTIFICATE REQUEST";Yn.PublicKeyTag="PUBLIC KEY";Yn.PrivateKeyTag="PRIVATE KEY";class Go extends jc{static isAsnEncoded(e){return de.isBufferSource(e)||typeof e=="string"}static toArrayBuffer(e){if(typeof e=="string"){if(Yn.isPem(e))return Yn.decode(e)[0];if(Se.isHex(e))return Se.FromHex(e);if(Se.isBase64(e))return Se.FromBase64(e);if(Se.isBase64Url(e))return Se.FromBase64Url(e);throw new TypeError("Unsupported format of 'raw' argument. Must be one of DER, PEM, HEX, Base64, or Base4Url")}else{const t=Se.ToBinary(e);return Yn.isPem(t)?Yn.decode(t)[0]:Se.isHex(t)?Se.FromHex(t):Se.isBase64(t)?Se.FromBase64(t):Se.isBase64Url(t)?Se.FromBase64Url(t):de.toArrayBuffer(e)}}constructor(...e){Go.isAsnEncoded(e[0])?super(Go.toArrayBuffer(e[0]),e[1]):super(e[0])}toString(e="pem"){switch(e){case"pem":return Yn.encode(this.rawData,this.tag);default:return super.toString(e)}}}class us extends Go{static async create(e,t=br.get()){if(e instanceof us)return e;if(Xa.isCryptoKey(e)){if(e.type!=="public")throw new TypeError("Public key is required");const n=await t.subtle.exportKey("spki",e);return new us(n)}else{if(e.publicKey)return e.publicKey;if(de.isBufferSource(e))return new us(e);throw new TypeError("Unsupported PublicKeyType")}}constructor(e){Go.isAsnEncoded(e)?super(e,ss):super(e),this.tag=Yn.PublicKeyTag}async export(...e){let t,n=["verify"],i={hash:"SHA-256",...this.algorithm};e.length>1?(i=e[0]||i,n=e[1]||n,t=e[2]||br.get()):t=e[0]||br.get();let s=this.rawData;const o=ae.parse(this.rawData,ss);return o.algorithm.algorithm===g1&&(s=Bve(o,s)),t.subtle.importKey("spki",s,i,!0,n)}onInit(e){const t=kr.resolve(du),n=this.algorithm=t.toWebAlgorithm(e.algorithm);switch(e.algorithm.algorithm){case cu:{const i=ae.parse(e.subjectPublicKey,bA),s=de.toUint8Array(i.modulus);n.publicExponent=de.toUint8Array(i.publicExponent),n.modulusLength=(s[0]?s:s.slice(1)).byteLength<<3;break}}}async getThumbprint(...e){var t;let n,i="SHA-1";return e.length>=1&&!(!((t=e[0])===null||t===void 0)&&t.subtle)?(i=e[0]||i,n=e[1]||br.get()):n=e[0]||br.get(),await n.subtle.digest(i,this.rawData)}async getKeyIdentifier(...e){let t,n="SHA-1";e.length===1?typeof e[0]=="string"?(n=e[0],t=br.get()):t=e[0]:e.length===2?(n=e[0],t=e[1]):t=br.get();const i=ae.parse(this.rawData,ss);return await t.subtle.digest(n,i.subjectPublicKey)}toTextObject(){const e=this.toTextObjectEmpty(),t=ae.parse(this.rawData,ss);switch(e.Algorithm=hu.serializeAlgorithm(t.algorithm),t.algorithm.algorithm){case dp:e["EC Point"]=t.subjectPublicKey;break;case cu:default:e["Raw Data"]=t.subjectPublicKey}return e}}function Bve(r,e){return r.algorithm=new me({algorithm:cu,parameters:null}),e=ae.serialize(r),e}class mp extends Bi{static async create(e,t=!1,n=br.get()){if("name"in e&&"serialNumber"in e)return new mp(e,t);const s=await(await us.create(e,n)).getKeyIdentifier(n);return new mp(Se.ToHex(s),t)}constructor(...e){if(de.isBufferSource(e[0]))super(e[0]);else if(typeof e[0]=="string"){const t=new vl({keyIdentifier:new eA(Se.FromHex(e[0]))});super(l7,e[1],ae.serialize(t))}else{const t=e[0],n=t.name instanceof gp?ae.parse(t.name.rawData,dn):t.name,i=new vl({authorityCertIssuer:n,authorityCertSerialNumber:Se.FromHex(t.serialNumber)});super(l7,e[1],ae.serialize(i))}}onInit(e){super.onInit(e);const t=ae.parse(e.extnValue,vl);t.keyIdentifier&&(this.keyId=Se.ToHex(t.keyIdentifier)),(t.authorityCertIssuer||t.authorityCertSerialNumber)&&(this.certId={name:t.authorityCertIssuer||[],serialNumber:t.authorityCertSerialNumber?Se.ToHex(t.authorityCertSerialNumber):""})}toTextObject(){const e=this.toTextObjectWithoutValue(),t=ae.parse(this.value,vl);return t.authorityCertIssuer&&(e["Authority Issuer"]=new gp(t.authorityCertIssuer).toTextObject()),t.authorityCertSerialNumber&&(e["Authority Serial Number"]=t.authorityCertSerialNumber),t.keyIdentifier&&(e[""]=t.keyIdentifier),e}}mp.NAME="Authority Key Identifier";class xA extends Bi{constructor(...e){if(de.isBufferSource(e[0])){super(e[0]);const t=ae.parse(this.value,_m);this.ca=t.cA,this.pathLength=t.pathLenConstraint}else{const t=new _m({cA:e[0],pathLenConstraint:e[1]});super(Ij,e[2],ae.serialize(t)),this.ca=e[0],this.pathLength=e[1]}}toTextObject(){const e=this.toTextObjectWithoutValue();return this.ca&&(e.CA=this.ca),this.pathLength!==void 0&&(e["Path Length"]=this.pathLength),e}}xA.NAME="Basic Constraints";var i$;(function(r){r.serverAuth="1.3.6.1.5.5.7.3.1",r.clientAuth="1.3.6.1.5.5.7.3.2",r.codeSigning="1.3.6.1.5.5.7.3.3",r.emailProtection="1.3.6.1.5.5.7.3.4",r.timeStamping="1.3.6.1.5.5.7.3.8",r.ocspSigning="1.3.6.1.5.5.7.3.9"})(i$||(i$={}));class cH extends Bi{constructor(...e){if(de.isBufferSource(e[0])){super(e[0]);const t=ae.parse(this.value,$m);this.usages=t.map(n=>n)}else{const t=new $m(e[0]);super(Tj,e[1],ae.serialize(t)),this.usages=e[0]}}toTextObject(){const e=this.toTextObjectWithoutValue();return e[""]=this.usages.map(t=>Kc.toString(t)).join(", "),e}}cH.NAME="Extended Key Usages";var s$;(function(r){r[r.digitalSignature=1]="digitalSignature",r[r.nonRepudiation=2]="nonRepudiation",r[r.keyEncipherment=4]="keyEncipherment",r[r.dataEncipherment=8]="dataEncipherment",r[r.keyAgreement=16]="keyAgreement",r[r.keyCertSign=32]="keyCertSign",r[r.cRLSign=64]="cRLSign",r[r.encipherOnly=128]="encipherOnly",r[r.decipherOnly=256]="decipherOnly"})(s$||(s$={}));class lH extends Bi{constructor(...e){if(de.isBufferSource(e[0])){super(e[0]);const t=ae.parse(this.value,k8);this.usages=t.toNumber()}else{const t=new k8(e[0]);super(Pj,e[1],ae.serialize(t)),this.usages=e[0]}}toTextObject(){const e=this.toTextObjectWithoutValue(),t=ae.parse(this.value,k8);return e[""]=t.toJSON().join(", "),e}}lH.NAME="Key Usages";class M4 extends Bi{static async create(e,t=!1,n=br.get()){const s=await(await us.create(e,n)).getKeyIdentifier(n);return new M4(Se.ToHex(s),t)}constructor(...e){if(de.isBufferSource(e[0])){super(e[0]);const t=ae.parse(this.value,gc);this.keyId=Se.ToHex(t)}else{const t=typeof e[0]=="string"?Se.FromHex(e[0]):e[0],n=new gc(t);super(Mj,e[1],ae.serialize(n)),this.keyId=Se.ToHex(t)}}toTextObject(){const e=this.toTextObjectWithoutValue(),t=ae.parse(this.value,gc);return e[""]=t,e}}M4.NAME="Subject Key Identifier";class uH extends Bi{constructor(...e){de.isBufferSource(e[0])?super(e[0]):super(Nj,e[1],new gp(e[0]||[]).rawData)}onInit(e){super.onInit(e);const t=ae.parse(e.extnValue,A7);this.names=new gp(t)}toTextObject(){const e=this.toTextObjectWithoutValue(),t=this.names.toTextObject();for(const n in t)e[n]=t[n];return e}}uH.NAME="Subject Alternative Name";class Ui{static register(e,t){this.items.set(e,t)}static create(e){const t=new Bi(e),n=this.items.get(t.type);return n?new n(e):t}}Ui.items=new Map;class dH extends Bi{constructor(...e){var t;if(de.isBufferSource(e[0])){super(e[0]);const n=ae.parse(this.value,Pm);this.policies=n.map(i=>i.policyIdentifier)}else{const n=e[0],i=(t=e[1])!==null&&t!==void 0?t:!1,s=new Pm(n.map(o=>new d4({policyIdentifier:o})));super(kj,i,ae.serialize(s)),this.policies=n}}toTextObject(){const e=this.toTextObjectWithoutValue();return e.Policy=this.policies.map(t=>new st("",{},Kc.toString(t))),e}}dH.NAME="Certificate Policies";Ui.register(kj,dH);class hH extends Bi{constructor(...e){var t;if(de.isBufferSource(e[0]))super(e[0]);else if(Array.isArray(e[0])&&typeof e[0][0]=="string"){const i=e[0].map(o=>new Vh({distributionPoint:new iu({fullName:[new Be({uniformResourceIdentifier:o})]})})),s=new xd(i);super(p7,e[1],ae.serialize(s))}else{const n=new xd(e[0]);super(p7,e[1],ae.serialize(n))}(t=this.distributionPoints)!==null&&t!==void 0||(this.distributionPoints=[])}onInit(e){super.onInit(e);const t=ae.parse(e.extnValue,xd);this.distributionPoints=t}toTextObject(){const e=this.toTextObjectWithoutValue();return e["Distribution Point"]=this.distributionPoints.map(t=>{var n;const i={};return t.distributionPoint&&(i[""]=(n=t.distributionPoint.fullName)===null||n===void 0?void 0:n.map(s=>new Za(s).toString()).join(", ")),t.reasons&&(i.Reasons=t.reasons.toString()),t.cRLIssuer&&(i["CRL Issuer"]=t.cRLIssuer.map(s=>s.toString()).join(", ")),i}),e}}hH.NAME="CRL Distribution Points";class fH extends Bi{constructor(...e){var t,n,i,s;if(de.isBufferSource(e[0]))super(e[0]);else if(e[0]instanceof id){const o=new id(e[0]);super(c7,e[1],ae.serialize(o))}else{const o=e[0],a=new id;bg(a,o,VP,"ocsp"),bg(a,o,KP,"caIssuers"),bg(a,o,jP,"timeStamping"),bg(a,o,HP,"caRepository"),super(c7,e[1],ae.serialize(a))}(t=this.ocsp)!==null&&t!==void 0||(this.ocsp=[]),(n=this.caIssuers)!==null&&n!==void 0||(this.caIssuers=[]),(i=this.timeStamping)!==null&&i!==void 0||(this.timeStamping=[]),(s=this.caRepository)!==null&&s!==void 0||(this.caRepository=[])}onInit(e){super.onInit(e),this.ocsp=[],this.caIssuers=[],this.timeStamping=[],this.caRepository=[],ae.parse(e.extnValue,id).forEach(n=>{switch(n.accessMethod){case VP:this.ocsp.push(new Za(n.accessLocation));break;case KP:this.caIssuers.push(new Za(n.accessLocation));break;case jP:this.timeStamping.push(new Za(n.accessLocation));break;case HP:this.caRepository.push(new Za(n.accessLocation));break}})}toTextObject(){const e=this.toTextObjectWithoutValue();return this.ocsp.length&&wg(e,"OCSP",this.ocsp),this.caIssuers.length&&wg(e,"CA Issuers",this.caIssuers),this.timeStamping.length&&wg(e,"Time Stamping",this.timeStamping),this.caRepository.length&&wg(e,"CA Repository",this.caRepository),e}}fH.NAME="Authority Info Access";function wg(r,e,t){if(t.length===1)r[e]=t[0].toTextObject();else{const n=new st("");t.forEach((i,s)=>{const o=i.toTextObject(),a=`${o[st.NAME]} ${s+1}`;let c=n[a];Array.isArray(c)||(c=[],n[a]=c),c.push(o)}),r[e]=n}}function bg(r,e,t,n){const i=e[n];i&&(Array.isArray(i)?i:[i]).forEach(o=>{typeof o=="string"&&(o=new Za("url",o)),r.push(new e0({accessMethod:t,accessLocation:ae.parse(o.rawData,Be)}))})}class Qh extends jc{constructor(...e){let t;if(de.isBufferSource(e[0]))t=de.toArrayBuffer(e[0]);else{const n=e[0],i=Array.isArray(e[1])?e[1].map(s=>de.toArrayBuffer(s)):[];t=ae.serialize(new Ho({type:n,values:i}))}super(t,Ho)}onInit(e){this.type=e.type,this.values=e.values}toTextObject(){const e=this.toTextObjectWithoutValue();return e.Value=this.values.map(t=>new st("",{"":t})),e}toTextObjectWithoutValue(){const e=this.toTextObjectEmpty();return e[st.NAME]===Qh.NAME&&(e[st.NAME]=Kc.toString(this.type)),e}}Qh.NAME="Attribute";class pH extends Qh{constructor(...e){var t;if(de.isBufferSource(e[0]))super(e[0]);else{const n=new r3({printableString:e[0]});super(rH,[ae.serialize(n)])}(t=this.password)!==null&&t!==void 0||(this.password="")}onInit(e){if(super.onInit(e),this.values[0]){const t=ae.parse(this.values[0],r3);this.password=t.toString()}}toTextObject(){const e=this.toTextObjectWithoutValue();return e[st.VALUE]=this.password,e}}pH.NAME="Challenge Password";class AA extends Qh{constructor(...e){var t;if(de.isBufferSource(e[0]))super(e[0]);else{const n=e[0],i=new Pc;for(const s of n)i.push(ae.parse(s.rawData,Mi));super(SA,[ae.serialize(i)])}(t=this.items)!==null&&t!==void 0||(this.items=[])}onInit(e){if(super.onInit(e),this.values[0]){const t=ae.parse(this.values[0],Pc);this.items=t.map(n=>Ui.create(ae.serialize(n)))}}toTextObject(){const e=this.toTextObjectWithoutValue(),t=this.items.map(n=>n.toTextObject());for(const n of t)e[n[st.NAME]]=n;return e}}AA.NAME="Extensions";class O4{static register(e,t){this.items.set(e,t)}static create(e){const t=new Qh(e),n=this.items.get(t.type);return n?new n(e):t}}O4.items=new Map;const f0="crypto.signatureFormatter";class Uve{toAsnSignature(e,t){return de.toArrayBuffer(t)}toWebSignature(e,t){return de.toArrayBuffer(t)}}var f2;let p9=f2=class{static createPssParams(e,t){const n=f2.getHashAlgorithm(e);return n?new uu({hashAlgorithm:n,maskGenAlgorithm:new me({algorithm:C4,parameters:ae.serialize(n)}),saltLength:t}):null}static getHashAlgorithm(e){const t=kr.resolve(du);return typeof e=="string"?t.toAsnAlgorithm({name:e}):typeof e=="object"&&e&&"name"in e?t.toAsnAlgorithm(e):null}toAsnAlgorithm(e){switch(e.name.toLowerCase()){case"rsassa-pkcs1-v1_5":if("hash"in e){let t;if(typeof e.hash=="string")t=e.hash;else if(e.hash&&typeof e.hash=="object"&&"name"in e.hash&&typeof e.hash.name=="string")t=e.hash.name.toUpperCase();else throw new Error("Cannot get hash algorithm name");switch(t.toLowerCase()){case"sha-1":return new me({algorithm:qm,parameters:null});case"sha-256":return new me({algorithm:H7,parameters:null});case"sha-384":return new me({algorithm:Wm,parameters:null});case"sha-512":return new me({algorithm:Gm,parameters:null})}}else return new me({algorithm:cu,parameters:null});break;case"rsa-pss":if("hash"in e){if(!("saltLength"in e&&typeof e.saltLength=="number"))throw new Error("Cannot get 'saltLength' from 'alg' argument");const t=f2.createPssParams(e.hash,e.saltLength);if(!t)throw new Error("Cannot create PSS parameters");return new me({algorithm:g1,parameters:ae.serialize(t)})}else return new me({algorithm:g1,parameters:null})}return null}toWebAlgorithm(e){switch(e.algorithm){case cu:return{name:"RSASSA-PKCS1-v1_5"};case qm:return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-1"}};case H7:return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}};case Wm:return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-384"}};case Gm:return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-512"}};case g1:if(e.parameters){const t=ae.parse(e.parameters,uu);return{name:"RSA-PSS",hash:kr.resolve(du).toWebAlgorithm(t.hashAlgorithm),saltLength:t.saltLength}}else return{name:"RSA-PSS"}}return null}};p9=f2=_([T4()],p9);kr.registerSingleton(h0,p9);let g9=class{toAsnAlgorithm(e){switch(e.name.toLowerCase()){case"sha-1":return new me({algorithm:Qm});case"sha-256":return new me({algorithm:Ym});case"sha-384":return new me({algorithm:Jm});case"sha-512":return new me({algorithm:Xm})}return null}toWebAlgorithm(e){switch(e.algorithm){case Qm:return{name:"SHA-1"};case Ym:return{name:"SHA-256"};case Jm:return{name:"SHA-384"};case Xm:return{name:"SHA-512"}}return null}};g9=_([T4()],g9);kr.registerSingleton(h0,g9);class _i{addPadding(e,t){const n=de.toUint8Array(t),i=new Uint8Array(e);return i.set(n,e-n.length),i}removePadding(e,t=!1){let n=de.toUint8Array(e);for(let i=0;i<n.length;i++)if(n[i]){n=n.slice(i);break}if(t&&n[0]>127){const i=new Uint8Array(n.length+1);return i.set(n,1),i.buffer}return n.buffer}toAsnSignature(e,t){if(e.name==="ECDSA"){const n=e.namedCurve,i=_i.namedCurveSize.get(n)||_i.defaultNamedCurveSize,s=new Hm,o=de.toUint8Array(t);return s.r=this.removePadding(o.slice(0,i),!0),s.s=this.removePadding(o.slice(i,i+i),!0),ae.serialize(s)}return null}toWebSignature(e,t){if(e.name==="ECDSA"){const n=ae.parse(t,Hm),i=e.namedCurve,s=_i.namedCurveSize.get(i)||_i.defaultNamedCurveSize,o=this.addPadding(s,this.removePadding(n.r)),a=this.addPadding(s,this.removePadding(n.s));return k8e(o,a)}return null}}_i.namedCurveSize=new Map;_i.defaultNamedCurveSize=32;const O8="1.3.101.110",o$="1.3.101.111",R8="1.3.101.112",a$="1.3.101.113";let y9=class{toAsnAlgorithm(e){let t=null;switch(e.name.toLowerCase()){case"ed25519":t=R8;break;case"x25519":t=O8;break;case"eddsa":switch(e.namedCurve.toLowerCase()){case"ed25519":t=R8;break;case"ed448":t=a$;break}break;case"ecdh-es":switch(e.namedCurve.toLowerCase()){case"x25519":t=O8;break;case"x448":t=o$;break}}return t?new me({algorithm:t}):null}toWebAlgorithm(e){switch(e.algorithm){case R8:return{name:"Ed25519"};case a$:return{name:"EdDSA",namedCurve:"Ed448"};case O8:return{name:"X25519"};case o$:return{name:"ECDH-ES",namedCurve:"X448"}}return null}};y9=_([T4()],y9);kr.registerSingleton(h0,y9);class Fve extends Go{constructor(e){Go.isAsnEncoded(e)?super(e,fp):super(e),this.tag=Yn.CertificateRequestTag}onInit(e){this.tbs=ae.serialize(e.certificationRequestInfo),this.publicKey=new us(e.certificationRequestInfo.subjectPKInfo);const t=kr.resolve(du);this.signatureAlgorithm=t.toWebAlgorithm(e.signatureAlgorithm),this.signature=e.signature,this.attributes=e.certificationRequestInfo.attributes.map(i=>O4.create(ae.serialize(i)));const n=this.getAttribute(SA);this.extensions=[],n instanceof AA&&(this.extensions=n.items),this.subjectName=new ki(e.certificationRequestInfo.subject),this.subject=this.subjectName.toString()}getAttribute(e){for(const t of this.attributes)if(t.type===e)return t;return null}getAttributes(e){return this.attributes.filter(t=>t.type===e)}getExtension(e){for(const t of this.extensions)if(t.type===e)return t;return null}getExtensions(e){return this.extensions.filter(t=>t.type===e)}async verify(e=br.get()){const t={...this.publicKey.algorithm,...this.signatureAlgorithm},n=await this.publicKey.export(t,["verify"],e),i=kr.resolveAll(f0).reverse();let s=null;for(const a of i)if(s=a.toWebSignature(t,this.signature),s)break;if(!s)throw Error("Cannot convert WebCrypto signature value to ASN.1 format");return await e.subtle.verify(this.signatureAlgorithm,n,s,this.tbs)}toTextObject(){const e=this.toTextObjectEmpty(),t=ae.parse(this.rawData,fp),n=t.certificationRequestInfo,i=new st("",{Version:`${su[n.version]} (${n.version})`,Subject:this.subject,"Subject Public Key Info":this.publicKey});if(this.attributes.length){const s=new st("");for(const o of this.attributes){const a=o.toTextObject();s[a[st.NAME]]=a}i.Attributes=s}return e.Data=i,e.Signature=new st("",{Algorithm:hu.serializeAlgorithm(t.signatureAlgorithm),"":t.signature}),e}}Fve.NAME="PKCS#10 Certificate Request";class CA extends Go{constructor(e){Go.isAsnEncoded(e)?super(e,ou):super(e),this.tag=Yn.CertificateTag}onInit(e){const t=e.tbsCertificate;this.tbs=ae.serialize(t),this.serialNumber=Se.ToHex(t.serialNumber),this.subjectName=new ki(t.subject),this.subject=new ki(t.subject).toString(),this.issuerName=new ki(t.issuer),this.issuer=this.issuerName.toString();const n=kr.resolve(du);this.signatureAlgorithm=n.toWebAlgorithm(e.signatureAlgorithm),this.signature=e.signatureValue;const i=t.validity.notBefore.utcTime||t.validity.notBefore.generalTime;if(!i)throw new Error("Cannot get 'notBefore' value");this.notBefore=i;const s=t.validity.notAfter.utcTime||t.validity.notAfter.generalTime;if(!s)throw new Error("Cannot get 'notAfter' value");this.notAfter=s,this.extensions=[],t.extensions&&(this.extensions=t.extensions.map(o=>Ui.create(ae.serialize(o)))),this.publicKey=new us(t.subjectPublicKeyInfo)}getExtension(e){for(const t of this.extensions)if(typeof e=="string"){if(t.type===e)return t}else if(t instanceof e)return t;return null}getExtensions(e){return this.extensions.filter(t=>typeof e=="string"?t.type===e:t instanceof e)}async verify(e={},t=br.get()){let n,i;const s=e.publicKey;try{if(!s)n={...this.publicKey.algorithm,...this.signatureAlgorithm},i=await this.publicKey.export(n,["verify"],t);else if("publicKey"in s)n={...s.publicKey.algorithm,...this.signatureAlgorithm},i=await s.publicKey.export(n,["verify"],t);else if(s instanceof us)n={...s.algorithm,...this.signatureAlgorithm},i=await s.export(n,["verify"],t);else if(de.isBufferSource(s)){const l=new us(s);n={...l.algorithm,...this.signatureAlgorithm},i=await l.export(n,["verify"],t)}else n={...s.algorithm,...this.signatureAlgorithm},i=s}catch{return!1}const o=kr.resolveAll(f0).reverse();let a=null;for(const l of o)if(a=l.toWebSignature(n,this.signature),a)break;if(!a)throw Error("Cannot convert ASN.1 signature value to WebCrypto format");const c=await t.subtle.verify(this.signatureAlgorithm,i,a,this.tbs);if(e.signatureOnly)return c;{const d=(e.date||new Date).getTime();return c&&this.notBefore.getTime()<d&&d<this.notAfter.getTime()}}async getThumbprint(...e){let t,n="SHA-1";return e[0]&&(e[0].subtle?t=e[0]:(n=e[0]||n,t=e[1])),t??(t=br.get()),await t.subtle.digest(n,this.rawData)}async isSelfSigned(e=br.get()){return this.subject===this.issuer&&await this.verify({signatureOnly:!0},e)}toTextObject(){const e=this.toTextObjectEmpty(),t=ae.parse(this.rawData,ou),n=t.tbsCertificate,i=new st("",{Version:`${su[n.version]} (${n.version})`,"Serial Number":n.serialNumber,"Signature Algorithm":hu.serializeAlgorithm(n.signature),Issuer:this.issuer,Validity:new st("",{"Not Before":n.validity.notBefore.getTime(),"Not After":n.validity.notAfter.getTime()}),Subject:this.subject,"Subject Public Key Info":this.publicKey});if(n.issuerUniqueID&&(i["Issuer Unique ID"]=n.issuerUniqueID),n.subjectUniqueID&&(i["Subject Unique ID"]=n.subjectUniqueID),this.extensions.length){const s=new st("");for(const o of this.extensions){const a=o.toTextObject();s[a[st.NAME]]=a}i.Extensions=s}return e.Data=i,e.Signature=new st("",{Algorithm:hu.serializeAlgorithm(t.signatureAlgorithm),"":t.signatureValue}),e}}CA.NAME="Certificate";class zve{static async createSelfSigned(e,t=br.get()){if(!e.keys.privateKey)throw new Error("Bad field 'keys' in 'params' argument. 'privateKey' is empty");if(!e.keys.publicKey)throw new Error("Bad field 'keys' in 'params' argument. 'publicKey' is empty");return this.create({serialNumber:e.serialNumber,subject:e.name,issuer:e.name,notBefore:e.notBefore,notAfter:e.notAfter,publicKey:e.keys.publicKey,signingKey:e.keys.privateKey,signingAlgorithm:e.signingAlgorithm,extensions:e.extensions},t)}static async create(e,t=br.get()){var n;let i;e.publicKey instanceof us?i=e.publicKey.rawData:"publicKey"in e.publicKey?i=e.publicKey.publicKey.rawData:de.isBufferSource(e.publicKey)?i=e.publicKey:i=await t.subtle.exportKey("spki",e.publicKey);const s=e.serialNumber?de.toUint8Array(Se.FromHex(e.serialNumber)):t.getRandomValues(new Uint8Array(16));s[0]>127&&(s[0]&=127),s.length>1&&s[0]===0&&(s[1]|=128);const o=e.notBefore||new Date,a=e.notAfter||new Date(o.getTime()+31536e6),c=new ou({tbsCertificate:new di({version:su.v3,serialNumber:s,validity:new t0({notBefore:o,notAfter:a}),extensions:new Pc(((n=e.extensions)===null||n===void 0?void 0:n.map(v=>ae.parse(v.rawData,Mi)))||[]),subjectPublicKeyInfo:ae.parse(i,ss)})});if(e.subject){const v=e.subject instanceof ki?e.subject:new ki(e.subject);c.tbsCertificate.subject=ae.parse(v.toArrayBuffer(),Wt)}if(e.issuer){const v=e.issuer instanceof ki?e.issuer:new ki(e.issuer);c.tbsCertificate.issuer=ae.parse(v.toArrayBuffer(),Wt)}const l={hash:"SHA-256"},d="signingKey"in e?{...l,...e.signingAlgorithm,...e.signingKey.algorithm}:{...l,...e.signingAlgorithm},h=kr.resolve(du);c.tbsCertificate.signature=c.signatureAlgorithm=h.toAsnAlgorithm(d);const p=ae.serialize(c.tbsCertificate),m="signingKey"in e?await t.subtle.sign(d,e.signingKey,p):e.signature,f=kr.resolveAll(f0).reverse();let g=null;for(const v of f)if(g=v.toAsnSignature(d,m),g)break;if(!g)throw Error("Cannot convert ASN.1 signature value to WebCrypto format");return c.signatureValue=g,new CA(ae.serialize(c))}}var c$;(function(r){r[r.unspecified=0]="unspecified",r[r.keyCompromise=1]="keyCompromise",r[r.cACompromise=2]="cACompromise",r[r.affiliationChanged=3]="affiliationChanged",r[r.superseded=4]="superseded",r[r.cessationOfOperation=5]="cessationOfOperation",r[r.certificateHold=6]="certificateHold",r[r.removeFromCRL=8]="removeFromCRL",r[r.privilegeWithdrawn=9]="privilegeWithdrawn",r[r.aACompromise=10]="aACompromise"})(c$||(c$={}));Ui.register(Ij,xA);Ui.register(Tj,cH);Ui.register(Pj,lH);Ui.register(Mj,M4);Ui.register(l7,mp);Ui.register(Nj,uH);Ui.register(p7,hH);Ui.register(c7,fH);O4.register(rH,pH);O4.register(SA,AA);kr.registerSingleton(f0,Uve);kr.registerSingleton(f0,_i);_i.namedCurveSize.set("P-256",32);_i.namedCurveSize.set("K-256",32);_i.namedCurveSize.set("P-384",48);_i.namedCurveSize.set("P-521",66);function gH(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function Vve(r){return new TextEncoder().encode(r)}function Kve(r){return new TextDecoder().decode(r)}function jve(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var i=0;i<r.length;i++){var s=r.charAt(i),o=s.charCodeAt(0);if(t[o]!==255)throw new TypeError(s+" is ambiguous");t[o]=i}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),d=Math.log(256)/Math.log(a);function h(f){if(f instanceof Uint8Array||(ArrayBuffer.isView(f)?f=new Uint8Array(f.buffer,f.byteOffset,f.byteLength):Array.isArray(f)&&(f=Uint8Array.from(f))),!(f instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(f.length===0)return"";for(var g=0,v=0,y=0,w=f.length;y!==w&&f[y]===0;)y++,g++;for(var b=(w-y)*d+1>>>0,E=new Uint8Array(b);y!==w;){for(var A=f[y],k=0,x=b-1;(A!==0||k<v)&&x!==-1;x--,k++)A+=256*E[x]>>>0,E[x]=A%a>>>0,A=A/a>>>0;if(A!==0)throw new Error("Non-zero carry");v=k,y++}for(var I=b-v;I!==b&&E[I]===0;)I++;for(var T=c.repeat(g);I<b;++I)T+=r.charAt(E[I]);return T}function p(f){if(typeof f!="string")throw new TypeError("Expected String");if(f.length===0)return new Uint8Array;var g=0;if(f[g]!==" "){for(var v=0,y=0;f[g]===c;)v++,g++;for(var w=(f.length-g)*l+1>>>0,b=new Uint8Array(w);f[g];){var E=t[f.charCodeAt(g)];if(E===255)return;for(var A=0,k=w-1;(E!==0||A<y)&&k!==-1;k--,A++)E+=a*b[k]>>>0,b[k]=E%256>>>0,E=E/256>>>0;if(E!==0)throw new Error("Non-zero carry");y=A,g++}if(f[g]!==" "){for(var x=w-y;x!==w&&b[x]===0;)x++;for(var I=new Uint8Array(v+(w-x)),T=v;x!==w;)I[T++]=b[x++];return I}}}function m(f){var g=p(f);if(g)return g;throw new Error(`Non-${e} character`)}return{encode:h,decodeUnsafe:p,decode:m}}var Hve=jve,qve=Hve;let Wve=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseEncode");this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},Gve=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseDecode");u(this,"prefixCodePoint");this.name=e,this.prefix=t;const i=t.codePointAt(0);if(i===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=i,this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return yH(this,e)}},Qve=class{constructor(e){u(this,"decoders");this.decoders=e}or(e){return yH(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};function yH(r,e){return new Qve({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}let Yve=class{constructor(e,t,n,i){u(this,"name");u(this,"prefix");u(this,"baseEncode");u(this,"baseDecode");u(this,"encoder");u(this,"decoder");this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=i,this.encoder=new Wve(e,t,n),this.decoder=new Gve(e,t,i)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};function R4({name:r,prefix:e,encode:t,decode:n}){return new Yve(r,e,t,n)}function p0({name:r,prefix:e,alphabet:t}){const{encode:n,decode:i}=qve(t,r);return R4({prefix:e,name:r,encode:n,decode:s=>gH(i(s))})}function Jve(r,e,t,n){const i={};for(let d=0;d<e.length;++d)i[e[d]]=d;let s=r.length;for(;r[s-1]==="=";)--s;const o=new Uint8Array(s*t/8|0);let a=0,c=0,l=0;for(let d=0;d<s;++d){const h=i[r[d]];if(h===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|h,a+=t,a>=8&&(a-=8,o[l++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o}function Xve(r,e,t){const n=e[e.length-1]==="=",i=(1<<t)-1;let s="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,s+=e[i&a>>o];if(o!==0&&(s+=e[i&a<<t-o]),n)for(;s.length*t&7;)s+="=";return s}function Pr({name:r,prefix:e,bitsPerChar:t,alphabet:n}){return R4({prefix:e,name:r,encode(i){return Xve(i,n,t)},decode(i){return Jve(i,n,t,r)}})}const Zve=Pr({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),e7e=Pr({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),IA=Pr({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),t7e=Pr({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),r7e=Object.freeze(Object.defineProperty({__proto__:null,base64:Zve,base64pad:e7e,base64url:IA,base64urlpad:t7e},Symbol.toStringTag,{value:"Module"}));var n7e=mH,l$=128,i7e=-128,s7e=Math.pow(2,31);function mH(r,e,t){e=e||[],t=t||0;for(var n=t;r>=s7e;)e[t++]=r&255|l$,r/=128;for(;r&i7e;)e[t++]=r&255|l$,r>>>=7;return e[t]=r|0,mH.bytes=t-n+1,e}var o7e=m9,a7e=128,u$=127;function m9(r,n){var t=0,n=n||0,i=0,s=n,o,a=r.length;do{if(s>=a)throw m9.bytes=0,new RangeError("Could not decode varint");o=r[s++],t+=i<28?(o&u$)<<i:(o&u$)*Math.pow(2,i),i+=7}while(o>=a7e);return m9.bytes=s-n,t}var c7e=Math.pow(2,7),l7e=Math.pow(2,14),u7e=Math.pow(2,21),d7e=Math.pow(2,28),h7e=Math.pow(2,35),f7e=Math.pow(2,42),p7e=Math.pow(2,49),g7e=Math.pow(2,56),y7e=Math.pow(2,63),m7e=function(r){return r<c7e?1:r<l7e?2:r<u7e?3:r<d7e?4:r<h7e?5:r<f7e?6:r<p7e?7:r<g7e?8:r<y7e?9:10},w7e={encode:n7e,decode:o7e,encodingLength:m7e},i3=w7e;function d$(r,e=0){return[i3.decode(r,e),i3.decode.bytes]}function h$(r,e,t=0){return i3.encode(r,e,t),e}function f$(r){return i3.encodingLength(r)}function s3(r,e){const t=e.byteLength,n=f$(r),i=n+f$(t),s=new Uint8Array(i+t);return h$(r,s,0),h$(t,s,n),s.set(e,i),new wH(r,t,e,s)}function b7e(r){const e=gH(r),[t,n]=d$(e),[i,s]=d$(e.subarray(n)),o=e.subarray(n+s);if(o.byteLength!==i)throw new Error("Incorrect length");return new wH(t,i,o,e)}let wH=class{constructor(e,t,n,i){u(this,"code");u(this,"size");u(this,"digest");u(this,"bytes");this.code=e,this.size=t,this.digest=n,this.bytes=i}};function v7e({name:r,code:e,encode:t}){return new E7e(r,e,t)}let E7e=class{constructor(e,t,n){u(this,"name");u(this,"code");u(this,"encode");this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?s3(this.code,t):t.then(n=>s3(this.code,n))}else throw Error("Unknown type, must be binary type")}};function S7e(r){return async e=>new Uint8Array(await crypto.subtle.digest(r,e))}const kA=v7e({name:"sha2-256",code:18,encode:S7e("SHA-256")});class x7e extends er{async listen(){throw new cbe("WebRTCTransport.createListener")}getAddrs(){return[]}updateAnnounceAddrs(){}async close(){}}const A7e=p0({prefix:"9",name:"base10",alphabet:"0123456789"}),C7e=Object.freeze(Object.defineProperty({__proto__:null,base10:A7e},Symbol.toStringTag,{value:"Module"})),I7e=Pr({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),k7e=Pr({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),_7e=Object.freeze(Object.defineProperty({__proto__:null,base16:I7e,base16upper:k7e},Symbol.toStringTag,{value:"Module"})),T7e=Pr({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),P7e=Object.freeze(Object.defineProperty({__proto__:null,base2:T7e},Symbol.toStringTag,{value:"Module"})),bH=Array.from(""),D7e=bH.reduce((r,e,t)=>(r[t]=e,r),[]),$7e=bH.reduce((r,e,t)=>{const n=e.codePointAt(0);if(n==null)throw new Error(`Invalid character: ${e}`);return r[n]=t,r},[]);function N7e(r){return r.reduce((e,t)=>(e+=D7e[t],e),"")}function M7e(r){const e=[];for(const t of r){const n=t.codePointAt(0);if(n==null)throw new Error(`Invalid character: ${t}`);const i=$7e[n];if(i==null)throw new Error(`Non-base256emoji character: ${t}`);e.push(i)}return new Uint8Array(e)}const O7e=R4({prefix:"",name:"base256emoji",encode:N7e,decode:M7e}),R7e=Object.freeze(Object.defineProperty({__proto__:null,base256emoji:O7e},Symbol.toStringTag,{value:"Module"})),L7e=Pr({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),B7e=Pr({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),U7e=Pr({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),F7e=Pr({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),z7e=Pr({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),V7e=Pr({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),K7e=Pr({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),j7e=Pr({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),H7e=Pr({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),q7e=Object.freeze(Object.defineProperty({__proto__:null,base32:L7e,base32hex:z7e,base32hexpad:K7e,base32hexpadupper:j7e,base32hexupper:V7e,base32pad:U7e,base32padupper:F7e,base32upper:B7e,base32z:H7e},Symbol.toStringTag,{value:"Module"})),W7e=p0({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),G7e=p0({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),Q7e=Object.freeze(Object.defineProperty({__proto__:null,base36:W7e,base36upper:G7e},Symbol.toStringTag,{value:"Module"})),Y7e=p0({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),J7e=p0({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),X7e=Object.freeze(Object.defineProperty({__proto__:null,base58btc:Y7e,base58flickr:J7e},Symbol.toStringTag,{value:"Module"})),Z7e=Pr({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),e9e=Object.freeze(Object.defineProperty({__proto__:null,base8:Z7e},Symbol.toStringTag,{value:"Module"})),t9e=R4({prefix:"\0",name:"identity",encode:r=>Kve(r),decode:r=>Vve(r)}),r9e=Object.freeze(Object.defineProperty({__proto__:null,identity:t9e},Symbol.toStringTag,{value:"Module"}));new TextEncoder;new TextDecoder;const n9e={...r9e,...P7e,...e9e,...C7e,..._7e,...q7e,...Q7e,...X7e,...r7e,...R7e},vH=Object.values(n9e).map(r=>r.decoder).reduce((r,e)=>r.or(e)),i9e=/^a=fingerprint:(?:\w+-[0-9]+)\s(?<fingerprint>(:?[0-9a-fA-F]{2})+)$/m;function s9e(r){var t;if(r==null)return;const e=r.match(i9e);return(t=e==null?void 0:e.groups)==null?void 0:t.fingerprint}function EH(r){const t=r.stringTuples().filter(n=>n[0]===D6e).map(n=>n[1])[0];if(t===void 0||t==="")throw new Z(`Couldn't find a certhash component of multiaddr: ${r.toString()}`);return t}function o9e(r){return b7e(vH.decode(r))}function a9e(r){const e=o9e(EH(r)),t=l9e(e.code),n=e.digest.reduce((s,o)=>s+o.toString(16).padStart(2,"0"),""),i=n.match(/.{1,2}/g);if(i==null)throw new abe(n,r.toString());return`${t} ${i.join(":").toUpperCase()}`}function c9e(r){const e=r.split(":").map(i=>parseInt(i,16)),t=Uint8Array.from(e),n=s3(kA.code,t);return Re(`/certhash/${IA.encode(n.bytes)}`)}function l9e(r){switch(r){case 17:return"sha-1";case 18:return"sha-256";case 19:return"sha-512";default:throw new lbe(r)}}function u9e(r,e){const{host:t,port:n,family:i}=r.toOptions(),s=a9e(r);return{type:"answer",sdp:`v=0
o=- 0 0 IN IP${i} ${t}
s=-
t=0 0
a=ice-lite
m=application ${n} UDP/DTLS/SCTP webrtc-datachannel
c=IN IP${i} ${t}
a=mid:0
a=ice-options:ice2
a=ice-ufrag:${e}
a=ice-pwd:${e}
a=fingerprint:${s}
a=setup:passive
a=sctp-port:5000
a=max-message-size:${a4}
a=candidate:1467250027 1 UDP 1467250027 ${t} ${n} typ host
a=end-of-candidates
`}}function d9e(r,e){const{host:t,port:n,family:i}=r.toOptions();return{type:"offer",sdp:`v=0
o=- 0 0 IN IP${i} ${t}
s=-
c=IN IP${i} ${t}
t=0 0
a=ice-options:ice2,trickle
m=application ${n} UDP/DTLS/SCTP webrtc-datachannel
a=mid:0
a=setup:active
a=ice-ufrag:${e}
a=ice-pwd:${e}
a=fingerprint:sha-256 00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00
a=sctp-port:5000
a=max-message-size:${a4}
a=candidate:1467250027 1 UDP 1467250027 ${t} ${n} typ host
a=end-of-candidates
`}}function p$(r,e){if(r.sdp===void 0)throw new Z("Can't munge a missing SDP");const t=r.sdp.includes(`\r
`)?`\r
`:`
`;return r.sdp=r.sdp.replace(/\na=ice-ufrag:[^\n]*\n/,`
a=ice-ufrag:`+e+t).replace(/\na=ice-pwd:[^\n]*\n/,`
a=ice-pwd:`+e+t),r}const L8=oe("libp2p-webrtc-noise:");function h9e(r,e,t){const n=r.trim().toLowerCase().replaceAll(":",""),i=oe(n,"hex"),s=s3(kA.code,i),o=vH.decode(EH(e)),a=L8.byteLength+s.bytes.byteLength+o.byteLength;return ir(t==="server"?[L8,o,s.bytes]:[L8,s.bytes,o],a)}const f9e=qx?"iceconnectionstatechange":"connectionstatechange";async function p9e(r,e,t){var i,s,o;const n=r.createDataChannel("",{negotiated:!0,id:0});try{if(t.role==="client"){t.log.trace("client creating local offer");const f=await r.createOffer();t.log.trace("client created local offer %s",f.sdp);const g=p$(f,e);t.log.trace("client setting local offer %s",g.sdp),await r.setLocalDescription(g);const v=u9e(t.remoteAddr,e);t.log.trace("client setting server description %s",v.sdp),await r.setRemoteDescription(v)}else{const f=d9e(t.remoteAddr,e);t.log.trace("server setting client %s %s",f.type,f.sdp),await r.setRemoteDescription(f),t.log.trace("server creating local answer");const g=await r.createAnswer();t.log.trace("server created local answer");const v=p$(g,e);t.log.trace("server setting local description %s",g.sdp),await r.setLocalDescription(v)}if(n.readyState!=="open"&&(t.log.trace("%s wait for handshake channel to open, starting status %s",t.role,n.readyState),await Ci(n,"open",t.signal)),t.log.trace("%s handshake channel opened",t.role),t.role==="server"){const f=((i=r.remoteFingerprint())==null?void 0:i.value)??"";t.remoteAddr=t.remoteAddr.encapsulate(c9e(f))}const a=s9e((s=r.localDescription)==null?void 0:s.sdp);if(a==null)throw new Zp("Could not get fingerprint from local description sdp");t.log.trace("%s performing noise handshake",t.role);const c=h9e(a,t.remoteAddr,t.role),l=EV({prologueBytes:c})(t),d=Im({channel:n,direction:"outbound",handshake:!0,logger:t.logger,...t.dataChannel??{}}),h=new r7(t,{peerConnection:r,remoteAddr:t.remoteAddr,timeline:{open:Date.now()},metrics:t.events});r.addEventListener(f9e,()=>{switch(r.connectionState){case"failed":case"disconnected":case"closed":h.close().catch(f=>{t.log.error("error closing connection",f),h.abort(f)});break;default:break}}),(o=t.events)==null||o.increment({peer_connection:!0});const p=new Wx(t,{peerConnection:r,metrics:t.events,dataChannelOptions:t.dataChannel});if(t.role==="client")return t.log.trace("%s secure inbound",t.role),await l.secureInbound(d,{remotePeer:t.remotePeerId,signal:t.signal,skipStreamMuxerNegotiation:!0}),t.log.trace("%s upgrade outbound",t.role),await t.upgrader.upgradeOutbound(h,{skipProtection:!0,skipEncryption:!0,muxerFactory:p,signal:t.signal});t.log.trace("%s secure outbound",t.role);const m=await l.secureOutbound(d,{remotePeer:t.remotePeerId,signal:t.signal,skipStreamMuxerNegotiation:!0});h.remoteAddr=h.remoteAddr.encapsulate(`/p2p/${m.remotePeer}`),t.log.trace("%s upgrade inbound",t.role),await t.upgrader.upgradeInbound(h,{skipProtection:!0,skipEncryption:!0,muxerFactory:p,signal:t.signal})}catch(a){throw n.close(),a}}async function g9e(r,e,t,n){n==null&&(n=await RTCPeerConnection.generateCertificate({name:"ECDSA",namedCurve:"P-256"}));const i=typeof t=="function"?await t():t;return new RTCPeerConnection({...i??{},certificates:[n]})}async function y9e(r){const e=await fU(r),t=await crypto.subtle.exportKey("pkcs8",e.privateKey);return["-----BEGIN PRIVATE KEY-----",...re(new Uint8Array(t),"base64pad").split(/(.{64})/).filter(Boolean),"-----END PRIVATE KEY-----"].join(`
`)}var tM,rM,nM;nM=X3,rM=Symbol.toStringTag,tM=fr;class m9e{constructor(e,t={}){u(this,"log");u(this,"metrics");u(this,"components");u(this,"init");u(this,"certificate");u(this,"privateKey");u(this,"emitter");u(this,"renewCertificateTask");u(this,nM,!0);u(this,rM,"@libp2p/webrtc-direct");u(this,tM,["@libp2p/transport"]);if(this.log=e.logger.forComponent("libp2p:webrtc-direct"),this.components=e,this.init=t,this.emitter=new er,t.certificateLifespan!=null&&t.certificateRenewalThreshold!=null&&t.certificateRenewalThreshold>=t.certificateLifespan)throw new Z("Certificate renewal threshold must be less than certificate lifespan");e.metrics!=null&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_webrtc-direct_dialer_events_total",{label:"event",help:"Total count of WebRTC-direct dial events by type"})})}async start(){this.certificate=await this.getCertificate()}async stop(){this.renewCertificateTask!=null&&clearTimeout(this.renewCertificateTask),this.certificate=void 0}async dial(e,t){var a;this.log("dial %a",e),t.signal.throwIfAborted();let n;const i=e.getPeerId();i!=null&&(n=Jt(i));const s=nbe(),o=await g9e("client",s,typeof this.init.rtcConfiguration=="function"?await this.init.rtcConfiguration():this.init.rtcConfiguration??{});try{return await p9e(o,s,{role:"client",log:this.log,logger:this.components.logger,metrics:this.components.metrics,events:(a=this.metrics)==null?void 0:a.dialerEvents,signal:t.signal,remoteAddr:e,dataChannel:this.init.dataChannel,upgrader:t.upgrader,peerId:this.components.peerId,remotePeerId:n,privateKey:this.components.privateKey})}catch(c){throw o.close(),c}}createListener(e){if(this.certificate==null)throw new ql;return new x7e(this.components,{...this.init,...e,certificate:this.certificate,emitter:this.emitter})}listenFilter(e){return e.filter(rv.exactMatch)}dialFilter(e){return this.listenFilter(e)}async getCertificate(e){if(w9e(this.init.certificate))return this.log("using provided TLS certificate"),this.init.certificate;const t=await this.loadOrCreatePrivateKey(),{pem:n,certhash:i}=await this.loadOrCreateCertificate(t,e);return{privateKey:await y9e(t),pem:n,certhash:i}}async loadOrCreatePrivateKey(){if(this.privateKey!=null)return this.privateKey;const e=this.init.certificateKeychainName??F6e,t=this.getKeychain();try{if(t==null)throw this.log("no keychain configured - not checking for stored private key"),new Zt;this.log.trace("checking for stored private key"),this.privateKey=await t.exportKey(e)}catch(n){if(n.name!=="NotFoundError")throw n;this.log.trace("generating private key"),this.privateKey=await dw("ECDSA","P-256"),t!=null?(this.log.trace("storing private key"),await t.importKey(e,this.privateKey)):this.log("no keychain configured - not storing private key")}return this.privateKey}async loadOrCreateCertificate(e,t){if(this.certificate!=null&&t!==!0)return this.certificate;let n;const i=new Et(this.init.certificateDatastoreKey??U6e),s=await fU(e);try{if(t===!0)throw this.log.trace("forcing renewal of TLS certificate"),new Zt;this.log.trace("checking for stored TLS certificate"),n=await this.loadCertificate(i,s)}catch(a){if(a.name!=="NotFoundError")throw a;this.log.trace("generating new TLS certificate"),n=await this.createCertificate(i,s)}let o=n.notAfter.getTime()-(this.init.certificateRenewalThreshold??$P)-Date.now();return o<0&&(o=100),this.log("will renew TLS certificate after %d ms",o),this.renewCertificateTask=setTimeout(()=>{this.log("renewing TLS certificate"),this.getCertificate(!0).then(a=>{this.certificate=a,this.emitter.safeDispatchEvent("certificate:renew",{detail:a})}).catch(a=>{this.log.error("could not renew certificate - %e",a)})},o),{pem:n.toString("pem"),certhash:IA.encode((await kA.digest(new Uint8Array(n.rawData))).bytes)}}async loadCertificate(e,t){const n=await this.components.datastore.get(e),i=new CA(n),s=i.notAfter.getTime()-(this.init.certificateRenewalThreshold??$P);if(Date.now()>s)throw this.log("stored TLS certificate has expired"),new Zt;this.log("loaded certificate, expires in %d ms",s);const o=await i.publicKey.export(crypto),a=await crypto.subtle.exportKey("raw",o),c=await crypto.subtle.exportKey("raw",t.publicKey);if(!He(new Uint8Array(a,0,a.byteLength),new Uint8Array(c,0,c.byteLength)))throw this.log("stored TLS certificate public key did not match public key from private key"),new Zt;return this.log("loaded certificate, expiry time is %o",s),i}async createCertificate(e,t){const n=new Date,i=new Date(Date.now()+(this.init.certificateLifespan??z6e));n.setMilliseconds(0),i.setMilliseconds(0);const s=await zve.createSelfSigned({serialNumber:(BigInt(Math.random().toString().replace(".",""))*100000n).toString(16),name:"CN=example.com, C=US, L=CA, O=example, ST=CA",notBefore:n,notAfter:i,keys:t,extensions:[new xA(!1,void 0,!0)]},crypto);return this.getKeychain()!=null?(this.log.trace("storing TLS certificate"),await this.components.datastore.put(e,oe(s.toString("pem")))):this.log("no keychain is configured so not storing TLS certificate since the private key will not be reused"),s}getKeychain(){try{return this.components.keychain}catch{}}}function w9e(r){return r==null?!1:typeof r.privateKey=="string"&&typeof r.pem=="string"&&typeof r.certhash=="string"}function b9e(r){return e=>new m9e(e,r)}function _A(r){return e=>new fbe(e,r)}const v9e=async r=>{if(r.readyState>=2)throw new Error("socket closed");r.readyState!==1&&await new Promise((e,t)=>{function n(){r.removeEventListener("open",i),r.removeEventListener("error",s)}function i(){n(),e()}function s(o){n(),t(o.error??new Error(`connect ECONNREFUSED ${r.url}`))}r.addEventListener("open",i),r.addEventListener("error",s)})},E9e=(r,e)=>(e=e??{},e.closeOnEnd=e.closeOnEnd!==!1,async n=>{for await(const i of n){try{await v9e(r)}catch(s){if(s.message==="socket closed")break;throw s}if(r.readyState===r.CLOSING||r.readyState===r.CLOSED)break;r.send(i)}e.closeOnEnd!=null&&r.readyState<=1&&await new Promise((i,s)=>{r.addEventListener("close",o=>{if(o.wasClean||o.code===1006)i();else{const a=Object.assign(new Error("ws error"),{event:o});s(a)}}),setTimeout(()=>{r.close()})})});var L4={},B4={};Object.defineProperty(B4,"__esModule",{value:!0});class S9e{constructor(){this.pullQueue=[],this.pushQueue=[],this.eventHandlers={},this.isPaused=!1,this.isStopped=!1}push(e){if(this.isStopped)return;const t={value:e,done:!1};if(this.pullQueue.length){const n=this.pullQueue.shift();n&&n.resolve(t)}else this.pushQueue.push(Promise.resolve(t)),this.highWaterMark!==void 0&&this.pushQueue.length>=this.highWaterMark&&!this.isPaused&&(this.isPaused=!0,this.eventHandlers.highWater?this.eventHandlers.highWater():console&&console.warn(`EventIterator queue reached ${this.pushQueue.length} items`))}stop(){if(!this.isStopped){this.isStopped=!0,this.remove();for(const e of this.pullQueue)e.resolve({value:void 0,done:!0});this.pullQueue.length=0}}fail(e){if(!this.isStopped)if(this.isStopped=!0,this.remove(),this.pullQueue.length){for(const t of this.pullQueue)t.reject(e);this.pullQueue.length=0}else{const t=Promise.reject(e);t.catch(()=>{}),this.pushQueue.push(t)}}remove(){Promise.resolve().then(()=>{this.removeCallback&&this.removeCallback()})}[Symbol.asyncIterator](){return{next:e=>{const t=this.pushQueue.shift();return t?(this.lowWaterMark!==void 0&&this.pushQueue.length<=this.lowWaterMark&&this.isPaused&&(this.isPaused=!1,this.eventHandlers.lowWater&&this.eventHandlers.lowWater()),t):this.isStopped?Promise.resolve({value:void 0,done:!0}):new Promise((n,i)=>{this.pullQueue.push({resolve:n,reject:i})})},return:()=>(this.isStopped=!0,this.pushQueue.length=0,this.remove(),Promise.resolve({value:void 0,done:!0}))}}}let SH=class{constructor(e,{highWaterMark:t=100,lowWaterMark:n=1}={}){const i=new S9e;i.highWaterMark=t,i.lowWaterMark=n,i.removeCallback=e({push:s=>i.push(s),stop:()=>i.stop(),fail:s=>i.fail(s),on:(s,o)=>{i.eventHandlers[s]=o}})||(()=>{}),this[Symbol.asyncIterator]=()=>i[Symbol.asyncIterator](),Object.freeze(this)}};B4.EventIterator=SH;B4.default=SH;Object.defineProperty(L4,"__esModule",{value:!0});const TA=B4;var x9e=L4.EventIterator=TA.EventIterator;function A9e(r,e,t){return new TA.EventIterator(({push:n})=>(this.addEventListener(r,n,e),()=>this.removeEventListener(r,n,e)),t)}L4.subscribe=A9e;L4.default=TA.EventIterator;function g$(r){var e;return r instanceof ArrayBuffer||((e=r==null?void 0:r.constructor)==null?void 0:e.name)==="ArrayBuffer"&&typeof(r==null?void 0:r.byteLength)=="number"}const C9e=r=>{r.binaryType="arraybuffer";const e=async()=>{await new Promise((s,o)=>{if(n){s();return}if(i!=null){o(i);return}const a=d=>{r.removeEventListener("open",c),r.removeEventListener("error",l),d()},c=()=>{a(s)},l=d=>{a(()=>{o(d.error??new Error(`connect ECONNREFUSED ${r.url}`))})};r.addEventListener("open",c),r.addEventListener("error",l)})},t=async function*(){const s=new x9e(({push:o,stop:a,fail:c})=>{const l=h=>{let p=null;typeof h.data=="string"&&(p=oe(h.data)),g$(h.data)&&(p=new Uint8Array(h.data)),h.data instanceof Uint8Array&&(p=h.data),p!=null&&o(p)},d=h=>{c(h.error??new Error("Socket error"))};return r.addEventListener("message",l),r.addEventListener("error",d),r.addEventListener("close",a),()=>{r.removeEventListener("message",l),r.removeEventListener("error",d),r.removeEventListener("close",a)}},{highWaterMark:1/0});await e();for await(const o of s)yield g$(o)?new Uint8Array(o):o}();let n=r.readyState===1,i;return r.addEventListener("open",()=>{n=!0,i=null}),r.addEventListener("close",()=>{n=!1,i=null}),r.addEventListener("error",s=>{n||(i=s.error??new Error(`connect ECONNREFUSED ${r.url}`))}),Object.assign(t,{connected:e})},I9e=(r,e)=>{e=e??{};const t=C9e(r);let n=e.remoteAddress,i=e.remotePort;if(r.url!=null)try{const o=new URL(r.url);n=o.hostname,i=parseInt(o.port,10)}catch{}if(n==null||i==null)throw new Error("Remote connection did not have address and/or port");return{sink:E9e(r,e),source:t,connected:async()=>{await t.connected()},close:async()=>{(r.readyState===r.CONNECTING||r.readyState===r.OPEN)&&await new Promise(o=>{r.addEventListener("close",()=>{o()}),r.close()})},destroy:()=>{r.terminate!=null?r.terminate():r.close()},remoteAddress:n,remotePort:i,socket:r}},k9e=WebSocket,_9e={"http:":"ws:","https:":"wss:"},y$="ws:",T9e=(r,e)=>{if(r.startsWith("//")&&(r=`${(e==null?void 0:e.protocol)??y$}${r}`),r.startsWith("/")&&e!=null){const n=e.protocol??y$,i=e.host,s=e.port!=null&&(i==null?void 0:i.endsWith(`:${e.port}`))!==!0?`:${e.port}`:"";r=`${n}//${i}${s}${r}`}const t=new URL(r);for(const[n,i]of Object.entries(_9e))t.protocol===n&&(t.protocol=i);return t};function P9e(r,e){const t=typeof window>"u"?void 0:window.location;e=e??{};const n=T9e(r,t),i=new k9e(n.toString(),e.websocket);return I9e(i,e)}function D9e(r){return r.filter(e=>zy.exactMatch(e)||X1.exactMatch(e))}function $9e(){throw new Error("WebSocket Servers can not be created in the browser!")}const N9e=500;function M9e(r,e,t){const n=t.logger.forComponent("libp2p:websockets:maconn"),i=t.metrics,s=t.metricPrefix??"",o={log:n,async sink(a){try{await r.sink(async function*(){for await(const c of a)c instanceof Uint8Array?yield c:yield c.subarray()}())}catch(c){c.type!=="aborted"&&n.error(c)}},source:r.source,remoteAddr:e,timeline:{open:Date.now()},async close(a={}){var d,h;const c=Date.now();if(a.signal==null){const p=AbortSignal.timeout(N9e);a={...a,signal:p}}const l=()=>{const{host:p,port:m}=o.remoteAddr.toOptions();n("timeout closing stream to %s:%s after %dms, destroying it manually",p,m,Date.now()-c),this.abort(new Hl("Socket close timeout"))};(d=a.signal)==null||d.addEventListener("abort",l);try{await r.close()}catch(p){n.error("error closing WebSocket gracefully",p),this.abort(p)}finally{(h=a.signal)==null||h.removeEventListener("abort",l),o.timeline.close=Date.now()}},abort(a){const{host:c,port:l}=o.remoteAddr.toOptions();n("timeout closing stream to %s:%s due to error",c,l,a),r.destroy(),o.timeline.close=Date.now(),i==null||i.increment({[`${s}error`]:!0})}};return r.socket.addEventListener("close",()=>{i==null||i.increment({[`${s}close`]:!0}),o.timeline.close==null&&(o.timeline.close=Date.now())},{once:!0}),o}var iM,sM,oM;oM=X3,sM=Symbol.toStringTag,iM=fr;class O9e{constructor(e,t={}){u(this,"log");u(this,"init");u(this,"logger");u(this,"metrics");u(this,"components");u(this,oM,!0);u(this,sM,"@libp2p/websockets");u(this,iM,["@libp2p/transport"]);this.log=e.logger.forComponent("libp2p:websockets"),this.logger=e.logger,this.components=e,this.init=t,e.metrics!=null&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_websockets_dialer_events_total",{label:"event",help:"Total count of WebSockets dialer events by type"})})}async dial(e,t){var o;this.log("dialing %s",e),t=t??{};const n=await this._connect(e,t),i=M9e(n,e,{logger:this.logger,metrics:(o=this.metrics)==null?void 0:o.dialerEvents});this.log("new outbound connection %s",i.remoteAddr);const s=await t.upgrader.upgradeOutbound(i,t);return this.log("outbound connection %s upgraded",i.remoteAddr),s}async _connect(e,t){var o,a,c,l,d;(o=t==null?void 0:t.signal)==null||o.throwIfAborted();const n=e.toOptions();this.log("dialing %s:%s",n.host,n.port);const i=Le(),s=P9e(_z(e),this.init);s.socket.addEventListener("error",()=>{var p;const h=new nS(`Could not connect to ${e.toString()}`);this.log.error("connection error:",h),(p=this.metrics)==null||p.dialerEvents.increment({error:!0}),i.reject(h)});try{(a=t.onProgress)==null||a.call(t,new _e("websockets:open-connection")),await cn(Promise.race([s.connected(),i.promise]),t.signal)}catch(h){throw(c=t.signal)!=null&&c.aborted&&((l=this.metrics)==null||l.dialerEvents.increment({abort:!0})),s.close().catch(p=>{this.log.error("error closing raw socket",p)}),h}return this.log("connected %s",e),(d=this.metrics)==null||d.dialerEvents.increment({connect:!0}),s}createListener(e){return $9e({logger:this.logger,events:this.components.events,metrics:this.components.metrics},{...this.init,...e})}listenFilter(e){var t,n;return e=Array.isArray(e)?e:[e],((t=this.init)==null?void 0:t.filter)!=null?(n=this.init)==null?void 0:n.filter(e):D9e(e)}dialFilter(e){return this.listenFilter(e)}}function PA(r={}){return e=>new O9e(e,r)}function R9e(r,e){const t=e.map((n,i)=>({record:qp(n),index:i}));return t.sort((n,i)=>{const s=n.record.sequence,o=i.record.sequence;if(s>o)return-1;if(s<o)return 1;if(n.record.validityType===ls.ValidityType.EOL&&i.record.validityType===ls.ValidityType.EOL){const a=uv.fromString(n.record.validity).toDate(),c=uv.fromString(i.record.validity).toDate();if(a.getTime()>c.getTime())return-1;if(a.getTime()<c.getTime())return 1}return 0}),t[0].index}const xH="2.8.5",AH="js-libp2p";function CH(r,e){return`${r??AH}/${e??xH} browser/${globalThis.navigator.userAgent}`}const L9e="5.3.0",B9e="helia",U9e={list:["/dnsaddr/bootstrap.libp2p.io/p2p/QmNnooDu7bfjPFoTZYxMNLWUQJyrVwtbZg5gBMjTezGAJN","/dnsaddr/bootstrap.libp2p.io/p2p/QmbLHAnMoJPWSCR5Zhtx6BHJX9KiKNN6tpvbUcqanj75Nb","/dnsaddr/bootstrap.libp2p.io/p2p/QmcZf59bWwK5XFi76CZX8cbJ4BhTzzA3gU1ZjYZcYW3dwt","/dnsaddr/va1.bootstrap.libp2p.io/p2p/12D3KooWKnDdG3iXw9eTFijk3EWSunZcFi54Zka4wmtqtt6rPxc8","/ip4/104.131.131.82/tcp/4001/p2p/QmaCpDMGvV2BGHeYERUEnRQAwe3N8SzbUtfsmvsqQLuvuJ"]};function F9e(r={}){const e=`${B9e}/${L9e} ${CH()}`;return{privateKey:r.privateKey,dns:r.dns,nodeInfo:{userAgent:e},addresses:{listen:["/p2p-circuit","/webrtc"]},transports:[xx(),_A(),b9e(),PA()],connectionEncrypters:[EV()],streamMuxers:[Tye(),v6e()],peerDiscovery:[Sx(U9e)],services:{autoNAT:ume(),dcutr:R3e(),delegatedRouting:()=>S0e("https://delegated-ipfs.dev",nge()),dht:v5e({clientMode:!0,validators:{ipns:Wz},selectors:{ipns:R9e}}),identify:Ax(),identifyPush:Q3e(),keychain:gj(r.keychain),ping:_6e()}}}async function z9e(r,e={}){const t=e.selfKey??"self",n=gj(e)({datastore:r,logger:ww()});let i;return await r.has(new Et(`/pkcs8/${t}`))?i=await n.exportKey(t):(i=await dw(e.keyType??"Ed25519"),await n.importKey(t,i)),i}const V9e=32,{code:K9e}=ze("dnsaddr");class j9e extends Error{constructor(e="Max recursive depth reached"){super(e),this.name="RecursionLimitError"}}const IH=async function(e,t={}){const n=t.maxRecursiveDepth??V9e;if(n===0)throw new j9e("Max recursive depth reached");const[,i]=e.stringTuples().find(([l])=>l===K9e)??[],o=await((t==null?void 0:t.dns)??fF()).query(`_dnsaddr.${i}`,{signal:t==null?void 0:t.signal,types:[Cc.TXT]}),a=e.getPeerId(),c=[];for(const l of o.Answer){const d=l.data.replace(/["']/g,"").trim().split("=")[1];if(d==null||a!=null&&!d.includes(a))continue;const h=Re(d);if(d.startsWith("/dnsaddr")){const p=await h.resolve({...t,maxRecursiveDepth:n-1});c.push(...p.map(m=>m.toString()))}else c.push(h.toString())}return c},H9e={addresses:{listen:[],announce:[],noAnnounce:[],announceFilter:r=>r},connectionManager:{resolvers:{dnsaddr:IH}},transportManager:{faultTolerance:jl.FATAL_ALL}};async function q9e(r){var t,n;const e=$x(H9e,r);if(e.connectionProtector===null&&((n=(t=globalThis.process)==null?void 0:t.env)==null?void 0:n.LIBP2P_FORCE_PNET)!=null)throw new Z("Private network is enforced, but no protector was provided");return e}function W9e(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function DA(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function G9e(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var i=0;i<r.length;i++){var s=r.charAt(i),o=s.charCodeAt(0);if(t[o]!==255)throw new TypeError(s+" is ambiguous");t[o]=i}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),d=Math.log(256)/Math.log(a);function h(f){if(f instanceof Uint8Array||(ArrayBuffer.isView(f)?f=new Uint8Array(f.buffer,f.byteOffset,f.byteLength):Array.isArray(f)&&(f=Uint8Array.from(f))),!(f instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(f.length===0)return"";for(var g=0,v=0,y=0,w=f.length;y!==w&&f[y]===0;)y++,g++;for(var b=(w-y)*d+1>>>0,E=new Uint8Array(b);y!==w;){for(var A=f[y],k=0,x=b-1;(A!==0||k<v)&&x!==-1;x--,k++)A+=256*E[x]>>>0,E[x]=A%a>>>0,A=A/a>>>0;if(A!==0)throw new Error("Non-zero carry");v=k,y++}for(var I=b-v;I!==b&&E[I]===0;)I++;for(var T=c.repeat(g);I<b;++I)T+=r.charAt(E[I]);return T}function p(f){if(typeof f!="string")throw new TypeError("Expected String");if(f.length===0)return new Uint8Array;var g=0;if(f[g]!==" "){for(var v=0,y=0;f[g]===c;)v++,g++;for(var w=(f.length-g)*l+1>>>0,b=new Uint8Array(w);f[g];){var E=t[f.charCodeAt(g)];if(E===255)return;for(var A=0,k=w-1;(E!==0||A<y)&&k!==-1;k--,A++)E+=a*b[k]>>>0,b[k]=E%256>>>0,E=E/256>>>0;if(E!==0)throw new Error("Non-zero carry");y=A,g++}if(f[g]!==" "){for(var x=w-y;x!==w&&b[x]===0;)x++;for(var I=new Uint8Array(v+(w-x)),T=v;x!==w;)I[T++]=b[x++];return I}}}function m(f){var g=p(f);if(g)return g;throw new Error(`Non-${e} character`)}return{encode:h,decodeUnsafe:p,decode:m}}var Q9e=G9e,Y9e=Q9e;class J9e{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseEncode");this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}}class X9e{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseDecode");u(this,"prefixCodePoint");this.name=e,this.prefix=t;const i=t.codePointAt(0);if(i===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=i,this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return kH(this,e)}}class Z9e{constructor(e){u(this,"decoders");this.decoders=e}or(e){return kH(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}}function kH(r,e){return new Z9e({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}class eEe{constructor(e,t,n,i){u(this,"name");u(this,"prefix");u(this,"baseEncode");u(this,"baseDecode");u(this,"encoder");u(this,"decoder");this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=i,this.encoder=new J9e(e,t,n),this.decoder=new X9e(e,t,i)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}}function _H({name:r,prefix:e,encode:t,decode:n}){return new eEe(r,e,t,n)}function U4({name:r,prefix:e,alphabet:t}){const{encode:n,decode:i}=Y9e(t,r);return _H({prefix:e,name:r,encode:n,decode:s=>DA(i(s))})}function tEe(r,e,t,n){const i={};for(let d=0;d<e.length;++d)i[e[d]]=d;let s=r.length;for(;r[s-1]==="=";)--s;const o=new Uint8Array(s*t/8|0);let a=0,c=0,l=0;for(let d=0;d<s;++d){const h=i[r[d]];if(h===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|h,a+=t,a>=8&&(a-=8,o[l++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o}function rEe(r,e,t){const n=e[e.length-1]==="=",i=(1<<t)-1;let s="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,s+=e[i&a>>o];if(o!==0&&(s+=e[i&a<<t-o]),n)for(;s.length*t&7;)s+="=";return s}function la({name:r,prefix:e,bitsPerChar:t,alphabet:n}){return _H({prefix:e,name:r,encode(i){return rEe(i,n,t)},decode(i){return tEe(i,n,t,r)}})}const m1=la({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});la({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5});la({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5});la({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5});la({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5});la({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5});la({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5});la({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5});la({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const B8=U4({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"});U4({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});const Eo=U4({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});U4({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var nEe=TH,m$=128,iEe=-128,sEe=Math.pow(2,31);function TH(r,e,t){e=e||[],t=t||0;for(var n=t;r>=sEe;)e[t++]=r&255|m$,r/=128;for(;r&iEe;)e[t++]=r&255|m$,r>>>=7;return e[t]=r|0,TH.bytes=t-n+1,e}var oEe=w9,aEe=128,w$=127;function w9(r,n){var t=0,n=n||0,i=0,s=n,o,a=r.length;do{if(s>=a)throw w9.bytes=0,new RangeError("Could not decode varint");o=r[s++],t+=i<28?(o&w$)<<i:(o&w$)*Math.pow(2,i),i+=7}while(o>=aEe);return w9.bytes=s-n,t}var cEe=Math.pow(2,7),lEe=Math.pow(2,14),uEe=Math.pow(2,21),dEe=Math.pow(2,28),hEe=Math.pow(2,35),fEe=Math.pow(2,42),pEe=Math.pow(2,49),gEe=Math.pow(2,56),yEe=Math.pow(2,63),mEe=function(r){return r<cEe?1:r<lEe?2:r<uEe?3:r<dEe?4:r<hEe?5:r<fEe?6:r<pEe?7:r<gEe?8:r<yEe?9:10},wEe={encode:nEe,decode:oEe,encodingLength:mEe},o3=wEe;function b9(r,e=0){return[o3.decode(r,e),o3.decode.bytes]}function a3(r,e,t=0){return o3.encode(r,e,t),e}function c3(r){return o3.encodingLength(r)}function bEe(r,e){const t=e.byteLength,n=c3(r),i=n+c3(t),s=new Uint8Array(i+t);return a3(r,s,0),a3(t,s,n),s.set(e,i),new $A(r,t,e,s)}function PH(r){const e=DA(r),[t,n]=b9(e),[i,s]=b9(e.subarray(n)),o=e.subarray(n+s);if(o.byteLength!==i)throw new Error("Incorrect length");return new $A(t,i,o,e)}function vEe(r,e){if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&W9e(r.bytes,t.bytes)}}let $A=class{constructor(e,t,n,i){u(this,"code");u(this,"size");u(this,"digest");u(this,"bytes");this.code=e,this.size=t,this.digest=n,this.bytes=i}};function b$(r,e){const{bytes:t,version:n}=r;switch(n){case 0:return SEe(t,v9(r),e??Eo.encoder);default:return xEe(t,v9(r),e??m1.encoder)}}const v$=new WeakMap;function v9(r){const e=v$.get(r);if(e==null){const t=new Map;return v$.set(r,t),t}return e}var aM;class mr{constructor(e,t,n,i){u(this,"code");u(this,"version");u(this,"multihash");u(this,"bytes");u(this,"/");u(this,aM,"CID");this.code=t,this.version=e,this.multihash=n,this.bytes=i,this["/"]=i}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==Of)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==AEe)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return mr.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=bEe(e,t);return mr.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return mr.equals(this,e)}static equals(e,t){const n=t;return n!=null&&e.code===n.code&&e.version===n.version&&vEe(e.multihash,n.multihash)}toString(e){return b$(this,e)}toJSON(){return{"/":b$(this)}}link(){return this}[(aM=Symbol.toStringTag,Symbol.for("nodejs.util.inspect.custom"))](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof mr)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:i,multihash:s,bytes:o}=t;return new mr(n,i,s,o??E$(n,i,s.bytes))}else if(t[CEe]===!0){const{version:n,multihash:i,code:s}=t,o=PH(i);return mr.create(n,s,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==Of)throw new Error(`Version 0 CID must use dag-pb (code: ${Of}) block encoding`);return new mr(e,t,n,n.bytes)}case 1:{const i=E$(e,t,n.bytes);return new mr(e,t,n,i)}default:throw new Error("Invalid version")}}static createV0(e){return mr.create(0,Of,e)}static createV1(e,t){return mr.create(1,e,t)}static decode(e){const[t,n]=mr.decodeFirst(e);if(n.length!==0)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=mr.inspectBytes(e),n=t.size-t.multihashSize,i=DA(e.subarray(n,n+t.multihashSize));if(i.byteLength!==t.multihashSize)throw new Error("Incorrect length");const s=i.subarray(t.multihashSize-t.digestSize),o=new $A(t.multihashCode,t.digestSize,s,i);return[t.version===0?mr.createV0(o):mr.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[h,p]=b9(e.subarray(t));return t+=p,h};let i=n(),s=Of;if(i===18?(i=0,t=0):s=n(),i!==0&&i!==1)throw new RangeError(`Invalid CID version ${i}`);const o=t,a=n(),c=n(),l=t+c,d=l-o;return{version:i,codec:s,multihashCode:a,digestSize:c,multihashSize:d,size:l}}static parse(e,t){const[n,i]=EEe(e,t),s=mr.decode(i);if(s.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return v9(s).set(n,e),s}}function EEe(r,e){switch(r[0]){case"Q":{const t=e??Eo;return[Eo.prefix,t.decode(`${Eo.prefix}${r}`)]}case Eo.prefix:{const t=e??Eo;return[Eo.prefix,t.decode(r)]}case m1.prefix:{const t=e??m1;return[m1.prefix,t.decode(r)]}case B8.prefix:{const t=e??B8;return[B8.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}}function SEe(r,e,t){const{prefix:n}=t;if(n!==Eo.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const i=e.get(n);if(i==null){const s=t.encode(r).slice(1);return e.set(n,s),s}else return i}function xEe(r,e,t){const{prefix:n}=t,i=e.get(n);if(i==null){const s=t.encode(r);return e.set(n,s),s}else return i}const Of=112,AEe=18;function E$(r,e,t){const n=c3(r),i=n+c3(e),s=new Uint8Array(i+t.byteLength);return a3(r,s,0),a3(e,s,n),s.set(t,i),s}const CEe=Symbol.for("@ipld/js-cid/CID"),IEe=36e5,kEe=216e5;var El;(function(r){(function(t){let n;t.codec=()=>(n==null&&(n=$e((i,s,o={})=>{o.lengthDelimited!==!1&&s.fork(),i.key!=null&&i.key!==""&&(s.uint32(10),s.string(i.key)),i.value!=null&&i.value.byteLength>0&&(s.uint32(18),s.bytes(i.value)),o.lengthDelimited!==!1&&s.ldelim()},(i,s,o={})=>{const a={key:"",value:Ye(0)},c=s==null?i.len:i.pos+s;for(;i.pos<c;){const l=i.uint32();switch(l>>>3){case 1:{a.key=i.string();break}case 2:{a.value=i.bytes();break}default:{i.skipType(l&7);break}}}return a})),n),t.encode=i=>De(i,t.codec()),t.decode=(i,s)=>Pe(i,t.codec(),s)})(r.Peer$metadataEntry||(r.Peer$metadataEntry={})),function(t){let n;t.codec=()=>(n==null&&(n=$e((i,s,o={})=>{o.lengthDelimited!==!1&&s.fork(),i.key!=null&&i.key!==""&&(s.uint32(10),s.string(i.key)),i.value!=null&&(s.uint32(18),u3.codec().encode(i.value,s)),o.lengthDelimited!==!1&&s.ldelim()},(i,s,o={})=>{var l;const a={key:""},c=s==null?i.len:i.pos+s;for(;i.pos<c;){const d=i.uint32();switch(d>>>3){case 1:{a.key=i.string();break}case 2:{a.value=u3.codec().decode(i,i.uint32(),{limits:(l=o.limits)==null?void 0:l.value});break}default:{i.skipType(d&7);break}}}return a})),n),t.encode=i=>De(i,t.codec()),t.decode=(i,s)=>Pe(i,t.codec(),s)}(r.Peer$tagsEntry||(r.Peer$tagsEntry={}));let e;r.codec=()=>(e==null&&(e=$e((t,n,i={})=>{if(i.lengthDelimited!==!1&&n.fork(),t.addresses!=null)for(const s of t.addresses)n.uint32(10),l3.codec().encode(s,n);if(t.protocols!=null)for(const s of t.protocols)n.uint32(18),n.string(s);if(t.publicKey!=null&&(n.uint32(34),n.bytes(t.publicKey)),t.peerRecordEnvelope!=null&&(n.uint32(42),n.bytes(t.peerRecordEnvelope)),t.metadata!=null&&t.metadata.size!==0)for(const[s,o]of t.metadata.entries())n.uint32(50),r.Peer$metadataEntry.codec().encode({key:s,value:o},n);if(t.tags!=null&&t.tags.size!==0)for(const[s,o]of t.tags.entries())n.uint32(58),r.Peer$tagsEntry.codec().encode({key:s,value:o},n);t.updated!=null&&(n.uint32(64),n.uint64Number(t.updated)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{var a,c,l,d,h,p;const s={addresses:[],protocols:[],metadata:new Map,tags:new Map},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const m=t.uint32();switch(m>>>3){case 1:{if(((a=i.limits)==null?void 0:a.addresses)!=null&&s.addresses.length===i.limits.addresses)throw new pt('Decode error - map field "addresses" had too many elements');s.addresses.push(l3.codec().decode(t,t.uint32(),{limits:(c=i.limits)==null?void 0:c.addresses$}));break}case 2:{if(((l=i.limits)==null?void 0:l.protocols)!=null&&s.protocols.length===i.limits.protocols)throw new pt('Decode error - map field "protocols" had too many elements');s.protocols.push(t.string());break}case 4:{s.publicKey=t.bytes();break}case 5:{s.peerRecordEnvelope=t.bytes();break}case 6:{if(((d=i.limits)==null?void 0:d.metadata)!=null&&s.metadata.size===i.limits.metadata)throw new nk('Decode error - map field "metadata" had too many elements');const f=r.Peer$metadataEntry.codec().decode(t,t.uint32());s.metadata.set(f.key,f.value);break}case 7:{if(((h=i.limits)==null?void 0:h.tags)!=null&&s.tags.size===i.limits.tags)throw new nk('Decode error - map field "tags" had too many elements');const f=r.Peer$tagsEntry.codec().decode(t,t.uint32(),{limits:{value:(p=i.limits)==null?void 0:p.tags$value}});s.tags.set(f.key,f.value);break}case 8:{s.updated=t.uint64Number();break}default:{t.skipType(m&7);break}}}return s})),e),r.encode=t=>De(t,r.codec()),r.decode=(t,n)=>Pe(t,r.codec(),n)})(El||(El={}));var l3;(function(r){let e;r.codec=()=>(e==null&&(e=$e((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.multiaddr!=null&&t.multiaddr.byteLength>0&&(n.uint32(10),n.bytes(t.multiaddr)),t.isCertified!=null&&(n.uint32(16),n.bool(t.isCertified)),t.observed!=null&&(n.uint32(24),n.uint64Number(t.observed)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{const s={multiaddr:Ye(0)},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.multiaddr=t.bytes();break}case 2:{s.isCertified=t.bool();break}case 3:{s.observed=t.uint64Number();break}default:{t.skipType(a&7);break}}}return s})),e),r.encode=t=>De(t,r.codec()),r.decode=(t,n)=>Pe(t,r.codec(),n)})(l3||(l3={}));var u3;(function(r){let e;r.codec=()=>(e==null&&(e=$e((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.value!=null&&t.value!==0&&(n.uint32(8),n.uint32(t.value)),t.expiry!=null&&(n.uint32(16),n.uint64(t.expiry)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{const s={value:0},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.value=t.uint32();break}case 2:{s.expiry=t.uint64();break}default:{t.skipType(a&7);break}}}return s})),e),r.encode=t=>De(t,r.codec()),r.decode=(t,n)=>Pe(t,r.codec(),n)})(u3||(u3={}));function _Ee(r,e){if(r.publicKey!=null||e.publicKey==null)return r;let t;if(r.type==="RSA"){const i=Eo.decode(`z${r}`);t=PH(i)}const n=Rn(e.publicKey,t);return Jd(n)}function E9(r,e,t){const n=El.decode(e);return S9(r,n,t)}function S9(r,e,t){const n=new Map,i=BigInt(Date.now());for(const[s,o]of e.tags.entries())o.expiry!=null&&o.expiry<i||n.set(s,o);return{...e,id:_Ee(r,e),addresses:e.addresses.filter(({observed:s})=>s!=null&&s>Date.now()-t).map(({multiaddr:s,isCertified:o})=>({multiaddr:Re(s),isCertified:o??!1})),metadata:e.metadata,peerRecordEnvelope:e.peerRecordEnvelope??void 0,tags:n}}function TEe(r,e){return PEe(r.addresses,e.addresses)&&DEe(r.protocols,e.protocols)&&$Ee(r.publicKey,e.publicKey)&&NEe(r.peerRecordEnvelope,e.peerRecordEnvelope)&&MEe(r.metadata,e.metadata)&&OEe(r.tags,e.tags)}function PEe(r,e){return $H(r,e,(t,n)=>!(t.isCertified!==n.isCertified||!He(t.multiaddr,n.multiaddr)))}function DEe(r,e){return $H(r,e,(t,n)=>t===n)}function $Ee(r,e){return DH(r,e)}function NEe(r,e){return DH(r,e)}function MEe(r,e){return NH(r,e,(t,n)=>He(t,n))}function OEe(r,e){return NH(r,e,(t,n)=>t.value===n.value&&t.expiry===n.expiry)}function DH(r,e){return r==null&&e==null?!0:r!=null&&e!=null?He(r,e):!1}function $H(r,e,t){if(r.length!==e.length)return!1;for(let n=0;n<r.length;n++)if(!t(r[n],e[n]))return!1;return!0}function NH(r,e,t){if(r.size!==e.size)return!1;for(const[n,i]of r.entries()){const s=e.get(n);if(s==null||!t(i,s))return!1}return!0}const MH="/peers/";function vg(r){if(!eB(r)||r.type==null)throw new Z("Invalid PeerId");const e=r.toCID().toString();return new Et(`${MH}${e}`)}async function REe(r,e,t,n){const i=new Map;for(const s of t){if(s==null)continue;if(s.multiaddr instanceof Uint8Array&&(s.multiaddr=Re(s.multiaddr)),!Tw(s.multiaddr))throw new Z("Multiaddr was invalid");if(!await e(r,s.multiaddr))continue;const o=s.isCertified??!1,a=s.multiaddr.toString(),c=i.get(a);c!=null?s.isCertified=c.isCertified||o:i.set(a,{multiaddr:s.multiaddr,isCertified:o})}return[...i.values()].sort((s,o)=>s.multiaddr.toString().localeCompare(o.multiaddr.toString())).map(({isCertified:s,multiaddr:o})=>({isCertified:s,multiaddr:o.bytes}))}async function U8(r,e,t,n){var p,m;if(e==null)throw new Z("Invalid PeerData");if(e.publicKey!=null&&r.publicKey!=null&&!e.publicKey.equals(r.publicKey))throw new Z("publicKey bytes do not match peer id publicKey bytes");const i=(p=n.existingPeer)==null?void 0:p.peer;if(i!=null&&!r.equals(i.id))throw new Z("peer id did not match existing peer id");let s=(i==null?void 0:i.addresses)??[],o=new Set((i==null?void 0:i.protocols)??[]),a=(i==null?void 0:i.metadata)??new Map,c=(i==null?void 0:i.tags)??new Map,l=i==null?void 0:i.peerRecordEnvelope;if(t==="patch"){if((e.multiaddrs!=null||e.addresses!=null)&&(s=[],e.multiaddrs!=null&&s.push(...e.multiaddrs.map(f=>({isCertified:!1,multiaddr:f}))),e.addresses!=null&&s.push(...e.addresses)),e.protocols!=null&&(o=new Set(e.protocols)),e.metadata!=null){const f=e.metadata instanceof Map?[...e.metadata.entries()]:Object.entries(e.metadata);a=Eg(f,{validate:S$})}if(e.tags!=null){const f=e.tags instanceof Map?[...e.tags.entries()]:Object.entries(e.tags);c=Eg(f,{validate:x$,map:A$})}e.peerRecordEnvelope!=null&&(l=e.peerRecordEnvelope)}if(t==="merge"){if(e.multiaddrs!=null&&s.push(...e.multiaddrs.map(f=>({isCertified:!1,multiaddr:f}))),e.addresses!=null&&s.push(...e.addresses),e.protocols!=null&&(o=new Set([...o,...e.protocols])),e.metadata!=null){const f=e.metadata instanceof Map?[...e.metadata.entries()]:Object.entries(e.metadata);for(const[g,v]of f)v==null?a.delete(g):a.set(g,v);a=Eg([...a.entries()],{validate:S$})}if(e.tags!=null){const f=e.tags instanceof Map?[...e.tags.entries()]:Object.entries(e.tags),g=new Map(c);for(const[v,y]of f)y==null?g.delete(v):g.set(v,y);c=Eg([...g.entries()],{validate:x$,map:A$})}e.peerRecordEnvelope!=null&&(l=e.peerRecordEnvelope)}let d;(i==null?void 0:i.id.publicKey)!=null?d=Pi(i.id.publicKey):e.publicKey!=null?d=Pi(e.publicKey):r.publicKey!=null&&(d=Pi(r.publicKey));const h={addresses:await REe(r,n.addressFilter??(async()=>!0),s,(m=n.existingPeer)==null?void 0:m.peerPB.addresses),protocols:[...o.values()].sort((f,g)=>f.localeCompare(g)),metadata:a,tags:c,publicKey:d,peerRecordEnvelope:l};return h.addresses.forEach(f=>{var g,v,y;f.observed=((y=(v=(g=n.existingPeer)==null?void 0:g.peerPB.addresses)==null?void 0:v.find(w=>He(w.multiaddr,w.multiaddr)))==null?void 0:y.observed)??Date.now()}),r.type!=="RSA"&&delete h.publicKey,h}function Eg(r,e){var n;const t=new Map;for(const[i,s]of r)s!=null&&e.validate(i,s);for(const[i,s]of r.sort(([o],[a])=>o.localeCompare(a)))s!=null&&t.set(i,((n=e.map)==null?void 0:n.call(e,i,s))??s);return t}function S$(r,e){if(typeof r!="string")throw new Z("Metadata key must be a string");if(!(e instanceof Uint8Array))throw new Z("Metadata value must be a Uint8Array")}function x$(r,e){if(typeof r!="string")throw new Z("Tag name must be a string");if(e.value!=null){if(parseInt(`${e.value}`,10)!==e.value)throw new Z("Tag value must be an integer");if(e.value<0||e.value>100)throw new Z("Tag value must be between 0-100")}if(e.ttl!=null){if(parseInt(`${e.ttl}`,10)!==e.ttl)throw new Z("Tag ttl must be an integer");if(e.ttl<0)throw new Z("Tag ttl must be between greater than 0")}}function A$(r,e){let t;return e.expiry!=null&&(t=e.expiry),e.ttl!=null&&(t=BigInt(Date.now()+Number(e.ttl))),{value:e.value??0,expiry:t}}function OH(r){const e=r.toString().split("/")[2],t=mr.parse(e,m1);return Oh(t)}function F8(r,e,t){const n=OH(r);return E9(n,e,t)}function LEe(r,e){return{prefix:MH,filters:(r.filters??[]).map(t=>({key:n,value:i})=>t(F8(n,i,e))),orders:(r.orders??[]).map(t=>(n,i)=>t(F8(n.key,n.value,e),F8(i.key,i.value,e)))}}var Nn,p2,g2,y2;class BEe{constructor(e,t={}){Ge(this,Nn);u(this,"peerId");u(this,"datastore");u(this,"lock");u(this,"addressFilter");u(this,"log");u(this,"maxAddressAge");u(this,"maxPeerAge");this.log=e.logger.forComponent("libp2p:peer-store"),this.peerId=e.peerId,this.datastore=e.datastore,this.addressFilter=t.addressFilter,this.lock=jS({name:"peer-store",singleProcess:!0}),this.maxAddressAge=t.maxAddressAge??IEe,this.maxPeerAge=t.maxPeerAge??kEe}async has(e){try{return await this.load(e),!0}catch(t){if(t.name!=="NotFoundError")throw t}return!1}async delete(e){this.peerId.equals(e)||await this.datastore.delete(vg(e))}async load(e){const t=vg(e),n=await this.datastore.get(t),i=El.decode(n);if(Ie(this,Nn,y2).call(this,e,i))throw await this.datastore.delete(t),new Zt;return S9(e,i,this.peerId.equals(e)?1/0:this.maxAddressAge)}async save(e,t){const n=await Ie(this,Nn,p2).call(this,e),i=await U8(e,t,"patch",{addressFilter:this.addressFilter});return Ie(this,Nn,g2).call(this,e,i,n)}async patch(e,t){const n=await Ie(this,Nn,p2).call(this,e),i=await U8(e,t,"patch",{addressFilter:this.addressFilter,existingPeer:n});return Ie(this,Nn,g2).call(this,e,i,n)}async merge(e,t){const n=await Ie(this,Nn,p2).call(this,e),i=await U8(e,t,"merge",{addressFilter:this.addressFilter,existingPeer:n});return Ie(this,Nn,g2).call(this,e,i,n)}async*all(e){for await(const{key:t,value:n}of this.datastore.query(LEe(e??{},this.maxAddressAge))){const i=OH(t);if(i.equals(this.peerId))continue;const s=El.decode(n);if(Ie(this,Nn,y2).call(this,i,s)){await this.datastore.delete(t);continue}yield S9(i,s,this.peerId.equals(i)?1/0:this.maxAddressAge)}}}Nn=new WeakSet,p2=async function(e){try{const t=vg(e),n=await this.datastore.get(t),i=El.decode(n);if(Ie(this,Nn,y2).call(this,e,i))throw await this.datastore.delete(t),new Zt;return{peerPB:i,peer:E9(e,n,this.maxAddressAge)}}catch(t){t.name!=="NotFoundError"&&this.log.error("invalid peer data found in peer store - %e",t)}},g2=async function(e,t,n){t.updated=Date.now();const i=El.encode(t);return await this.datastore.put(vg(e),i),{peer:E9(e,i,this.maxAddressAge),previous:n==null?void 0:n.peer,updated:n==null||!TEe(t,n.peerPB)}},y2=function(e,t){if(t.updated==null)return!0;if(this.peerId.equals(e))return!1;const n=t.updated<Date.now()-this.maxPeerAge,i=Date.now()-this.maxAddressAge,s=t.addresses.filter(o=>o.observed!=null&&o.observed>i);return n&&s.length===0};var cM,Md,m2;cM=Symbol.toStringTag;class UEe{constructor(e,t={}){Ge(this,Md);u(this,"store");u(this,"events");u(this,"peerId");u(this,"log");u(this,cM,"@libp2p/peer-store");this.log=e.logger.forComponent("libp2p:peer-store"),this.events=e.events,this.peerId=e.peerId,this.store=new BEe(e,t)}async forEach(e,t){this.log.trace("forEach await read lock");const n=await this.store.lock.readLock();this.log.trace("forEach got read lock");try{for await(const i of this.store.all(t))e(i)}finally{this.log.trace("forEach release read lock"),n()}}async all(e){this.log.trace("all await read lock");const t=await this.store.lock.readLock();this.log.trace("all got read lock");try{return await im(this.store.all(e))}finally{this.log.trace("all release read lock"),t()}}async delete(e){this.log.trace("delete await write lock");const t=await this.store.lock.writeLock();this.log.trace("delete got write lock");try{await this.store.delete(e)}finally{this.log.trace("delete release write lock"),t()}}async has(e){this.log.trace("has await read lock");const t=await this.store.lock.readLock();this.log.trace("has got read lock");try{return await this.store.has(e)}finally{this.log.trace("has release read lock"),t()}}async get(e){this.log.trace("get await read lock");const t=await this.store.lock.readLock();this.log.trace("get got read lock");try{return await this.store.load(e)}finally{this.log.trace("get release read lock"),t()}}async save(e,t){this.log.trace("save await write lock");const n=await this.store.lock.writeLock();this.log.trace("save got write lock");try{const i=await this.store.save(e,t);return Ie(this,Md,m2).call(this,e,i),i.peer}finally{this.log.trace("save release write lock"),n()}}async patch(e,t){this.log.trace("patch await write lock");const n=await this.store.lock.writeLock();this.log.trace("patch got write lock");try{const i=await this.store.patch(e,t);return Ie(this,Md,m2).call(this,e,i),i.peer}finally{this.log.trace("patch release write lock"),n()}}async merge(e,t){this.log.trace("merge await write lock");const n=await this.store.lock.writeLock();this.log.trace("merge got write lock");try{const i=await this.store.merge(e,t);return Ie(this,Md,m2).call(this,e,i),i.peer}finally{this.log.trace("merge release write lock"),n()}}async consumePeerRecord(e,t){const n=await _c.openAndCertify(e,js.DOMAIN),i=Oh(n.publicKey.toCID());if((t==null?void 0:t.equals(i))===!1)return this.log("envelope peer id was not the expected peer id - expected: %p received: %p",t,i),!1;const s=js.createFromProtobuf(n.payload);let o;try{o=await this.get(i)}catch(a){if(a.name!=="NotFoundError")throw a}if((o==null?void 0:o.peerRecordEnvelope)!=null){const a=await _c.createFromProtobuf(o.peerRecordEnvelope),c=js.createFromProtobuf(a.payload);if(c.seqNumber>=s.seqNumber)return this.log("sequence number was lower or equal to existing sequence number - stored: %d received: %d",c.seqNumber,s.seqNumber),!1}return await this.patch(s.peerId,{peerRecordEnvelope:e,addresses:s.multiaddrs.map(a=>({isCertified:!0,multiaddr:a}))}),!0}}Md=new WeakSet,m2=function(e,t){t.updated&&(this.peerId.equals(e)?this.events.safeDispatchEvent("self:peer:update",{detail:t}):this.events.safeDispatchEvent("peer:update",{detail:t}))};function FEe(r,e={}){return new UEe(r,e)}function zEe(r,e){let t;const n=function(){const i=function(){t=void 0,r()};clearTimeout(t),t=setTimeout(i,e)};return n.start=()=>{},n.stop=()=>{clearTimeout(t)},n}const C$=864e13,VEe=448,z8=449,KEe=53,jEe=54,HEe=55,qEe=56;class WEe{constructor(e,t={}){u(this,"log");u(this,"mappings");this.log=e.logger.forComponent("libp2p:address-manager:dns-mappings"),this.mappings=new Map}has(e){const t=this.findHost(e);for(const n of this.mappings.values())if(n.domain===t)return!0;return!1}add(e,t){t.forEach(n=>{this.log("add DNS mapping %s to %s",n,e);const i=zc(n)===!0;this.mappings.set(n,{domain:e,verified:i,expires:i?C$-Date.now():0,lastVerified:i?C$-Date.now():void 0})})}remove(e){const t=this.findHost(e);let n=!1;for(const[i,s]of this.mappings.entries())s.domain===t&&(this.log("removing %s to %s DNS mapping %e",i,s.domain,new Error("where")),this.mappings.delete(i),n=n||s.verified);return n}getAll(e){const t=[];for(let n=0;n<e.length;n++){const s=e[n].multiaddr.stringTuples(),o=s[0][1];if(o!=null)for(const[a,c]of this.mappings.entries()){if(o!==a)continue;this.maybeAddSNITuple(s,c.domain)&&(e.splice(n,1),n--,t.push({multiaddr:Re(`/${s.map(d=>[ze(d[0]).name,d[1]].join("/")).join("/")}`),verified:c.verified,type:"dns-mapping",expires:c.expires,lastVerified:c.lastVerified}))}}return t}maybeAddSNITuple(e,t){var n;for(let i=0;i<e.length;i++)if(e[i][0]===VEe&&((n=e[i+1])==null?void 0:n[0])!==z8)return e.splice(i+1,0,[z8,t]),!0;return!1}confirm(e,t){const n=this.findHost(e);let i=!1;for(const[s,o]of this.mappings.entries())o.domain===n&&(this.log("marking %s to %s DNS mapping as verified",s,o.domain),i=o.verified,o.verified=!0,o.expires=Date.now()+t,o.lastVerified=Date.now());return i}unconfirm(e,t){const n=this.findHost(e);let i=!1;for(const[s,o]of this.mappings.entries())o.domain===n&&(this.log("removing verification of %s to %s DNS mapping",s,o.domain),i=i||o.verified,o.verified=!1,o.expires=Date.now()+t);return i}findHost(e){for(const t of e.stringTuples())if(t[0]===z8||t[0]===KEe||t[0]===jEe||t[0]===HEe||t[0]===qEe)return t[1]}}const V8=4,K8=41,j8=6,GEe=273;class QEe{constructor(e,t={}){u(this,"log");u(this,"mappings");this.log=e.logger.forComponent("libp2p:address-manager:ip-mappings"),this.mappings=new Map}has(e){const t=e.stringTuples();for(const n of this.mappings.values())for(const i of n)if(i.externalIp===t[0][1])return!0;return!1}add(e,t,n,i=t,s="tcp"){const o=`${e}-${t}-${s}`,a=this.mappings.get(o)??[],c={internalIp:e,internalPort:t,externalIp:n,externalPort:i,externalFamily:rh(n)?4:6,protocol:s,verified:!1,expires:0};a.push(c),this.mappings.set(o,a)}remove(e){const t=e.stringTuples(),n=t[0][1]??"",i=t[1][0]===j8?"tcp":"udp",s=parseInt(t[1][1]??"0");let o=!1;for(const[a,c]of this.mappings.entries()){for(let l=0;l<c.length;l++){const d=c[l];d.externalIp===n&&d.externalPort===s&&d.protocol===i&&(this.log("removing %s:%s to %s:%s %s IP mapping",d.externalIp,d.externalPort,n,s,i),o=o||d.verified,c.splice(l,1),l--)}c.length===0&&this.mappings.delete(a)}return o}getAll(e){const t=[];for(const{multiaddr:n}of e){const i=n.stringTuples();let s;if((i[0][0]===V8||i[0][0]===K8)&&i[1][0]===j8?s=`${i[0][1]}-${i[1][1]}-tcp`:(i[0][0]===V8||i[0][0]===K8)&&i[1][0]===GEe&&(s=`${i[0][1]}-${i[1][1]}-udp`),s==null)continue;const o=this.mappings.get(s);if(o!=null)for(const a of o)i[0][0]=a.externalFamily===4?V8:K8,i[0][1]=a.externalIp,i[1][1]=`${a.externalPort}`,t.push({multiaddr:Re(`/${i.map(c=>[ze(c[0]).name,c[1]].join("/")).join("/")}`),verified:a.verified,type:"ip-mapping",expires:a.expires,lastVerified:a.lastVerified})}return t}confirm(e,t){const i=e.stringTuples()[0][1];let s=!1;for(const o of this.mappings.values())for(const a of o)a.externalIp===i&&(this.log("marking %s to %s IP mapping as verified",a.internalIp,a.externalIp),s=a.verified,a.verified=!0,a.expires=Date.now()+t,a.lastVerified=Date.now());return s}unconfirm(e,t){const n=e.stringTuples(),i=n[0][1]??"",s=n[1][0]===j8?"tcp":"udp",o=parseInt(n[1][1]??"0");let a=!1;for(const c of this.mappings.values())for(let l=0;l<c.length;l++){const d=c[l];d.externalIp===i&&d.externalPort===o&&d.protocol===s&&(this.log("removing verification of %s:%s to %s:%s %s IP mapping",d.externalIp,d.externalPort,i,o,s),a=a||d.verified,d.verified=!1,d.expires=Date.now()+t)}return a}}const YEe=4,JEe=41;function XEe(r){try{const[[e,t]]=r.stringTuples();if(t==null)return!1;if(e===YEe)return t.startsWith("169.254.");if(e===JEe)return t.toLowerCase().startsWith("fe80")}catch{}return!1}const ZEe={maxObservedAddresses:10};class eSe{constructor(e,t={}){u(this,"log");u(this,"addresses");u(this,"maxObservedAddresses");this.log=e.logger.forComponent("libp2p:address-manager:observed-addresses"),this.addresses=new Map,this.maxObservedAddresses=t.maxObservedAddresses??ZEe.maxObservedAddresses}has(e){return this.addresses.has(e.toString())}removePrefixed(e){for(const t of this.addresses.keys())t.toString().startsWith(e)&&this.addresses.delete(t)}add(e){this.addresses.size!==this.maxObservedAddresses&&(Zl(e)||XEe(e)||(this.log("adding observed address %a",e),this.addresses.set(e.toString(),{verified:!1,expires:0})))}getAll(){return Array.from(this.addresses).map(([e,t])=>({multiaddr:Re(e),verified:t.verified,type:"observed",expires:t.expires,lastVerified:t.lastVerified}))}remove(e){var n;const t=((n=this.addresses.get(e.toString()))==null?void 0:n.verified)??!1;return this.log("removing observed address %a",e),this.addresses.delete(e.toString()),t}confirm(e,t){const n=e.toString(),i=this.addresses.get(n)??{verified:!1,expires:Date.now()+t,lastVerified:Date.now()},s=i.verified;return i.verified=!0,i.expires=Date.now()+t,i.lastVerified=Date.now(),this.log("marking observed address %a as verified",n),this.addresses.set(n,i),s}}const tSe=4,rSe=41,nSe=53,iSe=54,sSe=55,oSe=56,aSe=[tSe,rSe,nSe,iSe,sSe,oSe];function I$(r){try{const[[e]]=r.stringTuples();return aSe.includes(e)}catch{}return!1}const cSe={maxObservedAddresses:10};class lSe{constructor(e,t={}){u(this,"log");u(this,"addresses");u(this,"maxObservedAddresses");this.log=e.logger.forComponent("libp2p:address-manager:observed-addresses"),this.addresses=new Map,this.maxObservedAddresses=t.maxObservedAddresses??cSe.maxObservedAddresses}get(e,t){if(Zl(e))return{multiaddr:e,verified:!0,type:"transport",expires:Date.now()+t,lastVerified:Date.now()};const n=this.toKey(e);let i=this.addresses.get(n);return i==null&&(i={verified:!I$(e),expires:0},this.addresses.set(n,i)),{multiaddr:e,verified:i.verified,type:"transport",expires:i.expires,lastVerified:i.lastVerified}}has(e){const t=this.toKey(e);return this.addresses.has(t)}remove(e){var i;const t=this.toKey(e),n=((i=this.addresses.get(t))==null?void 0:i.verified)??!1;return this.log("removing observed address %a",e),this.addresses.delete(t),n}confirm(e,t){const n=this.toKey(e),i=this.addresses.get(n)??{verified:!1,expires:0,lastVerified:0},s=i.verified;return i.verified=!0,i.expires=Date.now()+t,i.lastVerified=Date.now(),this.addresses.set(n,i),s}unconfirm(e,t){const n=this.toKey(e),i=this.addresses.get(n)??{verified:!1,expires:0},s=i.verified;return i.verified=!1,i.expires=Date.now()+t,this.addresses.set(n,i),s}toKey(e){if(I$(e)){const t=e.toOptions();return`${t.host}-${t.port}-${t.transport}`}return e.toString()}}const k$=6e4,_$={addressVerificationTTL:k$*10,addressVerificationRetry:k$*5},uSe=r=>r;function H8(r,e){const t=r.getPeerId();return t!=null&&Jt(t).equals(e)&&(r=r.decapsulate(Re(`/p2p/${e.toString()}`))),r}var lM;lM=Symbol.toStringTag;class dSe{constructor(e,t={}){u(this,"log");u(this,"components");u(this,"listen");u(this,"announce");u(this,"appendAnnounce");u(this,"announceFilter");u(this,"observed");u(this,"dnsMappings");u(this,"ipMappings");u(this,"transportAddresses");u(this,"observedAddressFilter");u(this,"addressVerificationTTL");u(this,"addressVerificationRetry");u(this,lM,"@libp2p/address-manager");const{listen:n=[],announce:i=[],appendAnnounce:s=[]}=t;this.components=e,this.log=e.logger.forComponent("libp2p:address-manager"),this.listen=n.map(o=>o.toString()),this.announce=new Set(i.map(o=>o.toString())),this.appendAnnounce=new Set(s.map(o=>o.toString())),this.observed=new eSe(e,t),this.dnsMappings=new WEe(e,t),this.ipMappings=new QEe(e,t),this.transportAddresses=new lSe(e,t),this.announceFilter=t.announceFilter??uSe,this.observedAddressFilter=Ql(1024),this.addressVerificationTTL=t.addressVerificationTTL??_$.addressVerificationTTL,this.addressVerificationRetry=t.addressVerificationRetry??_$.addressVerificationRetry,this._updatePeerStoreAddresses=zEe(this._updatePeerStoreAddresses.bind(this),1e3),e.events.addEventListener("transport:listening",()=>{this._updatePeerStoreAddresses()}),e.events.addEventListener("transport:close",()=>{this._updatePeerStoreAddresses()})}_updatePeerStoreAddresses(){const e=this.getAddresses().map(t=>t.getPeerId()===this.components.peerId.toString()?t.decapsulate(`/p2p/${this.components.peerId.toString()}`):t);this.components.peerStore.patch(this.components.peerId,{multiaddrs:e}).catch(t=>{this.log.error("error updating addresses",t)})}getListenAddrs(){return Array.from(this.listen).map(e=>Re(e))}getAnnounceAddrs(){return Array.from(this.announce).map(e=>Re(e))}getAppendAnnounceAddrs(){return Array.from(this.appendAnnounce).map(e=>Re(e))}getObservedAddrs(){return this.observed.getAll().map(e=>e.multiaddr)}addObservedAddr(e){const t=e.stringTuples(),n=`${t[0][1]}:${t[1][1]}`;this.observedAddressFilter.has(n)||(this.observedAddressFilter.add(n),e=H8(e,this.components.peerId),!this.ipMappings.has(e)&&(this.dnsMappings.has(e)||this.observed.add(e)))}confirmObservedAddr(e,t){e=H8(e,this.components.peerId);let n=!0;((t==null?void 0:t.type)==="transport"||this.transportAddresses.has(e))&&!this.transportAddresses.confirm(e,(t==null?void 0:t.ttl)??this.addressVerificationTTL)&&n&&(n=!1),((t==null?void 0:t.type)==="dns-mapping"||this.dnsMappings.has(e))&&!this.dnsMappings.confirm(e,(t==null?void 0:t.ttl)??this.addressVerificationTTL)&&n&&(n=!1),((t==null?void 0:t.type)==="ip-mapping"||this.ipMappings.has(e))&&!this.ipMappings.confirm(e,(t==null?void 0:t.ttl)??this.addressVerificationTTL)&&n&&(n=!1),((t==null?void 0:t.type)==="observed"||this.observed.has(e))&&(this.maybeUpgradeToIPMapping(e)?(this.ipMappings.confirm(e,(t==null?void 0:t.ttl)??this.addressVerificationTTL),n=!1):!this.observed.confirm(e,(t==null?void 0:t.ttl)??this.addressVerificationTTL)&&n&&(n=!1)),n||this._updatePeerStoreAddresses()}removeObservedAddr(e,t){e=H8(e,this.components.peerId),this.observed.has(e)&&this.observed.remove(e),this.transportAddresses.has(e)&&this.transportAddresses.unconfirm(e,(t==null?void 0:t.ttl)??this.addressVerificationRetry),this.dnsMappings.has(e)&&this.dnsMappings.unconfirm(e,(t==null?void 0:t.ttl)??this.addressVerificationRetry),this.ipMappings.has(e)&&this.ipMappings.unconfirm(e,(t==null?void 0:t.ttl)??this.addressVerificationRetry)}getAddresses(){const e=new Set,t=this.getAddressesWithMetadata().filter(n=>{if(!n.verified)return!1;const i=n.multiaddr.toString();return e.has(i)?!1:(e.add(i),!0)}).map(n=>n.multiaddr);return this.announceFilter(t.map(n=>{var s;const i=Re(n);return((s=i.protos().pop())==null?void 0:s.path)===!0||i.getPeerId()===this.components.peerId.toString()?i:i.encapsulate(`/p2p/${this.components.peerId.toString()}`)}))}getAddressesWithMetadata(){const e=this.getAnnounceAddrs();if(e.length>0)return this.components.transportManager.getListeners().forEach(i=>{i.updateAnnounceAddrs(e)}),e.map(i=>({multiaddr:i,verified:!0,type:"announce",expires:Date.now()+this.addressVerificationTTL,lastVerified:Date.now()}));let t=[];t=t.concat(this.components.transportManager.getAddrs().map(i=>this.transportAddresses.get(i,this.addressVerificationTTL)));const n=this.getAppendAnnounceAddrs();return n.length>0&&(this.components.transportManager.getListeners().forEach(i=>{i.updateAnnounceAddrs(n)}),t=t.concat(n.map(i=>({multiaddr:i,verified:!0,type:"announce",expires:Date.now()+this.addressVerificationTTL,lastVerified:Date.now()})))),t=t.concat(this.observed.getAll()),t=t.concat(this.ipMappings.getAll(t)),t=t.concat(this.dnsMappings.getAll(t)),t}addDNSMapping(e,t){this.dnsMappings.add(e,t)}removeDNSMapping(e){this.dnsMappings.remove(Re(`/dns/${e}`))&&this._updatePeerStoreAddresses()}addPublicAddressMapping(e,t,n,i=t,s="tcp"){this.ipMappings.add(e,t,n,i,s),this.observed.removePrefixed(`/ip${rh(n)?4:6}/${n}/${s}/${i}`)}removePublicAddressMapping(e,t,n,i=t,s="tcp"){this.ipMappings.remove(Re(`/ip${rh(n)?4:6}/${n}/${s}/${i}`))&&this._updatePeerStoreAddresses()}maybeUpgradeToIPMapping(e){if(this.ipMappings.has(e))return!1;const t=e.toOptions();if(t.family===6||t.host==="127.0.0.1"||zc(t.host)===!0)return!1;const n=this.components.transportManager.getListeners(),i=[s=>X1.exactMatch(s)||zy.exactMatch(s),s=>Fy.exactMatch(s),s=>Dhe.exactMatch(s)];for(const s of i){if(!s(e))continue;const o=n.filter(l=>l.getAddrs().filter(d=>d.toOptions().family===4&&s(d)).length>0);if(o.length!==1)continue;const a=o[0].getAddrs().filter(l=>l.toOptions().host!=="127.0.0.1").pop();if(a==null)continue;const c=a.toOptions();return this.observed.remove(e),this.ipMappings.add(c.host,c.port,t.host,t.port,t.transport),!0}return!1}}var T$;(function(r){r.NOT_STARTED_YET="The libp2p node is not started yet",r.NOT_FOUND="Not found"})(T$||(T$={}));class hSe extends Error{constructor(e="Missing service"){super(e),this.name="MissingServiceError"}}class fSe extends Error{constructor(e="Unmet service dependencies"){super(e),this.name="UnmetServiceDependenciesError"}}class q8 extends Error{constructor(e="No content routers available"){super(e),this.name="NoContentRoutersError"}}class P$ extends Error{constructor(e="No peer routers available"){super(e),this.name="NoPeerRoutersError"}}class pSe extends Error{constructor(e="Should not try to find self"){super(e),this.name="QueriedForSelfError"}}class gSe extends Error{constructor(e="Unhandled protocol error"){super(e),this.name="UnhandledProtocolError"}}class ySe extends Error{constructor(e="Duplicate protocol handler error"){super(e),this.name="DuplicateProtocolHandlerError"}}class D$ extends Error{constructor(e="Dial denied error"){super(e),this.name="DialDeniedError"}}class mSe extends Error{constructor(e="No transport was configured to listen on this address"){super(e),this.name="UnsupportedListenAddressError"}}class wSe extends Error{constructor(e="Configured listen addresses could not be listened on"){super(e),this.name="UnsupportedListenAddressesError"}}class bSe extends Error{constructor(e="No valid addresses"){super(e),this.name="NoValidAddressesError"}}class vSe extends Error{constructor(e="Connection intercepted"){super(e),this.name="ConnectionInterceptedError"}}class ESe extends Error{constructor(e="Connection denied"){super(e),this.name="ConnectionDeniedError"}}class Sg extends Error{constructor(e="Stream is not multiplexed"){super(e),this.name="MuxerUnavailableError"}}class xg extends Error{constructor(e="Encryption failed"){super(e),this.name="EncryptionFailedError"}}class SSe extends Error{constructor(e="Transport unavailable"){super(e),this.name="TransportUnavailableError"}}class xSe{constructor(e={}){u(this,"components",{});u(this,"_started",!1);this.components={};for(const[t,n]of Object.entries(e))this.components[t]=n;this.components.logger==null&&(this.components.logger=ww())}isStarted(){return this._started}async _invokeStartableMethod(e){await Promise.all(Object.values(this.components).filter(t=>oS(t)).map(async t=>{var n;await((n=t[e])==null?void 0:n.call(t))}))}async beforeStart(){await this._invokeStartableMethod("beforeStart")}async start(){await this._invokeStartableMethod("start"),this._started=!0}async afterStart(){await this._invokeStartableMethod("afterStart")}async beforeStop(){await this._invokeStartableMethod("beforeStop")}async stop(){await this._invokeStartableMethod("stop"),this._started=!1}async afterStop(){await this._invokeStartableMethod("afterStop")}}const ASe=["metrics","connectionProtector","dns"],CSe=["components","isStarted","beforeStart","start","afterStart","beforeStop","stop","afterStop","then","_invokeStartableMethod"];function ISe(r={}){const e=new xSe(r);return new Proxy(e,{get(n,i,s){if(typeof i=="string"&&!CSe.includes(i)){const o=e.components[i];if(o==null&&!ASe.includes(i))throw new hSe(`${i} not set`);return o}return Reflect.get(n,i,s)},set(n,i,s){return typeof i=="string"?e.components[i]=s:Reflect.set(n,i,s),!0}})}function kSe(r){const e={};for(const t of Object.values(r.components))for(const n of _Se(t))e[n]=!0;for(const t of Object.values(r.components))for(const n of TSe(t))if(e[n]!==!0)throw new fSe(`Service "${PSe(t)}" required capability "${n}" but it was not provided by any component, you may need to add additional configuration when creating your node.`)}function _Se(r){return Array.isArray(r==null?void 0:r[fr])?r[fr]:[]}function TSe(r){return Array.isArray(r==null?void 0:r[Ec])?r[Ec]:[]}function PSe(r){return(r==null?void 0:r[Symbol.toStringTag])??(r==null?void 0:r.toString())??"unknown"}const DSe=4,$Se=41;function NSe(r={}){return{denyDialPeer:async()=>!1,denyDialMultiaddr:async e=>{if(X1.matches(e))return!1;const t=e.stringTuples();return t[0][0]===DSe||t[0][0]===$Se?!!zc(`${t[0][1]}`):!1},denyInboundConnection:async()=>!1,denyOutboundConnection:async()=>!1,denyInboundEncryptedConnection:async()=>!1,denyOutboundEncryptedConnection:async()=>!1,denyInboundUpgradedConnection:async()=>!1,denyOutboundUpgradedConnection:async()=>!1,filterMultiaddrForPeer:async()=>!0,...r}}function RH(r){if(eB(r))return{peerId:r,multiaddrs:[]};let e=Array.isArray(r)?r:[r],t;if(e.length>0){const n=e[0].getPeerId();t=n==null?void 0:Jt(n),e.forEach(i=>{if(!Tw(i))throw new Z3("Invalid multiaddr");const s=i.getPeerId();if(s==null){if(t!=null)throw new Z("Multiaddrs must all have the same peer id or have no peer id")}else{const o=Jt(s);if((t==null?void 0:t.equals(o))!==!0)throw new Z("Multiaddrs must all have the same peer id or have no peer id")}})}return e=e.filter(n=>!khe.exactMatch(n)),{peerId:t,multiaddrs:e}}const MSe=["/ipfs/id/1.0.0","/ipfs/id/push/1.0.0","/libp2p/autonat/1.0.0","/libp2p/dcutr"];async function OSe(r,e){var i;const t=((i=r==null?void 0:r.streams)==null?void 0:i.map(s=>s.protocol))??[],n=(e==null?void 0:e.closableProtocols)??MSe;if(!(t.filter(s=>s!=null&&!n.includes(s)).length>0))try{await(r==null?void 0:r.close(e))}catch(s){r==null||r.abort(s)}}const LH=1e4,RSe=1e4,$$=1e4,BH=25,LSe=5,BSe=10,USe=5,FSe="last-dial-failure",zSe="last-dial-success",UH=500,FH=100,zH=50;async function VSe(r,e){let t=!1;for(const i of cx.keys())if(t=r.protoNames().includes(i),t)break;if(!t)return[r];const n=await r.resolve(e);return e.log("resolved %s to",r,n.map(i=>i.toString())),n}function x9(r){try{let e;if(typeof r=="string"?e=Re(r):e=r,!e.protoNames().includes("ipcidr")){const n=e.protoNames().includes("ip6")?"/ipcidr/128":"/ipcidr/32";e=e.encapsulate(n)}return w1e(e)}catch{throw new Error(`Can't convert to IpNet, Invalid multiaddr format: ${r}`)}}const KSe={maxConnections:FH};class jSe{constructor(e,t={}){u(this,"maxConnections");u(this,"connectionManager");u(this,"peerStore");u(this,"allow");u(this,"events");u(this,"log");this.maxConnections=t.maxConnections??KSe.maxConnections,this.allow=(t.allow??[]).map(n=>x9(n)),this.connectionManager=e.connectionManager,this.peerStore=e.peerStore,this.events=e.events,this.log=e.logger.forComponent("libp2p:connection-manager:connection-pruner"),this.maybePruneConnections=this.maybePruneConnections.bind(this)}start(){this.events.addEventListener("connection:open",this.maybePruneConnections)}stop(){this.events.removeEventListener("connection:open",this.maybePruneConnections)}maybePruneConnections(){this._maybePruneConnections().catch(e=>{this.log.error("error while pruning connections %e",e)})}async _maybePruneConnections(){const e=this.connectionManager.getConnections(),t=e.length;if(this.log("checking max connections limit %d/%d",t,this.maxConnections),t<=this.maxConnections)return;const n=new Fc;for(const a of e){const c=a.remotePeer;if(!n.has(c)){n.set(c,0);try{const l=await this.peerStore.get(c);n.set(c,[...l.tags.values()].reduce((d,h)=>d+h.value,0))}catch(l){l.name!=="NotFoundError"&&this.log.error("error loading peer tags",l)}}}const i=this.sortConnections(e,n),s=Math.max(t-this.maxConnections,0),o=[];for(const a of i)if(this.log("too many connections open - closing a connection to %p",a.remotePeer),this.allow.some(l=>l.contains(a.remoteAddr.nodeAddress().address))||o.push(a),o.length===s)break;await Promise.all(o.map(async a=>{await OSe(a,{signal:AbortSignal.timeout(1e3)})})),this.events.safeDispatchEvent("connection:prune",{detail:o})}sortConnections(e,t){return e.sort((n,i)=>{const s=n.timeline.open,o=i.timeline.open;return s<o?1:s>o?-1:0}).sort((n,i)=>n.direction==="outbound"&&i.direction==="inbound"?1:n.direction==="inbound"&&i.direction==="outbound"?-1:0).sort((n,i)=>n.streams.length>i.streams.length?1:n.streams.length<i.streams.length?-1:0).sort((n,i)=>{const s=t.get(n.remotePeer)??0,o=t.get(i.remotePeer)??0;return s>o?1:s<o?-1:0})}}class HSe extends Gl{constructor(e={}){super({...e,sort:(t,n)=>t.options.priority>n.options.priority?-1:t.options.priority<n.options.priority?1:0})}}function qSe(r){return/^127\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/i.test(r)||/^::1$/.test(r)}function N$(r){if(!PV(r))return!1;const{address:e}=r.nodeAddress();return qSe(e)}function WSe(r,e){const t=Fy.exactMatch(r.multiaddr),n=Fy.exactMatch(e.multiaddr);if(t&&!n)return-1;if(!t&&n)return 1;const i=zy.exactMatch(r.multiaddr),s=zy.exactMatch(e.multiaddr);if(i&&!s)return-1;if(!i&&s)return 1;const o=X1.exactMatch(r.multiaddr),a=X1.exactMatch(e.multiaddr);if(o&&!a)return-1;if(!o&&a)return 1;const c=nv.exactMatch(r.multiaddr),l=nv.exactMatch(e.multiaddr);if(c&&!l)return-1;if(!c&&l)return 1;const d=rv.exactMatch(r.multiaddr),h=rv.exactMatch(e.multiaddr);if(d&&!h)return-1;if(!d&&h)return 1;const p=S_.exactMatch(r.multiaddr),m=S_.exactMatch(e.multiaddr);return p&&!m?-1:!p&&m?1:0}function GSe(r,e){const t=N$(r.multiaddr),n=N$(e.multiaddr);return t&&!n?1:!t&&n?-1:0}function QSe(r,e){const t=Zl(r.multiaddr),n=Zl(e.multiaddr);return t&&!n?1:!t&&n?-1:0}function YSe(r,e){return r.isCertified&&!e.isCertified?-1:!r.isCertified&&e.isCertified?1:0}function JSe(r,e){const t=Ic.exactMatch(r.multiaddr),n=Ic.exactMatch(e.multiaddr);return t&&!n?1:!t&&n?-1:0}function XSe(r){return r.sort(WSe).sort(YSe).sort(JSe).sort(QSe).sort(GSe)}const Ag={maxParallelDials:zH,maxDialQueueLength:UH,maxPeerAddrsToDial:BH,dialTimeout:LH};class ZSe{constructor(e,t={}){u(this,"queue");u(this,"components");u(this,"addressSorter");u(this,"maxPeerAddrsToDial");u(this,"maxDialQueueLength");u(this,"dialTimeout");u(this,"shutDownController");u(this,"connections");u(this,"log");this.addressSorter=t.addressSorter,this.maxPeerAddrsToDial=t.maxPeerAddrsToDial??Ag.maxPeerAddrsToDial,this.maxDialQueueLength=t.maxDialQueueLength??Ag.maxDialQueueLength,this.dialTimeout=t.dialTimeout??Ag.dialTimeout,this.connections=t.connections??new Fc,this.log=e.logger.forComponent("libp2p:connection-manager:dial-queue"),this.components=e,this.shutDownController=new AbortController,this.shutDownController.signal;for(const[n,i]of Object.entries(t.resolvers??{}))cx.set(n,i);this.queue=new HSe({concurrency:t.maxParallelDials??Ag.maxParallelDials,metricName:"libp2p_dial_queue",metrics:e.metrics}),this.queue.addEventListener("error",n=>{var i;((i=n.detail)==null?void 0:i.name)!==Hl.name&&this.log.error("error in dial queue - %e",n.detail)})}start(){this.shutDownController=new AbortController,this.shutDownController.signal}stop(){this.shutDownController.abort(),this.queue.abort()}async dial(e,t={}){var a,c,l;const{peerId:n,multiaddrs:i}=RH(e),s=Array.from(this.connections.values()).flat().find(d=>t.force===!0?!1:d.remotePeer.equals(n)?!0:i.find(h=>h.equals(d.remoteAddr)));if((s==null?void 0:s.status)==="open")return this.log("already connected to %a",s.remoteAddr),(a=t.onProgress)==null||a.call(t,new _e("dial-queue:already-connected")),s;const o=this.queue.queue.find(d=>{if((n==null?void 0:n.equals(d.options.peerId))===!0)return!0;const h=d.options.multiaddrs;if(h==null)return!1;for(const p of i)if(h.has(p.toString()))return!0;return!1});if(o!=null){this.log("joining existing dial target for %p",n);for(const d of i)o.options.multiaddrs.add(d.toString());return(c=t.onProgress)==null||c.call(t,new _e("dial-queue:already-in-dial-queue")),o.join(t)}if(this.queue.size>=this.maxDialQueueLength)throw new gd("Dial queue is full");return this.log("creating dial target for %p",n,i.map(d=>d.toString())),(l=t.onProgress)==null||l.call(t,new _e("dial-queue:add-to-dial-queue")),this.queue.add(async d=>{var p;(p=d.onProgress)==null||p.call(d,new _e("dial-queue:start-dial"));const h=dt([this.shutDownController.signal,d.signal]);try{return await this.dialPeer(d,h)}finally{h.clear()}},{peerId:n,priority:t.priority??KH,multiaddrs:new Set(i.map(d=>d.toString())),signal:t.signal??AbortSignal.timeout(this.dialTimeout),onProgress:t.onProgress})}async dialPeer(e,t){var d;const n=e.peerId,i=e.multiaddrs,s=new Set;let o=e.multiaddrs.size===0,a=0,c=0;const l=[];for(this.log("starting dial to %p",n);o||i.size>0;){c++,o=!1;const h=[],p=new Set(e.multiaddrs);i.clear(),this.log("calculating addrs to dial %p from %s",n,[...p]);const m=await this.calculateMultiaddrs(n,p,{...e,signal:t});for(const f of m){if(s.has(f.multiaddr.toString())){this.log.trace("skipping previously failed multiaddr %a while dialing %p",f.multiaddr,n);continue}h.push(f)}this.log("%s dial to %p with %s",c===1?"starting":"continuing",n,h.map(f=>f.multiaddr.toString())),(d=e==null?void 0:e.onProgress)==null||d.call(e,new _e("dial-queue:calculated-addresses",h));for(const f of h){if(a===this.maxPeerAddrsToDial)throw this.log("dialed maxPeerAddrsToDial (%d) addresses for %p, not trying any others",a,e.peerId),new gd("Peer had more than maxPeerAddrsToDial");a++;try{const g=await this.components.transportManager.dial(f.multiaddr,{...e,signal:t});this.log("dial to %a succeeded",f.multiaddr);try{await this.components.peerStore.merge(g.remotePeer,{multiaddrs:[g.remoteAddr],metadata:{[zSe]:oe(Date.now().toString())}})}catch(v){this.log.error("could not update last dial failure key for %p",n,v)}return g}catch(g){if(this.log.error("dial failed to %a",f.multiaddr,g),s.add(f.multiaddr.toString()),n!=null)try{await this.components.peerStore.merge(n,{metadata:{[FSe]:oe(Date.now().toString())}})}catch(v){this.log.error("could not update last dial failure key for %p",n,v)}if(t.aborted)throw new Bp(g.message);l.push(g)}}}throw l.length===1?l[0]:new AggregateError(l,"All multiaddr dials failed")}async calculateMultiaddrs(e,t=new Set,n={}){var h,p;const i=[...t].map(m=>({multiaddr:Re(m),isCertified:!1}));if(e!=null){if(this.components.peerId.equals(e))throw new gd("Tried to dial self");if(await((p=(h=this.components.connectionGater).denyDialPeer)==null?void 0:p.call(h,e))===!0)throw new D$("The dial request is blocked by gater.allowDialPeer");if(i.length===0){this.log("loading multiaddrs for %p",e);try{const m=await this.components.peerStore.get(e);i.push(...m.addresses),this.log("loaded multiaddrs for %p",e,i.map(({multiaddr:f})=>f.toString()))}catch(m){if(m.name!=="NotFoundError")throw m}}if(i.length===0){this.log("looking up multiaddrs for %p in the peer routing",e);try{const m=await this.components.peerRouting.findPeer(e,n);this.log("found multiaddrs for %p in the peer routing",e,i.map(({multiaddr:f})=>f.toString())),i.push(...m.multiaddrs.map(f=>({multiaddr:f,isCertified:!1})))}catch(m){m.name==="NoPeerRoutersError"?this.log("no peer routers configured",e):this.log.error("looking up multiaddrs for %p in the peer routing failed - %e",e,m)}}}let s=(await Promise.all(i.map(async m=>{const f=await VSe(m.multiaddr,{dns:this.components.dns,...n,log:this.log});return f.length===1&&f[0].equals(m.multiaddr)?m:f.map(g=>({multiaddr:g,isCertified:!1}))}))).flat();if(e!=null){const m=`/p2p/${e.toString()}`;s=s.map(f=>{const g=f.multiaddr.protos().pop();return(g==null?void 0:g.path)===!0?f:f.multiaddr.getPeerId()==null?{multiaddr:f.multiaddr.encapsulate(m),isCertified:f.isCertified}:f})}const o=s.filter(m=>{if(this.components.transportManager.dialTransportForMultiaddr(m.multiaddr)==null)return!1;const f=m.multiaddr.getPeerId();return e!=null&&f!=null?e.equals(f):!0}),a=new Map;for(const m of o){const f=m.multiaddr.toString(),g=a.get(f);if(g!=null){g.isCertified=g.isCertified||m.isCertified||!1;continue}a.set(f,m)}const c=[...a.values()];if(c.length===0)throw new bSe("The dial request has no valid addresses");const l=[];for(const m of c)this.components.connectionGater.denyDialMultiaddr!=null&&await this.components.connectionGater.denyDialMultiaddr(m.multiaddr)||l.push(m);const d=this.addressSorter==null?XSe(l):l.sort(this.addressSorter);if(d.length===0)throw new D$("The connection gater denied all addresses in the dial request");return this.log.trace("addresses for %p before filtering",e??"unknown peer",s.map(({multiaddr:m})=>m.toString())),this.log.trace("addresses for %p after filtering",e??"unknown peer",d.map(({multiaddr:m})=>m.toString())),d}async isDialable(e,t={}){Array.isArray(e)||(e=[e]);try{const n=await this.calculateMultiaddrs(void 0,new Set(e.map(i=>i.toString())),t);return t.runOnLimitedConnection===!1?n.find(i=>!Ic.matches(i.multiaddr))!=null:!0}catch(n){this.log.trace("error calculating if multiaddr(s) were dialable",n)}return!1}}var VH={};function Oi(r,e){typeof e=="boolean"&&(e={forever:e}),this._originalTimeouts=JSON.parse(JSON.stringify(r)),this._timeouts=r,this._options=e||{},this._maxRetryTime=e&&e.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}var exe=Oi;Oi.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)};Oi.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null};Oi.prototype.retry=function(r){if(this._timeout&&clearTimeout(this._timeout),!r)return!1;var e=new Date().getTime();if(r&&e-this._operationStart>=this._maxRetryTime)return this._errors.push(r),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(r);var t=this._timeouts.shift();if(t===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),t=this._cachedTimeouts.slice(-1);else return!1;var n=this;return this._timer=setTimeout(function(){n._attempts++,n._operationTimeoutCb&&(n._timeout=setTimeout(function(){n._operationTimeoutCb(n._attempts)},n._operationTimeout),n._options.unref&&n._timeout.unref()),n._fn(n._attempts)},t),this._options.unref&&this._timer.unref(),!0};Oi.prototype.attempt=function(r,e){this._fn=r,e&&(e.timeout&&(this._operationTimeout=e.timeout),e.cb&&(this._operationTimeoutCb=e.cb));var t=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){t._operationTimeoutCb()},t._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)};Oi.prototype.try=function(r){console.log("Using RetryOperation.try() is deprecated"),this.attempt(r)};Oi.prototype.start=function(r){console.log("Using RetryOperation.start() is deprecated"),this.attempt(r)};Oi.prototype.start=Oi.prototype.try;Oi.prototype.errors=function(){return this._errors};Oi.prototype.attempts=function(){return this._attempts};Oi.prototype.mainError=function(){if(this._errors.length===0)return null;for(var r={},e=null,t=0,n=0;n<this._errors.length;n++){var i=this._errors[n],s=i.message,o=(r[s]||0)+1;r[s]=o,o>=t&&(e=i,t=o)}return e};(function(r){var e=exe;r.operation=function(t){var n=r.timeouts(t);return new e(n,{forever:t&&(t.forever||t.retries===1/0),unref:t&&t.unref,maxRetryTime:t&&t.maxRetryTime})},r.timeouts=function(t){if(t instanceof Array)return[].concat(t);var n={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var i in t)n[i]=t[i];if(n.minTimeout>n.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var s=[],o=0;o<n.retries;o++)s.push(this.createTimeout(o,n));return t&&t.forever&&!s.length&&s.push(this.createTimeout(o,n)),s.sort(function(a,c){return a-c}),s},r.createTimeout=function(t,n){var i=n.randomize?Math.random()+1:1,s=Math.round(i*Math.max(n.minTimeout,1)*Math.pow(n.factor,t));return s=Math.min(s,n.maxTimeout),s},r.wrap=function(t,n,i){if(n instanceof Array&&(i=n,n=null),!i){i=[];for(var s in t)typeof t[s]=="function"&&i.push(s)}for(var o=0;o<i.length;o++){var a=i[o],c=t[a];t[a]=(function(d){var h=r.operation(n),p=Array.prototype.slice.call(arguments,1),m=p.pop();p.push(function(f){h.retry(f)||(f&&(arguments[0]=h.mainError()),m.apply(this,arguments))}),h.attempt(function(){d.apply(t,p)})}).bind(t,c),t[a].options=n}}})(VH);var txe=VH;const rxe=Nc(txe),nxe=Object.prototype.toString,ixe=r=>nxe.call(r)==="[object Error]",sxe=new Set(["network error","Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Load failed","Network request failed","fetch failed","terminated"]);function oxe(r){return r&&ixe(r)&&r.name==="TypeError"&&typeof r.message=="string"?r.message==="Load failed"?r.stack===void 0:sxe.has(r.message):!1}class axe extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,{message:e}=e):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}}const M$=(r,e,t)=>{const n=t.retries-(e-1);return r.attemptNumber=e,r.retriesLeft=n,r};async function cxe(r,e){return new Promise((t,n)=>{e={...e},e.onFailedAttempt??(e.onFailedAttempt=()=>{}),e.shouldRetry??(e.shouldRetry=()=>!0),e.retries??(e.retries=10);const i=rxe.operation(e),s=()=>{var a;i.stop(),n((a=e.signal)==null?void 0:a.reason)};e.signal&&!e.signal.aborted&&e.signal.addEventListener("abort",s,{once:!0});const o=()=>{var a;(a=e.signal)==null||a.removeEventListener("abort",s),i.stop()};i.attempt(async a=>{try{const c=await r(a);o(),t(c)}catch(c){try{if(!(c instanceof Error))throw new TypeError(`Non-error was thrown: "${c}". You should only throw errors.`);if(c instanceof axe)throw c.originalError;if(c instanceof TypeError&&!oxe(c))throw c;if(M$(c,a,e),await e.shouldRetry(c)||(i.stop(),n(c)),await e.onFailedAttempt(c),!i.retry(c))throw i.mainError()}catch(l){M$(l,a,e),o(),n(l)}}})})}class lxe{constructor(e,t={}){u(this,"log");u(this,"queue");u(this,"started");u(this,"peerStore");u(this,"retries");u(this,"retryInterval");u(this,"backoffFactor");u(this,"connectionManager");u(this,"events");this.log=e.logger.forComponent("libp2p:reconnect-queue"),this.peerStore=e.peerStore,this.connectionManager=e.connectionManager,this.queue=new Ac({concurrency:t.maxParallelReconnects??USe,metricName:"libp2p_reconnect_queue",metrics:e.metrics}),this.started=!1,this.retries=t.retries??5,this.backoffFactor=t.backoffFactor,this.retryInterval=t.retryInterval,this.events=e.events,e.events.addEventListener("peer:disconnect",n=>{this.maybeReconnect(n.detail).catch(i=>{this.log.error("failed to maybe reconnect to %p - %e",n.detail,i)})})}async maybeReconnect(e){if(!this.started)return;const t=await this.peerStore.get(e);O$(t)&&(this.queue.has(e)||this.queue.add(async n=>{await cxe(async i=>{if(this.started)try{await this.connectionManager.openConnection(e,{signal:n==null?void 0:n.signal})}catch(s){throw this.log("reconnecting to %p attempt %d of %d failed - %e",e,i,this.retries,s),s}},{signal:n==null?void 0:n.signal,retries:this.retries,factor:this.backoffFactor,minTimeout:this.retryInterval})},{peerId:e}).catch(async n=>{this.log.error("failed to reconnect to %p - %e",e,n);const i={};[...t.tags.keys()].forEach(s=>{s.startsWith(J3)&&(i[s]=void 0)}),await this.peerStore.merge(e,{tags:i}),this.events.safeDispatchEvent("peer:reconnect-failure",{detail:e})}).catch(async n=>{this.log.error("failed to remove keep-alive tag from %p - %e",e,n)}))}start(){this.started=!0}async afterStart(){Promise.resolve().then(async()=>{const e=await this.peerStore.all({filters:[t=>O$(t)]});await Promise.all(e.map(async t=>{await this.connectionManager.openConnection(t.id).catch(n=>{this.log.error(n)})}))}).catch(e=>{this.log.error(e)})}stop(){this.started=!1,this.queue.abort()}}function O$(r){for(const e of r.tags.keys())if(e.startsWith(J3))return!0;return!1}const KH=50,W8={maxConnections:FH,inboundConnectionThreshold:LSe,maxIncomingPendingConnections:BSe};var uM;uM=Symbol.toStringTag;class uxe{constructor(e,t={}){u(this,"started");u(this,"connections");u(this,"allow");u(this,"deny");u(this,"maxIncomingPendingConnections");u(this,"incomingPendingConnections");u(this,"outboundPendingConnections");u(this,"maxConnections");u(this,"dialQueue");u(this,"reconnectQueue");u(this,"connectionPruner");u(this,"inboundConnectionRateLimiter");u(this,"peerStore");u(this,"metrics");u(this,"events");u(this,"log");u(this,"peerId");u(this,uM,"@libp2p/connection-manager");var n;if(this.maxConnections=t.maxConnections??W8.maxConnections,this.maxConnections<1)throw new Z("Connection Manager maxConnections must be greater than 0");this.connections=new Fc,this.started=!1,this.peerId=e.peerId,this.peerStore=e.peerStore,this.metrics=e.metrics,this.events=e.events,this.log=e.logger.forComponent("libp2p:connection-manager"),this.onConnect=this.onConnect.bind(this),this.onDisconnect=this.onDisconnect.bind(this),this.allow=(t.allow??[]).map(i=>x9(i)),this.deny=(t.deny??[]).map(i=>x9(i)),this.incomingPendingConnections=0,this.maxIncomingPendingConnections=t.maxIncomingPendingConnections??W8.maxIncomingPendingConnections,this.outboundPendingConnections=0,this.inboundConnectionRateLimiter=new yj({points:t.inboundConnectionThreshold??W8.inboundConnectionThreshold,duration:1}),this.connectionPruner=new jSe({connectionManager:this,peerStore:e.peerStore,events:e.events,logger:e.logger},{maxConnections:this.maxConnections,allow:(n=t.allow)==null?void 0:n.map(i=>Re(i))}),this.dialQueue=new ZSe(e,{addressSorter:t.addressSorter,maxParallelDials:t.maxParallelDials??zH,maxDialQueueLength:t.maxDialQueueLength??UH,maxPeerAddrsToDial:t.maxPeerAddrsToDial??BH,dialTimeout:t.dialTimeout??LH,resolvers:t.resolvers??{dnsaddr:IH},connections:this.connections}),this.reconnectQueue=new lxe({events:e.events,peerStore:e.peerStore,logger:e.logger,connectionManager:this},{retries:t.reconnectRetries,retryInterval:t.reconnectRetryInterval,backoffFactor:t.reconnectBackoffFactor,maxParallelReconnects:t.maxParallelReconnects})}async start(){var e,t,n;(e=this.metrics)==null||e.registerMetricGroup("libp2p_connection_manager_connections",{calculate:()=>{const i={inbound:0,"inbound pending":this.incomingPendingConnections,outbound:0,"outbound pending":this.outboundPendingConnections};for(const s of this.connections.values())for(const o of s)i[o.direction]++;return i}}),(t=this.metrics)==null||t.registerMetricGroup("libp2p_protocol_streams_total",{label:"protocol",calculate:()=>{const i={};for(const s of this.connections.values())for(const o of s)for(const a of o.streams){const c=`${a.direction} ${a.protocol??"unnegotiated"}`;i[c]=(i[c]??0)+1}return i}}),(n=this.metrics)==null||n.registerMetricGroup("libp2p_connection_manager_protocol_streams_per_connection_90th_percentile",{label:"protocol",calculate:()=>{const i={};for(const o of this.connections.values())for(const a of o){const c={};for(const l of a.streams){const d=`${l.direction} ${l.protocol??"unnegotiated"}`;c[d]=(c[d]??0)+1}for(const[l,d]of Object.entries(c))i[l]=i[l]??[],i[l].push(d)}const s={};for(let[o,a]of Object.entries(i)){a=a.sort((l,d)=>l-d);const c=Math.floor(a.length*.9);s[o]=a[c]}return s}}),this.events.addEventListener("connection:open",this.onConnect),this.events.addEventListener("connection:close",this.onDisconnect),await Vo(this.dialQueue,this.reconnectQueue,this.connectionPruner),this.started=!0,this.log("started")}async stop(){this.events.removeEventListener("connection:open",this.onConnect),this.events.removeEventListener("connection:close",this.onDisconnect),await Bc(this.reconnectQueue,this.dialQueue,this.connectionPruner);const e=[];for(const t of this.connections.values())for(const n of t)e.push((async()=>{try{await n.close()}catch(i){this.log.error(i)}})());this.log("closing %d connections",e.length),await Promise.all(e),this.connections.clear(),this.log("stopped")}getMaxConnections(){return this.maxConnections}onConnect(e){this._onConnect(e).catch(t=>{this.log.error(t)})}async _onConnect(e){const{detail:t}=e;if(!this.started){await t.close();return}if(t.status!=="open")return;const n=t.remotePeer,i=!this.connections.has(n),s=this.connections.get(n)??[];s.push(t),this.connections.set(n,s),n.publicKey!=null&&n.type==="RSA"&&await this.peerStore.patch(n,{publicKey:n.publicKey}),i&&this.events.safeDispatchEvent("peer:connect",{detail:t.remotePeer})}onDisconnect(e){const{detail:t}=e,n=t.remotePeer,s=(this.connections.get(n)??[]).filter(o=>o.id!==t.id);this.connections.set(n,s),s.length===0&&(this.log("onDisconnect remove all connections for peer %p",n),this.connections.delete(n),this.events.safeDispatchEvent("peer:disconnect",{detail:t.remotePeer}))}getConnections(e){if(e!=null)return this.connections.get(e)??[];let t=[];for(const n of this.connections.values())t=t.concat(n);return t}getConnectionsMap(){return this.connections}async openConnection(e,t={}){var n,i;if(!this.started)throw new ql("Not started");this.outboundPendingConnections++;try{(n=t.signal)==null||n.throwIfAborted();const{peerId:s}=RH(e);if(this.peerId.equals(s))throw new iS("Can not dial self");if(s!=null&&t.force!==!0){this.log("dial %p",s);const l=this.getConnections(s).find(d=>d.limits==null);if(l!=null)return this.log("had an existing non-limited connection to %p",s),(i=t.onProgress)==null||i.call(t,new _e("dial-queue:already-connected")),l}const o=await this.dialQueue.dial(e,{...t,priority:t.priority??KH});if(o.status!=="open")throw new rS("Remote closed connection during opening");let a=this.connections.get(o.remotePeer);a==null&&(a=[],this.connections.set(o.remotePeer,a));let c=!1;for(const l of a)if(l.id===o.id&&(c=!0),t.force!==!0&&l.id!==o.id&&l.remoteAddr.equals(o.remoteAddr))return o.abort(new Z3("Duplicate multiaddr connection")),l;return c||a.push(o),o}finally{this.outboundPendingConnections--}}async closeConnections(e,t={}){const n=this.connections.get(e)??[];await Promise.all(n.map(async i=>{try{await i.close(t)}catch(s){i.abort(s)}}))}async acceptIncomingConnection(e){if(this.deny.some(i=>i.contains(e.remoteAddr.nodeAddress().address)))return this.log("connection from %a refused - connection remote address was in deny list",e.remoteAddr),!1;if(this.allow.some(i=>i.contains(e.remoteAddr.nodeAddress().address)))return this.incomingPendingConnections++,!0;if(this.incomingPendingConnections===this.maxIncomingPendingConnections)return this.log("connection from %a refused - incomingPendingConnections exceeded by host",e.remoteAddr),!1;if(e.remoteAddr.isThinWaistAddress()){const i=e.remoteAddr.nodeAddress().address;try{await this.inboundConnectionRateLimiter.consume(i,1)}catch{return this.log("connection from %a refused - inboundConnectionThreshold exceeded by host %s",e.remoteAddr,i),!1}}return this.getConnections().length<this.maxConnections?(this.incomingPendingConnections++,!0):(this.log("connection from %a refused - maxConnections exceeded",e.remoteAddr),!1)}afterUpgradeInbound(){this.incomingPendingConnections--}getDialQueue(){const e={queued:"queued",running:"active",errored:"error",complete:"success"};return this.dialQueue.queue.queue.map(t=>({id:t.id,status:e[t.status],peerId:t.options.peerId,multiaddrs:[...t.options.multiaddrs].map(n=>Re(n))}))}async isDialable(e,t={}){return this.dialQueue.isDialable(e,t)}}const dxe=1e4,hxe="1.0.0",fxe="ping",pxe="ipfs",R$=32,gxe=!0;var dM,hM;hM=Symbol.toStringTag,dM=fr;class yxe{constructor(e,t={}){u(this,"protocol");u(this,"components");u(this,"log");u(this,"heartbeatInterval");u(this,"pingIntervalMs");u(this,"abortController");u(this,"timeout");u(this,"abortConnectionOnPingFailure");u(this,hM,"@libp2p/connection-monitor");u(this,dM,["@libp2p/connection-monitor"]);this.components=e,this.protocol=`/${t.protocolPrefix??pxe}/${fxe}/${hxe}`,this.log=e.logger.forComponent("libp2p:connection-monitor"),this.pingIntervalMs=t.pingInterval??dxe,this.abortConnectionOnPingFailure=t.abortConnectionOnPingFailure??gxe,this.timeout=new ip({...t.pingTimeout??{},metrics:e.metrics,metricName:"libp2p_connection_monitor_ping_time_milliseconds"})}start(){this.abortController=new AbortController,this.abortController.signal,this.heartbeatInterval=setInterval(()=>{this.components.connectionManager.getConnections().forEach(e=>{Promise.resolve().then(async()=>{var n;let t=Date.now();try{const i=this.timeout.getTimeoutSignal({signal:(n=this.abortController)==null?void 0:n.signal}),s=await e.newStream(this.protocol,{signal:i,runOnLimitedConnection:!0}),o=sm(s);t=Date.now(),await Promise.all([o.write(xc(R$),{signal:i}),o.read({bytes:R$,signal:i})]),e.rtt=Date.now()-t,await o.unwrap().close({signal:i})}catch(i){if(i.name!=="UnsupportedProtocolError")throw i;e.rtt=(Date.now()-t)/2}}).catch(t=>{this.log.error("error during heartbeat",t),this.abortConnectionOnPingFailure?(this.log.error("aborting connection due to ping failure"),e.abort(t)):this.log("connection ping failed, but not aborting due to abortConnectionOnPingFailure flag")})})},this.pingIntervalMs)}stop(){var e;(e=this.abortController)==null||e.abort(),this.heartbeatInterval!=null&&clearInterval(this.heartbeatInterval)}}var fM;fM=Symbol.toStringTag;class mxe{constructor(e,t){u(this,"routers");u(this,"started");u(this,"components");u(this,fM,"@libp2p/content-routing");var n,i,s,o,a;this.routers=t.routers??[],this.started=!1,this.components=e,this.findProviders=((n=e.metrics)==null?void 0:n.traceFunction("libp2p.contentRouting.findProviders",this.findProviders.bind(this),{optionsIndex:1,getAttributesFromArgs:([c],l)=>({...l,cid:c.toString()}),getAttributesFromYieldedValue:(c,l)=>({...l,providers:[...Array.isArray(l.providers)?l.providers:[],c.id.toString()]})}))??this.findProviders,this.provide=((i=e.metrics)==null?void 0:i.traceFunction("libp2p.contentRouting.provide",this.provide.bind(this),{optionsIndex:1,getAttributesFromArgs:([c],l)=>({...l,cid:c.toString()})}))??this.provide,this.cancelReprovide=((s=e.metrics)==null?void 0:s.traceFunction("libp2p.contentRouting.cancelReprovide",this.cancelReprovide.bind(this),{optionsIndex:1,getAttributesFromArgs:([c],l)=>({...l,cid:c.toString()})}))??this.cancelReprovide,this.put=((o=e.metrics)==null?void 0:o.traceFunction("libp2p.contentRouting.put",this.put.bind(this),{optionsIndex:2,getAttributesFromArgs:([c])=>({key:re(c,"base36")})}))??this.put,this.get=((a=e.metrics)==null?void 0:a.traceFunction("libp2p.contentRouting.get",this.get.bind(this),{optionsIndex:1,getAttributesFromArgs:([c])=>({key:re(c,"base36")})}))??this.get}isStarted(){return this.started}async start(){this.started=!0}async stop(){this.started=!1}async*findProviders(e,t={}){if(this.routers.length===0)throw new q8("No content routers available");const n=this,i=new cs;for await(const s of cc(...n.routers.map(o=>o.findProviders(e,t))))s!=null&&(s.multiaddrs.length>0&&await this.components.peerStore.merge(s.id,{multiaddrs:s.multiaddrs}),!i.has(s.id)&&(i.add(s.id),yield s))}async provide(e,t={}){if(this.routers.length===0)throw new q8("No content routers available");await Promise.all(this.routers.map(async n=>{await n.provide(e,t)}))}async cancelReprovide(e,t={}){if(this.routers.length===0)throw new q8("No content routers available");await Promise.all(this.routers.map(async n=>{await n.cancelReprovide(e,t)}))}async put(e,t,n){if(!this.isStarted())throw new ql;await Promise.all(this.routers.map(async i=>{await i.put(e,t,n)}))}async get(e,t){if(!this.isStarted())throw new ql;return Promise.any(this.routers.map(async n=>n.get(e,t)))}}var pM;pM=Symbol.toStringTag;class wxe{constructor(e,t={}){u(this,"log");u(this,"peerId");u(this,"peerStore");u(this,"routers");u(this,pM,"@libp2p/peer-routing");var n,i;this.log=e.logger.forComponent("libp2p:peer-routing"),this.peerId=e.peerId,this.peerStore=e.peerStore,this.routers=t.routers??[],this.findPeer=((n=e.metrics)==null?void 0:n.traceFunction("libp2p.peerRouting.findPeer",this.findPeer.bind(this),{optionsIndex:1,getAttributesFromArgs:([s],o)=>({...o,peer:s.toString()})}))??this.findPeer,this.getClosestPeers=((i=e.metrics)==null?void 0:i.traceFunction("libp2p.peerRouting.getClosestPeers",this.getClosestPeers.bind(this),{optionsIndex:1,getAttributesFromArgs:([s],o)=>({...o,key:re(s,"base36")}),getAttributesFromYieldedValue:(s,o)=>({...o,peers:[...Array.isArray(o.peers)?o.peers:[],s.id.toString()]})}))??this.getClosestPeers}async findPeer(e,t){if(this.routers.length===0)throw new P$("No peer routers available");if(e.toString()===this.peerId.toString())throw new pSe("Should not try to find self");const n=this,i=cc(...this.routers.map(s=>async function*(){try{yield await s.findPeer(e,t)}catch(o){n.log.error(o)}}()));for await(const s of i)if(s!=null)return s.multiaddrs.length>0&&await this.peerStore.merge(s.id,{multiaddrs:s.multiaddrs}),s;throw new Zt}async*getClosestPeers(e,t={}){if(this.routers.length===0)throw new P$("No peer routers available");const n=this,i=Ql(1024);for await(const s of Gp(async function*(){const o=cc(...n.routers.map(a=>a.getClosestPeers(e,t)));for await(let a of o)yield async()=>{if(a.multiaddrs.length===0)try{a=await n.findPeer(a.id,{...t,useCache:!1})}catch(c){n.log.error("could not find peer multiaddrs",c);return}return a}}()))s!=null&&(s.multiaddrs.length>0&&await this.peerStore.merge(s.id,{multiaddrs:s.multiaddrs}),!i.has(s.id.toMultihash().bytes)&&(i.add(s.id.toMultihash().bytes),yield s))}}var gM,yM;class bxe extends(yM=er,gM=Symbol.toStringTag,yM){constructor(t){super();u(this,"peerRouting");u(this,"log");u(this,"walking");u(this,"walkers");u(this,"shutdownController");u(this,"walkController");u(this,"needNext");u(this,gM,"@libp2p/random-walk");this.log=t.logger.forComponent("libp2p:random-walk"),this.peerRouting=t.peerRouting,this.walkers=0,this.walking=!1,this.shutdownController=new AbortController,this.shutdownController.signal}start(){this.shutdownController=new AbortController,this.shutdownController.signal}stop(){this.shutdownController.abort()}async*walk(t){var i,s;this.walking||this.startWalk(),this.walkers++;const n=dt([this.shutdownController.signal,t==null?void 0:t.signal]);try{for(;;)(i=this.needNext)==null||i.resolve(),this.needNext=Le(),yield(await Ci(this,"walk:peer",n,{errorEvent:"walk:error"})).detail}finally{n.clear(),this.walkers--,this.walkers===0&&((s=this.walkController)==null||s.abort(),this.walkController=void 0)}}startWalk(){this.walking=!0,this.walkController=new AbortController,this.walkController.signal;const t=dt([this.walkController.signal,this.shutdownController.signal]),n=Date.now();let i=0;Promise.resolve().then(async()=>{for(this.log("start walk");this.walkers>0;)try{const s=xc(32);let o=Date.now();for await(const a of this.peerRouting.getClosestPeers(s,{signal:t}))t.aborted&&this.log("aborting walk"),t.throwIfAborted(),this.log("found peer %p after %dms for %d walkers",a.id,Date.now()-o,this.walkers),i++,this.safeDispatchEvent("walk:peer",{detail:a}),this.walkers===1&&this.needNext!=null&&(this.log("wait for need next"),await cn(this.needNext.promise,t)),o=Date.now();this.log("walk iteration for %b and %d walkers finished, found %d peers",s,this.walkers,i)}catch(s){this.log.error("random walk errored",s),this.safeDispatchEvent("walk:error",{detail:s})}this.log("no walkers left, ended walk")}).catch(s=>{this.log.error("random walk errored",s)}).finally(()=>{this.log("finished walk, found %d peers after %dms",i,Date.now()-n),this.walking=!1})}}const jH=32,HH=64;var mM;mM=Symbol.toStringTag;class vxe{constructor(e){u(this,"log");u(this,"topologies");u(this,"handlers");u(this,"components");u(this,mM,"@libp2p/registrar");this.log=e.logger.forComponent("libp2p:registrar"),this.topologies=new Map,this.handlers=new Map,this.components=e,this._onDisconnect=this._onDisconnect.bind(this),this._onPeerUpdate=this._onPeerUpdate.bind(this),this._onPeerIdentify=this._onPeerIdentify.bind(this),this.components.events.addEventListener("peer:disconnect",this._onDisconnect),this.components.events.addEventListener("peer:update",this._onPeerUpdate),this.components.events.addEventListener("peer:identify",this._onPeerIdentify)}getProtocols(){return Array.from(new Set([...this.handlers.keys()])).sort()}getHandler(e){const t=this.handlers.get(e);if(t==null)throw new gSe(`No handler registered for protocol ${e}`);return t}getTopologies(e){const t=this.topologies.get(e);return t==null?[]:[...t.values()]}async handle(e,t,n){if(this.handlers.has(e)&&(n==null?void 0:n.force)!==!0)throw new ySe(`Handler already registered for protocol ${e}`);const i=$x.bind({ignoreUndefined:!0})({maxInboundStreams:jH,maxOutboundStreams:HH},n);this.handlers.set(e,{handler:t,options:i}),await this.components.peerStore.merge(this.components.peerId,{protocols:[e]})}async unhandle(e){(Array.isArray(e)?e:[e]).forEach(n=>{this.handlers.delete(n)}),await this.components.peerStore.patch(this.components.peerId,{protocols:this.getProtocols()})}async register(e,t){if(t==null)throw new Z("invalid topology");const n=`${(Math.random()*1e9).toString(36)}${Date.now()}`;let i=this.topologies.get(e);return i==null&&(i=new Map,this.topologies.set(e,i)),i.set(n,t),n}unregister(e){for(const[t,n]of this.topologies.entries())n.has(e)&&(n.delete(e),n.size===0&&this.topologies.delete(t))}_onDisconnect(e){const t=e.detail;this.components.peerStore.get(t).then(n=>{var i,s,o;for(const a of n.protocols){const c=this.topologies.get(a);if(c!=null)for(const l of c.values())((i=l.filter)==null?void 0:i.has(t))!==!1&&((s=l.filter)==null||s.remove(t),(o=l.onDisconnect)==null||o.call(l,t))}}).catch(n=>{n.name!=="NotFoundError"&&this.log.error("could not inform topologies of disconnecting peer %p",t,n)})}_onPeerUpdate(e){var s,o,a;const{peer:t,previous:n}=e.detail,i=((n==null?void 0:n.protocols)??[]).filter(c=>!t.protocols.includes(c));for(const c of i){const l=this.topologies.get(c);if(l!=null)for(const d of l.values())((s=d.filter)==null?void 0:s.has(t.id))!==!1&&((o=d.filter)==null||o.remove(t.id),(a=d.onDisconnect)==null||a.call(d,t.id))}}_onPeerIdentify(e){var s,o,a;const t=e.detail.protocols,n=e.detail.connection,i=e.detail.peerId;for(const c of t){const l=this.topologies.get(c);if(l!=null)for(const d of l.values())n.limits!=null&&d.notifyOnLimitedConnection!==!0||((s=d.filter)==null?void 0:s.has(i))!==!0&&((o=d.filter)==null||o.add(i),(a=d.onConnect)==null||a.call(d,i,n))}}}var wM;wM=Symbol.toStringTag;class Exe{constructor(e,t={}){u(this,"log");u(this,"components");u(this,"transports");u(this,"listeners");u(this,"faultTolerance");u(this,"started");u(this,wM,"@libp2p/transport-manager");this.log=e.logger.forComponent("libp2p:transports"),this.components=e,this.started=!1,this.transports=new Map,this.listeners=YF({name:"libp2p_transport_manager_listeners",metrics:this.components.metrics}),this.faultTolerance=t.faultTolerance??jl.FATAL_ALL}add(e){const t=e[Symbol.toStringTag];if(t==null)throw new Z("Transport must have a valid tag");if(this.transports.has(t))throw new Z(`There is already a transport with the tag ${t}`);this.log("adding transport %s",t),this.transports.set(t,e),this.listeners.has(t)||this.listeners.set(t,[])}isStarted(){return this.started}start(){this.started=!0}async afterStart(){const e=this.components.addressManager.getListenAddrs();await this.listen(e)}async stop(){const e=[];for(const[t,n]of this.listeners)for(this.log("closing listeners for %s",t);n.length>0;){const i=n.pop();i!=null&&e.push(i.close())}await Promise.all(e),this.log("all listeners closed");for(const t of this.listeners.keys())this.listeners.set(t,[]);this.started=!1}async dial(e,t){var i;const n=this.dialTransportForMultiaddr(e);if(n==null)throw new SSe(`No transport available for address ${String(e)}`);return(i=t==null?void 0:t.onProgress)==null||i.call(t,new _e("transport-manager:selected-transport",n[Symbol.toStringTag])),n.dial(e,{...t,upgrader:this.components.upgrader})}getAddrs(){let e=[];for(const t of this.listeners.values())for(const n of t)e=[...e,...n.getAddrs()];return e}getTransports(){return Array.of(...this.transports.values())}getListeners(){return Array.of(...this.listeners.values()).flat()}dialTransportForMultiaddr(e){for(const t of this.transports.values())if(t.dialFilter([e]).length>0)return t}listenTransportForMultiaddr(e){for(const t of this.transports.values())if(t.listenFilter([e]).length>0)return t}async listen(e){if(!this.isStarted())throw new ql("Not started");if(e==null||e.length===0){this.log("no addresses were provided for listening, this node is dial only");return}const t={errors:new Map,ipv4:{success:0,attempts:0},ipv6:{success:0,attempts:0}};e.forEach(s=>{t.errors.set(s.toString(),new mSe)});const n=[];for(const[s,o]of this.transports.entries()){const a=o.listenFilter(e);for(const c of a){this.log("creating listener for %s on %a",s,c);const l=o.createListener({upgrader:this.components.upgrader});let d=this.listeners.get(s)??[];d==null&&(d=[],this.listeners.set(s,d)),d.push(l),l.addEventListener("listening",()=>{this.components.events.safeDispatchEvent("transport:listening",{detail:l})}),l.addEventListener("close",()=>{const h=d.findIndex(p=>p===l);d.splice(h,1),this.components.events.safeDispatchEvent("transport:close",{detail:l})}),v_.matches(c)?t.ipv4.attempts++:E_.matches(c)&&t.ipv6.attempts++,n.push(l.listen(c).then(()=>{t.errors.delete(c.toString()),v_.matches(c)&&t.ipv4.success++,E_.matches(c)&&t.ipv6.success++},h=>{throw this.log.error("transport %s could not listen on address %a - %e",s,c,h),t.errors.set(c.toString(),h),h}))}}const i=await Promise.allSettled(n);if(!(i.length>0&&i.every(s=>s.status==="fulfilled"))){if(this.ipv6Unsupported(t)){this.log("all IPv4 addresses succeed but all IPv6 failed");return}if(this.faultTolerance===jl.NO_FATAL){this.log("failed to listen on any address but fault tolerance allows this");return}throw new wSe(`Some configured addresses failed to be listened on, you may need to remove one or more listen addresses from your configuration or set \`transportManager.faultTolerance\` to NO_FATAL:
${[...t.errors.entries()].map(([s,o])=>`
  ${s}: ${`${o.stack??o}`.split(`
`).join(`
  `)}
`).join("")}`)}}ipv6Unsupported(e){if(e.ipv4.attempts===0||e.ipv6.attempts===0)return!1;const t=e.ipv4.attempts===e.ipv4.success,n=e.ipv6.success===0;return t&&n}async remove(e){const t=this.listeners.get(e)??[];this.log.trace("removing transport %s",e);const n=[];for(this.log.trace("closing listeners for %s",e);t.length>0;){const i=t.pop();i!=null&&n.push(i.close())}await Promise.all(n),this.transports.delete(e),this.listeners.delete(e)}async removeAll(){const e=[];for(const t of this.transports.keys())e.push(this.remove(t));await Promise.all(e)}}const An="/multistream/1.0.0",NA=1024,Sxe=oe(`
`);async function Qf(r,e,t){await r.write(e,t)}async function xxe(r,e,t){await r.writeV(e,t)}async function Axe(r,e){const t=await r.read(e);if(t.byteLength===0||t.get(t.byteLength-1)!==Sxe[0])throw e.log.error("Invalid mss message - missing newline",t),new xt("Missing newline");return t.sublist(0,-1)}async function Ad(r,e){const t=await Axe(r,e);return re(t.subarray())}async function G8(r,e,t){if(e=Array.isArray(e)?[...e]:[e],e.length===1&&t.negotiateFully===!1)return Cxe(r,e[0],t);const n=nh(r,{...t,maxDataLength:NA}),i=e.shift();if(i==null)throw new Error("At least one protocol must be specified");t.log.trace('select: write ["%s", "%s"]',An,i);const s=oe(`${An}
`),o=oe(`${i}
`);await xxe(n,[s,o],t),t.log.trace("select: reading multistream-select header");let a=await Ad(n,t);if(t.log.trace('select: read "%s"',a),a===An&&(t.log.trace("select: reading protocol response"),a=await Ad(n,t),t.log.trace('select: read "%s"',a)),a===i)return{stream:n.unwrap(),protocol:i};for(const c of e){t.log.trace('select: write "%s"',c),await Qf(n,oe(`${c}
`),t),t.log.trace("select: reading protocol response");const l=await Ad(n,t);if(t.log.trace('select: read "%s" for "%s"',l,c),l===c)return{stream:n.unwrap(),protocol:c}}throw new Lp("protocol selection failed")}function Cxe(r,e,t){const n=r.sink.bind(r),i=r.source;let s=!1,o=!1;const a=Le();let c=!1,l=!1;const d=Le();let h=!1,p=!1;const m=Le(),f=nh({sink:n,source:i},{...t,maxDataLength:NA});r.sink=async w=>{const{sink:b}=f.unwrap();await b(async function*(){let E=!1;for await(const A of w){if(l&&await d.promise,c)yield A;else{l=!0,t.log.trace('optimistic: write ["%s", "%s", data(%d)] in sink',An,e,A.byteLength);const k=`${e}
`;yield new Ue(Uint8Array.from([19]),oe(`${An}
`),xr(k.length),oe(k),A).subarray(),t.log.trace('optimistic: wrote ["%s", "%s", data(%d)] in sink',An,e,A.byteLength),c=!0,l=!1,d.resolve(),g().catch(x=>{t.log.error("could not finish optimistic protocol negotiation of %s",e,x)})}E=!0}E||await g()}())};async function g(){if(o){t.log.trace("optimistic: already negotiating %s stream",e),await a.promise;return}o=!0;try{c||(t.log.trace("optimistic: doing send protocol for %s stream",e),await v()),h||(t.log.trace("optimistic: doing read protocol for %s stream",e),await y())}finally{o=!1,s=!0,a.resolve()}}async function v(){if(l){await d.promise;return}l=!0;try{t.log.trace('optimistic: write ["%s", "%s", data] in source',An,e),await f.writeV([oe(`${An}
`),oe(`${e}
`)]),t.log.trace('optimistic: wrote ["%s", "%s", data] in source',An,e)}finally{c=!0,l=!1,d.resolve()}}async function y(){if(p){await m.promise;return}p=!0;try{t.log.trace("optimistic: reading multistream select header");let w=await Ad(f,t);if(t.log.trace('optimistic: read multistream select header "%s"',w),w===An&&(w=await Ad(f,t)),t.log.trace('optimistic: read protocol "%s", expecting "%s"',w,e),w!==e)throw new Lp("protocol selection failed")}finally{h=!0,p=!1,m.resolve()}}if(r.source=async function*(){await g(),t.log.trace('optimistic: reading data from "%s" stream',e),yield*f.unwrap().source}(),r.closeRead!=null){const w=r.closeRead.bind(r);r.closeRead=async b=>{s||await g().catch(E=>{t.log.error("could not negotiate protocol before close read",E)}),await w(b)}}if(r.closeWrite!=null){const w=r.closeWrite.bind(r);r.closeWrite=async b=>{s||await g().catch(E=>{t.log.error("could not negotiate protocol before close write",E)}),await w(b)}}if(r.close!=null){const w=r.close.bind(r);r.close=async b=>{const E=[];l&&E.push(d.promise),p&&E.push(m.promise),E.length>0?await cn(Promise.all(E),b==null?void 0:b.signal):(s=!0,o=!1,a.resolve()),await w(b)}}return{stream:r,protocol:e}}async function Q8(r,e,t){e=Array.isArray(e)?e:[e],t.log.trace("handle: available protocols %s",e);const n=nh(r,{...t,maxDataLength:NA,maxLengthLength:2});for(;;){t.log.trace("handle: reading incoming string");const i=await Ad(n,t);if(t.log.trace('handle: read "%s"',i),i===An){t.log.trace('handle: respond with "%s" for "%s"',An,i),await Qf(n,oe(`${An}
`),t),t.log.trace('handle: responded with "%s" for "%s"',An,i);continue}if(e.includes(i))return t.log.trace('handle: respond with "%s" for "%s"',i,i),await Qf(n,oe(`${i}
`),t),t.log.trace('handle: responded with "%s" for "%s"',i,i),{stream:n.unwrap(),protocol:i};if(i==="ls"){const s=new Ue(...e.map(o=>Qd.single(oe(`${o}
`))),oe(`
`));t.log.trace('handle: respond with "%s" for %s',e,i),await Qf(n,s,t),t.log.trace('handle: responded with "%s" for %s',e,i);continue}t.log.trace('handle: respond with "na" for "%s"',i),await Qf(n,oe(`na
`),t),t.log('handle: responded with "na" for "%s"',i)}}const Ixe=500;var bM,vM;vM=Symbol.toStringTag,bM=RZ;class kxe{constructor(e){u(this,"id");u(this,"remoteAddr");u(this,"remotePeer");u(this,"direction");u(this,"timeline");u(this,"multiplexer");u(this,"encryption");u(this,"status");u(this,"limits");u(this,"log");u(this,"tags");u(this,"_newStream");u(this,"_close");u(this,"_abort");u(this,"_getStreams");u(this,vM,"Connection");u(this,bM,!0);const{remoteAddr:t,remotePeer:n,newStream:i,close:s,abort:o,getStreams:a}=e;this.id=`${parseInt(String(Math.random()*1e9)).toString(36)}${Date.now()}`,this.remoteAddr=t,this.remotePeer=n,this.direction=e.direction,this.status="open",this.timeline=e.timeline,this.multiplexer=e.multiplexer,this.encryption=e.encryption,this.limits=e.limits,this.log=e.logger.forComponent(`libp2p:connection:${this.direction}:${this.id}`),this.remoteAddr.getPeerId()==null&&(this.remoteAddr=this.remoteAddr.encapsulate(`/p2p/${this.remotePeer}`)),this._newStream=i,this._close=s,this._abort=o,this._getStreams=a,this.tags=[]}get streams(){return this._getStreams()}async newStream(e,t){if(this.status==="closing")throw new rB("the connection is being closed");if(this.status==="closed")throw new rS("the connection is closed");if(Array.isArray(e)||(e=[e]),this.limits!=null&&(t==null?void 0:t.runOnLimitedConnection)!==!0)throw new sS("Cannot open protocol stream on limited connection");const n=await this._newStream(e,t);return n.direction="outbound",n}async close(e={}){if(!(this.status==="closed"||this.status==="closing")){if(this.log("closing connection to %a",this.remoteAddr),this.status="closing",e.signal==null){const t=AbortSignal.timeout(Ixe);e={...e,signal:t}}try{this.log.trace("closing underlying transport"),await this._close(e),this.log.trace("updating timeline with close time"),this.status="closed",this.timeline.close=Date.now()}catch(t){this.log.error("error encountered during graceful close of connection to %a",this.remoteAddr,t),this.abort(t)}}}abort(e){this.status!=="closed"&&(this.log.error("aborting connection to %a due to error",this.remoteAddr,e),this.status="closing",this._abort(e),this.status="closed",this.timeline.close=Date.now())}}function _xe(r){return new kxe(r)}function Txe(r,e){try{const{options:t}=e.getHandler(r);return t.maxInboundStreams}catch(t){if(t.name!=="UnhandledProtocolError")throw t}return jH}function Pxe(r,e,t={}){try{const{options:n}=e.getHandler(r);if(n.maxOutboundStreams!=null)return n.maxOutboundStreams}catch(n){if(n.name!=="UnhandledProtocolError")throw n}return t.maxOutboundStreams??HH}function L$(r,e,t){let n=0;return t.streams.forEach(i=>{i.direction===e&&i.protocol===r&&n++}),n}var EM;EM=Symbol.toStringTag;class Dxe{constructor(e,t){u(this,"components");u(this,"connectionEncrypters");u(this,"streamMuxers");u(this,"inboundUpgradeTimeout");u(this,"inboundStreamProtocolNegotiationTimeout");u(this,"outboundStreamProtocolNegotiationTimeout");u(this,"events");u(this,"metrics");u(this,EM,"@libp2p/upgrader");var n,i;this.components=e,this.connectionEncrypters=new Map,t.connectionEncrypters.forEach(s=>{this.connectionEncrypters.set(s.protocol,s)}),this.streamMuxers=new Map,t.streamMuxers.forEach(s=>{this.streamMuxers.set(s.protocol,s)}),this.inboundUpgradeTimeout=t.inboundUpgradeTimeout??RSe,this.inboundStreamProtocolNegotiationTimeout=t.inboundStreamProtocolNegotiationTimeout??$$,this.outboundStreamProtocolNegotiationTimeout=t.outboundStreamProtocolNegotiationTimeout??$$,this.events=e.events,this.metrics={dials:(n=e.metrics)==null?void 0:n.registerCounterGroup("libp2p_connection_manager_dials_total"),errors:(i=e.metrics)==null?void 0:i.registerCounterGroup("libp2p_connection_manager_dial_errors_total")}}async shouldBlockConnection(e,...t){const n=this.components.connectionGater[e];if(n==null)return;if(await n.apply(this.components.connectionGater,t)===!0)throw new vSe(`The multiaddr connection is blocked by gater.${e}`)}createInboundAbortSignal(e){return dt([AbortSignal.timeout(this.inboundUpgradeTimeout),e])}async upgradeInbound(e,t){var s,o;let n=!1;const i=this.createInboundAbortSignal(t.signal);try{if((s=this.metrics.dials)==null||s.increment({inbound:!0}),n=await this.components.connectionManager.acceptIncomingConnection(e),!n)throw new ESe("Connection denied");await this.shouldBlockConnection("denyInboundConnection",e),await this._performUpgrade(e,"inbound",{...t,signal:i})}catch(a){throw(o=this.metrics.errors)==null||o.increment({inbound:!0}),a}finally{i.clear(),n&&this.components.connectionManager.afterUpgradeInbound()}}async upgradeOutbound(e,t){var n,i;try{(n=this.metrics.dials)==null||n.increment({outbound:!0});const s=e.remoteAddr.getPeerId();let o;s!=null&&(o=Jt(s),await this.shouldBlockConnection("denyOutboundConnection",o,e));let a="outbound";return t.initiator===!1&&(a="inbound"),await this._performUpgrade(e,a,t)}catch(s){throw(i=this.metrics.errors)==null||i.increment({outbound:!0}),s}}async _performUpgrade(e,t,n){var d,h,p;let i,s,o,a,c;(d=this.components.metrics)==null||d.trackMultiaddrConnection(e),e.log.trace("starting the %s connection upgrade",t);let l=e;if((n==null?void 0:n.skipProtection)!==!0){const m=this.components.connectionProtector;m!=null&&(e.log("protecting the %s connection",t),l=await m.protect(e,n))}try{if(i=l,(n==null?void 0:n.skipEncryption)!==!0){(h=n==null?void 0:n.onProgress)==null||h.call(n,new _e(`upgrader:encrypt-${t}-connection`)),{conn:i,remotePeer:s,protocol:c,streamMuxer:a}=await(t==="inbound"?this._encryptInbound(l,n):this._encryptOutbound(l,n));const m={...l,...i};await this.shouldBlockConnection(t==="inbound"?"denyInboundEncryptedConnection":"denyOutboundEncryptedConnection",s,m)}else{const m=e.remoteAddr.getPeerId();if(m==null)throw new Z3(`${t} connection that skipped encryption must have a peer id`);const f=Jt(m);c="native",s=f}if(s.equals(this.components.peerId)){const m=new iS("Can not dial self");throw e.abort(m),m}if(o=i,(n==null?void 0:n.muxerFactory)!=null)a=n.muxerFactory;else if(a==null&&this.streamMuxers.size>0){(p=n==null?void 0:n.onProgress)==null||p.call(n,new _e(`upgrader:multiplex-${t}-connection`));const m=await(t==="inbound"?this._multiplexInbound({...l,...i},this.streamMuxers,n):this._multiplexOutbound({...l,...i},this.streamMuxers,n));a=m.muxerFactory,o=m.stream}}catch(m){throw e.log.error("failed to upgrade inbound connection %s %a - %e",t==="inbound"?"from":"to",e.remoteAddr,m),m}return await this.shouldBlockConnection(t==="inbound"?"denyInboundUpgradedConnection":"denyOutboundUpgradedConnection",s,e),e.log("successfully upgraded %s connection",t),this._createConnection({cryptoProtocol:c,direction:t,maConn:e,upgradedConn:o,muxerFactory:a,remotePeer:s,limits:n==null?void 0:n.limits})}_createConnection(e){const{cryptoProtocol:t,direction:n,maConn:i,upgradedConn:s,remotePeer:o,muxerFactory:a,limits:c}=e;let l,d,h;a!=null&&(l=a.createStreamMuxer({direction:n,onIncomingStream:f=>{h!=null&&Promise.resolve().then(async()=>{var A;const g=this.components.registrar.getProtocols(),v=AbortSignal.timeout(this.inboundStreamProtocolNegotiationTimeout),{stream:y,protocol:w}=await Q8(f,g,{signal:v,log:f.log,yieldBytes:!1});if(h==null)return;h.log("incoming stream opened on %s",w);const b=Txe(w,this.components.registrar);if(L$(w,"inbound",h)===b){const k=new oB(`Too many inbound protocol streams for protocol "${w}" - limit ${b}`);throw f.abort(k),k}f.source=y.source,f.sink=y.sink,f.protocol=w,y.closeWrite!=null&&(f.closeWrite=y.closeWrite),y.closeRead!=null&&(f.closeRead=y.closeRead),y.close!=null&&(f.close=y.close),await this.components.peerStore.merge(o,{protocols:[w]}),(A=this.components.metrics)==null||A.trackProtocolStream(f,h),this._onStream({connection:h,stream:f,protocol:w})}).catch(async g=>{h.log.error("error handling incoming stream id %s - %e",f.id,g),f.timeline.close==null&&await f.close()})}}),d=async(f,g={})=>{var y;if(l==null)throw new Sg("Connection is not multiplexed");h.log.trace("starting new stream for protocols %s",f);const v=await l.newStream();h.log.trace("started new stream %s for protocols %s",v.id,f);try{if(g.signal==null){v.log("no abort signal was passed while trying to negotiate protocols %s falling back to default timeout",f);const k=AbortSignal.timeout(this.outboundStreamProtocolNegotiationTimeout);g={...g,signal:k}}v.log.trace("selecting protocol from protocols %s",f);const{stream:w,protocol:b}=await G8(v,f,{...g,log:v.log,yieldBytes:!0});v.log.trace("selected protocol %s",b);const E=Pxe(b,this.components.registrar,g),A=L$(b,"outbound",h);if(A>=E){const k=new tw(`Too many outbound protocol streams for protocol "${b}" - ${A}/${E}`);throw v.abort(k),k}return await this.components.peerStore.merge(o,{protocols:[b]}),v.source=w.source,v.sink=w.sink,v.protocol=b,w.closeWrite!=null&&(v.closeWrite=w.closeWrite),w.closeRead!=null&&(v.closeRead=w.closeRead),w.close!=null&&(v.close=w.close),(y=this.components.metrics)==null||y.trackProtocolStream(v,h),v}catch(w){throw h.log.error("could not create new outbound stream on connection %s %a for protocols %s - %e",n==="inbound"?"from":"to",e.maConn.remoteAddr,f,w),v.timeline.close==null&&v.abort(w),w}},Promise.all([l.sink(s.source),s.sink(l.source)]).catch(f=>{h.log.error("error piping data through muxer - %e",f)}));const p=i.timeline;i.timeline=new Proxy(p,{set:(...f)=>(f[1]==="close"&&f[2]!=null&&p.close==null&&(async()=>{try{h.status==="open"&&await h.close()}catch(g){h.log.error("error closing connection after timeline close %e",g)}finally{this.events.safeDispatchEvent("connection:close",{detail:h})}})().catch(g=>{h.log.error("error thrown while dispatching connection:close event %e",g)}),Reflect.set(...f))}),i.timeline.upgraded=Date.now();const m=()=>{throw new Sg("Connection is not multiplexed")};return h=_xe({remoteAddr:i.remoteAddr,remotePeer:o,status:"open",direction:n,timeline:i.timeline,multiplexer:l==null?void 0:l.protocol,encryption:t,limits:c,logger:this.components.logger,newStream:d??m,getStreams:()=>(l==null?void 0:l.streams)??[],close:async f=>{await(l==null?void 0:l.close(f)),await i.close(f)},abort:f=>{i.abort(f),l==null||l.abort(f)}}),this.events.safeDispatchEvent("connection:open",{detail:h}),h.__maConnTimeline=p,h}_onStream(e){const{connection:t,stream:n,protocol:i}=e,{handler:s,options:o}=this.components.registrar.getHandler(i);if(t.limits!=null&&o.runOnLimitedConnection!==!0)throw new sS("Cannot open protocol stream on limited connection");s({connection:t,stream:n})}async _encryptInbound(e,t){const n=Array.from(this.connectionEncrypters.keys());try{const{stream:i,protocol:s}=await Q8(e,n,{...t,log:e.log}),o=this.connectionEncrypters.get(s);if(o==null)throw new xg(`no crypto module found for ${s}`);return e.log("encrypting inbound connection to %a using %s",e.remoteAddr,s),{...await o.secureInbound(i,t),protocol:s}}catch(i){throw e.log.error("encrypting inbound connection from %a failed",e.remoteAddr,i),new xg(i.message)}}async _encryptOutbound(e,t){const n=Array.from(this.connectionEncrypters.keys());try{e.log.trace("selecting encrypter from %s",n);const{stream:i,protocol:s}=await G8(e,n,{...t,log:e.log,yieldBytes:!0}),o=this.connectionEncrypters.get(s);if(o==null)throw new xg(`no crypto module found for ${s}`);return e.log("encrypting outbound connection to %a using %s",e.remoteAddr,s),{...await o.secureOutbound(i,t),protocol:s}}catch(i){throw e.log.error("encrypting outbound connection to %a failed",e.remoteAddr,i),new xg(i.message)}}async _multiplexOutbound(e,t,n){const i=Array.from(t.keys());e.log("outbound selecting muxer %s",i);try{e.log.trace("selecting stream muxer from %s",i);const{stream:s,protocol:o}=await G8(e,i,{...n,log:e.log,yieldBytes:!0});e.log("selected %s as muxer protocol",o);const a=t.get(o);return{stream:s,muxerFactory:a}}catch(s){throw e.log.error("error multiplexing outbound connection",s),new Sg(String(s))}}async _multiplexInbound(e,t,n){const i=Array.from(t.keys());e.log("inbound handling muxers %s",i);try{const{stream:s,protocol:o}=await Q8(e,i,{...n,log:e.log}),a=t.get(o);return{stream:s,muxerFactory:a}}catch(s){throw e.log.error("error multiplexing inbound connection",s),new Sg(String(s))}}getConnectionEncrypters(){return this.connectionEncrypters}getStreamMuxers(){return this.streamMuxers}}var Ap,A9;class $xe extends er{constructor(t){var d,h,p,m,f,g,v,y,w,b,E,A;super();Ge(this,Ap);u(this,"peerId");u(this,"peerStore");u(this,"contentRouting");u(this,"peerRouting");u(this,"metrics");u(this,"services");u(this,"logger");u(this,"status");u(this,"components");u(this,"log");this.status="stopped";const n=new er,i=n.dispatchEvent.bind(n);n.dispatchEvent=k=>{const x=i(k),I=this.dispatchEvent(new CustomEvent(k.type,{detail:k.detail}));return x||I},this.peerId=t.peerId,this.logger=t.logger??ww(),this.log=this.logger.forComponent("libp2p"),this.services={};const s=((d=t.nodeInfo)==null?void 0:d.name)??AH,o=((h=t.nodeInfo)==null?void 0:h.version)??xH,a=this.components=ISe({peerId:t.peerId,privateKey:t.privateKey,nodeInfo:{name:s,version:o,userAgent:((p=t.nodeInfo)==null?void 0:p.userAgent)??CH(s,o)},logger:this.logger,events:n,datastore:t.datastore??new lV,connectionGater:NSe(t.connectionGater),dns:t.dns});this.peerStore=this.configureComponent("peerStore",FEe(a,{addressFilter:this.components.connectionGater.filterMultiaddrForPeer,...t.peerStore})),t.metrics!=null&&(this.metrics=this.configureComponent("metrics",t.metrics(this.components))),a.events.addEventListener("peer:update",k=>{if(k.detail.previous==null){const x={id:k.detail.peer.id,multiaddrs:k.detail.peer.addresses.map(I=>I.multiaddr)};a.events.safeDispatchEvent("peer:discovery",{detail:x})}}),t.connectionProtector!=null&&this.configureComponent("connectionProtector",t.connectionProtector(a)),this.components.upgrader=new Dxe(this.components,{connectionEncrypters:(t.connectionEncrypters??[]).map((k,x)=>this.configureComponent(`connection-encryption-${x}`,k(this.components))),streamMuxers:(t.streamMuxers??[]).map((k,x)=>this.configureComponent(`stream-muxers-${x}`,k(this.components))),inboundUpgradeTimeout:(m=t.connectionManager)==null?void 0:m.inboundUpgradeTimeout,inboundStreamProtocolNegotiationTimeout:((f=t.connectionManager)==null?void 0:f.inboundStreamProtocolNegotiationTimeout)??((g=t.connectionManager)==null?void 0:g.protocolNegotiationTimeout),outboundStreamProtocolNegotiationTimeout:((v=t.connectionManager)==null?void 0:v.outboundStreamProtocolNegotiationTimeout)??((y=t.connectionManager)==null?void 0:y.protocolNegotiationTimeout)}),this.configureComponent("transportManager",new Exe(this.components,t.transportManager)),this.configureComponent("connectionManager",new uxe(this.components,t.connectionManager)),((w=t.connectionMonitor)==null?void 0:w.enabled)!==!1&&this.configureComponent("connectionMonitor",new yxe(this.components,t.connectionMonitor)),this.configureComponent("registrar",new vxe(this.components)),this.configureComponent("addressManager",new dSe(this.components,t.addresses));const c=(t.peerRouters??[]).map((k,x)=>this.configureComponent(`peer-router-${x}`,k(this.components)));this.peerRouting=this.components.peerRouting=this.configureComponent("peerRouting",new wxe(this.components,{routers:c}));const l=(t.contentRouters??[]).map((k,x)=>this.configureComponent(`content-router-${x}`,k(this.components)));if(this.contentRouting=this.components.contentRouting=this.configureComponent("contentRouting",new mxe(this.components,{routers:l})),this.configureComponent("randomWalk",new bxe(this.components)),(t.peerDiscovery??[]).forEach((k,x)=>{this.configureComponent(`peer-discovery-${x}`,k(this.components)).addEventListener("peer",T=>{Ie(this,Ap,A9).call(this,T)})}),(b=t.transports)==null||b.forEach((k,x)=>{this.components.transportManager.add(this.configureComponent(`transport-${x}`,k(this.components)))}),t.services!=null)for(const k of Object.keys(t.services)){const x=t.services[k],I=x(this.components);if(I==null){this.log.error("service factory %s returned null or undefined instance",k);continue}this.services[k]=I,this.configureComponent(k,I),I[jd]!=null&&(this.log("registering service %s for content routing",k),l.push(I[jd])),I[Hd]!=null&&(this.log("registering service %s for peer routing",k),c.push(I[Hd])),I[ey]!=null&&(this.log("registering service %s for peer discovery",k),(A=(E=I[ey]).addEventListener)==null||A.call(E,"peer",T=>{Ie(this,Ap,A9).call(this,T)}))}kSe(a)}configureComponent(t,n){return n==null&&this.log.error("component %s was null or undefined",t),this.components[t]=n,n}async start(){var t,n,i,s;if(this.status==="stopped"){this.status="starting",this.log("libp2p is starting");try{await((n=(t=this.components).beforeStart)==null?void 0:n.call(t)),await this.components.start(),await((s=(i=this.components).afterStart)==null?void 0:s.call(i)),this.status="started",this.safeDispatchEvent("start",{detail:this}),this.log("libp2p has started")}catch(o){throw this.log.error("An error occurred starting libp2p",o),this.status="started",await this.stop(),o}}}async stop(){var t,n,i,s;this.status==="started"&&(this.log("libp2p is stopping"),this.status="stopping",await((n=(t=this.components).beforeStop)==null?void 0:n.call(t)),await this.components.stop(),await((s=(i=this.components).afterStop)==null?void 0:s.call(i)),this.status="stopped",this.safeDispatchEvent("stop",{detail:this}),this.log("libp2p has stopped"))}getConnections(t){return this.components.connectionManager.getConnections(t)}getDialQueue(){return this.components.connectionManager.getDialQueue()}getPeers(){const t=new cs;for(const n of this.components.connectionManager.getConnections())t.add(n.remotePeer);return Array.from(t)}async dial(t,n={}){return this.components.connectionManager.openConnection(t,{priority:75,...n})}async dialProtocol(t,n,i={}){if(n==null)throw new Z("no protocols were provided to open a stream");if(n=Array.isArray(n)?n:[n],n.length===0)throw new Z("no protocols were provided to open a stream");return(await this.dial(t,i)).newStream(n,i)}getMultiaddrs(){return this.components.addressManager.getAddresses()}getProtocols(){return this.components.registrar.getProtocols()}async hangUp(t,n={}){Tw(t)&&(t=Jt(t.getPeerId()??"")),await this.components.connectionManager.closeConnections(t,n)}async getPublicKey(t,n={}){if(this.log("getPublicKey %p",t),t.publicKey!=null)return t.publicKey;try{const a=await this.peerStore.get(t);if(a.id.publicKey!=null)return a.id.publicKey}catch(a){if(a.name!=="NotFoundError")throw a}const i=ir([oe("/pk/"),t.toMultihash().bytes]),s=await this.contentRouting.get(i,n),o=Rn(s);return await this.peerStore.patch(t,{publicKey:o}),o}async handle(t,n,i){Array.isArray(t)||(t=[t]),await Promise.all(t.map(async s=>{await this.components.registrar.handle(s,n,i)}))}async unhandle(t){Array.isArray(t)||(t=[t]),await Promise.all(t.map(async n=>{await this.components.registrar.unhandle(n)}))}async register(t,n){return this.components.registrar.register(t,n)}unregister(t){this.components.registrar.unregister(t)}async isDialable(t,n={}){return this.components.connectionManager.isDialable(t,n)}}Ap=new WeakSet,A9=function(t){const{detail:n}=t;if(n.id.toString()===this.peerId.toString()){this.log.error("peer discovery mechanism discovered self");return}this.components.peerStore.merge(n.id,{multiaddrs:n.multiaddrs}).catch(i=>{this.log.error(i)})};async function Nxe(r={}){r.privateKey??(r.privateKey=await dw("Ed25519"));const e=new $xe({...await q9e(r),peerId:hoe(r.privateKey)});return r.start!==!1&&await e.start(),e}async function Mxe(r){const e=r.libp2p??{};e.privateKey==null&&r.datastore!=null&&(e.privateKey=await z9e(r.datastore,r.keychain));const t=F9e(e);return t.datastore=t.datastore??r.datastore,await Nxe({...t,...e,start:!1})}async function qH(r={}){const e=r.datastore??new lV,t=r.blockstore??new f2e;let n;Oxe(r.libp2p)?n=r.libp2p:n=await Mxe({...r,libp2p:{dns:r.dns,...r.libp2p,start:void 0},datastore:e});const i=new w2e({...r,libp2p:n,datastore:e,blockstore:t,blockBrokers:r.blockBrokers??[q1e(),nhe()],routers:r.routers??[Dge(n),Tge()],metrics:n.metrics});return r.start!==!1&&await i.start(),i}function Oxe(r){return r==null?!1:["dial","dialProtocol","hangUp","handle","unhandle","getMultiaddrs","getProtocols"].every(t=>typeof r[t]=="function")}function WH(r){return r[Symbol.asyncIterator]!=null}const F4=r=>{const e=gt(r),t=Mn(e);return xr(r,t),F4.bytes=e,t};F4.bytes=0;function MA(r,e){e=e??{};const t=e.lengthEncoder??F4;function*n(i){const s=t(i.byteLength);s instanceof Uint8Array?yield s:yield*s,i instanceof Uint8Array?yield i:yield*i}return WH(r)?async function*(){for await(const i of r)yield*n(i)}():function*(){for(const i of r)yield*n(i)}()}MA.single=(r,e)=>{e=e??{};const t=e.lengthEncoder??F4;return new Ue(t(r.byteLength),r)};class Rxe extends Error{constructor(){super(...arguments);u(this,"name","InvalidMessageLengthError");u(this,"code","ERR_INVALID_MSG_LENGTH")}}class Lxe extends Error{constructor(){super(...arguments);u(this,"name","InvalidDataLengthError");u(this,"code","ERR_MSG_DATA_TOO_LONG")}}class Bxe extends Error{constructor(){super(...arguments);u(this,"name","InvalidDataLengthLengthError");u(this,"code","ERR_MSG_LENGTH_TOO_LONG")}}class B$ extends Error{constructor(){super(...arguments);u(this,"name","UnexpectedEOFError");u(this,"code","ERR_UNEXPECTED_EOF")}}const Uxe=8,Fxe=1024*1024*4;var hl;(function(r){r[r.LENGTH=0]="LENGTH",r[r.DATA=1]="DATA"})(hl||(hl={}));const OA=r=>{const e=gs(r);return OA.bytes=gt(e),e};OA.bytes=0;function C9(r,e){const t=new Ue;let n=hl.LENGTH,i=-1;const s=(e==null?void 0:e.lengthDecoder)??OA,o=(e==null?void 0:e.maxLengthLength)??Uxe,a=(e==null?void 0:e.maxDataLength)??Fxe;function*c(){for(;t.byteLength>0;){if(n===hl.LENGTH)try{if(i=s(t),i<0)throw new Rxe("Invalid message length");if(i>a)throw new Lxe("Message length too long");const l=s.bytes;t.consume(l),(e==null?void 0:e.onLength)!=null&&e.onLength(i),n=hl.DATA}catch(l){if(l instanceof RangeError){if(t.byteLength>o)throw new Bxe("Message length length too long");break}throw l}if(n===hl.DATA){if(t.byteLength<i)break;const l=t.sublist(0,i);t.consume(i),(e==null?void 0:e.onData)!=null&&e.onData(l),yield l,n=hl.LENGTH}}}return WH(r)?async function*(){for await(const l of r)t.append(l),yield*c();if(t.byteLength>0)throw new B$("Unexpected end of input")}():function*(){for(const l of r)t.append(l),yield*c();if(t.byteLength>0)throw new B$("Unexpected end of input")}()}C9.fromReader=(r,e)=>{let t=1;const n=async function*(){for(;;)try{const{done:s,value:o}=await r.next(t);if(s===!0)return;o!=null&&(yield o)}catch(s){if(s.code==="ERR_UNDER_READ")return{done:!0,value:null};throw s}finally{t=1}}();return C9(n,{...e??{},onLength:s=>{t=s}})};function zxe(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}var Vxe=GH,U$=128,Kxe=-128,jxe=Math.pow(2,31);function GH(r,e,t){e=e||[],t=t||0;for(var n=t;r>=jxe;)e[t++]=r&255|U$,r/=128;for(;r&Kxe;)e[t++]=r&255|U$,r>>>=7;return e[t]=r|0,GH.bytes=t-n+1,e}var Hxe=I9,qxe=128,F$=127;function I9(r,n){var t=0,n=n||0,i=0,s=n,o,a=r.length;do{if(s>=a)throw I9.bytes=0,new RangeError("Could not decode varint");o=r[s++],t+=i<28?(o&F$)<<i:(o&F$)*Math.pow(2,i),i+=7}while(o>=qxe);return I9.bytes=s-n,t}var Wxe=Math.pow(2,7),Gxe=Math.pow(2,14),Qxe=Math.pow(2,21),Yxe=Math.pow(2,28),Jxe=Math.pow(2,35),Xxe=Math.pow(2,42),Zxe=Math.pow(2,49),eAe=Math.pow(2,56),tAe=Math.pow(2,63),rAe=function(r){return r<Wxe?1:r<Gxe?2:r<Qxe?3:r<Yxe?4:r<Jxe?5:r<Xxe?6:r<Zxe?7:r<eAe?8:r<tAe?9:10},nAe={encode:Vxe,decode:Hxe,encodingLength:rAe},d3=nAe;function z$(r,e=0){return[d3.decode(r,e),d3.decode.bytes]}function V$(r,e,t=0){return d3.encode(r,e,t),e}function K$(r){return d3.encodingLength(r)}function j$(r,e){const t=e.byteLength,n=K$(r),i=n+K$(t),s=new Uint8Array(i+t);return V$(r,s,0),V$(t,s,n),s.set(e,i),new YH(r,t,e,s)}function QH(r){const e=zxe(r),[t,n]=z$(e),[i,s]=z$(e.subarray(n)),o=e.subarray(n+s);if(o.byteLength!==i)throw new Error("Incorrect length");return new YH(t,i,o,e)}class YH{constructor(e,t,n,i){u(this,"code");u(this,"size");u(this,"digest");u(this,"bytes");this.code=e,this.size=t,this.digest=n,this.bytes=i}}const Yh=1e3,RA=60*Yh,H$="/floodsub/1.0.0",q$="/meshsub/1.0.0",iAe="/meshsub/1.1.0",Y8="/meshsub/1.2.0",sAe=6,oAe=4,aAe=12,cAe=4,lAe=2,uAe=5,dAe=3,hAe=6,fAe=.25,pAe=3,W$=100,gAe=Yh,yAe=RA,mAe=16,wAe=RA,bAe=10*Yh,vAe=15,EAe=300,SAe=Yh,xAe=60,AAe=2,CAe=10*Yh,ju=5e3,IAe=10,kAe=3*Yh,_Ae=2*RA,TAe=120*1e3,PAe="ERR_TOPIC_VALIDATOR_REJECT",DAe="ERR_TOPIC_VALIDATOR_IGNORE",$Ae=0,NAe=128,MAe=1e3,OAe=1e3,RAe=1,LAe=512,BAe=512,UAe={maxSubscriptions:1/0,maxMessages:1/0,maxIhaveMessageIDs:1/0,maxIwantMessageIDs:1/0,maxIdontwantMessageIDs:1/0,maxControlMessages:1/0,maxPeerInfos:1/0};var Ll;(function(r){(function(t){let n;t.codec=()=>(n==null&&(n=$e((i,s,o={})=>{o.lengthDelimited!==!1&&s.fork(),i.subscribe!=null&&(s.uint32(8),s.bool(i.subscribe)),i.topic!=null&&(s.uint32(18),s.string(i.topic)),o.lengthDelimited!==!1&&s.ldelim()},(i,s,o={})=>{const a={},c=s==null?i.len:i.pos+s;for(;i.pos<c;){const l=i.uint32();switch(l>>>3){case 1:{a.subscribe=i.bool();break}case 2:{a.topic=i.string();break}default:{i.skipType(l&7);break}}}return a})),n),t.encode=i=>De(i,t.codec()),t.decode=(i,s)=>Pe(i,t.codec(),s)})(r.SubOpts||(r.SubOpts={})),function(t){let n;t.codec=()=>(n==null&&(n=$e((i,s,o={})=>{o.lengthDelimited!==!1&&s.fork(),i.from!=null&&(s.uint32(10),s.bytes(i.from)),i.data!=null&&(s.uint32(18),s.bytes(i.data)),i.seqno!=null&&(s.uint32(26),s.bytes(i.seqno)),i.topic!=null&&i.topic!==""&&(s.uint32(34),s.string(i.topic)),i.signature!=null&&(s.uint32(42),s.bytes(i.signature)),i.key!=null&&(s.uint32(50),s.bytes(i.key)),o.lengthDelimited!==!1&&s.ldelim()},(i,s,o={})=>{const a={topic:""},c=s==null?i.len:i.pos+s;for(;i.pos<c;){const l=i.uint32();switch(l>>>3){case 1:{a.from=i.bytes();break}case 2:{a.data=i.bytes();break}case 3:{a.seqno=i.bytes();break}case 4:{a.topic=i.string();break}case 5:{a.signature=i.bytes();break}case 6:{a.key=i.bytes();break}default:{i.skipType(l&7);break}}}return a})),n),t.encode=i=>De(i,t.codec()),t.decode=(i,s)=>Pe(i,t.codec(),s)}(r.Message||(r.Message={})),function(t){let n;t.codec=()=>(n==null&&(n=$e((i,s,o={})=>{if(o.lengthDelimited!==!1&&s.fork(),i.ihave!=null)for(const a of i.ihave)s.uint32(10),r.ControlIHave.codec().encode(a,s);if(i.iwant!=null)for(const a of i.iwant)s.uint32(18),r.ControlIWant.codec().encode(a,s);if(i.graft!=null)for(const a of i.graft)s.uint32(26),r.ControlGraft.codec().encode(a,s);if(i.prune!=null)for(const a of i.prune)s.uint32(34),r.ControlPrune.codec().encode(a,s);if(i.idontwant!=null)for(const a of i.idontwant)s.uint32(42),r.ControlIDontWant.codec().encode(a,s);o.lengthDelimited!==!1&&s.ldelim()},(i,s,o={})=>{var l,d,h,p,m,f,g,v,y,w;const a={ihave:[],iwant:[],graft:[],prune:[],idontwant:[]},c=s==null?i.len:i.pos+s;for(;i.pos<c;){const b=i.uint32();switch(b>>>3){case 1:{if(((l=o.limits)==null?void 0:l.ihave)!=null&&a.ihave.length===o.limits.ihave)throw new pt('Decode error - map field "ihave" had too many elements');a.ihave.push(r.ControlIHave.codec().decode(i,i.uint32(),{limits:(d=o.limits)==null?void 0:d.ihave$}));break}case 2:{if(((h=o.limits)==null?void 0:h.iwant)!=null&&a.iwant.length===o.limits.iwant)throw new pt('Decode error - map field "iwant" had too many elements');a.iwant.push(r.ControlIWant.codec().decode(i,i.uint32(),{limits:(p=o.limits)==null?void 0:p.iwant$}));break}case 3:{if(((m=o.limits)==null?void 0:m.graft)!=null&&a.graft.length===o.limits.graft)throw new pt('Decode error - map field "graft" had too many elements');a.graft.push(r.ControlGraft.codec().decode(i,i.uint32(),{limits:(f=o.limits)==null?void 0:f.graft$}));break}case 4:{if(((g=o.limits)==null?void 0:g.prune)!=null&&a.prune.length===o.limits.prune)throw new pt('Decode error - map field "prune" had too many elements');a.prune.push(r.ControlPrune.codec().decode(i,i.uint32(),{limits:(v=o.limits)==null?void 0:v.prune$}));break}case 5:{if(((y=o.limits)==null?void 0:y.idontwant)!=null&&a.idontwant.length===o.limits.idontwant)throw new pt('Decode error - map field "idontwant" had too many elements');a.idontwant.push(r.ControlIDontWant.codec().decode(i,i.uint32(),{limits:(w=o.limits)==null?void 0:w.idontwant$}));break}default:{i.skipType(b&7);break}}}return a})),n),t.encode=i=>De(i,t.codec()),t.decode=(i,s)=>Pe(i,t.codec(),s)}(r.ControlMessage||(r.ControlMessage={})),function(t){let n;t.codec=()=>(n==null&&(n=$e((i,s,o={})=>{if(o.lengthDelimited!==!1&&s.fork(),i.topicID!=null&&(s.uint32(10),s.string(i.topicID)),i.messageIDs!=null)for(const a of i.messageIDs)s.uint32(18),s.bytes(a);o.lengthDelimited!==!1&&s.ldelim()},(i,s,o={})=>{var l;const a={messageIDs:[]},c=s==null?i.len:i.pos+s;for(;i.pos<c;){const d=i.uint32();switch(d>>>3){case 1:{a.topicID=i.string();break}case 2:{if(((l=o.limits)==null?void 0:l.messageIDs)!=null&&a.messageIDs.length===o.limits.messageIDs)throw new pt('Decode error - map field "messageIDs" had too many elements');a.messageIDs.push(i.bytes());break}default:{i.skipType(d&7);break}}}return a})),n),t.encode=i=>De(i,t.codec()),t.decode=(i,s)=>Pe(i,t.codec(),s)}(r.ControlIHave||(r.ControlIHave={})),function(t){let n;t.codec=()=>(n==null&&(n=$e((i,s,o={})=>{if(o.lengthDelimited!==!1&&s.fork(),i.messageIDs!=null)for(const a of i.messageIDs)s.uint32(10),s.bytes(a);o.lengthDelimited!==!1&&s.ldelim()},(i,s,o={})=>{var l;const a={messageIDs:[]},c=s==null?i.len:i.pos+s;for(;i.pos<c;){const d=i.uint32();switch(d>>>3){case 1:{if(((l=o.limits)==null?void 0:l.messageIDs)!=null&&a.messageIDs.length===o.limits.messageIDs)throw new pt('Decode error - map field "messageIDs" had too many elements');a.messageIDs.push(i.bytes());break}default:{i.skipType(d&7);break}}}return a})),n),t.encode=i=>De(i,t.codec()),t.decode=(i,s)=>Pe(i,t.codec(),s)}(r.ControlIWant||(r.ControlIWant={})),function(t){let n;t.codec=()=>(n==null&&(n=$e((i,s,o={})=>{o.lengthDelimited!==!1&&s.fork(),i.topicID!=null&&(s.uint32(10),s.string(i.topicID)),o.lengthDelimited!==!1&&s.ldelim()},(i,s,o={})=>{const a={},c=s==null?i.len:i.pos+s;for(;i.pos<c;){const l=i.uint32();switch(l>>>3){case 1:{a.topicID=i.string();break}default:{i.skipType(l&7);break}}}return a})),n),t.encode=i=>De(i,t.codec()),t.decode=(i,s)=>Pe(i,t.codec(),s)}(r.ControlGraft||(r.ControlGraft={})),function(t){let n;t.codec=()=>(n==null&&(n=$e((i,s,o={})=>{if(o.lengthDelimited!==!1&&s.fork(),i.topicID!=null&&(s.uint32(10),s.string(i.topicID)),i.peers!=null)for(const a of i.peers)s.uint32(18),r.PeerInfo.codec().encode(a,s);i.backoff!=null&&(s.uint32(24),s.uint64Number(i.backoff)),o.lengthDelimited!==!1&&s.ldelim()},(i,s,o={})=>{var l,d;const a={peers:[]},c=s==null?i.len:i.pos+s;for(;i.pos<c;){const h=i.uint32();switch(h>>>3){case 1:{a.topicID=i.string();break}case 2:{if(((l=o.limits)==null?void 0:l.peers)!=null&&a.peers.length===o.limits.peers)throw new pt('Decode error - map field "peers" had too many elements');a.peers.push(r.PeerInfo.codec().decode(i,i.uint32(),{limits:(d=o.limits)==null?void 0:d.peers$}));break}case 3:{a.backoff=i.uint64Number();break}default:{i.skipType(h&7);break}}}return a})),n),t.encode=i=>De(i,t.codec()),t.decode=(i,s)=>Pe(i,t.codec(),s)}(r.ControlPrune||(r.ControlPrune={})),function(t){let n;t.codec=()=>(n==null&&(n=$e((i,s,o={})=>{o.lengthDelimited!==!1&&s.fork(),i.peerID!=null&&(s.uint32(10),s.bytes(i.peerID)),i.signedPeerRecord!=null&&(s.uint32(18),s.bytes(i.signedPeerRecord)),o.lengthDelimited!==!1&&s.ldelim()},(i,s,o={})=>{const a={},c=s==null?i.len:i.pos+s;for(;i.pos<c;){const l=i.uint32();switch(l>>>3){case 1:{a.peerID=i.bytes();break}case 2:{a.signedPeerRecord=i.bytes();break}default:{i.skipType(l&7);break}}}return a})),n),t.encode=i=>De(i,t.codec()),t.decode=(i,s)=>Pe(i,t.codec(),s)}(r.PeerInfo||(r.PeerInfo={})),function(t){let n;t.codec=()=>(n==null&&(n=$e((i,s,o={})=>{if(o.lengthDelimited!==!1&&s.fork(),i.messageIDs!=null)for(const a of i.messageIDs)s.uint32(10),s.bytes(a);o.lengthDelimited!==!1&&s.ldelim()},(i,s,o={})=>{var l;const a={messageIDs:[]},c=s==null?i.len:i.pos+s;for(;i.pos<c;){const d=i.uint32();switch(d>>>3){case 1:{if(((l=o.limits)==null?void 0:l.messageIDs)!=null&&a.messageIDs.length===o.limits.messageIDs)throw new pt('Decode error - map field "messageIDs" had too many elements');a.messageIDs.push(i.bytes());break}default:{i.skipType(d&7);break}}}return a})),n),t.encode=i=>De(i,t.codec()),t.decode=(i,s)=>Pe(i,t.codec(),s)}(r.ControlIDontWant||(r.ControlIDontWant={}));let e;r.codec=()=>(e==null&&(e=$e((t,n,i={})=>{if(i.lengthDelimited!==!1&&n.fork(),t.subscriptions!=null)for(const s of t.subscriptions)n.uint32(10),r.SubOpts.codec().encode(s,n);if(t.messages!=null)for(const s of t.messages)n.uint32(18),r.Message.codec().encode(s,n);t.control!=null&&(n.uint32(26),r.ControlMessage.codec().encode(t.control,n)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{var a,c,l,d,h;const s={subscriptions:[],messages:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const p=t.uint32();switch(p>>>3){case 1:{if(((a=i.limits)==null?void 0:a.subscriptions)!=null&&s.subscriptions.length===i.limits.subscriptions)throw new pt('Decode error - map field "subscriptions" had too many elements');s.subscriptions.push(r.SubOpts.codec().decode(t,t.uint32(),{limits:(c=i.limits)==null?void 0:c.subscriptions$}));break}case 2:{if(((l=i.limits)==null?void 0:l.messages)!=null&&s.messages.length===i.limits.messages)throw new pt('Decode error - map field "messages" had too many elements');s.messages.push(r.Message.codec().decode(t,t.uint32(),{limits:(d=i.limits)==null?void 0:d.messages$}));break}case 3:{s.control=r.ControlMessage.codec().decode(t,t.uint32(),{limits:(h=i.limits)==null?void 0:h.control});break}default:{t.skipType(p&7);break}}}return s})),e),r.encode=t=>De(t,r.codec()),r.decode=(t,n)=>Pe(t,r.codec(),n)})(Ll||(Ll={}));class FAe{constructor(e,t,n){u(this,"gossip");u(this,"msgs",new Map);u(this,"msgIdToStrFn");u(this,"history",[]);u(this,"notValidatedCount",0);this.gossip=e,this.msgIdToStrFn=n;for(let i=0;i<t;i++)this.history[i]=[]}get size(){return this.msgs.size}put(e,t,n=!1){const{msgIdStr:i}=e;return this.msgs.has(i)?!1:(this.msgs.set(i,{message:t,validated:n,originatingPeers:new Set,iwantCounts:new Map}),this.history[0].push({...e,topic:t.topic}),n||this.notValidatedCount++,!0)}observeDuplicate(e,t){const n=this.msgs.get(e);n!=null&&!n.validated&&n.originatingPeers.add(t)}get(e){var t;return(t=this.msgs.get(this.msgIdToStrFn(e)))==null?void 0:t.message}getWithIWantCount(e,t){const n=this.msgs.get(e);if(n==null)return null;const i=(n.iwantCounts.get(t)??0)+1;return n.iwantCounts.set(t,i),{msg:n.message,count:i}}getGossipIDs(e){const t=new Map;for(let n=0;n<this.gossip;n++)this.history[n].forEach(i=>{const s=this.msgs.get(i.msgIdStr);if(((s==null?void 0:s.validated)??!1)&&e.has(i.topic)){let o=t.get(i.topic);o==null&&(o=[],t.set(i.topic,o)),o.push(i.msgId)}});return t}validate(e){const t=this.msgs.get(e);if(t==null)return null;t.validated||this.notValidatedCount--;const{message:n,originatingPeers:i}=t;return t.validated=!0,t.originatingPeers=new Set,{message:n,originatingPeers:i}}shift(){this.history[this.history.length-1].forEach(t=>{const n=this.msgs.get(t.msgIdStr);n!=null&&(this.msgs.delete(t.msgIdStr),n.validated||this.notValidatedCount--)}),this.history.pop(),this.history.unshift([])}remove(e){const t=this.msgs.get(e);return t==null?null:(this.msgs.delete(e),t)}}var G$;(function(r){r.StrictSign="StrictSign",r.StrictNoSign="StrictNoSign"})(G$||(G$={}));var xh;(function(r){r[r.Signing=0]="Signing",r[r.Anonymous=1]="Anonymous"})(xh||(xh={}));var ds;(function(r){r.Error="error",r.Ignore="ignore",r.Reject="reject",r.Blacklisted="blacklisted"})(ds||(ds={}));var vn;(function(r){r.InvalidSignature="invalid_signature",r.InvalidSeqno="invalid_seqno",r.InvalidPeerId="invalid_peerid",r.SignaturePresent="signature_present",r.SeqnoPresent="seqno_present",r.FromPresent="from_present",r.TransformFailed="transform_failed"})(vn||(vn={}));var Sn;(function(r){r.duplicate="duplicate",r.invalid="invalid",r.valid="valid"})(Sn||(Sn={}));function Q$(r){switch(r){case xi.Ignore:return ds.Ignore;case xi.Reject:return ds.Reject;default:throw new Error("Unreachable")}}var Y$;(function(r){r.forward="forward",r.publish="publish"})(Y$||(Y$={}));var In;(function(r){r.Fanout="fanout",r.Random="random",r.Subscribed="subscribed",r.Outbound="outbound",r.NotEnough="not_enough",r.Opportunistic="opportunistic"})(In||(In={}));var Bs;(function(r){r.Dc="disconnected",r.BadScore="bad_score",r.Prune="prune",r.Excess="excess"})(Bs||(Bs={}));var w1;(function(r){r.GraftBackoff="graft_backoff",r.BrokenPromise="broken_promise",r.MessageDeficit="message_deficit",r.IPColocation="IP_colocation"})(w1||(w1={}));var b1;(function(r){r.LowScore="low_score",r.MaxIhave="max_ihave",r.MaxIasked="max_iasked"})(b1||(b1={}));var sd;(function(r){r.graylist="graylist",r.publish="publish",r.gossip="gossip",r.mesh="mesh"})(sd||(sd={}));function zAe(r,e,t){return{protocolsEnabled:r.gauge({name:"gossipsub_protocol",help:"Status of enabled protocols",labelNames:["protocol"]}),topicSubscriptionStatus:r.gauge({name:"gossipsub_topic_subscription_status",help:"Status of our subscription to this topic",labelNames:["topicStr"]}),topicPeersCount:r.gauge({name:"gossipsub_topic_peer_count",help:"Number of peers subscribed to each topic",labelNames:["topicStr"]}),meshPeerCounts:r.gauge({name:"gossipsub_mesh_peer_count",help:"Number of peers in our mesh",labelNames:["topicStr"]}),meshPeerInclusionEventsFanout:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_fanout_total",help:"Number of times we include peers in a topic mesh for fanout reasons",labelNames:["topic"]}),meshPeerInclusionEventsRandom:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_random_total",help:"Number of times we include peers in a topic mesh for random reasons",labelNames:["topic"]}),meshPeerInclusionEventsSubscribed:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_subscribed_total",help:"Number of times we include peers in a topic mesh for subscribed reasons",labelNames:["topic"]}),meshPeerInclusionEventsOutbound:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_outbound_total",help:"Number of times we include peers in a topic mesh for outbound reasons",labelNames:["topic"]}),meshPeerInclusionEventsNotEnough:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_not_enough_total",help:"Number of times we include peers in a topic mesh for not_enough reasons",labelNames:["topic"]}),meshPeerInclusionEventsOpportunistic:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_opportunistic_total",help:"Number of times we include peers in a topic mesh for opportunistic reasons",labelNames:["topic"]}),meshPeerInclusionEventsUnknown:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_unknown_total",help:"Number of times we include peers in a topic mesh for unknown reasons",labelNames:["topic"]}),meshPeerChurnEventsDisconnected:r.gauge({name:"gossipsub_peer_churn_events_disconnected_total",help:"Number of times we remove peers in a topic mesh for disconnected reasons",labelNames:["topic"]}),meshPeerChurnEventsBadScore:r.gauge({name:"gossipsub_peer_churn_events_bad_score_total",help:"Number of times we remove peers in a topic mesh for bad_score reasons",labelNames:["topic"]}),meshPeerChurnEventsPrune:r.gauge({name:"gossipsub_peer_churn_events_prune_total",help:"Number of times we remove peers in a topic mesh for prune reasons",labelNames:["topic"]}),meshPeerChurnEventsExcess:r.gauge({name:"gossipsub_peer_churn_events_excess_total",help:"Number of times we remove peers in a topic mesh for excess reasons",labelNames:["topic"]}),meshPeerChurnEventsUnknown:r.gauge({name:"gossipsub_peer_churn_events_unknown_total",help:"Number of times we remove peers in a topic mesh for unknown reasons",labelNames:["topic"]}),peersPerProtocol:r.gauge({name:"gossipsub_peers_per_protocol_count",help:"Peers connected for each topic",labelNames:["protocol"]}),heartbeatDuration:r.histogram({name:"gossipsub_heartbeat_duration_seconds",help:"The time it takes to complete one iteration of the heartbeat",buckets:[.01,.1,1]}),heartbeatSkipped:r.gauge({name:"gossipsub_heartbeat_skipped",help:"Heartbeat run took longer than heartbeat interval so next is skipped"}),acceptedMessagesTotal:r.gauge({name:"gossipsub_accepted_messages_total",help:"Total accepted messages for each topic",labelNames:["topic"]}),ignoredMessagesTotal:r.gauge({name:"gossipsub_ignored_messages_total",help:"Total ignored messages for each topic",labelNames:["topic"]}),rejectedMessagesTotal:r.gauge({name:"gossipsub_rejected_messages_total",help:"Total rejected messages for each topic",labelNames:["topic"]}),unknownValidationResultsTotal:r.gauge({name:"gossipsub_unknown_validation_results_total",help:"Total unknown validation results for each topic",labelNames:["topic"]}),asyncValidationMcacheHit:r.gauge({name:"gossipsub_async_validation_mcache_hit_total",help:"Async validation result reported by the user layer",labelNames:["hit"]}),asyncValidationDelayFromFirstSeenSec:r.histogram({name:"gossipsub_async_validation_delay_from_first_seen",help:"Async validation report delay from first seen in second",buckets:[.01,.03,.1,.3,1,3,10]}),asyncValidationUnknownFirstSeen:r.gauge({name:"gossipsub_async_validation_unknown_first_seen_count_total",help:"Async validation report unknown first seen value for message"}),peerReadStreamError:r.gauge({name:"gossipsub_peer_read_stream_err_count_total",help:"Peer read stream error"}),rpcRecvBytes:r.gauge({name:"gossipsub_rpc_recv_bytes_total",help:"RPC recv"}),rpcRecvCount:r.gauge({name:"gossipsub_rpc_recv_count_total",help:"RPC recv"}),rpcRecvSubscription:r.gauge({name:"gossipsub_rpc_recv_subscription_total",help:"RPC recv"}),rpcRecvMessage:r.gauge({name:"gossipsub_rpc_recv_message_total",help:"RPC recv"}),rpcRecvControl:r.gauge({name:"gossipsub_rpc_recv_control_total",help:"RPC recv"}),rpcRecvIHave:r.gauge({name:"gossipsub_rpc_recv_ihave_total",help:"RPC recv"}),rpcRecvIWant:r.gauge({name:"gossipsub_rpc_recv_iwant_total",help:"RPC recv"}),rpcRecvGraft:r.gauge({name:"gossipsub_rpc_recv_graft_total",help:"RPC recv"}),rpcRecvPrune:r.gauge({name:"gossipsub_rpc_recv_prune_total",help:"RPC recv"}),rpcDataError:r.gauge({name:"gossipsub_rpc_data_err_count_total",help:"RPC data error"}),rpcRecvError:r.gauge({name:"gossipsub_rpc_recv_err_count_total",help:"RPC recv error"}),rpcRecvNotAccepted:r.gauge({name:"gossipsub_rpc_rcv_not_accepted_total",help:"Total count of RPC dropped because acceptFrom() == false"}),rpcSentBytes:r.gauge({name:"gossipsub_rpc_sent_bytes_total",help:"RPC sent"}),rpcSentCount:r.gauge({name:"gossipsub_rpc_sent_count_total",help:"RPC sent"}),rpcSentSubscription:r.gauge({name:"gossipsub_rpc_sent_subscription_total",help:"RPC sent"}),rpcSentMessage:r.gauge({name:"gossipsub_rpc_sent_message_total",help:"RPC sent"}),rpcSentControl:r.gauge({name:"gossipsub_rpc_sent_control_total",help:"RPC sent"}),rpcSentIHave:r.gauge({name:"gossipsub_rpc_sent_ihave_total",help:"RPC sent"}),rpcSentIWant:r.gauge({name:"gossipsub_rpc_sent_iwant_total",help:"RPC sent"}),rpcSentGraft:r.gauge({name:"gossipsub_rpc_sent_graft_total",help:"RPC sent"}),rpcSentPrune:r.gauge({name:"gossipsub_rpc_sent_prune_total",help:"RPC sent"}),rpcSentIDontWant:r.gauge({name:"gossipsub_rpc_sent_idontwant_total",help:"RPC sent"}),msgPublishCount:r.gauge({name:"gossipsub_msg_publish_count_total",help:"Total count of msg published by topic",labelNames:["topic"]}),msgPublishPeersByTopic:r.gauge({name:"gossipsub_msg_publish_peers_total",help:"Total count of peers that we publish a msg to",labelNames:["topic"]}),directPeersPublishedTotal:r.gauge({name:"gossipsub_direct_peers_published_total",help:"Total direct peers that we publish a msg to",labelNames:["topic"]}),floodsubPeersPublishedTotal:r.gauge({name:"gossipsub_floodsub_peers_published_total",help:"Total floodsub peers that we publish a msg to",labelNames:["topic"]}),meshPeersPublishedTotal:r.gauge({name:"gossipsub_mesh_peers_published_total",help:"Total mesh peers that we publish a msg to",labelNames:["topic"]}),fanoutPeersPublishedTotal:r.gauge({name:"gossipsub_fanout_peers_published_total",help:"Total fanout peers that we publish a msg to",labelNames:["topic"]}),msgPublishBytes:r.gauge({name:"gossipsub_msg_publish_bytes_total",help:"Total count of msg publish data.length bytes",labelNames:["topic"]}),msgPublishTime:r.histogram({name:"gossipsub_msg_publish_seconds",help:"Total time in seconds to publish a message",buckets:[.001,.002,.005,.01,.1,.5,1],labelNames:["topic"]}),msgForwardCount:r.gauge({name:"gossipsub_msg_forward_count_total",help:"Total count of msg forwarded by topic",labelNames:["topic"]}),msgForwardPeers:r.gauge({name:"gossipsub_msg_forward_peers_total",help:"Total count of peers that we forward a msg to",labelNames:["topic"]}),msgReceivedPreValidation:r.gauge({name:"gossipsub_msg_received_prevalidation_total",help:"Total count of recv msgs before any validation",labelNames:["topic"]}),msgReceivedError:r.gauge({name:"gossipsub_msg_received_error_total",help:"Total count of recv msgs error",labelNames:["topic"]}),prevalidationInvalidTotal:r.gauge({name:"gossipsub_pre_validation_invalid_total",help:"Total count of invalid messages received",labelNames:["topic"]}),prevalidationValidTotal:r.gauge({name:"gossipsub_pre_validation_valid_total",help:"Total count of valid messages received",labelNames:["topic"]}),prevalidationDuplicateTotal:r.gauge({name:"gossipsub_pre_validation_duplicate_total",help:"Total count of duplicate messages received",labelNames:["topic"]}),prevalidationUnknownTotal:r.gauge({name:"gossipsub_pre_validation_unknown_status_total",help:"Total count of unknown_status messages received",labelNames:["topic"]}),msgReceivedInvalid:r.gauge({name:"gossipsub_msg_received_invalid_total",help:"Tracks specific reason of invalid",labelNames:["error"]}),msgReceivedInvalidByTopic:r.gauge({name:"gossipsub_msg_received_invalid_by_topic_total",help:"Tracks specific invalid message by topic",labelNames:["topic"]}),duplicateMsgDeliveryDelay:r.histogram({name:"gossisub_duplicate_msg_delivery_delay_seconds",help:"Time since the 1st duplicated message validated",labelNames:["topic"],buckets:[.25*t.maxMeshMessageDeliveriesWindowSec,.5*t.maxMeshMessageDeliveriesWindowSec,Number(t.maxMeshMessageDeliveriesWindowSec),2*t.maxMeshMessageDeliveriesWindowSec,4*t.maxMeshMessageDeliveriesWindowSec]}),duplicateMsgLateDelivery:r.gauge({name:"gossisub_duplicate_msg_late_delivery_total",help:"Total count of late duplicate message delivery by topic, which triggers P3 penalty",labelNames:["topic"]}),duplicateMsgIgnored:r.gauge({name:"gossisub_ignored_published_duplicate_msgs_total",help:"Total count of published duplicate message ignored by topic",labelNames:["topic"]}),scoreFnCalls:r.gauge({name:"gossipsub_score_fn_calls_total",help:"Total times score() is called"}),scoreFnRuns:r.gauge({name:"gossipsub_score_fn_runs_total",help:"Total times score() call actually computed computeScore(), no cache"}),scoreCachedDelta:r.histogram({name:"gossipsub_score_cache_delta",help:"Delta of score between cached values that expired",buckets:[10,100,1e3]}),peersByScoreThreshold:r.gauge({name:"gossipsub_peers_by_score_threshold_count",help:"Current count of peers by score threshold",labelNames:["threshold"]}),score:r.avgMinMax({name:"gossipsub_score",help:"Avg min max of gossip scores"}),scoreWeights:r.avgMinMax({name:"gossipsub_score_weights",help:"Separate score weights",labelNames:["topic","p"]}),scorePerMesh:r.avgMinMax({name:"gossipsub_score_per_mesh",help:"Histogram of the scores for each mesh topic",labelNames:["topic"]}),scoringPenalties:r.gauge({name:"gossipsub_scoring_penalties_total",help:"A counter of the kind of penalties being applied to peers",labelNames:["penalty"]}),behaviourPenalty:r.histogram({name:"gossipsub_peer_stat_behaviour_penalty",help:"Current peer stat behaviour_penalty at each scrape",buckets:[.25*t.behaviourPenaltyThreshold,.5*t.behaviourPenaltyThreshold,Number(t.behaviourPenaltyThreshold),2*t.behaviourPenaltyThreshold,4*t.behaviourPenaltyThreshold]}),ihaveRcvIgnored:r.gauge({name:"gossipsub_ihave_rcv_ignored_total",help:"Total received IHAVE messages that we ignore for some reason",labelNames:["reason"]}),ihaveRcvMsgids:r.gauge({name:"gossipsub_ihave_rcv_msgids_total",help:"Total received IHAVE messages by topic",labelNames:["topic"]}),ihaveRcvNotSeenMsgids:r.gauge({name:"gossipsub_ihave_rcv_not_seen_msgids_total",help:"Total messages per topic we do not have, not actual requests",labelNames:["topic"]}),iwantRcvMsgids:r.gauge({name:"gossipsub_iwant_rcv_msgids_total",help:"Total received IWANT messages by topic",labelNames:["topic"]}),iwantRcvDonthaveMsgids:r.gauge({name:"gossipsub_iwant_rcv_dont_have_msgids_total",help:"Total requested messageIDs that we do not have"}),idontwantRcvMsgids:r.gauge({name:"gossipsub_idontwant_rcv_msgids_total",help:"Total received IDONTWANT messages"}),idontwantRcvDonthaveMsgids:r.gauge({name:"gossipsub_idontwant_rcv_dont_have_msgids_total",help:"Total received IDONTWANT messageIDs that we do not have in mcache"}),iwantPromiseStarted:r.gauge({name:"gossipsub_iwant_promise_sent_total",help:"Total count of started IWANT promises"}),iwantPromiseResolved:r.gauge({name:"gossipsub_iwant_promise_resolved_total",help:"Total count of resolved IWANT promises"}),iwantPromiseResolvedFromDuplicate:r.gauge({name:"gossipsub_iwant_promise_resolved_from_duplicate_total",help:"Total count of resolved IWANT promises from duplicate messages"}),iwantPromiseResolvedPeers:r.gauge({name:"gossipsub_iwant_promise_resolved_peers",help:"Total count of peers we have asked IWANT promises that are resolved"}),iwantPromiseBroken:r.gauge({name:"gossipsub_iwant_promise_broken",help:"Total count of broken IWANT promises"}),iwantMessagePruned:r.gauge({name:"gossipsub_iwant_message_pruned",help:"Total count of pruned IWANT messages"}),iwantPromiseDeliveryTime:r.histogram({name:"gossipsub_iwant_promise_delivery_seconds",help:"Histogram of delivery time of resolved IWANT promises",buckets:[.5*t.gossipPromiseExpireSec,Number(t.gossipPromiseExpireSec),2*t.gossipPromiseExpireSec,4*t.gossipPromiseExpireSec]}),iwantPromiseUntracked:r.gauge({name:"gossip_iwant_promise_untracked",help:"Total count of untracked IWANT promise"}),connectedPeersBackoffSec:r.histogram({name:"gossipsub_connected_peers_backoff_seconds",help:"Backoff time in seconds",buckets:[1,2,4,10,20,60,120]}),cacheSize:r.gauge({name:"gossipsub_cache_size",help:"Unbounded cache sizes",labelNames:["cache"]}),mcacheSize:r.gauge({name:"gossipsub_mcache_size",help:"Current mcache msg count"}),mcacheNotValidatedCount:r.gauge({name:"gossipsub_mcache_not_validated_count",help:"Current mcache msg count not validated"}),fastMsgIdCacheCollision:r.gauge({name:"gossipsub_fastmsgid_cache_collision_total",help:"Total count of key collisions on fastmsgid cache put"}),newConnectionCount:r.gauge({name:"gossipsub_new_connection_total",help:"Total new connection by status",labelNames:["status"]}),topicStrToLabel:e,toTopic(n){return this.topicStrToLabel.get(n)??n},onJoin(n){this.topicSubscriptionStatus.set({topicStr:n},1),this.meshPeerCounts.set({topicStr:n},0)},onLeave(n){this.topicSubscriptionStatus.set({topicStr:n},0),this.meshPeerCounts.set({topicStr:n},0)},onAddToMesh(n,i,s){const o=this.toTopic(n);switch(i){case In.Fanout:this.meshPeerInclusionEventsFanout.inc({topic:o},s);break;case In.Random:this.meshPeerInclusionEventsRandom.inc({topic:o},s);break;case In.Subscribed:this.meshPeerInclusionEventsSubscribed.inc({topic:o},s);break;case In.Outbound:this.meshPeerInclusionEventsOutbound.inc({topic:o},s);break;case In.NotEnough:this.meshPeerInclusionEventsNotEnough.inc({topic:o},s);break;case In.Opportunistic:this.meshPeerInclusionEventsOpportunistic.inc({topic:o},s);break;default:this.meshPeerInclusionEventsUnknown.inc({topic:o},s);break}},onRemoveFromMesh(n,i,s){const o=this.toTopic(n);switch(i){case Bs.Dc:this.meshPeerChurnEventsDisconnected.inc({topic:o},s);break;case Bs.BadScore:this.meshPeerChurnEventsBadScore.inc({topic:o},s);break;case Bs.Prune:this.meshPeerChurnEventsPrune.inc({topic:o},s);break;case Bs.Excess:this.meshPeerChurnEventsExcess.inc({topic:o},s);break;default:this.meshPeerChurnEventsUnknown.inc({topic:o},s);break}},onReportValidation(n,i,s){if(this.asyncValidationMcacheHit.inc({hit:n!=null?"hit":"miss"}),n!=null){const o=this.toTopic(n.message.topic);switch(i){case xi.Accept:this.acceptedMessagesTotal.inc({topic:o});break;case xi.Ignore:this.ignoredMessagesTotal.inc({topic:o});break;case xi.Reject:this.rejectedMessagesTotal.inc({topic:o});break;default:this.unknownValidationResultsTotal.inc({topic:o});break}}s!=null?this.asyncValidationDelayFromFirstSeenSec.observe((Date.now()-s)/1e3):this.asyncValidationUnknownFirstSeen.inc()},onScorePenalty(n){this.scoringPenalties.inc({penalty:n},1)},onIhaveRcv(n,i,s){const o=this.toTopic(n);this.ihaveRcvMsgids.inc({topic:o},i),this.ihaveRcvNotSeenMsgids.inc({topic:o},s)},onIwantRcv(n,i){for(const[s,o]of n){const a=this.toTopic(s);this.iwantRcvMsgids.inc({topic:a},o)}this.iwantRcvDonthaveMsgids.inc(i)},onIdontwantRcv(n,i){this.idontwantRcvMsgids.inc(n),this.idontwantRcvDonthaveMsgids.inc(i)},onForwardMsg(n,i){const s=this.toTopic(n);this.msgForwardCount.inc({topic:s},1),this.msgForwardPeers.inc({topic:s},i)},onPublishMsg(n,i,s,o,a){const c=this.toTopic(n);this.msgPublishCount.inc({topic:c},1),this.msgPublishBytes.inc({topic:c},s*o),this.msgPublishPeersByTopic.inc({topic:c},s),this.directPeersPublishedTotal.inc({topic:c},i.direct),this.floodsubPeersPublishedTotal.inc({topic:c},i.floodsub),this.meshPeersPublishedTotal.inc({topic:c},i.mesh),this.fanoutPeersPublishedTotal.inc({topic:c},i.fanout),this.msgPublishTime.observe({topic:c},a/1e3)},onMsgRecvPreValidation(n){const i=this.toTopic(n);this.msgReceivedPreValidation.inc({topic:i},1)},onMsgRecvError(n){const i=this.toTopic(n);this.msgReceivedError.inc({topic:i},1)},onPrevalidationResult(n,i){const s=this.toTopic(n);switch(i){case Sn.duplicate:this.prevalidationDuplicateTotal.inc({topic:s});break;case Sn.invalid:this.prevalidationInvalidTotal.inc({topic:s});break;case Sn.valid:this.prevalidationValidTotal.inc({topic:s});break;default:this.prevalidationUnknownTotal.inc({topic:s});break}},onMsgRecvInvalid(n,i){const s=this.toTopic(n),o=i.reason===ds.Error?i.error:i.reason;this.msgReceivedInvalid.inc({error:o},1),this.msgReceivedInvalidByTopic.inc({topic:s},1)},onDuplicateMsgDelivery(n,i,s){const o=this.toTopic(n);this.duplicateMsgDeliveryDelay.observe({topic:o},i/1e3),s&&this.duplicateMsgLateDelivery.inc({topic:o},1)},onPublishDuplicateMsg(n){const i=this.toTopic(n);this.duplicateMsgIgnored.inc({topic:i},1)},onPeerReadStreamError(){this.peerReadStreamError.inc(1)},onRpcRecvError(){this.rpcRecvError.inc(1)},onRpcDataError(){this.rpcDataError.inc(1)},onRpcRecv(n,i){this.rpcRecvBytes.inc(i),this.rpcRecvCount.inc(1),n.subscriptions!=null&&this.rpcRecvSubscription.inc(n.subscriptions.length),n.messages!=null&&this.rpcRecvMessage.inc(n.messages.length),n.control!=null&&(this.rpcRecvControl.inc(1),n.control.ihave!=null&&this.rpcRecvIHave.inc(n.control.ihave.length),n.control.iwant!=null&&this.rpcRecvIWant.inc(n.control.iwant.length),n.control.graft!=null&&this.rpcRecvGraft.inc(n.control.graft.length),n.control.prune!=null&&this.rpcRecvPrune.inc(n.control.prune.length))},onRpcSent(n,i){var s,o,a,c,l;if(this.rpcSentBytes.inc(i),this.rpcSentCount.inc(1),n.subscriptions!=null&&this.rpcSentSubscription.inc(n.subscriptions.length),n.messages!=null&&this.rpcSentMessage.inc(n.messages.length),n.control!=null){const d=((s=n.control.ihave)==null?void 0:s.length)??0,h=((o=n.control.iwant)==null?void 0:o.length)??0,p=((a=n.control.graft)==null?void 0:a.length)??0,m=((c=n.control.prune)==null?void 0:c.length)??0,f=((l=n.control.idontwant)==null?void 0:l.length)??0;d>0&&this.rpcSentIHave.inc(d),h>0&&this.rpcSentIWant.inc(h),p>0&&this.rpcSentGraft.inc(p),m>0&&this.rpcSentPrune.inc(m),f>0&&this.rpcSentIDontWant.inc(f),(d>0||h>0||p>0||m>0||f>0)&&this.rpcSentControl.inc(1)}},registerScores(n,i){let s=0,o=0,a=0,c=0;for(const l of n)l>=i.graylistThreshold&&s++,l>=i.publishThreshold&&o++,l>=i.gossipThreshold&&a++,l>=0&&c++;this.peersByScoreThreshold.set({threshold:sd.graylist},s),this.peersByScoreThreshold.set({threshold:sd.publish},o),this.peersByScoreThreshold.set({threshold:sd.gossip},a),this.peersByScoreThreshold.set({threshold:sd.mesh},c),this.score.set(n)},registerScoreWeights(n){for(const[i,s]of n.byTopic)this.scoreWeights.set({topic:i,p:"p1"},s.p1w),this.scoreWeights.set({topic:i,p:"p2"},s.p2w),this.scoreWeights.set({topic:i,p:"p3"},s.p3w),this.scoreWeights.set({topic:i,p:"p3b"},s.p3bw),this.scoreWeights.set({topic:i,p:"p4"},s.p4w);this.scoreWeights.set({p:"p5"},n.p5w),this.scoreWeights.set({p:"p6"},n.p6w),this.scoreWeights.set({p:"p7"},n.p7w)},registerScorePerMesh(n,i){const s=new Map;n.forEach((o,a)=>{const c=this.topicStrToLabel.get(a)??"unknown";let l=s.get(c);l==null&&(l=new Set,s.set(c,l)),o.forEach(d=>l==null?void 0:l.add(d))});for(const[o,a]of s){const c=[];a.forEach(l=>{c.push(i.get(l)??0)}),this.scorePerMesh.set({topic:o},c)}}}}class ft extends Error{constructor(e="Invalid peer score params"){super(e),this.name="InvalidPeerScoreParamsError"}}u(ft,"name","InvalidPeerScoreParamsError");const VAe={topics:{},topicScoreCap:10,appSpecificScore:()=>0,appSpecificWeight:10,IPColocationFactorWeight:-5,IPColocationFactorThreshold:10,IPColocationFactorWhitelist:new Set,behaviourPenaltyWeight:-10,behaviourPenaltyThreshold:0,behaviourPenaltyDecay:.2,decayInterval:1e3,decayToZero:.1,retainScore:3600*1e3},KAe={topicWeight:.5,timeInMeshWeight:1,timeInMeshQuantum:1,timeInMeshCap:3600,firstMessageDeliveriesWeight:1,firstMessageDeliveriesDecay:.5,firstMessageDeliveriesCap:2e3,meshMessageDeliveriesWeight:-1,meshMessageDeliveriesDecay:.5,meshMessageDeliveriesCap:100,meshMessageDeliveriesThreshold:20,meshMessageDeliveriesWindow:10,meshMessageDeliveriesActivation:5e3,meshFailurePenaltyWeight:-1,meshFailurePenaltyDecay:.5,invalidMessageDeliveriesWeight:-1,invalidMessageDeliveriesDecay:.3};function jAe(r={}){return{...VAe,...r,topics:r.topics!=null?Object.entries(r.topics).reduce((e,[t,n])=>(e[t]=HAe(n),e),{}):{}}}function HAe(r={}){return{...KAe,...r}}function qAe(r){for(const[e,t]of Object.entries(r.topics))try{WAe(t)}catch(n){throw new ft(`invalid score parameters for topic ${e}: ${n.message}`)}if(r.topicScoreCap<0)throw new ft("invalid topic score cap; must be positive (or 0 for no cap)");if(r.appSpecificScore===null||r.appSpecificScore===void 0)throw new ft("missing application specific score function");if(r.IPColocationFactorWeight>0)throw new ft("invalid IPColocationFactorWeight; must be negative (or 0 to disable)");if(r.IPColocationFactorWeight!==0&&r.IPColocationFactorThreshold<1)throw new ft("invalid IPColocationFactorThreshold; must be at least 1");if(r.behaviourPenaltyWeight>0)throw new ft("invalid BehaviourPenaltyWeight; must be negative (or 0 to disable)");if(r.behaviourPenaltyWeight!==0&&(r.behaviourPenaltyDecay<=0||r.behaviourPenaltyDecay>=1))throw new ft("invalid BehaviourPenaltyDecay; must be between 0 and 1");if(r.decayInterval<1e3)throw new ft("invalid DecayInterval; must be at least 1s");if(r.decayToZero<=0||r.decayToZero>=1)throw new ft("invalid DecayToZero; must be between 0 and 1")}function WAe(r){if(r.topicWeight<0)throw new ft("invalid topic weight; must be >= 0");if(r.timeInMeshQuantum===0)throw new ft("invalid TimeInMeshQuantum; must be non zero");if(r.timeInMeshWeight<0)throw new ft("invalid TimeInMeshWeight; must be positive (or 0 to disable)");if(r.timeInMeshWeight!==0&&r.timeInMeshQuantum<=0)throw new ft("invalid TimeInMeshQuantum; must be positive");if(r.timeInMeshWeight!==0&&r.timeInMeshCap<=0)throw new ft("invalid TimeInMeshCap; must be positive");if(r.firstMessageDeliveriesWeight<0)throw new ft("invallid FirstMessageDeliveriesWeight; must be positive (or 0 to disable)");if(r.firstMessageDeliveriesWeight!==0&&(r.firstMessageDeliveriesDecay<=0||r.firstMessageDeliveriesDecay>=1))throw new ft("invalid FirstMessageDeliveriesDecay; must be between 0 and 1");if(r.firstMessageDeliveriesWeight!==0&&r.firstMessageDeliveriesCap<=0)throw new ft("invalid FirstMessageDeliveriesCap; must be positive");if(r.meshMessageDeliveriesWeight>0)throw new ft("invalid MeshMessageDeliveriesWeight; must be negative (or 0 to disable)");if(r.meshMessageDeliveriesWeight!==0&&(r.meshMessageDeliveriesDecay<=0||r.meshMessageDeliveriesDecay>=1))throw new ft("invalid MeshMessageDeliveriesDecay; must be between 0 and 1");if(r.meshMessageDeliveriesWeight!==0&&r.meshMessageDeliveriesCap<=0)throw new ft("invalid MeshMessageDeliveriesCap; must be positive");if(r.meshMessageDeliveriesWeight!==0&&r.meshMessageDeliveriesThreshold<=0)throw new ft("invalid MeshMessageDeliveriesThreshold; must be positive");if(r.meshMessageDeliveriesWindow<0)throw new ft("invalid MeshMessageDeliveriesWindow; must be non-negative");if(r.meshMessageDeliveriesWeight!==0&&r.meshMessageDeliveriesActivation<1e3)throw new ft("invalid MeshMessageDeliveriesActivation; must be at least 1s");if(r.meshFailurePenaltyWeight>0)throw new ft("invalid MeshFailurePenaltyWeight; must be negative (or 0 to disable)");if(r.meshFailurePenaltyWeight!==0&&(r.meshFailurePenaltyDecay<=0||r.meshFailurePenaltyDecay>=1))throw new ft("invalid MeshFailurePenaltyDecay; must be between 0 and 1");if(r.invalidMessageDeliveriesWeight>0)throw new ft("invalid InvalidMessageDeliveriesWeight; must be negative (or 0 to disable)");if(r.invalidMessageDeliveriesDecay<=0||r.invalidMessageDeliveriesDecay>=1)throw new ft("invalid InvalidMessageDeliveriesDecay; must be between 0 and 1")}const GAe={gossipThreshold:-10,publishThreshold:-50,graylistThreshold:-80,acceptPXThreshold:10,opportunisticGraftThreshold:20};function QAe(r={}){return{...GAe,...r}}function k9(r,e,t=()=>!0){const n=new Set;if(e<=0)return n;for(const i of r){if(n.size>=e)break;t(i)&&(n.add(i),r.delete(i))}return n}function YAe(r,e){return k9(r,e,()=>!0)}class JAe extends Map{constructor(t){super();u(this,"getDefault");this.getDefault=t}getOrDefault(t){let n=super.get(t);return n===void 0&&(n=this.getDefault(),this.set(t,n)),n}}function XAe(r,e,t,n){let i=0;Object.entries(e.topics).forEach(([o,a])=>{const c=t.topics[o];if(c===void 0)return;let l=0;if(a.inMesh){let m=a.meshTime/c.timeInMeshQuantum;m>c.timeInMeshCap&&(m=c.timeInMeshCap),l+=m*c.timeInMeshWeight}let d=a.firstMessageDeliveries;if(d>c.firstMessageDeliveriesCap&&(d=c.firstMessageDeliveriesCap),l+=d*c.firstMessageDeliveriesWeight,a.meshMessageDeliveriesActive&&a.meshMessageDeliveries<c.meshMessageDeliveriesThreshold){const m=c.meshMessageDeliveriesThreshold-a.meshMessageDeliveries,f=m*m;l+=f*c.meshMessageDeliveriesWeight}const h=a.meshFailurePenalty;l+=h*c.meshFailurePenaltyWeight;const p=a.invalidMessageDeliveries*a.invalidMessageDeliveries;l+=p*c.invalidMessageDeliveriesWeight,i+=l*c.topicWeight}),t.topicScoreCap>0&&i>t.topicScoreCap&&(i=t.topicScoreCap);const s=t.appSpecificScore(r);if(i+=s*t.appSpecificWeight,e.knownIPs.forEach(o=>{if(t.IPColocationFactorWhitelist.has(o))return;const a=n.get(o),c=a!=null?a.size:0;if(c>t.IPColocationFactorThreshold){const l=c-t.IPColocationFactorThreshold,d=l*l;i+=d*t.IPColocationFactorWeight}}),e.behaviourPenalty>t.behaviourPenaltyThreshold){const o=e.behaviourPenalty-t.behaviourPenaltyThreshold,a=o*o;i+=a*t.behaviourPenaltyWeight}return i}function zt(r,t){var t=t||{};this._capacity=t.capacity,this._head=0,this._tail=0,Array.isArray(r)?this._fromArray(r):(this._capacityMask=3,this._list=new Array(4))}zt.prototype.peekAt=function(e){var t=e;if(t===(t|0)){var n=this.size();if(!(t>=n||t<-n))return t<0&&(t+=n),t=this._head+t&this._capacityMask,this._list[t]}};zt.prototype.get=function(e){return this.peekAt(e)};zt.prototype.peek=function(){if(this._head!==this._tail)return this._list[this._head]};zt.prototype.peekFront=function(){return this.peek()};zt.prototype.peekBack=function(){return this.peekAt(-1)};Object.defineProperty(zt.prototype,"length",{get:function(){return this.size()}});zt.prototype.size=function(){return this._head===this._tail?0:this._head<this._tail?this._tail-this._head:this._capacityMask+1-(this._head-this._tail)};zt.prototype.unshift=function(e){if(arguments.length===0)return this.size();var t=this._list.length;return this._head=this._head-1+t&this._capacityMask,this._list[this._head]=e,this._tail===this._head&&this._growArray(),this._capacity&&this.size()>this._capacity&&this.pop(),this._head<this._tail?this._tail-this._head:this._capacityMask+1-(this._head-this._tail)};zt.prototype.shift=function(){var e=this._head;if(e!==this._tail){var t=this._list[e];return this._list[e]=void 0,this._head=e+1&this._capacityMask,e<2&&this._tail>1e4&&this._tail<=this._list.length>>>2&&this._shrinkArray(),t}};zt.prototype.push=function(e){if(arguments.length===0)return this.size();var t=this._tail;return this._list[t]=e,this._tail=t+1&this._capacityMask,this._tail===this._head&&this._growArray(),this._capacity&&this.size()>this._capacity&&this.shift(),this._head<this._tail?this._tail-this._head:this._capacityMask+1-(this._head-this._tail)};zt.prototype.pop=function(){var e=this._tail;if(e!==this._head){var t=this._list.length;this._tail=e-1+t&this._capacityMask;var n=this._list[this._tail];return this._list[this._tail]=void 0,this._head<2&&e>1e4&&e<=t>>>2&&this._shrinkArray(),n}};zt.prototype.removeOne=function(e){var t=e;if(t===(t|0)&&this._head!==this._tail){var n=this.size(),i=this._list.length;if(!(t>=n||t<-n)){t<0&&(t+=n),t=this._head+t&this._capacityMask;var s=this._list[t],o;if(e<n/2){for(o=e;o>0;o--)this._list[t]=this._list[t=t-1+i&this._capacityMask];this._list[t]=void 0,this._head=this._head+1+i&this._capacityMask}else{for(o=n-1-e;o>0;o--)this._list[t]=this._list[t=t+1+i&this._capacityMask];this._list[t]=void 0,this._tail=this._tail-1+i&this._capacityMask}return s}}};zt.prototype.remove=function(e,t){var n=e,i,s=t;if(n===(n|0)&&this._head!==this._tail){var o=this.size(),a=this._list.length;if(!(n>=o||n<-o||t<1)){if(n<0&&(n+=o),t===1||!t)return i=new Array(1),i[0]=this.removeOne(n),i;if(n===0&&n+t>=o)return i=this.toArray(),this.clear(),i;n+t>o&&(t=o-n);var c;for(i=new Array(t),c=0;c<t;c++)i[c]=this._list[this._head+n+c&this._capacityMask];if(n=this._head+n&this._capacityMask,e+t===o){for(this._tail=this._tail-t+a&this._capacityMask,c=t;c>0;c--)this._list[n=n+1+a&this._capacityMask]=void 0;return i}if(e===0){for(this._head=this._head+t+a&this._capacityMask,c=t-1;c>0;c--)this._list[n=n+1+a&this._capacityMask]=void 0;return i}if(n<o/2){for(this._head=this._head+e+t+a&this._capacityMask,c=e;c>0;c--)this.unshift(this._list[n=n-1+a&this._capacityMask]);for(n=this._head-1+a&this._capacityMask;s>0;)this._list[n=n-1+a&this._capacityMask]=void 0,s--;e<0&&(this._tail=n)}else{for(this._tail=n,n=n+t+a&this._capacityMask,c=o-(t+e);c>0;c--)this.push(this._list[n++]);for(n=this._tail;s>0;)this._list[n=n+1+a&this._capacityMask]=void 0,s--}return this._head<2&&this._tail>1e4&&this._tail<=a>>>2&&this._shrinkArray(),i}}};zt.prototype.splice=function(e,t){var n=e;if(n===(n|0)){var i=this.size();if(n<0&&(n+=i),!(n>i))if(arguments.length>2){var s,o,a,c=arguments.length,l=this._list.length,d=2;if(!i||n<i/2){for(o=new Array(n),s=0;s<n;s++)o[s]=this._list[this._head+s&this._capacityMask];for(t===0?(a=[],n>0&&(this._head=this._head+n+l&this._capacityMask)):(a=this.remove(n,t),this._head=this._head+n+l&this._capacityMask);c>d;)this.unshift(arguments[--c]);for(s=n;s>0;s--)this.unshift(o[s-1])}else{o=new Array(i-(n+t));var h=o.length;for(s=0;s<h;s++)o[s]=this._list[this._head+n+t+s&this._capacityMask];for(t===0?(a=[],n!=i&&(this._tail=this._head+n+l&this._capacityMask)):(a=this.remove(n,t),this._tail=this._tail-h+l&this._capacityMask);d<c;)this.push(arguments[d++]);for(s=0;s<h;s++)this.push(o[s])}return a}else return this.remove(n,t)}};zt.prototype.clear=function(){this._list=new Array(this._list.length),this._head=0,this._tail=0};zt.prototype.isEmpty=function(){return this._head===this._tail};zt.prototype.toArray=function(){return this._copyArray(!1)};zt.prototype._fromArray=function(e){var t=e.length,n=this._nextPowerOf2(t);this._list=new Array(n),this._capacityMask=n-1,this._tail=t;for(var i=0;i<t;i++)this._list[i]=e[i]};zt.prototype._copyArray=function(e,t){var n=this._list,i=n.length,s=this.length;if(t=t|s,t==s&&this._head<this._tail)return this._list.slice(this._head,this._tail);var o=new Array(t),a=0,c;if(e||this._head>this._tail){for(c=this._head;c<i;c++)o[a++]=n[c];for(c=0;c<this._tail;c++)o[a++]=n[c]}else for(c=this._head;c<this._tail;c++)o[a++]=n[c];return o};zt.prototype._growArray=function(){if(this._head!=0){var e=this._copyArray(!0,this._list.length<<1);this._tail=this._list.length,this._head=0,this._list=e}else this._tail=this._list.length,this._list.length<<=1;this._capacityMask=this._capacityMask<<1|1};zt.prototype._shrinkArray=function(){this._list.length>>>=1,this._capacityMask>>>=1};zt.prototype._nextPowerOf2=function(e){var t=Math.log(e)/Math.log(2),n=1<<t+1;return Math.max(n,4)};var ZAe=zt;const eCe=Nc(ZAe);var En;(function(r){r[r.unknown=0]="unknown",r[r.valid=1]="valid",r[r.invalid=2]="invalid",r[r.ignored=3]="ignored"})(En||(En={}));class tCe{constructor(){u(this,"records");u(this,"queue");this.records=new Map,this.queue=new eCe}getRecord(e){return this.records.get(e)}ensureRecord(e){let t=this.records.get(e);if(t!=null)return t;t={status:En.unknown,firstSeenTsMs:Date.now(),validated:0,peers:new Set},this.records.set(e,t);const n={msgId:e,expire:Date.now()+TAe};return this.queue.push(n),t}gc(){const e=Date.now();let t=this.queue.peekFront();for(;t!=null&&t.expire<e;)this.records.delete(t.msgId),this.queue.shift(),t=this.queue.peekFront()}clear(){this.records.clear(),this.queue.clear()}}class rCe{constructor(e,t,n,i){u(this,"params");u(this,"metrics");u(this,"peerStats",new Map);u(this,"peerIPs",new JAe(()=>new Set));u(this,"scoreCache",new Map);u(this,"deliveryRecords",new tCe);u(this,"_backgroundInterval");u(this,"scoreCacheValidityMs");u(this,"computeScore");u(this,"log");this.params=e,this.metrics=t,qAe(e),this.scoreCacheValidityMs=i.scoreCacheValidityMs,this.computeScore=i.computeScore??XAe,this.log=n.forComponent("libp2p:gossipsub:score")}get size(){return this.peerStats.size}start(){if(this._backgroundInterval!=null){this.log("Peer score already running");return}this._backgroundInterval=setInterval(()=>{this.background()},this.params.decayInterval),this.log("started")}stop(){if(this._backgroundInterval==null){this.log("Peer score already stopped");return}clearInterval(this._backgroundInterval),delete this._backgroundInterval,this.peerIPs.clear(),this.peerStats.clear(),this.deliveryRecords.clear(),this.log("stopped")}background(){this.refreshScores(),this.deliveryRecords.gc()}dumpPeerScoreStats(){return Object.fromEntries(Array.from(this.peerStats.entries()).map(([e,t])=>[e,t]))}messageFirstSeenTimestampMs(e){const t=this.deliveryRecords.getRecord(e);return t!=null?t.firstSeenTsMs:null}refreshScores(){const e=Date.now(),t=this.params.decayToZero;this.peerStats.forEach((n,i)=>{if(!n.connected){e>n.expire&&(this.removeIPsForPeer(i,n.knownIPs),this.peerStats.delete(i),this.scoreCache.delete(i));return}Object.entries(n.topics).forEach(([s,o])=>{const a=this.params.topics[s];a!==void 0&&(o.firstMessageDeliveries*=a.firstMessageDeliveriesDecay,o.firstMessageDeliveries<t&&(o.firstMessageDeliveries=0),o.meshMessageDeliveries*=a.meshMessageDeliveriesDecay,o.meshMessageDeliveries<t&&(o.meshMessageDeliveries=0),o.meshFailurePenalty*=a.meshFailurePenaltyDecay,o.meshFailurePenalty<t&&(o.meshFailurePenalty=0),o.invalidMessageDeliveries*=a.invalidMessageDeliveriesDecay,o.invalidMessageDeliveries<t&&(o.invalidMessageDeliveries=0),o.inMesh&&(o.meshTime=e-o.graftTime,o.meshTime>a.meshMessageDeliveriesActivation&&(o.meshMessageDeliveriesActive=!0)))}),n.behaviourPenalty*=this.params.behaviourPenaltyDecay,n.behaviourPenalty<t&&(n.behaviourPenalty=0)})}score(e){var a,c,l;(a=this.metrics)==null||a.scoreFnCalls.inc();const t=this.peerStats.get(e);if(t==null)return 0;const n=Date.now(),i=this.scoreCache.get(e);if(i!=null&&i.cacheUntil>n)return i.score;(c=this.metrics)==null||c.scoreFnRuns.inc();const s=this.computeScore(e,t,this.params,this.peerIPs),o=n+this.scoreCacheValidityMs;return i!=null?((l=this.metrics)==null||l.scoreCachedDelta.observe(Math.abs(s-i.score)),i.score=s,i.cacheUntil=o):this.scoreCache.set(e,{score:s,cacheUntil:o}),s}addPenalty(e,t,n){var s;const i=this.peerStats.get(e);i!=null&&(i.behaviourPenalty+=t,(s=this.metrics)==null||s.onScorePenalty(n))}addPeer(e){const t={connected:!0,expire:0,topics:{},knownIPs:new Set,behaviourPenalty:0};this.peerStats.set(e,t)}addIP(e,t){const n=this.peerStats.get(e);n!=null&&n.knownIPs.add(t),this.peerIPs.getOrDefault(t).add(e)}removeIP(e,t){const n=this.peerStats.get(e);n!=null&&n.knownIPs.delete(t);const i=this.peerIPs.get(t);i!=null&&(i.delete(e),i.size===0&&this.peerIPs.delete(t))}removePeer(e){const t=this.peerStats.get(e);if(t!=null){if(this.score(e)>0){this.removeIPsForPeer(e,t.knownIPs),this.peerStats.delete(e);return}Object.entries(t.topics).forEach(([n,i])=>{i.firstMessageDeliveries=0;const s=this.params.topics[n].meshMessageDeliveriesThreshold;if(i.inMesh&&i.meshMessageDeliveriesActive&&i.meshMessageDeliveries<s){const o=s-i.meshMessageDeliveries;i.meshFailurePenalty+=o*o}i.inMesh=!1,i.meshMessageDeliveriesActive=!1}),t.connected=!1,t.expire=Date.now()+this.params.retainScore}}graft(e,t){const n=this.peerStats.get(e);if(n!=null){const i=this.getPtopicStats(n,t);i!=null&&(i.inMesh=!0,i.graftTime=Date.now(),i.meshTime=0,i.meshMessageDeliveriesActive=!1)}}prune(e,t){const n=this.peerStats.get(e);if(n!=null){const i=this.getPtopicStats(n,t);if(i!=null){const s=this.params.topics[t].meshMessageDeliveriesThreshold;if(i.meshMessageDeliveriesActive&&i.meshMessageDeliveries<s){const o=s-i.meshMessageDeliveries;i.meshFailurePenalty+=o*o}i.meshMessageDeliveriesActive=!1,i.inMesh=!1}}}validateMessage(e){this.deliveryRecords.ensureRecord(e)}deliverMessage(e,t,n){this.markFirstMessageDelivery(e,n);const i=this.deliveryRecords.ensureRecord(t),s=Date.now();if(i.status!==En.unknown){this.log("unexpected delivery: message from %s was first seen %s ago and has delivery status %s",e,s-i.firstSeenTsMs,En[i.status]);return}i.status=En.valid,i.validated=s,i.peers.forEach(o=>{o!==e.toString()&&this.markDuplicateMessageDelivery(o,n)})}rejectInvalidMessage(e,t){this.markInvalidMessageDelivery(e,t)}rejectMessage(e,t,n,i){switch(i){case ds.Error:this.markInvalidMessageDelivery(e,n);return;case ds.Blacklisted:return}const s=this.deliveryRecords.ensureRecord(t);if(s.status!==En.unknown){this.log("unexpected rejection: message from %s was first seen %s ago and has delivery status %d",e,Date.now()-s.firstSeenTsMs,En[s.status]);return}if(i===ds.Ignore){s.status=En.ignored,s.peers.clear();return}s.status=En.invalid,this.markInvalidMessageDelivery(e,n),s.peers.forEach(o=>{this.markInvalidMessageDelivery(o,n)}),s.peers.clear()}duplicateMessage(e,t,n){const i=this.deliveryRecords.ensureRecord(t);if(!i.peers.has(e))switch(i.status){case En.unknown:i.peers.add(e);break;case En.valid:i.peers.add(e),this.markDuplicateMessageDelivery(e,n,i.validated);break;case En.invalid:this.markInvalidMessageDelivery(e,n);break;case En.ignored:break}}markInvalidMessageDelivery(e,t){const n=this.peerStats.get(e);if(n!=null){const i=this.getPtopicStats(n,t);i!=null&&(i.invalidMessageDeliveries+=1)}}markFirstMessageDelivery(e,t){const n=this.peerStats.get(e);if(n!=null){const i=this.getPtopicStats(n,t);if(i!=null){let s=this.params.topics[t].firstMessageDeliveriesCap;i.firstMessageDeliveries=Math.min(s,i.firstMessageDeliveries+1),i.inMesh&&(s=this.params.topics[t].meshMessageDeliveriesCap,i.meshMessageDeliveries=Math.min(s,i.meshMessageDeliveries+1))}}}markDuplicateMessageDelivery(e,t,n){var s;const i=this.peerStats.get(e);if(i!=null){const o=n!==void 0?Date.now():0,a=this.getPtopicStats(i,t);if(a!=null&&a.inMesh){const c=this.params.topics[t];if(n!==void 0){const d=o-n,h=d>c.meshMessageDeliveriesWindow;if((s=this.metrics)==null||s.onDuplicateMsgDelivery(t,d,h),h)return}const l=c.meshMessageDeliveriesCap;a.meshMessageDeliveries=Math.min(l,a.meshMessageDeliveries+1)}}}removeIPsForPeer(e,t){for(const n of t){const i=this.peerIPs.get(n);i!=null&&(i.delete(e),i.size===0&&this.peerIPs.delete(n))}}getPtopicStats(e,t){let n=e.topics[t];return n!==void 0?n:this.params.topics[t]!==void 0?(n={inMesh:!1,graftTime:0,meshTime:0,firstMessageDeliveries:0,meshMessageDeliveries:0,meshMessageDeliveriesActive:!1,meshFailurePenalty:0,invalidMessageDeliveries:0},e.topics[t]=n,n):null}}function nCe(r,e,t,n,i){let s=0;const o=new Map;if(Object.entries(e.topics).forEach(([p,m])=>{const f=i.get(p)??"unknown",g=t.topics[p];if(g===void 0)return;let v=o.get(f);v==null&&(v={p1w:0,p2w:0,p3w:0,p3bw:0,p4w:0},o.set(f,v));let y=0,w=0,b=0,E=0,A=0;if(m.inMesh){const T=Math.max(m.meshTime/g.timeInMeshQuantum,g.timeInMeshCap);y+=T*g.timeInMeshWeight}let k=m.firstMessageDeliveries;if(k>g.firstMessageDeliveriesCap&&(k=g.firstMessageDeliveriesCap),w+=k*g.firstMessageDeliveriesWeight,m.meshMessageDeliveriesActive&&m.meshMessageDeliveries<g.meshMessageDeliveriesThreshold){const T=g.meshMessageDeliveriesThreshold-m.meshMessageDeliveries,L=T*T;b+=L*g.meshMessageDeliveriesWeight}const x=m.meshFailurePenalty;E+=x*g.meshFailurePenaltyWeight;const I=m.invalidMessageDeliveries*m.invalidMessageDeliveries;A+=I*g.invalidMessageDeliveriesWeight,s+=(y+w+b+E+A)*g.topicWeight,v.p1w+=y,v.p2w+=w,v.p3w+=b,v.p3bw+=E,v.p4w+=A}),t.topicScoreCap>0&&s>t.topicScoreCap){s=t.topicScoreCap;const p=t.topicScoreCap/s;for(const m of o.values())m.p1w*=p,m.p2w*=p,m.p3w*=p,m.p3bw*=p,m.p4w*=p}let a=0,c=0,l=0;const d=t.appSpecificScore(r);a+=d*t.appSpecificWeight,e.knownIPs.forEach(p=>{if(t.IPColocationFactorWhitelist.has(p))return;const m=n.get(p),f=m!=null?m.size:0;if(f>t.IPColocationFactorThreshold){const g=f-t.IPColocationFactorThreshold,v=g*g;c+=v*t.IPColocationFactorWeight}});const h=e.behaviourPenalty*e.behaviourPenalty;return l+=h*t.behaviourPenaltyWeight,s+=a+c+l,{byTopic:o,p5w:a,p6w:c,p7w:l,score:s}}function iCe(r,e,t,n,i){const s={byTopic:new Map,p5w:[],p6w:[],p7w:[],score:[]};for(const o of r){const a=e.get(o);if(a!=null){const c=nCe(o,a,t,n,i);for(const[l,d]of c.byTopic){let h=s.byTopic.get(l);h==null&&(h={p1w:[],p2w:[],p3w:[],p3bw:[],p4w:[]},s.byTopic.set(l,h)),h.p1w.push(d.p1w),h.p2w.push(d.p2w),h.p3w.push(d.p3w),h.p3bw.push(d.p3bw),h.p4w.push(d.p4w)}s.p5w.push(c.p5w),s.p6w.push(c.p6w),s.p7w.push(c.p7w),s.score.push(c.score)}else s.p5w.push(0),s.p6w.push(0),s.p7w.push(0),s.score.push(0)}return s}class sCe{constructor(e,t,n){u(this,"rawStream");u(this,"pushable");u(this,"closeController");u(this,"maxBufferSize");this.rawStream=e,this.pushable=Fo(),this.closeController=new AbortController,this.maxBufferSize=n.maxBufferSize??1/0,this.closeController.signal.addEventListener("abort",()=>{e.close().catch(i=>{e.abort(i)})}),hn(this.pushable,this.rawStream).catch(t)}get protocol(){return this.rawStream.protocol}push(e){if(this.pushable.readableLength>this.maxBufferSize)throw Error(`OutboundStream buffer full, size > ${this.maxBufferSize}`);this.pushable.push(MA.single(e))}pushPrefixed(e){if(this.pushable.readableLength>this.maxBufferSize)throw Error(`OutboundStream buffer full, size > ${this.maxBufferSize}`);this.pushable.push(e)}async close(){this.closeController.abort(),await this.pushable.return()}}class oCe{constructor(e,t={}){u(this,"source");u(this,"rawStream");u(this,"closeController");this.rawStream=e,this.closeController=new AbortController,this.closeController.signal.addEventListener("abort",()=>{e.close().catch(n=>{e.abort(n)})}),this.source=hn(this.rawStream,n=>C9(n,t))}async close(){this.closeController.abort()}}class aCe{constructor(e,t,n){u(this,"gossipsubIWantFollowupMs");u(this,"msgIdToStrFn");u(this,"metrics");u(this,"promises",new Map);u(this,"requestMsByMsg",new Map);u(this,"requestMsByMsgExpire");this.gossipsubIWantFollowupMs=e,this.msgIdToStrFn=t,this.metrics=n,this.requestMsByMsgExpire=10*e}get size(){return this.promises.size}get requestMsByMsgSize(){return this.requestMsByMsg.size}addPromise(e,t){const n=Math.floor(Math.random()*t.length),i=t[n],s=this.msgIdToStrFn(i);let o=this.promises.get(s);o==null&&(o=new Map,this.promises.set(s,o));const a=Date.now();o.has(e)||(o.set(e,a+this.gossipsubIWantFollowupMs),this.metrics!=null&&(this.metrics.iwantPromiseStarted.inc(1),this.requestMsByMsg.has(s)||this.requestMsByMsg.set(s,a)))}getBrokenPromises(){var i;const e=Date.now(),t=new Map;let n=0;return this.promises.forEach((s,o)=>{s.forEach((a,c)=>{a<e&&(t.set(c,(t.get(c)??0)+1),s.delete(c),n++)}),s.size===0&&this.promises.delete(o)}),(i=this.metrics)==null||i.iwantPromiseBroken.inc(n),t}deliverMessage(e,t=!1){this.trackMessage(e);const n=this.promises.get(e);n!=null&&(this.promises.delete(e),this.metrics!=null&&(this.metrics.iwantPromiseResolved.inc(1),t&&this.metrics.iwantPromiseResolvedFromDuplicate.inc(1),this.metrics.iwantPromiseResolvedPeers.inc(n.size)))}rejectMessage(e,t){switch(this.trackMessage(e),t){case ds.Error:return}this.promises.delete(e)}clear(){this.promises.clear()}prune(){var n;const e=Date.now()-this.requestMsByMsgExpire;let t=0;for(const[i,s]of this.requestMsByMsg.entries())if(s<e)this.requestMsByMsg.delete(i),t++;else break;(n=this.metrics)==null||n.iwantMessagePruned.inc(t)}trackMessage(e){if(this.metrics!=null){const t=this.requestMsByMsg.get(e);t!==void 0&&(this.metrics.iwantPromiseDeliveryTime.observe((Date.now()-t)/1e3),this.requestMsByMsg.delete(e))}}}const JH=oe("libp2p-pubsub:");async function cCe(r,e,t,n){switch(r.type){case xh.Signing:{const i={from:r.author.toMultihash().bytes,data:n,seqno:xc(8),topic:e,signature:void 0,key:void 0},s=ir([JH,Ll.Message.encode(i)]);i.signature=await r.privateKey.sign(s),i.key=r.key;const o={type:"signed",from:r.author,data:t,sequenceNumber:BigInt(`0x${re(i.seqno??new Uint8Array(0),"base16")}`),topic:e,signature:i.signature,key:Rn(i.key)};return{raw:i,msg:o}}case xh.Anonymous:return{raw:{from:void 0,data:n,seqno:void 0,topic:e,signature:void 0,key:void 0},msg:{type:"unsigned",data:t,topic:e}};default:throw new Error("Unreachable")}}async function lCe(r,e){switch(r){case eS:return e.signature!=null?{valid:!1,error:vn.SignaturePresent}:e.seqno!=null?{valid:!1,error:vn.SeqnoPresent}:e.key!=null?{valid:!1,error:vn.FromPresent}:{valid:!0,message:{type:"unsigned",topic:e.topic,data:e.data??new Uint8Array(0)}};case ty:{if(e.seqno==null)return{valid:!1,error:vn.InvalidSeqno};if(e.seqno.length!==8)return{valid:!1,error:vn.InvalidSeqno};if(e.signature==null)return{valid:!1,error:vn.InvalidSignature};if(e.from==null)return{valid:!1,error:vn.InvalidPeerId};let t;try{t=si(QH(e.from))}catch{return{valid:!1,error:vn.InvalidPeerId}}let n;if(e.key!=null){if(n=Rn(e.key),t.publicKey!==void 0&&!n.equals(t.publicKey))return{valid:!1,error:vn.InvalidPeerId}}else{if(t.publicKey==null)return{valid:!1,error:vn.InvalidPeerId};n=t.publicKey}const i={from:e.from,data:e.data,seqno:e.seqno,topic:e.topic,signature:void 0,key:void 0},s=ir([JH,Ll.Message.encode(i)]);return await n.verify(s,e.signature)?{valid:!0,message:{type:"signed",from:t,data:e.data??new Uint8Array(0),sequenceNumber:BigInt(`0x${re(e.seqno,"base16")}`),topic:e.topic,signature:e.signature,key:e.key!=null?Rn(e.key):n}}:{valid:!1,error:vn.InvalidSignature}}default:throw new Error("Unreachable")}}function Ts(r=[],e){return{subscriptions:[],messages:r,control:e!==void 0?{graft:e.graft??[],prune:e.prune??[],ihave:e.ihave??[],iwant:e.iwant??[],idontwant:e.idontwant??[]}:void 0}}function J$(r){return r.control===void 0&&(r.control={graft:[],prune:[],ihave:[],iwant:[],idontwant:[]}),r}function lo(r){if(r.length<=1)return r;const e=()=>Math.floor(Math.random()*Math.floor(r.length));for(let t=0;t<r.length;t++){const n=e(),i=r[t];r[t]=r[n],r[n]=i}return r}function uCe(r){return re(r,"base64")}function dCe(r,e,t){switch(r){case ty:return{type:xh.Signing,author:e,key:Pi(t.publicKey),privateKey:t};case eS:return{type:xh.Anonymous};default:throw new Error(`Unknown signature policy "${r}"`)}}const hCe=(r,e)=>{const t=oe(e.toString(16).padStart(16,"0"),"base16"),n=Pi(r),i=new Uint8Array(n.byteLength+t.length);return i.set(n,0),i.set(t,n.byteLength),i};function fCe({name:r,code:e,encode:t}){return new pCe(r,e,t)}class pCe{constructor(e,t,n){u(this,"name");u(this,"code");u(this,"encode");this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?j$(this.code,t):t.then(n=>j$(this.code,n))}else throw Error("Unknown type, must be binary type")}}function gCe(r){return async e=>new Uint8Array(await crypto.subtle.digest(r,e))}const yCe=fCe({name:"sha2-256",code:18,encode:gCe("SHA-256")});function mCe(r){if(r.type!=="signed")throw new Error("expected signed message type");if(r.sequenceNumber==null)throw Error("missing seqno field");return hCe(r.from.publicKey??r.key,r.sequenceNumber)}async function wCe(r){return yCe.encode(r.data)}var h3;(function(r){r[r.ip4=4]="ip4",r[r.ip6=41]="ip6"})(h3||(h3={}));function bCe(r){for(const e of r.tuples())switch(e[0]){case h3.ip4:case h3.ip6:return sx(e[0],e[1])}return null}class J8{constructor(e){u(this,"entries",new Map);u(this,"validityMs");this.validityMs=e.validityMs}get size(){return this.entries.size}put(e,t){return this.entries.has(e)?!0:(this.entries.set(e,{value:t,validUntilMs:Date.now()+this.validityMs}),!1)}prune(){const e=Date.now();for(const[t,n]of this.entries.entries())if(n.validUntilMs<e)this.entries.delete(t);else break}has(e){return this.entries.has(e)}get(e){const t=this.entries.get(e);return t!=null&&t.validUntilMs>=Date.now()?t.value:void 0}clear(){this.entries.clear()}}var Vn;(function(r){r[r.started=0]="started",r[r.stopped=1]="stopped"})(Vn||(Vn={}));var SM,xM,AM,CM;class XH extends(CM=er,AM=Symbol.toStringTag,xM=fr,SM=Ec,CM){constructor(t,n={}){super();u(this,"globalSignaturePolicy");u(this,"multicodecs",[Y8,iAe,q$]);u(this,"publishConfig");u(this,"dataTransform");u(this,"peers",new Map);u(this,"streamsInbound",new Map);u(this,"streamsOutbound",new Map);u(this,"outboundInflightQueue",Fo({objectMode:!0}));u(this,"direct",new Set);u(this,"floodsubPeers",new Set);u(this,"seenCache");u(this,"acceptFromWhitelist",new Map);u(this,"topics",new Map);u(this,"subscriptions",new Set);u(this,"mesh",new Map);u(this,"fanout",new Map);u(this,"fanoutLastpub",new Map);u(this,"gossip",new Map);u(this,"control",new Map);u(this,"peerhave",new Map);u(this,"iasked",new Map);u(this,"backoff",new Map);u(this,"outbound",new Map);u(this,"msgIdFn");u(this,"fastMsgIdFn");u(this,"msgIdToStrFn");u(this,"fastMsgIdCache");u(this,"publishedMessageIds");u(this,"mcache");u(this,"score");u(this,"topicValidators",new Map);u(this,"log");u(this,"heartbeatTicks",0);u(this,"gossipTracer");u(this,"idontwantCounts",new Map);u(this,"idontwants",new Map);u(this,"components");u(this,"directPeerInitial",null);u(this,"opts");u(this,"decodeRpcLimits");u(this,"metrics");u(this,"status",{code:Vn.stopped});u(this,"maxInboundStreams");u(this,"maxOutboundStreams");u(this,"runOnLimitedConnection");u(this,"allowedTopics");u(this,"heartbeatTimer",null);u(this,AM,"@chainsafe/libp2p-gossipsub");u(this,xM,["@libp2p/pubsub"]);u(this,SM,["@libp2p/identify"]);u(this,"runHeartbeat",()=>{var n;const t=(n=this.metrics)==null?void 0:n.heartbeatDuration.startTimer();this.heartbeat().catch(i=>{this.log("Error running heartbeat",i)}).finally(()=>{var i;if(t!=null&&t(),this.status.code===Vn.started){clearTimeout(this.status.heartbeatTimeout);let s=this.opts.heartbeatInterval-(Date.now()-this.status.hearbeatStartMs)%this.opts.heartbeatInterval;s<this.opts.heartbeatInterval*.25&&(s+=this.opts.heartbeatInterval,(i=this.metrics)==null||i.heartbeatSkipped.inc()),this.status.heartbeatTimeout=setTimeout(this.runHeartbeat,s)}})});u(this,"tagMeshPeer",t=>{const{peerId:n,topic:i}=t.detail;this.components.peerStore.merge(this.peers.get(n)??Jt(n),{tags:{[i]:{value:100}}}).catch(s=>{this.log.error("Error tagging peer %s with topic %s",n,i,s)})});u(this,"untagMeshPeer",t=>{const{peerId:n,topic:i}=t.detail;this.components.peerStore.merge(this.peers.get(n)??Jt(n),{tags:{[i]:void 0}}).catch(s=>{this.log.error("Error untagging peer %s with topic %s",n,i,s)})});const i={fallbackToFloodsub:!0,floodPublish:!0,batchPublish:!1,tagMeshPeers:!0,doPX:!1,directPeers:[],D:sAe,Dlo:oAe,Dhi:aAe,Dscore:cAe,Dout:lAe,Dlazy:hAe,heartbeatInterval:gAe,fanoutTTL:yAe,mcacheLength:uAe,mcacheGossip:dAe,seenTTL:_Ae,gossipsubIWantFollowupMs:kAe,prunePeers:mAe,pruneBackoff:wAe,unsubcribeBackoff:bAe,graftFloodThreshold:CAe,opportunisticGraftPeers:AAe,opportunisticGraftTicks:xAe,directConnectTicks:EAe,gossipFactor:fAe,idontwantMinDataSize:LAe,idontwantMaxMessages:BAe,...n,scoreParams:jAe(n.scoreParams),scoreThresholds:QAe(n.scoreThresholds)};if(this.components=t,this.decodeRpcLimits=i.decodeRpcLimits??UAe,this.globalSignaturePolicy=i.globalSignaturePolicy??ty,i.fallbackToFloodsub&&this.multicodecs.push(H$),this.log=t.logger.forComponent(i.debugName??"libp2p:gossipsub"),this.opts=i,this.direct=new Set(i.directPeers.map(s=>s.id.toString())),this.seenCache=new J8({validityMs:i.seenTTL}),this.publishedMessageIds=new J8({validityMs:i.seenTTL}),n.msgIdFn!=null)this.msgIdFn=n.msgIdFn;else switch(this.globalSignaturePolicy){case ty:this.msgIdFn=mCe;break;case eS:this.msgIdFn=wCe;break;default:throw new Error(`Invalid globalSignaturePolicy: ${this.globalSignaturePolicy}`)}if(n.fastMsgIdFn!=null&&(this.fastMsgIdFn=n.fastMsgIdFn,this.fastMsgIdCache=new J8({validityMs:i.seenTTL})),this.msgIdToStrFn=n.msgIdToStrFn??uCe,this.mcache=n.messageCache??new FAe(i.mcacheGossip,i.mcacheLength,this.msgIdToStrFn),n.dataTransform!=null&&(this.dataTransform=n.dataTransform),n.metricsRegister!=null){if(n.metricsTopicStrToLabel==null)throw Error("Must set metricsTopicStrToLabel with metrics");const s=Math.max(...Object.values(i.scoreParams.topics).map(a=>a.meshMessageDeliveriesWindow),OAe),o=zAe(n.metricsRegister,n.metricsTopicStrToLabel,{gossipPromiseExpireSec:this.opts.gossipsubIWantFollowupMs/1e3,behaviourPenaltyThreshold:i.scoreParams.behaviourPenaltyThreshold,maxMeshMessageDeliveriesWindowSec:s/1e3});o.mcacheSize.addCollect(()=>{this.onScrapeMetrics(o)});for(const a of this.multicodecs)o.protocolsEnabled.set({protocol:a},1);this.metrics=o}else this.metrics=null;this.gossipTracer=new aCe(this.opts.gossipsubIWantFollowupMs,this.msgIdToStrFn,this.metrics),this.score=new rCe(this.opts.scoreParams,this.metrics,this.components.logger,{scoreCacheValidityMs:i.heartbeatInterval}),this.maxInboundStreams=n.maxInboundStreams,this.maxOutboundStreams=n.maxOutboundStreams,this.runOnLimitedConnection=n.runOnLimitedConnection,this.allowedTopics=i.allowedTopics!=null?new Set(i.allowedTopics):null}getPeers(){return[...this.peers.values()]}isStarted(){return this.status.code===Vn.started}async start(){if(this.isStarted())return;this.log("starting"),this.publishConfig=dCe(this.globalSignaturePolicy,this.components.peerId,this.components.privateKey),this.outboundInflightQueue=Fo({objectMode:!0}),hn(this.outboundInflightQueue,async o=>{for await(const{peerId:a,connection:c}of o)await this.createOutboundStream(a,c)}).catch(o=>{this.log.error("outbound inflight queue error",o)}),await Promise.all(this.opts.directPeers.map(async o=>{await this.components.peerStore.merge(o.id,{multiaddrs:o.addrs})}));const t=this.components.registrar;await Promise.all(this.multicodecs.map(async o=>t.handle(o,this.onIncomingStream.bind(this),{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:this.runOnLimitedConnection})));const n={onConnect:this.onPeerConnected.bind(this),onDisconnect:this.onPeerDisconnected.bind(this),notifyOnLimitedConnection:this.runOnLimitedConnection},i=await Promise.all(this.multicodecs.map(async o=>t.register(o,n))),s=setTimeout(this.runHeartbeat,W$);this.status={code:Vn.started,registrarTopologyIds:i,heartbeatTimeout:s,hearbeatStartMs:Date.now()+W$},this.score.start(),this.directPeerInitial=setTimeout(()=>{Promise.resolve().then(async()=>{await Promise.all(Array.from(this.direct).map(async o=>this.connect(o)))}).catch(o=>{this.log(o)})},SAe),this.opts.tagMeshPeers&&(this.addEventListener("gossipsub:graft",this.tagMeshPeer),this.addEventListener("gossipsub:prune",this.untagMeshPeer)),this.log("started")}async stop(){if(this.log("stopping"),this.status.code!==Vn.started)return;const{registrarTopologyIds:t}=this.status;this.status={code:Vn.stopped},this.opts.tagMeshPeers&&(this.removeEventListener("gossipsub:graft",this.tagMeshPeer),this.removeEventListener("gossipsub:prune",this.untagMeshPeer));const n=this.components.registrar;await Promise.all(this.multicodecs.map(async s=>n.unhandle(s))),t.forEach(s=>{n.unregister(s)}),this.outboundInflightQueue.end();const i=[];for(const s of this.streamsOutbound.values())i.push(s.close());this.streamsOutbound.clear();for(const s of this.streamsInbound.values())i.push(s.close());this.streamsInbound.clear(),await Promise.all(i),this.peers.clear(),this.subscriptions.clear(),this.heartbeatTimer!=null&&(this.heartbeatTimer.cancel(),this.heartbeatTimer=null),this.score.stop(),this.mesh.clear(),this.fanout.clear(),this.fanoutLastpub.clear(),this.gossip.clear(),this.control.clear(),this.peerhave.clear(),this.iasked.clear(),this.backoff.clear(),this.outbound.clear(),this.gossipTracer.clear(),this.seenCache.clear(),this.fastMsgIdCache!=null&&this.fastMsgIdCache.clear(),this.directPeerInitial!=null&&clearTimeout(this.directPeerInitial),this.idontwantCounts.clear(),this.idontwants.clear(),this.log("stopped")}dumpPeerScoreStats(){return this.score.dumpPeerScoreStats()}onIncomingStream({stream:t,connection:n}){if(!this.isStarted())return;const i=n.remotePeer;this.addPeer(i,n.direction,n.remoteAddr),this.createInboundStream(i,t),this.outboundInflightQueue.push({peerId:i,connection:n})}onPeerConnected(t,n){var i;(i=this.metrics)==null||i.newConnectionCount.inc({status:n.status}),!(!this.isStarted()||n.status!=="open")&&(this.addPeer(t,n.direction,n.remoteAddr),this.outboundInflightQueue.push({peerId:t,connection:n}))}onPeerDisconnected(t){this.log("connection ended %p",t),this.removePeer(t)}async createOutboundStream(t,n){var s;if(!this.isStarted())return;const i=t.toString();if(this.peers.has(i)&&!this.streamsOutbound.has(i))try{const o=new sCe(await n.newStream(this.multicodecs,{runOnLimitedConnection:this.runOnLimitedConnection}),c=>{this.log.error("outbound pipe error",c)},{maxBufferSize:this.opts.maxOutboundBufferSize});this.log("create outbound stream %p",t),this.streamsOutbound.set(i,o);const a=o.protocol;a===H$&&this.floodsubPeers.add(i),(s=this.metrics)==null||s.peersPerProtocol.inc({protocol:a},1),this.subscriptions.size>0&&(this.log("send subscriptions to",i),this.sendSubscriptions(i,Array.from(this.subscriptions),!0))}catch(o){this.log.error("createOutboundStream error",o)}}createInboundStream(t,n){if(!this.isStarted())return;const i=t.toString();if(!this.peers.has(i))return;const s=this.streamsInbound.get(i);s!==void 0&&(this.log("replacing existing inbound steam %s",i),s.close().catch(a=>{this.log.error(a)})),this.log("create inbound stream %s",i);const o=new oCe(n,{maxDataLength:this.opts.maxInboundDataLength});this.streamsInbound.set(i,o),this.pipePeerReadStream(t,o.source).catch(a=>{this.log(a)})}addPeer(t,n,i){const s=t.toString();if(!this.peers.has(s)){this.log("new peer %p",t),this.peers.set(s,t),this.score.addPeer(s);const o=bCe(i);o!==null?this.score.addIP(s,o):this.log("Added peer has no IP in current address %s %s",s,i.toString()),this.outbound.has(s)||this.outbound.set(s,n==="outbound")}}removePeer(t){var o,a;const n=t.toString();if(!this.peers.has(n))return;this.log("delete peer %p",t),this.peers.delete(n);const i=this.streamsOutbound.get(n),s=this.streamsInbound.get(n);i!=null&&((o=this.metrics)==null||o.peersPerProtocol.inc({protocol:i.protocol},-1)),i==null||i.close().catch(c=>{this.log.error(c)}),s==null||s.close().catch(c=>{this.log.error(c)}),this.streamsOutbound.delete(n),this.streamsInbound.delete(n);for(const c of this.topics.values())c.delete(n);for(const[c,l]of this.mesh)l.delete(n)&&((a=this.metrics)==null||a.onRemoveFromMesh(c,Bs.Dc,1));for(const c of this.fanout.values())c.delete(n);this.floodsubPeers.delete(n),this.gossip.delete(n),this.control.delete(n),this.outbound.delete(n),this.idontwantCounts.delete(n),this.idontwants.delete(n),this.score.removePeer(n),this.acceptFromWhitelist.delete(n)}get started(){return this.status.code===Vn.started}getMeshPeers(t){const n=this.mesh.get(t);return n!=null?Array.from(n):[]}getSubscribers(t){const n=this.topics.get(t);return(n!=null?Array.from(n):[]).map(i=>this.peers.get(i)??Jt(i))}getTopics(){return Array.from(this.subscriptions)}async pipePeerReadStream(t,n){var i;try{await hn(n,async s=>{var o,a,c;for await(const l of s)try{const d=l.subarray(),h=Ll.decode(d,{limits:{subscriptions:this.decodeRpcLimits.maxSubscriptions,messages:this.decodeRpcLimits.maxMessages,control$:{ihave:this.decodeRpcLimits.maxIhaveMessageIDs,iwant:this.decodeRpcLimits.maxIwantMessageIDs,graft:this.decodeRpcLimits.maxControlMessages,prune:this.decodeRpcLimits.maxControlMessages,prune$:{peers:this.decodeRpcLimits.maxPeerInfos},idontwant:this.decodeRpcLimits.maxControlMessages,idontwant$:{messageIDs:this.decodeRpcLimits.maxIdontwantMessageIDs}}}});if((o=this.metrics)==null||o.onRpcRecv(h,d.length),this.opts.awaitRpcHandler)try{await this.handleReceivedRpc(t,h)}catch(p){(a=this.metrics)==null||a.onRpcRecvError(),this.log(p)}else this.handleReceivedRpc(t,h).catch(p=>{var m;(m=this.metrics)==null||m.onRpcRecvError(),this.log(p)})}catch(d){(c=this.metrics)==null||c.onRpcDataError(),this.log(d)}})}catch(s){(i=this.metrics)==null||i.onPeerReadStreamError(),this.handlePeerReadStreamError(s,t)}}handlePeerReadStreamError(t,n){this.log.error(t),this.onPeerDisconnected(n)}async handleReceivedRpc(t,n){var d;if(!this.acceptFrom(t.toString())){this.log("received message from unacceptable peer %p",t),(d=this.metrics)==null||d.rpcRecvNotAccepted.inc();return}const i=n.subscriptions!=null?n.subscriptions.length:0,s=n.messages!=null?n.messages.length:0;let o=0,a=0,c=0,l=0;if(n.control!=null&&(n.control.ihave!=null&&(o=n.control.ihave.length),n.control.iwant!=null&&(a=n.control.iwant.length),n.control.graft!=null&&(c=n.control.graft.length),n.control.prune!=null&&(l=n.control.prune.length)),this.log(`rpc.from ${t.toString()} subscriptions ${i} messages ${s} ihave ${o} iwant ${a} graft ${c} prune ${l}`),n.subscriptions!=null&&n.subscriptions.length>0){const h=[];n.subscriptions.forEach(p=>{const m=p.topic,f=p.subscribe===!0;if(m!=null){if(this.allowedTopics!=null&&!this.allowedTopics.has(m))return;this.handleReceivedSubscription(t,m,f),h.push({topic:m,subscribe:f})}}),this.safeDispatchEvent("subscription-change",{detail:{peerId:t,subscriptions:h}})}for(const h of n.messages){if(this.allowedTopics!=null&&!this.allowedTopics.has(h.topic))continue;const p=this.handleReceivedMessage(t,h).catch(m=>{var f;(f=this.metrics)==null||f.onMsgRecvError(h.topic),this.log(m)});this.opts.awaitRpcMessageHandler&&await p}n.control!=null&&await this.handleControlMessage(t.toString(),n.control)}handleReceivedSubscription(t,n,i){this.log("subscription update from %p topic %s",t,n);let s=this.topics.get(n);s==null&&(s=new Set,this.topics.set(n,s)),i?s.add(t.toString()):s.delete(t.toString())}async handleReceivedMessage(t,n){var o,a,c;(o=this.metrics)==null||o.onMsgRecvPreValidation(n.topic);const i=await this.validateReceivedMessage(t,n);(a=this.metrics)==null||a.onPrevalidationResult(n.topic,i.code);const s=i.code;switch(s){case Sn.duplicate:this.score.duplicateMessage(t.toString(),i.msgIdStr,n.topic),this.gossipTracer.deliverMessage(i.msgIdStr,!0),this.mcache.observeDuplicate(i.msgIdStr,t.toString());return;case Sn.invalid:if(i.msgIdStr!=null){const l=i.msgIdStr;this.score.rejectMessage(t.toString(),l,n.topic,i.reason),this.gossipTracer.rejectMessage(l,i.reason)}else this.score.rejectInvalidMessage(t.toString(),n.topic);(c=this.metrics)==null||c.onMsgRecvInvalid(n.topic,i);return;case Sn.valid:this.score.validateMessage(i.messageId.msgIdStr),this.gossipTracer.deliverMessage(i.messageId.msgIdStr),this.mcache.put(i.messageId,n,!this.opts.asyncValidation),this.subscriptions.has(n.topic)&&(!this.components.peerId.equals(t)||this.opts.emitSelf)&&(super.dispatchEvent(new CustomEvent("gossipsub:message",{detail:{propagationSource:t,msgId:i.messageId.msgIdStr,msg:i.msg}})),super.dispatchEvent(new CustomEvent("message",{detail:i.msg}))),this.opts.asyncValidation||this.forwardMessage(i.messageId.msgIdStr,n,t.toString());break;default:throw new Error(`Invalid validation result: ${s}`)}}async validateReceivedMessage(t,n){var p,m,f,g;const i=(p=this.fastMsgIdFn)==null?void 0:p.call(this,n),s=i!==void 0?(m=this.fastMsgIdCache)==null?void 0:m.get(i):void 0;if(s!=null)return{code:Sn.duplicate,msgIdStr:s};const o=await lCe(this.globalSignaturePolicy,n);if(!o.valid)return{code:Sn.invalid,reason:ds.Error,error:o.error};const a=o.message;try{this.dataTransform!=null&&(a.data=this.dataTransform.inboundTransform(n.topic,a.data))}catch(v){return this.log("Invalid message, transform failed",v),{code:Sn.invalid,reason:ds.Error,error:vn.TransformFailed}}const c=await this.msgIdFn(a),l=this.msgIdToStrFn(c),d={msgId:c,msgIdStr:l};if(i!==void 0&&this.fastMsgIdCache!=null&&this.fastMsgIdCache.put(i,l)&&((f=this.metrics)==null||f.fastMsgIdCacheCollision.inc()),this.seenCache.has(l))return{code:Sn.duplicate,msgIdStr:l};this.seenCache.put(l),(((g=n.data)==null?void 0:g.length)??0)>=this.opts.idontwantMinDataSize&&this.sendIDontWants(c,n.topic,t.toString());const h=this.topicValidators.get(n.topic);if(h!=null){let v;try{v=await h(t,a)}catch(y){const w=y.code;w===DAe&&(v=xi.Ignore),w===PAe?v=xi.Reject:v=xi.Ignore}if(v!==xi.Accept)return{code:Sn.invalid,reason:Q$(v),msgIdStr:l}}return{code:Sn.valid,messageId:d,msg:a}}getScore(t){return this.score.score(t)}sendSubscriptions(t,n,i){this.sendRpc(t,{subscriptions:n.map(s=>({topic:s,subscribe:i})),messages:[]})}async handleControlMessage(t,n){var l,d,h,p,m,f,g;if(n===void 0)return;const i=((l=n.ihave)==null?void 0:l.length)>0?this.handleIHave(t,n.ihave):[],s=((d=n.iwant)==null?void 0:d.length)>0?this.handleIWant(t,n.iwant):[],o=((h=n.graft)==null?void 0:h.length)>0?await this.handleGraft(t,n.graft):[];if(((p=n.prune)==null?void 0:p.length)>0&&await this.handlePrune(t,n.prune),((m=n.idontwant)==null?void 0:m.length)>0&&this.handleIdontwant(t,n.idontwant),i.length===0&&s.length===0&&o.length===0)return;const a=this.sendRpc(t,Ts(s,{iwant:i,prune:o})),c=(f=i[0])==null?void 0:f.messageIDs;c!=null&&(a?this.gossipTracer.addPromise(t,c):(g=this.metrics)==null||g.iwantPromiseUntracked.inc(1))}acceptFrom(t){if(this.direct.has(t))return!0;const n=Date.now(),i=this.acceptFromWhitelist.get(t);if(i!=null&&i.messagesAccepted<NAe&&i.acceptUntil>=n)return i.messagesAccepted+=1,!0;const s=this.score.score(t);return s>=$Ae?this.acceptFromWhitelist.set(t,{messagesAccepted:0,acceptUntil:n+MAe}):this.acceptFromWhitelist.delete(t),s>=this.opts.scoreThresholds.graylistThreshold}handleIHave(t,n){var d,h,p;if(n.length===0)return[];const i=this.score.score(t);if(i<this.opts.scoreThresholds.gossipThreshold)return this.log("IHAVE: ignoring peer %s with score below threshold [ score = %d ]",t,i),(d=this.metrics)==null||d.ihaveRcvIgnored.inc({reason:b1.LowScore}),[];const s=(this.peerhave.get(t)??0)+1;if(this.peerhave.set(t,s),s>IAe)return this.log("IHAVE: peer %s has advertised too many times (%d) within this heartbeat interval; ignoring",t,s),(h=this.metrics)==null||h.ihaveRcvIgnored.inc({reason:b1.MaxIhave}),[];const o=this.iasked.get(t)??0;if(o>=ju)return this.log("IHAVE: peer %s has already advertised too many messages (%d); ignoring",t,o),(p=this.metrics)==null||p.ihaveRcvIgnored.inc({reason:b1.MaxIasked}),[];const a=new Map;if(n.forEach(({topicID:m,messageIDs:f})=>{var v;if(m==null||f==null||!this.mesh.has(m))return;let g=0;f.forEach(y=>{const w=this.msgIdToStrFn(y);this.seenCache.has(w)||(a.set(w,y),g++)}),(v=this.metrics)==null||v.onIhaveRcv(m,f.length,g)}),a.size===0)return[];let c=a.size;c+o>ju&&(c=ju-o),this.log("IHAVE: Asking for %d out of %d messages from %s",c,a.size,t);let l=Array.from(a.values());return lo(l),l=l.slice(0,c),this.iasked.set(t,o+c),[{messageIDs:l}]}handleIWant(t,n){var c;if(n.length===0)return[];const i=this.score.score(t);if(i<this.opts.scoreThresholds.gossipThreshold)return this.log("IWANT: ignoring peer %s with score below threshold [score = %d]",t,i),[];const s=new Map,o=new Map;let a=0;return n.forEach(({messageIDs:l})=>{l==null||l.forEach(d=>{const h=this.msgIdToStrFn(d),p=this.mcache.getWithIWantCount(h,t);if(p==null){a++;return}if(o.set(p.msg.topic,1+(o.get(p.msg.topic)??0)),p.count>pAe){this.log("IWANT: Peer %s has asked for message %s too many times: ignoring request",t,d);return}s.set(h,p.msg)})}),(c=this.metrics)==null||c.onIwantRcv(o,a),s.size===0?(this.log("IWANT: Could not provide any wanted messages to %s",t),[]):(this.log("IWANT: Sending %d messages to %s",s.size,t),Array.from(s.values()))}async handleGraft(t,n){const i=[],s=this.score.score(t),o=Date.now();let a=this.opts.doPX;if(n.forEach(({topicID:l})=>{var p,m;if(l==null)return;const d=this.mesh.get(l);if(d==null){a=!1;return}if(d.has(t))return;const h=(p=this.backoff.get(l))==null?void 0:p.get(t);if(this.direct.has(t))this.log("GRAFT: ignoring request from direct peer %s",t),i.push(l),a=!1;else if(typeof h=="number"&&o<h){this.log("GRAFT: ignoring backed off peer %s",t),this.score.addPenalty(t,1,w1.GraftBackoff),a=!1;const f=h+this.opts.graftFloodThreshold-this.opts.pruneBackoff;o<f&&this.score.addPenalty(t,1,w1.GraftBackoff),this.addBackoff(t,l),i.push(l)}else s<0?(this.log("GRAFT: ignoring peer %s with negative score: score=%d, topic=%s",t,s,l),i.push(l),a=!1,this.addBackoff(t,l)):d.size>=this.opts.Dhi&&!(this.outbound.get(t)??!1)?(i.push(l),this.addBackoff(t,l)):(this.log("GRAFT: Add mesh link from %s in %s",t,l),this.score.graft(t,l),d.add(t),(m=this.metrics)==null||m.onAddToMesh(l,In.Subscribed,1));this.safeDispatchEvent("gossipsub:graft",{detail:{peerId:t,topic:l,direction:"inbound"}})}),i.length===0)return[];const c=!1;return Promise.all(i.map(async l=>this.makePrune(t,l,a,c)))}async handlePrune(t,n){var s;const i=this.score.score(t);for(const{topicID:o,backoff:a,peers:c}of n){if(o==null)continue;const l=this.mesh.get(o);if(l==null)return;this.log("PRUNE: Remove mesh link to %s in %s",t,o),this.score.prune(t,o),l.has(t)&&(l.delete(t),(s=this.metrics)==null||s.onRemoveFromMesh(o,Bs.Prune,1)),typeof a=="number"&&a>0?this.doAddBackoff(t,o,a*1e3):this.addBackoff(t,o),c!=null&&c.length>0&&(i<this.opts.scoreThresholds.acceptPXThreshold?this.log("PRUNE: ignoring PX from peer %s with insufficient score [score = %d, topic = %s]",t,i,o):await this.pxConnect(c)),this.safeDispatchEvent("gossipsub:prune",{detail:{peerId:t,topic:o,direction:"inbound"}})}}handleIdontwant(t,n){var l;let i=this.idontwantCounts.get(t)??0;if(i>=this.opts.idontwantMaxMessages)return;const s=i;let o=this.idontwants.get(t);o==null&&(o=new Map,this.idontwants.set(t,o));let a=0;e:for(const{messageIDs:d}of n)for(const h of d){if(i>=this.opts.idontwantMaxMessages)break e;i++;const p=this.msgIdToStrFn(h);o.set(p,this.heartbeatTicks),this.mcache.msgs.has(p)||a++}this.idontwantCounts.set(t,i);const c=i-s;(l=this.metrics)==null||l.onIdontwantRcv(c,a)}addBackoff(t,n){this.doAddBackoff(t,n,this.opts.pruneBackoff)}doAddBackoff(t,n,i){let s=this.backoff.get(n);s==null&&(s=new Map,this.backoff.set(n,s));const o=Date.now()+i;(s.get(t)??0)<o&&s.set(t,o)}applyIwantPenalties(){this.gossipTracer.getBrokenPromises().forEach((t,n)=>{this.log("peer %s didn't follow up in %d IWANT requests; adding penalty",n,t),this.score.addPenalty(n,t,w1.BrokenPromise)})}clearBackoff(){if(this.heartbeatTicks%vAe!==0)return;const t=Date.now();this.backoff.forEach((n,i)=>{n.forEach((s,o)=>{s+RAe*this.opts.heartbeatInterval<t&&n.delete(o)}),n.size===0&&this.backoff.delete(i)})}async directConnect(){const t=[];this.direct.forEach(n=>{this.streamsOutbound.has(n)||t.push(n)}),await Promise.all(t.map(async n=>this.connect(n)))}async pxConnect(t){t.length>this.opts.prunePeers&&(lo(t),t=t.slice(0,this.opts.prunePeers));const n=[];await Promise.all(t.map(async i=>{if(i.peerID==null)return;const s=si(QH(i.peerID)),o=s.toString();if(!this.peers.has(o)){if(i.signedPeerRecord==null){n.push(o);return}try{if(!await this.components.peerStore.consumePeerRecord(i.signedPeerRecord,s)){this.log("bogus peer record obtained through px: could not add peer record to address book");return}n.push(o)}catch{this.log("bogus peer record obtained through px: invalid signature or not a peer record")}}})),n.length!==0&&await Promise.all(n.map(async i=>this.connect(i)))}async connect(t){var s;this.log("Initiating connection with %s",t);const n=Jt(t),i=await this.components.connectionManager.openConnection(n);for(const o of this.multicodecs)for(const a of this.components.registrar.getTopologies(o))(s=a.onConnect)==null||s.call(a,n,i)}subscribe(t){if(this.status.code!==Vn.started)throw new Error("Pubsub has not started");if(!this.subscriptions.has(t)){this.subscriptions.add(t);for(const n of this.peers.keys())this.sendSubscriptions(n,[t],!0)}this.join(t)}unsubscribe(t){if(this.status.code!==Vn.started)throw new Error("Pubsub is not started");const n=this.subscriptions.delete(t);if(this.log("unsubscribe from %s - am subscribed %s",t,n),n)for(const i of this.peers.keys())this.sendSubscriptions(i,[t],!1);this.leave(t)}join(t){var o,a,c;if(this.status.code!==Vn.started)throw new Error("Gossipsub has not started");if(this.mesh.has(t))return;this.log("JOIN %s",t),(o=this.metrics)==null||o.onJoin(t);const n=new Set,i=this.backoff.get(t),s=this.fanout.get(t);if(s!=null&&(this.fanout.delete(t),this.fanoutLastpub.delete(t),s.forEach(l=>{!this.direct.has(l)&&this.score.score(l)>=0&&(i==null?void 0:i.has(l))!==!0&&n.add(l)}),(a=this.metrics)==null||a.onAddToMesh(t,In.Fanout,n.size)),n.size<this.opts.D){const l=n.size;this.getRandomGossipPeers(t,this.opts.D,h=>!n.has(h)&&!this.direct.has(h)&&this.score.score(h)>=0&&(i==null?void 0:i.has(h))!==!0).forEach(h=>{n.add(h)}),(c=this.metrics)==null||c.onAddToMesh(t,In.Random,n.size-l)}this.mesh.set(t,n),n.forEach(l=>{this.log("JOIN: Add mesh link to %s in %s",l,t),this.sendGraft(l,t)})}leave(t){var i;if(this.status.code!==Vn.started)throw new Error("Gossipsub has not started");this.log("LEAVE %s",t),(i=this.metrics)==null||i.onLeave(t);const n=this.mesh.get(t);n!=null&&(Promise.all(Array.from(n).map(async s=>{this.log("LEAVE: Remove mesh link to %s in %s",s,t),await this.sendPrune(s,t)})).catch(s=>{this.log("Error sending prunes to mesh peers",s)}),this.mesh.delete(t))}selectPeersToForward(t,n,i){const s=new Set,o=this.topics.get(t);o!=null&&(this.direct.forEach(c=>{o.has(c)&&n!==c&&!((i==null?void 0:i.has(c))??!1)&&s.add(c)}),this.floodsubPeers.forEach(c=>{o.has(c)&&n!==c&&!((i==null?void 0:i.has(c))??!1)&&this.score.score(c)>=this.opts.scoreThresholds.publishThreshold&&s.add(c)}));const a=this.mesh.get(t);return a!=null&&a.size>0&&a.forEach(c=>{n!==c&&!((i==null?void 0:i.has(c))??!1)&&s.add(c)}),s}selectPeersToPublish(t){const n=new Set,i={direct:0,floodsub:0,mesh:0,fanout:0},s=this.topics.get(t);if(s!=null)if(this.opts.floodPublish)s.forEach(o=>{this.direct.has(o)?(n.add(o),i.direct++):this.score.score(o)>=this.opts.scoreThresholds.publishThreshold&&(n.add(o),i.floodsub++)});else{this.direct.forEach(a=>{s.has(a)&&(n.add(a),i.direct++)}),this.floodsubPeers.forEach(a=>{s.has(a)&&this.score.score(a)>=this.opts.scoreThresholds.publishThreshold&&(n.add(a),i.floodsub++)});const o=this.mesh.get(t);if(o!=null&&o.size>0)o.forEach(a=>{n.add(a),i.mesh++}),o.size<this.opts.D&&this.getRandomGossipPeers(t,this.opts.D-o.size,c=>!o.has(c)&&!this.direct.has(c)&&!this.floodsubPeers.has(c)&&this.score.score(c)>=this.opts.scoreThresholds.publishThreshold).forEach(c=>{n.add(c),i.mesh++});else{const a=this.fanout.get(t);if(a!=null&&a.size>0)a.forEach(c=>{n.add(c),i.fanout++});else{const c=this.getRandomGossipPeers(t,this.opts.D,l=>this.score.score(l)>=this.opts.scoreThresholds.publishThreshold);c.size>0&&(this.fanout.set(t,c),c.forEach(l=>{n.add(l),i.fanout++}))}this.fanoutLastpub.set(t,Date.now())}}return{tosend:n,tosendCount:i}}forwardMessage(t,n,i,s){var a;i!=null&&this.score.deliverMessage(i,t,n.topic);const o=this.selectPeersToForward(n.topic,i,s);o.forEach(c=>{this.sendRpc(c,Ts([n]))}),(a=this.metrics)==null||a.onForwardMsg(n.topic,o.size)}async publish(t,n,i){var b,E;const s=Date.now(),o=this.dataTransform!=null?this.dataTransform.outboundTransform(t,n):n;if(this.publishConfig==null)throw Error("PublishError.Uninitialized");const{raw:a,msg:c}=await cCe(this.publishConfig,t,n,o),l=await this.msgIdFn(c),d=this.msgIdToStrFn(l),h=(i==null?void 0:i.ignoreDuplicatePublishError)??this.opts.ignoreDuplicatePublishError;if(this.seenCache.has(d)){if(h)return(b=this.metrics)==null||b.onPublishDuplicateMsg(t),{recipients:[]};throw Error("PublishError.Duplicate")}const{tosend:p,tosendCount:m}=this.selectPeersToPublish(t),f=this.opts.emitSelf&&this.subscriptions.has(t),g=(i==null?void 0:i.allowPublishToZeroTopicPeers)??this.opts.allowPublishToZeroTopicPeers;if(p.size===0&&!g&&!f)throw Error("PublishError.NoPeersSubscribedToTopic");this.seenCache.put(d),this.mcache.put({msgId:l,msgIdStr:d},a,!0),this.publishedMessageIds.put(d);const v=(i==null?void 0:i.batchPublish)??this.opts.batchPublish,y=Ts([a]);if(v)this.sendRpcInBatch(p,y);else for(const A of p)this.sendRpc(A,y)||p.delete(A);const w=Date.now()-s;return(E=this.metrics)==null||E.onPublishMsg(t,m,p.size,a.data!=null?a.data.length:0,w),f&&(p.add(this.components.peerId.toString()),super.dispatchEvent(new CustomEvent("gossipsub:message",{detail:{propagationSource:this.components.peerId,msgId:d,msg:c}})),super.dispatchEvent(new CustomEvent("message",{detail:c}))),{recipients:Array.from(p.values()).map(A=>this.peers.get(A)??Jt(A))}}sendRpcInBatch(t,n){var o;const i=Ll.encode(n),s=MA.single(i);for(const a of t){const c=this.streamsOutbound.get(a);if(c==null){this.log(`Cannot send RPC to ${a} as there is no open stream to it available`),t.delete(a);continue}try{c.pushPrefixed(s)}catch(l){t.delete(a),this.log.error(`Cannot send rpc to ${a}`,l)}(o=this.metrics)==null||o.onRpcSent(n,i.length)}}reportMessageValidationResult(t,n,i){var a;let s;if(i===xi.Accept){if(s=this.mcache.validate(t),s!=null){const{message:c,originatingPeers:l}=s;this.score.deliverMessage(n,t,c.topic),this.forwardMessage(t,s.message,n,l)}}else if(s=this.mcache.remove(t),s!=null){const c=Q$(i),{message:l,originatingPeers:d}=s;this.score.rejectMessage(n,t,l.topic,c);for(const h of d)this.score.rejectMessage(h,t,l.topic,c)}const o=this.score.messageFirstSeenTimestampMs(t);(a=this.metrics)==null||a.onReportValidation(s,i,o)}sendGraft(t,n){const s=Ts([],{graft:[{topicID:n}]});this.sendRpc(t,s)}async sendPrune(t,n){const s=[await this.makePrune(t,n,this.opts.doPX,!0)],o=Ts([],{prune:s});this.sendRpc(t,o)}sendIDontWants(t,n,i){var c;const s=this.mesh.get(n);if(s==null)return;const o=new Set(s);o.delete(i);for(const l of o)((c=this.streamsOutbound.get(l))==null?void 0:c.protocol)!==Y8&&o.delete(l);const a=Ts([],{idontwant:[{messageIDs:[t]}]});this.sendRpcInBatch(o,a)}sendRpc(t,n){var c,l,d,h,p;const i=this.streamsOutbound.get(t);if(i==null)return this.log(`Cannot send RPC to ${t} as there is no open stream to it available`),!1;const s=this.control.get(t);s!=null&&(this.piggybackControl(t,n,s),this.control.delete(t));const o=this.gossip.get(t);o!=null&&(this.piggybackGossip(t,n,o),this.gossip.delete(t));const a=Ll.encode(n);try{i.push(a)}catch(m){return this.log.error(`Cannot send rpc to ${t}`,m),s!=null&&this.control.set(t,s),o!=null&&this.gossip.set(t,o),!1}if((c=this.metrics)==null||c.onRpcSent(n,a.length),((l=n.control)==null?void 0:l.graft)!=null)for(const m of(d=n.control)==null?void 0:d.graft)m.topicID!=null&&this.safeDispatchEvent("gossipsub:graft",{detail:{peerId:t,topic:m.topicID,direction:"outbound"}});if(((h=n.control)==null?void 0:h.prune)!=null)for(const m of(p=n.control)==null?void 0:p.prune)m.topicID!=null&&this.safeDispatchEvent("gossipsub:prune",{detail:{peerId:t,topic:m.topicID,direction:"outbound"}});return!0}piggybackControl(t,n,i){var o,a;const s=J$(n);for(const c of i.graft)c.topicID!=null&&(((o=this.mesh.get(c.topicID))==null?void 0:o.has(t))??!1)&&s.control.graft.push(c);for(const c of i.prune)c.topicID!=null&&!(((a=this.mesh.get(c.topicID))==null?void 0:a.has(t))??!1)&&s.control.prune.push(c)}piggybackGossip(t,n,i){const s=J$(n);s.control.ihave=i}async sendGraftPrune(t,n,i){const s=this.opts.doPX,o=!1;for(const[a,c]of t){const l=c.map(p=>({topicID:p}));let d=[];const h=n.get(a);h!=null&&(d=await Promise.all(h.map(async p=>this.makePrune(a,p,s&&!(i.get(a)??!1),o))),n.delete(a)),this.sendRpc(a,Ts([],{graft:l,prune:d}))}for(const[a,c]of n){const l=await Promise.all(c.map(async d=>this.makePrune(a,d,s&&!(i.get(a)??!1),o)));this.sendRpc(a,Ts([],{prune:l}))}}emitGossip(t){const n=this.mcache.getGossipIDs(new Set(t.keys()));for(const[i,s]of t)this.doEmitGossip(i,s,n.get(i)??[])}doEmitGossip(t,n,i){if(i.length===0||(lo(i),i.length>ju&&this.log("too many messages for gossip; will truncate IHAVE list (%d messages)",i.length),n.size===0))return;let s=this.opts.Dlazy;const a=this.opts.gossipFactor*n.size;let c=n;a>s&&(s=a),s>c.size?s=c.size:c=lo(Array.from(c)).slice(0,s),c.forEach(l=>{let d=i;i.length>ju&&(d=lo(d.slice()).slice(0,ju)),this.pushGossip(l,{topicID:t,messageIDs:d})})}flush(){for(const[t,n]of this.gossip.entries())this.gossip.delete(t),this.sendRpc(t,Ts([],{ihave:n}));for(const[t,n]of this.control.entries()){this.control.delete(t);const i=Ts([],{graft:n.graft,prune:n.prune});this.sendRpc(t,i)}}pushGossip(t,n){this.log("Add gossip to %s",t);const i=this.gossip.get(t)??[];this.gossip.set(t,i.concat(n))}async makePrune(t,n,i,s){var d;if(this.score.prune(t,n),((d=this.streamsOutbound.get(t))==null?void 0:d.protocol)===q$)return{topicID:n,peers:[]};const o=s?this.opts.unsubcribeBackoff:this.opts.pruneBackoff,a=o/1e3;if(this.doAddBackoff(t,n,o),!i)return{topicID:n,peers:[],backoff:a};const c=this.getRandomGossipPeers(n,this.opts.prunePeers,h=>h!==t&&this.score.score(h)>=0),l=await Promise.all(Array.from(c).map(async h=>{const p=this.peers.get(h)??Jt(h);let m;try{m=await this.components.peerStore.get(p)}catch(f){if(f.name!=="NotFoundError")throw f}return{peerID:p.toMultihash().bytes,signedPeerRecord:m==null?void 0:m.peerRecordEnvelope}}));return{topicID:n,peers:l,backoff:a}}async heartbeat(){var g,v;const{D:t,Dlo:n,Dhi:i,Dscore:s,Dout:o,fanoutTTL:a}=this.opts;this.heartbeatTicks++;const c=new Map,l=y=>{let w=c.get(y);return w===void 0&&(w=this.score.score(y),c.set(y,w)),w},d=new Map,h=new Map,p=new Map;this.clearBackoff(),this.peerhave.clear(),(g=this.metrics)==null||g.cacheSize.set({cache:"iasked"},this.iasked.size),this.iasked.clear(),this.applyIwantPenalties(),this.idontwantCounts.clear();for(const y of this.idontwants.values())for(const[w,b]of y)this.heartbeatTicks-b>=this.opts.mcacheLength&&y.delete(w);this.heartbeatTicks%this.opts.directConnectTicks===0&&await this.directConnect(),(v=this.fastMsgIdCache)==null||v.prune(),this.seenCache.prune(),this.gossipTracer.prune(),this.publishedMessageIds.prune();const m=new Map;this.mesh.forEach((y,w)=>{const b=this.topics.get(w),E=new Set,A=new Set;if(m.set(w,A),b!=null){const I=lo(Array.from(b)),T=this.backoff.get(w);for(const L of I){const z=this.streamsOutbound.get(L);if(z!=null&&this.multicodecs.includes(z.protocol)&&!y.has(L)&&!this.direct.has(L)){const B=l(L);(T==null?void 0:T.has(L))!==!0&&B>=0&&E.add(L),B>=this.opts.scoreThresholds.gossipThreshold&&A.add(L)}}}const k=(I,T)=>{var z;this.log("HEARTBEAT: Remove mesh link to %s in %s",I,w),this.addBackoff(I,w),y.delete(I),l(I)>=this.opts.scoreThresholds.gossipThreshold&&A.add(I),(z=this.metrics)==null||z.onRemoveFromMesh(w,T,1);const L=h.get(I);L==null?h.set(I,[w]):L.push(w)},x=(I,T)=>{var z;this.log("HEARTBEAT: Add mesh link to %s in %s",I,w),this.score.graft(I,w),y.add(I),A.delete(I),(z=this.metrics)==null||z.onAddToMesh(w,T,1);const L=d.get(I);L==null?d.set(I,[w]):L.push(w)};if(y.forEach(I=>{const T=l(I);T<0&&(this.log("HEARTBEAT: Prune peer %s with negative score: score=%d, topic=%s",I,T,w),k(I,Bs.BadScore),p.set(I,!0))}),y.size<n){const I=t-y.size;YAe(E,I).forEach(L=>{x(L,In.NotEnough)})}if(y.size>i){let I=Array.from(y);I.sort((L,z)=>l(z)-l(L)),I=I.slice(0,s).concat(lo(I.slice(s)));let T=0;if(I.slice(0,t).forEach(L=>{(this.outbound.get(L)??!1)&&T++}),T<o){const L=B=>{const G=I[B];for(let j=B;j>0;j--)I[j]=I[j-1];I[0]=G};if(T>0){let B=T;for(let G=1;G<t&&B>0;G++)(this.outbound.get(I[G])??!1)&&(L(G),B--)}let z=t-T;for(let B=t;B<I.length&&z>0;B++)(this.outbound.get(I[B])??!1)&&(L(B),z--)}I.slice(t).forEach(L=>{k(L,Bs.Excess)})}if(y.size>=n){let I=0;if(y.forEach(T=>{(this.outbound.get(T)??!1)&&I++}),I<o){const T=o-I;k9(E,T,z=>this.outbound.get(z)===!0).forEach(z=>{x(z,In.Outbound)})}}if(this.heartbeatTicks%this.opts.opportunisticGraftTicks===0&&y.size>1){const I=Array.from(y).sort((z,B)=>l(z)-l(B)),T=Math.floor(y.size/2),L=l(I[T]);if(L<this.opts.scoreThresholds.opportunisticGraftThreshold){const z=this.opts.opportunisticGraftPeers,B=k9(E,z,G=>l(G)>L);for(const G of B)this.log("HEARTBEAT: Opportunistically graft peer %s on topic %s",G,w),x(G,In.Opportunistic)}}});const f=Date.now();this.fanoutLastpub.forEach((y,w)=>{y+a<f&&(this.fanout.delete(w),this.fanoutLastpub.delete(w))}),this.fanout.forEach((y,w)=>{const b=this.topics.get(w);y.forEach(x=>{(!((b==null?void 0:b.has(x))??!1)||l(x)<this.opts.scoreThresholds.publishThreshold)&&y.delete(x)});const E=this.topics.get(w),A=[],k=new Set;if(m.set(w,k),E!=null){const x=lo(Array.from(E));for(const I of x){const T=this.streamsOutbound.get(I);if(T!=null&&this.multicodecs.includes(T.protocol)&&!y.has(I)&&!this.direct.has(I)){const L=l(I);L>=this.opts.scoreThresholds.publishThreshold&&A.push(I),L>=this.opts.scoreThresholds.gossipThreshold&&k.add(I)}}}if(y.size<t){const x=t-y.size;A.slice(0,x).forEach(I=>{y.add(I),k==null||k.delete(I)})}}),this.emitGossip(m),await this.sendGraftPrune(d,h,p),this.flush(),this.mcache.shift(),this.dispatchEvent(new CustomEvent("gossipsub:heartbeat"))}getRandomGossipPeers(t,n,i=()=>!0){const s=this.topics.get(t);if(s==null)return new Set;let o=[];return s.forEach(a=>{const c=this.streamsOutbound.get(a);c!=null&&this.multicodecs.includes(c.protocol)&&i(a)&&o.push(a)}),o=lo(o),n>0&&o.length>n&&(o=o.slice(0,n)),new Set(o)}onScrapeMetrics(t){var l,d;t.mcacheSize.set(this.mcache.size),t.mcacheNotValidatedCount.set(this.mcache.notValidatedCount),t.cacheSize.set({cache:"direct"},this.direct.size),t.cacheSize.set({cache:"seenCache"},this.seenCache.size),t.cacheSize.set({cache:"fastMsgIdCache"},((l=this.fastMsgIdCache)==null?void 0:l.size)??0),t.cacheSize.set({cache:"publishedMessageIds"},this.publishedMessageIds.size),t.cacheSize.set({cache:"mcache"},this.mcache.size),t.cacheSize.set({cache:"score"},this.score.size),t.cacheSize.set({cache:"gossipTracer.promises"},this.gossipTracer.size),t.cacheSize.set({cache:"gossipTracer.requests"},this.gossipTracer.requestMsByMsgSize),t.cacheSize.set({cache:"topics"},this.topics.size),t.cacheSize.set({cache:"subscriptions"},this.subscriptions.size),t.cacheSize.set({cache:"mesh"},this.mesh.size),t.cacheSize.set({cache:"fanout"},this.fanout.size),t.cacheSize.set({cache:"peers"},this.peers.size),t.cacheSize.set({cache:"streamsOutbound"},this.streamsOutbound.size),t.cacheSize.set({cache:"streamsInbound"},this.streamsInbound.size),t.cacheSize.set({cache:"acceptFromWhitelist"},this.acceptFromWhitelist.size),t.cacheSize.set({cache:"gossip"},this.gossip.size),t.cacheSize.set({cache:"control"},this.control.size),t.cacheSize.set({cache:"peerhave"},this.peerhave.size),t.cacheSize.set({cache:"outbound"},this.outbound.size);let n=0;const i=Date.now();t.connectedPeersBackoffSec.reset();for(const h of this.backoff.values()){n+=h.size;for(const[p,m]of h.entries())this.peers.has(p)&&t.connectedPeersBackoffSec.observe(Math.max(0,m-i)/1e3)}t.cacheSize.set({cache:"backoff"},n);let s=0;for(const h of this.idontwants.values())s+=h.size;t.cacheSize.set({cache:"idontwants"},s);for(const[h,p]of this.topics)t.topicPeersCount.set({topicStr:h},p.size);for(const[h,p]of this.mesh)t.meshPeerCounts.set({topicStr:h},p.size);const o=[],a=new Map;t.behaviourPenalty.reset();for(const h of this.peers.keys()){const p=this.score.score(h);o.push(p),a.set(h,p),t.behaviourPenalty.observe(((d=this.score.peerStats.get(h))==null?void 0:d.behaviourPenalty)??0)}t.registerScores(o,this.opts.scoreThresholds),t.registerScorePerMesh(this.mesh,a);const c=iCe(this.peers.keys(),this.score.peerStats,this.score.params,this.score.peerIPs,t.topicStrToLabel);t.registerScoreWeights(c)}}u(XH,"multicodec",Y8);function ZH(r={}){return e=>new XH(e,r)}const vCe=r=>{const[e,t]=Qe.useState(null),[n,i]=Qe.useState(null);return Qe.useEffect(()=>{async function s(){try{console.log("Starting OrbitDB initialization for",r);let o;try{o=await qH({libp2p:{transports:[PA(),_A(),xx()],transportManager:{faultTolerance:jl.NO_FATAL},peerDiscovery:[Sx({list:["/dns4/bootstrap.libp2p.io/tcp/443/wss/p2p/12D3KooWQL1aS4qD3yCjmV7gNmx4F5gP7pNXG1qimV5DXe7tXUn","/dns4/bootstrap.libp2p.io/tcp/443/wss/p2p/12D3KooWAtfLqN4QmgjrZ9eZ9r4L1B7bH7d9eW8fA4n4bBAyKSm","/dns4/relay.libp2p.io/tcp/443/wss/p2p/12D3KooWAdNWhqW6zSMv1tW2aLKNvEfR7f2DubkXq56Y2uLmsdN","/dns4/relay.ipfs.io/tcp/443/wss/p2p/12D3KooWAdNWhqW6zSMv1tW2aLKNvEfR7f2DubkXq56Y2uLmsdN","/dns4/relay.ipfs.io/tcp/443/wss/p2p/12D3KooWAdNWhqW6zSMv1tW2aLKNvEfR7f2DubkXq56Y2uLmsdN"]})],services:{identify:Ax(),pubsub:ZH()}}}),o.libp2p.addEventListener("peer:connect",l=>{console.log("Connected to peer:",l.detail.toString())}),o.libp2p.addEventListener("peer:disconnect",l=>{console.log("Disconnected from peer:",l.detail.toString())})}catch(l){throw console.error("Failed to initialize Helia:",l),new Error("IPFS initialization failed")}if(console.log("IPFS initialized:",o),!o)throw new Error("IPFS instance is undefined");const a=await IU({ipfs:o});console.log("OrbitDB instance created:",a);const c=await a.open("citizenx-annotations",{type:"documents"});console.log("Database opened:",c),t(c)}catch(o){console.error("OrbitDB initialization failed:",o),i("Failed to initialize decentralized storage")}}s()},[r]),{db:e,error:n}},ECe=(r,e,t)=>{const[n,i]=Qe.useState([]),[s,o]=Qe.useState(null);return Qe.useEffect(()=>{async function d(){if(e)try{const h=r.split("?")[0],m=(await e.all()).filter(f=>f.value.url===h).map(f=>f.value);i(m)}catch(h){console.error("Failed to load annotations:",h),o("Failed to load annotations")}}d(),e&&e.events.on("update",async()=>{const h=r.split("?")[0],m=(await e.all()).filter(f=>f.value.url===h).map(f=>f.value);i(m)})},[e,r]),{annotations:n,error:s,handleSaveAnnotation:async d=>{if(!t)throw new Error("User not authenticated");if(!e)throw new Error("Database not initialized");const h={_id:`${t}-${Date.now()}`,url:r.split("?")[0],text:d,timestamp:Date.now(),did:t,comments:[]};try{await e.put(h),i(p=>[...p,h])}catch(p){console.error("Failed to save annotation:",p),o("Failed to save annotation")}},handleDeleteAnnotation:async d=>{if(!e)throw new Error("Database not initialized");try{await e.del(d),i(h=>h.filter(p=>p._id!==d))}catch(h){console.error("Failed to delete annotation:",h),o("Failed to delete annotation")}},handleSaveComment:async(d,h)=>{if(!t)throw new Error("User not authenticated");if(!e)throw new Error("Database not initialized");try{const p=n.find(g=>g._id===d);if(!p)throw new Error("Annotation not found");const m={_id:`${t}-${Date.now()}`,text:h,timestamp:Date.now(),did:t},f={...p,comments:[...p.comments||[],m]};await e.put(f),i(g=>g.map(v=>v._id===d?f:v))}catch(p){console.error("Failed to save comment:",p),o("Failed to save comment")}}}},eq=r=>{const[e,t]=Qe.useState(new Map),[n,i]=Qe.useState(!0),[s,o]=Qe.useState(null),[a,c]=Qe.useState(null);return Qe.useEffect(()=>{console.log("useUserProfiles: Current DID:",r);async function h(){try{console.log("Initializing user profiles database...");const p=await qH({libp2p:{transports:[PA(),_A(),xx()],transportManager:{faultTolerance:jl.NO_FATAL},peerDiscovery:[Sx({list:["/dns4/bootstrap.libp2p.io/tcp/443/wss/p2p/12D3KooWQL1aS4qD3yCjmV7gNmx4F5gP7pNXG1qimV5DXe7tXUn","/dns4/bootstrap.libp2p.io/tcp/443/wss/p2p/12D3KooWAtfLqN4QmgjrZ9eZ9r4L1B7bH7d9eW8fA4n4bBAyKSm","/dns4/relay.libp2p.io/tcp/443/wss/p2p/12D3KooWAdNWhqW6zSMv1tW2aLKNvEfR7f2DubkXq56Y2uLmsdN","/dns4/relay.ipfs.io/tcp/443/wss/p2p/12D3KooWAdNWhqW6zSMv1tW2aLKNvEfR7f2DubkXq56Y2uLmsdN","/dns4/relay.ipfs.io/tcp/443/wss/p2p/12D3KooWAdNWhqW6zSMv1tW2aLKNvEfR7f2DubkXq56Y2uLmsdN","/dns4/go-ipfs-bootstrap-1.ipfs.dwebops.pub/tcp/443/wss/p2p/QmNnooDu7bfjPFoTZYxMNLWUQJyrVwtbZguyWvRmga5yW","/dns4/go-ipfs-bootstrap-2.ipfs.dwebops.pub/tcp/443/wss/p2p/QmNnooDu7bfjPFoTZYxMNLWUQJyrVwtbZguyWvRmga5yX"]})],services:{identify:Ax(),pubsub:ZH()}}});p.libp2p.addEventListener("peer:connect",b=>{console.log("Connected to peer:",b.detail.toString())}),p.libp2p.addEventListener("peer:disconnect",b=>{console.log("Disconnected from peer:",b.detail.toString())}),console.log("IPFS initialized for user profiles:",p);const f=await(await IU({ipfs:p})).open("citizenx-user-profiles",{type:"documents"});console.log("User profiles database opened:",f),c(f);const g=await f.all(),v=new Map;g.forEach(b=>{v.set(b.value._id,b.value)});const y=localStorage.getItem("citizenx-user-profiles")||"[]";console.log("Raw localStorage profiles:",y);const w=JSON.parse(y);console.log("Parsed localStorage profiles:",w),w.forEach(b=>{v.has(b._id)||v.set(b._id,b)}),t(v),console.log("Initial profiles loaded:",Array.from(v.entries())),i(!1),f.events.on("update",async()=>{const b=await f.all(),E=new Map;b.forEach(k=>{E.set(k.value._id,k.value)}),JSON.parse(localStorage.getItem("citizenx-user-profiles")||"[]").forEach(k=>{E.has(k._id)||E.set(k._id,k)}),t(E),console.log("User profiles updated:",Array.from(E.entries()))}),f.events.on("peer",async()=>{console.log("Peer connected, syncing local profiles to OrbitDB");const b=JSON.parse(localStorage.getItem("citizenx-user-profiles")||"[]");for(const k of b)try{await f.put(k),console.log("Synced local profile to OrbitDB:",k)}catch(x){console.error("Failed to sync local profile:",x)}localStorage.setItem("citizenx-user-profiles",JSON.stringify([]));const E=await f.all(),A=new Map;E.forEach(k=>{A.set(k.value._id,k.value)}),t(A),console.log("Profiles after sync:",Array.from(A.entries()))})}catch(p){console.error("Failed to initialize user profiles database:",p),o("Failed to initialize user profiles database"),i(!1)}}h()},[]),{profiles:e,createProfile:async(h,p)=>{if(!r)throw new Error("User not authenticated");const m={_id:r,handle:h,profilePicture:p};try{if(!a)throw new Error("Database not initialized");await a.put(m),console.log("User profile created:",m),t(f=>{const g=new Map(f);return g.set(r,m),console.log("Profiles after create:",Array.from(g.entries())),g})}catch(f){if(f.message.includes("NoPeersSubscribedToTopic")){console.warn("No peers subscribed, saving profile to localStorage:",m);const g=JSON.parse(localStorage.getItem("citizenx-user-profiles")||"[]"),v=g.findIndex(y=>y._id===r);v!==-1?g[v]=m:g.push(m),localStorage.setItem("citizenx-user-profiles",JSON.stringify(g)),t(y=>{const w=new Map(y);return w.set(r,m),console.log("Profiles after local save:",Array.from(w.entries())),JSON.parse(localStorage.getItem("citizenx-user-profiles")||"[]").forEach(E=>{w.has(E._id)||w.set(E._id,E)}),console.log("Profiles after refresh:",Array.from(w.entries())),w})}else throw console.error("Failed to create user profile:",f),f}},updateProfile:async(h,p)=>{if(!r)throw new Error("User not authenticated");try{if(!a)throw new Error("Database not initialized");const m=await a.get(r);if(!m)throw new Error("User profile not found");const f={...m,handle:h,profilePicture:p};await a.put(f),console.log("User profile updated:",f),t(g=>{const v=new Map(g);return v.set(r,f),console.log("Profiles after update:",Array.from(v.entries())),v})}catch(m){if(m.message.includes("NoPeersSubscribedToTopic")){console.warn("No peers subscribed, updating profile in localStorage:",{did:r,handle:h,profilePicture:p});const f=JSON.parse(localStorage.getItem("citizenx-user-profiles")||"[]"),g=f.findIndex(y=>y._id===r),v={_id:r,handle:h,profilePicture:p};g!==-1?f[g]=v:f.push(v),localStorage.setItem("citizenx-user-profiles",JSON.stringify(f)),t(y=>{const w=new Map(y);return w.set(r,v),console.log("Profiles after local update:",Array.from(w.entries())),w})}else throw console.error("Failed to update user profile:",m),m}},loading:n,error:s}};async function SCe(){const r=await crypto.subtle.generateKey({name:"ECDSA",namedCurve:"P-256"},!0,["sign","verify"]),e=await crypto.subtle.exportKey("spki",r.publicKey),t=btoa(String.fromCharCode(...new Uint8Array(e))),n=await crypto.subtle.exportKey("pkcs8",r.privateKey),i=btoa(String.fromCharCode(...new Uint8Array(n)));return{publicKey:t,privateKey:i,rawPublicKey:r.publicKey,rawPrivateKey:r.privateKey}}async function X$(r,e){const t=Uint8Array.from(atob(e),a=>a.charCodeAt(0)),n=await crypto.subtle.importKey("pkcs8",t,{name:"ECDSA",namedCurve:"P-256"},!1,["sign"]),s=new TextEncoder().encode(r),o=await crypto.subtle.sign({name:"ECDSA",hash:"SHA-256"},n,s);return btoa(String.fromCharCode(...new Uint8Array(o)))}async function Z$(r,e,t){const n=Uint8Array.from(atob(t),c=>c.charCodeAt(0)),i=await crypto.subtle.importKey("spki",n,{name:"ECDSA",namedCurve:"P-256"},!1,["verify"]),s=Uint8Array.from(atob(e),c=>c.charCodeAt(0)),a=new TextEncoder().encode(r);return await crypto.subtle.verify({name:"ECDSA",hash:"SHA-256"},i,s,a)}async function xCe(r,e){const t=new TextEncoder,n=t.encode(e),i=crypto.getRandomValues(new Uint8Array(16)),s=await crypto.subtle.importKey("raw",n,{name:"PBKDF2"},!1,["deriveBits","deriveKey"]),o=await crypto.subtle.deriveKey({name:"PBKDF2",salt:i,iterations:1e5,hash:"SHA-256"},s,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"]),a=crypto.getRandomValues(new Uint8Array(12)),c=t.encode(r),l=await crypto.subtle.encrypt({name:"AES-GCM",iv:a},o,c),d=new Uint8Array(i.length+a.length+l.byteLength);return d.set(i,0),d.set(a,i.length),d.set(new Uint8Array(l),i.length+a.length),btoa(String.fromCharCode(...d))}async function ACe(r,e){const t=Uint8Array.from(atob(r),h=>h.charCodeAt(0)),n=t.slice(0,16),i=t.slice(16,28),s=t.slice(28),a=new TextEncoder().encode(e),c=await crypto.subtle.importKey("raw",a,{name:"PBKDF2"},!1,["deriveBits","deriveKey"]),l=await crypto.subtle.deriveKey({name:"PBKDF2",salt:n,iterations:1e5,hash:"SHA-256"},c,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"]),d=await crypto.subtle.decrypt({name:"AES-GCM",iv:i},l,s);return new TextDecoder().decode(d)}const CCe=()=>{const[r,e]=Qe.useState(null),[t,n]=Qe.useState(null),[i,s]=Qe.useState(null),{profiles:o,loading:a,createProfile:c,updateProfile:l,error:d}=eq(r);return Qe.useEffect(()=>{const g=chrome;if(!g.storage||!g.storage.local){n("chrome.storage.local is not available");return}g.storage.local.get(["did"],v=>{if(v.did){e(v.did),console.log("useAuth: Initial DID from storage:",v.did);const y=localStorage.getItem("citizenx-user-profiles")||"[]";console.log("useAuth: Checking localStorage profiles for DID mismatch:",y);let w;try{w=JSON.parse(y)}catch(E){console.error("useAuth: Failed to parse localStorage profiles:",E),w=[]}const b=w.find(E=>(console.log("useAuth: Comparing DID",v.did,"with profile _id",E._id),E._id===v.did));!b&&w.length>0&&(console.log("useAuth: DID mismatch detected, clearing stale profiles"),localStorage.setItem("citizenx-user-profiles",JSON.stringify([]))),b&&(console.log("useAuth: Setting initial profile from localStorage:",b),s(b))}else console.log("useAuth: No DID found in storage")})},[]),Qe.useEffect(()=>{if(console.log("useAuth: Loading profiles, loading:",a,"profiles:",Array.from(o.entries())),r&&!a){const g=o.get(r);console.log("useAuth: Profile for DID",r,":",g),s(g||null)}},[r,o,a]),{did:r,profile:i,loading:a,authenticate:async()=>{try{const g=chrome;if(!g.storage||!g.storage.local)throw new Error("chrome.storage.local is not available");const v=await new Promise(y=>{g.storage.local.get(["did","privateKey"],y)});if(v.did&&v.privateKey){e(v.did),console.log("useAuth: Authenticated DID:",v.did);const y=Date.now().toString(),w=await X$(y,v.privateKey);if(!await Z$(y,w,v.did))throw new Error("Failed to verify existing key pair");n(null)}else{const y=await SCe();g.storage.local.set({did:y.publicKey,privateKey:y.privateKey},()=>{console.log("useAuth: Key pair stored in chrome.storage.local"),e(y.publicKey),console.log("useAuth: New authenticated DID:",y.publicKey),n(null)})}}catch(g){console.error("useAuth: Authentication error:",g),n(g.message),e(null)}},signOut:()=>{e(null),s(null),n(null);const g=chrome;g.storage&&g.storage.local&&(g.storage.local.remove(["did","privateKey"],()=>{console.log("useAuth: Cleared DID and private key from chrome.storage.local")}),localStorage.setItem("citizenx-user-profiles",JSON.stringify([])),console.log("useAuth: Cleared profiles from localStorage"))},exportIdentity:async g=>{const v=chrome;if(!v.storage||!v.storage.local)throw new Error("chrome.storage.local is not available");const y=await new Promise(E=>{v.storage.local.get(["did","privateKey"],E)});if(!y.did||!y.privateKey)throw new Error("No identity found to export");const w=await xCe(y.privateKey,g);return JSON.stringify({did:y.did,privateKey:w})},importIdentity:async(g,v)=>{try{const y=chrome;if(!y.storage||!y.storage.local)throw new Error("chrome.storage.local is not available");const{did:w,privateKey:b}=JSON.parse(g),E=await ACe(b,v),A=Date.now().toString(),k=await X$(A,E);if(!await Z$(A,k,w))throw new Error("Invalid key pair or passphrase");y.storage.local.set({did:w,privateKey:E},()=>{console.log("useAuth: Imported identity stored in chrome.storage.local"),e(w),console.log("useAuth: Imported DID:",w),n(null)})}catch(y){throw console.error("useAuth: Import error:",y),n(y.message),e(null),y}},createProfile:c,updateProfile:l,error:t||d}},ICe=({comment:r,creatorProfile:e})=>Ae.jsxs("div",{style:{marginLeft:"1rem",marginTop:"0.5rem",borderLeft:"2px solid #e5e7eb",paddingLeft:"0.5rem"},children:[Ae.jsxs("div",{style:{display:"flex",alignItems:"center",marginBottom:"0.25rem"},children:[(e==null?void 0:e.profilePicture)&&Ae.jsx("img",{src:e.profilePicture,alt:"Profile",style:{width:"1.5rem",height:"1.5rem",borderRadius:"50%",marginRight:"0.5rem"}}),Ae.jsxs("p",{style:{margin:"0",fontSize:"0.8rem",color:"#666"},children:[(e==null?void 0:e.handle)||"Anonymous","  ",new Date(r.timestamp).toLocaleString()]})]}),Ae.jsx("p",{style:{margin:"0",fontSize:"0.9rem",color:"#333"},children:r.text})]}),kCe=({annotations:r,profiles:e,onDelete:t,onSaveComment:n})=>{const[i,s]=Qe.useState({}),o=async a=>{if(!(!n||!i[a]))try{await n(a,i[a]),s(c=>({...c,[a]:""}))}catch(c){console.error("Failed to submit comment:",c)}};return Ae.jsx("div",{children:r.map(a=>{const c=e.get(a.did||"");return Ae.jsxs("div",{style:{background:"#fff",padding:"0.5rem",border:"1px solid #e5e7eb",borderRadius:"5px",marginBottom:"0.5rem"},children:[Ae.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[Ae.jsxs("div",{style:{display:"flex",alignItems:"center"},children:[(c==null?void 0:c.profilePicture)&&Ae.jsx("img",{src:c.profilePicture,alt:"Profile",style:{width:"1.5rem",height:"1.5rem",borderRadius:"50%",marginRight:"0.5rem"}}),Ae.jsxs("p",{style:{margin:"0",fontSize:"0.9rem",color:"#333"},children:[(c==null?void 0:c.handle)||"Anonymous","  ",new Date(a.timestamp).toLocaleString()]})]}),Ae.jsx("button",{onClick:()=>t(a._id),style:{padding:"0.25rem 0.5rem",background:"#e11d48",color:"#fff",border:"none",borderRadius:"5px",cursor:"pointer",fontSize:"0.8rem"},onMouseEnter:l=>l.currentTarget.style.backgroundColor="#f43f5e",onMouseLeave:l=>l.currentTarget.style.backgroundColor="#e11d48",children:"Delete"})]}),Ae.jsx("p",{style:{margin:"0.5rem 0 0 0",fontSize:"0.9rem",color:"#333"},children:a.text}),a.comments&&a.comments.length>0&&Ae.jsx("div",{style:{marginTop:"0.5rem"},children:a.comments.map(l=>Ae.jsx(ICe,{comment:l,creatorProfile:e.get(l.did)},l._id))}),n&&Ae.jsxs("div",{style:{marginTop:"0.5rem"},children:[Ae.jsx("textarea",{value:i[a._id]||"",onChange:l=>s(d=>({...d,[a._id]:l.target.value})),placeholder:"Add a comment...",style:{width:"100%",height:"3rem",marginBottom:"0.5rem",fontSize:"0.9rem",border:"1px solid #e5e7eb",borderRadius:"5px",padding:"0.5rem",color:"#333",backgroundColor:"#fff"}}),Ae.jsx("button",{onClick:()=>o(a._id),disabled:!i[a._id],style:{padding:"0.5rem 1rem",background:i[a._id]?"#2c7a7b":"#d1d5db",color:"#fff",border:"none",borderRadius:"5px",cursor:i[a._id]?"pointer":"not-allowed",width:"100%",fontSize:"0.9rem"},onMouseEnter:l=>i[a._id]&&(l.currentTarget.style.backgroundColor="#4a999a"),onMouseLeave:l=>i[a._id]&&(l.currentTarget.style.backgroundColor="#2c7a7b"),children:"Add Comment"})]})]},a._id)})})},_Ce=({url:r})=>{const[e,t]=Qe.useState(""),{did:n,profile:i,loading:s,authenticate:o,signOut:a,exportIdentity:c,importIdentity:l,createProfile:d,updateProfile:h,error:p}=CCe(),{profiles:m,error:f}=eq(n),[g,v]=Qe.useState(""),[y,w]=Qe.useState(""),[b,E]=Qe.useState(""),[A,k]=Qe.useState(""),[x,I]=Qe.useState(""),[T,L]=Qe.useState(""),[z,B]=Qe.useState(!1),[G,j]=Qe.useState(!1),[q,Q]=Qe.useState(""),[K,O]=Qe.useState(""),[U,W]=Qe.useState(!1),Y=Qe.useRef(null),H=r.startsWith("chrome-extension://"),{db:ne,error:ye}=H?{db:null,error:null}:vCe(r),{annotations:ue,error:ce,handleSaveAnnotation:Ne,handleDeleteAnnotation:Me,handleSaveComment:Xe}=H?{annotations:[],error:null,handleSaveAnnotation:async()=>{},handleDeleteAnnotation:async()=>{},handleSaveComment:async()=>{}}:ECe(r,ne,n),tt=p||ye||ce||f;Qe.useEffect(()=>{console.log("AnnotationUI: Checking profile modal conditions - loading:",s,"did:",n,"profile:",i),!s&&n&&!i&&(console.log("AnnotationUI: Opening Update Profile modal"),B(!0))},[n,i,s]),Qe.useEffect(()=>{const fe=Fi=>{Y.current&&!Y.current.contains(Fi.target)&&W(!1)};return document.addEventListener("mousedown",fe),()=>{document.removeEventListener("mousedown",fe)}},[]);const wt=async()=>{await Ne(e),t("")},bt=async()=>{try{if(!b){L("Please enter a passphrase to export your identity");return}const fe=await c(b);v(fe),L("")}catch(fe){L(fe.message)}},kt=async()=>{try{if(!y||!A){I("Please enter the identity data and passphrase");return}await l(y,A),w(""),k(""),I(""),v("")}catch(fe){I(fe.message)}},Qt=async()=>{try{if(!q||!K){L("Please provide a handle and profile picture");return}i?await h(q,K):await d(q,K),B(!1),Q(""),O(""),W(!1)}catch(fe){L(fe.message)}},pr=fe=>{var bs;const Fi=(bs=fe.target.files)==null?void 0:bs[0];if(Fi){const zi=new FileReader;zi.onload=tn=>{var ua;(ua=tn.target)!=null&&ua.result&&O(tn.target.result)},zi.readAsDataURL(Fi)}},to=()=>{W(fe=>!fe)},ws=()=>{W(!1),j(!0),E(""),v(""),L("")};return Ae.jsxs("div",{style:{padding:"1rem",width:"100%",backgroundColor:"#f5f7fa",minHeight:"100vh",fontFamily:"Arial, sans-serif"},children:[n?Ae.jsx("div",{style:{marginBottom:"1rem",backgroundColor:"#fff",padding:"0.5rem",borderRadius:"5px",border:"1px solid #e5e7eb"},children:Ae.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",flexWrap:"wrap"},children:[Ae.jsxs("div",{style:{display:"flex",alignItems:"center",flexShrink:0},children:[i&&i.profilePicture&&Ae.jsx("img",{src:i.profilePicture,alt:"Profile",style:{width:"2rem",height:"2rem",borderRadius:"50%",marginRight:"0.5rem"}}),Ae.jsxs("p",{style:{margin:"0",fontSize:"0.9rem",color:"#333",whiteSpace:"nowrap"},children:["Connected: ",(i==null?void 0:i.handle)||"Set your handle"]})]}),Ae.jsxs("div",{style:{position:"relative",flexShrink:0},children:[Ae.jsx("button",{onClick:to,style:{padding:"0.25rem",background:"none",border:"none",cursor:"pointer"},"aria-label":"Settings",children:Ae.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1.25rem",height:"1.25rem",viewBox:"0 0 24 24",fill:"none",stroke:"#2c7a7b",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[Ae.jsx("circle",{cx:"12",cy:"12",r:"3"}),Ae.jsx("path",{d:"M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l-.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h-.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l-.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v-.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l-.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"})]})}),U&&Ae.jsxs("div",{ref:Y,style:{position:"absolute",right:0,top:"100%",background:"#fff",border:"1px solid #e5e7eb",borderRadius:"5px",boxShadow:"0 2px 8px rgba(0,0,0,0.1)",zIndex:1e3},children:[Ae.jsx("button",{onClick:()=>B(!0),style:{display:"block",padding:"0.5rem 1rem",background:"none",border:"none",width:"100%",textAlign:"left",cursor:"pointer",color:"#333",fontSize:"0.9rem"},onMouseEnter:fe=>fe.currentTarget.style.backgroundColor="#f5f7fa",onMouseLeave:fe=>fe.currentTarget.style.backgroundColor="transparent",children:"Edit Profile"}),Ae.jsx("button",{onClick:ws,style:{display:"block",padding:"0.5rem 1rem",background:"none",border:"none",width:"100%",textAlign:"left",cursor:"pointer",color:"#333",fontSize:"0.9rem"},onMouseEnter:fe=>fe.currentTarget.style.backgroundColor="#f5f7fa",onMouseLeave:fe=>fe.currentTarget.style.backgroundColor="transparent",children:"Export Identity"}),Ae.jsx("button",{onClick:a,style:{display:"block",padding:"0.5rem 1rem",background:"none",border:"none",width:"100%",textAlign:"left",cursor:"pointer",color:"#f97316",fontSize:"0.9rem"},onMouseEnter:fe=>fe.currentTarget.style.backgroundColor="#f5f7fa",onMouseLeave:fe=>fe.currentTarget.style.backgroundColor="transparent",children:"Sign Out"})]})]})]})}):Ae.jsxs("div",{style:{marginBottom:"1rem"},children:[Ae.jsx("button",{onClick:o,style:{padding:"0.5rem 1rem",background:"#2c7a7b",color:"#fff",border:"none",borderRadius:"5px",cursor:"pointer",width:"100%",fontSize:"0.9rem"},onMouseEnter:fe=>fe.currentTarget.style.backgroundColor="#4a999a",onMouseLeave:fe=>fe.currentTarget.style.backgroundColor="#2c7a7b",children:"Authenticate"}),Ae.jsxs("div",{style:{marginTop:"0.5rem"},children:[Ae.jsx("textarea",{value:y,onChange:fe=>w(fe.target.value),placeholder:"Paste your exported identity here...",style:{width:"100%",height:"3.75rem",marginBottom:"0.5rem",fontSize:"0.8rem",border:"1px solid #e5e7eb",borderRadius:"5px",padding:"0.5rem",color:"#333",backgroundColor:"#fff"}}),Ae.jsx("input",{type:"password",placeholder:"Enter passphrase to import",value:A,onChange:fe=>k(fe.target.value),style:{width:"100%",marginBottom:"0.5rem",padding:"0.5rem",border:"1px solid #e5e7eb",borderRadius:"5px",fontSize:"0.9rem",color:"#333",backgroundColor:"#fff"}}),Ae.jsx("button",{onClick:kt,style:{padding:"0.5rem 1rem",background:"#2c7a7b",color:"#fff",border:"none",borderRadius:"5px",cursor:"pointer",width:"100%",fontSize:"0.9rem"},onMouseEnter:fe=>fe.currentTarget.style.backgroundColor="#4a999a",onMouseLeave:fe=>fe.currentTarget.style.backgroundColor="#2c7a7b",children:"Import Identity"}),x&&Ae.jsx("p",{style:{color:"#e11d48",margin:"0.25rem 0 0 0",fontSize:"0.8rem"},children:x})]})]}),z&&Ae.jsxs("div",{style:{position:"fixed",top:"50%",left:"50%",transform:"translate(-50%, -50%)",background:"#fff",padding:"1rem",borderRadius:"5px",boxShadow:"0 0 10px rgba(0,0,0,0.3)",zIndex:1e3,width:"90%",maxWidth:"400px"},children:[Ae.jsx("h2",{style:{fontSize:"1.2rem",margin:"0 0 0.5rem 0",color:"#333"},children:i?"Update Profile":"Set Profile"}),Ae.jsx("input",{type:"text",placeholder:"Enter your handle",value:q,onChange:fe=>Q(fe.target.value),style:{width:"100%",marginBottom:"0.5rem",padding:"0.5rem",border:"1px solid #e5e7eb",borderRadius:"5px",fontSize:"0.9rem",color:"#333",backgroundColor:"#fff"}}),Ae.jsx("input",{type:"file",accept:"image/*",onChange:pr,style:{width:"100%",marginBottom:"0.5rem"}}),K&&Ae.jsx("img",{src:K,alt:"Preview",style:{width:"3.125rem",height:"3.125rem",borderRadius:"50%",marginBottom:"0.5rem"}}),Ae.jsxs("div",{style:{display:"flex",gap:"0.5rem"},children:[Ae.jsx("button",{onClick:Qt,style:{padding:"0.5rem 1rem",background:"#2c7a7b",color:"#fff",border:"none",borderRadius:"5px",cursor:"pointer",fontSize:"0.9rem",flex:1},onMouseEnter:fe=>fe.currentTarget.style.backgroundColor="#4a999a",onMouseLeave:fe=>fe.currentTarget.style.backgroundColor="#2c7a7b",children:"Save"}),Ae.jsx("button",{onClick:()=>B(!1),style:{padding:"0.5rem 1rem",background:"#f97316",color:"#fff",border:"none",borderRadius:"5px",cursor:"pointer",fontSize:"0.9rem",flex:1},onMouseEnter:fe=>fe.currentTarget.style.backgroundColor="#fb923c",onMouseLeave:fe=>fe.currentTarget.style.backgroundColor="#f97316",children:"Cancel"})]})]}),G&&Ae.jsxs("div",{style:{position:"fixed",top:"50%",left:"50%",transform:"translate(-50%, -50%)",background:"#fff",padding:"1rem",borderRadius:"5px",boxShadow:"0 0 10px rgba(0,0,0,0.3)",zIndex:1e3,width:"90%",maxWidth:"400px"},children:[Ae.jsx("h2",{style:{fontSize:"1.2rem",margin:"0 0 0.5rem 0",color:"#333"},children:"Export Identity"}),Ae.jsx("input",{type:"password",placeholder:"Enter passphrase to export",value:b,onChange:fe=>E(fe.target.value),style:{width:"100%",marginBottom:"0.5rem",padding:"0.5rem",border:"1px solid #e5e7eb",borderRadius:"5px",fontSize:"0.9rem",color:"#333",backgroundColor:"#fff"}}),Ae.jsx("button",{onClick:bt,style:{padding:"0.5rem 1rem",background:"#2c7a7b",color:"#fff",border:"none",borderRadius:"5px",cursor:"pointer",width:"100%",fontSize:"0.9rem",marginBottom:"0.5rem"},onMouseEnter:fe=>fe.currentTarget.style.backgroundColor="#4a999a",onMouseLeave:fe=>fe.currentTarget.style.backgroundColor="#2c7a7b",children:"Export"}),T&&Ae.jsx("p",{style:{color:"#e11d48",margin:"0.25rem 0 0.5rem 0",fontSize:"0.8rem"},children:T}),g&&Ae.jsx("textarea",{value:g,readOnly:!0,style:{width:"100%",height:"3.75rem",marginBottom:"0.5rem",fontSize:"0.8rem",border:"1px solid #e5e7eb",borderRadius:"5px",padding:"0.5rem",color:"#333",backgroundColor:"#fff"}}),Ae.jsx("button",{onClick:()=>j(!1),style:{padding:"0.5rem 1rem",background:"#f97316",color:"#fff",border:"none",borderRadius:"5px",cursor:"pointer",width:"100%",fontSize:"0.9rem"},onMouseEnter:fe=>fe.currentTarget.style.backgroundColor="#fb923c",onMouseLeave:fe=>fe.currentTarget.style.backgroundColor="#f97316",children:"Close"})]}),tt&&Ae.jsx("p",{style:{color:"#e11d48",margin:"0 0 0.5rem 0",fontSize:"0.8rem"},children:tt}),Ae.jsx("textarea",{value:e,onChange:fe=>t(fe.target.value),placeholder:"Enter annotation...",style:{width:"100%",height:"5rem",marginBottom:"0.5rem",fontSize:"0.9rem",border:"1px solid #e5e7eb",borderRadius:"5px",padding:"0.5rem",color:"#333",backgroundColor:"#fff"}}),Ae.jsx("button",{onClick:wt,disabled:!n||!ne,style:{padding:"0.5rem 1rem",background:n&&ne?"#2c7a7b":"#d1d5db",color:"#fff",border:"none",borderRadius:"5px",cursor:n&&ne?"pointer":"not-allowed",marginBottom:"1rem",width:"100%",fontSize:"0.9rem"},onMouseEnter:fe=>n&&ne&&(fe.currentTarget.style.backgroundColor="#4a999a"),onMouseLeave:fe=>n&&ne&&(fe.currentTarget.style.backgroundColor="#2c7a7b"),children:"Save"}),Ae.jsx(kCe,{annotations:ue,profiles:m,onDelete:Me,onSaveComment:n&&ne?Xe:void 0})]})},TCe=()=>{const[r,e]=Qe.useState(null);return Qe.useEffect(()=>{const t=()=>{chrome.tabs.query({active:!0,currentWindow:!0},s=>{var o;(o=s[0])!=null&&o.url?e(s[0].url):(console.error("Failed to get current tab URL"),e(""))})};t();const n=(s,o,a)=>{o.url&&a.active&&e(o.url)};chrome.tabs.onUpdated.addListener(n);const i=()=>{t()};return chrome.tabs.onActivated.addListener(i),()=>{chrome.tabs.onUpdated.removeListener(n),chrome.tabs.onActivated.removeListener(i)}},[]),r===null?Ae.jsx("div",{children:"Loading..."}):Ae.jsx(_Ce,{url:r})},eN=document.getElementById("root");eN?BR(eN).render(Ae.jsx(TCe,{})):console.error("Root element not found");
