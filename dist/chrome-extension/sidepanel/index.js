var nCe=Object.defineProperty;var qH=rt=>{throw TypeError(rt)};var iCe=(rt,Je,Kt)=>Je in rt?nCe(rt,Je,{enumerable:!0,configurable:!0,writable:!0,value:Kt}):rt[Je]=Kt;var u=(rt,Je,Kt)=>iCe(rt,typeof Je!="symbol"?Je+"":Je,Kt),MA=(rt,Je,Kt)=>Je.has(rt)||qH("Cannot "+Kt);var se=(rt,Je,Kt)=>(MA(rt,Je,"read from private field"),Kt?Kt.call(rt):Je.get(rt)),Ye=(rt,Je,Kt)=>Je.has(rt)?qH("Cannot add the same private member more than once"):Je instanceof WeakSet?Je.add(rt):Je.set(rt,Kt),_t=(rt,Je,Kt,eo)=>(MA(rt,Je,"write to private field"),eo?eo.call(rt,Kt):Je.set(rt,Kt),Kt),Ae=(rt,Je,Kt)=>(MA(rt,Je,"access private method"),Kt);var Zs=(rt,Je,Kt,eo)=>({set _(w0){_t(rt,Je,w0,Kt)},get _(){return se(rt,Je,eo)}});(function(){"use strict";var Ui,vj,Fh,zh,Uc,o0,Vh,a0,Fi,Kh,yn,c0,zi,jh,oa,l0,$4,at,WH,GH,QH,YH,JH,O4,OA,RA,R4,XH,L4,Ej,PA,DA,$A,Js,Sj,xj,Aj,Cj,Ij,kj,_j,Tj,aa,B4,LA,Pj,Dj,$j,Nj,qh,Fc,u0,d0,Eu,Su,Gh,Qh,xu,N4,ZH,Mj,Oj,mn,p0,BA,g0,Rj,Lj,Bj,Uj,Fj,zj,Vj,Kj,jj,Hj,qj,Wj,Gj,Qj,Fn,eq,y0,m0,Yj,Jj,Xj,Zj,eH,tH,rH,nH,iH,sH,oH,aH,cH,lH,uH,dH,hH,fH,pH,gH,Yh,U4,yH,mH,wH,bH,vH,EH,SH,xH,AH,CH,IH,zn,F4,z4,V4,kH,Jh,K4,_H,TH,PH,DH,$H,NH,MH,OH,RH,LH,BH,UH,FH,h0,UA,zH,VH,KH,jH;var rt=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Je(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}var Kt={exports:{}},eo={},w0={exports:{}},je={};/**
* @license React
* react.production.min.js
*
* Copyright (c) Facebook, Inc. and its affiliates.
*
* This source code is licensed under the MIT license found in the
* LICENSE file in the root directory of this source tree.
*/var ef=Symbol.for("react.element"),rq=Symbol.for("react.portal"),nq=Symbol.for("react.fragment"),iq=Symbol.for("react.strict_mode"),sq=Symbol.for("react.profiler"),oq=Symbol.for("react.provider"),aq=Symbol.for("react.context"),cq=Symbol.for("react.forward_ref"),lq=Symbol.for("react.suspense"),uq=Symbol.for("react.memo"),dq=Symbol.for("react.lazy"),FA=Symbol.iterator;function hq(r){return r===null||typeof r!="object"?null:(r=FA&&r[FA]||r["@@iterator"],typeof r=="function"?r:null)}var zA={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},VA=Object.assign,KA={};function ku(r,e,t){this.props=r,this.context=e,this.refs=KA,this.updater=t||zA}ku.prototype.isReactComponent={},ku.prototype.setState=function(r,e){if(typeof r!="object"&&typeof r!="function"&&r!=null)throw Error("setState(...): takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,r,e,"setState")},ku.prototype.forceUpdate=function(r){this.updater.enqueueForceUpdate(this,r,"forceUpdate")};function jA(){}jA.prototype=ku.prototype;function j4(r,e,t){this.props=r,this.context=e,this.refs=KA,this.updater=t||zA}var H4=j4.prototype=new jA;H4.constructor=j4,VA(H4,ku.prototype),H4.isPureReactComponent=!0;var HA=Array.isArray,qA=Object.prototype.hasOwnProperty,q4={current:null},WA={key:!0,ref:!0,__self:!0,__source:!0};function GA(r,e,t){var n,i={},s=null,o=null;if(e!=null)for(n in e.ref!==void 0&&(o=e.ref),e.key!==void 0&&(s=""+e.key),e)qA.call(e,n)&&!WA.hasOwnProperty(n)&&(i[n]=e[n]);var a=arguments.length-2;if(a===1)i.children=t;else if(1<a){for(var c=Array(a),l=0;l<a;l++)c[l]=arguments[l+2];i.children=c}if(r&&r.defaultProps)for(n in a=r.defaultProps,a)i[n]===void 0&&(i[n]=a[n]);return{$$typeof:ef,type:r,key:s,ref:o,props:i,_owner:q4.current}}function fq(r,e){return{$$typeof:ef,type:r.type,key:e,ref:r.ref,props:r.props,_owner:r._owner}}function W4(r){return typeof r=="object"&&r!==null&&r.$$typeof===ef}function pq(r){var e={"=":"=0",":":"=2"};return"$"+r.replace(/[=:]/g,function(t){return e[t]})}var QA=/\/+/g;function G4(r,e){return typeof r=="object"&&r!==null&&r.key!=null?pq(""+r.key):e.toString(36)}function b0(r,e,t,n,i){var s=typeof r;(s==="undefined"||s==="boolean")&&(r=null);var o=!1;if(r===null)o=!0;else switch(s){case"string":case"number":o=!0;break;case"object":switch(r.$$typeof){case ef:case rq:o=!0}}if(o)return o=r,i=i(o),r=n===""?"."+G4(o,0):n,HA(i)?(t="",r!=null&&(t=r.replace(QA,"$&/")+"/"),b0(i,e,t,"",function(l){return l})):i!=null&&(W4(i)&&(i=fq(i,t+(!i.key||o&&o.key===i.key?"":(""+i.key).replace(QA,"$&/")+"/")+r)),e.push(i)),1;if(o=0,n=n===""?".":n+":",HA(r))for(var a=0;a<r.length;a++){s=r[a];var c=n+G4(s,a);o+=b0(s,e,t,c,i)}else if(c=hq(r),typeof c=="function")for(r=c.call(r),a=0;!(s=r.next()).done;)s=s.value,c=n+G4(s,a++),o+=b0(s,e,t,c,i);else if(s==="object")throw e=String(r),Error("Objects are not valid as a React child (found: "+(e==="[object Object]"?"object with keys {"+Object.keys(r).join(", ")+"}":e)+"). If you meant to render a collection of children, use an array instead.");return o}function v0(r,e,t){if(r==null)return r;var n=[],i=0;return b0(r,n,"","",function(s){return e.call(t,s,i++)}),n}function gq(r){if(r._status===-1){var e=r._result;e=e(),e.then(function(t){(r._status===0||r._status===-1)&&(r._status=1,r._result=t)},function(t){(r._status===0||r._status===-1)&&(r._status=2,r._result=t)}),r._status===-1&&(r._status=0,r._result=e)}if(r._status===1)return r._result.default;throw r._result}var rn={current:null},E0={transition:null},yq={ReactCurrentDispatcher:rn,ReactCurrentBatchConfig:E0,ReactCurrentOwner:q4};function YA(){throw Error("act(...) is not supported in production builds of React.")}je.Children={map:v0,forEach:function(r,e,t){v0(r,function(){e.apply(this,arguments)},t)},count:function(r){var e=0;return v0(r,function(){e++}),e},toArray:function(r){return v0(r,function(e){return e})||[]},only:function(r){if(!W4(r))throw Error("React.Children.only expected to receive a single React element child.");return r}},je.Component=ku,je.Fragment=nq,je.Profiler=sq,je.PureComponent=j4,je.StrictMode=iq,je.Suspense=lq,je.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=yq,je.act=YA,je.cloneElement=function(r,e,t){if(r==null)throw Error("React.cloneElement(...): The argument must be a React element, but you passed "+r+".");var n=VA({},r.props),i=r.key,s=r.ref,o=r._owner;if(e!=null){if(e.ref!==void 0&&(s=e.ref,o=q4.current),e.key!==void 0&&(i=""+e.key),r.type&&r.type.defaultProps)var a=r.type.defaultProps;for(c in e)qA.call(e,c)&&!WA.hasOwnProperty(c)&&(n[c]=e[c]===void 0&&a!==void 0?a[c]:e[c])}var c=arguments.length-2;if(c===1)n.children=t;else if(1<c){a=Array(c);for(var l=0;l<c;l++)a[l]=arguments[l+2];n.children=a}return{$$typeof:ef,type:r.type,key:i,ref:s,props:n,_owner:o}},je.createContext=function(r){return r={$$typeof:aq,_currentValue:r,_currentValue2:r,_threadCount:0,Provider:null,Consumer:null,_defaultValue:null,_globalName:null},r.Provider={$$typeof:oq,_context:r},r.Consumer=r},je.createElement=GA,je.createFactory=function(r){var e=GA.bind(null,r);return e.type=r,e},je.createRef=function(){return{current:null}},je.forwardRef=function(r){return{$$typeof:cq,render:r}},je.isValidElement=W4,je.lazy=function(r){return{$$typeof:dq,_payload:{_status:-1,_result:r},_init:gq}},je.memo=function(r,e){return{$$typeof:uq,type:r,compare:e===void 0?null:e}},je.startTransition=function(r){var e=E0.transition;E0.transition={};try{r()}finally{E0.transition=e}},je.unstable_act=YA,je.useCallback=function(r,e){return rn.current.useCallback(r,e)},je.useContext=function(r){return rn.current.useContext(r)},je.useDebugValue=function(){},je.useDeferredValue=function(r){return rn.current.useDeferredValue(r)},je.useEffect=function(r,e){return rn.current.useEffect(r,e)},je.useId=function(){return rn.current.useId()},je.useImperativeHandle=function(r,e,t){return rn.current.useImperativeHandle(r,e,t)},je.useInsertionEffect=function(r,e){return rn.current.useInsertionEffect(r,e)},je.useLayoutEffect=function(r,e){return rn.current.useLayoutEffect(r,e)},je.useMemo=function(r,e){return rn.current.useMemo(r,e)},je.useReducer=function(r,e,t){return rn.current.useReducer(r,e,t)},je.useRef=function(r){return rn.current.useRef(r)},je.useState=function(r){return rn.current.useState(r)},je.useSyncExternalStore=function(r,e,t){return rn.current.useSyncExternalStore(r,e,t)},je.useTransition=function(){return rn.current.useTransition()},je.version="18.3.1",w0.exports=je;var ct=w0.exports;/**
* @license React
* react-jsx-runtime.production.min.js
*
* Copyright (c) Facebook, Inc. and its affiliates.
*
* This source code is licensed under the MIT license found in the
* LICENSE file in the root directory of this source tree.
*/var mq=ct,wq=Symbol.for("react.element"),bq=Symbol.for("react.fragment"),vq=Object.prototype.hasOwnProperty,Eq=mq.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,Sq={key:!0,ref:!0,__self:!0,__source:!0};function JA(r,e,t){var n,i={},s=null,o=null;t!==void 0&&(s=""+t),e.key!==void 0&&(s=""+e.key),e.ref!==void 0&&(o=e.ref);for(n in e)vq.call(e,n)&&!Sq.hasOwnProperty(n)&&(i[n]=e[n]);if(r&&r.defaultProps)for(n in e=r.defaultProps,e)i[n]===void 0&&(i[n]=e[n]);return{$$typeof:wq,type:r,key:s,ref:o,props:i,_owner:Eq.current}}eo.Fragment=bq,eo.jsx=JA,eo.jsxs=JA,Kt.exports=eo;var Ue=Kt.exports,XA={exports:{}},Vn={},ZA={exports:{}},eC={};/**
* @license React
* scheduler.production.min.js
*
* Copyright (c) Facebook, Inc. and its affiliates.
*
* This source code is licensed under the MIT license found in the
* LICENSE file in the root directory of this source tree.
*/(function(r){function e(O,U){var W=O.length;O.push(U);e:for(;0<W;){var Y=W-1>>>1,H=O[Y];if(0<i(H,U))O[Y]=U,O[W]=H,W=Y;else break e}}function t(O){return O.length===0?null:O[0]}function n(O){if(O.length===0)return null;var U=O[0],W=O.pop();if(W!==U){O[0]=W;e:for(var Y=0,H=O.length,oe=H>>>1;Y<oe;){var ye=2*(Y+1)-1,de=O[ye],le=ye+1,$e=O[le];if(0>i(de,W))le<H&&0>i($e,de)?(O[Y]=$e,O[le]=W,Y=le):(O[Y]=de,O[ye]=W,Y=ye);else if(le<H&&0>i($e,W))O[Y]=$e,O[le]=W,Y=le;else break e}}return U}function i(O,U){var W=O.sortIndex-U.sortIndex;return W!==0?W:O.id-U.id}if(typeof performance=="object"&&typeof performance.now=="function"){var s=performance;r.unstable_now=function(){return s.now()}}else{var o=Date,a=o.now();r.unstable_now=function(){return o.now()-a}}var c=[],l=[],d=1,h=null,p=3,m=!1,f=!1,g=!1,w=typeof setTimeout=="function"?setTimeout:null,y=typeof clearTimeout=="function"?clearTimeout:null,b=typeof setImmediate<"u"?setImmediate:null;typeof navigator<"u"&&navigator.scheduling!==void 0&&navigator.scheduling.isInputPending!==void 0&&navigator.scheduling.isInputPending.bind(navigator.scheduling);function v(O){for(var U=t(l);U!==null;){if(U.callback===null)n(l);else if(U.startTime<=O)n(l),U.sortIndex=U.expirationTime,e(c,U);else break;U=t(l)}}function E(O){if(g=!1,v(O),!f)if(t(c)!==null)f=!0,Q(C);else{var U=t(l);U!==null&&j(E,U.startTime-O)}}function C(O,U){f=!1,g&&(g=!1,y(I),I=-1),m=!0;var W=p;try{for(v(U),h=t(c);h!==null&&(!(h.expirationTime>U)||O&&!z());){var Y=h.callback;if(typeof Y=="function"){h.callback=null,p=h.priorityLevel;var H=Y(h.expirationTime<=U);U=r.unstable_now(),typeof H=="function"?h.callback=H:h===t(c)&&n(c),v(U)}else n(c);h=t(c)}if(h!==null)var oe=!0;else{var ye=t(l);ye!==null&&j(E,ye.startTime-U),oe=!1}return oe}finally{h=null,p=W,m=!1}}var k=!1,x=null,I=-1,T=5,L=-1;function z(){return!(r.unstable_now()-L<T)}function B(){if(x!==null){var O=r.unstable_now();L=O;var U=!0;try{U=x(!0,O)}finally{U?G():(k=!1,x=null)}}else k=!1}var G;if(typeof b=="function")G=function(){b(B)};else if(typeof MessageChannel<"u"){var K=new MessageChannel,q=K.port2;K.port1.onmessage=B,G=function(){q.postMessage(null)}}else G=function(){w(B,0)};function Q(O){x=O,k||(k=!0,G())}function j(O,U){I=w(function(){O(r.unstable_now())},U)}r.unstable_IdlePriority=5,r.unstable_ImmediatePriority=1,r.unstable_LowPriority=4,r.unstable_NormalPriority=3,r.unstable_Profiling=null,r.unstable_UserBlockingPriority=2,r.unstable_cancelCallback=function(O){O.callback=null},r.unstable_continueExecution=function(){f||m||(f=!0,Q(C))},r.unstable_forceFrameRate=function(O){0>O||125<O?console.error("forceFrameRate takes a positive int between 0 and 125, forcing frame rates higher than 125 fps is not supported"):T=0<O?Math.floor(1e3/O):5},r.unstable_getCurrentPriorityLevel=function(){return p},r.unstable_getFirstCallbackNode=function(){return t(c)},r.unstable_next=function(O){switch(p){case 1:case 2:case 3:var U=3;break;default:U=p}var W=p;p=U;try{return O()}finally{p=W}},r.unstable_pauseExecution=function(){},r.unstable_requestPaint=function(){},r.unstable_runWithPriority=function(O,U){switch(O){case 1:case 2:case 3:case 4:case 5:break;default:O=3}var W=p;p=O;try{return U()}finally{p=W}},r.unstable_scheduleCallback=function(O,U,W){var Y=r.unstable_now();switch(typeof W=="object"&&W!==null?(W=W.delay,W=typeof W=="number"&&0<W?Y+W:Y):W=Y,O){case 1:var H=-1;break;case 2:H=250;break;case 5:H=1073741823;break;case 4:H=1e4;break;default:H=5e3}return H=W+H,O={id:d++,callback:U,priorityLevel:O,startTime:W,expirationTime:H,sortIndex:-1},W>Y?(O.sortIndex=W,e(l,O),t(c)===null&&O===t(l)&&(g?(y(I),I=-1):g=!0,j(E,W-Y))):(O.sortIndex=H,e(c,O),f||m||(f=!0,Q(C))),O},r.unstable_shouldYield=z,r.unstable_wrapCallback=function(O){var U=p;return function(){var W=p;p=U;try{return O.apply(this,arguments)}finally{p=W}}}})(eC),ZA.exports=eC;var xq=ZA.exports;/**
* @license React
* react-dom.production.min.js
*
* Copyright (c) Facebook, Inc. and its affiliates.
*
* This source code is licensed under the MIT license found in the
* LICENSE file in the root directory of this source tree.
*/var Aq=ct,Kn=xq;function ee(r){for(var e="https://reactjs.org/docs/error-decoder.html?invariant="+r,t=1;t<arguments.length;t++)e+="&args[]="+encodeURIComponent(arguments[t]);return"Minified React error #"+r+"; visit "+e+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}var tC=new Set,tf={};function jc(r,e){_u(r,e),_u(r+"Capture",e)}function _u(r,e){for(tf[r]=e,r=0;r<e.length;r++)tC.add(e[r])}var to=!(typeof window>"u"||typeof window.document>"u"||typeof window.document.createElement>"u"),Q4=Object.prototype.hasOwnProperty,Cq=/^[:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD][:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\-.0-9\u00B7\u0300-\u036F\u203F-\u2040]*$/,rC={},nC={};function Iq(r){return Q4.call(nC,r)?!0:Q4.call(rC,r)?!1:Cq.test(r)?nC[r]=!0:(rC[r]=!0,!1)}function kq(r,e,t,n){if(t!==null&&t.type===0)return!1;switch(typeof e){case"function":case"symbol":return!0;case"boolean":return n?!1:t!==null?!t.acceptsBooleans:(r=r.toLowerCase().slice(0,5),r!=="data-"&&r!=="aria-");default:return!1}}function _q(r,e,t,n){if(e===null||typeof e>"u"||kq(r,e,t,n))return!0;if(n)return!1;if(t!==null)switch(t.type){case 3:return!e;case 4:return e===!1;case 5:return isNaN(e);case 6:return isNaN(e)||1>e}return!1}function nn(r,e,t,n,i,s,o){this.acceptsBooleans=e===2||e===3||e===4,this.attributeName=n,this.attributeNamespace=i,this.mustUseProperty=t,this.propertyName=r,this.type=e,this.sanitizeURL=s,this.removeEmptyString=o}var yr={};"children dangerouslySetInnerHTML defaultValue defaultChecked innerHTML suppressContentEditableWarning suppressHydrationWarning style".split(" ").forEach(function(r){yr[r]=new nn(r,0,!1,r,null,!1,!1)}),[["acceptCharset","accept-charset"],["className","class"],["htmlFor","for"],["httpEquiv","http-equiv"]].forEach(function(r){var e=r[0];yr[e]=new nn(e,1,!1,r[1],null,!1,!1)}),["contentEditable","draggable","spellCheck","value"].forEach(function(r){yr[r]=new nn(r,2,!1,r.toLowerCase(),null,!1,!1)}),["autoReverse","externalResourcesRequired","focusable","preserveAlpha"].forEach(function(r){yr[r]=new nn(r,2,!1,r,null,!1,!1)}),"allowFullScreen async autoFocus autoPlay controls default defer disabled disablePictureInPicture disableRemotePlayback formNoValidate hidden loop noModule noValidate open playsInline readOnly required reversed scoped seamless itemScope".split(" ").forEach(function(r){yr[r]=new nn(r,3,!1,r.toLowerCase(),null,!1,!1)}),["checked","multiple","muted","selected"].forEach(function(r){yr[r]=new nn(r,3,!0,r,null,!1,!1)}),["capture","download"].forEach(function(r){yr[r]=new nn(r,4,!1,r,null,!1,!1)}),["cols","rows","size","span"].forEach(function(r){yr[r]=new nn(r,6,!1,r,null,!1,!1)}),["rowSpan","start"].forEach(function(r){yr[r]=new nn(r,5,!1,r.toLowerCase(),null,!1,!1)});var Y4=/[\-:]([a-z])/g;function J4(r){return r[1].toUpperCase()}"accent-height alignment-baseline arabic-form baseline-shift cap-height clip-path clip-rule color-interpolation color-interpolation-filters color-profile color-rendering dominant-baseline enable-background fill-opacity fill-rule flood-color flood-opacity font-family font-size font-size-adjust font-stretch font-style font-variant font-weight glyph-name glyph-orientation-horizontal glyph-orientation-vertical horiz-adv-x horiz-origin-x image-rendering letter-spacing lighting-color marker-end marker-mid marker-start overline-position overline-thickness paint-order panose-1 pointer-events rendering-intent shape-rendering stop-color stop-opacity strikethrough-position strikethrough-thickness stroke-dasharray stroke-dashoffset stroke-linecap stroke-linejoin stroke-miterlimit stroke-opacity stroke-width text-anchor text-decoration text-rendering underline-position underline-thickness unicode-bidi unicode-range units-per-em v-alphabetic v-hanging v-ideographic v-mathematical vector-effect vert-adv-y vert-origin-x vert-origin-y word-spacing writing-mode xmlns:xlink x-height".split(" ").forEach(function(r){var e=r.replace(Y4,J4);yr[e]=new nn(e,1,!1,r,null,!1,!1)}),"xlink:actuate xlink:arcrole xlink:role xlink:show xlink:title xlink:type".split(" ").forEach(function(r){var e=r.replace(Y4,J4);yr[e]=new nn(e,1,!1,r,"http://www.w3.org/1999/xlink",!1,!1)}),["xml:base","xml:lang","xml:space"].forEach(function(r){var e=r.replace(Y4,J4);yr[e]=new nn(e,1,!1,r,"http://www.w3.org/XML/1998/namespace",!1,!1)}),["tabIndex","crossOrigin"].forEach(function(r){yr[r]=new nn(r,1,!1,r.toLowerCase(),null,!1,!1)}),yr.xlinkHref=new nn("xlinkHref",1,!1,"xlink:href","http://www.w3.org/1999/xlink",!0,!1),["src","href","action","formAction"].forEach(function(r){yr[r]=new nn(r,1,!1,r.toLowerCase(),null,!0,!0)});function X4(r,e,t,n){var i=yr.hasOwnProperty(e)?yr[e]:null;(i!==null?i.type!==0:n||!(2<e.length)||e[0]!=="o"&&e[0]!=="O"||e[1]!=="n"&&e[1]!=="N")&&(_q(e,t,i,n)&&(t=null),n||i===null?Iq(e)&&(t===null?r.removeAttribute(e):r.setAttribute(e,""+t)):i.mustUseProperty?r[i.propertyName]=t===null?i.type===3?!1:"":t:(e=i.attributeName,n=i.attributeNamespace,t===null?r.removeAttribute(e):(i=i.type,t=i===3||i===4&&t===!0?"":""+t,n?r.setAttributeNS(n,e,t):r.setAttribute(e,t))))}var ro=Aq.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED,S0=Symbol.for("react.element"),Tu=Symbol.for("react.portal"),Pu=Symbol.for("react.fragment"),Z4=Symbol.for("react.strict_mode"),e8=Symbol.for("react.profiler"),iC=Symbol.for("react.provider"),sC=Symbol.for("react.context"),t8=Symbol.for("react.forward_ref"),r8=Symbol.for("react.suspense"),n8=Symbol.for("react.suspense_list"),i8=Symbol.for("react.memo"),la=Symbol.for("react.lazy"),oC=Symbol.for("react.offscreen"),aC=Symbol.iterator;function rf(r){return r===null||typeof r!="object"?null:(r=aC&&r[aC]||r["@@iterator"],typeof r=="function"?r:null)}var Rt=Object.assign,s8;function nf(r){if(s8===void 0)try{throw Error()}catch(t){var e=t.stack.trim().match(/\n( *(at )?)/);s8=e&&e[1]||""}return`
`+s8+r}var o8=!1;function a8(r,e){if(!r||o8)return"";o8=!0;var t=Error.prepareStackTrace;Error.prepareStackTrace=void 0;try{if(e)if(e=function(){throw Error()},Object.defineProperty(e.prototype,"props",{set:function(){throw Error()}}),typeof Reflect=="object"&&Reflect.construct){try{Reflect.construct(e,[])}catch(l){var n=l}Reflect.construct(r,[],e)}else{try{e.call()}catch(l){n=l}r.call(e.prototype)}else{try{throw Error()}catch(l){n=l}r()}}catch(l){if(l&&n&&typeof l.stack=="string"){for(var i=l.stack.split(`
`),s=n.stack.split(`
`),o=i.length-1,a=s.length-1;1<=o&&0<=a&&i[o]!==s[a];)a--;for(;1<=o&&0<=a;o--,a--)if(i[o]!==s[a]){if(o!==1||a!==1)do if(o--,a--,0>a||i[o]!==s[a]){var c=`
`+i[o].replace(" at new "," at ");return r.displayName&&c.includes("<anonymous>")&&(c=c.replace("<anonymous>",r.displayName)),c}while(1<=o&&0<=a);break}}}finally{o8=!1,Error.prepareStackTrace=t}return(r=r?r.displayName||r.name:"")?nf(r):""}function Tq(r){switch(r.tag){case 5:return nf(r.type);case 16:return nf("Lazy");case 13:return nf("Suspense");case 19:return nf("SuspenseList");case 0:case 2:case 15:return r=a8(r.type,!1),r;case 11:return r=a8(r.type.render,!1),r;case 1:return r=a8(r.type,!0),r;default:return""}}function c8(r){if(r==null)return null;if(typeof r=="function")return r.displayName||r.name||null;if(typeof r=="string")return r;switch(r){case Pu:return"Fragment";case Tu:return"Portal";case e8:return"Profiler";case Z4:return"StrictMode";case r8:return"Suspense";case n8:return"SuspenseList"}if(typeof r=="object")switch(r.$$typeof){case sC:return(r.displayName||"Context")+".Consumer";case iC:return(r._context.displayName||"Context")+".Provider";case t8:var e=r.render;return r=r.displayName,r||(r=e.displayName||e.name||"",r=r!==""?"ForwardRef("+r+")":"ForwardRef"),r;case i8:return e=r.displayName||null,e!==null?e:c8(r.type)||"Memo";case la:e=r._payload,r=r._init;try{return c8(r(e))}catch{}}return null}function Pq(r){var e=r.type;switch(r.tag){case 24:return"Cache";case 9:return(e.displayName||"Context")+".Consumer";case 10:return(e._context.displayName||"Context")+".Provider";case 18:return"DehydratedFragment";case 11:return r=e.render,r=r.displayName||r.name||"",e.displayName||(r!==""?"ForwardRef("+r+")":"ForwardRef");case 7:return"Fragment";case 5:return e;case 4:return"Portal";case 3:return"Root";case 6:return"Text";case 16:return c8(e);case 8:return e===Z4?"StrictMode":"Mode";case 22:return"Offscreen";case 12:return"Profiler";case 21:return"Scope";case 13:return"Suspense";case 19:return"SuspenseList";case 25:return"TracingMarker";case 1:case 0:case 17:case 2:case 14:case 15:if(typeof e=="function")return e.displayName||e.name||null;if(typeof e=="string")return e}return null}function ua(r){switch(typeof r){case"boolean":case"number":case"string":case"undefined":return r;case"object":return r;default:return""}}function cC(r){var e=r.type;return(r=r.nodeName)&&r.toLowerCase()==="input"&&(e==="checkbox"||e==="radio")}function Dq(r){var e=cC(r)?"checked":"value",t=Object.getOwnPropertyDescriptor(r.constructor.prototype,e),n=""+r[e];if(!r.hasOwnProperty(e)&&typeof t<"u"&&typeof t.get=="function"&&typeof t.set=="function"){var i=t.get,s=t.set;return Object.defineProperty(r,e,{configurable:!0,get:function(){return i.call(this)},set:function(o){n=""+o,s.call(this,o)}}),Object.defineProperty(r,e,{enumerable:t.enumerable}),{getValue:function(){return n},setValue:function(o){n=""+o},stopTracking:function(){r._valueTracker=null,delete r[e]}}}}function x0(r){r._valueTracker||(r._valueTracker=Dq(r))}function lC(r){if(!r)return!1;var e=r._valueTracker;if(!e)return!0;var t=e.getValue(),n="";return r&&(n=cC(r)?r.checked?"true":"false":r.value),r=n,r!==t?(e.setValue(r),!0):!1}function A0(r){if(r=r||(typeof document<"u"?document:void 0),typeof r>"u")return null;try{return r.activeElement||r.body}catch{return r.body}}function l8(r,e){var t=e.checked;return Rt({},e,{defaultChecked:void 0,defaultValue:void 0,value:void 0,checked:t??r._wrapperState.initialChecked})}function uC(r,e){var t=e.defaultValue==null?"":e.defaultValue,n=e.checked!=null?e.checked:e.defaultChecked;t=ua(e.value!=null?e.value:t),r._wrapperState={initialChecked:n,initialValue:t,controlled:e.type==="checkbox"||e.type==="radio"?e.checked!=null:e.value!=null}}function dC(r,e){e=e.checked,e!=null&&X4(r,"checked",e,!1)}function u8(r,e){dC(r,e);var t=ua(e.value),n=e.type;if(t!=null)n==="number"?(t===0&&r.value===""||r.value!=t)&&(r.value=""+t):r.value!==""+t&&(r.value=""+t);else if(n==="submit"||n==="reset"){r.removeAttribute("value");return}e.hasOwnProperty("value")?d8(r,e.type,t):e.hasOwnProperty("defaultValue")&&d8(r,e.type,ua(e.defaultValue)),e.checked==null&&e.defaultChecked!=null&&(r.defaultChecked=!!e.defaultChecked)}function hC(r,e,t){if(e.hasOwnProperty("value")||e.hasOwnProperty("defaultValue")){var n=e.type;if(!(n!=="submit"&&n!=="reset"||e.value!==void 0&&e.value!==null))return;e=""+r._wrapperState.initialValue,t||e===r.value||(r.value=e),r.defaultValue=e}t=r.name,t!==""&&(r.name=""),r.defaultChecked=!!r._wrapperState.initialChecked,t!==""&&(r.name=t)}function d8(r,e,t){(e!=="number"||A0(r.ownerDocument)!==r)&&(t==null?r.defaultValue=""+r._wrapperState.initialValue:r.defaultValue!==""+t&&(r.defaultValue=""+t))}var sf=Array.isArray;function Du(r,e,t,n){if(r=r.options,e){e={};for(var i=0;i<t.length;i++)e["$"+t[i]]=!0;for(t=0;t<r.length;t++)i=e.hasOwnProperty("$"+r[t].value),r[t].selected!==i&&(r[t].selected=i),i&&n&&(r[t].defaultSelected=!0)}else{for(t=""+ua(t),e=null,i=0;i<r.length;i++){if(r[i].value===t){r[i].selected=!0,n&&(r[i].defaultSelected=!0);return}e!==null||r[i].disabled||(e=r[i])}e!==null&&(e.selected=!0)}}function h8(r,e){if(e.dangerouslySetInnerHTML!=null)throw Error(ee(91));return Rt({},e,{value:void 0,defaultValue:void 0,children:""+r._wrapperState.initialValue})}function fC(r,e){var t=e.value;if(t==null){if(t=e.children,e=e.defaultValue,t!=null){if(e!=null)throw Error(ee(92));if(sf(t)){if(1<t.length)throw Error(ee(93));t=t[0]}e=t}e==null&&(e=""),t=e}r._wrapperState={initialValue:ua(t)}}function pC(r,e){var t=ua(e.value),n=ua(e.defaultValue);t!=null&&(t=""+t,t!==r.value&&(r.value=t),e.defaultValue==null&&r.defaultValue!==t&&(r.defaultValue=t)),n!=null&&(r.defaultValue=""+n)}function gC(r){var e=r.textContent;e===r._wrapperState.initialValue&&e!==""&&e!==null&&(r.value=e)}function yC(r){switch(r){case"svg":return"http://www.w3.org/2000/svg";case"math":return"http://www.w3.org/1998/Math/MathML";default:return"http://www.w3.org/1999/xhtml"}}function f8(r,e){return r==null||r==="http://www.w3.org/1999/xhtml"?yC(e):r==="http://www.w3.org/2000/svg"&&e==="foreignObject"?"http://www.w3.org/1999/xhtml":r}var C0,mC=function(r){return typeof MSApp<"u"&&MSApp.execUnsafeLocalFunction?function(e,t,n,i){MSApp.execUnsafeLocalFunction(function(){return r(e,t,n,i)})}:r}(function(r,e){if(r.namespaceURI!=="http://www.w3.org/2000/svg"||"innerHTML"in r)r.innerHTML=e;else{for(C0=C0||document.createElement("div"),C0.innerHTML="<svg>"+e.valueOf().toString()+"</svg>",e=C0.firstChild;r.firstChild;)r.removeChild(r.firstChild);for(;e.firstChild;)r.appendChild(e.firstChild)}});function of(r,e){if(e){var t=r.firstChild;if(t&&t===r.lastChild&&t.nodeType===3){t.nodeValue=e;return}}r.textContent=e}var af={animationIterationCount:!0,aspectRatio:!0,borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,columns:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridArea:!0,gridRow:!0,gridRowEnd:!0,gridRowSpan:!0,gridRowStart:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnSpan:!0,gridColumnStart:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},$q=["Webkit","ms","Moz","O"];Object.keys(af).forEach(function(r){$q.forEach(function(e){e=e+r.charAt(0).toUpperCase()+r.substring(1),af[e]=af[r]})});function wC(r,e,t){return e==null||typeof e=="boolean"||e===""?"":t||typeof e!="number"||e===0||af.hasOwnProperty(r)&&af[r]?(""+e).trim():e+"px"}function bC(r,e){r=r.style;for(var t in e)if(e.hasOwnProperty(t)){var n=t.indexOf("--")===0,i=wC(t,e[t],n);t==="float"&&(t="cssFloat"),n?r.setProperty(t,i):r[t]=i}}var Nq=Rt({menuitem:!0},{area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0});function p8(r,e){if(e){if(Nq[r]&&(e.children!=null||e.dangerouslySetInnerHTML!=null))throw Error(ee(137,r));if(e.dangerouslySetInnerHTML!=null){if(e.children!=null)throw Error(ee(60));if(typeof e.dangerouslySetInnerHTML!="object"||!("__html"in e.dangerouslySetInnerHTML))throw Error(ee(61))}if(e.style!=null&&typeof e.style!="object")throw Error(ee(62))}}function g8(r,e){if(r.indexOf("-")===-1)return typeof e.is=="string";switch(r){case"annotation-xml":case"color-profile":case"font-face":case"font-face-src":case"font-face-uri":case"font-face-format":case"font-face-name":case"missing-glyph":return!1;default:return!0}}var y8=null;function m8(r){return r=r.target||r.srcElement||window,r.correspondingUseElement&&(r=r.correspondingUseElement),r.nodeType===3?r.parentNode:r}var w8=null,$u=null,Nu=null;function vC(r){if(r=Tf(r)){if(typeof w8!="function")throw Error(ee(280));var e=r.stateNode;e&&(e=G0(e),w8(r.stateNode,r.type,e))}}function EC(r){$u?Nu?Nu.push(r):Nu=[r]:$u=r}function SC(){if($u){var r=$u,e=Nu;if(Nu=$u=null,vC(r),e)for(r=0;r<e.length;r++)vC(e[r])}}function xC(r,e){return r(e)}function AC(){}var b8=!1;function CC(r,e,t){if(b8)return r(e,t);b8=!0;try{return xC(r,e,t)}finally{b8=!1,($u!==null||Nu!==null)&&(AC(),SC())}}function cf(r,e){var t=r.stateNode;if(t===null)return null;var n=G0(t);if(n===null)return null;t=n[e];e:switch(e){case"onClick":case"onClickCapture":case"onDoubleClick":case"onDoubleClickCapture":case"onMouseDown":case"onMouseDownCapture":case"onMouseMove":case"onMouseMoveCapture":case"onMouseUp":case"onMouseUpCapture":case"onMouseEnter":(n=!n.disabled)||(r=r.type,n=!(r==="button"||r==="input"||r==="select"||r==="textarea")),r=!n;break e;default:r=!1}if(r)return null;if(t&&typeof t!="function")throw Error(ee(231,e,typeof t));return t}var v8=!1;if(to)try{var lf={};Object.defineProperty(lf,"passive",{get:function(){v8=!0}}),window.addEventListener("test",lf,lf),window.removeEventListener("test",lf,lf)}catch{v8=!1}function Mq(r,e,t,n,i,s,o,a,c){var l=Array.prototype.slice.call(arguments,3);try{e.apply(t,l)}catch(d){this.onError(d)}}var uf=!1,I0=null,k0=!1,E8=null,Oq={onError:function(r){uf=!0,I0=r}};function Rq(r,e,t,n,i,s,o,a,c){uf=!1,I0=null,Mq.apply(Oq,arguments)}function Lq(r,e,t,n,i,s,o,a,c){if(Rq.apply(this,arguments),uf){if(uf){var l=I0;uf=!1,I0=null}else throw Error(ee(198));k0||(k0=!0,E8=l)}}function Hc(r){var e=r,t=r;if(r.alternate)for(;e.return;)e=e.return;else{r=e;do e=r,e.flags&4098&&(t=e.return),r=e.return;while(r)}return e.tag===3?t:null}function IC(r){if(r.tag===13){var e=r.memoizedState;if(e===null&&(r=r.alternate,r!==null&&(e=r.memoizedState)),e!==null)return e.dehydrated}return null}function kC(r){if(Hc(r)!==r)throw Error(ee(188))}function Bq(r){var e=r.alternate;if(!e){if(e=Hc(r),e===null)throw Error(ee(188));return e!==r?null:r}for(var t=r,n=e;;){var i=t.return;if(i===null)break;var s=i.alternate;if(s===null){if(n=i.return,n!==null){t=n;continue}break}if(i.child===s.child){for(s=i.child;s;){if(s===t)return kC(i),r;if(s===n)return kC(i),e;s=s.sibling}throw Error(ee(188))}if(t.return!==n.return)t=i,n=s;else{for(var o=!1,a=i.child;a;){if(a===t){o=!0,t=i,n=s;break}if(a===n){o=!0,n=i,t=s;break}a=a.sibling}if(!o){for(a=s.child;a;){if(a===t){o=!0,t=s,n=i;break}if(a===n){o=!0,n=s,t=i;break}a=a.sibling}if(!o)throw Error(ee(189))}}if(t.alternate!==n)throw Error(ee(190))}if(t.tag!==3)throw Error(ee(188));return t.stateNode.current===t?r:e}function _C(r){return r=Bq(r),r!==null?TC(r):null}function TC(r){if(r.tag===5||r.tag===6)return r;for(r=r.child;r!==null;){var e=TC(r);if(e!==null)return e;r=r.sibling}return null}var PC=Kn.unstable_scheduleCallback,DC=Kn.unstable_cancelCallback,Uq=Kn.unstable_shouldYield,Fq=Kn.unstable_requestPaint,Wt=Kn.unstable_now,zq=Kn.unstable_getCurrentPriorityLevel,S8=Kn.unstable_ImmediatePriority,$C=Kn.unstable_UserBlockingPriority,_0=Kn.unstable_NormalPriority,Vq=Kn.unstable_LowPriority,NC=Kn.unstable_IdlePriority,T0=null,bs=null;function Kq(r){if(bs&&typeof bs.onCommitFiberRoot=="function")try{bs.onCommitFiberRoot(T0,r,void 0,(r.current.flags&128)===128)}catch{}}var Ki=Math.clz32?Math.clz32:qq,jq=Math.log,Hq=Math.LN2;function qq(r){return r>>>=0,r===0?32:31-(jq(r)/Hq|0)|0}var P0=64,D0=4194304;function df(r){switch(r&-r){case 1:return 1;case 2:return 2;case 4:return 4;case 8:return 8;case 16:return 16;case 32:return 32;case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return r&4194240;case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:return r&130023424;case 134217728:return 134217728;case 268435456:return 268435456;case 536870912:return 536870912;case 1073741824:return 1073741824;default:return r}}function $0(r,e){var t=r.pendingLanes;if(t===0)return 0;var n=0,i=r.suspendedLanes,s=r.pingedLanes,o=t&268435455;if(o!==0){var a=o&~i;a!==0?n=df(a):(s&=o,s!==0&&(n=df(s)))}else o=t&~i,o!==0?n=df(o):s!==0&&(n=df(s));if(n===0)return 0;if(e!==0&&e!==n&&!(e&i)&&(i=n&-n,s=e&-e,i>=s||i===16&&(s&4194240)!==0))return e;if(n&4&&(n|=t&16),e=r.entangledLanes,e!==0)for(r=r.entanglements,e&=n;0<e;)t=31-Ki(e),i=1<<t,n|=r[t],e&=~i;return n}function Wq(r,e){switch(r){case 1:case 2:case 4:return e+250;case 8:case 16:case 32:case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return e+5e3;case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:return-1;case 134217728:case 268435456:case 536870912:case 1073741824:return-1;default:return-1}}function Gq(r,e){for(var t=r.suspendedLanes,n=r.pingedLanes,i=r.expirationTimes,s=r.pendingLanes;0<s;){var o=31-Ki(s),a=1<<o,c=i[o];c===-1?(!(a&t)||a&n)&&(i[o]=Wq(a,e)):c<=e&&(r.expiredLanes|=a),s&=~a}}function x8(r){return r=r.pendingLanes&-1073741825,r!==0?r:r&1073741824?1073741824:0}function MC(){var r=P0;return P0<<=1,!(P0&4194240)&&(P0=64),r}function A8(r){for(var e=[],t=0;31>t;t++)e.push(r);return e}function hf(r,e,t){r.pendingLanes|=e,e!==536870912&&(r.suspendedLanes=0,r.pingedLanes=0),r=r.eventTimes,e=31-Ki(e),r[e]=t}function Qq(r,e){var t=r.pendingLanes&~e;r.pendingLanes=e,r.suspendedLanes=0,r.pingedLanes=0,r.expiredLanes&=e,r.mutableReadLanes&=e,r.entangledLanes&=e,e=r.entanglements;var n=r.eventTimes;for(r=r.expirationTimes;0<t;){var i=31-Ki(t),s=1<<i;e[i]=0,n[i]=-1,r[i]=-1,t&=~s}}function C8(r,e){var t=r.entangledLanes|=e;for(r=r.entanglements;t;){var n=31-Ki(t),i=1<<n;i&e|r[n]&e&&(r[n]|=e),t&=~i}}var ht=0;function OC(r){return r&=-r,1<r?4<r?r&268435455?16:536870912:4:1}var RC,I8,LC,BC,UC,k8=!1,N0=[],da=null,ha=null,fa=null,ff=new Map,pf=new Map,pa=[],Yq="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput copy cut paste click change contextmenu reset submit".split(" ");function FC(r,e){switch(r){case"focusin":case"focusout":da=null;break;case"dragenter":case"dragleave":ha=null;break;case"mouseover":case"mouseout":fa=null;break;case"pointerover":case"pointerout":ff.delete(e.pointerId);break;case"gotpointercapture":case"lostpointercapture":pf.delete(e.pointerId)}}function gf(r,e,t,n,i,s){return r===null||r.nativeEvent!==s?(r={blockedOn:e,domEventName:t,eventSystemFlags:n,nativeEvent:s,targetContainers:[i]},e!==null&&(e=Tf(e),e!==null&&I8(e)),r):(r.eventSystemFlags|=n,e=r.targetContainers,i!==null&&e.indexOf(i)===-1&&e.push(i),r)}function Jq(r,e,t,n,i){switch(e){case"focusin":return da=gf(da,r,e,t,n,i),!0;case"dragenter":return ha=gf(ha,r,e,t,n,i),!0;case"mouseover":return fa=gf(fa,r,e,t,n,i),!0;case"pointerover":var s=i.pointerId;return ff.set(s,gf(ff.get(s)||null,r,e,t,n,i)),!0;case"gotpointercapture":return s=i.pointerId,pf.set(s,gf(pf.get(s)||null,r,e,t,n,i)),!0}return!1}function zC(r){var e=qc(r.target);if(e!==null){var t=Hc(e);if(t!==null){if(e=t.tag,e===13){if(e=IC(t),e!==null){r.blockedOn=e,UC(r.priority,function(){LC(t)});return}}else if(e===3&&t.stateNode.current.memoizedState.isDehydrated){r.blockedOn=t.tag===3?t.stateNode.containerInfo:null;return}}}r.blockedOn=null}function M0(r){if(r.blockedOn!==null)return!1;for(var e=r.targetContainers;0<e.length;){var t=T8(r.domEventName,r.eventSystemFlags,e[0],r.nativeEvent);if(t===null){t=r.nativeEvent;var n=new t.constructor(t.type,t);y8=n,t.target.dispatchEvent(n),y8=null}else return e=Tf(t),e!==null&&I8(e),r.blockedOn=t,!1;e.shift()}return!0}function VC(r,e,t){M0(r)&&t.delete(e)}function Xq(){k8=!1,da!==null&&M0(da)&&(da=null),ha!==null&&M0(ha)&&(ha=null),fa!==null&&M0(fa)&&(fa=null),ff.forEach(VC),pf.forEach(VC)}function yf(r,e){r.blockedOn===e&&(r.blockedOn=null,k8||(k8=!0,Kn.unstable_scheduleCallback(Kn.unstable_NormalPriority,Xq)))}function mf(r){function e(i){return yf(i,r)}if(0<N0.length){yf(N0[0],r);for(var t=1;t<N0.length;t++){var n=N0[t];n.blockedOn===r&&(n.blockedOn=null)}}for(da!==null&&yf(da,r),ha!==null&&yf(ha,r),fa!==null&&yf(fa,r),ff.forEach(e),pf.forEach(e),t=0;t<pa.length;t++)n=pa[t],n.blockedOn===r&&(n.blockedOn=null);for(;0<pa.length&&(t=pa[0],t.blockedOn===null);)zC(t),t.blockedOn===null&&pa.shift()}var Mu=ro.ReactCurrentBatchConfig,O0=!0;function Zq(r,e,t,n){var i=ht,s=Mu.transition;Mu.transition=null;try{ht=1,_8(r,e,t,n)}finally{ht=i,Mu.transition=s}}function eW(r,e,t,n){var i=ht,s=Mu.transition;Mu.transition=null;try{ht=4,_8(r,e,t,n)}finally{ht=i,Mu.transition=s}}function _8(r,e,t,n){if(O0){var i=T8(r,e,t,n);if(i===null)q8(r,e,n,R0,t),FC(r,n);else if(Jq(i,r,e,t,n))n.stopPropagation();else if(FC(r,n),e&4&&-1<Yq.indexOf(r)){for(;i!==null;){var s=Tf(i);if(s!==null&&RC(s),s=T8(r,e,t,n),s===null&&q8(r,e,n,R0,t),s===i)break;i=s}i!==null&&n.stopPropagation()}else q8(r,e,n,null,t)}}var R0=null;function T8(r,e,t,n){if(R0=null,r=m8(n),r=qc(r),r!==null)if(e=Hc(r),e===null)r=null;else if(t=e.tag,t===13){if(r=IC(e),r!==null)return r;r=null}else if(t===3){if(e.stateNode.current.memoizedState.isDehydrated)return e.tag===3?e.stateNode.containerInfo:null;r=null}else e!==r&&(r=null);return R0=r,null}function KC(r){switch(r){case"cancel":case"click":case"close":case"contextmenu":case"copy":case"cut":case"auxclick":case"dblclick":case"dragend":case"dragstart":case"drop":case"focusin":case"focusout":case"input":case"invalid":case"keydown":case"keypress":case"keyup":case"mousedown":case"mouseup":case"paste":case"pause":case"play":case"pointercancel":case"pointerdown":case"pointerup":case"ratechange":case"reset":case"resize":case"seeked":case"submit":case"touchcancel":case"touchend":case"touchstart":case"volumechange":case"change":case"selectionchange":case"textInput":case"compositionstart":case"compositionend":case"compositionupdate":case"beforeblur":case"afterblur":case"beforeinput":case"blur":case"fullscreenchange":case"focus":case"hashchange":case"popstate":case"select":case"selectstart":return 1;case"drag":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"mousemove":case"mouseout":case"mouseover":case"pointermove":case"pointerout":case"pointerover":case"scroll":case"toggle":case"touchmove":case"wheel":case"mouseenter":case"mouseleave":case"pointerenter":case"pointerleave":return 4;case"message":switch(zq()){case S8:return 1;case $C:return 4;case _0:case Vq:return 16;case NC:return 536870912;default:return 16}default:return 16}}var ga=null,P8=null,L0=null;function jC(){if(L0)return L0;var r,e=P8,t=e.length,n,i="value"in ga?ga.value:ga.textContent,s=i.length;for(r=0;r<t&&e[r]===i[r];r++);var o=t-r;for(n=1;n<=o&&e[t-n]===i[s-n];n++);return L0=i.slice(r,1<n?1-n:void 0)}function B0(r){var e=r.keyCode;return"charCode"in r?(r=r.charCode,r===0&&e===13&&(r=13)):r=e,r===10&&(r=13),32<=r||r===13?r:0}function U0(){return!0}function HC(){return!1}function jn(r){function e(t,n,i,s,o){this._reactName=t,this._targetInst=i,this.type=n,this.nativeEvent=s,this.target=o,this.currentTarget=null;for(var a in r)r.hasOwnProperty(a)&&(t=r[a],this[a]=t?t(s):s[a]);return this.isDefaultPrevented=(s.defaultPrevented!=null?s.defaultPrevented:s.returnValue===!1)?U0:HC,this.isPropagationStopped=HC,this}return Rt(e.prototype,{preventDefault:function(){this.defaultPrevented=!0;var t=this.nativeEvent;t&&(t.preventDefault?t.preventDefault():typeof t.returnValue!="unknown"&&(t.returnValue=!1),this.isDefaultPrevented=U0)},stopPropagation:function(){var t=this.nativeEvent;t&&(t.stopPropagation?t.stopPropagation():typeof t.cancelBubble!="unknown"&&(t.cancelBubble=!0),this.isPropagationStopped=U0)},persist:function(){},isPersistent:U0}),e}var Ou={eventPhase:0,bubbles:0,cancelable:0,timeStamp:function(r){return r.timeStamp||Date.now()},defaultPrevented:0,isTrusted:0},D8=jn(Ou),wf=Rt({},Ou,{view:0,detail:0}),tW=jn(wf),$8,N8,bf,F0=Rt({},wf,{screenX:0,screenY:0,clientX:0,clientY:0,pageX:0,pageY:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,getModifierState:O8,button:0,buttons:0,relatedTarget:function(r){return r.relatedTarget===void 0?r.fromElement===r.srcElement?r.toElement:r.fromElement:r.relatedTarget},movementX:function(r){return"movementX"in r?r.movementX:(r!==bf&&(bf&&r.type==="mousemove"?($8=r.screenX-bf.screenX,N8=r.screenY-bf.screenY):N8=$8=0,bf=r),$8)},movementY:function(r){return"movementY"in r?r.movementY:N8}}),qC=jn(F0),rW=Rt({},F0,{dataTransfer:0}),nW=jn(rW),iW=Rt({},wf,{relatedTarget:0}),M8=jn(iW),sW=Rt({},Ou,{animationName:0,elapsedTime:0,pseudoElement:0}),oW=jn(sW),aW=Rt({},Ou,{clipboardData:function(r){return"clipboardData"in r?r.clipboardData:window.clipboardData}}),cW=jn(aW),lW=Rt({},Ou,{data:0}),WC=jn(lW),uW={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},dW={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",224:"Meta"},hW={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"};function fW(r){var e=this.nativeEvent;return e.getModifierState?e.getModifierState(r):(r=hW[r])?!!e[r]:!1}function O8(){return fW}var pW=Rt({},wf,{key:function(r){if(r.key){var e=uW[r.key]||r.key;if(e!=="Unidentified")return e}return r.type==="keypress"?(r=B0(r),r===13?"Enter":String.fromCharCode(r)):r.type==="keydown"||r.type==="keyup"?dW[r.keyCode]||"Unidentified":""},code:0,location:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,repeat:0,locale:0,getModifierState:O8,charCode:function(r){return r.type==="keypress"?B0(r):0},keyCode:function(r){return r.type==="keydown"||r.type==="keyup"?r.keyCode:0},which:function(r){return r.type==="keypress"?B0(r):r.type==="keydown"||r.type==="keyup"?r.keyCode:0}}),gW=jn(pW),yW=Rt({},F0,{pointerId:0,width:0,height:0,pressure:0,tangentialPressure:0,tiltX:0,tiltY:0,twist:0,pointerType:0,isPrimary:0}),GC=jn(yW),mW=Rt({},wf,{touches:0,targetTouches:0,changedTouches:0,altKey:0,metaKey:0,ctrlKey:0,shiftKey:0,getModifierState:O8}),wW=jn(mW),bW=Rt({},Ou,{propertyName:0,elapsedTime:0,pseudoElement:0}),vW=jn(bW),EW=Rt({},F0,{deltaX:function(r){return"deltaX"in r?r.deltaX:"wheelDeltaX"in r?-r.wheelDeltaX:0},deltaY:function(r){return"deltaY"in r?r.deltaY:"wheelDeltaY"in r?-r.wheelDeltaY:"wheelDelta"in r?-r.wheelDelta:0},deltaZ:0,deltaMode:0}),SW=jn(EW),xW=[9,13,27,32],R8=to&&"CompositionEvent"in window,vf=null;to&&"documentMode"in document&&(vf=document.documentMode);var AW=to&&"TextEvent"in window&&!vf,QC=to&&(!R8||vf&&8<vf&&11>=vf),YC=" ",JC=!1;function XC(r,e){switch(r){case"keyup":return xW.indexOf(e.keyCode)!==-1;case"keydown":return e.keyCode!==229;case"keypress":case"mousedown":case"focusout":return!0;default:return!1}}function ZC(r){return r=r.detail,typeof r=="object"&&"data"in r?r.data:null}var Ru=!1;function CW(r,e){switch(r){case"compositionend":return ZC(e);case"keypress":return e.which!==32?null:(JC=!0,YC);case"textInput":return r=e.data,r===YC&&JC?null:r;default:return null}}function IW(r,e){if(Ru)return r==="compositionend"||!R8&&XC(r,e)?(r=jC(),L0=P8=ga=null,Ru=!1,r):null;switch(r){case"paste":return null;case"keypress":if(!(e.ctrlKey||e.altKey||e.metaKey)||e.ctrlKey&&e.altKey){if(e.char&&1<e.char.length)return e.char;if(e.which)return String.fromCharCode(e.which)}return null;case"compositionend":return QC&&e.locale!=="ko"?null:e.data;default:return null}}var kW={color:!0,date:!0,datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0};function eI(r){var e=r&&r.nodeName&&r.nodeName.toLowerCase();return e==="input"?!!kW[r.type]:e==="textarea"}function tI(r,e,t,n){EC(n),e=H0(e,"onChange"),0<e.length&&(t=new D8("onChange","change",null,t,n),r.push({event:t,listeners:e}))}var Ef=null,Sf=null;function _W(r){bI(r,0)}function z0(r){var e=zu(r);if(lC(e))return r}function TW(r,e){if(r==="change")return e}var rI=!1;if(to){var L8;if(to){var B8="oninput"in document;if(!B8){var nI=document.createElement("div");nI.setAttribute("oninput","return;"),B8=typeof nI.oninput=="function"}L8=B8}else L8=!1;rI=L8&&(!document.documentMode||9<document.documentMode)}function iI(){Ef&&(Ef.detachEvent("onpropertychange",sI),Sf=Ef=null)}function sI(r){if(r.propertyName==="value"&&z0(Sf)){var e=[];tI(e,Sf,r,m8(r)),CC(_W,e)}}function PW(r,e,t){r==="focusin"?(iI(),Ef=e,Sf=t,Ef.attachEvent("onpropertychange",sI)):r==="focusout"&&iI()}function DW(r){if(r==="selectionchange"||r==="keyup"||r==="keydown")return z0(Sf)}function $W(r,e){if(r==="click")return z0(e)}function NW(r,e){if(r==="input"||r==="change")return z0(e)}function MW(r,e){return r===e&&(r!==0||1/r===1/e)||r!==r&&e!==e}var ji=typeof Object.is=="function"?Object.is:MW;function xf(r,e){if(ji(r,e))return!0;if(typeof r!="object"||r===null||typeof e!="object"||e===null)return!1;var t=Object.keys(r),n=Object.keys(e);if(t.length!==n.length)return!1;for(n=0;n<t.length;n++){var i=t[n];if(!Q4.call(e,i)||!ji(r[i],e[i]))return!1}return!0}function oI(r){for(;r&&r.firstChild;)r=r.firstChild;return r}function aI(r,e){var t=oI(r);r=0;for(var n;t;){if(t.nodeType===3){if(n=r+t.textContent.length,r<=e&&n>=e)return{node:t,offset:e-r};r=n}e:{for(;t;){if(t.nextSibling){t=t.nextSibling;break e}t=t.parentNode}t=void 0}t=oI(t)}}function cI(r,e){return r&&e?r===e?!0:r&&r.nodeType===3?!1:e&&e.nodeType===3?cI(r,e.parentNode):"contains"in r?r.contains(e):r.compareDocumentPosition?!!(r.compareDocumentPosition(e)&16):!1:!1}function lI(){for(var r=window,e=A0();e instanceof r.HTMLIFrameElement;){try{var t=typeof e.contentWindow.location.href=="string"}catch{t=!1}if(t)r=e.contentWindow;else break;e=A0(r.document)}return e}function U8(r){var e=r&&r.nodeName&&r.nodeName.toLowerCase();return e&&(e==="input"&&(r.type==="text"||r.type==="search"||r.type==="tel"||r.type==="url"||r.type==="password")||e==="textarea"||r.contentEditable==="true")}function OW(r){var e=lI(),t=r.focusedElem,n=r.selectionRange;if(e!==t&&t&&t.ownerDocument&&cI(t.ownerDocument.documentElement,t)){if(n!==null&&U8(t)){if(e=n.start,r=n.end,r===void 0&&(r=e),"selectionStart"in t)t.selectionStart=e,t.selectionEnd=Math.min(r,t.value.length);else if(r=(e=t.ownerDocument||document)&&e.defaultView||window,r.getSelection){r=r.getSelection();var i=t.textContent.length,s=Math.min(n.start,i);n=n.end===void 0?s:Math.min(n.end,i),!r.extend&&s>n&&(i=n,n=s,s=i),i=aI(t,s);var o=aI(t,n);i&&o&&(r.rangeCount!==1||r.anchorNode!==i.node||r.anchorOffset!==i.offset||r.focusNode!==o.node||r.focusOffset!==o.offset)&&(e=e.createRange(),e.setStart(i.node,i.offset),r.removeAllRanges(),s>n?(r.addRange(e),r.extend(o.node,o.offset)):(e.setEnd(o.node,o.offset),r.addRange(e)))}}for(e=[],r=t;r=r.parentNode;)r.nodeType===1&&e.push({element:r,left:r.scrollLeft,top:r.scrollTop});for(typeof t.focus=="function"&&t.focus(),t=0;t<e.length;t++)r=e[t],r.element.scrollLeft=r.left,r.element.scrollTop=r.top}}var RW=to&&"documentMode"in document&&11>=document.documentMode,Lu=null,F8=null,Af=null,z8=!1;function uI(r,e,t){var n=t.window===t?t.document:t.nodeType===9?t:t.ownerDocument;z8||Lu==null||Lu!==A0(n)||(n=Lu,"selectionStart"in n&&U8(n)?n={start:n.selectionStart,end:n.selectionEnd}:(n=(n.ownerDocument&&n.ownerDocument.defaultView||window).getSelection(),n={anchorNode:n.anchorNode,anchorOffset:n.anchorOffset,focusNode:n.focusNode,focusOffset:n.focusOffset}),Af&&xf(Af,n)||(Af=n,n=H0(F8,"onSelect"),0<n.length&&(e=new D8("onSelect","select",null,e,t),r.push({event:e,listeners:n}),e.target=Lu)))}function V0(r,e){var t={};return t[r.toLowerCase()]=e.toLowerCase(),t["Webkit"+r]="webkit"+e,t["Moz"+r]="moz"+e,t}var Bu={animationend:V0("Animation","AnimationEnd"),animationiteration:V0("Animation","AnimationIteration"),animationstart:V0("Animation","AnimationStart"),transitionend:V0("Transition","TransitionEnd")},V8={},dI={};to&&(dI=document.createElement("div").style,"AnimationEvent"in window||(delete Bu.animationend.animation,delete Bu.animationiteration.animation,delete Bu.animationstart.animation),"TransitionEvent"in window||delete Bu.transitionend.transition);function K0(r){if(V8[r])return V8[r];if(!Bu[r])return r;var e=Bu[r],t;for(t in e)if(e.hasOwnProperty(t)&&t in dI)return V8[r]=e[t];return r}var hI=K0("animationend"),fI=K0("animationiteration"),pI=K0("animationstart"),gI=K0("transitionend"),yI=new Map,mI="abort auxClick cancel canPlay canPlayThrough click close contextMenu copy cut drag dragEnd dragEnter dragExit dragLeave dragOver dragStart drop durationChange emptied encrypted ended error gotPointerCapture input invalid keyDown keyPress keyUp load loadedData loadedMetadata loadStart lostPointerCapture mouseDown mouseMove mouseOut mouseOver mouseUp paste pause play playing pointerCancel pointerDown pointerMove pointerOut pointerOver pointerUp progress rateChange reset resize seeked seeking stalled submit suspend timeUpdate touchCancel touchEnd touchStart volumeChange scroll toggle touchMove waiting wheel".split(" ");function ya(r,e){yI.set(r,e),jc(e,[r])}for(var K8=0;K8<mI.length;K8++){var j8=mI[K8],LW=j8.toLowerCase(),BW=j8[0].toUpperCase()+j8.slice(1);ya(LW,"on"+BW)}ya(hI,"onAnimationEnd"),ya(fI,"onAnimationIteration"),ya(pI,"onAnimationStart"),ya("dblclick","onDoubleClick"),ya("focusin","onFocus"),ya("focusout","onBlur"),ya(gI,"onTransitionEnd"),_u("onMouseEnter",["mouseout","mouseover"]),_u("onMouseLeave",["mouseout","mouseover"]),_u("onPointerEnter",["pointerout","pointerover"]),_u("onPointerLeave",["pointerout","pointerover"]),jc("onChange","change click focusin focusout input keydown keyup selectionchange".split(" ")),jc("onSelect","focusout contextmenu dragend focusin keydown keyup mousedown mouseup selectionchange".split(" ")),jc("onBeforeInput",["compositionend","keypress","textInput","paste"]),jc("onCompositionEnd","compositionend focusout keydown keypress keyup mousedown".split(" ")),jc("onCompositionStart","compositionstart focusout keydown keypress keyup mousedown".split(" ")),jc("onCompositionUpdate","compositionupdate focusout keydown keypress keyup mousedown".split(" "));var Cf="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange resize seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),UW=new Set("cancel close invalid load scroll toggle".split(" ").concat(Cf));function wI(r,e,t){var n=r.type||"unknown-event";r.currentTarget=t,Lq(n,e,void 0,r),r.currentTarget=null}function bI(r,e){e=(e&4)!==0;for(var t=0;t<r.length;t++){var n=r[t],i=n.event;n=n.listeners;e:{var s=void 0;if(e)for(var o=n.length-1;0<=o;o--){var a=n[o],c=a.instance,l=a.currentTarget;if(a=a.listener,c!==s&&i.isPropagationStopped())break e;wI(i,a,l),s=c}else for(o=0;o<n.length;o++){if(a=n[o],c=a.instance,l=a.currentTarget,a=a.listener,c!==s&&i.isPropagationStopped())break e;wI(i,a,l),s=c}}}if(k0)throw r=E8,k0=!1,E8=null,r}function Tt(r,e){var t=e[X8];t===void 0&&(t=e[X8]=new Set);var n=r+"__bubble";t.has(n)||(vI(e,r,2,!1),t.add(n))}function H8(r,e,t){var n=0;e&&(n|=4),vI(t,r,n,e)}var j0="_reactListening"+Math.random().toString(36).slice(2);function If(r){if(!r[j0]){r[j0]=!0,tC.forEach(function(t){t!=="selectionchange"&&(UW.has(t)||H8(t,!1,r),H8(t,!0,r))});var e=r.nodeType===9?r:r.ownerDocument;e===null||e[j0]||(e[j0]=!0,H8("selectionchange",!1,e))}}function vI(r,e,t,n){switch(KC(e)){case 1:var i=Zq;break;case 4:i=eW;break;default:i=_8}t=i.bind(null,e,t,r),i=void 0,!v8||e!=="touchstart"&&e!=="touchmove"&&e!=="wheel"||(i=!0),n?i!==void 0?r.addEventListener(e,t,{capture:!0,passive:i}):r.addEventListener(e,t,!0):i!==void 0?r.addEventListener(e,t,{passive:i}):r.addEventListener(e,t,!1)}function q8(r,e,t,n,i){var s=n;if(!(e&1)&&!(e&2)&&n!==null)e:for(;;){if(n===null)return;var o=n.tag;if(o===3||o===4){var a=n.stateNode.containerInfo;if(a===i||a.nodeType===8&&a.parentNode===i)break;if(o===4)for(o=n.return;o!==null;){var c=o.tag;if((c===3||c===4)&&(c=o.stateNode.containerInfo,c===i||c.nodeType===8&&c.parentNode===i))return;o=o.return}for(;a!==null;){if(o=qc(a),o===null)return;if(c=o.tag,c===5||c===6){n=s=o;continue e}a=a.parentNode}}n=n.return}CC(function(){var l=s,d=m8(t),h=[];e:{var p=yI.get(r);if(p!==void 0){var m=D8,f=r;switch(r){case"keypress":if(B0(t)===0)break e;case"keydown":case"keyup":m=gW;break;case"focusin":f="focus",m=M8;break;case"focusout":f="blur",m=M8;break;case"beforeblur":case"afterblur":m=M8;break;case"click":if(t.button===2)break e;case"auxclick":case"dblclick":case"mousedown":case"mousemove":case"mouseup":case"mouseout":case"mouseover":case"contextmenu":m=qC;break;case"drag":case"dragend":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"dragstart":case"drop":m=nW;break;case"touchcancel":case"touchend":case"touchmove":case"touchstart":m=wW;break;case hI:case fI:case pI:m=oW;break;case gI:m=vW;break;case"scroll":m=tW;break;case"wheel":m=SW;break;case"copy":case"cut":case"paste":m=cW;break;case"gotpointercapture":case"lostpointercapture":case"pointercancel":case"pointerdown":case"pointermove":case"pointerout":case"pointerover":case"pointerup":m=GC}var g=(e&4)!==0,w=!g&&r==="scroll",y=g?p!==null?p+"Capture":null:p;g=[];for(var b=l,v;b!==null;){v=b;var E=v.stateNode;if(v.tag===5&&E!==null&&(v=E,y!==null&&(E=cf(b,y),E!=null&&g.push(kf(b,E,v)))),w)break;b=b.return}0<g.length&&(p=new m(p,f,null,t,d),h.push({event:p,listeners:g}))}}if(!(e&7)){e:{if(p=r==="mouseover"||r==="pointerover",m=r==="mouseout"||r==="pointerout",p&&t!==y8&&(f=t.relatedTarget||t.fromElement)&&(qc(f)||f[no]))break e;if((m||p)&&(p=d.window===d?d:(p=d.ownerDocument)?p.defaultView||p.parentWindow:window,m?(f=t.relatedTarget||t.toElement,m=l,f=f?qc(f):null,f!==null&&(w=Hc(f),f!==w||f.tag!==5&&f.tag!==6)&&(f=null)):(m=null,f=l),m!==f)){if(g=qC,E="onMouseLeave",y="onMouseEnter",b="mouse",(r==="pointerout"||r==="pointerover")&&(g=GC,E="onPointerLeave",y="onPointerEnter",b="pointer"),w=m==null?p:zu(m),v=f==null?p:zu(f),p=new g(E,b+"leave",m,t,d),p.target=w,p.relatedTarget=v,E=null,qc(d)===l&&(g=new g(y,b+"enter",f,t,d),g.target=v,g.relatedTarget=w,E=g),w=E,m&&f)t:{for(g=m,y=f,b=0,v=g;v;v=Uu(v))b++;for(v=0,E=y;E;E=Uu(E))v++;for(;0<b-v;)g=Uu(g),b--;for(;0<v-b;)y=Uu(y),v--;for(;b--;){if(g===y||y!==null&&g===y.alternate)break t;g=Uu(g),y=Uu(y)}g=null}else g=null;m!==null&&EI(h,p,m,g,!1),f!==null&&w!==null&&EI(h,w,f,g,!0)}}e:{if(p=l?zu(l):window,m=p.nodeName&&p.nodeName.toLowerCase(),m==="select"||m==="input"&&p.type==="file")var C=TW;else if(eI(p))if(rI)C=NW;else{C=DW;var k=PW}else(m=p.nodeName)&&m.toLowerCase()==="input"&&(p.type==="checkbox"||p.type==="radio")&&(C=$W);if(C&&(C=C(r,l))){tI(h,C,t,d);break e}k&&k(r,p,l),r==="focusout"&&(k=p._wrapperState)&&k.controlled&&p.type==="number"&&d8(p,"number",p.value)}switch(k=l?zu(l):window,r){case"focusin":(eI(k)||k.contentEditable==="true")&&(Lu=k,F8=l,Af=null);break;case"focusout":Af=F8=Lu=null;break;case"mousedown":z8=!0;break;case"contextmenu":case"mouseup":case"dragend":z8=!1,uI(h,t,d);break;case"selectionchange":if(RW)break;case"keydown":case"keyup":uI(h,t,d)}var x;if(R8)e:{switch(r){case"compositionstart":var I="onCompositionStart";break e;case"compositionend":I="onCompositionEnd";break e;case"compositionupdate":I="onCompositionUpdate";break e}I=void 0}else Ru?XC(r,t)&&(I="onCompositionEnd"):r==="keydown"&&t.keyCode===229&&(I="onCompositionStart");I&&(QC&&t.locale!=="ko"&&(Ru||I!=="onCompositionStart"?I==="onCompositionEnd"&&Ru&&(x=jC()):(ga=d,P8="value"in ga?ga.value:ga.textContent,Ru=!0)),k=H0(l,I),0<k.length&&(I=new WC(I,r,null,t,d),h.push({event:I,listeners:k}),x?I.data=x:(x=ZC(t),x!==null&&(I.data=x)))),(x=AW?CW(r,t):IW(r,t))&&(l=H0(l,"onBeforeInput"),0<l.length&&(d=new WC("onBeforeInput","beforeinput",null,t,d),h.push({event:d,listeners:l}),d.data=x))}bI(h,e)})}function kf(r,e,t){return{instance:r,listener:e,currentTarget:t}}function H0(r,e){for(var t=e+"Capture",n=[];r!==null;){var i=r,s=i.stateNode;i.tag===5&&s!==null&&(i=s,s=cf(r,t),s!=null&&n.unshift(kf(r,s,i)),s=cf(r,e),s!=null&&n.push(kf(r,s,i))),r=r.return}return n}function Uu(r){if(r===null)return null;do r=r.return;while(r&&r.tag!==5);return r||null}function EI(r,e,t,n,i){for(var s=e._reactName,o=[];t!==null&&t!==n;){var a=t,c=a.alternate,l=a.stateNode;if(c!==null&&c===n)break;a.tag===5&&l!==null&&(a=l,i?(c=cf(t,s),c!=null&&o.unshift(kf(t,c,a))):i||(c=cf(t,s),c!=null&&o.push(kf(t,c,a)))),t=t.return}o.length!==0&&r.push({event:e,listeners:o})}var FW=/\r\n?/g,zW=/\u0000|\uFFFD/g;function SI(r){return(typeof r=="string"?r:""+r).replace(FW,`
`).replace(zW,"")}function q0(r,e,t){if(e=SI(e),SI(r)!==e&&t)throw Error(ee(425))}function W0(){}var W8=null,G8=null;function Q8(r,e){return r==="textarea"||r==="noscript"||typeof e.children=="string"||typeof e.children=="number"||typeof e.dangerouslySetInnerHTML=="object"&&e.dangerouslySetInnerHTML!==null&&e.dangerouslySetInnerHTML.__html!=null}var Y8=typeof setTimeout=="function"?setTimeout:void 0,VW=typeof clearTimeout=="function"?clearTimeout:void 0,xI=typeof Promise=="function"?Promise:void 0,KW=typeof queueMicrotask=="function"?queueMicrotask:typeof xI<"u"?function(r){return xI.resolve(null).then(r).catch(jW)}:Y8;function jW(r){setTimeout(function(){throw r})}function J8(r,e){var t=e,n=0;do{var i=t.nextSibling;if(r.removeChild(t),i&&i.nodeType===8)if(t=i.data,t==="/$"){if(n===0){r.removeChild(i),mf(e);return}n--}else t!=="$"&&t!=="$?"&&t!=="$!"||n++;t=i}while(t);mf(e)}function ma(r){for(;r!=null;r=r.nextSibling){var e=r.nodeType;if(e===1||e===3)break;if(e===8){if(e=r.data,e==="$"||e==="$!"||e==="$?")break;if(e==="/$")return null}}return r}function AI(r){r=r.previousSibling;for(var e=0;r;){if(r.nodeType===8){var t=r.data;if(t==="$"||t==="$!"||t==="$?"){if(e===0)return r;e--}else t==="/$"&&e++}r=r.previousSibling}return null}var Fu=Math.random().toString(36).slice(2),vs="__reactFiber$"+Fu,_f="__reactProps$"+Fu,no="__reactContainer$"+Fu,X8="__reactEvents$"+Fu,HW="__reactListeners$"+Fu,qW="__reactHandles$"+Fu;function qc(r){var e=r[vs];if(e)return e;for(var t=r.parentNode;t;){if(e=t[no]||t[vs]){if(t=e.alternate,e.child!==null||t!==null&&t.child!==null)for(r=AI(r);r!==null;){if(t=r[vs])return t;r=AI(r)}return e}r=t,t=r.parentNode}return null}function Tf(r){return r=r[vs]||r[no],!r||r.tag!==5&&r.tag!==6&&r.tag!==13&&r.tag!==3?null:r}function zu(r){if(r.tag===5||r.tag===6)return r.stateNode;throw Error(ee(33))}function G0(r){return r[_f]||null}var Z8=[],Vu=-1;function wa(r){return{current:r}}function Pt(r){0>Vu||(r.current=Z8[Vu],Z8[Vu]=null,Vu--)}function Et(r,e){Vu++,Z8[Vu]=r.current,r.current=e}var ba={},$r=wa(ba),bn=wa(!1),Wc=ba;function Ku(r,e){var t=r.type.contextTypes;if(!t)return ba;var n=r.stateNode;if(n&&n.__reactInternalMemoizedUnmaskedChildContext===e)return n.__reactInternalMemoizedMaskedChildContext;var i={},s;for(s in t)i[s]=e[s];return n&&(r=r.stateNode,r.__reactInternalMemoizedUnmaskedChildContext=e,r.__reactInternalMemoizedMaskedChildContext=i),i}function vn(r){return r=r.childContextTypes,r!=null}function Q0(){Pt(bn),Pt($r)}function CI(r,e,t){if($r.current!==ba)throw Error(ee(168));Et($r,e),Et(bn,t)}function II(r,e,t){var n=r.stateNode;if(e=e.childContextTypes,typeof n.getChildContext!="function")return t;n=n.getChildContext();for(var i in n)if(!(i in e))throw Error(ee(108,Pq(r)||"Unknown",i));return Rt({},t,n)}function Y0(r){return r=(r=r.stateNode)&&r.__reactInternalMemoizedMergedChildContext||ba,Wc=$r.current,Et($r,r),Et(bn,bn.current),!0}function kI(r,e,t){var n=r.stateNode;if(!n)throw Error(ee(169));t?(r=II(r,e,Wc),n.__reactInternalMemoizedMergedChildContext=r,Pt(bn),Pt($r),Et($r,r)):Pt(bn),Et(bn,t)}var io=null,J0=!1,e5=!1;function _I(r){io===null?io=[r]:io.push(r)}function WW(r){J0=!0,_I(r)}function va(){if(!e5&&io!==null){e5=!0;var r=0,e=ht;try{var t=io;for(ht=1;r<t.length;r++){var n=t[r];do n=n(!0);while(n!==null)}io=null,J0=!1}catch(i){throw io!==null&&(io=io.slice(r+1)),PC(S8,va),i}finally{ht=e,e5=!1}}return null}var ju=[],Hu=0,X0=null,Z0=0,pi=[],gi=0,Gc=null,so=1,oo="";function Qc(r,e){ju[Hu++]=Z0,ju[Hu++]=X0,X0=r,Z0=e}function TI(r,e,t){pi[gi++]=so,pi[gi++]=oo,pi[gi++]=Gc,Gc=r;var n=so;r=oo;var i=32-Ki(n)-1;n&=~(1<<i),t+=1;var s=32-Ki(e)+i;if(30<s){var o=i-i%5;s=(n&(1<<o)-1).toString(32),n>>=o,i-=o,so=1<<32-Ki(e)+i|t<<i|n,oo=s+r}else so=1<<s|t<<i|n,oo=r}function t5(r){r.return!==null&&(Qc(r,1),TI(r,1,0))}function r5(r){for(;r===X0;)X0=ju[--Hu],ju[Hu]=null,Z0=ju[--Hu],ju[Hu]=null;for(;r===Gc;)Gc=pi[--gi],pi[gi]=null,oo=pi[--gi],pi[gi]=null,so=pi[--gi],pi[gi]=null}var Hn=null,qn=null,Nt=!1,Hi=null;function PI(r,e){var t=bi(5,null,null,0);t.elementType="DELETED",t.stateNode=e,t.return=r,e=r.deletions,e===null?(r.deletions=[t],r.flags|=16):e.push(t)}function DI(r,e){switch(r.tag){case 5:var t=r.type;return e=e.nodeType!==1||t.toLowerCase()!==e.nodeName.toLowerCase()?null:e,e!==null?(r.stateNode=e,Hn=r,qn=ma(e.firstChild),!0):!1;case 6:return e=r.pendingProps===""||e.nodeType!==3?null:e,e!==null?(r.stateNode=e,Hn=r,qn=null,!0):!1;case 13:return e=e.nodeType!==8?null:e,e!==null?(t=Gc!==null?{id:so,overflow:oo}:null,r.memoizedState={dehydrated:e,treeContext:t,retryLane:1073741824},t=bi(18,null,null,0),t.stateNode=e,t.return=r,r.child=t,Hn=r,qn=null,!0):!1;default:return!1}}function n5(r){return(r.mode&1)!==0&&(r.flags&128)===0}function i5(r){if(Nt){var e=qn;if(e){var t=e;if(!DI(r,e)){if(n5(r))throw Error(ee(418));e=ma(t.nextSibling);var n=Hn;e&&DI(r,e)?PI(n,t):(r.flags=r.flags&-4097|2,Nt=!1,Hn=r)}}else{if(n5(r))throw Error(ee(418));r.flags=r.flags&-4097|2,Nt=!1,Hn=r}}}function $I(r){for(r=r.return;r!==null&&r.tag!==5&&r.tag!==3&&r.tag!==13;)r=r.return;Hn=r}function eg(r){if(r!==Hn)return!1;if(!Nt)return $I(r),Nt=!0,!1;var e;if((e=r.tag!==3)&&!(e=r.tag!==5)&&(e=r.type,e=e!=="head"&&e!=="body"&&!Q8(r.type,r.memoizedProps)),e&&(e=qn)){if(n5(r))throw NI(),Error(ee(418));for(;e;)PI(r,e),e=ma(e.nextSibling)}if($I(r),r.tag===13){if(r=r.memoizedState,r=r!==null?r.dehydrated:null,!r)throw Error(ee(317));e:{for(r=r.nextSibling,e=0;r;){if(r.nodeType===8){var t=r.data;if(t==="/$"){if(e===0){qn=ma(r.nextSibling);break e}e--}else t!=="$"&&t!=="$!"&&t!=="$?"||e++}r=r.nextSibling}qn=null}}else qn=Hn?ma(r.stateNode.nextSibling):null;return!0}function NI(){for(var r=qn;r;)r=ma(r.nextSibling)}function qu(){qn=Hn=null,Nt=!1}function s5(r){Hi===null?Hi=[r]:Hi.push(r)}var GW=ro.ReactCurrentBatchConfig;function Pf(r,e,t){if(r=t.ref,r!==null&&typeof r!="function"&&typeof r!="object"){if(t._owner){if(t=t._owner,t){if(t.tag!==1)throw Error(ee(309));var n=t.stateNode}if(!n)throw Error(ee(147,r));var i=n,s=""+r;return e!==null&&e.ref!==null&&typeof e.ref=="function"&&e.ref._stringRef===s?e.ref:(e=function(o){var a=i.refs;o===null?delete a[s]:a[s]=o},e._stringRef=s,e)}if(typeof r!="string")throw Error(ee(284));if(!t._owner)throw Error(ee(290,r))}return r}function tg(r,e){throw r=Object.prototype.toString.call(e),Error(ee(31,r==="[object Object]"?"object with keys {"+Object.keys(e).join(", ")+"}":r))}function MI(r){var e=r._init;return e(r._payload)}function OI(r){function e(y,b){if(r){var v=y.deletions;v===null?(y.deletions=[b],y.flags|=16):v.push(b)}}function t(y,b){if(!r)return null;for(;b!==null;)e(y,b),b=b.sibling;return null}function n(y,b){for(y=new Map;b!==null;)b.key!==null?y.set(b.key,b):y.set(b.index,b),b=b.sibling;return y}function i(y,b){return y=_a(y,b),y.index=0,y.sibling=null,y}function s(y,b,v){return y.index=v,r?(v=y.alternate,v!==null?(v=v.index,v<b?(y.flags|=2,b):v):(y.flags|=2,b)):(y.flags|=1048576,b)}function o(y){return r&&y.alternate===null&&(y.flags|=2),y}function a(y,b,v,E){return b===null||b.tag!==6?(b=Y5(v,y.mode,E),b.return=y,b):(b=i(b,v),b.return=y,b)}function c(y,b,v,E){var C=v.type;return C===Pu?d(y,b,v.props.children,E,v.key):b!==null&&(b.elementType===C||typeof C=="object"&&C!==null&&C.$$typeof===la&&MI(C)===b.type)?(E=i(b,v.props),E.ref=Pf(y,b,v),E.return=y,E):(E=Cg(v.type,v.key,v.props,null,y.mode,E),E.ref=Pf(y,b,v),E.return=y,E)}function l(y,b,v,E){return b===null||b.tag!==4||b.stateNode.containerInfo!==v.containerInfo||b.stateNode.implementation!==v.implementation?(b=J5(v,y.mode,E),b.return=y,b):(b=i(b,v.children||[]),b.return=y,b)}function d(y,b,v,E,C){return b===null||b.tag!==7?(b=nl(v,y.mode,E,C),b.return=y,b):(b=i(b,v),b.return=y,b)}function h(y,b,v){if(typeof b=="string"&&b!==""||typeof b=="number")return b=Y5(""+b,y.mode,v),b.return=y,b;if(typeof b=="object"&&b!==null){switch(b.$$typeof){case S0:return v=Cg(b.type,b.key,b.props,null,y.mode,v),v.ref=Pf(y,null,b),v.return=y,v;case Tu:return b=J5(b,y.mode,v),b.return=y,b;case la:var E=b._init;return h(y,E(b._payload),v)}if(sf(b)||rf(b))return b=nl(b,y.mode,v,null),b.return=y,b;tg(y,b)}return null}function p(y,b,v,E){var C=b!==null?b.key:null;if(typeof v=="string"&&v!==""||typeof v=="number")return C!==null?null:a(y,b,""+v,E);if(typeof v=="object"&&v!==null){switch(v.$$typeof){case S0:return v.key===C?c(y,b,v,E):null;case Tu:return v.key===C?l(y,b,v,E):null;case la:return C=v._init,p(y,b,C(v._payload),E)}if(sf(v)||rf(v))return C!==null?null:d(y,b,v,E,null);tg(y,v)}return null}function m(y,b,v,E,C){if(typeof E=="string"&&E!==""||typeof E=="number")return y=y.get(v)||null,a(b,y,""+E,C);if(typeof E=="object"&&E!==null){switch(E.$$typeof){case S0:return y=y.get(E.key===null?v:E.key)||null,c(b,y,E,C);case Tu:return y=y.get(E.key===null?v:E.key)||null,l(b,y,E,C);case la:var k=E._init;return m(y,b,v,k(E._payload),C)}if(sf(E)||rf(E))return y=y.get(v)||null,d(b,y,E,C,null);tg(b,E)}return null}function f(y,b,v,E){for(var C=null,k=null,x=b,I=b=0,T=null;x!==null&&I<v.length;I++){x.index>I?(T=x,x=null):T=x.sibling;var L=p(y,x,v[I],E);if(L===null){x===null&&(x=T);break}r&&x&&L.alternate===null&&e(y,x),b=s(L,b,I),k===null?C=L:k.sibling=L,k=L,x=T}if(I===v.length)return t(y,x),Nt&&Qc(y,I),C;if(x===null){for(;I<v.length;I++)x=h(y,v[I],E),x!==null&&(b=s(x,b,I),k===null?C=x:k.sibling=x,k=x);return Nt&&Qc(y,I),C}for(x=n(y,x);I<v.length;I++)T=m(x,y,I,v[I],E),T!==null&&(r&&T.alternate!==null&&x.delete(T.key===null?I:T.key),b=s(T,b,I),k===null?C=T:k.sibling=T,k=T);return r&&x.forEach(function(z){return e(y,z)}),Nt&&Qc(y,I),C}function g(y,b,v,E){var C=rf(v);if(typeof C!="function")throw Error(ee(150));if(v=C.call(v),v==null)throw Error(ee(151));for(var k=C=null,x=b,I=b=0,T=null,L=v.next();x!==null&&!L.done;I++,L=v.next()){x.index>I?(T=x,x=null):T=x.sibling;var z=p(y,x,L.value,E);if(z===null){x===null&&(x=T);break}r&&x&&z.alternate===null&&e(y,x),b=s(z,b,I),k===null?C=z:k.sibling=z,k=z,x=T}if(L.done)return t(y,x),Nt&&Qc(y,I),C;if(x===null){for(;!L.done;I++,L=v.next())L=h(y,L.value,E),L!==null&&(b=s(L,b,I),k===null?C=L:k.sibling=L,k=L);return Nt&&Qc(y,I),C}for(x=n(y,x);!L.done;I++,L=v.next())L=m(x,y,I,L.value,E),L!==null&&(r&&L.alternate!==null&&x.delete(L.key===null?I:L.key),b=s(L,b,I),k===null?C=L:k.sibling=L,k=L);return r&&x.forEach(function(B){return e(y,B)}),Nt&&Qc(y,I),C}function w(y,b,v,E){if(typeof v=="object"&&v!==null&&v.type===Pu&&v.key===null&&(v=v.props.children),typeof v=="object"&&v!==null){switch(v.$$typeof){case S0:e:{for(var C=v.key,k=b;k!==null;){if(k.key===C){if(C=v.type,C===Pu){if(k.tag===7){t(y,k.sibling),b=i(k,v.props.children),b.return=y,y=b;break e}}else if(k.elementType===C||typeof C=="object"&&C!==null&&C.$$typeof===la&&MI(C)===k.type){t(y,k.sibling),b=i(k,v.props),b.ref=Pf(y,k,v),b.return=y,y=b;break e}t(y,k);break}else e(y,k);k=k.sibling}v.type===Pu?(b=nl(v.props.children,y.mode,E,v.key),b.return=y,y=b):(E=Cg(v.type,v.key,v.props,null,y.mode,E),E.ref=Pf(y,b,v),E.return=y,y=E)}return o(y);case Tu:e:{for(k=v.key;b!==null;){if(b.key===k)if(b.tag===4&&b.stateNode.containerInfo===v.containerInfo&&b.stateNode.implementation===v.implementation){t(y,b.sibling),b=i(b,v.children||[]),b.return=y,y=b;break e}else{t(y,b);break}else e(y,b);b=b.sibling}b=J5(v,y.mode,E),b.return=y,y=b}return o(y);case la:return k=v._init,w(y,b,k(v._payload),E)}if(sf(v))return f(y,b,v,E);if(rf(v))return g(y,b,v,E);tg(y,v)}return typeof v=="string"&&v!==""||typeof v=="number"?(v=""+v,b!==null&&b.tag===6?(t(y,b.sibling),b=i(b,v),b.return=y,y=b):(t(y,b),b=Y5(v,y.mode,E),b.return=y,y=b),o(y)):t(y,b)}return w}var Wu=OI(!0),RI=OI(!1),rg=wa(null),ng=null,Gu=null,o5=null;function a5(){o5=Gu=ng=null}function c5(r){var e=rg.current;Pt(rg),r._currentValue=e}function l5(r,e,t){for(;r!==null;){var n=r.alternate;if((r.childLanes&e)!==e?(r.childLanes|=e,n!==null&&(n.childLanes|=e)):n!==null&&(n.childLanes&e)!==e&&(n.childLanes|=e),r===t)break;r=r.return}}function Qu(r,e){ng=r,o5=Gu=null,r=r.dependencies,r!==null&&r.firstContext!==null&&(r.lanes&e&&(En=!0),r.firstContext=null)}function yi(r){var e=r._currentValue;if(o5!==r)if(r={context:r,memoizedValue:e,next:null},Gu===null){if(ng===null)throw Error(ee(308));Gu=r,ng.dependencies={lanes:0,firstContext:r}}else Gu=Gu.next=r;return e}var Yc=null;function u5(r){Yc===null?Yc=[r]:Yc.push(r)}function LI(r,e,t,n){var i=e.interleaved;return i===null?(t.next=t,u5(e)):(t.next=i.next,i.next=t),e.interleaved=t,ao(r,n)}function ao(r,e){r.lanes|=e;var t=r.alternate;for(t!==null&&(t.lanes|=e),t=r,r=r.return;r!==null;)r.childLanes|=e,t=r.alternate,t!==null&&(t.childLanes|=e),t=r,r=r.return;return t.tag===3?t.stateNode:null}var Ea=!1;function d5(r){r.updateQueue={baseState:r.memoizedState,firstBaseUpdate:null,lastBaseUpdate:null,shared:{pending:null,interleaved:null,lanes:0},effects:null}}function BI(r,e){r=r.updateQueue,e.updateQueue===r&&(e.updateQueue={baseState:r.baseState,firstBaseUpdate:r.firstBaseUpdate,lastBaseUpdate:r.lastBaseUpdate,shared:r.shared,effects:r.effects})}function co(r,e){return{eventTime:r,lane:e,tag:0,payload:null,callback:null,next:null}}function Sa(r,e,t){var n=r.updateQueue;if(n===null)return null;if(n=n.shared,et&2){var i=n.pending;return i===null?e.next=e:(e.next=i.next,i.next=e),n.pending=e,ao(r,t)}return i=n.interleaved,i===null?(e.next=e,u5(n)):(e.next=i.next,i.next=e),n.interleaved=e,ao(r,t)}function ig(r,e,t){if(e=e.updateQueue,e!==null&&(e=e.shared,(t&4194240)!==0)){var n=e.lanes;n&=r.pendingLanes,t|=n,e.lanes=t,C8(r,t)}}function UI(r,e){var t=r.updateQueue,n=r.alternate;if(n!==null&&(n=n.updateQueue,t===n)){var i=null,s=null;if(t=t.firstBaseUpdate,t!==null){do{var o={eventTime:t.eventTime,lane:t.lane,tag:t.tag,payload:t.payload,callback:t.callback,next:null};s===null?i=s=o:s=s.next=o,t=t.next}while(t!==null);s===null?i=s=e:s=s.next=e}else i=s=e;t={baseState:n.baseState,firstBaseUpdate:i,lastBaseUpdate:s,shared:n.shared,effects:n.effects},r.updateQueue=t;return}r=t.lastBaseUpdate,r===null?t.firstBaseUpdate=e:r.next=e,t.lastBaseUpdate=e}function sg(r,e,t,n){var i=r.updateQueue;Ea=!1;var s=i.firstBaseUpdate,o=i.lastBaseUpdate,a=i.shared.pending;if(a!==null){i.shared.pending=null;var c=a,l=c.next;c.next=null,o===null?s=l:o.next=l,o=c;var d=r.alternate;d!==null&&(d=d.updateQueue,a=d.lastBaseUpdate,a!==o&&(a===null?d.firstBaseUpdate=l:a.next=l,d.lastBaseUpdate=c))}if(s!==null){var h=i.baseState;o=0,d=l=c=null,a=s;do{var p=a.lane,m=a.eventTime;if((n&p)===p){d!==null&&(d=d.next={eventTime:m,lane:0,tag:a.tag,payload:a.payload,callback:a.callback,next:null});e:{var f=r,g=a;switch(p=e,m=t,g.tag){case 1:if(f=g.payload,typeof f=="function"){h=f.call(m,h,p);break e}h=f;break e;case 3:f.flags=f.flags&-65537|128;case 0:if(f=g.payload,p=typeof f=="function"?f.call(m,h,p):f,p==null)break e;h=Rt({},h,p);break e;case 2:Ea=!0}}a.callback!==null&&a.lane!==0&&(r.flags|=64,p=i.effects,p===null?i.effects=[a]:p.push(a))}else m={eventTime:m,lane:p,tag:a.tag,payload:a.payload,callback:a.callback,next:null},d===null?(l=d=m,c=h):d=d.next=m,o|=p;if(a=a.next,a===null){if(a=i.shared.pending,a===null)break;p=a,a=p.next,p.next=null,i.lastBaseUpdate=p,i.shared.pending=null}}while(!0);if(d===null&&(c=h),i.baseState=c,i.firstBaseUpdate=l,i.lastBaseUpdate=d,e=i.shared.interleaved,e!==null){i=e;do o|=i.lane,i=i.next;while(i!==e)}else s===null&&(i.shared.lanes=0);Zc|=o,r.lanes=o,r.memoizedState=h}}function FI(r,e,t){if(r=e.effects,e.effects=null,r!==null)for(e=0;e<r.length;e++){var n=r[e],i=n.callback;if(i!==null){if(n.callback=null,n=t,typeof i!="function")throw Error(ee(191,i));i.call(n)}}}var Df={},Es=wa(Df),$f=wa(Df),Nf=wa(Df);function Jc(r){if(r===Df)throw Error(ee(174));return r}function h5(r,e){switch(Et(Nf,e),Et($f,r),Et(Es,Df),r=e.nodeType,r){case 9:case 11:e=(e=e.documentElement)?e.namespaceURI:f8(null,"");break;default:r=r===8?e.parentNode:e,e=r.namespaceURI||null,r=r.tagName,e=f8(e,r)}Pt(Es),Et(Es,e)}function Yu(){Pt(Es),Pt($f),Pt(Nf)}function zI(r){Jc(Nf.current);var e=Jc(Es.current),t=f8(e,r.type);e!==t&&(Et($f,r),Et(Es,t))}function f5(r){$f.current===r&&(Pt(Es),Pt($f))}var Lt=wa(0);function og(r){for(var e=r;e!==null;){if(e.tag===13){var t=e.memoizedState;if(t!==null&&(t=t.dehydrated,t===null||t.data==="$?"||t.data==="$!"))return e}else if(e.tag===19&&e.memoizedProps.revealOrder!==void 0){if(e.flags&128)return e}else if(e.child!==null){e.child.return=e,e=e.child;continue}if(e===r)break;for(;e.sibling===null;){if(e.return===null||e.return===r)return null;e=e.return}e.sibling.return=e.return,e=e.sibling}return null}var p5=[];function g5(){for(var r=0;r<p5.length;r++)p5[r]._workInProgressVersionPrimary=null;p5.length=0}var ag=ro.ReactCurrentDispatcher,y5=ro.ReactCurrentBatchConfig,Xc=0,Bt=null,nr=null,cr=null,cg=!1,Mf=!1,Of=0,QW=0;function Nr(){throw Error(ee(321))}function m5(r,e){if(e===null)return!1;for(var t=0;t<e.length&&t<r.length;t++)if(!ji(r[t],e[t]))return!1;return!0}function w5(r,e,t,n,i,s){if(Xc=s,Bt=e,e.memoizedState=null,e.updateQueue=null,e.lanes=0,ag.current=r===null||r.memoizedState===null?ZW:eG,r=t(n,i),Mf){s=0;do{if(Mf=!1,Of=0,25<=s)throw Error(ee(301));s+=1,cr=nr=null,e.updateQueue=null,ag.current=tG,r=t(n,i)}while(Mf)}if(ag.current=dg,e=nr!==null&&nr.next!==null,Xc=0,cr=nr=Bt=null,cg=!1,e)throw Error(ee(300));return r}function b5(){var r=Of!==0;return Of=0,r}function Ss(){var r={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};return cr===null?Bt.memoizedState=cr=r:cr=cr.next=r,cr}function mi(){if(nr===null){var r=Bt.alternate;r=r!==null?r.memoizedState:null}else r=nr.next;var e=cr===null?Bt.memoizedState:cr.next;if(e!==null)cr=e,nr=r;else{if(r===null)throw Error(ee(310));nr=r,r={memoizedState:nr.memoizedState,baseState:nr.baseState,baseQueue:nr.baseQueue,queue:nr.queue,next:null},cr===null?Bt.memoizedState=cr=r:cr=cr.next=r}return cr}function Rf(r,e){return typeof e=="function"?e(r):e}function v5(r){var e=mi(),t=e.queue;if(t===null)throw Error(ee(311));t.lastRenderedReducer=r;var n=nr,i=n.baseQueue,s=t.pending;if(s!==null){if(i!==null){var o=i.next;i.next=s.next,s.next=o}n.baseQueue=i=s,t.pending=null}if(i!==null){s=i.next,n=n.baseState;var a=o=null,c=null,l=s;do{var d=l.lane;if((Xc&d)===d)c!==null&&(c=c.next={lane:0,action:l.action,hasEagerState:l.hasEagerState,eagerState:l.eagerState,next:null}),n=l.hasEagerState?l.eagerState:r(n,l.action);else{var h={lane:d,action:l.action,hasEagerState:l.hasEagerState,eagerState:l.eagerState,next:null};c===null?(a=c=h,o=n):c=c.next=h,Bt.lanes|=d,Zc|=d}l=l.next}while(l!==null&&l!==s);c===null?o=n:c.next=a,ji(n,e.memoizedState)||(En=!0),e.memoizedState=n,e.baseState=o,e.baseQueue=c,t.lastRenderedState=n}if(r=t.interleaved,r!==null){i=r;do s=i.lane,Bt.lanes|=s,Zc|=s,i=i.next;while(i!==r)}else i===null&&(t.lanes=0);return[e.memoizedState,t.dispatch]}function E5(r){var e=mi(),t=e.queue;if(t===null)throw Error(ee(311));t.lastRenderedReducer=r;var n=t.dispatch,i=t.pending,s=e.memoizedState;if(i!==null){t.pending=null;var o=i=i.next;do s=r(s,o.action),o=o.next;while(o!==i);ji(s,e.memoizedState)||(En=!0),e.memoizedState=s,e.baseQueue===null&&(e.baseState=s),t.lastRenderedState=s}return[s,n]}function VI(){}function KI(r,e){var t=Bt,n=mi(),i=e(),s=!ji(n.memoizedState,i);if(s&&(n.memoizedState=i,En=!0),n=n.queue,S5(qI.bind(null,t,n,r),[r]),n.getSnapshot!==e||s||cr!==null&&cr.memoizedState.tag&1){if(t.flags|=2048,Lf(9,HI.bind(null,t,n,i,e),void 0,null),lr===null)throw Error(ee(349));Xc&30||jI(t,e,i)}return i}function jI(r,e,t){r.flags|=16384,r={getSnapshot:e,value:t},e=Bt.updateQueue,e===null?(e={lastEffect:null,stores:null},Bt.updateQueue=e,e.stores=[r]):(t=e.stores,t===null?e.stores=[r]:t.push(r))}function HI(r,e,t,n){e.value=t,e.getSnapshot=n,WI(e)&&GI(r)}function qI(r,e,t){return t(function(){WI(e)&&GI(r)})}function WI(r){var e=r.getSnapshot;r=r.value;try{var t=e();return!ji(r,t)}catch{return!0}}function GI(r){var e=ao(r,1);e!==null&&Qi(e,r,1,-1)}function QI(r){var e=Ss();return typeof r=="function"&&(r=r()),e.memoizedState=e.baseState=r,r={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:Rf,lastRenderedState:r},e.queue=r,r=r.dispatch=XW.bind(null,Bt,r),[e.memoizedState,r]}function Lf(r,e,t,n){return r={tag:r,create:e,destroy:t,deps:n,next:null},e=Bt.updateQueue,e===null?(e={lastEffect:null,stores:null},Bt.updateQueue=e,e.lastEffect=r.next=r):(t=e.lastEffect,t===null?e.lastEffect=r.next=r:(n=t.next,t.next=r,r.next=n,e.lastEffect=r)),r}function YI(){return mi().memoizedState}function lg(r,e,t,n){var i=Ss();Bt.flags|=r,i.memoizedState=Lf(1|e,t,void 0,n===void 0?null:n)}function ug(r,e,t,n){var i=mi();n=n===void 0?null:n;var s=void 0;if(nr!==null){var o=nr.memoizedState;if(s=o.destroy,n!==null&&m5(n,o.deps)){i.memoizedState=Lf(e,t,s,n);return}}Bt.flags|=r,i.memoizedState=Lf(1|e,t,s,n)}function JI(r,e){return lg(8390656,8,r,e)}function S5(r,e){return ug(2048,8,r,e)}function XI(r,e){return ug(4,2,r,e)}function ZI(r,e){return ug(4,4,r,e)}function ek(r,e){if(typeof e=="function")return r=r(),e(r),function(){e(null)};if(e!=null)return r=r(),e.current=r,function(){e.current=null}}function tk(r,e,t){return t=t!=null?t.concat([r]):null,ug(4,4,ek.bind(null,e,r),t)}function x5(){}function rk(r,e){var t=mi();e=e===void 0?null:e;var n=t.memoizedState;return n!==null&&e!==null&&m5(e,n[1])?n[0]:(t.memoizedState=[r,e],r)}function nk(r,e){var t=mi();e=e===void 0?null:e;var n=t.memoizedState;return n!==null&&e!==null&&m5(e,n[1])?n[0]:(r=r(),t.memoizedState=[r,e],r)}function ik(r,e,t){return Xc&21?(ji(t,e)||(t=MC(),Bt.lanes|=t,Zc|=t,r.baseState=!0),e):(r.baseState&&(r.baseState=!1,En=!0),r.memoizedState=t)}function YW(r,e){var t=ht;ht=t!==0&&4>t?t:4,r(!0);var n=y5.transition;y5.transition={};try{r(!1),e()}finally{ht=t,y5.transition=n}}function sk(){return mi().memoizedState}function JW(r,e,t){var n=Ia(r);if(t={lane:n,action:t,hasEagerState:!1,eagerState:null,next:null},ok(r))ak(e,t);else if(t=LI(r,e,t,n),t!==null){var i=on();Qi(t,r,n,i),ck(t,e,n)}}function XW(r,e,t){var n=Ia(r),i={lane:n,action:t,hasEagerState:!1,eagerState:null,next:null};if(ok(r))ak(e,i);else{var s=r.alternate;if(r.lanes===0&&(s===null||s.lanes===0)&&(s=e.lastRenderedReducer,s!==null))try{var o=e.lastRenderedState,a=s(o,t);if(i.hasEagerState=!0,i.eagerState=a,ji(a,o)){var c=e.interleaved;c===null?(i.next=i,u5(e)):(i.next=c.next,c.next=i),e.interleaved=i;return}}catch{}finally{}t=LI(r,e,i,n),t!==null&&(i=on(),Qi(t,r,n,i),ck(t,e,n))}}function ok(r){var e=r.alternate;return r===Bt||e!==null&&e===Bt}function ak(r,e){Mf=cg=!0;var t=r.pending;t===null?e.next=e:(e.next=t.next,t.next=e),r.pending=e}function ck(r,e,t){if(t&4194240){var n=e.lanes;n&=r.pendingLanes,t|=n,e.lanes=t,C8(r,t)}}var dg={readContext:yi,useCallback:Nr,useContext:Nr,useEffect:Nr,useImperativeHandle:Nr,useInsertionEffect:Nr,useLayoutEffect:Nr,useMemo:Nr,useReducer:Nr,useRef:Nr,useState:Nr,useDebugValue:Nr,useDeferredValue:Nr,useTransition:Nr,useMutableSource:Nr,useSyncExternalStore:Nr,useId:Nr,unstable_isNewReconciler:!1},ZW={readContext:yi,useCallback:function(r,e){return Ss().memoizedState=[r,e===void 0?null:e],r},useContext:yi,useEffect:JI,useImperativeHandle:function(r,e,t){return t=t!=null?t.concat([r]):null,lg(4194308,4,ek.bind(null,e,r),t)},useLayoutEffect:function(r,e){return lg(4194308,4,r,e)},useInsertionEffect:function(r,e){return lg(4,2,r,e)},useMemo:function(r,e){var t=Ss();return e=e===void 0?null:e,r=r(),t.memoizedState=[r,e],r},useReducer:function(r,e,t){var n=Ss();return e=t!==void 0?t(e):e,n.memoizedState=n.baseState=e,r={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:r,lastRenderedState:e},n.queue=r,r=r.dispatch=JW.bind(null,Bt,r),[n.memoizedState,r]},useRef:function(r){var e=Ss();return r={current:r},e.memoizedState=r},useState:QI,useDebugValue:x5,useDeferredValue:function(r){return Ss().memoizedState=r},useTransition:function(){var r=QI(!1),e=r[0];return r=YW.bind(null,r[1]),Ss().memoizedState=r,[e,r]},useMutableSource:function(){},useSyncExternalStore:function(r,e,t){var n=Bt,i=Ss();if(Nt){if(t===void 0)throw Error(ee(407));t=t()}else{if(t=e(),lr===null)throw Error(ee(349));Xc&30||jI(n,e,t)}i.memoizedState=t;var s={value:t,getSnapshot:e};return i.queue=s,JI(qI.bind(null,n,s,r),[r]),n.flags|=2048,Lf(9,HI.bind(null,n,s,t,e),void 0,null),t},useId:function(){var r=Ss(),e=lr.identifierPrefix;if(Nt){var t=oo,n=so;t=(n&~(1<<32-Ki(n)-1)).toString(32)+t,e=":"+e+"R"+t,t=Of++,0<t&&(e+="H"+t.toString(32)),e+=":"}else t=QW++,e=":"+e+"r"+t.toString(32)+":";return r.memoizedState=e},unstable_isNewReconciler:!1},eG={readContext:yi,useCallback:rk,useContext:yi,useEffect:S5,useImperativeHandle:tk,useInsertionEffect:XI,useLayoutEffect:ZI,useMemo:nk,useReducer:v5,useRef:YI,useState:function(){return v5(Rf)},useDebugValue:x5,useDeferredValue:function(r){var e=mi();return ik(e,nr.memoizedState,r)},useTransition:function(){var r=v5(Rf)[0],e=mi().memoizedState;return[r,e]},useMutableSource:VI,useSyncExternalStore:KI,useId:sk,unstable_isNewReconciler:!1},tG={readContext:yi,useCallback:rk,useContext:yi,useEffect:S5,useImperativeHandle:tk,useInsertionEffect:XI,useLayoutEffect:ZI,useMemo:nk,useReducer:E5,useRef:YI,useState:function(){return E5(Rf)},useDebugValue:x5,useDeferredValue:function(r){var e=mi();return nr===null?e.memoizedState=r:ik(e,nr.memoizedState,r)},useTransition:function(){var r=E5(Rf)[0],e=mi().memoizedState;return[r,e]},useMutableSource:VI,useSyncExternalStore:KI,useId:sk,unstable_isNewReconciler:!1};function qi(r,e){if(r&&r.defaultProps){e=Rt({},e),r=r.defaultProps;for(var t in r)e[t]===void 0&&(e[t]=r[t]);return e}return e}function A5(r,e,t,n){e=r.memoizedState,t=t(n,e),t=t==null?e:Rt({},e,t),r.memoizedState=t,r.lanes===0&&(r.updateQueue.baseState=t)}var hg={isMounted:function(r){return(r=r._reactInternals)?Hc(r)===r:!1},enqueueSetState:function(r,e,t){r=r._reactInternals;var n=on(),i=Ia(r),s=co(n,i);s.payload=e,t!=null&&(s.callback=t),e=Sa(r,s,i),e!==null&&(Qi(e,r,i,n),ig(e,r,i))},enqueueReplaceState:function(r,e,t){r=r._reactInternals;var n=on(),i=Ia(r),s=co(n,i);s.tag=1,s.payload=e,t!=null&&(s.callback=t),e=Sa(r,s,i),e!==null&&(Qi(e,r,i,n),ig(e,r,i))},enqueueForceUpdate:function(r,e){r=r._reactInternals;var t=on(),n=Ia(r),i=co(t,n);i.tag=2,e!=null&&(i.callback=e),e=Sa(r,i,n),e!==null&&(Qi(e,r,n,t),ig(e,r,n))}};function lk(r,e,t,n,i,s,o){return r=r.stateNode,typeof r.shouldComponentUpdate=="function"?r.shouldComponentUpdate(n,s,o):e.prototype&&e.prototype.isPureReactComponent?!xf(t,n)||!xf(i,s):!0}function uk(r,e,t){var n=!1,i=ba,s=e.contextType;return typeof s=="object"&&s!==null?s=yi(s):(i=vn(e)?Wc:$r.current,n=e.contextTypes,s=(n=n!=null)?Ku(r,i):ba),e=new e(t,s),r.memoizedState=e.state!==null&&e.state!==void 0?e.state:null,e.updater=hg,r.stateNode=e,e._reactInternals=r,n&&(r=r.stateNode,r.__reactInternalMemoizedUnmaskedChildContext=i,r.__reactInternalMemoizedMaskedChildContext=s),e}function dk(r,e,t,n){r=e.state,typeof e.componentWillReceiveProps=="function"&&e.componentWillReceiveProps(t,n),typeof e.UNSAFE_componentWillReceiveProps=="function"&&e.UNSAFE_componentWillReceiveProps(t,n),e.state!==r&&hg.enqueueReplaceState(e,e.state,null)}function C5(r,e,t,n){var i=r.stateNode;i.props=t,i.state=r.memoizedState,i.refs={},d5(r);var s=e.contextType;typeof s=="object"&&s!==null?i.context=yi(s):(s=vn(e)?Wc:$r.current,i.context=Ku(r,s)),i.state=r.memoizedState,s=e.getDerivedStateFromProps,typeof s=="function"&&(A5(r,e,s,t),i.state=r.memoizedState),typeof e.getDerivedStateFromProps=="function"||typeof i.getSnapshotBeforeUpdate=="function"||typeof i.UNSAFE_componentWillMount!="function"&&typeof i.componentWillMount!="function"||(e=i.state,typeof i.componentWillMount=="function"&&i.componentWillMount(),typeof i.UNSAFE_componentWillMount=="function"&&i.UNSAFE_componentWillMount(),e!==i.state&&hg.enqueueReplaceState(i,i.state,null),sg(r,t,i,n),i.state=r.memoizedState),typeof i.componentDidMount=="function"&&(r.flags|=4194308)}function Ju(r,e){try{var t="",n=e;do t+=Tq(n),n=n.return;while(n);var i=t}catch(s){i=`
Error generating stack: `+s.message+`
`+s.stack}return{value:r,source:e,stack:i,digest:null}}function I5(r,e,t){return{value:r,source:null,stack:t??null,digest:e??null}}function k5(r,e){try{console.error(e.value)}catch(t){setTimeout(function(){throw t})}}var rG=typeof WeakMap=="function"?WeakMap:Map;function hk(r,e,t){t=co(-1,t),t.tag=3,t.payload={element:null};var n=e.value;return t.callback=function(){bg||(bg=!0,V5=n),k5(r,e)},t}function fk(r,e,t){t=co(-1,t),t.tag=3;var n=r.type.getDerivedStateFromError;if(typeof n=="function"){var i=e.value;t.payload=function(){return n(i)},t.callback=function(){k5(r,e)}}var s=r.stateNode;return s!==null&&typeof s.componentDidCatch=="function"&&(t.callback=function(){k5(r,e),typeof n!="function"&&(Aa===null?Aa=new Set([this]):Aa.add(this));var o=e.stack;this.componentDidCatch(e.value,{componentStack:o!==null?o:""})}),t}function pk(r,e,t){var n=r.pingCache;if(n===null){n=r.pingCache=new rG;var i=new Set;n.set(e,i)}else i=n.get(e),i===void 0&&(i=new Set,n.set(e,i));i.has(t)||(i.add(t),r=yG.bind(null,r,e,t),e.then(r,r))}function gk(r){do{var e;if((e=r.tag===13)&&(e=r.memoizedState,e=e!==null?e.dehydrated!==null:!0),e)return r;r=r.return}while(r!==null);return null}function yk(r,e,t,n,i){return r.mode&1?(r.flags|=65536,r.lanes=i,r):(r===e?r.flags|=65536:(r.flags|=128,t.flags|=131072,t.flags&=-52805,t.tag===1&&(t.alternate===null?t.tag=17:(e=co(-1,1),e.tag=2,Sa(t,e,1))),t.lanes|=1),r)}var nG=ro.ReactCurrentOwner,En=!1;function sn(r,e,t,n){e.child=r===null?RI(e,null,t,n):Wu(e,r.child,t,n)}function mk(r,e,t,n,i){t=t.render;var s=e.ref;return Qu(e,i),n=w5(r,e,t,n,s,i),t=b5(),r!==null&&!En?(e.updateQueue=r.updateQueue,e.flags&=-2053,r.lanes&=~i,lo(r,e,i)):(Nt&&t&&t5(e),e.flags|=1,sn(r,e,n,i),e.child)}function wk(r,e,t,n,i){if(r===null){var s=t.type;return typeof s=="function"&&!Q5(s)&&s.defaultProps===void 0&&t.compare===null&&t.defaultProps===void 0?(e.tag=15,e.type=s,bk(r,e,s,n,i)):(r=Cg(t.type,null,n,e,e.mode,i),r.ref=e.ref,r.return=e,e.child=r)}if(s=r.child,!(r.lanes&i)){var o=s.memoizedProps;if(t=t.compare,t=t!==null?t:xf,t(o,n)&&r.ref===e.ref)return lo(r,e,i)}return e.flags|=1,r=_a(s,n),r.ref=e.ref,r.return=e,e.child=r}function bk(r,e,t,n,i){if(r!==null){var s=r.memoizedProps;if(xf(s,n)&&r.ref===e.ref)if(En=!1,e.pendingProps=n=s,(r.lanes&i)!==0)r.flags&131072&&(En=!0);else return e.lanes=r.lanes,lo(r,e,i)}return _5(r,e,t,n,i)}function vk(r,e,t){var n=e.pendingProps,i=n.children,s=r!==null?r.memoizedState:null;if(n.mode==="hidden")if(!(e.mode&1))e.memoizedState={baseLanes:0,cachePool:null,transitions:null},Et(Zu,Wn),Wn|=t;else{if(!(t&1073741824))return r=s!==null?s.baseLanes|t:t,e.lanes=e.childLanes=1073741824,e.memoizedState={baseLanes:r,cachePool:null,transitions:null},e.updateQueue=null,Et(Zu,Wn),Wn|=r,null;e.memoizedState={baseLanes:0,cachePool:null,transitions:null},n=s!==null?s.baseLanes:t,Et(Zu,Wn),Wn|=n}else s!==null?(n=s.baseLanes|t,e.memoizedState=null):n=t,Et(Zu,Wn),Wn|=n;return sn(r,e,i,t),e.child}function Ek(r,e){var t=e.ref;(r===null&&t!==null||r!==null&&r.ref!==t)&&(e.flags|=512,e.flags|=2097152)}function _5(r,e,t,n,i){var s=vn(t)?Wc:$r.current;return s=Ku(e,s),Qu(e,i),t=w5(r,e,t,n,s,i),n=b5(),r!==null&&!En?(e.updateQueue=r.updateQueue,e.flags&=-2053,r.lanes&=~i,lo(r,e,i)):(Nt&&n&&t5(e),e.flags|=1,sn(r,e,t,i),e.child)}function Sk(r,e,t,n,i){if(vn(t)){var s=!0;Y0(e)}else s=!1;if(Qu(e,i),e.stateNode===null)pg(r,e),uk(e,t,n),C5(e,t,n,i),n=!0;else if(r===null){var o=e.stateNode,a=e.memoizedProps;o.props=a;var c=o.context,l=t.contextType;typeof l=="object"&&l!==null?l=yi(l):(l=vn(t)?Wc:$r.current,l=Ku(e,l));var d=t.getDerivedStateFromProps,h=typeof d=="function"||typeof o.getSnapshotBeforeUpdate=="function";h||typeof o.UNSAFE_componentWillReceiveProps!="function"&&typeof o.componentWillReceiveProps!="function"||(a!==n||c!==l)&&dk(e,o,n,l),Ea=!1;var p=e.memoizedState;o.state=p,sg(e,n,o,i),c=e.memoizedState,a!==n||p!==c||bn.current||Ea?(typeof d=="function"&&(A5(e,t,d,n),c=e.memoizedState),(a=Ea||lk(e,t,a,n,p,c,l))?(h||typeof o.UNSAFE_componentWillMount!="function"&&typeof o.componentWillMount!="function"||(typeof o.componentWillMount=="function"&&o.componentWillMount(),typeof o.UNSAFE_componentWillMount=="function"&&o.UNSAFE_componentWillMount()),typeof o.componentDidMount=="function"&&(e.flags|=4194308)):(typeof o.componentDidMount=="function"&&(e.flags|=4194308),e.memoizedProps=n,e.memoizedState=c),o.props=n,o.state=c,o.context=l,n=a):(typeof o.componentDidMount=="function"&&(e.flags|=4194308),n=!1)}else{o=e.stateNode,BI(r,e),a=e.memoizedProps,l=e.type===e.elementType?a:qi(e.type,a),o.props=l,h=e.pendingProps,p=o.context,c=t.contextType,typeof c=="object"&&c!==null?c=yi(c):(c=vn(t)?Wc:$r.current,c=Ku(e,c));var m=t.getDerivedStateFromProps;(d=typeof m=="function"||typeof o.getSnapshotBeforeUpdate=="function")||typeof o.UNSAFE_componentWillReceiveProps!="function"&&typeof o.componentWillReceiveProps!="function"||(a!==h||p!==c)&&dk(e,o,n,c),Ea=!1,p=e.memoizedState,o.state=p,sg(e,n,o,i);var f=e.memoizedState;a!==h||p!==f||bn.current||Ea?(typeof m=="function"&&(A5(e,t,m,n),f=e.memoizedState),(l=Ea||lk(e,t,l,n,p,f,c)||!1)?(d||typeof o.UNSAFE_componentWillUpdate!="function"&&typeof o.componentWillUpdate!="function"||(typeof o.componentWillUpdate=="function"&&o.componentWillUpdate(n,f,c),typeof o.UNSAFE_componentWillUpdate=="function"&&o.UNSAFE_componentWillUpdate(n,f,c)),typeof o.componentDidUpdate=="function"&&(e.flags|=4),typeof o.getSnapshotBeforeUpdate=="function"&&(e.flags|=1024)):(typeof o.componentDidUpdate!="function"||a===r.memoizedProps&&p===r.memoizedState||(e.flags|=4),typeof o.getSnapshotBeforeUpdate!="function"||a===r.memoizedProps&&p===r.memoizedState||(e.flags|=1024),e.memoizedProps=n,e.memoizedState=f),o.props=n,o.state=f,o.context=c,n=l):(typeof o.componentDidUpdate!="function"||a===r.memoizedProps&&p===r.memoizedState||(e.flags|=4),typeof o.getSnapshotBeforeUpdate!="function"||a===r.memoizedProps&&p===r.memoizedState||(e.flags|=1024),n=!1)}return T5(r,e,t,n,s,i)}function T5(r,e,t,n,i,s){Ek(r,e);var o=(e.flags&128)!==0;if(!n&&!o)return i&&kI(e,t,!1),lo(r,e,s);n=e.stateNode,nG.current=e;var a=o&&typeof t.getDerivedStateFromError!="function"?null:n.render();return e.flags|=1,r!==null&&o?(e.child=Wu(e,r.child,null,s),e.child=Wu(e,null,a,s)):sn(r,e,a,s),e.memoizedState=n.state,i&&kI(e,t,!0),e.child}function xk(r){var e=r.stateNode;e.pendingContext?CI(r,e.pendingContext,e.pendingContext!==e.context):e.context&&CI(r,e.context,!1),h5(r,e.containerInfo)}function Ak(r,e,t,n,i){return qu(),s5(i),e.flags|=256,sn(r,e,t,n),e.child}var P5={dehydrated:null,treeContext:null,retryLane:0};function D5(r){return{baseLanes:r,cachePool:null,transitions:null}}function Ck(r,e,t){var n=e.pendingProps,i=Lt.current,s=!1,o=(e.flags&128)!==0,a;if((a=o)||(a=r!==null&&r.memoizedState===null?!1:(i&2)!==0),a?(s=!0,e.flags&=-129):(r===null||r.memoizedState!==null)&&(i|=1),Et(Lt,i&1),r===null)return i5(e),r=e.memoizedState,r!==null&&(r=r.dehydrated,r!==null)?(e.mode&1?r.data==="$!"?e.lanes=8:e.lanes=1073741824:e.lanes=1,null):(o=n.children,r=n.fallback,s?(n=e.mode,s=e.child,o={mode:"hidden",children:o},!(n&1)&&s!==null?(s.childLanes=0,s.pendingProps=o):s=Ig(o,n,0,null),r=nl(r,n,t,null),s.return=e,r.return=e,s.sibling=r,e.child=s,e.child.memoizedState=D5(t),e.memoizedState=P5,r):$5(e,o));if(i=r.memoizedState,i!==null&&(a=i.dehydrated,a!==null))return iG(r,e,o,n,a,i,t);if(s){s=n.fallback,o=e.mode,i=r.child,a=i.sibling;var c={mode:"hidden",children:n.children};return!(o&1)&&e.child!==i?(n=e.child,n.childLanes=0,n.pendingProps=c,e.deletions=null):(n=_a(i,c),n.subtreeFlags=i.subtreeFlags&14680064),a!==null?s=_a(a,s):(s=nl(s,o,t,null),s.flags|=2),s.return=e,n.return=e,n.sibling=s,e.child=n,n=s,s=e.child,o=r.child.memoizedState,o=o===null?D5(t):{baseLanes:o.baseLanes|t,cachePool:null,transitions:o.transitions},s.memoizedState=o,s.childLanes=r.childLanes&~t,e.memoizedState=P5,n}return s=r.child,r=s.sibling,n=_a(s,{mode:"visible",children:n.children}),!(e.mode&1)&&(n.lanes=t),n.return=e,n.sibling=null,r!==null&&(t=e.deletions,t===null?(e.deletions=[r],e.flags|=16):t.push(r)),e.child=n,e.memoizedState=null,n}function $5(r,e){return e=Ig({mode:"visible",children:e},r.mode,0,null),e.return=r,r.child=e}function fg(r,e,t,n){return n!==null&&s5(n),Wu(e,r.child,null,t),r=$5(e,e.pendingProps.children),r.flags|=2,e.memoizedState=null,r}function iG(r,e,t,n,i,s,o){if(t)return e.flags&256?(e.flags&=-257,n=I5(Error(ee(422))),fg(r,e,o,n)):e.memoizedState!==null?(e.child=r.child,e.flags|=128,null):(s=n.fallback,i=e.mode,n=Ig({mode:"visible",children:n.children},i,0,null),s=nl(s,i,o,null),s.flags|=2,n.return=e,s.return=e,n.sibling=s,e.child=n,e.mode&1&&Wu(e,r.child,null,o),e.child.memoizedState=D5(o),e.memoizedState=P5,s);if(!(e.mode&1))return fg(r,e,o,null);if(i.data==="$!"){if(n=i.nextSibling&&i.nextSibling.dataset,n)var a=n.dgst;return n=a,s=Error(ee(419)),n=I5(s,n,void 0),fg(r,e,o,n)}if(a=(o&r.childLanes)!==0,En||a){if(n=lr,n!==null){switch(o&-o){case 4:i=2;break;case 16:i=8;break;case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:i=32;break;case 536870912:i=268435456;break;default:i=0}i=i&(n.suspendedLanes|o)?0:i,i!==0&&i!==s.retryLane&&(s.retryLane=i,ao(r,i),Qi(n,r,i,-1))}return G5(),n=I5(Error(ee(421))),fg(r,e,o,n)}return i.data==="$?"?(e.flags|=128,e.child=r.child,e=mG.bind(null,r),i._reactRetry=e,null):(r=s.treeContext,qn=ma(i.nextSibling),Hn=e,Nt=!0,Hi=null,r!==null&&(pi[gi++]=so,pi[gi++]=oo,pi[gi++]=Gc,so=r.id,oo=r.overflow,Gc=e),e=$5(e,n.children),e.flags|=4096,e)}function Ik(r,e,t){r.lanes|=e;var n=r.alternate;n!==null&&(n.lanes|=e),l5(r.return,e,t)}function N5(r,e,t,n,i){var s=r.memoizedState;s===null?r.memoizedState={isBackwards:e,rendering:null,renderingStartTime:0,last:n,tail:t,tailMode:i}:(s.isBackwards=e,s.rendering=null,s.renderingStartTime=0,s.last=n,s.tail=t,s.tailMode=i)}function kk(r,e,t){var n=e.pendingProps,i=n.revealOrder,s=n.tail;if(sn(r,e,n.children,t),n=Lt.current,n&2)n=n&1|2,e.flags|=128;else{if(r!==null&&r.flags&128)e:for(r=e.child;r!==null;){if(r.tag===13)r.memoizedState!==null&&Ik(r,t,e);else if(r.tag===19)Ik(r,t,e);else if(r.child!==null){r.child.return=r,r=r.child;continue}if(r===e)break e;for(;r.sibling===null;){if(r.return===null||r.return===e)break e;r=r.return}r.sibling.return=r.return,r=r.sibling}n&=1}if(Et(Lt,n),!(e.mode&1))e.memoizedState=null;else switch(i){case"forwards":for(t=e.child,i=null;t!==null;)r=t.alternate,r!==null&&og(r)===null&&(i=t),t=t.sibling;t=i,t===null?(i=e.child,e.child=null):(i=t.sibling,t.sibling=null),N5(e,!1,i,t,s);break;case"backwards":for(t=null,i=e.child,e.child=null;i!==null;){if(r=i.alternate,r!==null&&og(r)===null){e.child=i;break}r=i.sibling,i.sibling=t,t=i,i=r}N5(e,!0,t,null,s);break;case"together":N5(e,!1,null,null,void 0);break;default:e.memoizedState=null}return e.child}function pg(r,e){!(e.mode&1)&&r!==null&&(r.alternate=null,e.alternate=null,e.flags|=2)}function lo(r,e,t){if(r!==null&&(e.dependencies=r.dependencies),Zc|=e.lanes,!(t&e.childLanes))return null;if(r!==null&&e.child!==r.child)throw Error(ee(153));if(e.child!==null){for(r=e.child,t=_a(r,r.pendingProps),e.child=t,t.return=e;r.sibling!==null;)r=r.sibling,t=t.sibling=_a(r,r.pendingProps),t.return=e;t.sibling=null}return e.child}function sG(r,e,t){switch(e.tag){case 3:xk(e),qu();break;case 5:zI(e);break;case 1:vn(e.type)&&Y0(e);break;case 4:h5(e,e.stateNode.containerInfo);break;case 10:var n=e.type._context,i=e.memoizedProps.value;Et(rg,n._currentValue),n._currentValue=i;break;case 13:if(n=e.memoizedState,n!==null)return n.dehydrated!==null?(Et(Lt,Lt.current&1),e.flags|=128,null):t&e.child.childLanes?Ck(r,e,t):(Et(Lt,Lt.current&1),r=lo(r,e,t),r!==null?r.sibling:null);Et(Lt,Lt.current&1);break;case 19:if(n=(t&e.childLanes)!==0,r.flags&128){if(n)return kk(r,e,t);e.flags|=128}if(i=e.memoizedState,i!==null&&(i.rendering=null,i.tail=null,i.lastEffect=null),Et(Lt,Lt.current),n)break;return null;case 22:case 23:return e.lanes=0,vk(r,e,t)}return lo(r,e,t)}var _k,M5,Tk,Pk;_k=function(r,e){for(var t=e.child;t!==null;){if(t.tag===5||t.tag===6)r.appendChild(t.stateNode);else if(t.tag!==4&&t.child!==null){t.child.return=t,t=t.child;continue}if(t===e)break;for(;t.sibling===null;){if(t.return===null||t.return===e)return;t=t.return}t.sibling.return=t.return,t=t.sibling}},M5=function(){},Tk=function(r,e,t,n){var i=r.memoizedProps;if(i!==n){r=e.stateNode,Jc(Es.current);var s=null;switch(t){case"input":i=l8(r,i),n=l8(r,n),s=[];break;case"select":i=Rt({},i,{value:void 0}),n=Rt({},n,{value:void 0}),s=[];break;case"textarea":i=h8(r,i),n=h8(r,n),s=[];break;default:typeof i.onClick!="function"&&typeof n.onClick=="function"&&(r.onclick=W0)}p8(t,n);var o;t=null;for(l in i)if(!n.hasOwnProperty(l)&&i.hasOwnProperty(l)&&i[l]!=null)if(l==="style"){var a=i[l];for(o in a)a.hasOwnProperty(o)&&(t||(t={}),t[o]="")}else l!=="dangerouslySetInnerHTML"&&l!=="children"&&l!=="suppressContentEditableWarning"&&l!=="suppressHydrationWarning"&&l!=="autoFocus"&&(tf.hasOwnProperty(l)?s||(s=[]):(s=s||[]).push(l,null));for(l in n){var c=n[l];if(a=i!=null?i[l]:void 0,n.hasOwnProperty(l)&&c!==a&&(c!=null||a!=null))if(l==="style")if(a){for(o in a)!a.hasOwnProperty(o)||c&&c.hasOwnProperty(o)||(t||(t={}),t[o]="");for(o in c)c.hasOwnProperty(o)&&a[o]!==c[o]&&(t||(t={}),t[o]=c[o])}else t||(s||(s=[]),s.push(l,t)),t=c;else l==="dangerouslySetInnerHTML"?(c=c?c.__html:void 0,a=a?a.__html:void 0,c!=null&&a!==c&&(s=s||[]).push(l,c)):l==="children"?typeof c!="string"&&typeof c!="number"||(s=s||[]).push(l,""+c):l!=="suppressContentEditableWarning"&&l!=="suppressHydrationWarning"&&(tf.hasOwnProperty(l)?(c!=null&&l==="onScroll"&&Tt("scroll",r),s||a===c||(s=[])):(s=s||[]).push(l,c))}t&&(s=s||[]).push("style",t);var l=s;(e.updateQueue=l)&&(e.flags|=4)}},Pk=function(r,e,t,n){t!==n&&(e.flags|=4)};function Bf(r,e){if(!Nt)switch(r.tailMode){case"hidden":e=r.tail;for(var t=null;e!==null;)e.alternate!==null&&(t=e),e=e.sibling;t===null?r.tail=null:t.sibling=null;break;case"collapsed":t=r.tail;for(var n=null;t!==null;)t.alternate!==null&&(n=t),t=t.sibling;n===null?e||r.tail===null?r.tail=null:r.tail.sibling=null:n.sibling=null}}function Mr(r){var e=r.alternate!==null&&r.alternate.child===r.child,t=0,n=0;if(e)for(var i=r.child;i!==null;)t|=i.lanes|i.childLanes,n|=i.subtreeFlags&14680064,n|=i.flags&14680064,i.return=r,i=i.sibling;else for(i=r.child;i!==null;)t|=i.lanes|i.childLanes,n|=i.subtreeFlags,n|=i.flags,i.return=r,i=i.sibling;return r.subtreeFlags|=n,r.childLanes=t,e}function oG(r,e,t){var n=e.pendingProps;switch(r5(e),e.tag){case 2:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return Mr(e),null;case 1:return vn(e.type)&&Q0(),Mr(e),null;case 3:return n=e.stateNode,Yu(),Pt(bn),Pt($r),g5(),n.pendingContext&&(n.context=n.pendingContext,n.pendingContext=null),(r===null||r.child===null)&&(eg(e)?e.flags|=4:r===null||r.memoizedState.isDehydrated&&!(e.flags&256)||(e.flags|=1024,Hi!==null&&(H5(Hi),Hi=null))),M5(r,e),Mr(e),null;case 5:f5(e);var i=Jc(Nf.current);if(t=e.type,r!==null&&e.stateNode!=null)Tk(r,e,t,n,i),r.ref!==e.ref&&(e.flags|=512,e.flags|=2097152);else{if(!n){if(e.stateNode===null)throw Error(ee(166));return Mr(e),null}if(r=Jc(Es.current),eg(e)){n=e.stateNode,t=e.type;var s=e.memoizedProps;switch(n[vs]=e,n[_f]=s,r=(e.mode&1)!==0,t){case"dialog":Tt("cancel",n),Tt("close",n);break;case"iframe":case"object":case"embed":Tt("load",n);break;case"video":case"audio":for(i=0;i<Cf.length;i++)Tt(Cf[i],n);break;case"source":Tt("error",n);break;case"img":case"image":case"link":Tt("error",n),Tt("load",n);break;case"details":Tt("toggle",n);break;case"input":uC(n,s),Tt("invalid",n);break;case"select":n._wrapperState={wasMultiple:!!s.multiple},Tt("invalid",n);break;case"textarea":fC(n,s),Tt("invalid",n)}p8(t,s),i=null;for(var o in s)if(s.hasOwnProperty(o)){var a=s[o];o==="children"?typeof a=="string"?n.textContent!==a&&(s.suppressHydrationWarning!==!0&&q0(n.textContent,a,r),i=["children",a]):typeof a=="number"&&n.textContent!==""+a&&(s.suppressHydrationWarning!==!0&&q0(n.textContent,a,r),i=["children",""+a]):tf.hasOwnProperty(o)&&a!=null&&o==="onScroll"&&Tt("scroll",n)}switch(t){case"input":x0(n),hC(n,s,!0);break;case"textarea":x0(n),gC(n);break;case"select":case"option":break;default:typeof s.onClick=="function"&&(n.onclick=W0)}n=i,e.updateQueue=n,n!==null&&(e.flags|=4)}else{o=i.nodeType===9?i:i.ownerDocument,r==="http://www.w3.org/1999/xhtml"&&(r=yC(t)),r==="http://www.w3.org/1999/xhtml"?t==="script"?(r=o.createElement("div"),r.innerHTML="<script><\/script>",r=r.removeChild(r.firstChild)):typeof n.is=="string"?r=o.createElement(t,{is:n.is}):(r=o.createElement(t),t==="select"&&(o=r,n.multiple?o.multiple=!0:n.size&&(o.size=n.size))):r=o.createElementNS(r,t),r[vs]=e,r[_f]=n,_k(r,e,!1,!1),e.stateNode=r;e:{switch(o=g8(t,n),t){case"dialog":Tt("cancel",r),Tt("close",r),i=n;break;case"iframe":case"object":case"embed":Tt("load",r),i=n;break;case"video":case"audio":for(i=0;i<Cf.length;i++)Tt(Cf[i],r);i=n;break;case"source":Tt("error",r),i=n;break;case"img":case"image":case"link":Tt("error",r),Tt("load",r),i=n;break;case"details":Tt("toggle",r),i=n;break;case"input":uC(r,n),i=l8(r,n),Tt("invalid",r);break;case"option":i=n;break;case"select":r._wrapperState={wasMultiple:!!n.multiple},i=Rt({},n,{value:void 0}),Tt("invalid",r);break;case"textarea":fC(r,n),i=h8(r,n),Tt("invalid",r);break;default:i=n}p8(t,i),a=i;for(s in a)if(a.hasOwnProperty(s)){var c=a[s];s==="style"?bC(r,c):s==="dangerouslySetInnerHTML"?(c=c?c.__html:void 0,c!=null&&mC(r,c)):s==="children"?typeof c=="string"?(t!=="textarea"||c!=="")&&of(r,c):typeof c=="number"&&of(r,""+c):s!=="suppressContentEditableWarning"&&s!=="suppressHydrationWarning"&&s!=="autoFocus"&&(tf.hasOwnProperty(s)?c!=null&&s==="onScroll"&&Tt("scroll",r):c!=null&&X4(r,s,c,o))}switch(t){case"input":x0(r),hC(r,n,!1);break;case"textarea":x0(r),gC(r);break;case"option":n.value!=null&&r.setAttribute("value",""+ua(n.value));break;case"select":r.multiple=!!n.multiple,s=n.value,s!=null?Du(r,!!n.multiple,s,!1):n.defaultValue!=null&&Du(r,!!n.multiple,n.defaultValue,!0);break;default:typeof i.onClick=="function"&&(r.onclick=W0)}switch(t){case"button":case"input":case"select":case"textarea":n=!!n.autoFocus;break e;case"img":n=!0;break e;default:n=!1}}n&&(e.flags|=4)}e.ref!==null&&(e.flags|=512,e.flags|=2097152)}return Mr(e),null;case 6:if(r&&e.stateNode!=null)Pk(r,e,r.memoizedProps,n);else{if(typeof n!="string"&&e.stateNode===null)throw Error(ee(166));if(t=Jc(Nf.current),Jc(Es.current),eg(e)){if(n=e.stateNode,t=e.memoizedProps,n[vs]=e,(s=n.nodeValue!==t)&&(r=Hn,r!==null))switch(r.tag){case 3:q0(n.nodeValue,t,(r.mode&1)!==0);break;case 5:r.memoizedProps.suppressHydrationWarning!==!0&&q0(n.nodeValue,t,(r.mode&1)!==0)}s&&(e.flags|=4)}else n=(t.nodeType===9?t:t.ownerDocument).createTextNode(n),n[vs]=e,e.stateNode=n}return Mr(e),null;case 13:if(Pt(Lt),n=e.memoizedState,r===null||r.memoizedState!==null&&r.memoizedState.dehydrated!==null){if(Nt&&qn!==null&&e.mode&1&&!(e.flags&128))NI(),qu(),e.flags|=98560,s=!1;else if(s=eg(e),n!==null&&n.dehydrated!==null){if(r===null){if(!s)throw Error(ee(318));if(s=e.memoizedState,s=s!==null?s.dehydrated:null,!s)throw Error(ee(317));s[vs]=e}else qu(),!(e.flags&128)&&(e.memoizedState=null),e.flags|=4;Mr(e),s=!1}else Hi!==null&&(H5(Hi),Hi=null),s=!0;if(!s)return e.flags&65536?e:null}return e.flags&128?(e.lanes=t,e):(n=n!==null,n!==(r!==null&&r.memoizedState!==null)&&n&&(e.child.flags|=8192,e.mode&1&&(r===null||Lt.current&1?ir===0&&(ir=3):G5())),e.updateQueue!==null&&(e.flags|=4),Mr(e),null);case 4:return Yu(),M5(r,e),r===null&&If(e.stateNode.containerInfo),Mr(e),null;case 10:return c5(e.type._context),Mr(e),null;case 17:return vn(e.type)&&Q0(),Mr(e),null;case 19:if(Pt(Lt),s=e.memoizedState,s===null)return Mr(e),null;if(n=(e.flags&128)!==0,o=s.rendering,o===null)if(n)Bf(s,!1);else{if(ir!==0||r!==null&&r.flags&128)for(r=e.child;r!==null;){if(o=og(r),o!==null){for(e.flags|=128,Bf(s,!1),n=o.updateQueue,n!==null&&(e.updateQueue=n,e.flags|=4),e.subtreeFlags=0,n=t,t=e.child;t!==null;)s=t,r=n,s.flags&=14680066,o=s.alternate,o===null?(s.childLanes=0,s.lanes=r,s.child=null,s.subtreeFlags=0,s.memoizedProps=null,s.memoizedState=null,s.updateQueue=null,s.dependencies=null,s.stateNode=null):(s.childLanes=o.childLanes,s.lanes=o.lanes,s.child=o.child,s.subtreeFlags=0,s.deletions=null,s.memoizedProps=o.memoizedProps,s.memoizedState=o.memoizedState,s.updateQueue=o.updateQueue,s.type=o.type,r=o.dependencies,s.dependencies=r===null?null:{lanes:r.lanes,firstContext:r.firstContext}),t=t.sibling;return Et(Lt,Lt.current&1|2),e.child}r=r.sibling}s.tail!==null&&Wt()>ed&&(e.flags|=128,n=!0,Bf(s,!1),e.lanes=4194304)}else{if(!n)if(r=og(o),r!==null){if(e.flags|=128,n=!0,t=r.updateQueue,t!==null&&(e.updateQueue=t,e.flags|=4),Bf(s,!0),s.tail===null&&s.tailMode==="hidden"&&!o.alternate&&!Nt)return Mr(e),null}else 2*Wt()-s.renderingStartTime>ed&&t!==1073741824&&(e.flags|=128,n=!0,Bf(s,!1),e.lanes=4194304);s.isBackwards?(o.sibling=e.child,e.child=o):(t=s.last,t!==null?t.sibling=o:e.child=o,s.last=o)}return s.tail!==null?(e=s.tail,s.rendering=e,s.tail=e.sibling,s.renderingStartTime=Wt(),e.sibling=null,t=Lt.current,Et(Lt,n?t&1|2:t&1),e):(Mr(e),null);case 22:case 23:return W5(),n=e.memoizedState!==null,r!==null&&r.memoizedState!==null!==n&&(e.flags|=8192),n&&e.mode&1?Wn&1073741824&&(Mr(e),e.subtreeFlags&6&&(e.flags|=8192)):Mr(e),null;case 24:return null;case 25:return null}throw Error(ee(156,e.tag))}function aG(r,e){switch(r5(e),e.tag){case 1:return vn(e.type)&&Q0(),r=e.flags,r&65536?(e.flags=r&-65537|128,e):null;case 3:return Yu(),Pt(bn),Pt($r),g5(),r=e.flags,r&65536&&!(r&128)?(e.flags=r&-65537|128,e):null;case 5:return f5(e),null;case 13:if(Pt(Lt),r=e.memoizedState,r!==null&&r.dehydrated!==null){if(e.alternate===null)throw Error(ee(340));qu()}return r=e.flags,r&65536?(e.flags=r&-65537|128,e):null;case 19:return Pt(Lt),null;case 4:return Yu(),null;case 10:return c5(e.type._context),null;case 22:case 23:return W5(),null;case 24:return null;default:return null}}var gg=!1,Or=!1,cG=typeof WeakSet=="function"?WeakSet:Set,we=null;function Xu(r,e){var t=r.ref;if(t!==null)if(typeof t=="function")try{t(null)}catch(n){jt(r,e,n)}else t.current=null}function O5(r,e,t){try{t()}catch(n){jt(r,e,n)}}var Dk=!1;function lG(r,e){if(W8=O0,r=lI(),U8(r)){if("selectionStart"in r)var t={start:r.selectionStart,end:r.selectionEnd};else e:{t=(t=r.ownerDocument)&&t.defaultView||window;var n=t.getSelection&&t.getSelection();if(n&&n.rangeCount!==0){t=n.anchorNode;var i=n.anchorOffset,s=n.focusNode;n=n.focusOffset;try{t.nodeType,s.nodeType}catch{t=null;break e}var o=0,a=-1,c=-1,l=0,d=0,h=r,p=null;t:for(;;){for(var m;h!==t||i!==0&&h.nodeType!==3||(a=o+i),h!==s||n!==0&&h.nodeType!==3||(c=o+n),h.nodeType===3&&(o+=h.nodeValue.length),(m=h.firstChild)!==null;)p=h,h=m;for(;;){if(h===r)break t;if(p===t&&++l===i&&(a=o),p===s&&++d===n&&(c=o),(m=h.nextSibling)!==null)break;h=p,p=h.parentNode}h=m}t=a===-1||c===-1?null:{start:a,end:c}}else t=null}t=t||{start:0,end:0}}else t=null;for(G8={focusedElem:r,selectionRange:t},O0=!1,we=e;we!==null;)if(e=we,r=e.child,(e.subtreeFlags&1028)!==0&&r!==null)r.return=e,we=r;else for(;we!==null;){e=we;try{var f=e.alternate;if(e.flags&1024)switch(e.tag){case 0:case 11:case 15:break;case 1:if(f!==null){var g=f.memoizedProps,w=f.memoizedState,y=e.stateNode,b=y.getSnapshotBeforeUpdate(e.elementType===e.type?g:qi(e.type,g),w);y.__reactInternalSnapshotBeforeUpdate=b}break;case 3:var v=e.stateNode.containerInfo;v.nodeType===1?v.textContent="":v.nodeType===9&&v.documentElement&&v.removeChild(v.documentElement);break;case 5:case 6:case 4:case 17:break;default:throw Error(ee(163))}}catch(E){jt(e,e.return,E)}if(r=e.sibling,r!==null){r.return=e.return,we=r;break}we=e.return}return f=Dk,Dk=!1,f}function Uf(r,e,t){var n=e.updateQueue;if(n=n!==null?n.lastEffect:null,n!==null){var i=n=n.next;do{if((i.tag&r)===r){var s=i.destroy;i.destroy=void 0,s!==void 0&&O5(e,t,s)}i=i.next}while(i!==n)}}function yg(r,e){if(e=e.updateQueue,e=e!==null?e.lastEffect:null,e!==null){var t=e=e.next;do{if((t.tag&r)===r){var n=t.create;t.destroy=n()}t=t.next}while(t!==e)}}function R5(r){var e=r.ref;if(e!==null){var t=r.stateNode;switch(r.tag){case 5:r=t;break;default:r=t}typeof e=="function"?e(r):e.current=r}}function $k(r){var e=r.alternate;e!==null&&(r.alternate=null,$k(e)),r.child=null,r.deletions=null,r.sibling=null,r.tag===5&&(e=r.stateNode,e!==null&&(delete e[vs],delete e[_f],delete e[X8],delete e[HW],delete e[qW])),r.stateNode=null,r.return=null,r.dependencies=null,r.memoizedProps=null,r.memoizedState=null,r.pendingProps=null,r.stateNode=null,r.updateQueue=null}function Nk(r){return r.tag===5||r.tag===3||r.tag===4}function Mk(r){e:for(;;){for(;r.sibling===null;){if(r.return===null||Nk(r.return))return null;r=r.return}for(r.sibling.return=r.return,r=r.sibling;r.tag!==5&&r.tag!==6&&r.tag!==18;){if(r.flags&2||r.child===null||r.tag===4)continue e;r.child.return=r,r=r.child}if(!(r.flags&2))return r.stateNode}}function L5(r,e,t){var n=r.tag;if(n===5||n===6)r=r.stateNode,e?t.nodeType===8?t.parentNode.insertBefore(r,e):t.insertBefore(r,e):(t.nodeType===8?(e=t.parentNode,e.insertBefore(r,t)):(e=t,e.appendChild(r)),t=t._reactRootContainer,t!=null||e.onclick!==null||(e.onclick=W0));else if(n!==4&&(r=r.child,r!==null))for(L5(r,e,t),r=r.sibling;r!==null;)L5(r,e,t),r=r.sibling}function B5(r,e,t){var n=r.tag;if(n===5||n===6)r=r.stateNode,e?t.insertBefore(r,e):t.appendChild(r);else if(n!==4&&(r=r.child,r!==null))for(B5(r,e,t),r=r.sibling;r!==null;)B5(r,e,t),r=r.sibling}var mr=null,Wi=!1;function xa(r,e,t){for(t=t.child;t!==null;)Ok(r,e,t),t=t.sibling}function Ok(r,e,t){if(bs&&typeof bs.onCommitFiberUnmount=="function")try{bs.onCommitFiberUnmount(T0,t)}catch{}switch(t.tag){case 5:Or||Xu(t,e);case 6:var n=mr,i=Wi;mr=null,xa(r,e,t),mr=n,Wi=i,mr!==null&&(Wi?(r=mr,t=t.stateNode,r.nodeType===8?r.parentNode.removeChild(t):r.removeChild(t)):mr.removeChild(t.stateNode));break;case 18:mr!==null&&(Wi?(r=mr,t=t.stateNode,r.nodeType===8?J8(r.parentNode,t):r.nodeType===1&&J8(r,t),mf(r)):J8(mr,t.stateNode));break;case 4:n=mr,i=Wi,mr=t.stateNode.containerInfo,Wi=!0,xa(r,e,t),mr=n,Wi=i;break;case 0:case 11:case 14:case 15:if(!Or&&(n=t.updateQueue,n!==null&&(n=n.lastEffect,n!==null))){i=n=n.next;do{var s=i,o=s.destroy;s=s.tag,o!==void 0&&(s&2||s&4)&&O5(t,e,o),i=i.next}while(i!==n)}xa(r,e,t);break;case 1:if(!Or&&(Xu(t,e),n=t.stateNode,typeof n.componentWillUnmount=="function"))try{n.props=t.memoizedProps,n.state=t.memoizedState,n.componentWillUnmount()}catch(a){jt(t,e,a)}xa(r,e,t);break;case 21:xa(r,e,t);break;case 22:t.mode&1?(Or=(n=Or)||t.memoizedState!==null,xa(r,e,t),Or=n):xa(r,e,t);break;default:xa(r,e,t)}}function Rk(r){var e=r.updateQueue;if(e!==null){r.updateQueue=null;var t=r.stateNode;t===null&&(t=r.stateNode=new cG),e.forEach(function(n){var i=wG.bind(null,r,n);t.has(n)||(t.add(n),n.then(i,i))})}}function Gi(r,e){var t=e.deletions;if(t!==null)for(var n=0;n<t.length;n++){var i=t[n];try{var s=r,o=e,a=o;e:for(;a!==null;){switch(a.tag){case 5:mr=a.stateNode,Wi=!1;break e;case 3:mr=a.stateNode.containerInfo,Wi=!0;break e;case 4:mr=a.stateNode.containerInfo,Wi=!0;break e}a=a.return}if(mr===null)throw Error(ee(160));Ok(s,o,i),mr=null,Wi=!1;var c=i.alternate;c!==null&&(c.return=null),i.return=null}catch(l){jt(i,e,l)}}if(e.subtreeFlags&12854)for(e=e.child;e!==null;)Lk(e,r),e=e.sibling}function Lk(r,e){var t=r.alternate,n=r.flags;switch(r.tag){case 0:case 11:case 14:case 15:if(Gi(e,r),xs(r),n&4){try{Uf(3,r,r.return),yg(3,r)}catch(g){jt(r,r.return,g)}try{Uf(5,r,r.return)}catch(g){jt(r,r.return,g)}}break;case 1:Gi(e,r),xs(r),n&512&&t!==null&&Xu(t,t.return);break;case 5:if(Gi(e,r),xs(r),n&512&&t!==null&&Xu(t,t.return),r.flags&32){var i=r.stateNode;try{of(i,"")}catch(g){jt(r,r.return,g)}}if(n&4&&(i=r.stateNode,i!=null)){var s=r.memoizedProps,o=t!==null?t.memoizedProps:s,a=r.type,c=r.updateQueue;if(r.updateQueue=null,c!==null)try{a==="input"&&s.type==="radio"&&s.name!=null&&dC(i,s),g8(a,o);var l=g8(a,s);for(o=0;o<c.length;o+=2){var d=c[o],h=c[o+1];d==="style"?bC(i,h):d==="dangerouslySetInnerHTML"?mC(i,h):d==="children"?of(i,h):X4(i,d,h,l)}switch(a){case"input":u8(i,s);break;case"textarea":pC(i,s);break;case"select":var p=i._wrapperState.wasMultiple;i._wrapperState.wasMultiple=!!s.multiple;var m=s.value;m!=null?Du(i,!!s.multiple,m,!1):p!==!!s.multiple&&(s.defaultValue!=null?Du(i,!!s.multiple,s.defaultValue,!0):Du(i,!!s.multiple,s.multiple?[]:"",!1))}i[_f]=s}catch(g){jt(r,r.return,g)}}break;case 6:if(Gi(e,r),xs(r),n&4){if(r.stateNode===null)throw Error(ee(162));i=r.stateNode,s=r.memoizedProps;try{i.nodeValue=s}catch(g){jt(r,r.return,g)}}break;case 3:if(Gi(e,r),xs(r),n&4&&t!==null&&t.memoizedState.isDehydrated)try{mf(e.containerInfo)}catch(g){jt(r,r.return,g)}break;case 4:Gi(e,r),xs(r);break;case 13:Gi(e,r),xs(r),i=r.child,i.flags&8192&&(s=i.memoizedState!==null,i.stateNode.isHidden=s,!s||i.alternate!==null&&i.alternate.memoizedState!==null||(z5=Wt())),n&4&&Rk(r);break;case 22:if(d=t!==null&&t.memoizedState!==null,r.mode&1?(Or=(l=Or)||d,Gi(e,r),Or=l):Gi(e,r),xs(r),n&8192){if(l=r.memoizedState!==null,(r.stateNode.isHidden=l)&&!d&&r.mode&1)for(we=r,d=r.child;d!==null;){for(h=we=d;we!==null;){switch(p=we,m=p.child,p.tag){case 0:case 11:case 14:case 15:Uf(4,p,p.return);break;case 1:Xu(p,p.return);var f=p.stateNode;if(typeof f.componentWillUnmount=="function"){n=p,t=p.return;try{e=n,f.props=e.memoizedProps,f.state=e.memoizedState,f.componentWillUnmount()}catch(g){jt(n,t,g)}}break;case 5:Xu(p,p.return);break;case 22:if(p.memoizedState!==null){Fk(h);continue}}m!==null?(m.return=p,we=m):Fk(h)}d=d.sibling}e:for(d=null,h=r;;){if(h.tag===5){if(d===null){d=h;try{i=h.stateNode,l?(s=i.style,typeof s.setProperty=="function"?s.setProperty("display","none","important"):s.display="none"):(a=h.stateNode,c=h.memoizedProps.style,o=c!=null&&c.hasOwnProperty("display")?c.display:null,a.style.display=wC("display",o))}catch(g){jt(r,r.return,g)}}}else if(h.tag===6){if(d===null)try{h.stateNode.nodeValue=l?"":h.memoizedProps}catch(g){jt(r,r.return,g)}}else if((h.tag!==22&&h.tag!==23||h.memoizedState===null||h===r)&&h.child!==null){h.child.return=h,h=h.child;continue}if(h===r)break e;for(;h.sibling===null;){if(h.return===null||h.return===r)break e;d===h&&(d=null),h=h.return}d===h&&(d=null),h.sibling.return=h.return,h=h.sibling}}break;case 19:Gi(e,r),xs(r),n&4&&Rk(r);break;case 21:break;default:Gi(e,r),xs(r)}}function xs(r){var e=r.flags;if(e&2){try{e:{for(var t=r.return;t!==null;){if(Nk(t)){var n=t;break e}t=t.return}throw Error(ee(160))}switch(n.tag){case 5:var i=n.stateNode;n.flags&32&&(of(i,""),n.flags&=-33);var s=Mk(r);B5(r,s,i);break;case 3:case 4:var o=n.stateNode.containerInfo,a=Mk(r);L5(r,a,o);break;default:throw Error(ee(161))}}catch(c){jt(r,r.return,c)}r.flags&=-3}e&4096&&(r.flags&=-4097)}function uG(r,e,t){we=r,Bk(r)}function Bk(r,e,t){for(var n=(r.mode&1)!==0;we!==null;){var i=we,s=i.child;if(i.tag===22&&n){var o=i.memoizedState!==null||gg;if(!o){var a=i.alternate,c=a!==null&&a.memoizedState!==null||Or;a=gg;var l=Or;if(gg=o,(Or=c)&&!l)for(we=i;we!==null;)o=we,c=o.child,o.tag===22&&o.memoizedState!==null?zk(i):c!==null?(c.return=o,we=c):zk(i);for(;s!==null;)we=s,Bk(s),s=s.sibling;we=i,gg=a,Or=l}Uk(r)}else i.subtreeFlags&8772&&s!==null?(s.return=i,we=s):Uk(r)}}function Uk(r){for(;we!==null;){var e=we;if(e.flags&8772){var t=e.alternate;try{if(e.flags&8772)switch(e.tag){case 0:case 11:case 15:Or||yg(5,e);break;case 1:var n=e.stateNode;if(e.flags&4&&!Or)if(t===null)n.componentDidMount();else{var i=e.elementType===e.type?t.memoizedProps:qi(e.type,t.memoizedProps);n.componentDidUpdate(i,t.memoizedState,n.__reactInternalSnapshotBeforeUpdate)}var s=e.updateQueue;s!==null&&FI(e,s,n);break;case 3:var o=e.updateQueue;if(o!==null){if(t=null,e.child!==null)switch(e.child.tag){case 5:t=e.child.stateNode;break;case 1:t=e.child.stateNode}FI(e,o,t)}break;case 5:var a=e.stateNode;if(t===null&&e.flags&4){t=a;var c=e.memoizedProps;switch(e.type){case"button":case"input":case"select":case"textarea":c.autoFocus&&t.focus();break;case"img":c.src&&(t.src=c.src)}}break;case 6:break;case 4:break;case 12:break;case 13:if(e.memoizedState===null){var l=e.alternate;if(l!==null){var d=l.memoizedState;if(d!==null){var h=d.dehydrated;h!==null&&mf(h)}}}break;case 19:case 17:case 21:case 22:case 23:case 25:break;default:throw Error(ee(163))}Or||e.flags&512&&R5(e)}catch(p){jt(e,e.return,p)}}if(e===r){we=null;break}if(t=e.sibling,t!==null){t.return=e.return,we=t;break}we=e.return}}function Fk(r){for(;we!==null;){var e=we;if(e===r){we=null;break}var t=e.sibling;if(t!==null){t.return=e.return,we=t;break}we=e.return}}function zk(r){for(;we!==null;){var e=we;try{switch(e.tag){case 0:case 11:case 15:var t=e.return;try{yg(4,e)}catch(c){jt(e,t,c)}break;case 1:var n=e.stateNode;if(typeof n.componentDidMount=="function"){var i=e.return;try{n.componentDidMount()}catch(c){jt(e,i,c)}}var s=e.return;try{R5(e)}catch(c){jt(e,s,c)}break;case 5:var o=e.return;try{R5(e)}catch(c){jt(e,o,c)}}}catch(c){jt(e,e.return,c)}if(e===r){we=null;break}var a=e.sibling;if(a!==null){a.return=e.return,we=a;break}we=e.return}}var dG=Math.ceil,mg=ro.ReactCurrentDispatcher,U5=ro.ReactCurrentOwner,wi=ro.ReactCurrentBatchConfig,et=0,lr=null,Xt=null,wr=0,Wn=0,Zu=wa(0),ir=0,Ff=null,Zc=0,wg=0,F5=0,zf=null,Sn=null,z5=0,ed=1/0,uo=null,bg=!1,V5=null,Aa=null,vg=!1,Ca=null,Eg=0,Vf=0,K5=null,Sg=-1,xg=0;function on(){return et&6?Wt():Sg!==-1?Sg:Sg=Wt()}function Ia(r){return r.mode&1?et&2&&wr!==0?wr&-wr:GW.transition!==null?(xg===0&&(xg=MC()),xg):(r=ht,r!==0||(r=window.event,r=r===void 0?16:KC(r.type)),r):1}function Qi(r,e,t,n){if(50<Vf)throw Vf=0,K5=null,Error(ee(185));hf(r,t,n),(!(et&2)||r!==lr)&&(r===lr&&(!(et&2)&&(wg|=t),ir===4&&ka(r,wr)),xn(r,n),t===1&&et===0&&!(e.mode&1)&&(ed=Wt()+500,J0&&va()))}function xn(r,e){var t=r.callbackNode;Gq(r,e);var n=$0(r,r===lr?wr:0);if(n===0)t!==null&&DC(t),r.callbackNode=null,r.callbackPriority=0;else if(e=n&-n,r.callbackPriority!==e){if(t!=null&&DC(t),e===1)r.tag===0?WW(Kk.bind(null,r)):_I(Kk.bind(null,r)),KW(function(){!(et&6)&&va()}),t=null;else{switch(OC(n)){case 1:t=S8;break;case 4:t=$C;break;case 16:t=_0;break;case 536870912:t=NC;break;default:t=_0}t=Jk(t,Vk.bind(null,r))}r.callbackPriority=e,r.callbackNode=t}}function Vk(r,e){if(Sg=-1,xg=0,et&6)throw Error(ee(327));var t=r.callbackNode;if(td()&&r.callbackNode!==t)return null;var n=$0(r,r===lr?wr:0);if(n===0)return null;if(n&30||n&r.expiredLanes||e)e=Ag(r,n);else{e=n;var i=et;et|=2;var s=Hk();(lr!==r||wr!==e)&&(uo=null,ed=Wt()+500,tl(r,e));do try{pG();break}catch(a){jk(r,a)}while(!0);a5(),mg.current=s,et=i,Xt!==null?e=0:(lr=null,wr=0,e=ir)}if(e!==0){if(e===2&&(i=x8(r),i!==0&&(n=i,e=j5(r,i))),e===1)throw t=Ff,tl(r,0),ka(r,n),xn(r,Wt()),t;if(e===6)ka(r,n);else{if(i=r.current.alternate,!(n&30)&&!hG(i)&&(e=Ag(r,n),e===2&&(s=x8(r),s!==0&&(n=s,e=j5(r,s))),e===1))throw t=Ff,tl(r,0),ka(r,n),xn(r,Wt()),t;switch(r.finishedWork=i,r.finishedLanes=n,e){case 0:case 1:throw Error(ee(345));case 2:rl(r,Sn,uo);break;case 3:if(ka(r,n),(n&130023424)===n&&(e=z5+500-Wt(),10<e)){if($0(r,0)!==0)break;if(i=r.suspendedLanes,(i&n)!==n){on(),r.pingedLanes|=r.suspendedLanes&i;break}r.timeoutHandle=Y8(rl.bind(null,r,Sn,uo),e);break}rl(r,Sn,uo);break;case 4:if(ka(r,n),(n&4194240)===n)break;for(e=r.eventTimes,i=-1;0<n;){var o=31-Ki(n);s=1<<o,o=e[o],o>i&&(i=o),n&=~s}if(n=i,n=Wt()-n,n=(120>n?120:480>n?480:1080>n?1080:1920>n?1920:3e3>n?3e3:4320>n?4320:1960*dG(n/1960))-n,10<n){r.timeoutHandle=Y8(rl.bind(null,r,Sn,uo),n);break}rl(r,Sn,uo);break;case 5:rl(r,Sn,uo);break;default:throw Error(ee(329))}}}return xn(r,Wt()),r.callbackNode===t?Vk.bind(null,r):null}function j5(r,e){var t=zf;return r.current.memoizedState.isDehydrated&&(tl(r,e).flags|=256),r=Ag(r,e),r!==2&&(e=Sn,Sn=t,e!==null&&H5(e)),r}function H5(r){Sn===null?Sn=r:Sn.push.apply(Sn,r)}function hG(r){for(var e=r;;){if(e.flags&16384){var t=e.updateQueue;if(t!==null&&(t=t.stores,t!==null))for(var n=0;n<t.length;n++){var i=t[n],s=i.getSnapshot;i=i.value;try{if(!ji(s(),i))return!1}catch{return!1}}}if(t=e.child,e.subtreeFlags&16384&&t!==null)t.return=e,e=t;else{if(e===r)break;for(;e.sibling===null;){if(e.return===null||e.return===r)return!0;e=e.return}e.sibling.return=e.return,e=e.sibling}}return!0}function ka(r,e){for(e&=~F5,e&=~wg,r.suspendedLanes|=e,r.pingedLanes&=~e,r=r.expirationTimes;0<e;){var t=31-Ki(e),n=1<<t;r[t]=-1,e&=~n}}function Kk(r){if(et&6)throw Error(ee(327));td();var e=$0(r,0);if(!(e&1))return xn(r,Wt()),null;var t=Ag(r,e);if(r.tag!==0&&t===2){var n=x8(r);n!==0&&(e=n,t=j5(r,n))}if(t===1)throw t=Ff,tl(r,0),ka(r,e),xn(r,Wt()),t;if(t===6)throw Error(ee(345));return r.finishedWork=r.current.alternate,r.finishedLanes=e,rl(r,Sn,uo),xn(r,Wt()),null}function q5(r,e){var t=et;et|=1;try{return r(e)}finally{et=t,et===0&&(ed=Wt()+500,J0&&va())}}function el(r){Ca!==null&&Ca.tag===0&&!(et&6)&&td();var e=et;et|=1;var t=wi.transition,n=ht;try{if(wi.transition=null,ht=1,r)return r()}finally{ht=n,wi.transition=t,et=e,!(et&6)&&va()}}function W5(){Wn=Zu.current,Pt(Zu)}function tl(r,e){r.finishedWork=null,r.finishedLanes=0;var t=r.timeoutHandle;if(t!==-1&&(r.timeoutHandle=-1,VW(t)),Xt!==null)for(t=Xt.return;t!==null;){var n=t;switch(r5(n),n.tag){case 1:n=n.type.childContextTypes,n!=null&&Q0();break;case 3:Yu(),Pt(bn),Pt($r),g5();break;case 5:f5(n);break;case 4:Yu();break;case 13:Pt(Lt);break;case 19:Pt(Lt);break;case 10:c5(n.type._context);break;case 22:case 23:W5()}t=t.return}if(lr=r,Xt=r=_a(r.current,null),wr=Wn=e,ir=0,Ff=null,F5=wg=Zc=0,Sn=zf=null,Yc!==null){for(e=0;e<Yc.length;e++)if(t=Yc[e],n=t.interleaved,n!==null){t.interleaved=null;var i=n.next,s=t.pending;if(s!==null){var o=s.next;s.next=i,n.next=o}t.pending=n}Yc=null}return r}function jk(r,e){do{var t=Xt;try{if(a5(),ag.current=dg,cg){for(var n=Bt.memoizedState;n!==null;){var i=n.queue;i!==null&&(i.pending=null),n=n.next}cg=!1}if(Xc=0,cr=nr=Bt=null,Mf=!1,Of=0,U5.current=null,t===null||t.return===null){ir=1,Ff=e,Xt=null;break}e:{var s=r,o=t.return,a=t,c=e;if(e=wr,a.flags|=32768,c!==null&&typeof c=="object"&&typeof c.then=="function"){var l=c,d=a,h=d.tag;if(!(d.mode&1)&&(h===0||h===11||h===15)){var p=d.alternate;p?(d.updateQueue=p.updateQueue,d.memoizedState=p.memoizedState,d.lanes=p.lanes):(d.updateQueue=null,d.memoizedState=null)}var m=gk(o);if(m!==null){m.flags&=-257,yk(m,o,a,s,e),m.mode&1&&pk(s,l,e),e=m,c=l;var f=e.updateQueue;if(f===null){var g=new Set;g.add(c),e.updateQueue=g}else f.add(c);break e}else{if(!(e&1)){pk(s,l,e),G5();break e}c=Error(ee(426))}}else if(Nt&&a.mode&1){var w=gk(o);if(w!==null){!(w.flags&65536)&&(w.flags|=256),yk(w,o,a,s,e),s5(Ju(c,a));break e}}s=c=Ju(c,a),ir!==4&&(ir=2),zf===null?zf=[s]:zf.push(s),s=o;do{switch(s.tag){case 3:s.flags|=65536,e&=-e,s.lanes|=e;var y=hk(s,c,e);UI(s,y);break e;case 1:a=c;var b=s.type,v=s.stateNode;if(!(s.flags&128)&&(typeof b.getDerivedStateFromError=="function"||v!==null&&typeof v.componentDidCatch=="function"&&(Aa===null||!Aa.has(v)))){s.flags|=65536,e&=-e,s.lanes|=e;var E=fk(s,a,e);UI(s,E);break e}}s=s.return}while(s!==null)}Wk(t)}catch(C){e=C,Xt===t&&t!==null&&(Xt=t=t.return);continue}break}while(!0)}function Hk(){var r=mg.current;return mg.current=dg,r===null?dg:r}function G5(){(ir===0||ir===3||ir===2)&&(ir=4),lr===null||!(Zc&268435455)&&!(wg&268435455)||ka(lr,wr)}function Ag(r,e){var t=et;et|=2;var n=Hk();(lr!==r||wr!==e)&&(uo=null,tl(r,e));do try{fG();break}catch(i){jk(r,i)}while(!0);if(a5(),et=t,mg.current=n,Xt!==null)throw Error(ee(261));return lr=null,wr=0,ir}function fG(){for(;Xt!==null;)qk(Xt)}function pG(){for(;Xt!==null&&!Uq();)qk(Xt)}function qk(r){var e=Yk(r.alternate,r,Wn);r.memoizedProps=r.pendingProps,e===null?Wk(r):Xt=e,U5.current=null}function Wk(r){var e=r;do{var t=e.alternate;if(r=e.return,e.flags&32768){if(t=aG(t,e),t!==null){t.flags&=32767,Xt=t;return}if(r!==null)r.flags|=32768,r.subtreeFlags=0,r.deletions=null;else{ir=6,Xt=null;return}}else if(t=oG(t,e,Wn),t!==null){Xt=t;return}if(e=e.sibling,e!==null){Xt=e;return}Xt=e=r}while(e!==null);ir===0&&(ir=5)}function rl(r,e,t){var n=ht,i=wi.transition;try{wi.transition=null,ht=1,gG(r,e,t,n)}finally{wi.transition=i,ht=n}return null}function gG(r,e,t,n){do td();while(Ca!==null);if(et&6)throw Error(ee(327));t=r.finishedWork;var i=r.finishedLanes;if(t===null)return null;if(r.finishedWork=null,r.finishedLanes=0,t===r.current)throw Error(ee(177));r.callbackNode=null,r.callbackPriority=0;var s=t.lanes|t.childLanes;if(Qq(r,s),r===lr&&(Xt=lr=null,wr=0),!(t.subtreeFlags&2064)&&!(t.flags&2064)||vg||(vg=!0,Jk(_0,function(){return td(),null})),s=(t.flags&15990)!==0,t.subtreeFlags&15990||s){s=wi.transition,wi.transition=null;var o=ht;ht=1;var a=et;et|=4,U5.current=null,lG(r,t),Lk(t,r),OW(G8),O0=!!W8,G8=W8=null,r.current=t,uG(t),Fq(),et=a,ht=o,wi.transition=s}else r.current=t;if(vg&&(vg=!1,Ca=r,Eg=i),s=r.pendingLanes,s===0&&(Aa=null),Kq(t.stateNode),xn(r,Wt()),e!==null)for(n=r.onRecoverableError,t=0;t<e.length;t++)i=e[t],n(i.value,{componentStack:i.stack,digest:i.digest});if(bg)throw bg=!1,r=V5,V5=null,r;return Eg&1&&r.tag!==0&&td(),s=r.pendingLanes,s&1?r===K5?Vf++:(Vf=0,K5=r):Vf=0,va(),null}function td(){if(Ca!==null){var r=OC(Eg),e=wi.transition,t=ht;try{if(wi.transition=null,ht=16>r?16:r,Ca===null)var n=!1;else{if(r=Ca,Ca=null,Eg=0,et&6)throw Error(ee(331));var i=et;for(et|=4,we=r.current;we!==null;){var s=we,o=s.child;if(we.flags&16){var a=s.deletions;if(a!==null){for(var c=0;c<a.length;c++){var l=a[c];for(we=l;we!==null;){var d=we;switch(d.tag){case 0:case 11:case 15:Uf(8,d,s)}var h=d.child;if(h!==null)h.return=d,we=h;else for(;we!==null;){d=we;var p=d.sibling,m=d.return;if($k(d),d===l){we=null;break}if(p!==null){p.return=m,we=p;break}we=m}}}var f=s.alternate;if(f!==null){var g=f.child;if(g!==null){f.child=null;do{var w=g.sibling;g.sibling=null,g=w}while(g!==null)}}we=s}}if(s.subtreeFlags&2064&&o!==null)o.return=s,we=o;else e:for(;we!==null;){if(s=we,s.flags&2048)switch(s.tag){case 0:case 11:case 15:Uf(9,s,s.return)}var y=s.sibling;if(y!==null){y.return=s.return,we=y;break e}we=s.return}}var b=r.current;for(we=b;we!==null;){o=we;var v=o.child;if(o.subtreeFlags&2064&&v!==null)v.return=o,we=v;else e:for(o=b;we!==null;){if(a=we,a.flags&2048)try{switch(a.tag){case 0:case 11:case 15:yg(9,a)}}catch(C){jt(a,a.return,C)}if(a===o){we=null;break e}var E=a.sibling;if(E!==null){E.return=a.return,we=E;break e}we=a.return}}if(et=i,va(),bs&&typeof bs.onPostCommitFiberRoot=="function")try{bs.onPostCommitFiberRoot(T0,r)}catch{}n=!0}return n}finally{ht=t,wi.transition=e}}return!1}function Gk(r,e,t){e=Ju(t,e),e=hk(r,e,1),r=Sa(r,e,1),e=on(),r!==null&&(hf(r,1,e),xn(r,e))}function jt(r,e,t){if(r.tag===3)Gk(r,r,t);else for(;e!==null;){if(e.tag===3){Gk(e,r,t);break}else if(e.tag===1){var n=e.stateNode;if(typeof e.type.getDerivedStateFromError=="function"||typeof n.componentDidCatch=="function"&&(Aa===null||!Aa.has(n))){r=Ju(t,r),r=fk(e,r,1),e=Sa(e,r,1),r=on(),e!==null&&(hf(e,1,r),xn(e,r));break}}e=e.return}}function yG(r,e,t){var n=r.pingCache;n!==null&&n.delete(e),e=on(),r.pingedLanes|=r.suspendedLanes&t,lr===r&&(wr&t)===t&&(ir===4||ir===3&&(wr&130023424)===wr&&500>Wt()-z5?tl(r,0):F5|=t),xn(r,e)}function Qk(r,e){e===0&&(r.mode&1?(e=D0,D0<<=1,!(D0&130023424)&&(D0=4194304)):e=1);var t=on();r=ao(r,e),r!==null&&(hf(r,e,t),xn(r,t))}function mG(r){var e=r.memoizedState,t=0;e!==null&&(t=e.retryLane),Qk(r,t)}function wG(r,e){var t=0;switch(r.tag){case 13:var n=r.stateNode,i=r.memoizedState;i!==null&&(t=i.retryLane);break;case 19:n=r.stateNode;break;default:throw Error(ee(314))}n!==null&&n.delete(e),Qk(r,t)}var Yk;Yk=function(r,e,t){if(r!==null)if(r.memoizedProps!==e.pendingProps||bn.current)En=!0;else{if(!(r.lanes&t)&&!(e.flags&128))return En=!1,sG(r,e,t);En=!!(r.flags&131072)}else En=!1,Nt&&e.flags&1048576&&TI(e,Z0,e.index);switch(e.lanes=0,e.tag){case 2:var n=e.type;pg(r,e),r=e.pendingProps;var i=Ku(e,$r.current);Qu(e,t),i=w5(null,e,n,r,i,t);var s=b5();return e.flags|=1,typeof i=="object"&&i!==null&&typeof i.render=="function"&&i.$$typeof===void 0?(e.tag=1,e.memoizedState=null,e.updateQueue=null,vn(n)?(s=!0,Y0(e)):s=!1,e.memoizedState=i.state!==null&&i.state!==void 0?i.state:null,d5(e),i.updater=hg,e.stateNode=i,i._reactInternals=e,C5(e,n,r,t),e=T5(null,e,n,!0,s,t)):(e.tag=0,Nt&&s&&t5(e),sn(null,e,i,t),e=e.child),e;case 16:n=e.elementType;e:{switch(pg(r,e),r=e.pendingProps,i=n._init,n=i(n._payload),e.type=n,i=e.tag=vG(n),r=qi(n,r),i){case 0:e=_5(null,e,n,r,t);break e;case 1:e=Sk(null,e,n,r,t);break e;case 11:e=mk(null,e,n,r,t);break e;case 14:e=wk(null,e,n,qi(n.type,r),t);break e}throw Error(ee(306,n,""))}return e;case 0:return n=e.type,i=e.pendingProps,i=e.elementType===n?i:qi(n,i),_5(r,e,n,i,t);case 1:return n=e.type,i=e.pendingProps,i=e.elementType===n?i:qi(n,i),Sk(r,e,n,i,t);case 3:e:{if(xk(e),r===null)throw Error(ee(387));n=e.pendingProps,s=e.memoizedState,i=s.element,BI(r,e),sg(e,n,null,t);var o=e.memoizedState;if(n=o.element,s.isDehydrated)if(s={element:n,isDehydrated:!1,cache:o.cache,pendingSuspenseBoundaries:o.pendingSuspenseBoundaries,transitions:o.transitions},e.updateQueue.baseState=s,e.memoizedState=s,e.flags&256){i=Ju(Error(ee(423)),e),e=Ak(r,e,n,t,i);break e}else if(n!==i){i=Ju(Error(ee(424)),e),e=Ak(r,e,n,t,i);break e}else for(qn=ma(e.stateNode.containerInfo.firstChild),Hn=e,Nt=!0,Hi=null,t=RI(e,null,n,t),e.child=t;t;)t.flags=t.flags&-3|4096,t=t.sibling;else{if(qu(),n===i){e=lo(r,e,t);break e}sn(r,e,n,t)}e=e.child}return e;case 5:return zI(e),r===null&&i5(e),n=e.type,i=e.pendingProps,s=r!==null?r.memoizedProps:null,o=i.children,Q8(n,i)?o=null:s!==null&&Q8(n,s)&&(e.flags|=32),Ek(r,e),sn(r,e,o,t),e.child;case 6:return r===null&&i5(e),null;case 13:return Ck(r,e,t);case 4:return h5(e,e.stateNode.containerInfo),n=e.pendingProps,r===null?e.child=Wu(e,null,n,t):sn(r,e,n,t),e.child;case 11:return n=e.type,i=e.pendingProps,i=e.elementType===n?i:qi(n,i),mk(r,e,n,i,t);case 7:return sn(r,e,e.pendingProps,t),e.child;case 8:return sn(r,e,e.pendingProps.children,t),e.child;case 12:return sn(r,e,e.pendingProps.children,t),e.child;case 10:e:{if(n=e.type._context,i=e.pendingProps,s=e.memoizedProps,o=i.value,Et(rg,n._currentValue),n._currentValue=o,s!==null)if(ji(s.value,o)){if(s.children===i.children&&!bn.current){e=lo(r,e,t);break e}}else for(s=e.child,s!==null&&(s.return=e);s!==null;){var a=s.dependencies;if(a!==null){o=s.child;for(var c=a.firstContext;c!==null;){if(c.context===n){if(s.tag===1){c=co(-1,t&-t),c.tag=2;var l=s.updateQueue;if(l!==null){l=l.shared;var d=l.pending;d===null?c.next=c:(c.next=d.next,d.next=c),l.pending=c}}s.lanes|=t,c=s.alternate,c!==null&&(c.lanes|=t),l5(s.return,t,e),a.lanes|=t;break}c=c.next}}else if(s.tag===10)o=s.type===e.type?null:s.child;else if(s.tag===18){if(o=s.return,o===null)throw Error(ee(341));o.lanes|=t,a=o.alternate,a!==null&&(a.lanes|=t),l5(o,t,e),o=s.sibling}else o=s.child;if(o!==null)o.return=s;else for(o=s;o!==null;){if(o===e){o=null;break}if(s=o.sibling,s!==null){s.return=o.return,o=s;break}o=o.return}s=o}sn(r,e,i.children,t),e=e.child}return e;case 9:return i=e.type,n=e.pendingProps.children,Qu(e,t),i=yi(i),n=n(i),e.flags|=1,sn(r,e,n,t),e.child;case 14:return n=e.type,i=qi(n,e.pendingProps),i=qi(n.type,i),wk(r,e,n,i,t);case 15:return bk(r,e,e.type,e.pendingProps,t);case 17:return n=e.type,i=e.pendingProps,i=e.elementType===n?i:qi(n,i),pg(r,e),e.tag=1,vn(n)?(r=!0,Y0(e)):r=!1,Qu(e,t),uk(e,n,i),C5(e,n,i,t),T5(null,e,n,!0,r,t);case 19:return kk(r,e,t);case 22:return vk(r,e,t)}throw Error(ee(156,e.tag))};function Jk(r,e){return PC(r,e)}function bG(r,e,t,n){this.tag=r,this.key=t,this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null,this.index=0,this.ref=null,this.pendingProps=e,this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null,this.mode=n,this.subtreeFlags=this.flags=0,this.deletions=null,this.childLanes=this.lanes=0,this.alternate=null}function bi(r,e,t,n){return new bG(r,e,t,n)}function Q5(r){return r=r.prototype,!(!r||!r.isReactComponent)}function vG(r){if(typeof r=="function")return Q5(r)?1:0;if(r!=null){if(r=r.$$typeof,r===t8)return 11;if(r===i8)return 14}return 2}function _a(r,e){var t=r.alternate;return t===null?(t=bi(r.tag,e,r.key,r.mode),t.elementType=r.elementType,t.type=r.type,t.stateNode=r.stateNode,t.alternate=r,r.alternate=t):(t.pendingProps=e,t.type=r.type,t.flags=0,t.subtreeFlags=0,t.deletions=null),t.flags=r.flags&14680064,t.childLanes=r.childLanes,t.lanes=r.lanes,t.child=r.child,t.memoizedProps=r.memoizedProps,t.memoizedState=r.memoizedState,t.updateQueue=r.updateQueue,e=r.dependencies,t.dependencies=e===null?null:{lanes:e.lanes,firstContext:e.firstContext},t.sibling=r.sibling,t.index=r.index,t.ref=r.ref,t}function Cg(r,e,t,n,i,s){var o=2;if(n=r,typeof r=="function")Q5(r)&&(o=1);else if(typeof r=="string")o=5;else e:switch(r){case Pu:return nl(t.children,i,s,e);case Z4:o=8,i|=8;break;case e8:return r=bi(12,t,e,i|2),r.elementType=e8,r.lanes=s,r;case r8:return r=bi(13,t,e,i),r.elementType=r8,r.lanes=s,r;case n8:return r=bi(19,t,e,i),r.elementType=n8,r.lanes=s,r;case oC:return Ig(t,i,s,e);default:if(typeof r=="object"&&r!==null)switch(r.$$typeof){case iC:o=10;break e;case sC:o=9;break e;case t8:o=11;break e;case i8:o=14;break e;case la:o=16,n=null;break e}throw Error(ee(130,r==null?r:typeof r,""))}return e=bi(o,t,e,i),e.elementType=r,e.type=n,e.lanes=s,e}function nl(r,e,t,n){return r=bi(7,r,n,e),r.lanes=t,r}function Ig(r,e,t,n){return r=bi(22,r,n,e),r.elementType=oC,r.lanes=t,r.stateNode={isHidden:!1},r}function Y5(r,e,t){return r=bi(6,r,null,e),r.lanes=t,r}function J5(r,e,t){return e=bi(4,r.children!==null?r.children:[],r.key,e),e.lanes=t,e.stateNode={containerInfo:r.containerInfo,pendingChildren:null,implementation:r.implementation},e}function EG(r,e,t,n,i){this.tag=e,this.containerInfo=r,this.finishedWork=this.pingCache=this.current=this.pendingChildren=null,this.timeoutHandle=-1,this.callbackNode=this.pendingContext=this.context=null,this.callbackPriority=0,this.eventTimes=A8(0),this.expirationTimes=A8(-1),this.entangledLanes=this.finishedLanes=this.mutableReadLanes=this.expiredLanes=this.pingedLanes=this.suspendedLanes=this.pendingLanes=0,this.entanglements=A8(0),this.identifierPrefix=n,this.onRecoverableError=i,this.mutableSourceEagerHydrationData=null}function X5(r,e,t,n,i,s,o,a,c){return r=new EG(r,e,t,a,c),e===1?(e=1,s===!0&&(e|=8)):e=0,s=bi(3,null,null,e),r.current=s,s.stateNode=r,s.memoizedState={element:n,isDehydrated:t,cache:null,transitions:null,pendingSuspenseBoundaries:null},d5(s),r}function SG(r,e,t){var n=3<arguments.length&&arguments[3]!==void 0?arguments[3]:null;return{$$typeof:Tu,key:n==null?null:""+n,children:r,containerInfo:e,implementation:t}}function Xk(r){if(!r)return ba;r=r._reactInternals;e:{if(Hc(r)!==r||r.tag!==1)throw Error(ee(170));var e=r;do{switch(e.tag){case 3:e=e.stateNode.context;break e;case 1:if(vn(e.type)){e=e.stateNode.__reactInternalMemoizedMergedChildContext;break e}}e=e.return}while(e!==null);throw Error(ee(171))}if(r.tag===1){var t=r.type;if(vn(t))return II(r,t,e)}return e}function Zk(r,e,t,n,i,s,o,a,c){return r=X5(t,n,!0,r,i,s,o,a,c),r.context=Xk(null),t=r.current,n=on(),i=Ia(t),s=co(n,i),s.callback=e??null,Sa(t,s,i),r.current.lanes=i,hf(r,i,n),xn(r,n),r}function kg(r,e,t,n){var i=e.current,s=on(),o=Ia(i);return t=Xk(t),e.context===null?e.context=t:e.pendingContext=t,e=co(s,o),e.payload={element:r},n=n===void 0?null:n,n!==null&&(e.callback=n),r=Sa(i,e,o),r!==null&&(Qi(r,i,o,s),ig(r,i,o)),o}function _g(r){if(r=r.current,!r.child)return null;switch(r.child.tag){case 5:return r.child.stateNode;default:return r.child.stateNode}}function e_(r,e){if(r=r.memoizedState,r!==null&&r.dehydrated!==null){var t=r.retryLane;r.retryLane=t!==0&&t<e?t:e}}function Z5(r,e){e_(r,e),(r=r.alternate)&&e_(r,e)}function xG(){return null}var t_=typeof reportError=="function"?reportError:function(r){console.error(r)};function e6(r){this._internalRoot=r}Tg.prototype.render=e6.prototype.render=function(r){var e=this._internalRoot;if(e===null)throw Error(ee(409));kg(r,e,null,null)},Tg.prototype.unmount=e6.prototype.unmount=function(){var r=this._internalRoot;if(r!==null){this._internalRoot=null;var e=r.containerInfo;el(function(){kg(null,r,null,null)}),e[no]=null}};function Tg(r){this._internalRoot=r}Tg.prototype.unstable_scheduleHydration=function(r){if(r){var e=BC();r={blockedOn:null,target:r,priority:e};for(var t=0;t<pa.length&&e!==0&&e<pa[t].priority;t++);pa.splice(t,0,r),t===0&&zC(r)}};function t6(r){return!(!r||r.nodeType!==1&&r.nodeType!==9&&r.nodeType!==11)}function Pg(r){return!(!r||r.nodeType!==1&&r.nodeType!==9&&r.nodeType!==11&&(r.nodeType!==8||r.nodeValue!==" react-mount-point-unstable "))}function r_(){}function AG(r,e,t,n,i){if(i){if(typeof n=="function"){var s=n;n=function(){var l=_g(o);s.call(l)}}var o=Zk(e,n,r,0,null,!1,!1,"",r_);return r._reactRootContainer=o,r[no]=o.current,If(r.nodeType===8?r.parentNode:r),el(),o}for(;i=r.lastChild;)r.removeChild(i);if(typeof n=="function"){var a=n;n=function(){var l=_g(c);a.call(l)}}var c=X5(r,0,!1,null,null,!1,!1,"",r_);return r._reactRootContainer=c,r[no]=c.current,If(r.nodeType===8?r.parentNode:r),el(function(){kg(e,c,t,n)}),c}function Dg(r,e,t,n,i){var s=t._reactRootContainer;if(s){var o=s;if(typeof i=="function"){var a=i;i=function(){var c=_g(o);a.call(c)}}kg(e,o,r,i)}else o=AG(t,e,r,i,n);return _g(o)}RC=function(r){switch(r.tag){case 3:var e=r.stateNode;if(e.current.memoizedState.isDehydrated){var t=df(e.pendingLanes);t!==0&&(C8(e,t|1),xn(e,Wt()),!(et&6)&&(ed=Wt()+500,va()))}break;case 13:el(function(){var n=ao(r,1);if(n!==null){var i=on();Qi(n,r,1,i)}}),Z5(r,1)}},I8=function(r){if(r.tag===13){var e=ao(r,134217728);if(e!==null){var t=on();Qi(e,r,134217728,t)}Z5(r,134217728)}},LC=function(r){if(r.tag===13){var e=Ia(r),t=ao(r,e);if(t!==null){var n=on();Qi(t,r,e,n)}Z5(r,e)}},BC=function(){return ht},UC=function(r,e){var t=ht;try{return ht=r,e()}finally{ht=t}},w8=function(r,e,t){switch(e){case"input":if(u8(r,t),e=t.name,t.type==="radio"&&e!=null){for(t=r;t.parentNode;)t=t.parentNode;for(t=t.querySelectorAll("input[name="+JSON.stringify(""+e)+'][type="radio"]'),e=0;e<t.length;e++){var n=t[e];if(n!==r&&n.form===r.form){var i=G0(n);if(!i)throw Error(ee(90));lC(n),u8(n,i)}}}break;case"textarea":pC(r,t);break;case"select":e=t.value,e!=null&&Du(r,!!t.multiple,e,!1)}},xC=q5,AC=el;var CG={usingClientEntryPoint:!1,Events:[Tf,zu,G0,EC,SC,q5]},Kf={findFiberByHostInstance:qc,bundleType:0,version:"18.3.1",rendererPackageName:"react-dom"},IG={bundleType:Kf.bundleType,version:Kf.version,rendererPackageName:Kf.rendererPackageName,rendererConfig:Kf.rendererConfig,overrideHookState:null,overrideHookStateDeletePath:null,overrideHookStateRenamePath:null,overrideProps:null,overridePropsDeletePath:null,overridePropsRenamePath:null,setErrorHandler:null,setSuspenseHandler:null,scheduleUpdate:null,currentDispatcherRef:ro.ReactCurrentDispatcher,findHostInstanceByFiber:function(r){return r=_C(r),r===null?null:r.stateNode},findFiberByHostInstance:Kf.findFiberByHostInstance||xG,findHostInstancesForRefresh:null,scheduleRefresh:null,scheduleRoot:null,setRefreshHandler:null,getCurrentFiber:null,reconcilerVersion:"18.3.1-next-f1338f8080-20240426"};if(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__<"u"){var $g=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(!$g.isDisabled&&$g.supportsFiber)try{T0=$g.inject(IG),bs=$g}catch{}}Vn.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=CG,Vn.createPortal=function(r,e){var t=2<arguments.length&&arguments[2]!==void 0?arguments[2]:null;if(!t6(e))throw Error(ee(200));return SG(r,e,null,t)},Vn.createRoot=function(r,e){if(!t6(r))throw Error(ee(299));var t=!1,n="",i=t_;return e!=null&&(e.unstable_strictMode===!0&&(t=!0),e.identifierPrefix!==void 0&&(n=e.identifierPrefix),e.onRecoverableError!==void 0&&(i=e.onRecoverableError)),e=X5(r,1,!1,null,null,t,!1,n,i),r[no]=e.current,If(r.nodeType===8?r.parentNode:r),new e6(e)},Vn.findDOMNode=function(r){if(r==null)return null;if(r.nodeType===1)return r;var e=r._reactInternals;if(e===void 0)throw typeof r.render=="function"?Error(ee(188)):(r=Object.keys(r).join(","),Error(ee(268,r)));return r=_C(e),r=r===null?null:r.stateNode,r},Vn.flushSync=function(r){return el(r)},Vn.hydrate=function(r,e,t){if(!Pg(e))throw Error(ee(200));return Dg(null,r,e,!0,t)},Vn.hydrateRoot=function(r,e,t){if(!t6(r))throw Error(ee(405));var n=t!=null&&t.hydratedSources||null,i=!1,s="",o=t_;if(t!=null&&(t.unstable_strictMode===!0&&(i=!0),t.identifierPrefix!==void 0&&(s=t.identifierPrefix),t.onRecoverableError!==void 0&&(o=t.onRecoverableError)),e=Zk(e,null,r,1,t??null,i,!1,s,o),r[no]=e.current,If(r),n)for(r=0;r<n.length;r++)t=n[r],i=t._getVersion,i=i(t._source),e.mutableSourceEagerHydrationData==null?e.mutableSourceEagerHydrationData=[t,i]:e.mutableSourceEagerHydrationData.push(t,i);return new Tg(e)},Vn.render=function(r,e,t){if(!Pg(e))throw Error(ee(200));return Dg(null,r,e,!1,t)},Vn.unmountComponentAtNode=function(r){if(!Pg(r))throw Error(ee(40));return r._reactRootContainer?(el(function(){Dg(null,null,r,!1,function(){r._reactRootContainer=null,r[no]=null})}),!0):!1},Vn.unstable_batchedUpdates=q5,Vn.unstable_renderSubtreeIntoContainer=function(r,e,t,n){if(!Pg(t))throw Error(ee(200));if(r==null||r._reactInternals===void 0)throw Error(ee(38));return Dg(r,e,t,!1,n)},Vn.version="18.3.1-next-f1338f8080-20240426";function n_(){if(!(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__>"u"||typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE!="function"))try{__REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE(n_)}catch(r){console.error(r)}}n_(),XA.exports=Vn;var kG=XA.exports,i_,s_=kG;i_=s_.createRoot,s_.hydrateRoot;var r6={exports:{}},rd=typeof Reflect=="object"?Reflect:null,o_=rd&&typeof rd.apply=="function"?rd.apply:function(e,t,n){return Function.prototype.apply.call(e,t,n)},Ng;rd&&typeof rd.ownKeys=="function"?Ng=rd.ownKeys:Object.getOwnPropertySymbols?Ng=function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:Ng=function(e){return Object.getOwnPropertyNames(e)};function _G(r){console&&console.warn&&console.warn(r)}var a_=Number.isNaN||function(e){return e!==e};function pt(){pt.init.call(this)}r6.exports=pt,r6.exports.once=$G,pt.EventEmitter=pt,pt.prototype._events=void 0,pt.prototype._eventsCount=0,pt.prototype._maxListeners=void 0;var c_=10;function Mg(r){if(typeof r!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof r)}Object.defineProperty(pt,"defaultMaxListeners",{enumerable:!0,get:function(){return c_},set:function(r){if(typeof r!="number"||r<0||a_(r))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+r+".");c_=r}}),pt.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},pt.prototype.setMaxListeners=function(e){if(typeof e!="number"||e<0||a_(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this};function l_(r){return r._maxListeners===void 0?pt.defaultMaxListeners:r._maxListeners}pt.prototype.getMaxListeners=function(){return l_(this)},pt.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t.push(arguments[n]);var i=e==="error",s=this._events;if(s!==void 0)i=i&&s.error===void 0;else if(!i)return!1;if(i){var o;if(t.length>0&&(o=t[0]),o instanceof Error)throw o;var a=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw a.context=o,a}var c=s[e];if(c===void 0)return!1;if(typeof c=="function")o_(c,this,t);else for(var l=c.length,d=p_(c,l),n=0;n<l;++n)o_(d[n],this,t);return!0};function u_(r,e,t,n){var i,s,o;if(Mg(t),s=r._events,s===void 0?(s=r._events=Object.create(null),r._eventsCount=0):(s.newListener!==void 0&&(r.emit("newListener",e,t.listener?t.listener:t),s=r._events),o=s[e]),o===void 0)o=s[e]=t,++r._eventsCount;else if(typeof o=="function"?o=s[e]=n?[t,o]:[o,t]:n?o.unshift(t):o.push(t),i=l_(r),i>0&&o.length>i&&!o.warned){o.warned=!0;var a=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");a.name="MaxListenersExceededWarning",a.emitter=r,a.type=e,a.count=o.length,_G(a)}return r}pt.prototype.addListener=function(e,t){return u_(this,e,t,!1)},pt.prototype.on=pt.prototype.addListener,pt.prototype.prependListener=function(e,t){return u_(this,e,t,!0)};function TG(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function d_(r,e,t){var n={fired:!1,wrapFn:void 0,target:r,type:e,listener:t},i=TG.bind(n);return i.listener=t,n.wrapFn=i,i}pt.prototype.once=function(e,t){return Mg(t),this.on(e,d_(this,e,t)),this},pt.prototype.prependOnceListener=function(e,t){return Mg(t),this.prependListener(e,d_(this,e,t)),this},pt.prototype.removeListener=function(e,t){var n,i,s,o,a;if(Mg(t),i=this._events,i===void 0)return this;if(n=i[e],n===void 0)return this;if(n===t||n.listener===t)--this._eventsCount===0?this._events=Object.create(null):(delete i[e],i.removeListener&&this.emit("removeListener",e,n.listener||t));else if(typeof n!="function"){for(s=-1,o=n.length-1;o>=0;o--)if(n[o]===t||n[o].listener===t){a=n[o].listener,s=o;break}if(s<0)return this;s===0?n.shift():PG(n,s),n.length===1&&(i[e]=n[0]),i.removeListener!==void 0&&this.emit("removeListener",e,a||t)}return this},pt.prototype.off=pt.prototype.removeListener,pt.prototype.removeAllListeners=function(e){var t,n,i;if(n=this._events,n===void 0)return this;if(n.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):n[e]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete n[e]),this;if(arguments.length===0){var s=Object.keys(n),o;for(i=0;i<s.length;++i)o=s[i],o!=="removeListener"&&this.removeAllListeners(o);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(t=n[e],typeof t=="function")this.removeListener(e,t);else if(t!==void 0)for(i=t.length-1;i>=0;i--)this.removeListener(e,t[i]);return this};function h_(r,e,t){var n=r._events;if(n===void 0)return[];var i=n[e];return i===void 0?[]:typeof i=="function"?t?[i.listener||i]:[i]:t?DG(i):p_(i,i.length)}pt.prototype.listeners=function(e){return h_(this,e,!0)},pt.prototype.rawListeners=function(e){return h_(this,e,!1)},pt.listenerCount=function(r,e){return typeof r.listenerCount=="function"?r.listenerCount(e):f_.call(r,e)},pt.prototype.listenerCount=f_;function f_(r){var e=this._events;if(e!==void 0){var t=e[r];if(typeof t=="function")return 1;if(t!==void 0)return t.length}return 0}pt.prototype.eventNames=function(){return this._eventsCount>0?Ng(this._events):[]};function p_(r,e){for(var t=new Array(e),n=0;n<e;++n)t[n]=r[n];return t}function PG(r,e){for(;e+1<r.length;e++)r[e]=r[e+1];r.pop()}function DG(r){for(var e=new Array(r.length),t=0;t<e.length;++t)e[t]=r[t].listener||r[t];return e}function $G(r,e){return new Promise(function(t,n){function i(o){r.removeListener(e,s),n(o)}function s(){typeof r.removeListener=="function"&&r.removeListener("error",i),t([].slice.call(arguments))}g_(r,e,s,{once:!0}),e!=="error"&&NG(r,i,{once:!0})})}function NG(r,e,t){typeof r.on=="function"&&g_(r,"error",e,t)}function g_(r,e,t,n){if(typeof r.on=="function")n.once?r.once(e,t):r.on(e,t);else if(typeof r.addEventListener=="function")r.addEventListener(e,function i(s){n.once&&r.removeEventListener(e,i),t(s)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof r)}var Og=r6.exports,y_={exports:{}};(function(r){var e=Object.prototype.hasOwnProperty,t="~";function n(){}Object.create&&(n.prototype=Object.create(null),new n().__proto__||(t=!1));function i(c,l,d){this.fn=c,this.context=l,this.once=d||!1}function s(c,l,d,h,p){if(typeof d!="function")throw new TypeError("The listener must be a function");var m=new i(d,h||c,p),f=t?t+l:l;return c._events[f]?c._events[f].fn?c._events[f]=[c._events[f],m]:c._events[f].push(m):(c._events[f]=m,c._eventsCount++),c}function o(c,l){--c._eventsCount===0?c._events=new n:delete c._events[l]}function a(){this._events=new n,this._eventsCount=0}a.prototype.eventNames=function(){var l=[],d,h;if(this._eventsCount===0)return l;for(h in d=this._events)e.call(d,h)&&l.push(t?h.slice(1):h);return Object.getOwnPropertySymbols?l.concat(Object.getOwnPropertySymbols(d)):l},a.prototype.listeners=function(l){var d=t?t+l:l,h=this._events[d];if(!h)return[];if(h.fn)return[h.fn];for(var p=0,m=h.length,f=new Array(m);p<m;p++)f[p]=h[p].fn;return f},a.prototype.listenerCount=function(l){var d=t?t+l:l,h=this._events[d];return h?h.fn?1:h.length:0},a.prototype.emit=function(l,d,h,p,m,f){var g=t?t+l:l;if(!this._events[g])return!1;var w=this._events[g],y=arguments.length,b,v;if(w.fn){switch(w.once&&this.removeListener(l,w.fn,void 0,!0),y){case 1:return w.fn.call(w.context),!0;case 2:return w.fn.call(w.context,d),!0;case 3:return w.fn.call(w.context,d,h),!0;case 4:return w.fn.call(w.context,d,h,p),!0;case 5:return w.fn.call(w.context,d,h,p,m),!0;case 6:return w.fn.call(w.context,d,h,p,m,f),!0}for(v=1,b=new Array(y-1);v<y;v++)b[v-1]=arguments[v];w.fn.apply(w.context,b)}else{var E=w.length,C;for(v=0;v<E;v++)switch(w[v].once&&this.removeListener(l,w[v].fn,void 0,!0),y){case 1:w[v].fn.call(w[v].context);break;case 2:w[v].fn.call(w[v].context,d);break;case 3:w[v].fn.call(w[v].context,d,h);break;case 4:w[v].fn.call(w[v].context,d,h,p);break;default:if(!b)for(C=1,b=new Array(y-1);C<y;C++)b[C-1]=arguments[C];w[v].fn.apply(w[v].context,b)}}return!0},a.prototype.on=function(l,d,h){return s(this,l,d,h,!1)},a.prototype.once=function(l,d,h){return s(this,l,d,h,!0)},a.prototype.removeListener=function(l,d,h,p){var m=t?t+l:l;if(!this._events[m])return this;if(!d)return o(this,m),this;var f=this._events[m];if(f.fn)f.fn===d&&(!p||f.once)&&(!h||f.context===h)&&o(this,m);else{for(var g=0,w=[],y=f.length;g<y;g++)(f[g].fn!==d||p&&!f[g].once||h&&f[g].context!==h)&&w.push(f[g]);w.length?this._events[m]=w.length===1?w[0]:w:o(this,m)}return this},a.prototype.removeAllListeners=function(l){var d;return l?(d=t?t+l:l,this._events[d]&&o(this,d)):(this._events=new n,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=t,a.EventEmitter=a,r.exports=a})(y_);var MG=y_.exports;const OG=Je(MG);let m_=class extends Error{constructor(e){super(e),this.name="TimeoutError"}},RG=class extends Error{constructor(e){super(),this.name="AbortError",this.message=e}};const w_=r=>globalThis.DOMException===void 0?new RG(r):new DOMException(r),b_=r=>{const e=r.reason===void 0?w_("This operation was aborted."):r.reason;return e instanceof Error?e:w_(e)};function jf(r,e){const{milliseconds:t,fallback:n,message:i,customTimers:s={setTimeout,clearTimeout}}=e;let o,a;const l=new Promise((d,h)=>{if(typeof t!="number"||Math.sign(t)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${t}\``);if(e.signal){const{signal:m}=e;m.aborted&&h(b_(m)),a=()=>{h(b_(m))},m.addEventListener("abort",a,{once:!0})}if(t===Number.POSITIVE_INFINITY){r.then(d,h);return}const p=new m_;o=s.setTimeout.call(void 0,()=>{if(n){try{d(n())}catch(m){h(m)}return}typeof r.cancel=="function"&&r.cancel(),i===!1?d():i instanceof Error?h(i):(p.message=i??`Promise timed out after ${t} milliseconds`,h(p))},t),(async()=>{try{d(await r)}catch(m){h(m)}})()}).finally(()=>{l.clear(),a&&e.signal&&e.signal.removeEventListener("abort",a)});return l.clear=()=>{s.clearTimeout.call(void 0,o),o=void 0},l}function LG(r,e,t){let n=0,i=r.length;for(;i>0;){const s=Math.trunc(i/2);let o=n+s;t(r[o],e)<=0?(n=++o,i-=s+1):i=s}return n}let BG=(vj=class{constructor(){Ye(this,Ui,[])}enqueue(e,t){t={priority:0,...t};const n={priority:t.priority,id:t.id,run:e};if(this.size===0||se(this,Ui)[this.size-1].priority>=t.priority){se(this,Ui).push(n);return}const i=LG(se(this,Ui),n,(s,o)=>o.priority-s.priority);se(this,Ui).splice(i,0,n)}setPriority(e,t){const n=se(this,Ui).findIndex(s=>s.id===e);if(n===-1)throw new ReferenceError(`No promise function with the id "${e}" exists in the queue.`);const[i]=se(this,Ui).splice(n,1);this.enqueue(i.run,{priority:t,id:e})}dequeue(){const e=se(this,Ui).shift();return e==null?void 0:e.run}filter(e){return se(this,Ui).filter(t=>t.priority===e.priority).map(t=>t.run)}get size(){return se(this,Ui).length}},Ui=new WeakMap,vj);class Ta extends OG{constructor(t){var n,i;super();Ye(this,at);Ye(this,Fh);Ye(this,zh);Ye(this,Uc,0);Ye(this,o0);Ye(this,Vh);Ye(this,a0,0);Ye(this,Fi);Ye(this,Kh);Ye(this,yn);Ye(this,c0);Ye(this,zi,0);Ye(this,jh);Ye(this,oa);Ye(this,l0);Ye(this,$4,1n);u(this,"timeout");if(t={carryoverConcurrencyCount:!1,intervalCap:Number.POSITIVE_INFINITY,interval:0,concurrency:Number.POSITIVE_INFINITY,autoStart:!0,queueClass:BG,...t},!(typeof t.intervalCap=="number"&&t.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${((n=t.intervalCap)==null?void 0:n.toString())??""}\` (${typeof t.intervalCap})`);if(t.interval===void 0||!(Number.isFinite(t.interval)&&t.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${((i=t.interval)==null?void 0:i.toString())??""}\` (${typeof t.interval})`);_t(this,Fh,t.carryoverConcurrencyCount),_t(this,zh,t.intervalCap===Number.POSITIVE_INFINITY||t.interval===0),_t(this,o0,t.intervalCap),_t(this,Vh,t.interval),_t(this,yn,new t.queueClass),_t(this,c0,t.queueClass),this.concurrency=t.concurrency,this.timeout=t.timeout,_t(this,l0,t.throwOnTimeout===!0),_t(this,oa,t.autoStart===!1)}get concurrency(){return se(this,jh)}set concurrency(t){if(!(typeof t=="number"&&t>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${t}\` (${typeof t})`);_t(this,jh,t),Ae(this,at,R4).call(this)}setPriority(t,n){se(this,yn).setPriority(t,n)}async add(t,n={}){return n.id??(n.id=(Zs(this,$4)._++).toString()),n={timeout:this.timeout,throwOnTimeout:se(this,l0),...n},new Promise((i,s)=>{se(this,yn).enqueue(async()=>{var o;Zs(this,zi)._++,Zs(this,Uc)._++;try{(o=n.signal)==null||o.throwIfAborted();let a=t({signal:n.signal});n.timeout&&(a=jf(Promise.resolve(a),{milliseconds:n.timeout})),n.signal&&(a=Promise.race([a,Ae(this,at,XH).call(this,n.signal)]));const c=await a;i(c),this.emit("completed",c)}catch(a){if(a instanceof m_&&!n.throwOnTimeout){i();return}s(a),this.emit("error",a)}finally{Ae(this,at,QH).call(this)}},n),this.emit("add"),Ae(this,at,O4).call(this)})}async addAll(t,n){return Promise.all(t.map(async i=>this.add(i,n)))}start(){return se(this,oa)?(_t(this,oa,!1),Ae(this,at,R4).call(this),this):this}pause(){_t(this,oa,!0)}clear(){_t(this,yn,new(se(this,c0)))}async onEmpty(){se(this,yn).size!==0&&await Ae(this,at,L4).call(this,"empty")}async onSizeLessThan(t){se(this,yn).size<t||await Ae(this,at,L4).call(this,"next",()=>se(this,yn).size<t)}async onIdle(){se(this,zi)===0&&se(this,yn).size===0||await Ae(this,at,L4).call(this,"idle")}get size(){return se(this,yn).size}sizeBy(t){return se(this,yn).filter(t).length}get pending(){return se(this,zi)}get isPaused(){return se(this,oa)}}Fh=new WeakMap,zh=new WeakMap,Uc=new WeakMap,o0=new WeakMap,Vh=new WeakMap,a0=new WeakMap,Fi=new WeakMap,Kh=new WeakMap,yn=new WeakMap,c0=new WeakMap,zi=new WeakMap,jh=new WeakMap,oa=new WeakMap,l0=new WeakMap,$4=new WeakMap,at=new WeakSet,WH=function(){return se(this,zh)||se(this,Uc)<se(this,o0)},GH=function(){return se(this,zi)<se(this,jh)},QH=function(){Zs(this,zi)._--,Ae(this,at,O4).call(this),this.emit("next")},YH=function(){Ae(this,at,RA).call(this),Ae(this,at,OA).call(this),_t(this,Kh,void 0)},JH=function(){const t=Date.now();if(se(this,Fi)===void 0){const n=se(this,a0)-t;if(n<0)_t(this,Uc,se(this,Fh)?se(this,zi):0);else return se(this,Kh)===void 0&&_t(this,Kh,setTimeout(()=>{Ae(this,at,YH).call(this)},n)),!0}return!1},O4=function(){if(se(this,yn).size===0)return se(this,Fi)&&clearInterval(se(this,Fi)),_t(this,Fi,void 0),this.emit("empty"),se(this,zi)===0&&this.emit("idle"),!1;if(!se(this,oa)){const t=!se(this,at,JH);if(se(this,at,WH)&&se(this,at,GH)){const n=se(this,yn).dequeue();return n?(this.emit("active"),n(),t&&Ae(this,at,OA).call(this),!0):!1}}return!1},OA=function(){se(this,zh)||se(this,Fi)!==void 0||(_t(this,Fi,setInterval(()=>{Ae(this,at,RA).call(this)},se(this,Vh))),_t(this,a0,Date.now()+se(this,Vh)))},RA=function(){se(this,Uc)===0&&se(this,zi)===0&&se(this,Fi)&&(clearInterval(se(this,Fi)),_t(this,Fi,void 0)),_t(this,Uc,se(this,Fh)?se(this,zi):0),Ae(this,at,R4).call(this)},R4=function(){for(;Ae(this,at,O4).call(this););},XH=async function(t){return new Promise((n,i)=>{t.addEventListener("abort",()=>{i(t.reason)},{once:!0})})},L4=async function(t,n){return new Promise(i=>{const s=()=>{n&&!n()||(this.off(t,s),i())};this.on(t,s)})};function Re(){const r={};return r.promise=new Promise((e,t)=>{r.resolve=e,r.reject=t}),r}class v_{constructor(e){u(this,"buffer");u(this,"mask");u(this,"top");u(this,"btm");u(this,"next");if(!(e>0)||e-1&e)throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}push(e){return this.buffer[this.top]!==void 0?!1:(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){const e=this.buffer[this.btm];if(e!==void 0)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}isEmpty(){return this.buffer[this.btm]===void 0}}class n6{constructor(e={}){u(this,"size");u(this,"hwm");u(this,"head");u(this,"tail");this.hwm=e.splitLimit??16,this.head=new v_(this.hwm),this.tail=this.head,this.size=0}calculateSize(e){return(e==null?void 0:e.byteLength)!=null?e.byteLength:1}push(e){if((e==null?void 0:e.value)!=null&&(this.size+=this.calculateSize(e.value)),!this.head.push(e)){const t=this.head;this.head=t.next=new v_(2*this.head.buffer.length),this.head.push(e)}}shift(){let e=this.tail.shift();if(e===void 0&&this.tail.next!=null){const t=this.tail.next;this.tail.next=null,this.tail=t,e=this.tail.shift()}return(e==null?void 0:e.value)!=null&&(this.size-=this.calculateSize(e.value)),e}isEmpty(){return this.head.isEmpty()}}let UG=class extends Error{constructor(t,n){super(t??"The operation was aborted");u(this,"type");u(this,"code");this.type="aborted",this.code=n??"ABORT_ERR"}};function ho(r={}){return FG(t=>{const n=t.shift();if(n==null)return{done:!0};if(n.error!=null)throw n.error;return{done:n.done===!0,value:n.value}},r)}function FG(r,e){e=e??{};let t=e.onEnd,n=new n6,i,s,o,a=Re();const c=async()=>{try{return n.isEmpty()?o?{done:!0}:await new Promise((w,y)=>{s=b=>{s=null,n.push(b);try{w(r(n))}catch(v){y(v)}return i}}):r(n)}finally{n.isEmpty()&&queueMicrotask(()=>{a.resolve(),a=Re()})}},l=w=>s!=null?s(w):(n.push(w),i),d=w=>(n=new n6,s!=null?s({error:w}):(n.push({error:w}),i)),h=w=>{if(o)return i;if((e==null?void 0:e.objectMode)!==!0&&(w==null?void 0:w.byteLength)==null)throw new Error("objectMode was not true but tried to push non-Uint8Array value");return l({done:!1,value:w})},p=w=>o?i:(o=!0,w!=null?d(w):l({done:!0})),m=()=>(n=new n6,p(),{done:!0}),f=w=>(p(w),{done:!0});if(i={[Symbol.asyncIterator](){return this},next:c,return:m,throw:f,push:h,end:p,get readableLength(){return n.size},onEmpty:async w=>{const y=w==null?void 0:w.signal;if(y==null||y.throwIfAborted(),n.isEmpty())return;let b,v;y!=null&&(b=new Promise((E,C)=>{v=()=>{C(new UG)},y.addEventListener("abort",v)}));try{await Promise.race([a.promise,b])}finally{v!=null&&y!=null&&(y==null||y.removeEventListener("abort",v))}}},t==null)return i;const g=i;return i={[Symbol.asyncIterator](){return this},next(){return g.next()},throw(w){return g.throw(w),t!=null&&(t(w),t=void 0),{done:!0}},return(){return g.return(),t!=null&&(t(),t=void 0),{done:!0}},push:h,end(w){return g.end(w),t!=null&&(t(w),t=void 0),i},get readableLength(){return g.readableLength},onEmpty:w=>g.onEmpty(w)},i}let E_=class extends Error{constructor(t,n,i){super(t??"The operation was aborted");u(this,"type");u(this,"code");this.type="aborted",this.name=i??"AbortError",this.code=n??"ABORT_ERR"}};async function an(r,e,t){if(e==null)return r;if(e.aborted)return r.catch(()=>{}),Promise.reject(new E_(t==null?void 0:t.errorMessage,t==null?void 0:t.errorCode,t==null?void 0:t.errorName));let n;const i=new E_(t==null?void 0:t.errorMessage,t==null?void 0:t.errorCode,t==null?void 0:t.errorName);try{return await Promise.race([r,new Promise((s,o)=>{n=()=>{o(i)},e.addEventListener("abort",n)})])}finally{n!=null&&e.removeEventListener("abort",n)}}let zG=class{constructor(){u(this,"readNext");u(this,"haveNext");u(this,"ended");u(this,"nextResult");u(this,"error");this.ended=!1,this.readNext=Re(),this.haveNext=Re()}[Symbol.asyncIterator](){return this}async next(){if(this.nextResult==null&&await this.haveNext.promise,this.nextResult==null)throw new Error("HaveNext promise resolved but nextResult was undefined");const e=this.nextResult;return this.nextResult=void 0,this.readNext.resolve(),this.readNext=Re(),e}async throw(e){return this.ended=!0,this.error=e,e!=null&&(this.haveNext.promise.catch(()=>{}),this.haveNext.reject(e)),{done:!0,value:void 0}}async return(){const e={done:!0,value:void 0};return this.ended=!0,this.nextResult=e,this.haveNext.resolve(),e}async push(e,t){await this._push(e,t)}async end(e,t){e!=null?await this.throw(e):await this._push(void 0,t)}async _push(e,t){if(e!=null&&this.ended)throw this.error??new Error("Cannot push value onto an ended pushable");for(;this.nextResult!=null;)await this.readNext.promise;e!=null?this.nextResult={done:!1,value:e}:(this.ended=!0,this.nextResult={done:!0,value:void 0}),this.haveNext.resolve(),this.haveNext=Re(),await an(this.readNext.promise,t==null?void 0:t.signal,t)}};function VG(){return new zG}function KG(r){return r[Symbol.asyncIterator]!=null}async function jG(r,e){try{await Promise.all(r.map(async t=>{for await(const n of t)await e.push(n)})),await e.end()}catch(t){await e.end(t).catch(()=>{})}}async function*HG(r){const e=VG();jG(r,e).catch(()=>{}),yield*e}function*qG(r){for(const e of r)yield*e}function Pa(...r){const e=[];for(const t of r)KG(t)||e.push(t);return e.length===r.length?qG(e):HG(r)}function cn(r,...e){if(r==null)throw new Error("Empty pipeline");if(i6(r)){const n=r;r=()=>n.source}else if(x_(r)||S_(r)){const n=r;r=()=>n}const t=[r,...e];if(t.length>1&&i6(t[t.length-1])&&(t[t.length-1]=t[t.length-1].sink),t.length>2)for(let n=1;n<t.length-1;n++)i6(t[n])&&(t[n]=GG(t[n]));return WG(...t)}const WG=(...r)=>{let e;for(;r.length>0;)e=r.shift()(e);return e},S_=r=>(r==null?void 0:r[Symbol.asyncIterator])!=null,x_=r=>(r==null?void 0:r[Symbol.iterator])!=null,i6=r=>r==null?!1:r.sink!=null&&r.source!=null,GG=r=>e=>{const t=r.sink(e);if((t==null?void 0:t.then)!=null){const n=ho({objectMode:!0});t.then(()=>{n.end()},o=>{n.end(o)});let i;const s=r.source;if(S_(s))i=async function*(){yield*s,n.end()};else if(x_(s))i=function*(){yield*s,n.end()};else throw new Error("Unknown duplex source type - must be Iterable or AsyncIterable");return Pa(n,i())}return r.source};var QG=function(){return Date.now()};const Rg=QG;class YG{constructor(e,t,n){const i=this;this._started=Rg(),this._rescheduled=0,this._scheduled=t,this._args=n,this._triggered=!1,this._timerWrapper=()=>{i._rescheduled>0?(i._scheduled=i._rescheduled-(Rg()-i._started),i._schedule(i._scheduled)):(i._triggered=!0,e.apply(null,i._args))},this._timer=setTimeout(this._timerWrapper,t)}reschedule(e){e||(e=this._scheduled);const t=Rg();t+e-(this._started+this._scheduled)<0?(clearTimeout(this._timer),this._schedule(e)):this._triggered?this._schedule(e):(this._started=t,this._rescheduled=e)}_schedule(e){this._triggered=!1,this._started=Rg(),this._rescheduled=0,this._scheduled=e,this._timer=setTimeout(this._timerWrapper,e)}clear(){clearTimeout(this._timer)}}function JG(){if(typeof arguments[0]!="function")throw new Error("callback needed");if(typeof arguments[1]!="number")throw new Error("timeout needed");let r;if(arguments.length>0){r=new Array(arguments.length-2);for(var e=0;e<r.length;e++)r[e]=arguments[e+2]}return new YG(arguments[0],arguments[1],r)}var XG=JG;const{AbortController:ZG}=globalThis,A_=XG;class s6 extends ZG{constructor(e){super(),this._ms=e,this._timer=A_(()=>this.abort(),e),Object.setPrototypeOf(this,s6.prototype)}abort(){return this._timer.clear(),super.abort()}clear(){this._timer.clear()}reset(){this._timer.clear(),this._timer=A_(()=>this.abort(),this._ms)}}var o6={TimeoutController:s6};const Da=(...r)=>r.join("/").replace(new RegExp("((?<=\\/)\\/+)|(^\\.\\/)|((?<=\\/)\\.\\/)","g"),"")||".",eQ=3e4,tQ=async({ipfs:r,log:e,events:t,onSynced:n,start:i,timeout:s})=>{if(!r)throw new Error("An instance of ipfs is required.");if(!e)throw new Error("An instance of log is required.");const o=r.libp2p,a=r.libp2p.services.pubsub,c=e.id,l=Da("/orbitdb/heads/",c),d=new Ta({concurrency:1}),h=new Set;t=t||new Og.EventEmitter,s=s||eQ;let p=!1;const m=async x=>{const I=await e.heads();t.emit("join",x,I)},f=x=>async function*(){const I=await e.heads();for await(const{bytes:T}of I)yield T}(),g=x=>async I=>{for await(const T of I){const L=T.subarray();L&&n&&await n(L)}p&&await m(x)},w=async({connection:x,stream:I})=>{const T=String(x.remotePeer);try{h.add(T),await cn(I,g(T),f,I)}catch(L){h.delete(T),t.emit("error",L)}},y=async x=>{const I=async()=>{const{peerId:T,subscriptions:L}=x.detail,z=String(T),B=L.find(G=>G.topic===c);if(B)if(B.subscribe){if(h.has(z))return;const G=new o6.TimeoutController(s),{signal:K}=G;try{h.add(z);const q=await o.dialProtocol(T,l,{signal:K});await cn(f,q,g(z))}catch(q){h.delete(z),q.name==="UnsupportedProtocolError"||t.emit("error",q)}finally{G&&G.clear()}}else h.delete(z),t.emit("leave",z)};d.add(I)},b=async x=>{const{topic:I,data:T}=x.detail,L=async()=>{try{T&&n&&await n(T)}catch(z){t.emit("error",z)}};I===c&&d.add(L)},v=async x=>{h.delete(x.detail.toString())},E=async x=>{p&&await a.publish(c,x.bytes)},C=async()=>{p&&(p=!1,await d.onIdle(),a.removeEventListener("subscription-change",y),a.removeEventListener("message",b),await o.unhandle(l),await a.unsubscribe(c),o.removeEventListener("peer:disconnect",v),h.clear())},k=async()=>{p||(await o.handle(l,w),a.addEventListener("subscription-change",y),a.addEventListener("message",b),await a.subscribe(c),o.addEventListener("peer:disconnect",v),p=!0)};return i!==!1&&await k(),{add:E,stop:C,start:k,events:t,peers:h}};var a6={exports:{}};typeof Object.create=="function"?a6.exports=function(e,t){t&&(e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}))}:a6.exports=function(e,t){if(t){e.super_=t;var n=function(){};n.prototype=t.prototype,e.prototype=new n,e.prototype.constructor=e}};var rQ=a6.exports,C_=Og,nQ=rQ,iQ=Gn;function Gn(r){if(!(this instanceof Gn))return new Gn(r);typeof r=="number"&&(r={max:r}),r||(r={}),C_.EventEmitter.call(this),this.cache={},this.head=this.tail=null,this.length=0,this.max=r.max||1e3,this.maxAge=r.maxAge||0}nQ(Gn,C_.EventEmitter),Object.defineProperty(Gn.prototype,"keys",{get:function(){return Object.keys(this.cache)}}),Gn.prototype.clear=function(){this.cache={},this.head=this.tail=null,this.length=0},Gn.prototype.remove=function(r){if(typeof r!="string"&&(r=""+r),!!this.cache.hasOwnProperty(r)){var e=this.cache[r];return delete this.cache[r],this._unlink(r,e.prev,e.next),e.value}},Gn.prototype._unlink=function(r,e,t){this.length--,this.length===0?this.head=this.tail=null:this.head===r?(this.head=e,this.cache[this.head].next=null):this.tail===r?(this.tail=t,this.cache[this.tail].prev=null):(this.cache[e].next=t,this.cache[t].prev=e)},Gn.prototype.peek=function(r){if(this.cache.hasOwnProperty(r)){var e=this.cache[r];if(this._checkAge(r,e))return e.value}},Gn.prototype.set=function(r,e){typeof r!="string"&&(r=""+r);var t;if(this.cache.hasOwnProperty(r)){if(t=this.cache[r],t.value=e,this.maxAge&&(t.modified=Date.now()),r===this.head)return e;this._unlink(r,t.prev,t.next)}else t={value:e,modified:0,next:null,prev:null},this.maxAge&&(t.modified=Date.now()),this.cache[r]=t,this.length===this.max&&this.evict();return this.length++,t.next=null,t.prev=this.head,this.head&&(this.cache[this.head].next=r),this.head=r,this.tail||(this.tail=r),e},Gn.prototype._checkAge=function(r,e){return this.maxAge&&Date.now()-e.modified>this.maxAge?(this.remove(r),this.emit("evict",{key:r,value:e.value}),!1):!0},Gn.prototype.get=function(r){if(typeof r!="string"&&(r=""+r),!!this.cache.hasOwnProperty(r)){var e=this.cache[r];if(this._checkAge(r,e))return this.head!==r&&(r===this.tail?(this.tail=e.next,this.cache[this.tail].prev=null):this.cache[e.prev].next=e.next,this.cache[e.next].prev=e.prev,this.cache[this.head].next=r,e.prev=this.head,e.next=null,this.head=r),e.value}},Gn.prototype.evict=function(){if(this.tail){var r=this.tail,e=this.remove(this.tail);this.emit("evict",{key:r,value:e})}};const c6=Je(iQ),sQ=(r,e)=>{const t=r.time-e.time;return t===0&&r.id!==e.id?r.id<e.id?-1:1:t},oQ=r=>Lg(r.id,++r.time),Lg=(r,e)=>(e=e||0,{id:r,time:e}),aQ=(r,e)=>{if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0},l6=r=>{if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")};function cQ(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var i=0;i<r.length;i++){var s=r.charAt(i),o=s.charCodeAt(0);if(t[o]!==255)throw new TypeError(s+" is ambiguous");t[o]=i}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),d=Math.log(256)/Math.log(a);function h(f){if(f instanceof Uint8Array||(ArrayBuffer.isView(f)?f=new Uint8Array(f.buffer,f.byteOffset,f.byteLength):Array.isArray(f)&&(f=Uint8Array.from(f))),!(f instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(f.length===0)return"";for(var g=0,w=0,y=0,b=f.length;y!==b&&f[y]===0;)y++,g++;for(var v=(b-y)*d+1>>>0,E=new Uint8Array(v);y!==b;){for(var C=f[y],k=0,x=v-1;(C!==0||k<w)&&x!==-1;x--,k++)C+=256*E[x]>>>0,E[x]=C%a>>>0,C=C/a>>>0;if(C!==0)throw new Error("Non-zero carry");w=k,y++}for(var I=v-w;I!==v&&E[I]===0;)I++;for(var T=c.repeat(g);I<v;++I)T+=r.charAt(E[I]);return T}function p(f){if(typeof f!="string")throw new TypeError("Expected String");if(f.length===0)return new Uint8Array;var g=0;if(f[g]!==" "){for(var w=0,y=0;f[g]===c;)w++,g++;for(var b=(f.length-g)*l+1>>>0,v=new Uint8Array(b);f[g];){var E=t[f.charCodeAt(g)];if(E===255)return;for(var C=0,k=b-1;(E!==0||C<y)&&k!==-1;k--,C++)E+=a*v[k]>>>0,v[k]=E%256>>>0,E=E/256>>>0;if(E!==0)throw new Error("Non-zero carry");y=C,g++}if(f[g]!==" "){for(var x=b-y;x!==b&&v[x]===0;)x++;for(var I=new Uint8Array(w+(b-x)),T=w;x!==b;)I[T++]=v[x++];return I}}}function m(f){var g=p(f);if(g)return g;throw new Error(`Non-${e} character`)}return{encode:h,decodeUnsafe:p,decode:m}}var lQ=cQ,uQ=lQ;let dQ=class{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},hQ=class{constructor(e,t,n){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return I_(this,e)}},fQ=class{constructor(e){this.decoders=e}or(e){return I_(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};const I_=(r,e)=>new fQ({...r.decoders||{[r.prefix]:r},...e.decoders||{[e.prefix]:e}});let pQ=class{constructor(e,t,n,i){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=i,this.encoder=new dQ(e,t,n),this.decoder=new hQ(e,t,i)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};const k_=({name:r,prefix:e,encode:t,decode:n})=>new pQ(r,e,t,n),__=({prefix:r,name:e,alphabet:t})=>{const{encode:n,decode:i}=uQ(t,e);return k_({prefix:r,name:e,encode:n,decode:s=>l6(i(s))})},gQ=(r,e,t,n)=>{const i={};for(let d=0;d<e.length;++d)i[e[d]]=d;let s=r.length;for(;r[s-1]==="=";)--s;const o=new Uint8Array(s*t/8|0);let a=0,c=0,l=0;for(let d=0;d<s;++d){const h=i[r[d]];if(h===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|h,a+=t,a>=8&&(a-=8,o[l++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},yQ=(r,e,t)=>{const n=e[e.length-1]==="=",i=(1<<t)-1;let s="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,s+=e[i&a>>o];if(o&&(s+=e[i&a<<t-o]),n)for(;s.length*t&7;)s+="=";return s},fo=({name:r,prefix:e,bitsPerChar:t,alphabet:n})=>k_({prefix:e,name:r,encode(i){return yQ(i,n,t)},decode(i){return gQ(i,n,t,r)}}),Bg=fo({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});fo({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),fo({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),fo({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),fo({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),fo({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),fo({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),fo({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),fo({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const ln=__({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});__({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var mQ=P_,T_=128,wQ=-128,bQ=Math.pow(2,31);function P_(r,e,t){e=e||[],t=t||0;for(var n=t;r>=bQ;)e[t++]=r&255|T_,r/=128;for(;r&wQ;)e[t++]=r&255|T_,r>>>=7;return e[t]=r|0,P_.bytes=t-n+1,e}var vQ=u6,EQ=128,D_=127;function u6(r,n){var t=0,n=n||0,i=0,s=n,o,a=r.length;do{if(s>=a)throw u6.bytes=0,new RangeError("Could not decode varint");o=r[s++],t+=i<28?(o&D_)<<i:(o&D_)*Math.pow(2,i),i+=7}while(o>=EQ);return u6.bytes=s-n,t}var SQ=Math.pow(2,7),xQ=Math.pow(2,14),AQ=Math.pow(2,21),CQ=Math.pow(2,28),IQ=Math.pow(2,35),kQ=Math.pow(2,42),_Q=Math.pow(2,49),TQ=Math.pow(2,56),PQ=Math.pow(2,63),DQ=function(r){return r<SQ?1:r<xQ?2:r<AQ?3:r<CQ?4:r<IQ?5:r<kQ?6:r<_Q?7:r<TQ?8:r<PQ?9:10},$Q={encode:mQ,decode:vQ,encodingLength:DQ},Ug=$Q;const d6=(r,e=0)=>[Ug.decode(r,e),Ug.decode.bytes],Fg=(r,e,t=0)=>(Ug.encode(r,e,t),e),zg=r=>Ug.encodingLength(r),h6=(r,e)=>{const t=e.byteLength,n=zg(r),i=n+zg(t),s=new Uint8Array(i+t);return Fg(r,s,0),Fg(t,s,n),s.set(e,i),new f6(r,t,e,s)},NQ=r=>{const e=l6(r),[t,n]=d6(e),[i,s]=d6(e.subarray(n)),o=e.subarray(n+s);if(o.byteLength!==i)throw new Error("Incorrect length");return new f6(t,i,o,e)},MQ=(r,e)=>{if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&aQ(r.bytes,t.bytes)}};let f6=class{constructor(e,t,n,i){this.code=e,this.size=t,this.digest=n,this.bytes=i}};const $_=(r,e)=>{const{bytes:t,version:n}=r;switch(n){case 0:return RQ(t,p6(r),e||ln.encoder);default:return LQ(t,p6(r),e||Bg.encoder)}},N_=new WeakMap,p6=r=>{const e=N_.get(r);if(e==null){const t=new Map;return N_.set(r,t),t}return e};let Yi=class Vr{constructor(e,t,n,i){this.code=t,this.version=e,this.multihash=n,this.bytes=i,this["/"]=i}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==Hf)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==BQ)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return Vr.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=h6(e,t);return Vr.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return Vr.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&MQ(e.multihash,n.multihash)}toString(e){return $_(this,e)}toJSON(){return{"/":$_(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof Vr)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:i,multihash:s,bytes:o}=t;return new Vr(n,i,s,o||M_(n,i,s.bytes))}else if(t[UQ]===!0){const{version:n,multihash:i,code:s}=t,o=NQ(i);return Vr.create(n,s,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==Hf)throw new Error(`Version 0 CID must use dag-pb (code: ${Hf}) block encoding`);return new Vr(e,t,n,n.bytes)}case 1:{const i=M_(e,t,n.bytes);return new Vr(e,t,n,i)}default:throw new Error("Invalid version")}}static createV0(e){return Vr.create(0,Hf,e)}static createV1(e,t){return Vr.create(1,e,t)}static decode(e){const[t,n]=Vr.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=Vr.inspectBytes(e),n=t.size-t.multihashSize,i=l6(e.subarray(n,n+t.multihashSize));if(i.byteLength!==t.multihashSize)throw new Error("Incorrect length");const s=i.subarray(t.multihashSize-t.digestSize),o=new f6(t.multihashCode,t.digestSize,s,i);return[t.version===0?Vr.createV0(o):Vr.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[h,p]=d6(e.subarray(t));return t+=p,h};let i=n(),s=Hf;if(i===18?(i=0,t=0):s=n(),i!==0&&i!==1)throw new RangeError(`Invalid CID version ${i}`);const o=t,a=n(),c=n(),l=t+c,d=l-o;return{version:i,codec:s,multihashCode:a,digestSize:c,multihashSize:d,size:l}}static parse(e,t){const[n,i]=OQ(e,t),s=Vr.decode(i);if(s.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return p6(s).set(n,e),s}};const OQ=(r,e)=>{switch(r[0]){case"Q":{const t=e||ln;return[ln.prefix,t.decode(`${ln.prefix}${r}`)]}case ln.prefix:{const t=e||ln;return[ln.prefix,t.decode(r)]}case Bg.prefix:{const t=e||Bg;return[Bg.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}},RQ=(r,e,t)=>{const{prefix:n}=t;if(n!==ln.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const i=e.get(n);if(i==null){const s=t.encode(r).slice(1);return e.set(n,s),s}else return i},LQ=(r,e,t)=>{const{prefix:n}=t,i=e.get(n);if(i==null){const s=t.encode(r);return e.set(n,s),s}else return i},Hf=112,BQ=18,M_=(r,e,t)=>{const n=zg(r),i=n+zg(e),s=new Uint8Array(i+t.byteLength);return Fg(r,s,0),Fg(e,s,n),s.set(t,i),s},UQ=Symbol.for("@ipld/js-cid/CID"),FQ=({name:r,code:e,encode:t})=>new zQ(r,e,t);let zQ=class{constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?h6(this.code,t):t.then(n=>h6(this.code,n))}else throw Error("Unknown type, must be binary type")}};function Vg({enumerable:r=!0,configurable:e=!1}={}){return{enumerable:r,configurable:e,writable:!1}}function*VQ(r,e){if(e!=null&&typeof e=="object")if(Array.isArray(e))for(const[t,n]of e.entries()){const i=[...r,t],s=Yi.asCID(n);s?yield[i.join("/"),s]:typeof n=="object"&&(yield*g6(n,i))}else{const t=Yi.asCID(e);t?yield[r.join("/"),t]:yield*g6(e,r)}}function*g6(r,e){if(r==null||r instanceof Uint8Array)return;const t=Yi.asCID(r);t&&(yield[e.join("/"),t]);for(const[n,i]of Object.entries(r)){const s=[...e,n];yield*VQ(s,i)}}function*KQ(r,e){if(Array.isArray(e))for(const[t,n]of e.entries()){const i=[...r,t];yield i.join("/"),typeof n=="object"&&!Yi.asCID(n)&&(yield*y6(n,i))}else yield*y6(e,r)}function*y6(r,e){if(!(r==null||typeof r!="object"))for(const[t,n]of Object.entries(r)){const i=[...e,t];yield i.join("/"),n!=null&&!(n instanceof Uint8Array)&&typeof n=="object"&&!Yi.asCID(n)&&(yield*KQ(i,n))}}function jQ(r,e){let t=r;for(const[n,i]of e.entries()){if(t=t[i],t==null)throw new Error(`Object has no property at ${e.slice(0,n+1).map(o=>`[${JSON.stringify(o)}]`).join("")}`);const s=Yi.asCID(t);if(s)return{value:s,remaining:e.slice(n+1).join("/")}}return{value:t}}let O_=class{constructor({cid:e,bytes:t,value:n}){if(!e||!t||typeof n>"u")throw new Error("Missing required argument");this.cid=e,this.bytes=t,this.value=n,this.asBlock=this,Object.defineProperties(this,{cid:Vg(),bytes:Vg(),value:Vg(),asBlock:Vg()})}links(){return g6(this.value,[])}tree(){return y6(this.value,[])}get(e="/"){return jQ(this.value,e.split("/").filter(Boolean))}};async function nd({value:r,codec:e,hasher:t}){if(typeof r>"u")throw new Error('Missing required argument "value"');if(!e||!t)throw new Error("Missing required argument: codec or hasher");const n=e.encode(r),i=await t.digest(n),s=Yi.create(1,e.code,i);return new O_({value:r,bytes:n,cid:s})}async function Kg({bytes:r,codec:e,hasher:t}){if(!r)throw new Error('Missing required argument "bytes"');if(!e||!t)throw new Error("Missing required argument: codec or hasher");const n=e.decode(r),i=await t.digest(r),s=Yi.create(1,e.code,i);return new O_({value:n,bytes:r,cid:s})}const HQ=["string","number","bigint","symbol"],qQ=["Function","Generator","AsyncGenerator","GeneratorFunction","AsyncGeneratorFunction","AsyncFunction","Observable","Array","Buffer","Object","RegExp","Date","Error","Map","Set","WeakMap","WeakSet","ArrayBuffer","SharedArrayBuffer","DataView","Promise","URL","HTMLElement","Int8Array","Uint8Array","Uint8ClampedArray","Int16Array","Uint16Array","Int32Array","Uint32Array","Float32Array","Float64Array","BigInt64Array","BigUint64Array"];function WQ(r){if(r===null)return"null";if(r===void 0)return"undefined";if(r===!0||r===!1)return"boolean";const e=typeof r;if(HQ.includes(e))return e;if(e==="function")return"Function";if(Array.isArray(r))return"Array";if(GQ(r))return"Buffer";const t=QQ(r);return t||"Object"}function GQ(r){return r&&r.constructor&&r.constructor.isBuffer&&r.constructor.isBuffer.call(null,r)}function QQ(r){const e=Object.prototype.toString.call(r).slice(8,-1);if(qQ.includes(e))return e}class V{constructor(e,t,n){this.major=e,this.majorEncoded=e<<5,this.name=t,this.terminal=n}toString(){return`Type[${this.major}].${this.name}`}compare(e){return this.major<e.major?-1:this.major>e.major?1:0}}V.uint=new V(0,"uint",!0),V.negint=new V(1,"negint",!0),V.bytes=new V(2,"bytes",!0),V.string=new V(3,"string",!0),V.array=new V(4,"array",!1),V.map=new V(5,"map",!1),V.tag=new V(6,"tag",!1),V.float=new V(7,"float",!0),V.false=new V(7,"false",!0),V.true=new V(7,"true",!0),V.null=new V(7,"null",!0),V.undefined=new V(7,"undefined",!0),V.break=new V(7,"break",!0);class ne{constructor(e,t,n){this.type=e,this.value=t,this.encodedLength=n,this.encodedBytes=void 0,this.byteValue=void 0}toString(){return`Token[${this.type}].${this.value}`}}const id=globalThis.process&&!globalThis.process.browser&&globalThis.Buffer&&typeof globalThis.Buffer.isBuffer=="function",YQ=new TextDecoder,JQ=new TextEncoder;function jg(r){return id&&globalThis.Buffer.isBuffer(r)}function m6(r){return r instanceof Uint8Array?jg(r)?new Uint8Array(r.buffer,r.byteOffset,r.byteLength):r:Uint8Array.from(r)}const XQ=id?(r,e,t)=>t-e>64?globalThis.Buffer.from(r.subarray(e,t)).toString("utf8"):B_(r,e,t):(r,e,t)=>t-e>64?YQ.decode(r.subarray(e,t)):B_(r,e,t),R_=id?r=>r.length>64?globalThis.Buffer.from(r):L_(r):r=>r.length>64?JQ.encode(r):L_(r),po=r=>Uint8Array.from(r),w6=id?(r,e,t)=>jg(r)?new Uint8Array(r.subarray(e,t)):r.slice(e,t):(r,e,t)=>r.slice(e,t),ZQ=id?(r,e)=>(r=r.map(t=>t instanceof Uint8Array?t:globalThis.Buffer.from(t)),m6(globalThis.Buffer.concat(r,e))):(r,e)=>{const t=new Uint8Array(e);let n=0;for(let i of r)n+i.length>t.length&&(i=i.subarray(0,t.length-n)),t.set(i,n),n+=i.length;return t},eY=id?r=>globalThis.Buffer.allocUnsafe(r):r=>new Uint8Array(r);function tY(r,e){if(jg(r)&&jg(e))return r.compare(e);for(let t=0;t<r.length;t++)if(r[t]!==e[t])return r[t]<e[t]?-1:1;return 0}function L_(r){const e=[];let t=0;for(let n=0;n<r.length;n++){let i=r.charCodeAt(n);i<128?e[t++]=i:i<2048?(e[t++]=i>>6|192,e[t++]=i&63|128):(i&64512)===55296&&n+1<r.length&&(r.charCodeAt(n+1)&64512)===56320?(i=65536+((i&1023)<<10)+(r.charCodeAt(++n)&1023),e[t++]=i>>18|240,e[t++]=i>>12&63|128,e[t++]=i>>6&63|128,e[t++]=i&63|128):(e[t++]=i>>12|224,e[t++]=i>>6&63|128,e[t++]=i&63|128)}return e}function B_(r,e,t){const n=[];for(;e<t;){const i=r[e];let s=null,o=i>239?4:i>223?3:i>191?2:1;if(e+o<=t){let a,c,l,d;switch(o){case 1:i<128&&(s=i);break;case 2:a=r[e+1],(a&192)===128&&(d=(i&31)<<6|a&63,d>127&&(s=d));break;case 3:a=r[e+1],c=r[e+2],(a&192)===128&&(c&192)===128&&(d=(i&15)<<12|(a&63)<<6|c&63,d>2047&&(d<55296||d>57343)&&(s=d));break;case 4:a=r[e+1],c=r[e+2],l=r[e+3],(a&192)===128&&(c&192)===128&&(l&192)===128&&(d=(i&15)<<18|(a&63)<<12|(c&63)<<6|l&63,d>65535&&d<1114112&&(s=d))}}s===null?(s=65533,o=1):s>65535&&(s-=65536,n.push(s>>>10&1023|55296),s=56320|s&1023),n.push(s),e+=o}return F_(n)}const U_=4096;function F_(r){const e=r.length;if(e<=U_)return String.fromCharCode.apply(String,r);let t="",n=0;for(;n<e;)t+=String.fromCharCode.apply(String,r.slice(n,n+=U_));return t}const rY=256;class z_{constructor(e=rY){this.chunkSize=e,this.cursor=0,this.maxCursor=-1,this.chunks=[],this._initReuseChunk=null}reset(){this.cursor=0,this.maxCursor=-1,this.chunks.length&&(this.chunks=[]),this._initReuseChunk!==null&&(this.chunks.push(this._initReuseChunk),this.maxCursor=this._initReuseChunk.length-1)}push(e){let t=this.chunks[this.chunks.length-1];if(this.cursor+e.length<=this.maxCursor+1){const i=t.length-(this.maxCursor-this.cursor)-1;t.set(e,i)}else{if(t){const i=t.length-(this.maxCursor-this.cursor)-1;i<t.length&&(this.chunks[this.chunks.length-1]=t.subarray(0,i),this.maxCursor=this.cursor-1)}e.length<64&&e.length<this.chunkSize?(t=eY(this.chunkSize),this.chunks.push(t),this.maxCursor+=t.length,this._initReuseChunk===null&&(this._initReuseChunk=t),t.set(e,0)):(this.chunks.push(e),this.maxCursor+=e.length)}this.cursor+=e.length}toBytes(e=!1){let t;if(this.chunks.length===1){const n=this.chunks[0];e&&this.cursor>n.length/2?(t=this.cursor===n.length?n:n.subarray(0,this.cursor),this._initReuseChunk=null,this.chunks=[]):t=w6(n,0,this.cursor)}else t=ZQ(this.chunks,this.cursor);return e&&this.reset(),t}}const Ce="CBOR decode error:",il="CBOR encode error:";function sd(r,e,t){if(r.length-e<t)throw new Error(`${Ce} not enough data for type`)}const br=[24,256,65536,4294967296,BigInt("18446744073709551616")];function sl(r,e,t){sd(r,e,1);const n=r[e];if(t.strict===!0&&n<br[0])throw new Error(`${Ce} integer encoded in more bytes than necessary (strict decode)`);return n}function ol(r,e,t){sd(r,e,2);const n=r[e]<<8|r[e+1];if(t.strict===!0&&n<br[1])throw new Error(`${Ce} integer encoded in more bytes than necessary (strict decode)`);return n}function al(r,e,t){sd(r,e,4);const n=r[e]*16777216+(r[e+1]<<16)+(r[e+2]<<8)+r[e+3];if(t.strict===!0&&n<br[2])throw new Error(`${Ce} integer encoded in more bytes than necessary (strict decode)`);return n}function cl(r,e,t){sd(r,e,8);const n=r[e]*16777216+(r[e+1]<<16)+(r[e+2]<<8)+r[e+3],i=r[e+4]*16777216+(r[e+5]<<16)+(r[e+6]<<8)+r[e+7],s=(BigInt(n)<<BigInt(32))+BigInt(i);if(t.strict===!0&&s<br[3])throw new Error(`${Ce} integer encoded in more bytes than necessary (strict decode)`);if(s<=Number.MAX_SAFE_INTEGER)return Number(s);if(t.allowBigInt===!0)return s;throw new Error(`${Ce} integers outside of the safe integer range are not supported`)}function nY(r,e,t,n){return new ne(V.uint,sl(r,e+1,n),2)}function iY(r,e,t,n){return new ne(V.uint,ol(r,e+1,n),3)}function sY(r,e,t,n){return new ne(V.uint,al(r,e+1,n),5)}function oY(r,e,t,n){return new ne(V.uint,cl(r,e+1,n),9)}function ll(r,e){return vi(r,0,e.value)}function vi(r,e,t){if(t<br[0]){const n=Number(t);r.push([e|n])}else if(t<br[1]){const n=Number(t);r.push([e|24,n])}else if(t<br[2]){const n=Number(t);r.push([e|25,n>>>8,n&255])}else if(t<br[3]){const n=Number(t);r.push([e|26,n>>>24&255,n>>>16&255,n>>>8&255,n&255])}else{const n=BigInt(t);if(n<br[4]){const i=[e|27,0,0,0,0,0,0,0];let s=Number(n&BigInt(4294967295)),o=Number(n>>BigInt(32)&BigInt(4294967295));i[8]=s&255,s=s>>8,i[7]=s&255,s=s>>8,i[6]=s&255,s=s>>8,i[5]=s&255,i[4]=o&255,o=o>>8,i[3]=o&255,o=o>>8,i[2]=o&255,o=o>>8,i[1]=o&255,r.push(i)}else throw new Error(`${Ce} encountered BigInt larger than allowable range`)}}ll.encodedSize=function(e){return vi.encodedSize(e.value)},vi.encodedSize=function(e){return e<br[0]?1:e<br[1]?2:e<br[2]?3:e<br[3]?5:9},ll.compareTokens=function(e,t){return e.value<t.value?-1:e.value>t.value?1:0};function aY(r,e,t,n){return new ne(V.negint,-1-sl(r,e+1,n),2)}function cY(r,e,t,n){return new ne(V.negint,-1-ol(r,e+1,n),3)}function lY(r,e,t,n){return new ne(V.negint,-1-al(r,e+1,n),5)}const b6=BigInt(-1),V_=BigInt(1);function uY(r,e,t,n){const i=cl(r,e+1,n);if(typeof i!="bigint"){const s=-1-i;if(s>=Number.MIN_SAFE_INTEGER)return new ne(V.negint,s,9)}if(n.allowBigInt!==!0)throw new Error(`${Ce} integers outside of the safe integer range are not supported`);return new ne(V.negint,b6-BigInt(i),9)}function v6(r,e){const t=e.value,n=typeof t=="bigint"?t*b6-V_:t*-1-1;vi(r,e.type.majorEncoded,n)}v6.encodedSize=function(e){const t=e.value,n=typeof t=="bigint"?t*b6-V_:t*-1-1;return n<br[0]?1:n<br[1]?2:n<br[2]?3:n<br[3]?5:9},v6.compareTokens=function(e,t){return e.value<t.value?1:e.value>t.value?-1:0};function qf(r,e,t,n){sd(r,e,t+n);const i=w6(r,e+t,e+t+n);return new ne(V.bytes,i,t+n)}function dY(r,e,t,n){return qf(r,e,1,t)}function hY(r,e,t,n){return qf(r,e,2,sl(r,e+1,n))}function fY(r,e,t,n){return qf(r,e,3,ol(r,e+1,n))}function pY(r,e,t,n){return qf(r,e,5,al(r,e+1,n))}function gY(r,e,t,n){const i=cl(r,e+1,n);if(typeof i=="bigint")throw new Error(`${Ce} 64-bit integer bytes lengths not supported`);return qf(r,e,9,i)}function Hg(r){return r.encodedBytes===void 0&&(r.encodedBytes=r.type===V.string?R_(r.value):r.value),r.encodedBytes}function qg(r,e){const t=Hg(e);vi(r,e.type.majorEncoded,t.length),r.push(t)}qg.encodedSize=function(e){const t=Hg(e);return vi.encodedSize(t.length)+t.length},qg.compareTokens=function(e,t){return yY(Hg(e),Hg(t))};function yY(r,e){return r.length<e.length?-1:r.length>e.length?1:tY(r,e)}function Wf(r,e,t,n,i){const s=t+n;sd(r,e,s);const o=new ne(V.string,XQ(r,e+t,e+s),s);return i.retainStringBytes===!0&&(o.byteValue=w6(r,e+t,e+s)),o}function mY(r,e,t,n){return Wf(r,e,1,t,n)}function wY(r,e,t,n){return Wf(r,e,2,sl(r,e+1,n),n)}function bY(r,e,t,n){return Wf(r,e,3,ol(r,e+1,n),n)}function vY(r,e,t,n){return Wf(r,e,5,al(r,e+1,n),n)}function EY(r,e,t,n){const i=cl(r,e+1,n);if(typeof i=="bigint")throw new Error(`${Ce} 64-bit integer string lengths not supported`);return Wf(r,e,9,i,n)}const SY=qg;function od(r,e,t,n){return new ne(V.array,n,t)}function xY(r,e,t,n){return od(r,e,1,t)}function AY(r,e,t,n){return od(r,e,2,sl(r,e+1,n))}function CY(r,e,t,n){return od(r,e,3,ol(r,e+1,n))}function IY(r,e,t,n){return od(r,e,5,al(r,e+1,n))}function kY(r,e,t,n){const i=cl(r,e+1,n);if(typeof i=="bigint")throw new Error(`${Ce} 64-bit integer array lengths not supported`);return od(r,e,9,i)}function _Y(r,e,t,n){if(n.allowIndefinite===!1)throw new Error(`${Ce} indefinite length items not allowed`);return od(r,e,1,1/0)}function E6(r,e){vi(r,V.array.majorEncoded,e.value)}E6.compareTokens=ll.compareTokens,E6.encodedSize=function(e){return vi.encodedSize(e.value)};function ad(r,e,t,n){return new ne(V.map,n,t)}function TY(r,e,t,n){return ad(r,e,1,t)}function PY(r,e,t,n){return ad(r,e,2,sl(r,e+1,n))}function DY(r,e,t,n){return ad(r,e,3,ol(r,e+1,n))}function $Y(r,e,t,n){return ad(r,e,5,al(r,e+1,n))}function NY(r,e,t,n){const i=cl(r,e+1,n);if(typeof i=="bigint")throw new Error(`${Ce} 64-bit integer map lengths not supported`);return ad(r,e,9,i)}function MY(r,e,t,n){if(n.allowIndefinite===!1)throw new Error(`${Ce} indefinite length items not allowed`);return ad(r,e,1,1/0)}function S6(r,e){vi(r,V.map.majorEncoded,e.value)}S6.compareTokens=ll.compareTokens,S6.encodedSize=function(e){return vi.encodedSize(e.value)};function OY(r,e,t,n){return new ne(V.tag,t,1)}function RY(r,e,t,n){return new ne(V.tag,sl(r,e+1,n),2)}function LY(r,e,t,n){return new ne(V.tag,ol(r,e+1,n),3)}function BY(r,e,t,n){return new ne(V.tag,al(r,e+1,n),5)}function UY(r,e,t,n){return new ne(V.tag,cl(r,e+1,n),9)}function x6(r,e){vi(r,V.tag.majorEncoded,e.value)}x6.compareTokens=ll.compareTokens,x6.encodedSize=function(e){return vi.encodedSize(e.value)};const FY=20,zY=21,VY=22,KY=23;function jY(r,e,t,n){if(n.allowUndefined===!1)throw new Error(`${Ce} undefined values are not supported`);return n.coerceUndefinedToNull===!0?new ne(V.null,null,1):new ne(V.undefined,void 0,1)}function HY(r,e,t,n){if(n.allowIndefinite===!1)throw new Error(`${Ce} indefinite length items not allowed`);return new ne(V.break,void 0,1)}function A6(r,e,t){if(t){if(t.allowNaN===!1&&Number.isNaN(r))throw new Error(`${Ce} NaN values are not supported`);if(t.allowInfinity===!1&&(r===1/0||r===-1/0))throw new Error(`${Ce} Infinity values are not supported`)}return new ne(V.float,r,e)}function qY(r,e,t,n){return A6(I6(r,e+1),3,n)}function WY(r,e,t,n){return A6(k6(r,e+1),5,n)}function GY(r,e,t,n){return A6(q_(r,e+1),9,n)}function C6(r,e,t){const n=e.value;if(n===!1)r.push([V.float.majorEncoded|FY]);else if(n===!0)r.push([V.float.majorEncoded|zY]);else if(n===null)r.push([V.float.majorEncoded|VY]);else if(n===void 0)r.push([V.float.majorEncoded|KY]);else{let i,s=!1;(!t||t.float64!==!0)&&(j_(n),i=I6(Ji,1),n===i||Number.isNaN(n)?(Ji[0]=249,r.push(Ji.slice(0,3)),s=!0):(H_(n),i=k6(Ji,1),n===i&&(Ji[0]=250,r.push(Ji.slice(0,5)),s=!0))),s||(QY(n),i=q_(Ji,1),Ji[0]=251,r.push(Ji.slice(0,9)))}}C6.encodedSize=function(e,t){const n=e.value;if(n===!1||n===!0||n===null||n===void 0)return 1;if(!t||t.float64!==!0){j_(n);let i=I6(Ji,1);if(n===i||Number.isNaN(n))return 3;if(H_(n),i=k6(Ji,1),n===i)return 5}return 9};const K_=new ArrayBuffer(9),Ei=new DataView(K_,1),Ji=new Uint8Array(K_,0);function j_(r){if(r===1/0)Ei.setUint16(0,31744,!1);else if(r===-1/0)Ei.setUint16(0,64512,!1);else if(Number.isNaN(r))Ei.setUint16(0,32256,!1);else{Ei.setFloat32(0,r);const e=Ei.getUint32(0),t=(e&2139095040)>>23,n=e&8388607;if(t===255)Ei.setUint16(0,31744,!1);else if(t===0)Ei.setUint16(0,(r&2147483648)>>16|n>>13,!1);else{const i=t-127;i<-24?Ei.setUint16(0,0):i<-14?Ei.setUint16(0,(e&2147483648)>>16|1<<24+i,!1):Ei.setUint16(0,(e&2147483648)>>16|i+15<<10|n>>13,!1)}}}function I6(r,e){if(r.length-e<2)throw new Error(`${Ce} not enough data for float16`);const t=(r[e]<<8)+r[e+1];if(t===31744)return 1/0;if(t===64512)return-1/0;if(t===32256)return NaN;const n=t>>10&31,i=t&1023;let s;return n===0?s=i*2**-24:n!==31?s=(i+1024)*2**(n-25):s=i===0?1/0:NaN,t&32768?-s:s}function H_(r){Ei.setFloat32(0,r,!1)}function k6(r,e){if(r.length-e<4)throw new Error(`${Ce} not enough data for float32`);const t=(r.byteOffset||0)+e;return new DataView(r.buffer,t,4).getFloat32(0,!1)}function QY(r){Ei.setFloat64(0,r,!1)}function q_(r,e){if(r.length-e<8)throw new Error(`${Ce} not enough data for float64`);const t=(r.byteOffset||0)+e;return new DataView(r.buffer,t,8).getFloat64(0,!1)}C6.compareTokens=ll.compareTokens;function nt(r,e,t){throw new Error(`${Ce} encountered invalid minor (${t}) for major ${r[e]>>>5}`)}function Wg(r){return()=>{throw new Error(`${Ce} ${r}`)}}const ce=[];for(let r=0;r<=23;r++)ce[r]=nt;ce[24]=nY,ce[25]=iY,ce[26]=sY,ce[27]=oY,ce[28]=nt,ce[29]=nt,ce[30]=nt,ce[31]=nt;for(let r=32;r<=55;r++)ce[r]=nt;ce[56]=aY,ce[57]=cY,ce[58]=lY,ce[59]=uY,ce[60]=nt,ce[61]=nt,ce[62]=nt,ce[63]=nt;for(let r=64;r<=87;r++)ce[r]=dY;ce[88]=hY,ce[89]=fY,ce[90]=pY,ce[91]=gY,ce[92]=nt,ce[93]=nt,ce[94]=nt,ce[95]=Wg("indefinite length bytes/strings are not supported");for(let r=96;r<=119;r++)ce[r]=mY;ce[120]=wY,ce[121]=bY,ce[122]=vY,ce[123]=EY,ce[124]=nt,ce[125]=nt,ce[126]=nt,ce[127]=Wg("indefinite length bytes/strings are not supported");for(let r=128;r<=151;r++)ce[r]=xY;ce[152]=AY,ce[153]=CY,ce[154]=IY,ce[155]=kY,ce[156]=nt,ce[157]=nt,ce[158]=nt,ce[159]=_Y;for(let r=160;r<=183;r++)ce[r]=TY;ce[184]=PY,ce[185]=DY,ce[186]=$Y,ce[187]=NY,ce[188]=nt,ce[189]=nt,ce[190]=nt,ce[191]=MY;for(let r=192;r<=215;r++)ce[r]=OY;ce[216]=RY,ce[217]=LY,ce[218]=BY,ce[219]=UY,ce[220]=nt,ce[221]=nt,ce[222]=nt,ce[223]=nt;for(let r=224;r<=243;r++)ce[r]=Wg("simple values are not supported");ce[244]=nt,ce[245]=nt,ce[246]=nt,ce[247]=jY,ce[248]=Wg("simple values are not supported"),ce[249]=qY,ce[250]=WY,ce[251]=GY,ce[252]=nt,ce[253]=nt,ce[254]=nt,ce[255]=HY;const As=[];for(let r=0;r<24;r++)As[r]=new ne(V.uint,r,1);for(let r=-1;r>=-24;r--)As[31-r]=new ne(V.negint,r,1);As[64]=new ne(V.bytes,new Uint8Array(0),1),As[96]=new ne(V.string,"",1),As[128]=new ne(V.array,0,1),As[160]=new ne(V.map,0,1),As[244]=new ne(V.false,!1,1),As[245]=new ne(V.true,!0,1),As[246]=new ne(V.null,null,1);function YY(r){switch(r.type){case V.false:return po([244]);case V.true:return po([245]);case V.null:return po([246]);case V.bytes:return r.value.length?void 0:po([64]);case V.string:return r.value===""?po([96]):void 0;case V.array:return r.value===0?po([128]):void 0;case V.map:return r.value===0?po([160]):void 0;case V.uint:return r.value<24?po([Number(r.value)]):void 0;case V.negint:if(r.value>=-24)return po([31-Number(r.value)])}}const JY={float64:!1,mapSorter:eJ,quickEncodeToken:YY};function XY(){const r=[];return r[V.uint.major]=ll,r[V.negint.major]=v6,r[V.bytes.major]=qg,r[V.string.major]=SY,r[V.array.major]=E6,r[V.map.major]=S6,r[V.tag.major]=x6,r[V.float.major]=C6,r}const W_=XY(),_6=new z_;class Gg{constructor(e,t){this.obj=e,this.parent=t}includes(e){let t=this;do if(t.obj===e)return!0;while(t=t.parent);return!1}static createCheck(e,t){if(e&&e.includes(t))throw new Error(`${il} object contains circular references`);return new Gg(t,e)}}const $a={null:new ne(V.null,null),undefined:new ne(V.undefined,void 0),true:new ne(V.true,!0),false:new ne(V.false,!1),emptyArray:new ne(V.array,0),emptyMap:new ne(V.map,0)},Na={number(r,e,t,n){return!Number.isInteger(r)||!Number.isSafeInteger(r)?new ne(V.float,r):r>=0?new ne(V.uint,r):new ne(V.negint,r)},bigint(r,e,t,n){return r>=BigInt(0)?new ne(V.uint,r):new ne(V.negint,r)},Uint8Array(r,e,t,n){return new ne(V.bytes,r)},string(r,e,t,n){return new ne(V.string,r)},boolean(r,e,t,n){return r?$a.true:$a.false},null(r,e,t,n){return $a.null},undefined(r,e,t,n){return $a.undefined},ArrayBuffer(r,e,t,n){return new ne(V.bytes,new Uint8Array(r))},DataView(r,e,t,n){return new ne(V.bytes,new Uint8Array(r.buffer,r.byteOffset,r.byteLength))},Array(r,e,t,n){if(!r.length)return t.addBreakTokens===!0?[$a.emptyArray,new ne(V.break)]:$a.emptyArray;n=Gg.createCheck(n,r);const i=[];let s=0;for(const o of r)i[s++]=Qg(o,t,n);return t.addBreakTokens?[new ne(V.array,r.length),i,new ne(V.break)]:[new ne(V.array,r.length),i]},Object(r,e,t,n){const i=e!=="Object",s=i?r.keys():Object.keys(r),o=i?r.size:s.length;if(!o)return t.addBreakTokens===!0?[$a.emptyMap,new ne(V.break)]:$a.emptyMap;n=Gg.createCheck(n,r);const a=[];let c=0;for(const l of s)a[c++]=[Qg(l,t,n),Qg(i?r.get(l):r[l],t,n)];return ZY(a,t),t.addBreakTokens?[new ne(V.map,o),a,new ne(V.break)]:[new ne(V.map,o),a]}};Na.Map=Na.Object,Na.Buffer=Na.Uint8Array;for(const r of"Uint8Clamped Uint16 Uint32 Int8 Int16 Int32 BigUint64 BigInt64 Float32 Float64".split(" "))Na[`${r}Array`]=Na.DataView;function Qg(r,e={},t){const n=WQ(r),i=e&&e.typeEncoders&&e.typeEncoders[n]||Na[n];if(typeof i=="function"){const o=i(r,n,e,t);if(o!=null)return o}const s=Na[n];if(!s)throw new Error(`${il} unsupported type: ${n}`);return s(r,n,e,t)}function ZY(r,e){e.mapSorter&&r.sort(e.mapSorter)}function eJ(r,e){const t=Array.isArray(r[0])?r[0][0]:r[0],n=Array.isArray(e[0])?e[0][0]:e[0];if(t.type!==n.type)return t.type.compare(n.type);const i=t.type.major,s=W_[i].compareTokens(t,n);return s===0&&console.warn("WARNING: complex key types used, CBOR key sorting guarantees are gone"),s}function G_(r,e,t,n){if(Array.isArray(e))for(const i of e)G_(r,i,t,n);else t[e.type.major](r,e,n)}function Q_(r,e,t){const n=Qg(r,t);if(!Array.isArray(n)&&t.quickEncodeToken){const i=t.quickEncodeToken(n);if(i)return i;const s=e[n.type.major];if(s.encodedSize){const o=s.encodedSize(n,t),a=new z_(o);if(s(a,n,t),a.chunks.length!==1)throw new Error(`Unexpected error: pre-calculated length for ${n} was wrong`);return m6(a.chunks[0])}}return _6.reset(),G_(_6,n,e,t),_6.toBytes(!0)}function Yg(r,e){return e=Object.assign({},JY,e),Q_(r,W_,e)}const tJ={strict:!1,allowIndefinite:!0,allowUndefined:!0,allowBigInt:!0};class rJ{constructor(e,t={}){this._pos=0,this.data=e,this.options=t}pos(){return this._pos}done(){return this._pos>=this.data.length}next(){const e=this.data[this._pos];let t=As[e];if(t===void 0){const n=ce[e];if(!n)throw new Error(`${Ce} no decoder for major type ${e>>>5} (byte 0x${e.toString(16).padStart(2,"0")})`);const i=e&31;t=n(this.data,this._pos,i,this.options)}return this._pos+=t.encodedLength,t}}const Gf=Symbol.for("DONE"),Jg=Symbol.for("BREAK");function nJ(r,e,t){const n=[];for(let i=0;i<r.value;i++){const s=Qf(e,t);if(s===Jg){if(r.value===1/0)break;throw new Error(`${Ce} got unexpected break to lengthed array`)}if(s===Gf)throw new Error(`${Ce} found array but not enough entries (got ${i}, expected ${r.value})`);n[i]=s}return n}function iJ(r,e,t){const n=t.useMaps===!0,i=n?void 0:{},s=n?new Map:void 0;for(let o=0;o<r.value;o++){const a=Qf(e,t);if(a===Jg){if(r.value===1/0)break;throw new Error(`${Ce} got unexpected break to lengthed map`)}if(a===Gf)throw new Error(`${Ce} found map but not enough entries (got ${o} [no key], expected ${r.value})`);if(n!==!0&&typeof a!="string")throw new Error(`${Ce} non-string keys not supported (got ${typeof a})`);if(t.rejectDuplicateMapKeys===!0&&(n&&s.has(a)||!n&&a in i))throw new Error(`${Ce} found repeat map key "${a}"`);const c=Qf(e,t);if(c===Gf)throw new Error(`${Ce} found map but not enough entries (got ${o} [no value], expected ${r.value})`);n?s.set(a,c):i[a]=c}return n?s:i}function Qf(r,e){if(r.done())return Gf;const t=r.next();if(t.type===V.break)return Jg;if(t.type.terminal)return t.value;if(t.type===V.array)return nJ(t,r,e);if(t.type===V.map)return iJ(t,r,e);if(t.type===V.tag){if(e.tags&&typeof e.tags[t.value]=="function"){const n=Qf(r,e);return e.tags[t.value](n)}throw new Error(`${Ce} tag not supported (${t.value})`)}throw new Error("unsupported")}function sJ(r,e){if(!(r instanceof Uint8Array))throw new Error(`${Ce} data to decode must be a Uint8Array`);e=Object.assign({},tJ,e);const t=e.tokenizer||new rJ(r,e),n=Qf(t,e);if(n===Gf)throw new Error(`${Ce} did not find any content to decode`);if(n===Jg)throw new Error(`${Ce} got unexpected break`);return[n,r.subarray(t.pos())]}function Ma(r,e){const[t,n]=sJ(r,e);if(n.length>0)throw new Error(`${Ce} too many terminals, data makes no sense`);return t}function oJ(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function T6(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function aJ(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var i=0;i<r.length;i++){var s=r.charAt(i),o=s.charCodeAt(0);if(t[o]!==255)throw new TypeError(s+" is ambiguous");t[o]=i}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),d=Math.log(256)/Math.log(a);function h(f){if(f instanceof Uint8Array||(ArrayBuffer.isView(f)?f=new Uint8Array(f.buffer,f.byteOffset,f.byteLength):Array.isArray(f)&&(f=Uint8Array.from(f))),!(f instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(f.length===0)return"";for(var g=0,w=0,y=0,b=f.length;y!==b&&f[y]===0;)y++,g++;for(var v=(b-y)*d+1>>>0,E=new Uint8Array(v);y!==b;){for(var C=f[y],k=0,x=v-1;(C!==0||k<w)&&x!==-1;x--,k++)C+=256*E[x]>>>0,E[x]=C%a>>>0,C=C/a>>>0;if(C!==0)throw new Error("Non-zero carry");w=k,y++}for(var I=v-w;I!==v&&E[I]===0;)I++;for(var T=c.repeat(g);I<v;++I)T+=r.charAt(E[I]);return T}function p(f){if(typeof f!="string")throw new TypeError("Expected String");if(f.length===0)return new Uint8Array;var g=0;if(f[g]!==" "){for(var w=0,y=0;f[g]===c;)w++,g++;for(var b=(f.length-g)*l+1>>>0,v=new Uint8Array(b);f[g];){var E=t[f.charCodeAt(g)];if(E===255)return;for(var C=0,k=b-1;(E!==0||C<y)&&k!==-1;k--,C++)E+=a*v[k]>>>0,v[k]=E%256>>>0,E=E/256>>>0;if(E!==0)throw new Error("Non-zero carry");y=C,g++}if(f[g]!==" "){for(var x=b-y;x!==b&&v[x]===0;)x++;for(var I=new Uint8Array(w+(b-x)),T=w;x!==b;)I[T++]=v[x++];return I}}}function m(f){var g=p(f);if(g)return g;throw new Error(`Non-${e} character`)}return{encode:h,decodeUnsafe:p,decode:m}}var cJ=aJ,lJ=cJ;let uJ=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseEncode");this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},dJ=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseDecode");u(this,"prefixCodePoint");this.name=e,this.prefix=t;const i=t.codePointAt(0);if(i===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=i,this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return Y_(this,e)}},hJ=class{constructor(e){u(this,"decoders");this.decoders=e}or(e){return Y_(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};function Y_(r,e){return new hJ({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}let fJ=class{constructor(e,t,n,i){u(this,"name");u(this,"prefix");u(this,"baseEncode");u(this,"baseDecode");u(this,"encoder");u(this,"decoder");this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=i,this.encoder=new uJ(e,t,n),this.decoder=new dJ(e,t,i)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};function J_({name:r,prefix:e,encode:t,decode:n}){return new fJ(r,e,t,n)}function Xg({name:r,prefix:e,alphabet:t}){const{encode:n,decode:i}=lJ(t,r);return J_({prefix:e,name:r,encode:n,decode:s=>T6(i(s))})}function pJ(r,e,t,n){const i={};for(let d=0;d<e.length;++d)i[e[d]]=d;let s=r.length;for(;r[s-1]==="=";)--s;const o=new Uint8Array(s*t/8|0);let a=0,c=0,l=0;for(let d=0;d<s;++d){const h=i[r[d]];if(h===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|h,a+=t,a>=8&&(a-=8,o[l++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o}function gJ(r,e,t){const n=e[e.length-1]==="=",i=(1<<t)-1;let s="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,s+=e[i&a>>o];if(o!==0&&(s+=e[i&a<<t-o]),n)for(;s.length*t&7;)s+="=";return s}function go({name:r,prefix:e,bitsPerChar:t,alphabet:n}){return J_({prefix:e,name:r,encode(i){return gJ(i,n,t)},decode(i){return pJ(i,n,t,r)}})}const Zg=go({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});go({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),go({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),go({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),go({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),go({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),go({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),go({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),go({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const P6=Xg({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"});Xg({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});const Oa=Xg({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});Xg({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var yJ=Z_,X_=128,mJ=-128,wJ=Math.pow(2,31);function Z_(r,e,t){e=e||[],t=t||0;for(var n=t;r>=wJ;)e[t++]=r&255|X_,r/=128;for(;r&mJ;)e[t++]=r&255|X_,r>>>=7;return e[t]=r|0,Z_.bytes=t-n+1,e}var bJ=D6,vJ=128,eT=127;function D6(r,n){var t=0,n=n||0,i=0,s=n,o,a=r.length;do{if(s>=a)throw D6.bytes=0,new RangeError("Could not decode varint");o=r[s++],t+=i<28?(o&eT)<<i:(o&eT)*Math.pow(2,i),i+=7}while(o>=vJ);return D6.bytes=s-n,t}var EJ=Math.pow(2,7),SJ=Math.pow(2,14),xJ=Math.pow(2,21),AJ=Math.pow(2,28),CJ=Math.pow(2,35),IJ=Math.pow(2,42),kJ=Math.pow(2,49),_J=Math.pow(2,56),TJ=Math.pow(2,63),PJ=function(r){return r<EJ?1:r<SJ?2:r<xJ?3:r<AJ?4:r<CJ?5:r<IJ?6:r<kJ?7:r<_J?8:r<TJ?9:10},DJ={encode:yJ,decode:bJ,encodingLength:PJ},e2=DJ;function $6(r,e=0){return[e2.decode(r,e),e2.decode.bytes]}function t2(r,e,t=0){return e2.encode(r,e,t),e}function r2(r){return e2.encodingLength(r)}function $J(r,e){const t=e.byteLength,n=r2(r),i=n+r2(t),s=new Uint8Array(i+t);return t2(r,s,0),t2(t,s,n),s.set(e,i),new N6(r,t,e,s)}function NJ(r){const e=T6(r),[t,n]=$6(e),[i,s]=$6(e.subarray(n)),o=e.subarray(n+s);if(o.byteLength!==i)throw new Error("Incorrect length");return new N6(t,i,o,e)}function MJ(r,e){if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&oJ(r.bytes,t.bytes)}}let N6=class{constructor(e,t,n,i){u(this,"code");u(this,"size");u(this,"digest");u(this,"bytes");this.code=e,this.size=t,this.digest=n,this.bytes=i}};function tT(r,e){const{bytes:t,version:n}=r;switch(n){case 0:return RJ(t,M6(r),e??Oa.encoder);default:return LJ(t,M6(r),e??Zg.encoder)}}const rT=new WeakMap;function M6(r){const e=rT.get(r);if(e==null){const t=new Map;return rT.set(r,t),t}return e}let nT=class Kr{constructor(e,t,n,i){u(this,"code");u(this,"version");u(this,"multihash");u(this,"bytes");u(this,"/");u(this,Ej,"CID");this.code=t,this.version=e,this.multihash=n,this.bytes=i,this["/"]=i}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==Yf)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==BJ)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return Kr.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=$J(e,t);return Kr.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return Kr.equals(this,e)}static equals(e,t){const n=t;return n!=null&&e.code===n.code&&e.version===n.version&&MJ(e.multihash,n.multihash)}toString(e){return tT(this,e)}toJSON(){return{"/":tT(this)}}link(){return this}[(Ej=Symbol.toStringTag,Symbol.for("nodejs.util.inspect.custom"))](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof Kr)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:i,multihash:s,bytes:o}=t;return new Kr(n,i,s,o??iT(n,i,s.bytes))}else if(t[UJ]===!0){const{version:n,multihash:i,code:s}=t,o=NJ(i);return Kr.create(n,s,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==Yf)throw new Error(`Version 0 CID must use dag-pb (code: ${Yf}) block encoding`);return new Kr(e,t,n,n.bytes)}case 1:{const i=iT(e,t,n.bytes);return new Kr(e,t,n,i)}default:throw new Error("Invalid version")}}static createV0(e){return Kr.create(0,Yf,e)}static createV1(e,t){return Kr.create(1,e,t)}static decode(e){const[t,n]=Kr.decodeFirst(e);if(n.length!==0)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=Kr.inspectBytes(e),n=t.size-t.multihashSize,i=T6(e.subarray(n,n+t.multihashSize));if(i.byteLength!==t.multihashSize)throw new Error("Incorrect length");const s=i.subarray(t.multihashSize-t.digestSize),o=new N6(t.multihashCode,t.digestSize,s,i);return[t.version===0?Kr.createV0(o):Kr.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[h,p]=$6(e.subarray(t));return t+=p,h};let i=n(),s=Yf;if(i===18?(i=0,t=0):s=n(),i!==0&&i!==1)throw new RangeError(`Invalid CID version ${i}`);const o=t,a=n(),c=n(),l=t+c,d=l-o;return{version:i,codec:s,multihashCode:a,digestSize:c,multihashSize:d,size:l}}static parse(e,t){const[n,i]=OJ(e,t),s=Kr.decode(i);if(s.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return M6(s).set(n,e),s}};function OJ(r,e){switch(r[0]){case"Q":{const t=e??Oa;return[Oa.prefix,t.decode(`${Oa.prefix}${r}`)]}case Oa.prefix:{const t=e??Oa;return[Oa.prefix,t.decode(r)]}case Zg.prefix:{const t=e??Zg;return[Zg.prefix,t.decode(r)]}case P6.prefix:{const t=e??P6;return[P6.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}}function RJ(r,e,t){const{prefix:n}=t;if(n!==Oa.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const i=e.get(n);if(i==null){const s=t.encode(r).slice(1);return e.set(n,s),s}else return i}function LJ(r,e,t){const{prefix:n}=t,i=e.get(n);if(i==null){const s=t.encode(r);return e.set(n,s),s}else return i}const Yf=112,BJ=18;function iT(r,e,t){const n=r2(r),i=n+r2(e),s=new Uint8Array(i+t.byteLength);return t2(r,s,0),t2(e,s,n),s.set(t,i),s}const UJ=Symbol.for("@ipld/js-cid/CID"),sT=42;function oT(r){return r instanceof ArrayBuffer?new Uint8Array(r,0,r.byteLength):r}function FJ(r){if(r.asCID!==r&&r["/"]!==r.bytes)return null;const e=nT.asCID(r);if(!e)return null;const t=new Uint8Array(e.bytes.byteLength+1);return t.set(e.bytes,1),[new ne(V.tag,sT),new ne(V.bytes,t)]}function zJ(){throw new Error("`undefined` is not supported by the IPLD Data Model and cannot be encoded")}function VJ(r){if(Number.isNaN(r))throw new Error("`NaN` is not supported by the IPLD Data Model and cannot be encoded");if(r===1/0||r===-1/0)throw new Error("`Infinity` and `-Infinity` is not supported by the IPLD Data Model and cannot be encoded");return null}const O6={float64:!0,typeEncoders:{Object:FJ,undefined:zJ,number:VJ}},KJ={...O6,typeEncoders:{...O6.typeEncoders}};function jJ(r){if(r[0]!==0)throw new Error("Invalid CID for CBOR tag 42; expected leading 0x00");return nT.decode(r.subarray(1))}const n2={allowIndefinite:!1,coerceUndefinedToNull:!0,allowNaN:!1,allowInfinity:!1,allowBigInt:!0,strict:!0,useMaps:!1,rejectDuplicateMapKeys:!0,tags:[]};n2.tags[sT]=jJ;const HJ={...n2,tags:n2.tags.slice()},qJ="dag-cbor",aT=113,Jf=Object.freeze(Object.defineProperty({__proto__:null,code:aT,decode:r=>Ma(oT(r),n2),decodeOptions:HJ,encode:r=>Yg(r,O6),encodeOptions:KJ,name:qJ,toByteView:oT},Symbol.toStringTag,{value:"Module"})),i2=FQ({name:"sha2-256",code:18,encode:(r=>async e=>new Uint8Array(await crypto.subtle.digest(r,e)))("SHA-256")}),s2=Jf,o2=i2,cT=ln,WJ=async(r,e,t,n=null,i=[],s=[])=>{if(r==null)throw new Error("Identity is required, cannot create entry");if(e==null)throw new Error("Entry requires an id");if(t==null)throw new Error("Entry requires a payload");if(i==null||!Array.isArray(i))throw new Error("'next' argument is not an array");n=n||Lg(r.publicKey);const o={id:e,payload:t,next:i,refs:s,clock:n,v:2},{bytes:a}=await nd({value:o,codec:s2,hasher:o2}),c=await r.sign(r,a);return o.key=r.publicKey,o.identity=r.hash,o.sig=c,uT(o)},GJ=async(r,e)=>{if(!r)throw new Error("Identities is required, cannot verify entry");if(!lT(e))throw new Error("Invalid Log entry");if(!e.key)throw new Error("Entry doesn't have a key");if(!e.sig)throw new Error("Entry doesn't have a signature");const t={id:e.id,payload:e.payload,next:e.next,refs:e.refs,clock:e.clock,v:e.v},{bytes:n}=await nd({value:t,codec:s2,hasher:o2});return r.verify(e.sig,e.key,n)},lT=r=>r&&r.id!==void 0&&r.next!==void 0&&r.payload!==void 0&&r.v!==void 0&&r.clock!==void 0&&r.refs!==void 0,QJ=(r,e)=>r&&e&&r.hash===e.hash,YJ=async r=>{const{cid:e,value:t}=await Kg({bytes:r,codec:s2,hasher:o2}),n=e.toString(cT);return{...t,hash:n,bytes:r}},uT=async r=>{const{cid:e,bytes:t}=await nd({value:r,codec:s2,hasher:o2}),n=e.toString(cT),i=Lg(r.clock.id,r.clock.time);return{...r,clock:i,hash:n,bytes:t}},yo={create:WJ,verify:GJ,decode:YJ,encode:uT,isEntry:lT,isEqual:QJ},R6=async()=>{let r={};const e=async(c,l)=>{r[c]=l};return{put:e,del:async c=>{delete r[c]},get:async c=>r[c],iterator:async function*(){for await(const[c,l]of Object.entries(r))yield[c,l]},merge:async c=>{if(c)for await(const[l,d]of c.iterator())e(l,d)},clear:async()=>{r={}},close:async()=>{}}},JJ=R6,XJ=async({storage:r,heads:e})=>{r=r||await JJ();const t=async d=>{d=dT(d);for(const h of d)await r.put(h.hash,h.bytes)},n=async d=>{await r.clear(),await t(d)},i=async d=>{const h=await a();if(h.find(m=>yo.isEqual(m,d)))return;const p=dT([...h,d]);return await n(p),p},s=async d=>{const p=(await a()).filter(m=>m.hash!==d);await n(p)},o=async function*(){const d=r.iterator();for await(const[,h]of d)yield await yo.decode(h)},a=async()=>{const d=[];for await(const h of o())d.push(h);return d},c=async()=>{await r.clear()},l=async()=>{await r.close()};return await t(e||[]),{put:t,set:n,add:i,remove:s,iterator:o,all:a,clear:c,close:l}},dT=r=>{r=new Set(r);const e={};for(const n of r)for(const i of n.next)e[i]=n.hash;const t=[];for(const n of r)e[n.hash]||t.push(n);return t};function ZJ(r,e){const t=(s,o)=>s,n=(s,o)=>tX(s,o,t);return((s,o)=>eX(s,o,n))(r,e)}function eX(r,e,t){const n=sQ(r.clock,e.clock);return n===0?t(r,e):n}function tX(r,e,t){return r.clock.id===e.clock.id?t(r,e):r.clock.id<e.clock.id?-1:1}function rX(r){const e=`Your log's tiebreaker function, ${r.name}, has returned zero and therefore cannot be`;return(n,i)=>{const s=r(n,i);if(s===0)throw Error(e);return s}}const nX={LastWriteWins:ZJ,NoZeroes:rX},{LastWriteWins:iX,NoZeroes:sX}=nX,oX=()=>new Date().getTime().toString(),aX=(r,e)=>Math.max(r,e.clock.time),L6=R6,cX=async()=>({canAppend:async r=>!0}),lX=async(r,{logId:e,logHeads:t,access:n,entryStorage:i,headsStorage:s,indexStorage:o,sortFn:a}={})=>{if(r==null)throw new Error("Identity is required");if(t!=null&&!Array.isArray(t))throw new Error("'logHeads' argument must be an array");const c=e||oX();n=n||await cX();const l=i||await L6(),d=o||await L6();s=s||await L6();const h=await XJ({storage:s,heads:t});a=sX(a||iX);const p=new Ta({concurrency:1}),m=new Ta({concurrency:1}),f=async()=>{const B=Math.max(0,(await g()).reduce(aX,0));return Lg(r.publicKey,B)},g=async()=>(await h.all()).sort(a).reverse(),w=async()=>{const B=[];for await(const G of k())B.unshift(G);return B},y=async B=>{const G=await l.get(B);if(G)return await yo.decode(G)},b=async B=>await d.get(B)!=null,v=async(B,G={referencesCount:0})=>{const K=async()=>{const q=await g(),Q=q.map(W=>W.hash),j=await z(q,G.referencesCount+q.length),O=await yo.create(r,c,B,oQ(await f()),Q,j);if(!await n.canAppend(O))throw new Error(`Could not append entry:
Key "${r.hash}" is not allowed to write to the log`);return await h.set([O]),await l.put(O.hash,O.bytes),await d.put(O.hash,!0),O};return p.add(K)},E=async B=>{if(!B)throw new Error("Log instance not defined");if(!L(B))throw new Error("Given argument is not an instance of Log");l.merge&&await l.merge(B.storage);const G=await B.heads();for(const K of G)await C(K)},C=async B=>{const G=async()=>{if(await b(B.hash))return!1;const q=async Y=>{if(Y.id!==c)throw new Error(`Entry's id (${Y.id}) doesn't match the log's id (${c}).`);if(!await n.canAppend(Y))throw new Error(`Could not append entry:
Key "${Y.identity}" is not allowed to write to the log`);if(!await yo.verify(r,Y))throw new Error(`Could not validate signature for entry "${Y.hash}"`)};await q(B);const Q=(await g()).map(Y=>Y.hash),j=new Set([B.hash]),O=new Set([...B.next,...B.refs]),U=new Set,W=async()=>{const Y=Array.from(O.values()).filter(b).map(y),H=await Promise.all(Y);for(const oe of H){O.delete(oe.hash),await q(oe),j.add(oe.hash);for(const ye of[...oe.next,...oe.refs])!await b(ye)&&!j.has(ye)?O.add(ye):Q.includes(ye)&&U.add(ye)}O.size>0&&await W()};await W();for(const Y of j.values())await d.put(Y,!0);for(const Y of U.values())await h.remove(Y);return await l.put(B.hash,B.bytes),await h.add(B),!0};return m.add(G)},k=async function*(B,G){G=G||(()=>!1),B=B||await g();let q=B.sort(a);const Q={};let j=[];const O={},U=Y=>!(Q[Y]||O[Y]);let W;for(;q.length>0;)if(q=q.sort(a),W=q.pop(),W){const{hash:Y,next:H}=W;if(!Q[Y]){if(yield W,await G(W)===!0)break;Q[Y]=!0,O[Y]=!0,j=[...j,...H].filter(U);const ye=le=>{if(!Q[le]&&!O[le])return O[le]=!0,y(le)},de=await Promise.all(j.map(ye));j=de.filter(le=>le!=null).reduce((le,$e)=>Array.from(new Set([...le,...$e.next])),[]).filter(U),q=[...de,...q]}}},x=async function*({amount:B=-1,gt:G,gte:K,lt:q,lte:Q}={}){if(B===0)return;if(typeof Q=="string"&&(Q=[await y(Q)]),typeof q=="string"){const le=await y(q);q=await Promise.all(le.next.map(Ne=>y(Ne)))}if(q!=null&&!Array.isArray(q))throw new Error("lt must be a string or an array of Entries");if(Q!=null&&!Array.isArray(Q))throw new Error("lte must be a string or an array of Entries");const j=(q||Q||await g()).filter(le=>le!=null),O=G||K?await y(G||K):null,U=O||B===-1?-1:B;let W=0;const Y=async le=>(W++,le?!!(W>=U&&U!==-1||O&&yo.isEqual(le,O)):!1),H=O&&B!==-1&&!q&&!Q,oe=H?new c6(B+2):null;let ye=0;const de=k(j,Y);for await(const le of de){const $e=q&&yo.isEqual(le,j),Ne=G&&yo.isEqual(le,O);$e||Ne||(H?oe.set(ye++,le.hash):yield le)}if(H){const le=oe.keys.length,$e=le>B?le-B:0,Ne=oe.keys.slice($e,le);for(const Ie of Ne){const tt=oe.get(Ie);yield await y(tt)}}},I=async()=>{await d.clear(),await h.clear(),await l.clear()},T=async()=>{await d.close(),await h.close(),await l.close()},L=B=>B&&B.id!==void 0&&B.clock!==void 0&&B.heads!==void 0&&B.values!==void 0&&B.access!==void 0&&B.identity!==void 0&&B.storage!==void 0,z=async(B,G=0)=>{let K=[];const q=async Q=>K.length>=G&&G!==-1;for await(const{hash:Q}of k(B,q))K.push(Q);return K=K.slice(B.length+1,G),K};return{id:c,clock:f,heads:g,values:w,all:w,get:y,has:b,append:v,join:E,joinEntry:C,traverse:k,iterator:x,clear:I,close:T,access:n,identity:r,storage:l}},ul=async(r,e)=>({put:async(l,d)=>{await r.put(l,d),await e.put(l,d)},get:async l=>{let d=await r.get(l);return d||(d=await e.get(l),d&&await r.put(l,d)),d},del:async l=>{await r.del(l),await e.del(l)},iterator:async function*({amount:l,reverse:d}={}){const h=[],p={amount:l||-1,reverse:d||!1};for(const m of[r,e])for await(const[f,g]of m.iterator(p))h[f]||(h[f]=!0,yield[f,g])},merge:async l=>{await r.merge(l),await e.merge(l),await l.merge(r),await l.merge(e)},clear:async()=>{await r.clear(),await e.clear()},close:async()=>{await r.close(),await e.close()}});function uX(r){return r[Symbol.asyncIterator]!=null}function mo(r){if(uX(r))return(async()=>{for await(const e of r);})();for(const e of r);}const hT=3e4,a2=async({ipfs:r,pin:e,timeout:t}={})=>{if(!r)throw new Error("An instance of ipfs is required.");return{put:async(d,h)=>{const p=Yi.parse(d,ln),{signal:m}=new o6.TimeoutController(t||hT);await r.blockstore.put(p,h,{signal:m}),e&&!await r.pins.isPinned(p)&&await mo(r.pins.add(p))},del:async d=>{},get:async d=>{const h=Yi.parse(d,ln),{signal:p}=new o6.TimeoutController(t||hT),m=await r.blockstore.get(h,{signal:p});if(m)return m},iterator:async function*(){},merge:async d=>{},clear:async()=>{},close:async()=>{}}};var fT={},Ra={},c2={},pT={};pT.supports=function(...e){const t=e.reduce((n,i)=>Object.assign(n,i),{});return Object.assign(t,{snapshots:t.snapshots||!1,permanence:t.permanence||!1,seek:t.seek||!1,clear:t.clear||!1,getMany:t.getMany||!1,keyIterator:t.keyIterator||!1,valueIterator:t.valueIterator||!1,iteratorNextv:t.iteratorNextv||!1,iteratorAll:t.iteratorAll||!1,status:t.status||!1,createIfMissing:t.createIfMissing||!1,errorIfExists:t.errorIfExists||!1,deferredOpen:t.deferredOpen||!1,promises:t.promises||!1,streams:t.streams||!1,encodings:Object.assign({},t.encodings),events:Object.assign({},t.events),additionalMethods:Object.assign({},t.additionalMethods)})};var gT={},Cs=class extends Error{constructor(e,t){super(e||""),typeof t=="object"&&t!==null&&(t.code&&(this.code=String(t.code)),t.expected&&(this.expected=!0),t.transient&&(this.transient=!0),t.cause&&(this.cause=t.cause)),Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor)}},dl={},l2={},u2={};u2.byteLength=fX,u2.toByteArray=gX,u2.fromByteArray=wX;for(var Is=[],Si=[],dX=typeof Uint8Array<"u"?Uint8Array:Array,B6="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",cd=0,hX=B6.length;cd<hX;++cd)Is[cd]=B6[cd],Si[B6.charCodeAt(cd)]=cd;Si[45]=62,Si[95]=63;function yT(r){var e=r.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var t=r.indexOf("=");t===-1&&(t=e);var n=t===e?0:4-t%4;return[t,n]}function fX(r){var e=yT(r),t=e[0],n=e[1];return(t+n)*3/4-n}function pX(r,e,t){return(e+t)*3/4-t}function gX(r){var e,t=yT(r),n=t[0],i=t[1],s=new dX(pX(r,n,i)),o=0,a=i>0?n-4:n,c;for(c=0;c<a;c+=4)e=Si[r.charCodeAt(c)]<<18|Si[r.charCodeAt(c+1)]<<12|Si[r.charCodeAt(c+2)]<<6|Si[r.charCodeAt(c+3)],s[o++]=e>>16&255,s[o++]=e>>8&255,s[o++]=e&255;return i===2&&(e=Si[r.charCodeAt(c)]<<2|Si[r.charCodeAt(c+1)]>>4,s[o++]=e&255),i===1&&(e=Si[r.charCodeAt(c)]<<10|Si[r.charCodeAt(c+1)]<<4|Si[r.charCodeAt(c+2)]>>2,s[o++]=e>>8&255,s[o++]=e&255),s}function yX(r){return Is[r>>18&63]+Is[r>>12&63]+Is[r>>6&63]+Is[r&63]}function mX(r,e,t){for(var n,i=[],s=e;s<t;s+=3)n=(r[s]<<16&16711680)+(r[s+1]<<8&65280)+(r[s+2]&255),i.push(yX(n));return i.join("")}function wX(r){for(var e,t=r.length,n=t%3,i=[],s=16383,o=0,a=t-n;o<a;o+=s)i.push(mX(r,o,o+s>a?a:o+s));return n===1?(e=r[t-1],i.push(Is[e>>2]+Is[e<<4&63]+"==")):n===2&&(e=(r[t-2]<<8)+r[t-1],i.push(Is[e>>10]+Is[e>>4&63]+Is[e<<2&63]+"=")),i.join("")}var U6={};/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */U6.read=function(r,e,t,n,i){var s,o,a=i*8-n-1,c=(1<<a)-1,l=c>>1,d=-7,h=t?i-1:0,p=t?-1:1,m=r[e+h];for(h+=p,s=m&(1<<-d)-1,m>>=-d,d+=a;d>0;s=s*256+r[e+h],h+=p,d-=8);for(o=s&(1<<-d)-1,s>>=-d,d+=n;d>0;o=o*256+r[e+h],h+=p,d-=8);if(s===0)s=1-l;else{if(s===c)return o?NaN:(m?-1:1)*(1/0);o=o+Math.pow(2,n),s=s-l}return(m?-1:1)*o*Math.pow(2,s-n)},U6.write=function(r,e,t,n,i,s){var o,a,c,l=s*8-i-1,d=(1<<l)-1,h=d>>1,p=i===23?Math.pow(2,-24)-Math.pow(2,-77):0,m=n?0:s-1,f=n?1:-1,g=e<0||e===0&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(a=isNaN(e)?1:0,o=d):(o=Math.floor(Math.log(e)/Math.LN2),e*(c=Math.pow(2,-o))<1&&(o--,c*=2),o+h>=1?e+=p/c:e+=p*Math.pow(2,1-h),e*c>=2&&(o++,c/=2),o+h>=d?(a=0,o=d):o+h>=1?(a=(e*c-1)*Math.pow(2,i),o=o+h):(a=e*Math.pow(2,h-1)*Math.pow(2,i),o=0));i>=8;r[t+m]=a&255,m+=f,a/=256,i-=8);for(o=o<<i|a,l+=i;l>0;r[t+m]=o&255,m+=f,o/=256,l-=8);r[t+m-f]|=g*128};/*!
* The buffer module from node.js, for the browser.
*
* @author   Feross Aboukhadijeh <https://feross.org>
* @license  MIT
*/(function(r){const e=u2,t=U6,n=typeof Symbol=="function"&&typeof Symbol.for=="function"?Symbol.for("nodejs.util.inspect.custom"):null;r.Buffer=a,r.SlowBuffer=b,r.INSPECT_MAX_BYTES=50;const i=2147483647;r.kMaxLength=i,a.TYPED_ARRAY_SUPPORT=s(),!a.TYPED_ARRAY_SUPPORT&&typeof console<"u"&&typeof console.error=="function"&&console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support.");function s(){try{const D=new Uint8Array(1),S={foo:function(){return 42}};return Object.setPrototypeOf(S,Uint8Array.prototype),Object.setPrototypeOf(D,S),D.foo()===42}catch{return!1}}Object.defineProperty(a.prototype,"parent",{enumerable:!0,get:function(){if(a.isBuffer(this))return this.buffer}}),Object.defineProperty(a.prototype,"offset",{enumerable:!0,get:function(){if(a.isBuffer(this))return this.byteOffset}});function o(D){if(D>i)throw new RangeError('The value "'+D+'" is invalid for option "size"');const S=new Uint8Array(D);return Object.setPrototypeOf(S,a.prototype),S}function a(D,S,A){if(typeof D=="number"){if(typeof S=="string")throw new TypeError('The "string" argument must be of type string. Received type number');return h(D)}return c(D,S,A)}a.poolSize=8192;function c(D,S,A){if(typeof D=="string")return p(D,S);if(ArrayBuffer.isView(D))return f(D);if(D==null)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof D);if(Vi(D,ArrayBuffer)||D&&Vi(D.buffer,ArrayBuffer)||typeof SharedArrayBuffer<"u"&&(Vi(D,SharedArrayBuffer)||D&&Vi(D.buffer,SharedArrayBuffer)))return g(D,S,A);if(typeof D=="number")throw new TypeError('The "value" argument must not be of type number. Received type number');const M=D.valueOf&&D.valueOf();if(M!=null&&M!==D)return a.from(M,S,A);const P=w(D);if(P)return P;if(typeof Symbol<"u"&&Symbol.toPrimitive!=null&&typeof D[Symbol.toPrimitive]=="function")return a.from(D[Symbol.toPrimitive]("string"),S,A);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof D)}a.from=function(D,S,A){return c(D,S,A)},Object.setPrototypeOf(a.prototype,Uint8Array.prototype),Object.setPrototypeOf(a,Uint8Array);function l(D){if(typeof D!="number")throw new TypeError('"size" argument must be of type number');if(D<0)throw new RangeError('The value "'+D+'" is invalid for option "size"')}function d(D,S,A){return l(D),D<=0?o(D):S!==void 0?typeof A=="string"?o(D).fill(S,A):o(D).fill(S):o(D)}a.alloc=function(D,S,A){return d(D,S,A)};function h(D){return l(D),o(D<0?0:y(D)|0)}a.allocUnsafe=function(D){return h(D)},a.allocUnsafeSlow=function(D){return h(D)};function p(D,S){if((typeof S!="string"||S==="")&&(S="utf8"),!a.isEncoding(S))throw new TypeError("Unknown encoding: "+S);const A=v(D,S)|0;let M=o(A);const P=M.write(D,S);return P!==A&&(M=M.slice(0,P)),M}function m(D){const S=D.length<0?0:y(D.length)|0,A=o(S);for(let M=0;M<S;M+=1)A[M]=D[M]&255;return A}function f(D){if(Vi(D,Uint8Array)){const S=new Uint8Array(D);return g(S.buffer,S.byteOffset,S.byteLength)}return m(D)}function g(D,S,A){if(S<0||D.byteLength<S)throw new RangeError('"offset" is outside of buffer bounds');if(D.byteLength<S+(A||0))throw new RangeError('"length" is outside of buffer bounds');let M;return S===void 0&&A===void 0?M=new Uint8Array(D):A===void 0?M=new Uint8Array(D,S):M=new Uint8Array(D,S,A),Object.setPrototypeOf(M,a.prototype),M}function w(D){if(a.isBuffer(D)){const S=y(D.length)|0,A=o(S);return A.length===0||D.copy(A,0,0,S),A}if(D.length!==void 0)return typeof D.length!="number"||f0(D.length)?o(0):m(D);if(D.type==="Buffer"&&Array.isArray(D.data))return m(D.data)}function y(D){if(D>=i)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+i.toString(16)+" bytes");return D|0}function b(D){return+D!=D&&(D=0),a.alloc(+D)}a.isBuffer=function(S){return S!=null&&S._isBuffer===!0&&S!==a.prototype},a.compare=function(S,A){if(Vi(S,Uint8Array)&&(S=a.from(S,S.offset,S.byteLength)),Vi(A,Uint8Array)&&(A=a.from(A,A.offset,A.byteLength)),!a.isBuffer(S)||!a.isBuffer(A))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(S===A)return 0;let M=S.length,P=A.length;for(let N=0,R=Math.min(M,P);N<R;++N)if(S[N]!==A[N]){M=S[N],P=A[N];break}return M<P?-1:P<M?1:0},a.isEncoding=function(S){switch(String(S).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},a.concat=function(S,A){if(!Array.isArray(S))throw new TypeError('"list" argument must be an Array of Buffers');if(S.length===0)return a.alloc(0);let M;if(A===void 0)for(A=0,M=0;M<S.length;++M)A+=S[M].length;const P=a.allocUnsafe(A);let N=0;for(M=0;M<S.length;++M){let R=S[M];if(Vi(R,Uint8Array))N+R.length>P.length?(a.isBuffer(R)||(R=a.from(R)),R.copy(P,N)):Uint8Array.prototype.set.call(P,R,N);else if(a.isBuffer(R))R.copy(P,N);else throw new TypeError('"list" argument must be an Array of Buffers');N+=R.length}return P};function v(D,S){if(a.isBuffer(D))return D.length;if(ArrayBuffer.isView(D)||Vi(D,ArrayBuffer))return D.byteLength;if(typeof D!="string")throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof D);const A=D.length,M=arguments.length>2&&arguments[2]===!0;if(!M&&A===0)return 0;let P=!1;for(;;)switch(S){case"ascii":case"latin1":case"binary":return A;case"utf8":case"utf-8":return Vc(D).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return A*2;case"hex":return A>>>1;case"base64":return Cu(D).length;default:if(P)return M?-1:Vc(D).length;S=(""+S).toLowerCase(),P=!0}}a.byteLength=v;function E(D,S,A){let M=!1;if((S===void 0||S<0)&&(S=0),S>this.length||((A===void 0||A>this.length)&&(A=this.length),A<=0)||(A>>>=0,S>>>=0,A<=S))return"";for(D||(D="utf8");;)switch(D){case"hex":return U(this,S,A);case"utf8":case"utf-8":return K(this,S,A);case"ascii":return j(this,S,A);case"latin1":case"binary":return O(this,S,A);case"base64":return G(this,S,A);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return W(this,S,A);default:if(M)throw new TypeError("Unknown encoding: "+D);D=(D+"").toLowerCase(),M=!0}}a.prototype._isBuffer=!0;function C(D,S,A){const M=D[S];D[S]=D[A],D[A]=M}a.prototype.swap16=function(){const S=this.length;if(S%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let A=0;A<S;A+=2)C(this,A,A+1);return this},a.prototype.swap32=function(){const S=this.length;if(S%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let A=0;A<S;A+=4)C(this,A,A+3),C(this,A+1,A+2);return this},a.prototype.swap64=function(){const S=this.length;if(S%8!==0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let A=0;A<S;A+=8)C(this,A,A+7),C(this,A+1,A+6),C(this,A+2,A+5),C(this,A+3,A+4);return this},a.prototype.toString=function(){const S=this.length;return S===0?"":arguments.length===0?K(this,0,S):E.apply(this,arguments)},a.prototype.toLocaleString=a.prototype.toString,a.prototype.equals=function(S){if(!a.isBuffer(S))throw new TypeError("Argument must be a Buffer");return this===S?!0:a.compare(this,S)===0},a.prototype.inspect=function(){let S="";const A=r.INSPECT_MAX_BYTES;return S=this.toString("hex",0,A).replace(/(.{2})/g,"$1 ").trim(),this.length>A&&(S+=" ... "),"<Buffer "+S+">"},n&&(a.prototype[n]=a.prototype.inspect),a.prototype.compare=function(S,A,M,P,N){if(Vi(S,Uint8Array)&&(S=a.from(S,S.offset,S.byteLength)),!a.isBuffer(S))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof S);if(A===void 0&&(A=0),M===void 0&&(M=S?S.length:0),P===void 0&&(P=0),N===void 0&&(N=this.length),A<0||M>S.length||P<0||N>this.length)throw new RangeError("out of range index");if(P>=N&&A>=M)return 0;if(P>=N)return-1;if(A>=M)return 1;if(A>>>=0,M>>>=0,P>>>=0,N>>>=0,this===S)return 0;let R=N-P,J=M-A;const he=Math.min(R,J),Me=this.slice(P,N),Fe=S.slice(A,M);for(let ve=0;ve<he;++ve)if(Me[ve]!==Fe[ve]){R=Me[ve],J=Fe[ve];break}return R<J?-1:J<R?1:0};function k(D,S,A,M,P){if(D.length===0)return-1;if(typeof A=="string"?(M=A,A=0):A>2147483647?A=2147483647:A<-2147483648&&(A=-2147483648),A=+A,f0(A)&&(A=P?0:D.length-1),A<0&&(A=D.length+A),A>=D.length){if(P)return-1;A=D.length-1}else if(A<0)if(P)A=0;else return-1;if(typeof S=="string"&&(S=a.from(S,M)),a.isBuffer(S))return S.length===0?-1:x(D,S,A,M,P);if(typeof S=="number")return S=S&255,typeof Uint8Array.prototype.indexOf=="function"?P?Uint8Array.prototype.indexOf.call(D,S,A):Uint8Array.prototype.lastIndexOf.call(D,S,A):x(D,[S],A,M,P);throw new TypeError("val must be string, number or Buffer")}function x(D,S,A,M,P){let N=1,R=D.length,J=S.length;if(M!==void 0&&(M=String(M).toLowerCase(),M==="ucs2"||M==="ucs-2"||M==="utf16le"||M==="utf-16le")){if(D.length<2||S.length<2)return-1;N=2,R/=2,J/=2,A/=2}function he(Fe,ve){return N===1?Fe[ve]:Fe.readUInt16BE(ve*N)}let Me;if(P){let Fe=-1;for(Me=A;Me<R;Me++)if(he(D,Me)===he(S,Fe===-1?0:Me-Fe)){if(Fe===-1&&(Fe=Me),Me-Fe+1===J)return Fe*N}else Fe!==-1&&(Me-=Me-Fe),Fe=-1}else for(A+J>R&&(A=R-J),Me=A;Me>=0;Me--){let Fe=!0;for(let ve=0;ve<J;ve++)if(he(D,Me+ve)!==he(S,ve)){Fe=!1;break}if(Fe)return Me}return-1}a.prototype.includes=function(S,A,M){return this.indexOf(S,A,M)!==-1},a.prototype.indexOf=function(S,A,M){return k(this,S,A,M,!0)},a.prototype.lastIndexOf=function(S,A,M){return k(this,S,A,M,!1)};function I(D,S,A,M){A=Number(A)||0;const P=D.length-A;M?(M=Number(M),M>P&&(M=P)):M=P;const N=S.length;M>N/2&&(M=N/2);let R;for(R=0;R<M;++R){const J=parseInt(S.substr(R*2,2),16);if(f0(J))return R;D[A+R]=J}return R}function T(D,S,A,M){return Kc(Vc(S,D.length-A),D,A,M)}function L(D,S,A,M){return Kc(Xh(S),D,A,M)}function z(D,S,A,M){return Kc(Cu(S),D,A,M)}function B(D,S,A,M){return Kc(Zh(S,D.length-A),D,A,M)}a.prototype.write=function(S,A,M,P){if(A===void 0)P="utf8",M=this.length,A=0;else if(M===void 0&&typeof A=="string")P=A,M=this.length,A=0;else if(isFinite(A))A=A>>>0,isFinite(M)?(M=M>>>0,P===void 0&&(P="utf8")):(P=M,M=void 0);else throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");const N=this.length-A;if((M===void 0||M>N)&&(M=N),S.length>0&&(M<0||A<0)||A>this.length)throw new RangeError("Attempt to write outside buffer bounds");P||(P="utf8");let R=!1;for(;;)switch(P){case"hex":return I(this,S,A,M);case"utf8":case"utf-8":return T(this,S,A,M);case"ascii":case"latin1":case"binary":return L(this,S,A,M);case"base64":return z(this,S,A,M);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return B(this,S,A,M);default:if(R)throw new TypeError("Unknown encoding: "+P);P=(""+P).toLowerCase(),R=!0}},a.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function G(D,S,A){return S===0&&A===D.length?e.fromByteArray(D):e.fromByteArray(D.slice(S,A))}function K(D,S,A){A=Math.min(D.length,A);const M=[];let P=S;for(;P<A;){const N=D[P];let R=null,J=N>239?4:N>223?3:N>191?2:1;if(P+J<=A){let he,Me,Fe,ve;switch(J){case 1:N<128&&(R=N);break;case 2:he=D[P+1],(he&192)===128&&(ve=(N&31)<<6|he&63,ve>127&&(R=ve));break;case 3:he=D[P+1],Me=D[P+2],(he&192)===128&&(Me&192)===128&&(ve=(N&15)<<12|(he&63)<<6|Me&63,ve>2047&&(ve<55296||ve>57343)&&(R=ve));break;case 4:he=D[P+1],Me=D[P+2],Fe=D[P+3],(he&192)===128&&(Me&192)===128&&(Fe&192)===128&&(ve=(N&15)<<18|(he&63)<<12|(Me&63)<<6|Fe&63,ve>65535&&ve<1114112&&(R=ve))}}R===null?(R=65533,J=1):R>65535&&(R-=65536,M.push(R>>>10&1023|55296),R=56320|R&1023),M.push(R),P+=J}return Q(M)}const q=4096;function Q(D){const S=D.length;if(S<=q)return String.fromCharCode.apply(String,D);let A="",M=0;for(;M<S;)A+=String.fromCharCode.apply(String,D.slice(M,M+=q));return A}function j(D,S,A){let M="";A=Math.min(D.length,A);for(let P=S;P<A;++P)M+=String.fromCharCode(D[P]&127);return M}function O(D,S,A){let M="";A=Math.min(D.length,A);for(let P=S;P<A;++P)M+=String.fromCharCode(D[P]);return M}function U(D,S,A){const M=D.length;(!S||S<0)&&(S=0),(!A||A<0||A>M)&&(A=M);let P="";for(let N=S;N<A;++N)P+=NA[D[N]];return P}function W(D,S,A){const M=D.slice(S,A);let P="";for(let N=0;N<M.length-1;N+=2)P+=String.fromCharCode(M[N]+M[N+1]*256);return P}a.prototype.slice=function(S,A){const M=this.length;S=~~S,A=A===void 0?M:~~A,S<0?(S+=M,S<0&&(S=0)):S>M&&(S=M),A<0?(A+=M,A<0&&(A=0)):A>M&&(A=M),A<S&&(A=S);const P=this.subarray(S,A);return Object.setPrototypeOf(P,a.prototype),P};function Y(D,S,A){if(D%1!==0||D<0)throw new RangeError("offset is not uint");if(D+S>A)throw new RangeError("Trying to access beyond buffer length")}a.prototype.readUintLE=a.prototype.readUIntLE=function(S,A,M){S=S>>>0,A=A>>>0,M||Y(S,A,this.length);let P=this[S],N=1,R=0;for(;++R<A&&(N*=256);)P+=this[S+R]*N;return P},a.prototype.readUintBE=a.prototype.readUIntBE=function(S,A,M){S=S>>>0,A=A>>>0,M||Y(S,A,this.length);let P=this[S+--A],N=1;for(;A>0&&(N*=256);)P+=this[S+--A]*N;return P},a.prototype.readUint8=a.prototype.readUInt8=function(S,A){return S=S>>>0,A||Y(S,1,this.length),this[S]},a.prototype.readUint16LE=a.prototype.readUInt16LE=function(S,A){return S=S>>>0,A||Y(S,2,this.length),this[S]|this[S+1]<<8},a.prototype.readUint16BE=a.prototype.readUInt16BE=function(S,A){return S=S>>>0,A||Y(S,2,this.length),this[S]<<8|this[S+1]},a.prototype.readUint32LE=a.prototype.readUInt32LE=function(S,A){return S=S>>>0,A||Y(S,4,this.length),(this[S]|this[S+1]<<8|this[S+2]<<16)+this[S+3]*16777216},a.prototype.readUint32BE=a.prototype.readUInt32BE=function(S,A){return S=S>>>0,A||Y(S,4,this.length),this[S]*16777216+(this[S+1]<<16|this[S+2]<<8|this[S+3])},a.prototype.readBigUInt64LE=Xs(function(S){S=S>>>0,kt(S,"offset");const A=this[S],M=this[S+7];(A===void 0||M===void 0)&&Yt(S,this.length-8);const P=A+this[++S]*2**8+this[++S]*2**16+this[++S]*2**24,N=this[++S]+this[++S]*2**8+this[++S]*2**16+M*2**24;return BigInt(P)+(BigInt(N)<<BigInt(32))}),a.prototype.readBigUInt64BE=Xs(function(S){S=S>>>0,kt(S,"offset");const A=this[S],M=this[S+7];(A===void 0||M===void 0)&&Yt(S,this.length-8);const P=A*2**24+this[++S]*2**16+this[++S]*2**8+this[++S],N=this[++S]*2**24+this[++S]*2**16+this[++S]*2**8+M;return(BigInt(P)<<BigInt(32))+BigInt(N)}),a.prototype.readIntLE=function(S,A,M){S=S>>>0,A=A>>>0,M||Y(S,A,this.length);let P=this[S],N=1,R=0;for(;++R<A&&(N*=256);)P+=this[S+R]*N;return N*=128,P>=N&&(P-=Math.pow(2,8*A)),P},a.prototype.readIntBE=function(S,A,M){S=S>>>0,A=A>>>0,M||Y(S,A,this.length);let P=A,N=1,R=this[S+--P];for(;P>0&&(N*=256);)R+=this[S+--P]*N;return N*=128,R>=N&&(R-=Math.pow(2,8*A)),R},a.prototype.readInt8=function(S,A){return S=S>>>0,A||Y(S,1,this.length),this[S]&128?(255-this[S]+1)*-1:this[S]},a.prototype.readInt16LE=function(S,A){S=S>>>0,A||Y(S,2,this.length);const M=this[S]|this[S+1]<<8;return M&32768?M|4294901760:M},a.prototype.readInt16BE=function(S,A){S=S>>>0,A||Y(S,2,this.length);const M=this[S+1]|this[S]<<8;return M&32768?M|4294901760:M},a.prototype.readInt32LE=function(S,A){return S=S>>>0,A||Y(S,4,this.length),this[S]|this[S+1]<<8|this[S+2]<<16|this[S+3]<<24},a.prototype.readInt32BE=function(S,A){return S=S>>>0,A||Y(S,4,this.length),this[S]<<24|this[S+1]<<16|this[S+2]<<8|this[S+3]},a.prototype.readBigInt64LE=Xs(function(S){S=S>>>0,kt(S,"offset");const A=this[S],M=this[S+7];(A===void 0||M===void 0)&&Yt(S,this.length-8);const P=this[S+4]+this[S+5]*2**8+this[S+6]*2**16+(M<<24);return(BigInt(P)<<BigInt(32))+BigInt(A+this[++S]*2**8+this[++S]*2**16+this[++S]*2**24)}),a.prototype.readBigInt64BE=Xs(function(S){S=S>>>0,kt(S,"offset");const A=this[S],M=this[S+7];(A===void 0||M===void 0)&&Yt(S,this.length-8);const P=(A<<24)+this[++S]*2**16+this[++S]*2**8+this[++S];return(BigInt(P)<<BigInt(32))+BigInt(this[++S]*2**24+this[++S]*2**16+this[++S]*2**8+M)}),a.prototype.readFloatLE=function(S,A){return S=S>>>0,A||Y(S,4,this.length),t.read(this,S,!0,23,4)},a.prototype.readFloatBE=function(S,A){return S=S>>>0,A||Y(S,4,this.length),t.read(this,S,!1,23,4)},a.prototype.readDoubleLE=function(S,A){return S=S>>>0,A||Y(S,8,this.length),t.read(this,S,!0,52,8)},a.prototype.readDoubleBE=function(S,A){return S=S>>>0,A||Y(S,8,this.length),t.read(this,S,!1,52,8)};function H(D,S,A,M,P,N){if(!a.isBuffer(D))throw new TypeError('"buffer" argument must be a Buffer instance');if(S>P||S<N)throw new RangeError('"value" argument is out of bounds');if(A+M>D.length)throw new RangeError("Index out of range")}a.prototype.writeUintLE=a.prototype.writeUIntLE=function(S,A,M,P){if(S=+S,A=A>>>0,M=M>>>0,!P){const J=Math.pow(2,8*M)-1;H(this,S,A,M,J,0)}let N=1,R=0;for(this[A]=S&255;++R<M&&(N*=256);)this[A+R]=S/N&255;return A+M},a.prototype.writeUintBE=a.prototype.writeUIntBE=function(S,A,M,P){if(S=+S,A=A>>>0,M=M>>>0,!P){const J=Math.pow(2,8*M)-1;H(this,S,A,M,J,0)}let N=M-1,R=1;for(this[A+N]=S&255;--N>=0&&(R*=256);)this[A+N]=S/R&255;return A+M},a.prototype.writeUint8=a.prototype.writeUInt8=function(S,A,M){return S=+S,A=A>>>0,M||H(this,S,A,1,255,0),this[A]=S&255,A+1},a.prototype.writeUint16LE=a.prototype.writeUInt16LE=function(S,A,M){return S=+S,A=A>>>0,M||H(this,S,A,2,65535,0),this[A]=S&255,this[A+1]=S>>>8,A+2},a.prototype.writeUint16BE=a.prototype.writeUInt16BE=function(S,A,M){return S=+S,A=A>>>0,M||H(this,S,A,2,65535,0),this[A]=S>>>8,this[A+1]=S&255,A+2},a.prototype.writeUint32LE=a.prototype.writeUInt32LE=function(S,A,M){return S=+S,A=A>>>0,M||H(this,S,A,4,4294967295,0),this[A+3]=S>>>24,this[A+2]=S>>>16,this[A+1]=S>>>8,this[A]=S&255,A+4},a.prototype.writeUint32BE=a.prototype.writeUInt32BE=function(S,A,M){return S=+S,A=A>>>0,M||H(this,S,A,4,4294967295,0),this[A]=S>>>24,this[A+1]=S>>>16,this[A+2]=S>>>8,this[A+3]=S&255,A+4};function oe(D,S,A,M,P){vt(S,M,P,D,A,7);let N=Number(S&BigInt(4294967295));D[A++]=N,N=N>>8,D[A++]=N,N=N>>8,D[A++]=N,N=N>>8,D[A++]=N;let R=Number(S>>BigInt(32)&BigInt(4294967295));return D[A++]=R,R=R>>8,D[A++]=R,R=R>>8,D[A++]=R,R=R>>8,D[A++]=R,A}function ye(D,S,A,M,P){vt(S,M,P,D,A,7);let N=Number(S&BigInt(4294967295));D[A+7]=N,N=N>>8,D[A+6]=N,N=N>>8,D[A+5]=N,N=N>>8,D[A+4]=N;let R=Number(S>>BigInt(32)&BigInt(4294967295));return D[A+3]=R,R=R>>8,D[A+2]=R,R=R>>8,D[A+1]=R,R=R>>8,D[A]=R,A+8}a.prototype.writeBigUInt64LE=Xs(function(S,A=0){return oe(this,S,A,BigInt(0),BigInt("0xffffffffffffffff"))}),a.prototype.writeBigUInt64BE=Xs(function(S,A=0){return ye(this,S,A,BigInt(0),BigInt("0xffffffffffffffff"))}),a.prototype.writeIntLE=function(S,A,M,P){if(S=+S,A=A>>>0,!P){const he=Math.pow(2,8*M-1);H(this,S,A,M,he-1,-he)}let N=0,R=1,J=0;for(this[A]=S&255;++N<M&&(R*=256);)S<0&&J===0&&this[A+N-1]!==0&&(J=1),this[A+N]=(S/R>>0)-J&255;return A+M},a.prototype.writeIntBE=function(S,A,M,P){if(S=+S,A=A>>>0,!P){const he=Math.pow(2,8*M-1);H(this,S,A,M,he-1,-he)}let N=M-1,R=1,J=0;for(this[A+N]=S&255;--N>=0&&(R*=256);)S<0&&J===0&&this[A+N+1]!==0&&(J=1),this[A+N]=(S/R>>0)-J&255;return A+M},a.prototype.writeInt8=function(S,A,M){return S=+S,A=A>>>0,M||H(this,S,A,1,127,-128),S<0&&(S=255+S+1),this[A]=S&255,A+1},a.prototype.writeInt16LE=function(S,A,M){return S=+S,A=A>>>0,M||H(this,S,A,2,32767,-32768),this[A]=S&255,this[A+1]=S>>>8,A+2},a.prototype.writeInt16BE=function(S,A,M){return S=+S,A=A>>>0,M||H(this,S,A,2,32767,-32768),this[A]=S>>>8,this[A+1]=S&255,A+2},a.prototype.writeInt32LE=function(S,A,M){return S=+S,A=A>>>0,M||H(this,S,A,4,2147483647,-2147483648),this[A]=S&255,this[A+1]=S>>>8,this[A+2]=S>>>16,this[A+3]=S>>>24,A+4},a.prototype.writeInt32BE=function(S,A,M){return S=+S,A=A>>>0,M||H(this,S,A,4,2147483647,-2147483648),S<0&&(S=4294967295+S+1),this[A]=S>>>24,this[A+1]=S>>>16,this[A+2]=S>>>8,this[A+3]=S&255,A+4},a.prototype.writeBigInt64LE=Xs(function(S,A=0){return oe(this,S,A,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))}),a.prototype.writeBigInt64BE=Xs(function(S,A=0){return ye(this,S,A,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))});function de(D,S,A,M,P,N){if(A+M>D.length)throw new RangeError("Index out of range");if(A<0)throw new RangeError("Index out of range")}function le(D,S,A,M,P){return S=+S,A=A>>>0,P||de(D,S,A,4),t.write(D,S,A,M,23,4),A+4}a.prototype.writeFloatLE=function(S,A,M){return le(this,S,A,!0,M)},a.prototype.writeFloatBE=function(S,A,M){return le(this,S,A,!1,M)};function $e(D,S,A,M,P){return S=+S,A=A>>>0,P||de(D,S,A,8),t.write(D,S,A,M,52,8),A+8}a.prototype.writeDoubleLE=function(S,A,M){return $e(this,S,A,!0,M)},a.prototype.writeDoubleBE=function(S,A,M){return $e(this,S,A,!1,M)},a.prototype.copy=function(S,A,M,P){if(!a.isBuffer(S))throw new TypeError("argument should be a Buffer");if(M||(M=0),!P&&P!==0&&(P=this.length),A>=S.length&&(A=S.length),A||(A=0),P>0&&P<M&&(P=M),P===M||S.length===0||this.length===0)return 0;if(A<0)throw new RangeError("targetStart out of bounds");if(M<0||M>=this.length)throw new RangeError("Index out of range");if(P<0)throw new RangeError("sourceEnd out of bounds");P>this.length&&(P=this.length),S.length-A<P-M&&(P=S.length-A+M);const N=P-M;return this===S&&typeof Uint8Array.prototype.copyWithin=="function"?this.copyWithin(A,M,P):Uint8Array.prototype.set.call(S,this.subarray(M,P),A),N},a.prototype.fill=function(S,A,M,P){if(typeof S=="string"){if(typeof A=="string"?(P=A,A=0,M=this.length):typeof M=="string"&&(P=M,M=this.length),P!==void 0&&typeof P!="string")throw new TypeError("encoding must be a string");if(typeof P=="string"&&!a.isEncoding(P))throw new TypeError("Unknown encoding: "+P);if(S.length===1){const R=S.charCodeAt(0);(P==="utf8"&&R<128||P==="latin1")&&(S=R)}}else typeof S=="number"?S=S&255:typeof S=="boolean"&&(S=Number(S));if(A<0||this.length<A||this.length<M)throw new RangeError("Out of range index");if(M<=A)return this;A=A>>>0,M=M===void 0?this.length:M>>>0,S||(S=0);let N;if(typeof S=="number")for(N=A;N<M;++N)this[N]=S;else{const R=a.isBuffer(S)?S:a.from(S,P),J=R.length;if(J===0)throw new TypeError('The value "'+S+'" is invalid for argument "value"');for(N=0;N<M-A;++N)this[N+A]=R[N%J]}return this};const Ne={};function Ie(D,S,A){Ne[D]=class extends A{constructor(){super(),Object.defineProperty(this,"message",{value:S.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${D}]`,this.stack,delete this.name}get code(){return D}set code(P){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:P,writable:!0})}toString(){return`${this.name} [${D}]: ${this.message}`}}}Ie("ERR_BUFFER_OUT_OF_BOUNDS",function(D){return D?`${D} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"},RangeError),Ie("ERR_INVALID_ARG_TYPE",function(D,S){return`The "${D}" argument must be of type number. Received type ${typeof S}`},TypeError),Ie("ERR_OUT_OF_RANGE",function(D,S,A){let M=`The value of "${D}" is out of range.`,P=A;return Number.isInteger(A)&&Math.abs(A)>2**32?P=tt(String(A)):typeof A=="bigint"&&(P=String(A),(A>BigInt(2)**BigInt(32)||A<-(BigInt(2)**BigInt(32)))&&(P=tt(P)),P+="n"),M+=` It must be ${S}. Received ${P}`,M},RangeError);function tt(D){let S="",A=D.length;const M=D[0]==="-"?1:0;for(;A>=M+4;A-=3)S=`_${D.slice(A-3,A)}${S}`;return`${D.slice(0,A)}${S}`}function bt(D,S,A){kt(S,"offset"),(D[S]===void 0||D[S+A]===void 0)&&Yt(S,D.length-(A+1))}function vt(D,S,A,M,P,N){if(D>A||D<S){const R=typeof S=="bigint"?"n":"";let J;throw S===0||S===BigInt(0)?J=`>= 0${R} and < 2${R} ** ${(N+1)*8}${R}`:J=`>= -(2${R} ** ${(N+1)*8-1}${R}) and < 2 ** ${(N+1)*8-1}${R}`,new Ne.ERR_OUT_OF_RANGE("value",J,D)}bt(M,P,N)}function kt(D,S){if(typeof D!="number")throw new Ne.ERR_INVALID_ARG_TYPE(S,"number",D)}function Yt(D,S,A){throw Math.floor(D)!==D?(kt(D,A),new Ne.ERR_OUT_OF_RANGE("offset","an integer",D)):S<0?new Ne.ERR_BUFFER_OUT_OF_BOUNDS:new Ne.ERR_OUT_OF_RANGE("offset",`>= 0 and <= ${S}`,D)}const wn=/[^+/0-9A-Za-z-_]/g;function Au(D){if(D=D.split("=")[0],D=D.trim().replace(wn,""),D.length<2)return"";for(;D.length%4!==0;)D=D+"=";return D}function Vc(D,S){S=S||1/0;let A;const M=D.length;let P=null;const N=[];for(let R=0;R<M;++R){if(A=D.charCodeAt(R),A>55295&&A<57344){if(!P){if(A>56319){(S-=3)>-1&&N.push(239,191,189);continue}else if(R+1===M){(S-=3)>-1&&N.push(239,191,189);continue}P=A;continue}if(A<56320){(S-=3)>-1&&N.push(239,191,189),P=A;continue}A=(P-55296<<10|A-56320)+65536}else P&&(S-=3)>-1&&N.push(239,191,189);if(P=null,A<128){if((S-=1)<0)break;N.push(A)}else if(A<2048){if((S-=2)<0)break;N.push(A>>6|192,A&63|128)}else if(A<65536){if((S-=3)<0)break;N.push(A>>12|224,A>>6&63|128,A&63|128)}else if(A<1114112){if((S-=4)<0)break;N.push(A>>18|240,A>>12&63|128,A>>6&63|128,A&63|128)}else throw new Error("Invalid code point")}return N}function Xh(D){const S=[];for(let A=0;A<D.length;++A)S.push(D.charCodeAt(A)&255);return S}function Zh(D,S){let A,M,P;const N=[];for(let R=0;R<D.length&&!((S-=2)<0);++R)A=D.charCodeAt(R),M=A>>8,P=A%256,N.push(P),N.push(M);return N}function Cu(D){return e.toByteArray(Au(D))}function Kc(D,S,A,M){let P;for(P=0;P<M&&!(P+A>=S.length||P>=D.length);++P)S[P+A]=D[P];return P}function Vi(D,S){return D instanceof S||D!=null&&D.constructor!=null&&D.constructor.name!=null&&D.constructor.name===S.name}function f0(D){return D!==D}const NA=function(){const D="0123456789abcdef",S=new Array(256);for(let A=0;A<16;++A){const M=A*16;for(let P=0;P<16;++P)S[M+P]=D[A]+D[P]}return S}();function Xs(D){return typeof BigInt>"u"?Iu:D}function Iu(){throw new Error("BigInt not supported")}})(l2);let F6=null;var mT=function(){return F6===null&&(F6={textEncoder:new TextEncoder,textDecoder:new TextDecoder}),F6},Xf={},z6={};const V6=Cs,bX=new Set(["buffer","view","utf8"]);let vX=class{constructor(e){if(this.encode=e.encode||this.encode,this.decode=e.decode||this.decode,this.name=e.name||this.name,this.format=e.format||this.format,typeof this.encode!="function")throw new TypeError("The 'encode' property must be a function");if(typeof this.decode!="function")throw new TypeError("The 'decode' property must be a function");if(this.encode=this.encode.bind(this),this.decode=this.decode.bind(this),typeof this.name!="string"||this.name==="")throw new TypeError("The 'name' property must be a string");if(typeof this.format!="string"||!bX.has(this.format))throw new TypeError("The 'format' property must be one of 'buffer', 'view', 'utf8'");e.createViewTranscoder&&(this.createViewTranscoder=e.createViewTranscoder),e.createBufferTranscoder&&(this.createBufferTranscoder=e.createBufferTranscoder),e.createUTF8Transcoder&&(this.createUTF8Transcoder=e.createUTF8Transcoder)}get commonName(){return this.name.split("+")[0]}createBufferTranscoder(){throw new V6(`Encoding '${this.name}' cannot be transcoded to 'buffer'`,{code:"LEVEL_ENCODING_NOT_SUPPORTED"})}createViewTranscoder(){throw new V6(`Encoding '${this.name}' cannot be transcoded to 'view'`,{code:"LEVEL_ENCODING_NOT_SUPPORTED"})}createUTF8Transcoder(){throw new V6(`Encoding '${this.name}' cannot be transcoded to 'utf8'`,{code:"LEVEL_ENCODING_NOT_SUPPORTED"})}};z6.Encoding=vX;const{Buffer:K6}=l2||{},{Encoding:j6}=z6,EX=mT;let H6=class extends j6{constructor(e){super({...e,format:"buffer"})}createViewTranscoder(){return new q6({encode:this.encode,decode:e=>this.decode(K6.from(e.buffer,e.byteOffset,e.byteLength)),name:`${this.name}+view`})}createBufferTranscoder(){return this}},q6=class extends j6{constructor(e){super({...e,format:"view"})}createBufferTranscoder(){return new H6({encode:e=>{const t=this.encode(e);return K6.from(t.buffer,t.byteOffset,t.byteLength)},decode:this.decode,name:`${this.name}+buffer`})}createViewTranscoder(){return this}},SX=class extends j6{constructor(e){super({...e,format:"utf8"})}createBufferTranscoder(){return new H6({encode:e=>K6.from(this.encode(e),"utf8"),decode:e=>this.decode(e.toString("utf8")),name:`${this.name}+buffer`})}createViewTranscoder(){const{textEncoder:e,textDecoder:t}=EX();return new q6({encode:n=>e.encode(this.encode(n)),decode:n=>this.decode(t.decode(n)),name:`${this.name}+view`})}createUTF8Transcoder(){return this}};Xf.BufferFormat=H6,Xf.ViewFormat=q6,Xf.UTF8Format=SX;const{Buffer:Rr}=l2||{Buffer:{isBuffer:()=>!1}},{textEncoder:wT,textDecoder:bT}=mT(),{BufferFormat:Zf,ViewFormat:W6,UTF8Format:vT}=Xf,d2=r=>r;dl.utf8=new vT({encode:function(r){return Rr.isBuffer(r)?r.toString("utf8"):ArrayBuffer.isView(r)?bT.decode(r):String(r)},decode:d2,name:"utf8",createViewTranscoder(){return new W6({encode:function(r){return ArrayBuffer.isView(r)?r:wT.encode(r)},decode:function(r){return bT.decode(r)},name:`${this.name}+view`})},createBufferTranscoder(){return new Zf({encode:function(r){return Rr.isBuffer(r)?r:ArrayBuffer.isView(r)?Rr.from(r.buffer,r.byteOffset,r.byteLength):Rr.from(String(r),"utf8")},decode:function(r){return r.toString("utf8")},name:`${this.name}+buffer`})}}),dl.json=new vT({encode:JSON.stringify,decode:JSON.parse,name:"json"}),dl.buffer=new Zf({encode:function(r){return Rr.isBuffer(r)?r:ArrayBuffer.isView(r)?Rr.from(r.buffer,r.byteOffset,r.byteLength):Rr.from(String(r),"utf8")},decode:d2,name:"buffer",createViewTranscoder(){return new W6({encode:function(r){return ArrayBuffer.isView(r)?r:Rr.from(String(r),"utf8")},decode:function(r){return Rr.from(r.buffer,r.byteOffset,r.byteLength)},name:`${this.name}+view`})}}),dl.view=new W6({encode:function(r){return ArrayBuffer.isView(r)?r:wT.encode(r)},decode:d2,name:"view",createBufferTranscoder(){return new Zf({encode:function(r){return Rr.isBuffer(r)?r:ArrayBuffer.isView(r)?Rr.from(r.buffer,r.byteOffset,r.byteLength):Rr.from(String(r),"utf8")},decode:d2,name:`${this.name}+buffer`})}}),dl.hex=new Zf({encode:function(r){return Rr.isBuffer(r)?r:Rr.from(String(r),"hex")},decode:function(r){return r.toString("hex")},name:"hex"}),dl.base64=new Zf({encode:function(r){return Rr.isBuffer(r)?r:Rr.from(String(r),"base64")},decode:function(r){return r.toString("base64")},name:"base64"});const ET=Cs,h2=dl,{Encoding:xX}=z6,{BufferFormat:AX,ViewFormat:CX,UTF8Format:IX}=Xf,e1=Symbol("formats"),f2=Symbol("encodings"),kX=new Set(["buffer","view","utf8"]);let _X=class{constructor(e){if(Array.isArray(e)){if(!e.every(t=>kX.has(t)))throw new TypeError("Format must be one of 'buffer', 'view', 'utf8'")}else throw new TypeError("The first argument 'formats' must be an array");this[f2]=new Map,this[e1]=new Set(e);for(const t in h2)try{this.encoding(t)}catch(n){if(n.code!=="LEVEL_ENCODING_NOT_SUPPORTED")throw n}}encodings(){return Array.from(new Set(this[f2].values()))}encoding(e){let t=this[f2].get(e);if(t===void 0){if(typeof e=="string"&&e!==""){if(t=$X[e],!t)throw new ET(`Encoding '${e}' is not found`,{code:"LEVEL_ENCODING_NOT_FOUND"})}else{if(typeof e!="object"||e===null)throw new TypeError("First argument 'encoding' must be a string or object");t=TX(e)}const{name:n,format:i}=t;if(!this[e1].has(i))if(this[e1].has("view"))t=t.createViewTranscoder();else if(this[e1].has("buffer"))t=t.createBufferTranscoder();else if(this[e1].has("utf8"))t=t.createUTF8Transcoder();else throw new ET(`Encoding '${n}' cannot be transcoded`,{code:"LEVEL_ENCODING_NOT_SUPPORTED"});for(const s of[e,n,t.name,t.commonName])this[f2].set(s,t)}return t}};gT.Transcoder=_X;function TX(r){if(r instanceof xX)return r;const e="type"in r&&typeof r.type=="string"?r.type:void 0,t=r.name||e||`anonymous-${NX++}`;switch(PX(r)){case"view":return new CX({...r,name:t});case"utf8":return new IX({...r,name:t});case"buffer":return new AX({...r,name:t});default:throw new TypeError("Format must be one of 'buffer', 'view', 'utf8'")}}function PX(r){return"format"in r&&r.format!==void 0?r.format:"buffer"in r&&typeof r.buffer=="boolean"?r.buffer?"buffer":"utf8":"code"in r&&Number.isInteger(r.code)?"view":"buffer"}const DX={binary:h2.buffer,"utf-8":h2.utf8},$X={...h2,...DX};let NX=0;var ld={},MX=typeof queueMicrotask=="function"?queueMicrotask:r=>Promise.resolve().then(r),ST=MX;ld.fromCallback=function(r,e){if(r===void 0){var t=new Promise(function(n,i){r=function(s,o){s?i(s):n(o)}});r[e!==void 0?e:"promise"]=t}else if(typeof r!="function")throw new TypeError("Callback must be a function");return r},ld.fromPromise=function(r,e){if(e===void 0)return r;r.then(function(t){ST(()=>e(null,t))}).catch(function(t){ST(()=>e(t))})};var ks={},t1={};t1.getCallback=function(r,e){return typeof r=="function"?r:e},t1.getOptions=function(r,e){return typeof r=="object"&&r!==null?r:e!==void 0?e:{}};const{fromCallback:G6}=ld,Qn=Cs,{getOptions:Q6,getCallback:xT}=t1,hl=Symbol("promise"),ud=Symbol("callback"),_s=Symbol("working"),fl=Symbol("handleOne"),wo=Symbol("handleMany"),Y6=Symbol("autoClose"),La=Symbol("finishWork"),Ts=Symbol("returnMany"),Ba=Symbol("closing"),r1=Symbol("handleClose"),p2=Symbol("closed"),n1=Symbol("closeCallbacks"),Ua=Symbol("keyEncoding"),pl=Symbol("valueEncoding"),J6=Symbol("abortOnClose"),g2=Symbol("legacy"),X6=Symbol("keys"),Z6=Symbol("values"),Fa=Symbol("limit"),xi=Symbol("count"),y2=Object.freeze({}),OX=()=>{};let AT=!1;class eb{constructor(e,t,n){if(typeof e!="object"||e===null){const i=e===null?"null":typeof e;throw new TypeError(`The first argument must be an abstract-level database, received ${i}`)}if(typeof t!="object"||t===null)throw new TypeError("The second argument must be an options object");this[p2]=!1,this[n1]=[],this[_s]=!1,this[Ba]=!1,this[Y6]=!1,this[ud]=null,this[fl]=this[fl].bind(this),this[wo]=this[wo].bind(this),this[r1]=this[r1].bind(this),this[Ua]=t[Ua],this[pl]=t[pl],this[g2]=n,this[Fa]=Number.isInteger(t.limit)&&t.limit>=0?t.limit:1/0,this[xi]=0,this[J6]=!!t.abortOnClose,this.db=e,this.db.attachResource(this),this.nextTick=e.nextTick}get count(){return this[xi]}get limit(){return this[Fa]}next(e){let t;if(e===void 0)t=new Promise((n,i)=>{e=(s,o,a)=>{s?i(s):this[g2]?o===void 0&&a===void 0?n():n([o,a]):n(o)}});else if(typeof e!="function")throw new TypeError("Callback must be a function");return this[Ba]?this.nextTick(e,new Qn("Iterator is not open: cannot call next() after close()",{code:"LEVEL_ITERATOR_NOT_OPEN"})):this[_s]?this.nextTick(e,new Qn("Iterator is busy: cannot call next() until previous call has completed",{code:"LEVEL_ITERATOR_BUSY"})):(this[_s]=!0,this[ud]=e,this[xi]>=this[Fa]?this.nextTick(this[fl],null):this._next(this[fl])),t}_next(e){this.nextTick(e)}nextv(e,t,n){return n=xT(t,n),n=G6(n,hl),t=Q6(t,y2),Number.isInteger(e)?(this[Ba]?this.nextTick(n,new Qn("Iterator is not open: cannot call nextv() after close()",{code:"LEVEL_ITERATOR_NOT_OPEN"})):this[_s]?this.nextTick(n,new Qn("Iterator is busy: cannot call nextv() until previous call has completed",{code:"LEVEL_ITERATOR_BUSY"})):(e<1&&(e=1),this[Fa]<1/0&&(e=Math.min(e,this[Fa]-this[xi])),this[_s]=!0,this[ud]=n,e<=0?this.nextTick(this[wo],null,[]):this._nextv(e,t,this[wo])),n[hl]):(this.nextTick(n,new TypeError("The first argument 'size' must be an integer")),n[hl])}_nextv(e,t,n){const i=[],s=(o,a,c)=>{if(o)return n(o);if(this[g2]?a===void 0&&c===void 0:a===void 0)return n(null,i);i.push(this[g2]?[a,c]:a),i.length===e?n(null,i):this._next(s)};this._next(s)}all(e,t){return t=xT(e,t),t=G6(t,hl),e=Q6(e,y2),this[Ba]?this.nextTick(t,new Qn("Iterator is not open: cannot call all() after close()",{code:"LEVEL_ITERATOR_NOT_OPEN"})):this[_s]?this.nextTick(t,new Qn("Iterator is busy: cannot call all() until previous call has completed",{code:"LEVEL_ITERATOR_BUSY"})):(this[_s]=!0,this[ud]=t,this[Y6]=!0,this[xi]>=this[Fa]?this.nextTick(this[wo],null,[]):this._all(e,this[wo])),t[hl]}_all(e,t){let n=this[xi];const i=[],s=()=>{const a=this[Fa]<1/0?Math.min(1e3,this[Fa]-n):1e3;a<=0?this.nextTick(t,null,i):this._nextv(a,y2,o)},o=(a,c)=>{a?t(a):c.length===0?t(null,i):(i.push.apply(i,c),n+=c.length,s())};s()}[La](){const e=this[ud];return this[J6]&&e===null?OX:(this[_s]=!1,this[ud]=null,this[Ba]&&this._close(this[r1]),e)}[Ts](e,t,n){this[Y6]?this.close(e.bind(null,t,n)):e(t,n)}seek(e,t){if(t=Q6(t,y2),!this[Ba]){if(this[_s])throw new Qn("Iterator is busy: cannot call seek() until next() has completed",{code:"LEVEL_ITERATOR_BUSY"});{const n=this.db.keyEncoding(t.keyEncoding||this[Ua]),i=n.format;t.keyEncoding!==i&&(t={...t,keyEncoding:i});const s=this.db.prefixKey(n.encode(e),i);this._seek(s,t)}}}_seek(e,t){throw new Qn("Iterator does not support seek()",{code:"LEVEL_NOT_SUPPORTED"})}close(e){return e=G6(e,hl),this[p2]?this.nextTick(e):this[Ba]?this[n1].push(e):(this[Ba]=!0,this[n1].push(e),this[_s]?this[J6]&&this[La]()(new Qn("Aborted on iterator close()",{code:"LEVEL_ITERATOR_NOT_OPEN"})):this._close(this[r1])),e[hl]}_close(e){this.nextTick(e)}[r1](){this[p2]=!0,this.db.detachResource(this);const e=this[n1];this[n1]=[];for(const t of e)t()}async*[Symbol.asyncIterator](){try{let e;for(;(e=await this.next())!==void 0;)yield e}finally{this[p2]||await this.close()}}}let m2=class extends eb{constructor(e,t){super(e,t,!0),this[X6]=t.keys!==!1,this[Z6]=t.values!==!1}[fl](e,t,n){const i=this[La]();if(e)return i(e);try{t=this[X6]&&t!==void 0?this[Ua].decode(t):void 0,n=this[Z6]&&n!==void 0?this[pl].decode(n):void 0}catch(s){return i(new dd("entry",s))}t===void 0&&n===void 0||this[xi]++,i(null,t,n)}[wo](e,t){const n=this[La]();if(e)return this[Ts](n,e);try{for(const i of t){const s=i[0],o=i[1];i[0]=this[X6]&&s!==void 0?this[Ua].decode(s):void 0,i[1]=this[Z6]&&o!==void 0?this[pl].decode(o):void 0}}catch(i){return this[Ts](n,new dd("entries",i))}this[xi]+=t.length,this[Ts](n,null,t)}end(e){return!AT&&typeof console<"u"&&(AT=!0,console.warn(new Qn("The iterator.end() method was renamed to close() and end() is an alias that will be removed in a future version",{code:"LEVEL_LEGACY"}))),this.close(e)}},RX=class extends eb{constructor(e,t){super(e,t,!1)}[fl](e,t){const n=this[La]();if(e)return n(e);try{t=t!==void 0?this[Ua].decode(t):void 0}catch(i){return n(new dd("key",i))}t!==void 0&&this[xi]++,n(null,t)}[wo](e,t){const n=this[La]();if(e)return this[Ts](n,e);try{for(let i=0;i<t.length;i++){const s=t[i];t[i]=s!==void 0?this[Ua].decode(s):void 0}}catch(i){return this[Ts](n,new dd("keys",i))}this[xi]+=t.length,this[Ts](n,null,t)}},LX=class extends eb{constructor(e,t){super(e,t,!1)}[fl](e,t){const n=this[La]();if(e)return n(e);try{t=t!==void 0?this[pl].decode(t):void 0}catch(i){return n(new dd("value",i))}t!==void 0&&this[xi]++,n(null,t)}[wo](e,t){const n=this[La]();if(e)return this[Ts](n,e);try{for(let i=0;i<t.length;i++){const s=t[i];t[i]=s!==void 0?this[pl].decode(s):void 0}}catch(i){return this[Ts](n,new dd("values",i))}this[xi]+=t.length,this[Ts](n,null,t)}};class dd extends Qn{constructor(e,t){super(`Iterator could not decode ${e}`,{code:"LEVEL_DECODE_ERROR",cause:t})}}for(const r of["_ended property","_nexting property","_end method"])Object.defineProperty(m2.prototype,r.split(" ")[0],{get(){throw new Qn(`The ${r} has been removed`,{code:"LEVEL_LEGACY"})},set(){throw new Qn(`The ${r} has been removed`,{code:"LEVEL_LEGACY"})}});m2.keyEncoding=Ua,m2.valueEncoding=pl,ks.AbstractIterator=m2,ks.AbstractKeyIterator=RX,ks.AbstractValueIterator=LX;var tb={};const{AbstractKeyIterator:BX,AbstractValueIterator:UX}=ks,gl=Symbol("iterator"),i1=Symbol("callback"),hd=Symbol("handleOne"),yl=Symbol("handleMany");let rb=class extends BX{constructor(e,t){super(e,t),this[gl]=e.iterator({...t,keys:!0,values:!1}),this[hd]=this[hd].bind(this),this[yl]=this[yl].bind(this)}},CT=class extends UX{constructor(e,t){super(e,t),this[gl]=e.iterator({...t,keys:!1,values:!0}),this[hd]=this[hd].bind(this),this[yl]=this[yl].bind(this)}};for(const r of[rb,CT]){const e=r===rb,t=e?n=>n[0]:n=>n[1];r.prototype._next=function(n){this[i1]=n,this[gl].next(this[hd])},r.prototype[hd]=function(n,i,s){const o=this[i1];n?o(n):o(null,e?i:s)},r.prototype._nextv=function(n,i,s){this[i1]=s,this[gl].nextv(n,i,this[yl])},r.prototype._all=function(n,i){this[i1]=i,this[gl].all(n,this[yl])},r.prototype[yl]=function(n,i){const s=this[i1];n?s(n):s(null,i.map(t))},r.prototype._seek=function(n,i){this[gl].seek(n,i)},r.prototype._close=function(n){this[gl].close(n)}}tb.DefaultKeyIterator=rb,tb.DefaultValueIterator=CT;var w2={};const{AbstractIterator:FX,AbstractKeyIterator:zX,AbstractValueIterator:VX}=ks,nb=Cs,An=Symbol("nut"),b2=Symbol("undefer"),v2=Symbol("factory");let IT=class extends FX{constructor(e,t){super(e,t),this[An]=null,this[v2]=()=>e.iterator(t),this.db.defer(()=>this[b2]())}},kT=class extends zX{constructor(e,t){super(e,t),this[An]=null,this[v2]=()=>e.keys(t),this.db.defer(()=>this[b2]())}},_T=class extends VX{constructor(e,t){super(e,t),this[An]=null,this[v2]=()=>e.values(t),this.db.defer(()=>this[b2]())}};for(const r of[IT,kT,_T])r.prototype[b2]=function(){this.db.status==="open"&&(this[An]=this[v2]())},r.prototype._next=function(e){this[An]!==null?this[An].next(e):this.db.status==="opening"?this.db.defer(()=>this._next(e)):this.nextTick(e,new nb("Iterator is not open: cannot call next() after close()",{code:"LEVEL_ITERATOR_NOT_OPEN"}))},r.prototype._nextv=function(e,t,n){this[An]!==null?this[An].nextv(e,t,n):this.db.status==="opening"?this.db.defer(()=>this._nextv(e,t,n)):this.nextTick(n,new nb("Iterator is not open: cannot call nextv() after close()",{code:"LEVEL_ITERATOR_NOT_OPEN"}))},r.prototype._all=function(e,t){this[An]!==null?this[An].all(t):this.db.status==="opening"?this.db.defer(()=>this._all(e,t)):this.nextTick(t,new nb("Iterator is not open: cannot call all() after close()",{code:"LEVEL_ITERATOR_NOT_OPEN"}))},r.prototype._seek=function(e,t){this[An]!==null?this[An]._seek(e,t):this.db.status==="opening"&&this.db.defer(()=>this._seek(e,t))},r.prototype._close=function(e){this[An]!==null?this[An].close(e):this.db.status==="opening"?this.db.defer(()=>this._close(e)):this.nextTick(e)};w2.DeferredIterator=IT,w2.DeferredKeyIterator=kT,w2.DeferredValueIterator=_T;var TT={},ib={};const{fromCallback:PT}=ld,E2=Cs,{getCallback:KX,getOptions:jX}=t1,S2=Symbol("promise"),Ai=Symbol("status"),fd=Symbol("operations"),s1=Symbol("finishClose"),pd=Symbol("closeCallbacks");let HX=class{constructor(e){if(typeof e!="object"||e===null){const t=e===null?"null":typeof e;throw new TypeError(`The first argument must be an abstract-level database, received ${t}`)}this[fd]=[],this[pd]=[],this[Ai]="open",this[s1]=this[s1].bind(this),this.db=e,this.db.attachResource(this),this.nextTick=e.nextTick}get length(){return this[fd].length}put(e,t,n){if(this[Ai]!=="open")throw new E2("Batch is not open: cannot call put() after write() or close()",{code:"LEVEL_BATCH_NOT_OPEN"});const i=this.db._checkKey(e)||this.db._checkValue(t);if(i)throw i;const s=n&&n.sublevel!=null?n.sublevel:this.db,o=n,a=s.keyEncoding(n&&n.keyEncoding),c=s.valueEncoding(n&&n.valueEncoding),l=a.format;n={...n,keyEncoding:l,valueEncoding:c.format},s!==this.db&&(n.sublevel=null);const d=s.prefixKey(a.encode(e),l),h=c.encode(t);return this._put(d,h,n),this[fd].push({...o,type:"put",key:e,value:t}),this}_put(e,t,n){}del(e,t){if(this[Ai]!=="open")throw new E2("Batch is not open: cannot call del() after write() or close()",{code:"LEVEL_BATCH_NOT_OPEN"});const n=this.db._checkKey(e);if(n)throw n;const i=t&&t.sublevel!=null?t.sublevel:this.db,s=t,o=i.keyEncoding(t&&t.keyEncoding),a=o.format;return t={...t,keyEncoding:a},i!==this.db&&(t.sublevel=null),this._del(i.prefixKey(o.encode(e),a),t),this[fd].push({...s,type:"del",key:e}),this}_del(e,t){}clear(){if(this[Ai]!=="open")throw new E2("Batch is not open: cannot call clear() after write() or close()",{code:"LEVEL_BATCH_NOT_OPEN"});return this._clear(),this[fd]=[],this}_clear(){}write(e,t){return t=KX(e,t),t=PT(t,S2),e=jX(e),this[Ai]!=="open"?this.nextTick(t,new E2("Batch is not open: cannot call write() after write() or close()",{code:"LEVEL_BATCH_NOT_OPEN"})):this.length===0?this.close(t):(this[Ai]="writing",this._write(e,n=>{this[Ai]="closing",this[pd].push(()=>t(n)),n||this.db.emit("batch",this[fd]),this._close(this[s1])})),t[S2]}_write(e,t){}close(e){return e=PT(e,S2),this[Ai]==="closing"?this[pd].push(e):this[Ai]==="closed"?this.nextTick(e):(this[pd].push(e),this[Ai]!=="writing"&&(this[Ai]="closing",this._close(this[s1]))),e[S2]}_close(e){this.nextTick(e)}[s1](){this[Ai]="closed",this.db.detachResource(this);const e=this[pd];this[pd]=[];for(const t of e)t()}};ib.AbstractChainedBatch=HX;const{AbstractChainedBatch:qX}=ib,WX=Cs,gd=Symbol("encoded");let GX=class extends qX{constructor(e){super(e),this[gd]=[]}_put(e,t,n){this[gd].push({...n,type:"put",key:e,value:t})}_del(e,t){this[gd].push({...t,type:"del",key:e})}_clear(){this[gd]=[]}_write(e,t){this.db.status==="opening"?this.db.defer(()=>this._write(e,t)):this.db.status==="open"?this[gd].length===0?this.nextTick(t):this.db._batch(this[gd],e,t):this.nextTick(t,new WX("Batch is not open: cannot call write() after write() or close()",{code:"LEVEL_BATCH_NOT_OPEN"}))}};TT.DefaultChainedBatch=GX;const DT=Cs,QX=Object.prototype.hasOwnProperty,YX=new Set(["lt","lte","gt","gte"]);var JX=function(r,e){const t={};for(const n in r)if(QX.call(r,n)&&!(n==="keyEncoding"||n==="valueEncoding")){if(n==="start"||n==="end")throw new DT(`The legacy range option '${n}' has been removed`,{code:"LEVEL_LEGACY"});if(n==="encoding")throw new DT("The levelup-style 'encoding' alias has been removed, use 'valueEncoding' instead",{code:"LEVEL_LEGACY"});YX.has(n)?t[n]=e.encode(r[n]):t[n]=r[n]}return t.reverse=!!t.reverse,t.limit=Number.isInteger(t.limit)&&t.limit>=0?t.limit:-1,t};/*! queue-microtask. MIT License. Feross Aboukhadijeh <https://feross.org/opensource> */let $T;var NT=typeof queueMicrotask=="function"?queueMicrotask.bind(typeof window<"u"?window:rt):r=>($T||($T=Promise.resolve())).then(r).catch(e=>setTimeout(()=>{throw e},0)),sb,MT;function XX(){if(MT)return sb;MT=1;const r=NT;return sb=function(e,...t){t.length===0?r(e):r(()=>e(...t))},sb}var o1={},OT;function ZX(){if(OT)return o1;OT=1;const{AbstractIterator:r,AbstractKeyIterator:e,AbstractValueIterator:t}=ks,n=Symbol("unfix"),i=Symbol("iterator"),s=Symbol("handleOne"),o=Symbol("handleMany"),a=Symbol("callback");class c extends r{constructor(p,m,f,g){super(p,m),this[i]=f,this[n]=g,this[s]=this[s].bind(this),this[o]=this[o].bind(this),this[a]=null}[s](p,m,f){const g=this[a];if(p)return g(p);m!==void 0&&(m=this[n](m)),g(p,m,f)}[o](p,m){const f=this[a];if(p)return f(p);for(const g of m){const w=g[0];w!==void 0&&(g[0]=this[n](w))}f(p,m)}}class l extends e{constructor(p,m,f,g){super(p,m),this[i]=f,this[n]=g,this[s]=this[s].bind(this),this[o]=this[o].bind(this),this[a]=null}[s](p,m){const f=this[a];if(p)return f(p);m!==void 0&&(m=this[n](m)),f(p,m)}[o](p,m){const f=this[a];if(p)return f(p);for(let g=0;g<m.length;g++){const w=m[g];w!==void 0&&(m[g]=this[n](w))}f(p,m)}}class d extends t{constructor(p,m,f){super(p,m),this[i]=f}}for(const h of[c,l])h.prototype._next=function(p){this[a]=p,this[i].next(this[s])},h.prototype._nextv=function(p,m,f){this[a]=f,this[i].nextv(p,m,this[o])},h.prototype._all=function(p,m){this[a]=m,this[i].all(p,this[o])};for(const h of[d])h.prototype._next=function(p){this[i].next(p)},h.prototype._nextv=function(p,m,f){this[i].nextv(p,m,f)},h.prototype._all=function(p,m){this[i].all(p,m)};for(const h of[c,l,d])h.prototype._seek=function(p,m){this[i].seek(p,m)},h.prototype._close=function(p){this[i].close(p)};return o1.AbstractSublevelIterator=c,o1.AbstractSublevelKeyIterator=l,o1.AbstractSublevelValueIterator=d,o1}var ob,RT;function eZ(){if(RT)return ob;RT=1;const r=Cs,{Buffer:e}=l2||{},{AbstractSublevelIterator:t,AbstractSublevelKeyIterator:n,AbstractSublevelValueIterator:i}=ZX(),s=Symbol("prefix"),o=Symbol("upperBound"),a=Symbol("prefixRange"),c=Symbol("parent"),l=Symbol("unfix"),d=new TextEncoder,h={separator:"!"};ob=function({AbstractLevel:y}){class b extends y{static defaults(E){if(typeof E=="string")throw new r("The subleveldown string shorthand for { separator } has been removed",{code:"LEVEL_LEGACY"});if(E&&E.open)throw new r("The subleveldown open option has been removed",{code:"LEVEL_LEGACY"});return E==null?h:E.separator?E:{...E,separator:"!"}}constructor(E,C,k){const{separator:x,manifest:I,...T}=b.defaults(k);C=w(C,x);const L=x.charCodeAt(0)+1,z=E[c]||E;if(!d.encode(C).every(K=>K>L&&K<127))throw new r(`Prefix must use bytes > ${L} < 127`,{code:"LEVEL_INVALID_PREFIX"});super(p(z,I),T);const B=(E.prefix||"")+x+C+x,G=B.slice(0,-1)+String.fromCharCode(L);this[c]=z,this[s]=new f(B),this[o]=new f(G),this[l]=new g,this.nextTick=z.nextTick}prefixKey(E,C){if(C==="utf8")return this[s].utf8+E;if(E.byteLength===0)return this[s][C];if(C==="view"){const k=this[s].view,x=new Uint8Array(k.byteLength+E.byteLength);return x.set(k,0),x.set(E,k.byteLength),x}else{const k=this[s].buffer;return e.concat([k,E],k.byteLength+E.byteLength)}}[a](E,C){E.gte!==void 0?E.gte=this.prefixKey(E.gte,C):E.gt!==void 0?E.gt=this.prefixKey(E.gt,C):E.gte=this[s][C],E.lte!==void 0?E.lte=this.prefixKey(E.lte,C):E.lt!==void 0?E.lt=this.prefixKey(E.lt,C):E.lte=this[o][C]}get prefix(){return this[s].utf8}get db(){return this[c]}_open(E,C){this[c].open({passive:!0},C)}_put(E,C,k,x){this[c].put(E,C,k,x)}_get(E,C,k){this[c].get(E,C,k)}_getMany(E,C,k){this[c].getMany(E,C,k)}_del(E,C,k){this[c].del(E,C,k)}_batch(E,C,k){this[c].batch(E,C,k)}_clear(E,C){this[a](E,E.keyEncoding),this[c].clear(E,C)}_iterator(E){this[a](E,E.keyEncoding);const C=this[c].iterator(E),k=this[l].get(this[s].utf8.length,E.keyEncoding);return new t(this,E,C,k)}_keys(E){this[a](E,E.keyEncoding);const C=this[c].keys(E),k=this[l].get(this[s].utf8.length,E.keyEncoding);return new n(this,E,C,k)}_values(E){this[a](E,E.keyEncoding);const C=this[c].values(E);return new i(this,E,C)}}return{AbstractSublevel:b}};const p=function(y,b){return{...y.supports,createIfMissing:!1,errorIfExists:!1,events:{},additionalMethods:{},...b,encodings:{utf8:m(y,"utf8"),buffer:m(y,"buffer"),view:m(y,"view")}}},m=function(y,b){return y.supports.encodings[b]?y.keyEncoding(b).name===b:!1};class f{constructor(b){this.utf8=b,this.view=d.encode(b),this.buffer=e?e.from(this.view.buffer,0,this.view.byteLength):{}}}class g{constructor(){this.cache=new Map}get(b,v){let E=this.cache.get(v);return E===void 0&&(v==="view"?E=(function(C,k){return k.subarray(C)}).bind(null,b):E=(function(C,k){return k.slice(C)}).bind(null,b),this.cache.set(v,E)),E}}const w=function(y,b){let v=0,E=y.length;for(;v<E&&y[v]===b;)v++;for(;E>v&&y[E-1]===b;)E--;return y.slice(v,E)};return ob}const{supports:tZ}=pT,{Transcoder:rZ}=gT,{EventEmitter:nZ}=Og,{fromCallback:za}=ld,Xi=Cs,{AbstractIterator:ml}=ks,{DefaultKeyIterator:iZ,DefaultValueIterator:sZ}=tb,{DeferredIterator:oZ,DeferredKeyIterator:aZ,DeferredValueIterator:cZ}=w2,{DefaultChainedBatch:LT}=TT,{getCallback:wl,getOptions:Va}=t1,x2=JX,Ve=Symbol("promise"),bo=Symbol("landed"),bl=Symbol("resources"),ab=Symbol("closeResources"),a1=Symbol("operations"),c1=Symbol("undefer"),A2=Symbol("deferOpen"),BT=Symbol("options"),He=Symbol("status"),vl=Symbol("defaultOptions"),yd=Symbol("transcoder"),C2=Symbol("keyEncoding"),cb=Symbol("valueEncoding"),lZ=()=>{};let lb=class extends nZ{constructor(e,t){if(super(),typeof e!="object"||e===null)throw new TypeError("The first argument 'manifest' must be an object");t=Va(t);const{keyEncoding:n,valueEncoding:i,passive:s,...o}=t;this[bl]=new Set,this[a1]=[],this[A2]=!0,this[BT]=o,this[He]="opening",this.supports=tZ(e,{status:!0,promises:!0,clear:!0,getMany:!0,deferredOpen:!0,snapshots:e.snapshots!==!1,permanence:e.permanence!==!1,keyIterator:!0,valueIterator:!0,iteratorNextv:!0,iteratorAll:!0,encodings:e.encodings||{},events:Object.assign({},e.events,{opening:!0,open:!0,closing:!0,closed:!0,put:!0,del:!0,batch:!0,clear:!0})}),this[yd]=new rZ(uZ(this)),this[C2]=this[yd].encoding(n||"utf8"),this[cb]=this[yd].encoding(i||"utf8");for(const a of this[yd].encodings())this.supports.encodings[a.commonName]||(this.supports.encodings[a.commonName]=!0);this[vl]={empty:Object.freeze({}),entry:Object.freeze({keyEncoding:this[C2].commonName,valueEncoding:this[cb].commonName}),key:Object.freeze({keyEncoding:this[C2].commonName})},this.nextTick(()=>{this[A2]&&this.open({passive:!1},lZ)})}get status(){return this[He]}keyEncoding(e){return this[yd].encoding(e??this[C2])}valueEncoding(e){return this[yd].encoding(e??this[cb])}open(e,t){t=wl(e,t),t=za(t,Ve),e={...this[BT],...Va(e)},e.createIfMissing=e.createIfMissing!==!1,e.errorIfExists=!!e.errorIfExists;const n=i=>{this[He]==="closing"||this[He]==="opening"?this.once(bo,i?()=>n(i):n):this[He]!=="open"?t(new Xi("Database is not open",{code:"LEVEL_DATABASE_NOT_OPEN",cause:i})):t()};return e.passive?this[He]==="opening"?this.once(bo,n):this.nextTick(n):this[He]==="closed"||this[A2]?(this[A2]=!1,this[He]="opening",this.emit("opening"),this._open(e,i=>{if(i){this[He]="closed",this[ab](()=>{this.emit(bo),n(i)}),this[c1]();return}this[He]="open",this[c1](),this.emit(bo),this[He]==="open"&&this.emit("open"),this[He]==="open"&&this.emit("ready"),n()})):this[He]==="open"?this.nextTick(n):this.once(bo,()=>this.open(e,t)),t[Ve]}_open(e,t){this.nextTick(t)}close(e){e=za(e,Ve);const t=n=>{this[He]==="opening"||this[He]==="closing"?this.once(bo,n?t(n):t):this[He]!=="closed"?e(new Xi("Database is not closed",{code:"LEVEL_DATABASE_NOT_CLOSED",cause:n})):e()};if(this[He]==="open"){this[He]="closing",this.emit("closing");const n=i=>{this[He]="open",this[c1](),this.emit(bo),t(i)};this[ab](()=>{this._close(i=>{if(i)return n(i);this[He]="closed",this[c1](),this.emit(bo),this[He]==="closed"&&this.emit("closed"),t()})})}else this[He]==="closed"?this.nextTick(t):this.once(bo,()=>this.close(e));return e[Ve]}[ab](e){if(this[bl].size===0)return this.nextTick(e);let t=this[bl].size,n=!0;const i=()=>{--t===0&&(n?this.nextTick(e):e())};for(const s of this[bl])s.close(i);n=!1,this[bl].clear()}_close(e){this.nextTick(e)}get(e,t,n){if(n=wl(t,n),n=za(n,Ve),t=Va(t,this[vl].entry),this[He]==="opening")return this.defer(()=>this.get(e,t,n)),n[Ve];if(md(this,n))return n[Ve];const i=this._checkKey(e);if(i)return this.nextTick(n,i),n[Ve];const s=this.keyEncoding(t.keyEncoding),o=this.valueEncoding(t.valueEncoding),a=s.format,c=o.format;return(t.keyEncoding!==a||t.valueEncoding!==c)&&(t=Object.assign({},t,{keyEncoding:a,valueEncoding:c})),this._get(this.prefixKey(s.encode(e),a),t,(l,d)=>{if(l)return(l.code==="LEVEL_NOT_FOUND"||l.notFound||/NotFound/i.test(l))&&(l.code||(l.code="LEVEL_NOT_FOUND"),l.notFound||(l.notFound=!0),l.status||(l.status=404)),n(l);try{d=o.decode(d)}catch(h){return n(new Xi("Could not decode value",{code:"LEVEL_DECODE_ERROR",cause:h}))}n(null,d)}),n[Ve]}_get(e,t,n){this.nextTick(n,new Error("NotFound"))}getMany(e,t,n){if(n=wl(t,n),n=za(n,Ve),t=Va(t,this[vl].entry),this[He]==="opening")return this.defer(()=>this.getMany(e,t,n)),n[Ve];if(md(this,n))return n[Ve];if(!Array.isArray(e))return this.nextTick(n,new TypeError("The first argument 'keys' must be an array")),n[Ve];if(e.length===0)return this.nextTick(n,null,[]),n[Ve];const i=this.keyEncoding(t.keyEncoding),s=this.valueEncoding(t.valueEncoding),o=i.format,a=s.format;(t.keyEncoding!==o||t.valueEncoding!==a)&&(t=Object.assign({},t,{keyEncoding:o,valueEncoding:a}));const c=new Array(e.length);for(let l=0;l<e.length;l++){const d=e[l],h=this._checkKey(d);if(h)return this.nextTick(n,h),n[Ve];c[l]=this.prefixKey(i.encode(d),o)}return this._getMany(c,t,(l,d)=>{if(l)return n(l);try{for(let h=0;h<d.length;h++)d[h]!==void 0&&(d[h]=s.decode(d[h]))}catch(h){return n(new Xi(`Could not decode one or more of ${d.length} value(s)`,{code:"LEVEL_DECODE_ERROR",cause:h}))}n(null,d)}),n[Ve]}_getMany(e,t,n){this.nextTick(n,null,new Array(e.length).fill(void 0))}put(e,t,n,i){if(i=wl(n,i),i=za(i,Ve),n=Va(n,this[vl].entry),this[He]==="opening")return this.defer(()=>this.put(e,t,n,i)),i[Ve];if(md(this,i))return i[Ve];const s=this._checkKey(e)||this._checkValue(t);if(s)return this.nextTick(i,s),i[Ve];const o=this.keyEncoding(n.keyEncoding),a=this.valueEncoding(n.valueEncoding),c=o.format,l=a.format;(n.keyEncoding!==c||n.valueEncoding!==l)&&(n=Object.assign({},n,{keyEncoding:c,valueEncoding:l}));const d=this.prefixKey(o.encode(e),c),h=a.encode(t);return this._put(d,h,n,p=>{if(p)return i(p);this.emit("put",e,t),i()}),i[Ve]}_put(e,t,n,i){this.nextTick(i)}del(e,t,n){if(n=wl(t,n),n=za(n,Ve),t=Va(t,this[vl].key),this[He]==="opening")return this.defer(()=>this.del(e,t,n)),n[Ve];if(md(this,n))return n[Ve];const i=this._checkKey(e);if(i)return this.nextTick(n,i),n[Ve];const s=this.keyEncoding(t.keyEncoding),o=s.format;return t.keyEncoding!==o&&(t=Object.assign({},t,{keyEncoding:o})),this._del(this.prefixKey(s.encode(e),o),t,a=>{if(a)return n(a);this.emit("del",e),n()}),n[Ve]}_del(e,t,n){this.nextTick(n)}batch(e,t,n){if(!arguments.length){if(this[He]==="opening")return new LT(this);if(this[He]!=="open")throw new Xi("Database is not open",{code:"LEVEL_DATABASE_NOT_OPEN"});return this._chainedBatch()}if(typeof e=="function"?n=e:n=wl(t,n),n=za(n,Ve),t=Va(t,this[vl].empty),this[He]==="opening")return this.defer(()=>this.batch(e,t,n)),n[Ve];if(md(this,n))return n[Ve];if(!Array.isArray(e))return this.nextTick(n,new TypeError("The first argument 'operations' must be an array")),n[Ve];if(e.length===0)return this.nextTick(n),n[Ve];const i=new Array(e.length),{keyEncoding:s,valueEncoding:o,...a}=t;for(let c=0;c<e.length;c++){if(typeof e[c]!="object"||e[c]===null)return this.nextTick(n,new TypeError("A batch operation must be an object")),n[Ve];const l=Object.assign({},e[c]);if(l.type!=="put"&&l.type!=="del")return this.nextTick(n,new TypeError("A batch operation must have a type property that is 'put' or 'del'")),n[Ve];const d=this._checkKey(l.key);if(d)return this.nextTick(n,d),n[Ve];const h=l.sublevel!=null?l.sublevel:this,p=h.keyEncoding(l.keyEncoding||s),m=p.format;if(l.key=h.prefixKey(p.encode(l.key),m),l.keyEncoding=m,l.type==="put"){const f=this._checkValue(l.value);if(f)return this.nextTick(n,f),n[Ve];const g=h.valueEncoding(l.valueEncoding||o);l.value=g.encode(l.value),l.valueEncoding=g.format}h!==this&&(l.sublevel=null),i[c]=l}return this._batch(i,a,c=>{if(c)return n(c);this.emit("batch",e),n()}),n[Ve]}_batch(e,t,n){this.nextTick(n)}sublevel(e,t){return this._sublevel(e,ub.defaults(t))}_sublevel(e,t){return new ub(this,e,t)}prefixKey(e,t){return e}clear(e,t){if(t=wl(e,t),t=za(t,Ve),e=Va(e,this[vl].empty),this[He]==="opening")return this.defer(()=>this.clear(e,t)),t[Ve];if(md(this,t))return t[Ve];const n=e,i=this.keyEncoding(e.keyEncoding);return e=x2(e,i),e.keyEncoding=i.format,e.limit===0?this.nextTick(t):this._clear(e,s=>{if(s)return t(s);this.emit("clear",n),t()}),t[Ve]}_clear(e,t){this.nextTick(t)}iterator(e){const t=this.keyEncoding(e&&e.keyEncoding),n=this.valueEncoding(e&&e.valueEncoding);if(e=x2(e,t),e.keys=e.keys!==!1,e.values=e.values!==!1,e[ml.keyEncoding]=t,e[ml.valueEncoding]=n,e.keyEncoding=t.format,e.valueEncoding=n.format,this[He]==="opening")return new oZ(this,e);if(this[He]!=="open")throw new Xi("Database is not open",{code:"LEVEL_DATABASE_NOT_OPEN"});return this._iterator(e)}_iterator(e){return new ml(this,e)}keys(e){const t=this.keyEncoding(e&&e.keyEncoding),n=this.valueEncoding(e&&e.valueEncoding);if(e=x2(e,t),e[ml.keyEncoding]=t,e[ml.valueEncoding]=n,e.keyEncoding=t.format,e.valueEncoding=n.format,this[He]==="opening")return new aZ(this,e);if(this[He]!=="open")throw new Xi("Database is not open",{code:"LEVEL_DATABASE_NOT_OPEN"});return this._keys(e)}_keys(e){return new iZ(this,e)}values(e){const t=this.keyEncoding(e&&e.keyEncoding),n=this.valueEncoding(e&&e.valueEncoding);if(e=x2(e,t),e[ml.keyEncoding]=t,e[ml.valueEncoding]=n,e.keyEncoding=t.format,e.valueEncoding=n.format,this[He]==="opening")return new cZ(this,e);if(this[He]!=="open")throw new Xi("Database is not open",{code:"LEVEL_DATABASE_NOT_OPEN"});return this._values(e)}_values(e){return new sZ(this,e)}defer(e){if(typeof e!="function")throw new TypeError("The first argument must be a function");this[a1].push(e)}[c1](){if(this[a1].length===0)return;const e=this[a1];this[a1]=[];for(const t of e)t()}attachResource(e){if(typeof e!="object"||e===null||typeof e.close!="function")throw new TypeError("The first argument must be a resource object");this[bl].add(e)}detachResource(e){this[bl].delete(e)}_chainedBatch(){return new LT(this)}_checkKey(e){if(e==null)return new Xi("Key cannot be null or undefined",{code:"LEVEL_INVALID_KEY"})}_checkValue(e){if(e==null)return new Xi("Value cannot be null or undefined",{code:"LEVEL_INVALID_VALUE"})}};lb.prototype.nextTick=XX();const{AbstractSublevel:ub}=eZ()({AbstractLevel:lb});c2.AbstractLevel=lb,c2.AbstractSublevel=ub;const md=function(r,e){return r[He]!=="open"?(r.nextTick(e,new Xi("Database is not open",{code:"LEVEL_DATABASE_NOT_OPEN"})),!0):!1},uZ=function(r){return Object.keys(r.supports.encodings).filter(e=>!!r.supports.encodings[e])};Ra.AbstractLevel=c2.AbstractLevel,Ra.AbstractSublevel=c2.AbstractSublevel,Ra.AbstractIterator=ks.AbstractIterator,Ra.AbstractKeyIterator=ks.AbstractKeyIterator,Ra.AbstractValueIterator=ks.AbstractValueIterator,Ra.AbstractChainedBatch=ib.AbstractChainedBatch;/*! run-parallel-limit. MIT License. Feross Aboukhadijeh <https://feross.org/opensource> */var dZ=fZ;const hZ=NT;function fZ(r,e,t){if(typeof e!="number")throw new Error("second argument must be a Number");let n,i,s,o,a,c=!0,l;Array.isArray(r)?(n=[],s=i=r.length):(o=Object.keys(r),n={},s=i=o.length);function d(p){function m(){t&&t(p,n),t=null}c?hZ(m):m()}function h(p,m,f){if(n[p]=f,m&&(a=!0),--s===0||m)d(m);else if(!a&&l<i){let g;o?(g=o[l],l+=1,r[g](function(w,y){h(g,w,y)})):(g=l,l+=1,r[g](function(w,y){h(g,w,y)}))}}l=e,s?o?o.some(function(p,m){return r[p](function(f,g){h(p,f,g)}),m===e-1}):r.some(function(p,m){return p(function(f,g){h(m,f,g)}),m===e-1}):d(null),c=!1}var UT={},FT=function(e){const t=e.gte!==void 0?e.gte:e.gt!==void 0?e.gt:void 0,n=e.lte!==void 0?e.lte:e.lt!==void 0?e.lt:void 0,i=e.gte===void 0,s=e.lte===void 0;return t!==void 0&&n!==void 0?IDBKeyRange.bound(t,n,i,s):t!==void 0?IDBKeyRange.lowerBound(t,i):n!==void 0?IDBKeyRange.upperBound(n,s):null};const pZ=new TextEncoder;var zT=function(r){return r instanceof Uint8Array?r:r instanceof ArrayBuffer?new Uint8Array(r):pZ.encode(r)};const{AbstractIterator:gZ}=Ra,VT=FT,I2=zT,Ps=Symbol("cache"),vo=Symbol("finished"),Yn=Symbol("options"),Eo=Symbol("currentOptions"),El=Symbol("position"),db=Symbol("location"),wd=Symbol("first"),KT={};let yZ=class extends gZ{constructor(e,t,n){super(e,n),this[Ps]=[],this[vo]=this.limit===0,this[Yn]=n,this[Eo]={...n},this[El]=void 0,this[db]=t,this[wd]=!0}_nextv(e,t,n){if(this[wd]=!1,this[vo])return this.nextTick(n,null,[]);if(this[Ps].length>0)return e=Math.min(e,this[Ps].length),this.nextTick(n,null,this[Ps].splice(0,e));this[El]!==void 0&&(this[Yn].reverse?(this[Eo].lt=this[El],this[Eo].lte=void 0):(this[Eo].gt=this[El],this[Eo].gte=void 0));let i;try{i=VT(this[Eo])}catch{return this[vo]=!0,this.nextTick(n,null,[])}const s=this.db.db.transaction([this[db]],"readonly"),o=s.objectStore(this[db]),a=[];if(this[Yn].reverse){const c=!this[Yn].values&&o.openKeyCursor?"openKeyCursor":"openCursor";o[c](i,"prev").onsuccess=l=>{const d=l.target.result;if(d){const{key:h,value:p}=d;this[El]=h,a.push([this[Yn].keys&&h!==void 0?I2(h):void 0,this[Yn].values&&p!==void 0?I2(p):void 0]),a.length<e?d.continue():jT(s)}else this[vo]=!0}}else{let c,l;const d=()=>{if(c===void 0||l===void 0)return;const h=Math.max(c.length,l.length);h===0||e===1/0?this[vo]=!0:this[El]=c[h-1],a.length=h;for(let p=0;p<h;p++){const m=c[p],f=l[p];a[p]=[this[Yn].keys&&m!==void 0?I2(m):void 0,this[Yn].values&&f!==void 0?I2(f):void 0]}jT(s)};this[Yn].keys||e<1/0?o.getAllKeys(i,e<1/0?e:void 0).onsuccess=h=>{c=h.target.result,d()}:(c=[],this.nextTick(d)),this[Yn].values?o.getAll(i,e<1/0?e:void 0).onsuccess=h=>{l=h.target.result,d()}:(l=[],this.nextTick(d))}s.onabort=()=>{n(s.error||new Error("aborted by user")),n=null},s.oncomplete=()=>{n(null,a),n=null}}_next(e){if(this[Ps].length>0){const[t,n]=this[Ps].shift();this.nextTick(e,null,t,n)}else if(this[vo])this.nextTick(e);else{let t=Math.min(100,this.limit-this.count);this[wd]&&(this[wd]=!1,t=1),this._nextv(t,KT,(n,i)=>{if(n)return e(n);this[Ps]=i,this._next(e)})}}_all(e,t){this[wd]=!1;const n=this[Ps].splice(0,this[Ps].length),i=this.limit-this.count-n.length;if(i<=0)return this.nextTick(t,null,n);this._nextv(i,KT,(s,o)=>{if(s)return t(s);n.length>0&&(o=n.concat(o)),t(null,o)})}_seek(e,t){this[wd]=!0,this[Ps]=[],this[vo]=!1,this[El]=void 0,this[Eo]={...this[Yn]};let n;try{n=VT(this[Yn])}catch{this[vo]=!0;return}n!==null&&!n.includes(e)?this[vo]=!0:this[Yn].reverse?this[Eo].lte=e:this[Eo].gte=e}};UT.Iterator=yZ;function jT(r){typeof r.commit=="function"&&r.commit()}var mZ=function(e,t,n,i,s){if(i.limit===0)return e.nextTick(s);const o=e.db.transaction([t],"readwrite"),a=o.objectStore(t);let c=0;o.oncomplete=function(){s()},o.onabort=function(){s(o.error||new Error("aborted by user"))};const l=a.openKeyCursor?"openKeyCursor":"openCursor",d=i.reverse?"prev":"next";a[l](n,d).onsuccess=function(h){const p=h.target.result;p&&(a.delete(p.key).onsuccess=function(){(i.limit<=0||++c<i.limit)&&p.continue()})}};const{AbstractLevel:wZ}=Ra,HT=Cs,bZ=dZ,{fromCallback:vZ}=ld,{Iterator:EZ}=UT,qT=zT,SZ=mZ,xZ=FT,WT="level-js-",l1=Symbol("idb"),hb=Symbol("namePrefix"),So=Symbol("location"),fb=Symbol("version"),Sl=Symbol("store"),u1=Symbol("onComplete"),GT=Symbol("promise");class QT extends wZ{constructor(e,t,n){if(typeof t=="function"||typeof n=="function")throw new HT("The levelup-style callback argument has been removed",{code:"LEVEL_LEGACY"});const{prefix:i,version:s,...o}=t||{};if(super({encodings:{view:!0},snapshots:!1,createIfMissing:!1,errorIfExists:!1,seek:!0},o),typeof e!="string")throw new Error("constructor requires a location string argument");this[So]=e,this[hb]=i??WT,this[fb]=parseInt(s||1,10),this[l1]=null}get location(){return this[So]}get namePrefix(){return this[hb]}get version(){return this[fb]}get db(){return this[l1]}get type(){return"browser-level"}_open(e,t){const n=indexedDB.open(this[hb]+this[So],this[fb]);n.onerror=function(){t(n.error||new Error("unknown error"))},n.onsuccess=()=>{this[l1]=n.result,t()},n.onupgradeneeded=i=>{const s=i.target.result;s.objectStoreNames.contains(this[So])||s.createObjectStore(this[So])}}[Sl](e){return this[l1].transaction([this[So]],e).objectStore(this[So])}[u1](e,t){const n=e.transaction;n.onabort=function(){t(n.error||new Error("aborted by user"))},n.oncomplete=function(){t(null,e.result)}}_get(e,t,n){const i=this[Sl]("readonly");let s;try{s=i.get(e)}catch(o){return this.nextTick(n,o)}this[u1](s,function(o,a){if(o)return n(o);if(a===void 0)return n(new HT("Entry not found",{code:"LEVEL_NOT_FOUND"}));n(null,qT(a))})}_getMany(e,t,n){const i=this[Sl]("readonly"),s=e.map(o=>a=>{let c;try{c=i.get(o)}catch(l){return a(l)}c.onsuccess=()=>{const l=c.result;a(null,l===void 0?l:qT(l))},c.onerror=l=>{l.stopPropagation(),a(c.error)}});bZ(s,16,n)}_del(e,t,n){const i=this[Sl]("readwrite");let s;try{s=i.delete(e)}catch(o){return this.nextTick(n,o)}this[u1](s,n)}_put(e,t,n,i){const s=this[Sl]("readwrite");let o;try{o=s.put(t,e)}catch(a){return this.nextTick(i,a)}this[u1](o,i)}_iterator(e){return new EZ(this,this[So],e)}_batch(e,t,n){const i=this[Sl]("readwrite"),s=i.transaction;let o=0,a;s.onabort=function(){n(a||s.error||new Error("aborted by user"))},s.oncomplete=function(){n()};function c(){const l=e[o++],d=l.key;let h;try{h=l.type==="del"?i.delete(d):i.put(l.value,d)}catch(p){a=p,s.abort();return}o<e.length?h.onsuccess=c:typeof s.commit=="function"&&s.commit()}c()}_clear(e,t){let n,i;try{n=xZ(e)}catch{return this.nextTick(t)}if(e.limit>=0)return SZ(this,this[So],n,e,t);try{const s=this[Sl]("readwrite");i=n?s.delete(n):s.clear()}catch(s){return this.nextTick(t,s)}this[u1](i,t)}_close(e){this[l1].close(),this.nextTick(e)}}QT.destroy=function(r,e,t){typeof e=="function"&&(t=e,e=WT),t=vZ(t,GT);const n=indexedDB.deleteDatabase(e+r);return n.onsuccess=function(){t()},n.onerror=function(i){t(i)},t[GT]},fT.BrowserLevel=QT;var AZ=fT.BrowserLevel;const CZ="./level",IZ="view",pb=async({path:r,valueEncoding:e}={})=>{r=r||CZ,e=e||IZ;const t=new AZ(r,{valueEncoding:e,passive:!0});return await t.open(),{put:async(d,h)=>{await t.put(d,h)},del:async d=>{await t.del(d)},get:async d=>{try{const h=await t.get(d);if(h)return h}catch{}},iterator:async function*({amount:d,reverse:h}={}){const p={limit:d||-1,reverse:h||!1};for await(const[m,f]of t.iterator(p))yield[m,f]},merge:async d=>{},clear:async()=>{await t.clear()},close:async()=>{await t.close()}}},YT=1e6,Ds=async({size:r}={})=>{let e=new c6(r||YT);return{put:async(l,d)=>{e.set(l,d)},del:async l=>{e.remove(l)},get:async l=>e.get(l),iterator:async function*(){for await(const l of e.keys){const d=e.get(l);yield[l,d]}},merge:async l=>{if(l)for await(const[d,h]of l.iterator())e.set(d,h)},clear:async()=>{e=new c6(r||YT)},close:async()=>{}}},kZ=16,gb=1e3,yb=async({ipfs:r,identity:e,address:t,name:n,access:i,directory:s,meta:o,headsStorage:a,entryStorage:c,indexStorage:l,referencesCount:d,syncAutomatically:h,onUpdate:p})=>{s=Da(s||"./orbitdb",`./${t}/`),o=o||{},d=Number(d)>-1?d:kZ,c=c||await ul(await Ds({size:gb}),await a2({ipfs:r,pin:!0})),a=a||await ul(await Ds({size:gb}),await pb({path:Da(s,"/log/_heads/")})),l=l||await ul(await Ds({size:gb}),await pb({path:Da(s,"/log/_index/")}));const m=await lX(e,{logId:t,access:i,entryStorage:c,headsStorage:a,indexStorage:l}),f=new Og.EventEmitter,g=new Ta({concurrency:1}),w=async C=>{const k=async()=>{const I=await m.append(C,{referencesCount:d});return await E.add(I),p&&await p(m,I),f.emit("update",I),I.hash},x=await g.add(k);return await g.onIdle(),x},y=async C=>{const k=async()=>{const x=await yo.decode(C);x&&await m.joinEntry(x)&&(p&&await p(m,x),f.emit("update",x))};await g.add(k)},b=async()=>{await E.stop(),await g.onIdle(),await m.close(),i&&i.close&&await i.close(),f.emit("close")},v=async()=>{await g.onIdle(),await m.clear(),i&&i.drop&&await i.drop(),f.emit("drop")},E=await tQ({ipfs:r,log:m,events:f,onSynced:y,start:h});return{address:t,name:n,identity:e,meta:o,close:b,drop:v,addOperation:w,log:m,sync:E,peers:E.peers,events:f,access:i}},JT="documents",_Z={indexBy:"_id"},XT=({indexBy:r}=_Z)=>async({ipfs:e,identity:t,address:n,name:i,access:s,directory:o,meta:a,headsStorage:c,entryStorage:l,indexStorage:d,referencesCount:h,syncAutomatically:p,onUpdate:m})=>{const f=await yb({ipfs:e,identity:t,address:n,name:i,access:s,directory:o,meta:a,headsStorage:c,entryStorage:l,indexStorage:d,referencesCount:h,syncAutomatically:p}),{addOperation:g,log:w}=f,y=async x=>{const I=x[r];if(!I)throw new Error(`The provided document doesn't contain field '${r}'`);return g({op:"PUT",key:I,value:x})},b=async x=>{if(!await v(x))throw new Error(`No document with key '${x}' in the database`);return g({op:"DEL",key:x,value:null})},v=async x=>{for await(const I of C())if(x===I.key)return I},E=async x=>{const I=[];for await(const T of C())x(T.value)&&I.push(T.value);return I},C=async function*({amount:x}={}){const I={};let T=0;for await(const L of w.iterator()){const{op:z,key:B,value:G}=L.payload;if(z==="PUT"&&!I[B]?(I[B]=!0,T++,yield{hash:L.hash,key:B,value:G}):z==="DEL"&&!I[B]&&(I[B]=!0),T>=x)break}};return{...f,type:JT,put:y,del:b,get:v,iterator:C,query:E,indexBy:r,all:async()=>{const x=[];for await(const I of C())x.unshift(I);return x}}};XT.type=JT;const ZT="events",eP=()=>async({ipfs:r,identity:e,address:t,name:n,access:i,directory:s,meta:o,headsStorage:a,entryStorage:c,indexStorage:l,referencesCount:d,syncAutomatically:h,onUpdate:p})=>{const m=await yb({ipfs:r,identity:e,address:t,name:n,access:i,directory:s,meta:o,headsStorage:a,entryStorage:c,indexStorage:l,referencesCount:d,syncAutomatically:h,onUpdate:p}),{addOperation:f,log:g}=m,w=async E=>f({op:"ADD",key:null,value:E}),y=async E=>(await g.get(E)).payload.value,b=async function*({gt:E,gte:C,lt:k,lte:x,amount:I}={}){const T=g.iterator({gt:E,gte:C,lt:k,lte:x,amount:I});for await(const L of T){const z=L.hash,B=L.payload.value;yield{hash:z,value:B}}};return{...m,type:ZT,add:w,get:y,iterator:b,all:async()=>{const E=[];for await(const C of b())E.unshift(C);return E}}};eP.type=ZT;const tP="keyvalue",rP=()=>async({ipfs:r,identity:e,address:t,name:n,access:i,directory:s,meta:o,headsStorage:a,entryStorage:c,indexStorage:l,referencesCount:d,syncAutomatically:h,onUpdate:p})=>{const m=await yb({ipfs:r,identity:e,address:t,name:n,access:i,directory:s,meta:o,headsStorage:a,entryStorage:c,indexStorage:l,referencesCount:d,syncAutomatically:h,onUpdate:p}),{addOperation:f,log:g}=m,w=async(C,k)=>f({op:"PUT",key:C,value:k}),y=async C=>f({op:"DEL",key:C,value:null}),b=async C=>{for await(const k of g.traverse()){const{op:x,key:I,value:T}=k.payload;if(x==="PUT"&&I===C)return T;if(x==="DEL"&&I===C)return}},v=async function*({amount:C}={}){const k={};let x=0;for await(const I of g.traverse()){const{op:T,key:L,value:z}=I.payload;if(T==="PUT"&&!k[L]){k[L]=!0,x++;const B=I.hash;yield{key:L,value:z,hash:B}}else T==="DEL"&&!k[L]&&(k[L]=!0);if(x>=C)break}};return{...m,type:tP,put:w,set:w,del:y,get:b,iterator:v,all:async()=>{const C=[];for await(const k of v())C.unshift(k);return C}}};rP.type=tP;const mb={},wb=r=>{if(!r.type)throw new Error("Database type does not contain required field 'type'.");mb[r.type]=r},TZ=r=>{if(!r)throw new Error("Type not specified");if(!mb[r])throw new Error(`Unsupported database type: '${r}'`);return mb[r]};wb(eP),wb(XT),wb(rP);const PZ=Symbol.for("@libp2p/connection"),bd=Symbol.for("@libp2p/content-routing"),k2=Symbol.for("@libp2p/peer-discovery"),bb=Symbol.for("@libp2p/peer-id");function nP(r){return!!(r!=null&&r[bb])}const vd=Symbol.for("@libp2p/peer-routing"),_2="keep-alive",T2="StrictSign",vb="StrictNoSign";var Ci;(function(r){r.Accept="accept",r.Ignore="ignore",r.Reject="reject"})(Ci||(Ci={}));const P2=Symbol.for("@libp2p/transport");var xl;(function(r){r[r.FATAL_ALL=0]="FATAL_ALL",r[r.NO_FATAL=1]="NO_FATAL"})(xl||(xl={}));let Al=(PA=class extends Error{constructor(e="The operation was aborted"){super(e),this.name="AbortError"}},u(PA,"name","AbortError"),PA);class iP extends Error{constructor(e="Unexpected Peer"){super(e),this.name="UnexpectedPeerError"}}u(iP,"name","UnexpectedPeerError");let DZ=(DA=class extends Error{constructor(e="Invalid crypto exchange"){super(e),this.name="InvalidCryptoExchangeError"}},u(DA,"name","InvalidCryptoExchangeError"),DA);class Z extends Error{constructor(e="Invalid parameters"){super(e),this.name="InvalidParametersError"}}u(Z,"name","InvalidParametersError");class d1 extends Error{constructor(e="Invalid public key"){super(e),this.name="InvalidPublicKeyError"}}u(d1,"name","InvalidPublicKeyError");class Eb extends Error{constructor(e="Invalid private key"){super(e),this.name="InvalidPrivateKeyError"}}u(Eb,"name","InvalidPrivateKeyError");class sP extends Error{constructor(e="The connection is closing"){super(e),this.name="ConnectionClosingError"}}u(sP,"name","ConnectionClosingError");class Sb extends Error{constructor(e="The connection is closed"){super(e),this.name="ConnectionClosedError"}}u(Sb,"name","ConnectionClosedError");class xb extends Error{constructor(e="Connection failed"){super(e),this.name="ConnectionFailedError"}}u(xb,"name","ConnectionFailedError");class Cl extends Error{constructor(e="The muxer is closed"){super(e),this.name="MuxerClosedError"}}u(Cl,"name","MuxerClosedError");class oP extends Error{constructor(e="The stream has been reset"){super(e),this.name="StreamResetError"}}u(oP,"name","StreamResetError");class D2 extends Error{constructor(e="The stream is in an invalid state"){super(e),this.name="StreamStateError"}}u(D2,"name","StreamStateError");let Zt=($A=class extends Error{constructor(e="Not found"){super(e),this.name="NotFoundError"}},u($A,"name","NotFoundError"),$A);class Ab extends Error{constructor(e="Invalid PeerID"){super(e),this.name="InvalidPeerIdError"}}u(Ab,"name","InvalidPeerIdError");class $2 extends Error{constructor(e="Invalid multiaddr"){super(e),this.name="InvalidMultiaddrError"}}u($2,"name","InvalidMultiaddrError");class aP extends Error{constructor(e="Invalid CID"){super(e),this.name="InvalidCIDError"}}u(aP,"name","InvalidCIDError");class N2 extends Error{constructor(e="Invalid Multihash"){super(e),this.name="InvalidMultihashError"}}u(N2,"name","InvalidMultihashError");class h1 extends Error{constructor(e="Unsupported protocol error"){super(e),this.name="UnsupportedProtocolError"}}u(h1,"name","UnsupportedProtocolError");class St extends Error{constructor(e="Invalid message"){super(e),this.name="InvalidMessageError"}}u(St,"name","InvalidMessageError");class cP extends Error{constructor(e="Protocol error"){super(e),this.name="ProtocolError"}}u(cP,"name","ProtocolError");class f1 extends Error{constructor(e="Timed out"){super(e),this.name="TimeoutError"}}u(f1,"name","TimeoutError");class Il extends Error{constructor(e="Not started"){super(e),this.name="NotStartedError"}}u(Il,"name","NotStartedError");class Ed extends Error{constructor(e="Dial error"){super(e),this.name="DialError"}}u(Ed,"name","DialError");class M2 extends Error{constructor(e="Listen error"){super(e),this.name="ListenError"}}u(M2,"name","ListenError");class Cb extends Error{constructor(e="Limited connection"){super(e),this.name="LimitedConnectionError"}}u(Cb,"name","LimitedConnectionError");class lP extends Error{constructor(e="Too many inbound protocol streams"){super(e),this.name="TooManyInboundProtocolStreamsError"}}u(lP,"name","TooManyInboundProtocolStreamsError");class O2 extends Error{constructor(e="Too many outbound protocol streams"){super(e),this.name="TooManyOutboundProtocolStreamsError"}}u(O2,"name","TooManyOutboundProtocolStreamsError");class kl extends Error{constructor(e="Unsupported key type"){super(e),this.name="UnsupportedKeyTypeError"}}u(kl,"name","UnsupportedKeyTypeError");function cCe(){}class er extends EventTarget{constructor(){super();Ye(this,Js,new Map)}listenerCount(t){const n=se(this,Js).get(t);return n==null?0:n.length}addEventListener(t,n,i){super.addEventListener(t,n,i);let s=se(this,Js).get(t);s==null&&(s=[],se(this,Js).set(t,s)),s.push({callback:n,once:(i!==!0&&i!==!1&&(i==null?void 0:i.once))??!1})}removeEventListener(t,n,i){super.removeEventListener(t.toString(),n??null,i);let s=se(this,Js).get(t);s!=null&&(s=s.filter(({callback:o})=>o!==n),se(this,Js).set(t,s))}dispatchEvent(t){const n=super.dispatchEvent(t);let i=se(this,Js).get(t.type);return i==null||(i=i.filter(({once:s})=>!s),se(this,Js).set(t.type,i)),n}safeDispatchEvent(t,n={}){return this.dispatchEvent(new CustomEvent(t,n))}}Js=new WeakMap;function Ib(r){return r!=null&&typeof r.start=="function"&&typeof r.stop=="function"}async function xo(...r){const e=[];for(const t of r)Ib(t)&&e.push(t);await Promise.all(e.map(async t=>{t.beforeStart!=null&&await t.beforeStart()})),await Promise.all(e.map(async t=>{await t.start()})),await Promise.all(e.map(async t=>{t.afterStart!=null&&await t.afterStart()}))}async function Ka(...r){const e=[];for(const t of r)Ib(t)&&e.push(t);await Promise.all(e.map(async t=>{t.beforeStop!=null&&await t.beforeStop()})),await Promise.all(e.map(async t=>{await t.stop()})),await Promise.all(e.map(async t=>{t.afterStop!=null&&await t.afterStop()}))}const ur=Symbol.for("@libp2p/service-capabilities"),ja=Symbol.for("@libp2p/service-dependencies");function $Z(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function R2(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function NZ(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var i=0;i<r.length;i++){var s=r.charAt(i),o=s.charCodeAt(0);if(t[o]!==255)throw new TypeError(s+" is ambiguous");t[o]=i}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),d=Math.log(256)/Math.log(a);function h(f){if(f instanceof Uint8Array||(ArrayBuffer.isView(f)?f=new Uint8Array(f.buffer,f.byteOffset,f.byteLength):Array.isArray(f)&&(f=Uint8Array.from(f))),!(f instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(f.length===0)return"";for(var g=0,w=0,y=0,b=f.length;y!==b&&f[y]===0;)y++,g++;for(var v=(b-y)*d+1>>>0,E=new Uint8Array(v);y!==b;){for(var C=f[y],k=0,x=v-1;(C!==0||k<w)&&x!==-1;x--,k++)C+=256*E[x]>>>0,E[x]=C%a>>>0,C=C/a>>>0;if(C!==0)throw new Error("Non-zero carry");w=k,y++}for(var I=v-w;I!==v&&E[I]===0;)I++;for(var T=c.repeat(g);I<v;++I)T+=r.charAt(E[I]);return T}function p(f){if(typeof f!="string")throw new TypeError("Expected String");if(f.length===0)return new Uint8Array;var g=0;if(f[g]!==" "){for(var w=0,y=0;f[g]===c;)w++,g++;for(var b=(f.length-g)*l+1>>>0,v=new Uint8Array(b);f[g];){var E=t[f.charCodeAt(g)];if(E===255)return;for(var C=0,k=b-1;(E!==0||C<y)&&k!==-1;k--,C++)E+=a*v[k]>>>0,v[k]=E%256>>>0,E=E/256>>>0;if(E!==0)throw new Error("Non-zero carry");y=C,g++}if(f[g]!==" "){for(var x=b-y;x!==b&&v[x]===0;)x++;for(var I=new Uint8Array(w+(b-x)),T=w;x!==b;)I[T++]=v[x++];return I}}}function m(f){var g=p(f);if(g)return g;throw new Error(`Non-${e} character`)}return{encode:h,decodeUnsafe:p,decode:m}}var MZ=NZ,OZ=MZ;let RZ=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseEncode");this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},LZ=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseDecode");u(this,"prefixCodePoint");this.name=e,this.prefix=t;const i=t.codePointAt(0);if(i===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=i,this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return uP(this,e)}},BZ=class{constructor(e){u(this,"decoders");this.decoders=e}or(e){return uP(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};function uP(r,e){return new BZ({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}let UZ=class{constructor(e,t,n,i){u(this,"name");u(this,"prefix");u(this,"baseEncode");u(this,"baseDecode");u(this,"encoder");u(this,"decoder");this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=i,this.encoder=new RZ(e,t,n),this.decoder=new LZ(e,t,i)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};function dP({name:r,prefix:e,encode:t,decode:n}){return new UZ(r,e,t,n)}function L2({name:r,prefix:e,alphabet:t}){const{encode:n,decode:i}=OZ(t,r);return dP({prefix:e,name:r,encode:n,decode:s=>R2(i(s))})}function FZ(r,e,t,n){const i={};for(let d=0;d<e.length;++d)i[e[d]]=d;let s=r.length;for(;r[s-1]==="=";)--s;const o=new Uint8Array(s*t/8|0);let a=0,c=0,l=0;for(let d=0;d<s;++d){const h=i[r[d]];if(h===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|h,a+=t,a>=8&&(a-=8,o[l++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o}function zZ(r,e,t){const n=e[e.length-1]==="=",i=(1<<t)-1;let s="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,s+=e[i&a>>o];if(o!==0&&(s+=e[i&a<<t-o]),n)for(;s.length*t&7;)s+="=";return s}function Jn({name:r,prefix:e,bitsPerChar:t,alphabet:n}){return dP({prefix:e,name:r,encode(i){return zZ(i,n,t)},decode(i){return FZ(i,n,t,r)}})}const Ii=L2({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});L2({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});const B2=Jn({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});Jn({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),Jn({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),Jn({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),Jn({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),Jn({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),Jn({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),Jn({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),Jn({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const kb=L2({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"});L2({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});var VZ=fP,hP=128,KZ=-128,jZ=Math.pow(2,31);function fP(r,e,t){e=e||[],t=t||0;for(var n=t;r>=jZ;)e[t++]=r&255|hP,r/=128;for(;r&KZ;)e[t++]=r&255|hP,r>>>=7;return e[t]=r|0,fP.bytes=t-n+1,e}var HZ=_b,qZ=128,pP=127;function _b(r,n){var t=0,n=n||0,i=0,s=n,o,a=r.length;do{if(s>=a)throw _b.bytes=0,new RangeError("Could not decode varint");o=r[s++],t+=i<28?(o&pP)<<i:(o&pP)*Math.pow(2,i),i+=7}while(o>=qZ);return _b.bytes=s-n,t}var WZ=Math.pow(2,7),GZ=Math.pow(2,14),QZ=Math.pow(2,21),YZ=Math.pow(2,28),JZ=Math.pow(2,35),XZ=Math.pow(2,42),ZZ=Math.pow(2,49),eee=Math.pow(2,56),tee=Math.pow(2,63),ree=function(r){return r<WZ?1:r<GZ?2:r<QZ?3:r<YZ?4:r<JZ?5:r<XZ?6:r<ZZ?7:r<eee?8:r<tee?9:10},nee={encode:VZ,decode:HZ,encodingLength:ree},U2=nee;function Tb(r,e=0){return[U2.decode(r,e),U2.decode.bytes]}function F2(r,e,t=0){return U2.encode(r,e,t),e}function z2(r){return U2.encodingLength(r)}function _l(r,e){const t=e.byteLength,n=z2(r),i=n+z2(t),s=new Uint8Array(i+t);return F2(r,s,0),F2(t,s,n),s.set(e,i),new Pb(r,t,e,s)}function iee(r){const e=R2(r),[t,n]=Tb(e),[i,s]=Tb(e.subarray(n)),o=e.subarray(n+s);if(o.byteLength!==i)throw new Error("Incorrect length");return new Pb(t,i,o,e)}function see(r,e){if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&$Z(r.bytes,t.bytes)}}let Pb=class{constructor(e,t,n,i){u(this,"code");u(this,"size");u(this,"digest");u(this,"bytes");this.code=e,this.size=t,this.digest=n,this.bytes=i}};function gP(r,e){const{bytes:t,version:n}=r;switch(n){case 0:return aee(t,Db(r),e??Ii.encoder);default:return cee(t,Db(r),e??B2.encoder)}}const yP=new WeakMap;function Db(r){const e=yP.get(r);if(e==null){const t=new Map;return yP.set(r,t),t}return e}let V2=class jr{constructor(e,t,n,i){u(this,"code");u(this,"version");u(this,"multihash");u(this,"bytes");u(this,"/");u(this,Sj,"CID");this.code=t,this.version=e,this.multihash=n,this.bytes=i,this["/"]=i}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==p1)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==lee)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return jr.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=_l(e,t);return jr.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return jr.equals(this,e)}static equals(e,t){const n=t;return n!=null&&e.code===n.code&&e.version===n.version&&see(e.multihash,n.multihash)}toString(e){return gP(this,e)}toJSON(){return{"/":gP(this)}}link(){return this}[(Sj=Symbol.toStringTag,Symbol.for("nodejs.util.inspect.custom"))](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof jr)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:i,multihash:s,bytes:o}=t;return new jr(n,i,s,o??mP(n,i,s.bytes))}else if(t[uee]===!0){const{version:n,multihash:i,code:s}=t,o=iee(i);return jr.create(n,s,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==p1)throw new Error(`Version 0 CID must use dag-pb (code: ${p1}) block encoding`);return new jr(e,t,n,n.bytes)}case 1:{const i=mP(e,t,n.bytes);return new jr(e,t,n,i)}default:throw new Error("Invalid version")}}static createV0(e){return jr.create(0,p1,e)}static createV1(e,t){return jr.create(1,e,t)}static decode(e){const[t,n]=jr.decodeFirst(e);if(n.length!==0)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=jr.inspectBytes(e),n=t.size-t.multihashSize,i=R2(e.subarray(n,n+t.multihashSize));if(i.byteLength!==t.multihashSize)throw new Error("Incorrect length");const s=i.subarray(t.multihashSize-t.digestSize),o=new Pb(t.multihashCode,t.digestSize,s,i);return[t.version===0?jr.createV0(o):jr.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[h,p]=Tb(e.subarray(t));return t+=p,h};let i=n(),s=p1;if(i===18?(i=0,t=0):s=n(),i!==0&&i!==1)throw new RangeError(`Invalid CID version ${i}`);const o=t,a=n(),c=n(),l=t+c,d=l-o;return{version:i,codec:s,multihashCode:a,digestSize:c,multihashSize:d,size:l}}static parse(e,t){const[n,i]=oee(e,t),s=jr.decode(i);if(s.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return Db(s).set(n,e),s}};function oee(r,e){switch(r[0]){case"Q":{const t=e??Ii;return[Ii.prefix,t.decode(`${Ii.prefix}${r}`)]}case Ii.prefix:{const t=e??Ii;return[Ii.prefix,t.decode(r)]}case B2.prefix:{const t=e??B2;return[B2.prefix,t.decode(r)]}case kb.prefix:{const t=e??kb;return[kb.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}}function aee(r,e,t){const{prefix:n}=t;if(n!==Ii.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const i=e.get(n);if(i==null){const s=t.encode(r).slice(1);return e.set(n,s),s}else return i}function cee(r,e,t){const{prefix:n}=t,i=e.get(n);if(i==null){const s=t.encode(r);return e.set(n,s),s}else return i}const p1=112,lee=18;function mP(r,e,t){const n=z2(r),i=n+z2(e),s=new Uint8Array(i+t.byteLength);return F2(r,s,0),F2(e,s,n),s.set(t,i),s}const uee=Symbol.for("@ipld/js-cid/CID"),wP=0,dee="identity",bP=R2;function hee(r){return _l(wP,bP(r))}const $b={code:wP,name:dee,encode:bP,digest:hee};function qe(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function We(r=0){return new Uint8Array(r)}function Cn(r=0){return new Uint8Array(r)}function lCe(r){return r}function sr(r,e){e==null&&(e=r.reduce((i,s)=>i+s.length,0));const t=Cn(e);let n=0;for(const i of r)t.set(i,n),n+=i.length;return t}const vP=Symbol.for("@achingbrain/uint8arraylist");function EP(r,e){if(e==null||e<0)throw new RangeError("index is out of bounds");let t=0;for(const n of r){const i=t+n.byteLength;if(e<i)return{buf:n,index:e-t};t=i}throw new RangeError("index is out of bounds")}function g1(r){return!!(r!=null&&r[vP])}class Le{constructor(...e){u(this,"bufs");u(this,"length");u(this,xj,!0);this.bufs=[],this.length=0,e.length>0&&this.appendAll(e)}*[(xj=vP,Symbol.iterator)](){yield*this.bufs}get byteLength(){return this.length}append(...e){this.appendAll(e)}appendAll(e){let t=0;for(const n of e)if(n instanceof Uint8Array)t+=n.byteLength,this.bufs.push(n);else if(g1(n))t+=n.byteLength,this.bufs.push(...n.bufs);else throw new Error("Could not append value, must be an Uint8Array or a Uint8ArrayList");this.length+=t}prepend(...e){this.prependAll(e)}prependAll(e){let t=0;for(const n of e.reverse())if(n instanceof Uint8Array)t+=n.byteLength,this.bufs.unshift(n);else if(g1(n))t+=n.byteLength,this.bufs.unshift(...n.bufs);else throw new Error("Could not prepend value, must be an Uint8Array or a Uint8ArrayList");this.length+=t}get(e){const t=EP(this.bufs,e);return t.buf[t.index]}set(e,t){const n=EP(this.bufs,e);n.buf[n.index]=t}write(e,t=0){if(e instanceof Uint8Array)for(let n=0;n<e.length;n++)this.set(t+n,e[n]);else if(g1(e))for(let n=0;n<e.length;n++)this.set(t+n,e.get(n));else throw new Error("Could not write value, must be an Uint8Array or a Uint8ArrayList")}consume(e){if(e=Math.trunc(e),!(Number.isNaN(e)||e<=0)){if(e===this.byteLength){this.bufs=[],this.length=0;return}for(;this.bufs.length>0;)if(e>=this.bufs[0].byteLength)e-=this.bufs[0].byteLength,this.length-=this.bufs[0].byteLength,this.bufs.shift();else{this.bufs[0]=this.bufs[0].subarray(e),this.length-=e;break}}}slice(e,t){const{bufs:n,length:i}=this._subList(e,t);return sr(n,i)}subarray(e,t){const{bufs:n,length:i}=this._subList(e,t);return n.length===1?n[0]:sr(n,i)}sublist(e,t){const{bufs:n,length:i}=this._subList(e,t),s=new Le;return s.length=i,s.bufs=[...n],s}_subList(e,t){if(e=e??0,t=t??this.length,e<0&&(e=this.length+e),t<0&&(t=this.length+t),e<0||t>this.length)throw new RangeError("index is out of bounds");if(e===t)return{bufs:[],length:0};if(e===0&&t===this.length)return{bufs:this.bufs,length:this.length};const n=[];let i=0;for(let s=0;s<this.bufs.length;s++){const o=this.bufs[s],a=i,c=a+o.byteLength;if(i=c,e>=c)continue;const l=e>=a&&e<c,d=t>a&&t<=c;if(l&&d){if(e===a&&t===c){n.push(o);break}const h=e-a;n.push(o.subarray(h,h+(t-e)));break}if(l){if(e===0){n.push(o);continue}n.push(o.subarray(e-a));continue}if(d){if(t===c){n.push(o);break}n.push(o.subarray(0,t-a));break}n.push(o)}return{bufs:n,length:t-e}}indexOf(e,t=0){if(!g1(e)&&!(e instanceof Uint8Array))throw new TypeError('The "value" argument must be a Uint8ArrayList or Uint8Array');const n=e instanceof Uint8Array?e:e.subarray();if(t=Number(t??0),isNaN(t)&&(t=0),t<0&&(t=this.length+t),t<0&&(t=0),e.length===0)return t>this.length?this.length:t;const i=n.byteLength;if(i===0)throw new TypeError("search must be at least 1 byte long");const s=256,o=new Int32Array(s);for(let h=0;h<s;h++)o[h]=-1;for(let h=0;h<i;h++)o[n[h]]=h;const a=o,c=this.byteLength-n.byteLength,l=n.byteLength-1;let d;for(let h=t;h<=c;h+=d){d=0;for(let p=l;p>=0;p--){const m=this.get(h+p);if(n[p]!==m){d=Math.max(1,p-a[m]);break}}if(d===0)return h}return-1}getInt8(e){const t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getInt8(0)}setInt8(e,t){const n=Cn(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setInt8(0,t),this.write(n,e)}getInt16(e,t){const n=this.subarray(e,e+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt16(0,t)}setInt16(e,t,n){const i=We(2);new DataView(i.buffer,i.byteOffset,i.byteLength).setInt16(0,t,n),this.write(i,e)}getInt32(e,t){const n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getInt32(0,t)}setInt32(e,t,n){const i=We(4);new DataView(i.buffer,i.byteOffset,i.byteLength).setInt32(0,t,n),this.write(i,e)}getBigInt64(e,t){const n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigInt64(0,t)}setBigInt64(e,t,n){const i=We(8);new DataView(i.buffer,i.byteOffset,i.byteLength).setBigInt64(0,t,n),this.write(i,e)}getUint8(e){const t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getUint8(0)}setUint8(e,t){const n=Cn(1);new DataView(n.buffer,n.byteOffset,n.byteLength).setUint8(0,t),this.write(n,e)}getUint16(e,t){const n=this.subarray(e,e+2);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint16(0,t)}setUint16(e,t,n){const i=We(2);new DataView(i.buffer,i.byteOffset,i.byteLength).setUint16(0,t,n),this.write(i,e)}getUint32(e,t){const n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getUint32(0,t)}setUint32(e,t,n){const i=We(4);new DataView(i.buffer,i.byteOffset,i.byteLength).setUint32(0,t,n),this.write(i,e)}getBigUint64(e,t){const n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getBigUint64(0,t)}setBigUint64(e,t,n){const i=We(8);new DataView(i.buffer,i.byteOffset,i.byteLength).setBigUint64(0,t,n),this.write(i,e)}getFloat32(e,t){const n=this.subarray(e,e+4);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat32(0,t)}setFloat32(e,t,n){const i=We(4);new DataView(i.buffer,i.byteOffset,i.byteLength).setFloat32(0,t,n),this.write(i,e)}getFloat64(e,t){const n=this.subarray(e,e+8);return new DataView(n.buffer,n.byteOffset,n.byteLength).getFloat64(0,t)}setFloat64(e,t,n){const i=We(8);new DataView(i.buffer,i.byteOffset,i.byteLength).setFloat64(0,t,n),this.write(i,e)}equals(e){if(e==null||!(e instanceof Le)||e.bufs.length!==this.bufs.length)return!1;for(let t=0;t<this.bufs.length;t++)if(!qe(this.bufs[t],e.bufs[t]))return!1;return!0}static fromUint8Arrays(e,t){const n=new Le;return n.bufs=e,t==null&&(t=e.reduce((i,s)=>i+s.byteLength,0)),n.length=t,n}}function fee(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function pee(r){return new TextEncoder().encode(r)}function gee(r){return new TextDecoder().decode(r)}function yee(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var i=0;i<r.length;i++){var s=r.charAt(i),o=s.charCodeAt(0);if(t[o]!==255)throw new TypeError(s+" is ambiguous");t[o]=i}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),d=Math.log(256)/Math.log(a);function h(f){if(f instanceof Uint8Array||(ArrayBuffer.isView(f)?f=new Uint8Array(f.buffer,f.byteOffset,f.byteLength):Array.isArray(f)&&(f=Uint8Array.from(f))),!(f instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(f.length===0)return"";for(var g=0,w=0,y=0,b=f.length;y!==b&&f[y]===0;)y++,g++;for(var v=(b-y)*d+1>>>0,E=new Uint8Array(v);y!==b;){for(var C=f[y],k=0,x=v-1;(C!==0||k<w)&&x!==-1;x--,k++)C+=256*E[x]>>>0,E[x]=C%a>>>0,C=C/a>>>0;if(C!==0)throw new Error("Non-zero carry");w=k,y++}for(var I=v-w;I!==v&&E[I]===0;)I++;for(var T=c.repeat(g);I<v;++I)T+=r.charAt(E[I]);return T}function p(f){if(typeof f!="string")throw new TypeError("Expected String");if(f.length===0)return new Uint8Array;var g=0;if(f[g]!==" "){for(var w=0,y=0;f[g]===c;)w++,g++;for(var b=(f.length-g)*l+1>>>0,v=new Uint8Array(b);f[g];){var E=t[f.charCodeAt(g)];if(E===255)return;for(var C=0,k=b-1;(E!==0||C<y)&&k!==-1;k--,C++)E+=a*v[k]>>>0,v[k]=E%256>>>0,E=E/256>>>0;if(E!==0)throw new Error("Non-zero carry");y=C,g++}if(f[g]!==" "){for(var x=b-y;x!==b&&v[x]===0;)x++;for(var I=new Uint8Array(w+(b-x)),T=w;x!==b;)I[T++]=v[x++];return I}}}function m(f){var g=p(f);if(g)return g;throw new Error(`Non-${e} character`)}return{encode:h,decodeUnsafe:p,decode:m}}var mee=yee,wee=mee;let bee=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseEncode");this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},vee=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseDecode");u(this,"prefixCodePoint");this.name=e,this.prefix=t;const i=t.codePointAt(0);if(i===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=i,this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return SP(this,e)}},Eee=class{constructor(e){u(this,"decoders");this.decoders=e}or(e){return SP(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};function SP(r,e){return new Eee({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}let See=class{constructor(e,t,n,i){u(this,"name");u(this,"prefix");u(this,"baseEncode");u(this,"baseDecode");u(this,"encoder");u(this,"decoder");this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=i,this.encoder=new bee(e,t,n),this.decoder=new vee(e,t,i)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};function K2({name:r,prefix:e,encode:t,decode:n}){return new See(r,e,t,n)}function y1({name:r,prefix:e,alphabet:t}){const{encode:n,decode:i}=wee(t,r);return K2({prefix:e,name:r,encode:n,decode:s=>fee(i(s))})}function xee(r,e,t,n){const i={};for(let d=0;d<e.length;++d)i[e[d]]=d;let s=r.length;for(;r[s-1]==="=";)--s;const o=new Uint8Array(s*t/8|0);let a=0,c=0,l=0;for(let d=0;d<s;++d){const h=i[r[d]];if(h===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|h,a+=t,a>=8&&(a-=8,o[l++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o}function Aee(r,e,t){const n=e[e.length-1]==="=",i=(1<<t)-1;let s="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,s+=e[i&a>>o];if(o!==0&&(s+=e[i&a<<t-o]),n)for(;s.length*t&7;)s+="=";return s}function vr({name:r,prefix:e,bitsPerChar:t,alphabet:n}){return K2({prefix:e,name:r,encode(i){return Aee(i,n,t)},decode(i){return xee(i,n,t,r)}})}const Cee=y1({prefix:"9",name:"base10",alphabet:"0123456789"}),Iee=Object.freeze(Object.defineProperty({__proto__:null,base10:Cee},Symbol.toStringTag,{value:"Module"})),kee=vr({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),_ee=vr({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),Tee=Object.freeze(Object.defineProperty({__proto__:null,base16:kee,base16upper:_ee},Symbol.toStringTag,{value:"Module"})),Pee=vr({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),Dee=Object.freeze(Object.defineProperty({__proto__:null,base2:Pee},Symbol.toStringTag,{value:"Module"})),xP=Array.from("🚀🪐☄🛰🌌🌑🌒🌓🌔🌕🌖🌗🌘🌍🌏🌎🐉☀💻🖥💾💿😂❤😍🤣😊🙏💕😭😘👍😅👏😁🔥🥰💔💖💙😢🤔😆🙄💪😉☺👌🤗💜😔😎😇🌹🤦🎉💞✌✨🤷😱😌🌸🙌😋💗💚😏💛🙂💓🤩😄😀🖤😃💯🙈👇🎶😒🤭❣😜💋👀😪😑💥🙋😞😩😡🤪👊🥳😥🤤👉💃😳✋😚😝😴🌟😬🙃🍀🌷😻😓⭐✅🥺🌈😈🤘💦✔😣🏃💐☹🎊💘😠☝😕🌺🎂🌻😐🖕💝🙊😹🗣💫💀👑🎵🤞😛🔴😤🌼😫⚽🤙☕🏆🤫👈😮🙆🍻🍃🐶💁😲🌿🧡🎁⚡🌞🎈❌✊👋😰🤨😶🤝🚶💰🍓💢🤟🙁🚨💨🤬✈🎀🍺🤓😙💟🌱😖👶🥴▶➡❓💎💸⬇😨🌚🦋😷🕺⚠🙅😟😵👎🤲🤠🤧📌🔵💅🧐🐾🍒😗🤑🌊🤯🐷☎💧😯💆👆🎤🙇🍑❄🌴💣🐸💌📍🥀🤢👅💡💩👐📸👻🤐🤮🎼🥵🚩🍎🍊👼💍📣🥂"),$ee=xP.reduce((r,e,t)=>(r[t]=e,r),[]),Nee=xP.reduce((r,e,t)=>{const n=e.codePointAt(0);if(n==null)throw new Error(`Invalid character: ${e}`);return r[n]=t,r},[]);function Mee(r){return r.reduce((e,t)=>(e+=$ee[t],e),"")}function Oee(r){const e=[];for(const t of r){const n=t.codePointAt(0);if(n==null)throw new Error(`Invalid character: ${t}`);const i=Nee[n];if(i==null)throw new Error(`Non-base256emoji character: ${t}`);e.push(i)}return new Uint8Array(e)}const Ree=K2({prefix:"🚀",name:"base256emoji",encode:Mee,decode:Oee}),Lee=Object.freeze(Object.defineProperty({__proto__:null,base256emoji:Ree},Symbol.toStringTag,{value:"Module"})),Bee=vr({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),Uee=vr({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),Fee=vr({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),zee=vr({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),Vee=vr({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),Kee=vr({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),jee=vr({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),Hee=vr({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),qee=vr({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),Wee=Object.freeze(Object.defineProperty({__proto__:null,base32:Bee,base32hex:Vee,base32hexpad:jee,base32hexpadupper:Hee,base32hexupper:Kee,base32pad:Fee,base32padupper:zee,base32upper:Uee,base32z:qee},Symbol.toStringTag,{value:"Module"})),Gee=y1({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),Qee=y1({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),Yee=Object.freeze(Object.defineProperty({__proto__:null,base36:Gee,base36upper:Qee},Symbol.toStringTag,{value:"Module"})),Jee=y1({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),Xee=y1({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),Zee=Object.freeze(Object.defineProperty({__proto__:null,base58btc:Jee,base58flickr:Xee},Symbol.toStringTag,{value:"Module"})),ete=vr({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),tte=vr({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),rte=vr({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),nte=vr({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),ite=Object.freeze(Object.defineProperty({__proto__:null,base64:ete,base64pad:tte,base64url:rte,base64urlpad:nte},Symbol.toStringTag,{value:"Module"})),ste=vr({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),ote=Object.freeze(Object.defineProperty({__proto__:null,base8:ste},Symbol.toStringTag,{value:"Module"})),ate=K2({prefix:"\0",name:"identity",encode:r=>gee(r),decode:r=>pee(r)}),cte=Object.freeze(Object.defineProperty({__proto__:null,identity:ate},Symbol.toStringTag,{value:"Module"}));new TextEncoder,new TextDecoder;const AP={...cte,...Dee,...ote,...Iee,...Tee,...Wee,...Yee,...Zee,...ite,...Lee};function CP(r,e,t,n){return{name:r,prefix:e,encoder:{name:r,prefix:e,encode:t},decoder:{decode:n}}}const IP=CP("utf8","u",r=>"u"+new TextDecoder("utf8").decode(r),r=>new TextEncoder().encode(r.substring(1))),Nb=CP("ascii","a",r=>{let e="a";for(let t=0;t<r.length;t++)e+=String.fromCharCode(r[t]);return e},r=>{r=r.substring(1);const e=Cn(r.length);for(let t=0;t<r.length;t++)e[t]=r.charCodeAt(t);return e}),kP={utf8:IP,"utf-8":IP,hex:AP.base16,latin1:Nb,ascii:Nb,binary:Nb,...AP};function ie(r,e="utf8"){const t=kP[e];if(t==null)throw new Error(`Unsupported encoding "${e}"`);return t.decoder.decode(`${t.prefix}${r}`)}function re(r,e="utf8"){const t=kP[e];if(t==null)throw new Error(`Unsupported encoding "${e}"`);return t.encoder.encode(r).substring(1)}const lte=parseInt("11111",2),Mb=parseInt("10000000",2),ute=parseInt("01111111",2),_P={0:w1,1:w1,2:dte,3:pte,4:gte,5:fte,6:hte,16:w1,22:w1,48:w1};function Ha(r,e={offset:0}){const t=r[e.offset]&lte;if(e.offset++,_P[t]!=null)return _P[t](r,e);throw new Error("No decoder for tag "+t)}function m1(r,e){let t=0;if((r[e.offset]&Mb)===Mb){const n=r[e.offset]&ute;let i="0x";e.offset++;for(let s=0;s<n;s++,e.offset++)i+=r[e.offset].toString(16).padStart(2,"0");t=parseInt(i,16)}else t=r[e.offset],e.offset++;return t}function w1(r,e){m1(r,e);const t=[];for(;!(e.offset>=r.byteLength);){const n=Ha(r,e);if(n===null)break;t.push(n)}return t}function dte(r,e){const t=m1(r,e),n=e.offset,i=e.offset+t,s=[];for(let o=n;o<i;o++)o===n&&r[o]===0||s.push(r[o]);return e.offset+=t,Uint8Array.from(s)}function hte(r,e){const t=m1(r,e),n=e.offset+t,i=r[e.offset];e.offset++;let s=0,o=0;i<40?(s=0,o=i):i<80?(s=1,o=i-40):(s=2,o=i-80);let a=`${s}.${o}`,c=[];for(;e.offset<n;){const l=r[e.offset];if(e.offset++,c.push(l&127),l<128){c.reverse();let d=0;for(let h=0;h<c.length;h++)d+=c[h]<<h*7;a+=`.${d}`,c=[]}}return a}function fte(r,e){return e.offset++,null}function pte(r,e){const t=m1(r,e),n=r[e.offset];e.offset++;const i=r.subarray(e.offset,e.offset+t-1);if(e.offset+=t,n!==0)throw new Error("Unused bits in bit string is unimplemented");return i}function gte(r,e){const t=m1(r,e),n=r.subarray(e.offset,e.offset+t);return e.offset+=t,n}function yte(r){let e=r.toString(16);e.length%2===1&&(e="0"+e);const t=new Le;for(let n=0;n<e.length;n+=2)t.append(Uint8Array.from([parseInt(`${e[n]}${e[n+1]}`,16)]));return t}function j2(r){if(r.byteLength<128)return Uint8Array.from([r.byteLength]);const e=yte(r.byteLength);return new Le(Uint8Array.from([e.byteLength|Mb]),e)}function Xn(r){const e=new Le,t=128;return(r.subarray()[0]&t)===t&&e.append(Uint8Array.from([0])),e.append(r),new Le(Uint8Array.from([2]),j2(e),e)}function Ob(r){const e=Uint8Array.from([0]),t=new Le(e,r);return new Le(Uint8Array.from([3]),j2(t),t)}function mte(r){return new Le(Uint8Array.from([4]),j2(r),r)}function Ao(r,e=48){const t=new Le;for(const n of r)t.append(n);return new Le(Uint8Array.from([e]),j2(t),t)}const TP="1.2.840.10045.3.1.7",PP="1.3.132.0.34",DP="1.3.132.0.35";async function wte(r="P-256"){const e=await crypto.subtle.generateKey({name:"ECDSA",namedCurve:r},!0,["sign","verify"]);return{publicKey:await crypto.subtle.exportKey("jwk",e.publicKey),privateKey:await crypto.subtle.exportKey("jwk",e.privateKey)}}async function bte(r,e){const t=await crypto.subtle.importKey("jwk",r,{name:"ECDSA",namedCurve:r.crv??"P-256"},!1,["sign"]),n=await crypto.subtle.sign({name:"ECDSA",hash:{name:"SHA-256"}},t,e.subarray());return new Uint8Array(n,0,n.byteLength)}async function vte(r,e,t){const n=await crypto.subtle.importKey("jwk",r,{name:"ECDSA",namedCurve:r.crv??"P-256"},!1,["verify"]);return crypto.subtle.verify({name:"ECDSA",hash:{name:"SHA-256"}},n,e,t.subarray())}const Ete=Uint8Array.from([6,8,42,134,72,206,61,3,1,7]),Ste=Uint8Array.from([6,5,43,129,4,0,34]),xte=Uint8Array.from([6,5,43,129,4,0,35]),$P={ext:!0,kty:"EC",crv:"P-256"},NP={ext:!0,kty:"EC",crv:"P-384"},MP={ext:!0,kty:"EC",crv:"P-521"},Sd=32,xd=48,Ad=66;function Ate(r){const e=Ha(r);return OP(e)}function OP(r){const e=r[1],t=re(e,"base64url"),n=r[2][1][0],i=1;let s,o;if(e.byteLength===Sd)return s=re(n.subarray(i,i+Sd),"base64url"),o=re(n.subarray(i+Sd),"base64url"),new q2({...$P,key_ops:["sign"],d:t,x:s,y:o});if(e.byteLength===xd)return s=re(n.subarray(i,i+xd),"base64url"),o=re(n.subarray(i+xd),"base64url"),new q2({...NP,key_ops:["sign"],d:t,x:s,y:o});if(e.byteLength===Ad)return s=re(n.subarray(i,i+Ad),"base64url"),o=re(n.subarray(i+Ad),"base64url"),new q2({...MP,key_ops:["sign"],d:t,x:s,y:o});throw new Z(`Private key length was wrong length, got ${e.byteLength}, expected 32, 48 or 66`)}function RP(r){const e=Ha(r);return LP(e)}function LP(r){const e=r[1][1][0],t=1;let n,i;if(e.byteLength===Sd*2+1)return n=re(e.subarray(t,t+Sd),"base64url"),i=re(e.subarray(t+Sd),"base64url"),new H2({...$P,key_ops:["verify"],x:n,y:i});if(e.byteLength===xd*2+1)return n=re(e.subarray(t,t+xd),"base64url"),i=re(e.subarray(t+xd),"base64url"),new H2({...NP,key_ops:["verify"],x:n,y:i});if(e.byteLength===Ad*2+1)return n=re(e.subarray(t,t+Ad),"base64url"),i=re(e.subarray(t+Ad),"base64url"),new H2({...MP,key_ops:["verify"],x:n,y:i});throw new Z(`coordinates were wrong length, got ${e.byteLength}, expected 65, 97 or 133`)}function Cte(r){return Ao([Xn(Uint8Array.from([1])),mte(ie(r.d??"","base64url")),Ao([BP(r.crv)],160),Ao([Ob(new Le(Uint8Array.from([4]),ie(r.x??"","base64url"),ie(r.y??"","base64url")))],161)]).subarray()}function Ite(r){return Ao([Xn(Uint8Array.from([1])),Ao([BP(r.crv)],160),Ao([Ob(new Le(Uint8Array.from([4]),ie(r.x??"","base64url"),ie(r.y??"","base64url")))],161)]).subarray()}function BP(r){if(r==="P-256")return Ete;if(r==="P-384")return Ste;if(r==="P-521")return xte;throw new Z(`Invalid curve ${r}`)}async function kte(r="P-256"){const e=await wte(r);return new q2(e.privateKey)}class H2{constructor(e){u(this,"type","ECDSA");u(this,"jwk");u(this,"_raw");this.jwk=e}get raw(){return this._raw==null&&(this._raw=Ite(this.jwk)),this._raw}toMultihash(){return $b.digest(ki(this))}toCID(){return V2.createV1(114,this.toMultihash())}toString(){return Ii.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:qe(this.raw,e.raw)}async verify(e,t){return vte(this.jwk,t,e)}}class q2{constructor(e){u(this,"type","ECDSA");u(this,"jwk");u(this,"publicKey");u(this,"_raw");this.jwk=e,this.publicKey=new H2({crv:e.crv,ext:e.ext,key_ops:["verify"],kty:"EC",x:e.x,y:e.y})}get raw(){return this._raw==null&&(this._raw=Cte(this.jwk)),this._raw}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:qe(this.raw,e.raw)}async sign(e){return bte(this.jwk,e)}}function UP(r){if(!Number.isSafeInteger(r)||r<0)throw new Error("positive integer expected, got "+r)}function _te(r){return r instanceof Uint8Array||ArrayBuffer.isView(r)&&r.constructor.name==="Uint8Array"}function W2(r,...e){if(!_te(r))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(r.length))throw new Error("Uint8Array expected of length "+e+", got length="+r.length)}function Tte(r){if(typeof r!="function"||typeof r.create!="function")throw new Error("Hash should be wrapped by utils.wrapConstructor");UP(r.outputLen),UP(r.blockLen)}function G2(r,e=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(e&&r.finished)throw new Error("Hash#digest() has already been called")}function Pte(r,e){W2(r);const t=e.outputLen;if(r.length<t)throw new Error("digestInto() expects output buffer of length at least "+t)}const Cd=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */function Rb(r){return new DataView(r.buffer,r.byteOffset,r.byteLength)}function $s(r,e){return r<<32-e|r>>>e}typeof Uint8Array.from([]).toHex=="function"&&Uint8Array.fromHex;function Dte(r){if(typeof r!="string")throw new Error("utf8ToBytes expected string, got "+typeof r);return new Uint8Array(new TextEncoder().encode(r))}function Lb(r){return typeof r=="string"&&(r=Dte(r)),W2(r),r}function $te(...r){let e=0;for(let n=0;n<r.length;n++){const i=r[n];W2(i),e+=i.length}const t=new Uint8Array(e);for(let n=0,i=0;n<r.length;n++){const s=r[n];t.set(s,i),i+=s.length}return t}let FP=class{clone(){return this._cloneInto()}};function zP(r){const e=n=>r().update(Lb(n)).digest(),t=r();return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=()=>r(),e}function Bb(r=32){if(Cd&&typeof Cd.getRandomValues=="function")return Cd.getRandomValues(new Uint8Array(r));if(Cd&&typeof Cd.randomBytes=="function")return Uint8Array.from(Cd.randomBytes(r));throw new Error("crypto.getRandomValues must be defined")}function Nte(r,e,t,n){if(typeof r.setBigUint64=="function")return r.setBigUint64(e,t,n);const i=BigInt(32),s=BigInt(4294967295),o=Number(t>>i&s),a=Number(t&s),c=n?4:0,l=n?0:4;r.setUint32(e+c,o,n),r.setUint32(e+l,a,n)}function Mte(r,e,t){return r&e^~r&t}function Ote(r,e,t){return r&e^r&t^e&t}let VP=class extends FP{constructor(e,t,n,i){super(),this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.blockLen=e,this.outputLen=t,this.padOffset=n,this.isLE=i,this.buffer=new Uint8Array(e),this.view=Rb(this.buffer)}update(e){G2(this);const{view:t,buffer:n,blockLen:i}=this;e=Lb(e);const s=e.length;for(let o=0;o<s;){const a=Math.min(i-this.pos,s-o);if(a===i){const c=Rb(e);for(;i<=s-o;o+=i)this.process(c,o);continue}n.set(e.subarray(o,o+a),this.pos),this.pos+=a,o+=a,this.pos===i&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){G2(this),Pte(e,this),this.finished=!0;const{buffer:t,view:n,blockLen:i,isLE:s}=this;let{pos:o}=this;t[o++]=128,this.buffer.subarray(o).fill(0),this.padOffset>i-o&&(this.process(n,0),o=0);for(let h=o;h<i;h++)t[h]=0;Nte(n,i-8,BigInt(this.length*8),s),this.process(n,0);const a=Rb(e),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const l=c/4,d=this.get();if(l>d.length)throw new Error("_sha2: outputLen bigger than state");for(let h=0;h<l;h++)a.setUint32(4*h,d[h],s)}digest(){const{buffer:e,outputLen:t}=this;this.digestInto(e);const n=e.slice(0,t);return this.destroy(),n}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());const{blockLen:t,buffer:n,length:i,finished:s,destroyed:o,pos:a}=this;return e.length=i,e.pos=a,e.finished=s,e.destroyed=o,i%t&&e.buffer.set(n),e}};const Rte=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),qa=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),Wa=new Uint32Array(64);let Lte=class extends VP{constructor(e=32){super(64,e,8,!1),this.A=qa[0]|0,this.B=qa[1]|0,this.C=qa[2]|0,this.D=qa[3]|0,this.E=qa[4]|0,this.F=qa[5]|0,this.G=qa[6]|0,this.H=qa[7]|0}get(){const{A:e,B:t,C:n,D:i,E:s,F:o,G:a,H:c}=this;return[e,t,n,i,s,o,a,c]}set(e,t,n,i,s,o,a,c){this.A=e|0,this.B=t|0,this.C=n|0,this.D=i|0,this.E=s|0,this.F=o|0,this.G=a|0,this.H=c|0}process(e,t){for(let h=0;h<16;h++,t+=4)Wa[h]=e.getUint32(t,!1);for(let h=16;h<64;h++){const p=Wa[h-15],m=Wa[h-2],f=$s(p,7)^$s(p,18)^p>>>3,g=$s(m,17)^$s(m,19)^m>>>10;Wa[h]=g+Wa[h-7]+f+Wa[h-16]|0}let{A:n,B:i,C:s,D:o,E:a,F:c,G:l,H:d}=this;for(let h=0;h<64;h++){const p=$s(a,6)^$s(a,11)^$s(a,25),m=d+p+Mte(a,c,l)+Rte[h]+Wa[h]|0,g=($s(n,2)^$s(n,13)^$s(n,22))+Ote(n,i,s)|0;d=l,l=c,c=a,a=o+m|0,o=s,s=i,i=n,n=m+g|0}n=n+this.A|0,i=i+this.B|0,s=s+this.C|0,o=o+this.D|0,a=a+this.E|0,c=c+this.F|0,l=l+this.G|0,d=d+this.H|0,this.set(n,i,s,o,a,c,l,d)}roundClean(){Wa.fill(0)}destroy(){this.set(0,0,0,0,0,0,0,0),this.buffer.fill(0)}};const Bte=zP(()=>new Lte),Q2=BigInt(2**32-1),Ub=BigInt(32);function KP(r,e=!1){return e?{h:Number(r&Q2),l:Number(r>>Ub&Q2)}:{h:Number(r>>Ub&Q2)|0,l:Number(r&Q2)|0}}function Ute(r,e=!1){let t=new Uint32Array(r.length),n=new Uint32Array(r.length);for(let i=0;i<r.length;i++){const{h:s,l:o}=KP(r[i],e);[t[i],n[i]]=[s,o]}return[t,n]}const Fte=(r,e)=>BigInt(r>>>0)<<Ub|BigInt(e>>>0),zte=(r,e,t)=>r>>>t,Vte=(r,e,t)=>r<<32-t|e>>>t,Kte=(r,e,t)=>r>>>t|e<<32-t,jte=(r,e,t)=>r<<32-t|e>>>t,Hte=(r,e,t)=>r<<64-t|e>>>t-32,qte=(r,e,t)=>r>>>t-32|e<<64-t,Wte=(r,e)=>e,Gte=(r,e)=>r,Qte=(r,e,t)=>r<<t|e>>>32-t,Yte=(r,e,t)=>e<<t|r>>>32-t,Jte=(r,e,t)=>e<<t-32|r>>>64-t,Xte=(r,e,t)=>r<<t-32|e>>>64-t;function Zte(r,e,t,n){const i=(e>>>0)+(n>>>0);return{h:r+t+(i/2**32|0)|0,l:i|0}}const Ke={fromBig:KP,split:Ute,toBig:Fte,shrSH:zte,shrSL:Vte,rotrSH:Kte,rotrSL:jte,rotrBH:Hte,rotrBL:qte,rotr32H:Wte,rotr32L:Gte,rotlSH:Qte,rotlSL:Yte,rotlBH:Jte,rotlBL:Xte,add:Zte,add3L:(r,e,t)=>(r>>>0)+(e>>>0)+(t>>>0),add3H:(r,e,t,n)=>e+t+n+(r/2**32|0)|0,add4L:(r,e,t,n)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0),add4H:(r,e,t,n,i)=>e+t+n+i+(r/2**32|0)|0,add5H:(r,e,t,n,i,s)=>e+t+n+i+s+(r/2**32|0)|0,add5L:(r,e,t,n,i)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0)+(i>>>0)},[ere,tre]=Ke.split(["0x428a2f98d728ae22","0x7137449123ef65cd","0xb5c0fbcfec4d3b2f","0xe9b5dba58189dbbc","0x3956c25bf348b538","0x59f111f1b605d019","0x923f82a4af194f9b","0xab1c5ed5da6d8118","0xd807aa98a3030242","0x12835b0145706fbe","0x243185be4ee4b28c","0x550c7dc3d5ffb4e2","0x72be5d74f27b896f","0x80deb1fe3b1696b1","0x9bdc06a725c71235","0xc19bf174cf692694","0xe49b69c19ef14ad2","0xefbe4786384f25e3","0x0fc19dc68b8cd5b5","0x240ca1cc77ac9c65","0x2de92c6f592b0275","0x4a7484aa6ea6e483","0x5cb0a9dcbd41fbd4","0x76f988da831153b5","0x983e5152ee66dfab","0xa831c66d2db43210","0xb00327c898fb213f","0xbf597fc7beef0ee4","0xc6e00bf33da88fc2","0xd5a79147930aa725","0x06ca6351e003826f","0x142929670a0e6e70","0x27b70a8546d22ffc","0x2e1b21385c26c926","0x4d2c6dfc5ac42aed","0x53380d139d95b3df","0x650a73548baf63de","0x766a0abb3c77b2a8","0x81c2c92e47edaee6","0x92722c851482353b","0xa2bfe8a14cf10364","0xa81a664bbc423001","0xc24b8b70d0f89791","0xc76c51a30654be30","0xd192e819d6ef5218","0xd69906245565a910","0xf40e35855771202a","0x106aa07032bbd1b8","0x19a4c116b8d2d0c8","0x1e376c085141ab53","0x2748774cdf8eeb99","0x34b0bcb5e19b48a8","0x391c0cb3c5c95a63","0x4ed8aa4ae3418acb","0x5b9cca4f7763e373","0x682e6ff3d6b2b8a3","0x748f82ee5defb2fc","0x78a5636f43172f60","0x84c87814a1f0ab72","0x8cc702081a6439ec","0x90befffa23631e28","0xa4506cebde82bde9","0xbef9a3f7b2c67915","0xc67178f2e372532b","0xca273eceea26619c","0xd186b8c721c0c207","0xeada7dd6cde0eb1e","0xf57d4f7fee6ed178","0x06f067aa72176fba","0x0a637dc5a2c898a6","0x113f9804bef90dae","0x1b710b35131c471b","0x28db77f523047d84","0x32caab7b40c72493","0x3c9ebe0a15c9bebc","0x431d67c49c100d4c","0x4cc5d4becb3e42b6","0x597f299cfc657e2a","0x5fcb6fab3ad6faec","0x6c44198c4a475817"].map(r=>BigInt(r))),Ga=new Uint32Array(80),Qa=new Uint32Array(80);let rre=class extends VP{constructor(e=64){super(128,e,16,!1),this.Ah=1779033703,this.Al=-205731576,this.Bh=-1150833019,this.Bl=-2067093701,this.Ch=1013904242,this.Cl=-23791573,this.Dh=-1521486534,this.Dl=1595750129,this.Eh=1359893119,this.El=-1377402159,this.Fh=-1694144372,this.Fl=725511199,this.Gh=528734635,this.Gl=-79577749,this.Hh=1541459225,this.Hl=327033209}get(){const{Ah:e,Al:t,Bh:n,Bl:i,Ch:s,Cl:o,Dh:a,Dl:c,Eh:l,El:d,Fh:h,Fl:p,Gh:m,Gl:f,Hh:g,Hl:w}=this;return[e,t,n,i,s,o,a,c,l,d,h,p,m,f,g,w]}set(e,t,n,i,s,o,a,c,l,d,h,p,m,f,g,w){this.Ah=e|0,this.Al=t|0,this.Bh=n|0,this.Bl=i|0,this.Ch=s|0,this.Cl=o|0,this.Dh=a|0,this.Dl=c|0,this.Eh=l|0,this.El=d|0,this.Fh=h|0,this.Fl=p|0,this.Gh=m|0,this.Gl=f|0,this.Hh=g|0,this.Hl=w|0}process(e,t){for(let v=0;v<16;v++,t+=4)Ga[v]=e.getUint32(t),Qa[v]=e.getUint32(t+=4);for(let v=16;v<80;v++){const E=Ga[v-15]|0,C=Qa[v-15]|0,k=Ke.rotrSH(E,C,1)^Ke.rotrSH(E,C,8)^Ke.shrSH(E,C,7),x=Ke.rotrSL(E,C,1)^Ke.rotrSL(E,C,8)^Ke.shrSL(E,C,7),I=Ga[v-2]|0,T=Qa[v-2]|0,L=Ke.rotrSH(I,T,19)^Ke.rotrBH(I,T,61)^Ke.shrSH(I,T,6),z=Ke.rotrSL(I,T,19)^Ke.rotrBL(I,T,61)^Ke.shrSL(I,T,6),B=Ke.add4L(x,z,Qa[v-7],Qa[v-16]),G=Ke.add4H(B,k,L,Ga[v-7],Ga[v-16]);Ga[v]=G|0,Qa[v]=B|0}let{Ah:n,Al:i,Bh:s,Bl:o,Ch:a,Cl:c,Dh:l,Dl:d,Eh:h,El:p,Fh:m,Fl:f,Gh:g,Gl:w,Hh:y,Hl:b}=this;for(let v=0;v<80;v++){const E=Ke.rotrSH(h,p,14)^Ke.rotrSH(h,p,18)^Ke.rotrBH(h,p,41),C=Ke.rotrSL(h,p,14)^Ke.rotrSL(h,p,18)^Ke.rotrBL(h,p,41),k=h&m^~h&g,x=p&f^~p&w,I=Ke.add5L(b,C,x,tre[v],Qa[v]),T=Ke.add5H(I,y,E,k,ere[v],Ga[v]),L=I|0,z=Ke.rotrSH(n,i,28)^Ke.rotrBH(n,i,34)^Ke.rotrBH(n,i,39),B=Ke.rotrSL(n,i,28)^Ke.rotrBL(n,i,34)^Ke.rotrBL(n,i,39),G=n&s^n&a^s&a,K=i&o^i&c^o&c;y=g|0,b=w|0,g=m|0,w=f|0,m=h|0,f=p|0,{h,l:p}=Ke.add(l|0,d|0,T|0,L|0),l=a|0,d=c|0,a=s|0,c=o|0,s=n|0,o=i|0;const q=Ke.add3L(L,B,K);n=Ke.add3H(q,T,z,G),i=q|0}({h:n,l:i}=Ke.add(this.Ah|0,this.Al|0,n|0,i|0)),{h:s,l:o}=Ke.add(this.Bh|0,this.Bl|0,s|0,o|0),{h:a,l:c}=Ke.add(this.Ch|0,this.Cl|0,a|0,c|0),{h:l,l:d}=Ke.add(this.Dh|0,this.Dl|0,l|0,d|0),{h,l:p}=Ke.add(this.Eh|0,this.El|0,h|0,p|0),{h:m,l:f}=Ke.add(this.Fh|0,this.Fl|0,m|0,f|0),{h:g,l:w}=Ke.add(this.Gh|0,this.Gl|0,g|0,w|0),{h:y,l:b}=Ke.add(this.Hh|0,this.Hl|0,y|0,b|0),this.set(n,i,s,o,a,c,l,d,h,p,m,f,g,w,y,b)}roundClean(){Ga.fill(0),Qa.fill(0)}destroy(){this.buffer.fill(0),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}};const nre=zP(()=>new rre);/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const Fb=BigInt(0),zb=BigInt(1);function Id(r){return r instanceof Uint8Array||ArrayBuffer.isView(r)&&r.constructor.name==="Uint8Array"}function Vb(r){if(!Id(r))throw new Error("Uint8Array expected")}function Ya(r,e){if(typeof e!="boolean")throw new Error(r+" boolean expected, got "+e)}function Y2(r){const e=r.toString(16);return e.length&1?"0"+e:e}function jP(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);return r===""?Fb:BigInt("0x"+r)}const HP=typeof Uint8Array.from([]).toHex=="function"&&typeof Uint8Array.fromHex=="function",ire=Array.from({length:256},(r,e)=>e.toString(16).padStart(2,"0"));function kd(r){if(Vb(r),HP)return r.toHex();let e="";for(let t=0;t<r.length;t++)e+=ire[r[t]];return e}const Co={_0:48,_9:57,A:65,F:70,a:97,f:102};function qP(r){if(r>=Co._0&&r<=Co._9)return r-Co._0;if(r>=Co.A&&r<=Co.F)return r-(Co.A-10);if(r>=Co.a&&r<=Co.f)return r-(Co.a-10)}function J2(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);if(HP)return Uint8Array.fromHex(r);const e=r.length,t=e/2;if(e%2)throw new Error("hex string expected, got unpadded hex of length "+e);const n=new Uint8Array(t);for(let i=0,s=0;i<t;i++,s+=2){const o=qP(r.charCodeAt(s)),a=qP(r.charCodeAt(s+1));if(o===void 0||a===void 0){const c=r[s]+r[s+1];throw new Error('hex string expected, got non-hex character "'+c+'" at index '+s)}n[i]=o*16+a}return n}function Tl(r){return jP(kd(r))}function Pl(r){return Vb(r),jP(kd(Uint8Array.from(r).reverse()))}function b1(r,e){return J2(r.toString(16).padStart(e*2,"0"))}function v1(r,e){return b1(r,e).reverse()}function Ht(r,e,t){let n;if(typeof e=="string")try{n=J2(e)}catch(s){throw new Error(r+" must be hex string or Uint8Array, cause: "+s)}else if(Id(e))n=Uint8Array.from(e);else throw new Error(r+" must be hex string or Uint8Array");const i=n.length;if(typeof t=="number"&&i!==t)throw new Error(r+" of length "+t+" expected, got "+i);return n}function _d(...r){let e=0;for(let n=0;n<r.length;n++){const i=r[n];Vb(i),e+=i.length}const t=new Uint8Array(e);for(let n=0,i=0;n<r.length;n++){const s=r[n];t.set(s,i),i+=s.length}return t}const Kb=r=>typeof r=="bigint"&&Fb<=r;function jb(r,e,t){return Kb(r)&&Kb(e)&&Kb(t)&&e<=r&&r<t}function Zn(r,e,t,n){if(!jb(e,t,n))throw new Error("expected valid "+r+": "+t+" <= n < "+n+", got "+e)}function sre(r){let e;for(e=0;r>Fb;r>>=zb,e+=1);return e}const X2=r=>(zb<<BigInt(r))-zb,Hb=r=>new Uint8Array(r),WP=r=>Uint8Array.from(r);function ore(r,e,t){if(typeof r!="number"||r<2)throw new Error("hashLen must be a number");if(typeof e!="number"||e<2)throw new Error("qByteLen must be a number");if(typeof t!="function")throw new Error("hmacFn must be a function");let n=Hb(r),i=Hb(r),s=0;const o=()=>{n.fill(1),i.fill(0),s=0},a=(...h)=>t(i,n,...h),c=(h=Hb(0))=>{i=a(WP([0]),h),n=a(),h.length!==0&&(i=a(WP([1]),h),n=a())},l=()=>{if(s++>=1e3)throw new Error("drbg: tried 1000 values");let h=0;const p=[];for(;h<e;){n=a();const m=n.slice();p.push(m),h+=n.length}return _d(...p)};return(h,p)=>{o(),c(h);let m;for(;!(m=p(l()));)c();return o(),m}}const are={bigint:r=>typeof r=="bigint",function:r=>typeof r=="function",boolean:r=>typeof r=="boolean",string:r=>typeof r=="string",stringOrUint8Array:r=>typeof r=="string"||Id(r),isSafeInteger:r=>Number.isSafeInteger(r),array:r=>Array.isArray(r),field:(r,e)=>e.Fp.isValid(r),hash:r=>typeof r=="function"&&Number.isSafeInteger(r.outputLen)};function Td(r,e,t={}){const n=(i,s,o)=>{const a=are[s];if(typeof a!="function")throw new Error("invalid validator function");const c=r[i];if(!(o&&c===void 0)&&!a(c,r))throw new Error("param "+String(i)+" is invalid. Expected "+s+", got "+c)};for(const[i,s]of Object.entries(e))n(i,s,!1);for(const[i,s]of Object.entries(t))n(i,s,!0);return r}function Z2(r){const e=new WeakMap;return(t,...n)=>{const i=e.get(t);if(i!==void 0)return i;const s=r(t,...n);return e.set(t,s),s}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const dr=BigInt(0),Ut=BigInt(1),Dl=BigInt(2),cre=BigInt(3),qb=BigInt(4),GP=BigInt(5),QP=BigInt(8);function xt(r,e){const t=r%e;return t>=dr?t:e+t}function YP(r,e,t){if(e<dr)throw new Error("invalid exponent, negatives unsupported");if(t<=dr)throw new Error("invalid modulus");if(t===Ut)return dr;let n=Ut;for(;e>dr;)e&Ut&&(n=n*r%t),r=r*r%t,e>>=Ut;return n}function Ft(r,e,t){let n=r;for(;e-- >dr;)n*=n,n%=t;return n}function Wb(r,e){if(r===dr)throw new Error("invert: expected non-zero number");if(e<=dr)throw new Error("invert: expected positive modulus, got "+e);let t=xt(r,e),n=e,i=dr,s=Ut;for(;t!==dr;){const a=n/t,c=n%t,l=i-s*a;n=t,t=c,i=s,s=l}if(n!==Ut)throw new Error("invert: does not exist");return xt(i,e)}function lre(r){const e=(r-Ut)/Dl;let t,n,i;for(t=r-Ut,n=0;t%Dl===dr;t/=Dl,n++);for(i=Dl;i<r&&YP(i,e,r)!==r-Ut;i++)if(i>1e3)throw new Error("Cannot find square root: likely non-prime P");if(n===1){const o=(r+Ut)/qb;return function(c,l){const d=c.pow(l,o);if(!c.eql(c.sqr(d),l))throw new Error("Cannot find square root");return d}}const s=(t+Ut)/Dl;return function(a,c){if(a.pow(c,e)===a.neg(a.ONE))throw new Error("Cannot find square root");let l=n,d=a.pow(a.mul(a.ONE,i),t),h=a.pow(c,s),p=a.pow(c,t);for(;!a.eql(p,a.ONE);){if(a.eql(p,a.ZERO))return a.ZERO;let m=1;for(let g=a.sqr(p);m<l&&!a.eql(g,a.ONE);m++)g=a.sqr(g);const f=a.pow(d,Ut<<BigInt(l-m-1));d=a.sqr(f),h=a.mul(h,f),p=a.mul(p,d),l=m}return h}}function ure(r){if(r%qb===cre){const e=(r+Ut)/qb;return function(n,i){const s=n.pow(i,e);if(!n.eql(n.sqr(s),i))throw new Error("Cannot find square root");return s}}if(r%QP===GP){const e=(r-GP)/QP;return function(n,i){const s=n.mul(i,Dl),o=n.pow(s,e),a=n.mul(i,o),c=n.mul(n.mul(a,Dl),o),l=n.mul(a,n.sub(c,n.ONE));if(!n.eql(n.sqr(l),i))throw new Error("Cannot find square root");return l}}return lre(r)}const dre=(r,e)=>(xt(r,e)&Ut)===Ut,hre=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function fre(r){const e={ORDER:"bigint",MASK:"bigint",BYTES:"isSafeInteger",BITS:"isSafeInteger"},t=hre.reduce((n,i)=>(n[i]="function",n),e);return Td(r,t)}function pre(r,e,t){if(t<dr)throw new Error("invalid exponent, negatives unsupported");if(t===dr)return r.ONE;if(t===Ut)return e;let n=r.ONE,i=e;for(;t>dr;)t&Ut&&(n=r.mul(n,i)),i=r.sqr(i),t>>=Ut;return n}function gre(r,e){const t=new Array(e.length),n=e.reduce((s,o,a)=>r.is0(o)?s:(t[a]=s,r.mul(s,o)),r.ONE),i=r.inv(n);return e.reduceRight((s,o,a)=>r.is0(o)?s:(t[a]=r.mul(s,t[a]),r.mul(s,o)),i),t}function JP(r,e){const t=e!==void 0?e:r.toString(2).length,n=Math.ceil(t/8);return{nBitLength:t,nByteLength:n}}function ey(r,e,t=!1,n={}){if(r<=dr)throw new Error("invalid field: expected ORDER > 0, got "+r);const{nBitLength:i,nByteLength:s}=JP(r,e);if(s>2048)throw new Error("invalid field: expected ORDER of <= 2048 bytes");let o;const a=Object.freeze({ORDER:r,isLE:t,BITS:i,BYTES:s,MASK:X2(i),ZERO:dr,ONE:Ut,create:c=>xt(c,r),isValid:c=>{if(typeof c!="bigint")throw new Error("invalid field element: expected bigint, got "+typeof c);return dr<=c&&c<r},is0:c=>c===dr,isOdd:c=>(c&Ut)===Ut,neg:c=>xt(-c,r),eql:(c,l)=>c===l,sqr:c=>xt(c*c,r),add:(c,l)=>xt(c+l,r),sub:(c,l)=>xt(c-l,r),mul:(c,l)=>xt(c*l,r),pow:(c,l)=>pre(a,c,l),div:(c,l)=>xt(c*Wb(l,r),r),sqrN:c=>c*c,addN:(c,l)=>c+l,subN:(c,l)=>c-l,mulN:(c,l)=>c*l,inv:c=>Wb(c,r),sqrt:n.sqrt||(c=>(o||(o=ure(r)),o(a,c))),invertBatch:c=>gre(a,c),cmov:(c,l,d)=>d?l:c,toBytes:c=>t?v1(c,s):b1(c,s),fromBytes:c=>{if(c.length!==s)throw new Error("Field.fromBytes: expected "+s+" bytes, got "+c.length);return t?Pl(c):Tl(c)}});return Object.freeze(a)}function XP(r){if(typeof r!="bigint")throw new Error("field order must be bigint");const e=r.toString(2).length;return Math.ceil(e/8)}function ZP(r){const e=XP(r);return e+Math.ceil(e/2)}function yre(r,e,t=!1){const n=r.length,i=XP(e),s=ZP(e);if(n<16||n<s||n>1024)throw new Error("expected "+s+"-1024 bytes of input, got "+n);const o=t?Pl(r):Tl(r),a=xt(o,e-Ut)+Ut;return t?v1(a,i):b1(a,i)}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const eD=BigInt(0),Gb=BigInt(1);function Qb(r,e){const t=e.negate();return r?t:e}function tD(r,e){if(!Number.isSafeInteger(r)||r<=0||r>e)throw new Error("invalid window size, expected [1.."+e+"], got W="+r)}function Yb(r,e){tD(r,e);const t=Math.ceil(e/r)+1,n=2**(r-1),i=2**r,s=X2(r),o=BigInt(r);return{windows:t,windowSize:n,mask:s,maxNumber:i,shiftBy:o}}function rD(r,e,t){const{windowSize:n,mask:i,maxNumber:s,shiftBy:o}=t;let a=Number(r&i),c=r>>o;a>n&&(a-=s,c+=Gb);const l=e*n,d=l+Math.abs(a)-1,h=a===0,p=a<0,m=e%2!==0;return{nextN:c,offset:d,isZero:h,isNeg:p,isNegF:m,offsetF:l}}function mre(r,e){if(!Array.isArray(r))throw new Error("array expected");r.forEach((t,n)=>{if(!(t instanceof e))throw new Error("invalid point at index "+n)})}function wre(r,e){if(!Array.isArray(r))throw new Error("array of scalars expected");r.forEach((t,n)=>{if(!e.isValid(t))throw new Error("invalid scalar at index "+n)})}const Jb=new WeakMap,nD=new WeakMap;function Xb(r){return nD.get(r)||1}function iD(r,e){return{constTimeNegate:Qb,hasPrecomputes(t){return Xb(t)!==1},unsafeLadder(t,n,i=r.ZERO){let s=t;for(;n>eD;)n&Gb&&(i=i.add(s)),s=s.double(),n>>=Gb;return i},precomputeWindow(t,n){const{windows:i,windowSize:s}=Yb(n,e),o=[];let a=t,c=a;for(let l=0;l<i;l++){c=a,o.push(c);for(let d=1;d<s;d++)c=c.add(a),o.push(c);a=c.double()}return o},wNAF(t,n,i){let s=r.ZERO,o=r.BASE;const a=Yb(t,e);for(let c=0;c<a.windows;c++){const{nextN:l,offset:d,isZero:h,isNeg:p,isNegF:m,offsetF:f}=rD(i,c,a);i=l,h?o=o.add(Qb(m,n[f])):s=s.add(Qb(p,n[d]))}return{p:s,f:o}},wNAFUnsafe(t,n,i,s=r.ZERO){const o=Yb(t,e);for(let a=0;a<o.windows&&i!==eD;a++){const{nextN:c,offset:l,isZero:d,isNeg:h}=rD(i,a,o);if(i=c,!d){const p=n[l];s=s.add(h?p.negate():p)}}return s},getPrecomputes(t,n,i){let s=Jb.get(n);return s||(s=this.precomputeWindow(n,t),t!==1&&Jb.set(n,i(s))),s},wNAFCached(t,n,i){const s=Xb(t);return this.wNAF(s,this.getPrecomputes(s,t,i),n)},wNAFCachedUnsafe(t,n,i,s){const o=Xb(t);return o===1?this.unsafeLadder(t,n,s):this.wNAFUnsafe(o,this.getPrecomputes(o,t,i),n,s)},setWindowSize(t,n){tD(n,e),nD.set(t,n),Jb.delete(t)}}}function sD(r,e,t,n){if(mre(t,r),wre(n,e),t.length!==n.length)throw new Error("arrays of points and scalars must have equal length");const i=r.ZERO,s=sre(BigInt(t.length)),o=s>12?s-3:s>4?s-2:s?2:1,a=X2(o),c=new Array(Number(a)+1).fill(i),l=Math.floor((e.BITS-1)/o)*o;let d=i;for(let h=l;h>=0;h-=o){c.fill(i);for(let m=0;m<n.length;m++){const f=n[m],g=Number(f>>BigInt(h)&a);c[g]=c[g].add(t[m])}let p=i;for(let m=c.length-1,f=i;m>0;m--)f=f.add(c[m]),p=p.add(f);if(d=d.add(p),h!==0)for(let m=0;m<o;m++)d=d.double()}return d}function Zb(r){return fre(r.Fp),Td(r,{n:"bigint",h:"bigint",Gx:"field",Gy:"field"},{nBitLength:"isSafeInteger",nByteLength:"isSafeInteger"}),Object.freeze({...JP(r.n,r.nBitLength),...r,p:r.Fp.ORDER})}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const Ns=BigInt(0),un=BigInt(1),oD=BigInt(2),bre=BigInt(8),vre={zip215:!0};function Ere(r){const e=Zb(r);return Td(r,{hash:"function",a:"bigint",d:"bigint",randomBytes:"function"},{adjustScalarBytes:"function",domain:"function",uvRatio:"function",mapToCurve:"function"}),Object.freeze({...e})}function Sre(r){const e=Ere(r),{Fp:t,n,prehash:i,hash:s,randomBytes:o,nByteLength:a,h:c}=e,l=oD<<BigInt(a*8)-un,d=t.create,h=ey(e.n,e.nBitLength),p=e.uvRatio||((j,O)=>{try{return{isValid:!0,value:t.sqrt(j*t.inv(O))}}catch{return{isValid:!1,value:Ns}}}),m=e.adjustScalarBytes||(j=>j),f=e.domain||((j,O,U)=>{if(Ya("phflag",U),O.length||U)throw new Error("Contexts/pre-hash are not supported");return j});function g(j,O,U=!1){const W=U?un:Ns;Zn("coordinate "+j,O,W,l)}function w(j){if(!(j instanceof v))throw new Error("ExtendedPoint expected")}const y=Z2((j,O)=>{const{ex:U,ey:W,ez:Y}=j,H=j.is0();O==null&&(O=H?bre:t.inv(Y));const oe=d(U*O),ye=d(W*O),de=d(Y*O);if(H)return{x:Ns,y:un};if(de!==un)throw new Error("invZ was invalid");return{x:oe,y:ye}}),b=Z2(j=>{const{a:O,d:U}=e;if(j.is0())throw new Error("bad point: ZERO");const{ex:W,ey:Y,ez:H,et:oe}=j,ye=d(W*W),de=d(Y*Y),le=d(H*H),$e=d(le*le),Ne=d(ye*O),Ie=d(le*d(Ne+de)),tt=d($e+d(U*d(ye*de)));if(Ie!==tt)throw new Error("bad point: equation left != right (1)");const bt=d(W*Y),vt=d(H*oe);if(bt!==vt)throw new Error("bad point: equation left != right (2)");return!0});class v{constructor(O,U,W,Y){g("x",O),g("y",U),g("z",W,!0),g("t",Y),this.ex=O,this.ey=U,this.ez=W,this.et=Y,Object.freeze(this)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}static fromAffine(O){if(O instanceof v)throw new Error("extended point not allowed");const{x:U,y:W}=O||{};return g("x",U),g("y",W),new v(U,W,un,d(U*W))}static normalizeZ(O){const U=t.invertBatch(O.map(W=>W.ez));return O.map((W,Y)=>W.toAffine(U[Y])).map(v.fromAffine)}static msm(O,U){return sD(v,h,O,U)}_setWindowSize(O){k.setWindowSize(this,O)}assertValidity(){b(this)}equals(O){w(O);const{ex:U,ey:W,ez:Y}=this,{ex:H,ey:oe,ez:ye}=O,de=d(U*ye),le=d(H*Y),$e=d(W*ye),Ne=d(oe*Y);return de===le&&$e===Ne}is0(){return this.equals(v.ZERO)}negate(){return new v(d(-this.ex),this.ey,this.ez,d(-this.et))}double(){const{a:O}=e,{ex:U,ey:W,ez:Y}=this,H=d(U*U),oe=d(W*W),ye=d(oD*d(Y*Y)),de=d(O*H),le=U+W,$e=d(d(le*le)-H-oe),Ne=de+oe,Ie=Ne-ye,tt=de-oe,bt=d($e*Ie),vt=d(Ne*tt),kt=d($e*tt),Yt=d(Ie*Ne);return new v(bt,vt,Yt,kt)}add(O){w(O);const{a:U,d:W}=e,{ex:Y,ey:H,ez:oe,et:ye}=this,{ex:de,ey:le,ez:$e,et:Ne}=O,Ie=d(Y*de),tt=d(H*le),bt=d(ye*W*Ne),vt=d(oe*$e),kt=d((Y+H)*(de+le)-Ie-tt),Yt=vt-bt,wn=vt+bt,Au=d(tt-U*Ie),Vc=d(kt*Yt),Xh=d(wn*Au),Zh=d(kt*Au),Cu=d(Yt*wn);return new v(Vc,Xh,Cu,Zh)}subtract(O){return this.add(O.negate())}wNAF(O){return k.wNAFCached(this,O,v.normalizeZ)}multiply(O){const U=O;Zn("scalar",U,un,n);const{p:W,f:Y}=this.wNAF(U);return v.normalizeZ([W,Y])[0]}multiplyUnsafe(O,U=v.ZERO){const W=O;return Zn("scalar",W,Ns,n),W===Ns?C:this.is0()||W===un?this:k.wNAFCachedUnsafe(this,W,v.normalizeZ,U)}isSmallOrder(){return this.multiplyUnsafe(c).is0()}isTorsionFree(){return k.unsafeLadder(this,n).is0()}toAffine(O){return y(this,O)}clearCofactor(){const{h:O}=e;return O===un?this:this.multiplyUnsafe(O)}static fromHex(O,U=!1){const{d:W,a:Y}=e,H=t.BYTES;O=Ht("pointHex",O,H),Ya("zip215",U);const oe=O.slice(),ye=O[H-1];oe[H-1]=ye&-129;const de=Pl(oe),le=U?l:t.ORDER;Zn("pointHex.y",de,Ns,le);const $e=d(de*de),Ne=d($e-un),Ie=d(W*$e-Y);let{isValid:tt,value:bt}=p(Ne,Ie);if(!tt)throw new Error("Point.fromHex: invalid y coordinate");const vt=(bt&un)===un,kt=(ye&128)!==0;if(!U&&bt===Ns&&kt)throw new Error("Point.fromHex: x=0 and x_0=1");return kt!==vt&&(bt=d(-bt)),v.fromAffine({x:bt,y:de})}static fromPrivateKey(O){const{scalar:U}=T(O);return E.multiply(U)}toRawBytes(){const{x:O,y:U}=this.toAffine(),W=v1(U,t.BYTES);return W[W.length-1]|=O&un?128:0,W}toHex(){return kd(this.toRawBytes())}}v.BASE=new v(e.Gx,e.Gy,un,d(e.Gx*e.Gy)),v.ZERO=new v(Ns,un,un,Ns);const{BASE:E,ZERO:C}=v,k=iD(v,a*8);function x(j){return xt(j,n)}function I(j){return x(Pl(j))}function T(j){const O=t.BYTES;j=Ht("private key",j,O);const U=Ht("hashed private key",s(j),2*O),W=m(U.slice(0,O)),Y=U.slice(O,2*O),H=I(W);return{head:W,prefix:Y,scalar:H}}function L(j){const{head:O,prefix:U,scalar:W}=T(j),Y=E.multiply(W),H=Y.toRawBytes();return{head:O,prefix:U,scalar:W,point:Y,pointBytes:H}}function z(j){return L(j).pointBytes}function B(j=new Uint8Array,...O){const U=_d(...O);return I(s(f(U,Ht("context",j),!!i)))}function G(j,O,U={}){j=Ht("message",j),i&&(j=i(j));const{prefix:W,scalar:Y,pointBytes:H}=L(O),oe=B(U.context,W,j),ye=E.multiply(oe).toRawBytes(),de=B(U.context,ye,H,j),le=x(oe+de*Y);Zn("signature.s",le,Ns,n);const $e=_d(ye,v1(le,t.BYTES));return Ht("result",$e,t.BYTES*2)}const K=vre;function q(j,O,U,W=K){const{context:Y,zip215:H}=W,oe=t.BYTES;j=Ht("signature",j,2*oe),O=Ht("message",O),U=Ht("publicKey",U,oe),H!==void 0&&Ya("zip215",H),i&&(O=i(O));const ye=Pl(j.slice(oe,2*oe));let de,le,$e;try{de=v.fromHex(U,H),le=v.fromHex(j.slice(0,oe),H),$e=E.multiplyUnsafe(ye)}catch{return!1}if(!H&&de.isSmallOrder())return!1;const Ne=B(Y,le.toRawBytes(),de.toRawBytes(),O);return le.add(de.multiplyUnsafe(Ne)).subtract($e).clearCofactor().equals(v.ZERO)}return E._setWindowSize(8),{CURVE:e,getPublicKey:z,sign:G,verify:q,ExtendedPoint:v,utils:{getExtendedPublicKey:L,randomPrivateKey:()=>o(t.BYTES),precompute(j=8,O=v.BASE){return O._setWindowSize(j),O.multiply(BigInt(3)),O}}}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const Pd=BigInt(0),ev=BigInt(1);function xre(r){return Td(r,{a:"bigint"},{montgomeryBits:"isSafeInteger",nByteLength:"isSafeInteger",adjustScalarBytes:"function",domain:"function",powPminus2:"function",Gu:"bigint"}),Object.freeze({...r})}function Are(r){const e=xre(r),{P:t}=e,n=b=>xt(b,t),i=e.montgomeryBits,s=Math.ceil(i/8),o=e.nByteLength,a=e.adjustScalarBytes||(b=>b),c=e.powPminus2||(b=>YP(b,t-BigInt(2),t));function l(b,v,E){const C=n(b*(v-E));return v=n(v-C),E=n(E+C),[v,E]}const d=(e.a-BigInt(2))/BigInt(4);function h(b,v){Zn("u",b,Pd,t),Zn("scalar",v,Pd,t);const E=v,C=b;let k=ev,x=Pd,I=b,T=ev,L=Pd,z;for(let G=BigInt(i-1);G>=Pd;G--){const K=E>>G&ev;L^=K,z=l(L,k,I),k=z[0],I=z[1],z=l(L,x,T),x=z[0],T=z[1],L=K;const q=k+x,Q=n(q*q),j=k-x,O=n(j*j),U=Q-O,W=I+T,Y=I-T,H=n(Y*q),oe=n(W*j),ye=H+oe,de=H-oe;I=n(ye*ye),T=n(C*n(de*de)),k=n(Q*O),x=n(U*(Q+n(d*U)))}z=l(L,k,I),k=z[0],I=z[1],z=l(L,x,T),x=z[0],T=z[1];const B=c(x);return n(k*B)}function p(b){return v1(n(b),s)}function m(b){const v=Ht("u coordinate",b,s);return o===32&&(v[31]&=127),Pl(v)}function f(b){const v=Ht("scalar",b),E=v.length;if(E!==s&&E!==o){let C=""+s+" or "+o;throw new Error("invalid scalar, expected "+C+" bytes, got "+E)}return Pl(a(v))}function g(b,v){const E=m(v),C=f(b),k=h(E,C);if(k===Pd)throw new Error("invalid private or public key received");return p(k)}const w=p(e.Gu);function y(b){return g(b,w)}return{scalarMult:g,scalarMultBase:y,getSharedSecret:(b,v)=>g(b,v),getPublicKey:b=>y(b),utils:{randomPrivateKey:()=>e.randomBytes(e.nByteLength)},GuBytes:w}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const E1=BigInt("57896044618658097711785492504343953926634992332820282019728792003956564819949"),aD=BigInt("19681161376707505956807079304988542015446066515923890162744021073123829784752");BigInt(0);const Cre=BigInt(1),cD=BigInt(2),Ire=BigInt(3),kre=BigInt(5),_re=BigInt(8);function lD(r){const e=BigInt(10),t=BigInt(20),n=BigInt(40),i=BigInt(80),s=E1,a=r*r%s*r%s,c=Ft(a,cD,s)*a%s,l=Ft(c,Cre,s)*r%s,d=Ft(l,kre,s)*l%s,h=Ft(d,e,s)*d%s,p=Ft(h,t,s)*h%s,m=Ft(p,n,s)*p%s,f=Ft(m,i,s)*m%s,g=Ft(f,i,s)*m%s,w=Ft(g,e,s)*d%s;return{pow_p_5_8:Ft(w,cD,s)*r%s,b2:a}}function uD(r){return r[0]&=248,r[31]&=127,r[31]|=64,r}function Tre(r,e){const t=E1,n=xt(e*e*e,t),i=xt(n*n*e,t),s=lD(r*i).pow_p_5_8;let o=xt(r*n*s,t);const a=xt(e*o*o,t),c=o,l=xt(o*aD,t),d=a===r,h=a===xt(-r,t),p=a===xt(-r*aD,t);return d&&(o=c),(h||p)&&(o=l),dre(o,t)&&(o=xt(-o,t)),{isValid:d||h,value:o}}const dD=ey(E1,void 0,!0),Pre={a:dD.create(BigInt(-1)),d:BigInt("37095705934669439343138083508754565189542113879843219016388785533085940283555"),Fp:dD,n:BigInt("7237005577332262213973186563042994240857116359379907606001950938285454250989"),h:_re,Gx:BigInt("15112221349535400772501151409588531511454012693041857206046113283949847762202"),Gy:BigInt("46316835694926478169428394003475163141307993866256225615783033603165251855960"),hash:nre,randomBytes:Bb,adjustScalarBytes:uD,uvRatio:Tre},ty=Sre(Pre),ry=Are({P:E1,a:BigInt(486662),montgomeryBits:255,nByteLength:32,Gu:BigInt(9),powPminus2:r=>{const e=E1,{pow_p_5_8:t,b2:n}=lD(r);return xt(Ft(t,Ire,e)*n,e)},adjustScalarBytes:uD,randomBytes:Bb}),S1=32,Io=64,tv=32;function Dre(){const r=ty.utils.randomPrivateKey(),e=ty.getPublicKey(r);return{privateKey:Mre(r,e),publicKey:e}}function $re(r,e){const t=r.subarray(0,tv);return ty.sign(e instanceof Uint8Array?e:e.subarray(),t)}function Nre(r,e,t){return ty.verify(e,t instanceof Uint8Array?t:t.subarray(),r)}function Mre(r,e){const t=new Uint8Array(Io);for(let n=0;n<tv;n++)t[n]=r[n],t[tv+n]=e[n];return t}class hD{constructor(e){u(this,"type","Ed25519");u(this,"raw");this.raw=x1(e,S1)}toMultihash(){return $b.digest(ki(this))}toCID(){return V2.createV1(114,this.toMultihash())}toString(){return Ii.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:qe(this.raw,e.raw)}verify(e,t){return Nre(this.raw,t,e)}}class rv{constructor(e,t){u(this,"type","Ed25519");u(this,"raw");u(this,"publicKey");this.raw=x1(e,Io),this.publicKey=new hD(t)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:qe(this.raw,e.raw)}sign(e){return $re(this.raw,e)}}function fD(r){if(r.length>Io){r=x1(r,Io+S1);const n=r.subarray(0,Io),i=r.subarray(Io,r.length);return new rv(n,i)}r=x1(r,Io);const e=r.subarray(0,Io),t=r.subarray(S1);return new rv(e,t)}function nv(r){return r=x1(r,S1),new hD(r)}async function Ore(){const{privateKey:r,publicKey:e}=Dre();return new rv(r,e)}function x1(r,e){if(r=Uint8Array.from(r??[]),r.length!==e)throw new Z(`Key must be a Uint8Array of length ${e}, got ${r.length}`);return r}const Rre=Math.pow(2,7),Lre=Math.pow(2,14),Bre=Math.pow(2,21),iv=Math.pow(2,28),sv=Math.pow(2,35),ov=Math.pow(2,42),av=Math.pow(2,49),lt=128,Lr=127;function gt(r){if(r<Rre)return 1;if(r<Lre)return 2;if(r<Bre)return 3;if(r<iv)return 4;if(r<sv)return 5;if(r<ov)return 6;if(r<av)return 7;if(Number.MAX_SAFE_INTEGER!=null&&r>Number.MAX_SAFE_INTEGER)throw new RangeError("Could not encode varint");return 8}function pD(r,e,t=0){switch(gt(r)){case 8:e[t++]=r&255|lt,r/=128;case 7:e[t++]=r&255|lt,r/=128;case 6:e[t++]=r&255|lt,r/=128;case 5:e[t++]=r&255|lt,r/=128;case 4:e[t++]=r&255|lt,r>>>=7;case 3:e[t++]=r&255|lt,r>>>=7;case 2:e[t++]=r&255|lt,r>>>=7;case 1:{e[t++]=r&255,r>>>=7;break}default:throw new Error("unreachable")}return e}function Ure(r,e,t=0){switch(gt(r)){case 8:e.set(t++,r&255|lt),r/=128;case 7:e.set(t++,r&255|lt),r/=128;case 6:e.set(t++,r&255|lt),r/=128;case 5:e.set(t++,r&255|lt),r/=128;case 4:e.set(t++,r&255|lt),r>>>=7;case 3:e.set(t++,r&255|lt),r>>>=7;case 2:e.set(t++,r&255|lt),r>>>=7;case 1:{e.set(t++,r&255),r>>>=7;break}default:throw new Error("unreachable")}return e}function gD(r,e){let t=r[e],n=0;if(n+=t&Lr,t<lt||(t=r[e+1],n+=(t&Lr)<<7,t<lt)||(t=r[e+2],n+=(t&Lr)<<14,t<lt)||(t=r[e+3],n+=(t&Lr)<<21,t<lt)||(t=r[e+4],n+=(t&Lr)*iv,t<lt)||(t=r[e+5],n+=(t&Lr)*sv,t<lt)||(t=r[e+6],n+=(t&Lr)*ov,t<lt)||(t=r[e+7],n+=(t&Lr)*av,t<lt))return n;throw new RangeError("Could not decode varint")}function Fre(r,e){let t=r.get(e),n=0;if(n+=t&Lr,t<lt||(t=r.get(e+1),n+=(t&Lr)<<7,t<lt)||(t=r.get(e+2),n+=(t&Lr)<<14,t<lt)||(t=r.get(e+3),n+=(t&Lr)<<21,t<lt)||(t=r.get(e+4),n+=(t&Lr)*iv,t<lt)||(t=r.get(e+5),n+=(t&Lr)*sv,t<lt)||(t=r.get(e+6),n+=(t&Lr)*ov,t<lt)||(t=r.get(e+7),n+=(t&Lr)*av,t<lt))return n;throw new RangeError("Could not decode varint")}function Er(r,e,t=0){return e==null&&(e=Cn(gt(r))),e instanceof Uint8Array?pD(r,e,t):Ure(r,e,t)}function Zi(r,e=0){return r instanceof Uint8Array?gD(r,e):Fre(r,e)}const cv=new Float32Array([-0]),Ja=new Uint8Array(cv.buffer);function zre(r,e,t){cv[0]=r,e[t]=Ja[0],e[t+1]=Ja[1],e[t+2]=Ja[2],e[t+3]=Ja[3]}function Vre(r,e){return Ja[0]=r[e],Ja[1]=r[e+1],Ja[2]=r[e+2],Ja[3]=r[e+3],cv[0]}const lv=new Float64Array([-0]),Br=new Uint8Array(lv.buffer);function Kre(r,e,t){lv[0]=r,e[t]=Br[0],e[t+1]=Br[1],e[t+2]=Br[2],e[t+3]=Br[3],e[t+4]=Br[4],e[t+5]=Br[5],e[t+6]=Br[6],e[t+7]=Br[7]}function jre(r,e){return Br[0]=r[e],Br[1]=r[e+1],Br[2]=r[e+2],Br[3]=r[e+3],Br[4]=r[e+4],Br[5]=r[e+5],Br[6]=r[e+6],Br[7]=r[e+7],lv[0]}const Hre=BigInt(Number.MAX_SAFE_INTEGER),qre=BigInt(Number.MIN_SAFE_INTEGER);class Ur{constructor(e,t){u(this,"lo");u(this,"hi");this.lo=e|0,this.hi=t|0}toNumber(e=!1){if(!e&&this.hi>>>31>0){const t=~this.lo+1>>>0;let n=~this.hi>>>0;return t===0&&(n=n+1>>>0),-(t+n*4294967296)}return this.lo+this.hi*4294967296}toBigInt(e=!1){if(e)return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n);if(this.hi>>>31){const t=~this.lo+1>>>0;let n=~this.hi>>>0;return t===0&&(n=n+1>>>0),-(BigInt(t)+(BigInt(n)<<32n))}return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n)}toString(e=!1){return this.toBigInt(e).toString()}zzEncode(){const e=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^e)>>>0,this.lo=(this.lo<<1^e)>>>0,this}zzDecode(){const e=-(this.lo&1);return this.lo=((this.lo>>>1|this.hi<<31)^e)>>>0,this.hi=(this.hi>>>1^e)>>>0,this}length(){const e=this.lo,t=(this.lo>>>28|this.hi<<4)>>>0,n=this.hi>>>24;return n===0?t===0?e<16384?e<128?1:2:e<2097152?3:4:t<16384?t<128?5:6:t<2097152?7:8:n<128?9:10}static fromBigInt(e){if(e===0n)return $l;if(e<Hre&&e>qre)return this.fromNumber(Number(e));const t=e<0n;t&&(e=-e);let n=e>>32n,i=e-(n<<32n);return t&&(n=~n|0n,i=~i|0n,++i>yD&&(i=0n,++n>yD&&(n=0n))),new Ur(Number(i),Number(n))}static fromNumber(e){if(e===0)return $l;const t=e<0;t&&(e=-e);let n=e>>>0,i=(e-n)/4294967296>>>0;return t&&(i=~i>>>0,n=~n>>>0,++n>4294967295&&(n=0,++i>4294967295&&(i=0))),new Ur(n,i)}static from(e){return typeof e=="number"?Ur.fromNumber(e):typeof e=="bigint"?Ur.fromBigInt(e):typeof e=="string"?Ur.fromBigInt(BigInt(e)):e.low!=null||e.high!=null?new Ur(e.low>>>0,e.high>>>0):$l}}const $l=new Ur(0,0);$l.toBigInt=function(){return 0n},$l.zzEncode=$l.zzDecode=function(){return this},$l.length=function(){return 1};const yD=4294967296n;function Wre(r){let e=0,t=0;for(let n=0;n<r.length;++n)t=r.charCodeAt(n),t<128?e+=1:t<2048?e+=2:(t&64512)===55296&&(r.charCodeAt(n+1)&64512)===56320?(++n,e+=4):e+=3;return e}function Gre(r,e,t){if(t-e<1)return"";let i;const s=[];let o=0,a;for(;e<t;)a=r[e++],a<128?s[o++]=a:a>191&&a<224?s[o++]=(a&31)<<6|r[e++]&63:a>239&&a<365?(a=((a&7)<<18|(r[e++]&63)<<12|(r[e++]&63)<<6|r[e++]&63)-65536,s[o++]=55296+(a>>10),s[o++]=56320+(a&1023)):s[o++]=(a&15)<<12|(r[e++]&63)<<6|r[e++]&63,o>8191&&((i??(i=[])).push(String.fromCharCode.apply(String,s)),o=0);return i!=null?(o>0&&i.push(String.fromCharCode.apply(String,s.slice(0,o))),i.join("")):String.fromCharCode.apply(String,s.slice(0,o))}function mD(r,e,t){const n=t;let i,s;for(let o=0;o<r.length;++o)i=r.charCodeAt(o),i<128?e[t++]=i:i<2048?(e[t++]=i>>6|192,e[t++]=i&63|128):(i&64512)===55296&&((s=r.charCodeAt(o+1))&64512)===56320?(i=65536+((i&1023)<<10)+(s&1023),++o,e[t++]=i>>18|240,e[t++]=i>>12&63|128,e[t++]=i>>6&63|128,e[t++]=i&63|128):(e[t++]=i>>12|224,e[t++]=i>>6&63|128,e[t++]=i&63|128);return t-n}function es(r,e){return RangeError(`index out of range: ${r.pos} + ${e??1} > ${r.len}`)}function ny(r,e){return(r[e-4]|r[e-3]<<8|r[e-2]<<16|r[e-1]<<24)>>>0}class Qre{constructor(e){u(this,"buf");u(this,"pos");u(this,"len");u(this,"_slice",Uint8Array.prototype.subarray);this.buf=e,this.pos=0,this.len=e.length}uint32(){let e=4294967295;if(e=(this.buf[this.pos]&127)>>>0,this.buf[this.pos++]<128||(e=(e|(this.buf[this.pos]&127)<<7)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<14)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<21)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&15)<<28)>>>0,this.buf[this.pos++]<128))return e;if((this.pos+=5)>this.len)throw this.pos=this.len,es(this,10);return e}int32(){return this.uint32()|0}sint32(){const e=this.uint32();return e>>>1^-(e&1)|0}bool(){return this.uint32()!==0}fixed32(){if(this.pos+4>this.len)throw es(this,4);return ny(this.buf,this.pos+=4)}sfixed32(){if(this.pos+4>this.len)throw es(this,4);return ny(this.buf,this.pos+=4)|0}float(){if(this.pos+4>this.len)throw es(this,4);const e=Vre(this.buf,this.pos);return this.pos+=4,e}double(){if(this.pos+8>this.len)throw es(this,4);const e=jre(this.buf,this.pos);return this.pos+=8,e}bytes(){const e=this.uint32(),t=this.pos,n=this.pos+e;if(n>this.len)throw es(this,e);return this.pos+=e,t===n?new Uint8Array(0):this.buf.subarray(t,n)}string(){const e=this.bytes();return Gre(e,0,e.length)}skip(e){if(typeof e=="number"){if(this.pos+e>this.len)throw es(this,e);this.pos+=e}else do if(this.pos>=this.len)throw es(this);while(this.buf[this.pos++]&128);return this}skipType(e){switch(e){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;(e=this.uint32()&7)!==4;)this.skipType(e);break;case 5:this.skip(4);break;default:throw Error(`invalid wire type ${e} at offset ${this.pos}`)}return this}readLongVarint(){const e=new Ur(0,0);let t=0;if(this.len-this.pos>4){for(;t<4;++t)if(e.lo=(e.lo|(this.buf[this.pos]&127)<<t*7)>>>0,this.buf[this.pos++]<128)return e;if(e.lo=(e.lo|(this.buf[this.pos]&127)<<28)>>>0,e.hi=(e.hi|(this.buf[this.pos]&127)>>4)>>>0,this.buf[this.pos++]<128)return e;t=0}else{for(;t<3;++t){if(this.pos>=this.len)throw es(this);if(e.lo=(e.lo|(this.buf[this.pos]&127)<<t*7)>>>0,this.buf[this.pos++]<128)return e}return e.lo=(e.lo|(this.buf[this.pos++]&127)<<t*7)>>>0,e}if(this.len-this.pos>4){for(;t<5;++t)if(e.hi=(e.hi|(this.buf[this.pos]&127)<<t*7+3)>>>0,this.buf[this.pos++]<128)return e}else for(;t<5;++t){if(this.pos>=this.len)throw es(this);if(e.hi=(e.hi|(this.buf[this.pos]&127)<<t*7+3)>>>0,this.buf[this.pos++]<128)return e}throw Error("invalid varint encoding")}readFixed64(){if(this.pos+8>this.len)throw es(this,8);const e=ny(this.buf,this.pos+=4),t=ny(this.buf,this.pos+=4);return new Ur(e,t)}int64(){return this.readLongVarint().toBigInt()}int64Number(){return this.readLongVarint().toNumber()}int64String(){return this.readLongVarint().toString()}uint64(){return this.readLongVarint().toBigInt(!0)}uint64Number(){const e=gD(this.buf,this.pos);return this.pos+=gt(e),e}uint64String(){return this.readLongVarint().toString(!0)}sint64(){return this.readLongVarint().zzDecode().toBigInt()}sint64Number(){return this.readLongVarint().zzDecode().toNumber()}sint64String(){return this.readLongVarint().zzDecode().toString()}fixed64(){return this.readFixed64().toBigInt()}fixed64Number(){return this.readFixed64().toNumber()}fixed64String(){return this.readFixed64().toString()}sfixed64(){return this.readFixed64().toBigInt()}sfixed64Number(){return this.readFixed64().toNumber()}sfixed64String(){return this.readFixed64().toString()}}function Yre(r){return new Qre(r instanceof Uint8Array?r:r.subarray())}function Te(r,e,t){const n=Yre(r);return e.decode(n,void 0,t)}function Jre(r){let n,i=8192;return function(o){if(o<1||o>4096)return Cn(o);i+o>8192&&(n=Cn(8192),i=0);const a=n.subarray(i,i+=o);return i&7&&(i=(i|7)+1),a}}class A1{constructor(e,t,n){u(this,"fn");u(this,"len");u(this,"next");u(this,"val");this.fn=e,this.len=t,this.next=void 0,this.val=n}}function uv(){}class Xre{constructor(e){u(this,"head");u(this,"tail");u(this,"len");u(this,"next");this.head=e.head,this.tail=e.tail,this.len=e.len,this.next=e.states}}const Zre=Jre();function ene(r){return globalThis.Buffer!=null?Cn(r):Zre(r)}class dv{constructor(){u(this,"len");u(this,"head");u(this,"tail");u(this,"states");this.len=0,this.head=new A1(uv,0,0),this.tail=this.head,this.states=null}_push(e,t,n){return this.tail=this.tail.next=new A1(e,t,n),this.len+=t,this}uint32(e){return this.len+=(this.tail=this.tail.next=new rne((e=e>>>0)<128?1:e<16384?2:e<2097152?3:e<268435456?4:5,e)).len,this}int32(e){return e<0?this._push(iy,10,Ur.fromNumber(e)):this.uint32(e)}sint32(e){return this.uint32((e<<1^e>>31)>>>0)}uint64(e){const t=Ur.fromBigInt(e);return this._push(iy,t.length(),t)}uint64Number(e){return this._push(pD,gt(e),e)}uint64String(e){return this.uint64(BigInt(e))}int64(e){return this.uint64(e)}int64Number(e){return this.uint64Number(e)}int64String(e){return this.uint64String(e)}sint64(e){const t=Ur.fromBigInt(e).zzEncode();return this._push(iy,t.length(),t)}sint64Number(e){const t=Ur.fromNumber(e).zzEncode();return this._push(iy,t.length(),t)}sint64String(e){return this.sint64(BigInt(e))}bool(e){return this._push(hv,1,e?1:0)}fixed32(e){return this._push(C1,4,e>>>0)}sfixed32(e){return this.fixed32(e)}fixed64(e){const t=Ur.fromBigInt(e);return this._push(C1,4,t.lo)._push(C1,4,t.hi)}fixed64Number(e){const t=Ur.fromNumber(e);return this._push(C1,4,t.lo)._push(C1,4,t.hi)}fixed64String(e){return this.fixed64(BigInt(e))}sfixed64(e){return this.fixed64(e)}sfixed64Number(e){return this.fixed64Number(e)}sfixed64String(e){return this.fixed64String(e)}float(e){return this._push(zre,4,e)}double(e){return this._push(Kre,8,e)}bytes(e){const t=e.length>>>0;return t===0?this._push(hv,1,0):this.uint32(t)._push(nne,t,e)}string(e){const t=Wre(e);return t!==0?this.uint32(t)._push(mD,t,e):this._push(hv,1,0)}fork(){return this.states=new Xre(this),this.head=this.tail=new A1(uv,0,0),this.len=0,this}reset(){return this.states!=null?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new A1(uv,0,0),this.len=0),this}ldelim(){const e=this.head,t=this.tail,n=this.len;return this.reset().uint32(n),n!==0&&(this.tail.next=e.next,this.tail=t,this.len+=n),this}finish(){let e=this.head.next;const t=ene(this.len);let n=0;for(;e!=null;)e.fn(e.val,t,n),n+=e.len,e=e.next;return t}}function hv(r,e,t){e[t]=r&255}function tne(r,e,t){for(;r>127;)e[t++]=r&127|128,r>>>=7;e[t]=r}class rne extends A1{constructor(t,n){super(tne,t,n);u(this,"next");this.next=void 0}}function iy(r,e,t){for(;r.hi!==0;)e[t++]=r.lo&127|128,r.lo=(r.lo>>>7|r.hi<<25)>>>0,r.hi>>>=7;for(;r.lo>127;)e[t++]=r.lo&127|128,r.lo=r.lo>>>7;e[t++]=r.lo}function C1(r,e,t){e[t]=r&255,e[t+1]=r>>>8&255,e[t+2]=r>>>16&255,e[t+3]=r>>>24}function nne(r,e,t){e.set(r,t)}globalThis.Buffer!=null&&(dv.prototype.bytes=function(r){const e=r.length>>>0;return this.uint32(e),e>0&&this._push(ine,e,r),this},dv.prototype.string=function(r){const e=globalThis.Buffer.byteLength(r);return this.uint32(e),e>0&&this._push(sne,e,r),this});function ine(r,e,t){e.set(r,t)}function sne(r,e,t){r.length<40?mD(r,e,t):e.utf8Write!=null?e.utf8Write(r,t):e.set(ie(r),t)}function one(){return new dv}function Pe(r,e){const t=one();return e.encode(r,t,{lengthDelimited:!1}),t.finish()}var sy;(function(r){r[r.VARINT=0]="VARINT",r[r.BIT64=1]="BIT64",r[r.LENGTH_DELIMITED=2]="LENGTH_DELIMITED",r[r.START_GROUP=3]="START_GROUP",r[r.END_GROUP=4]="END_GROUP",r[r.BIT32=5]="BIT32"})(sy||(sy={}));function wD(r,e,t,n){return{name:r,type:e,encode:t,decode:n}}function In(r){function e(i){if(r[i.toString()]==null)throw new Error("Invalid enum value");return r[i]}const t=function(s,o){const a=e(s);o.int32(a)},n=function(s){const o=s.int32();return e(o)};return wD("enum",sy.VARINT,t,n)}function De(r,e){return wD("message",sy.LENGTH_DELIMITED,r,e)}class yt extends Error{constructor(){super(...arguments);u(this,"code","ERR_MAX_LENGTH");u(this,"name","MaxLengthError")}}class bD extends Error{constructor(){super(...arguments);u(this,"code","ERR_MAX_SIZE");u(this,"name","MaxSizeError")}}var Mt;(function(r){r.RSA="RSA",r.Ed25519="Ed25519",r.secp256k1="secp256k1",r.ECDSA="ECDSA"})(Mt||(Mt={}));var fv;(function(r){r[r.RSA=0]="RSA",r[r.Ed25519=1]="Ed25519",r[r.secp256k1=2]="secp256k1",r[r.ECDSA=3]="ECDSA"})(fv||(fv={})),function(r){r.codec=()=>In(fv)}(Mt||(Mt={}));var Xa;(function(r){let e;r.codec=()=>(e==null&&(e=De((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),Mt.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{const s={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.Type=Mt.codec().decode(t);break}case 2:{s.Data=t.bytes();break}default:{t.skipType(a&7);break}}}return s})),e),r.encode=t=>Pe(t,r.codec()),r.decode=(t,n)=>Te(t,r.codec(),n)})(Xa||(Xa={}));var oy;(function(r){let e;r.codec=()=>(e==null&&(e=De((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.Type!=null&&(n.uint32(8),Mt.codec().encode(t.Type,n)),t.Data!=null&&(n.uint32(18),n.bytes(t.Data)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{const s={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.Type=Mt.codec().decode(t);break}case 2:{s.Data=t.bytes();break}default:{t.skipType(a&7);break}}}return s})),e),r.encode=t=>Pe(t,r.codec()),r.decode=(t,n)=>Te(t,r.codec(),n)})(oy||(oy={}));const Dd=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */function ane(r){return r instanceof Uint8Array||ArrayBuffer.isView(r)&&r.constructor.name==="Uint8Array"}function $d(r){if(!Number.isSafeInteger(r)||r<0)throw new Error("positive integer expected, got "+r)}function I1(r,...e){if(!ane(r))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(r.length))throw new Error("Uint8Array expected of length "+e+", got length="+r.length)}function ay(r){if(typeof r!="function"||typeof r.create!="function")throw new Error("Hash should be wrapped by utils.createHasher");$d(r.outputLen),$d(r.blockLen)}function cy(r,e=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(e&&r.finished)throw new Error("Hash#digest() has already been called")}function cne(r,e){I1(r);const t=e.outputLen;if(r.length<t)throw new Error("digestInto() expects output buffer of length at least "+t)}function Ms(...r){for(let e=0;e<r.length;e++)r[e].fill(0)}function k1(r){return new DataView(r.buffer,r.byteOffset,r.byteLength)}function Os(r,e){return r<<32-e|r>>>e}function pv(r,e){return r<<e|r>>>32-e>>>0}const lne=async()=>{};async function une(r,e,t){let n=Date.now();for(let i=0;i<r;i++){t(i);const s=Date.now()-n;s>=0&&s<e||(await lne(),n+=s)}}function vD(r){if(typeof r!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(r))}function _1(r){return typeof r=="string"&&(r=vD(r)),I1(r),r}function ED(r){return typeof r=="string"&&(r=vD(r)),I1(r),r}function dne(r,e){if(e!==void 0&&{}.toString.call(e)!=="[object Object]")throw new Error("options should be object or undefined");return Object.assign(r,e)}class SD{}function gv(r){const e=n=>r().update(_1(n)).digest(),t=r();return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=()=>r(),e}function hne(r=32){if(Dd&&typeof Dd.getRandomValues=="function")return Dd.getRandomValues(new Uint8Array(r));if(Dd&&typeof Dd.randomBytes=="function")return Uint8Array.from(Dd.randomBytes(r));throw new Error("crypto.getRandomValues must be defined")}function Za(r){if(isNaN(r)||r<=0)throw new Z("random bytes length must be a Number bigger than 0");return hne(r)}class xD extends Error{constructor(e="An error occurred while signing a message"){super(e),this.name="SigningError"}}class AD extends Error{constructor(e="An error occurred while verifying a message"){super(e),this.name="VerificationError"}}class fne extends Error{constructor(e="Missing Web Crypto API"){super(e),this.name="WebCryptoMissingError"}}const Rs={get(r=globalThis){const e=r.crypto;if((e==null?void 0:e.subtle)==null)throw new fne("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p/blob/main/packages/crypto/README.md#web-crypto-api");return e}};function pne(r,e,t,n){if(typeof r.setBigUint64=="function")return r.setBigUint64(e,t,n);const i=BigInt(32),s=BigInt(4294967295),o=Number(t>>i&s),a=Number(t&s),c=n?4:0,l=n?0:4;r.setUint32(e+c,o,n),r.setUint32(e+l,a,n)}function CD(r,e,t){return r&e^~r&t}function ID(r,e,t){return r&e^r&t^e&t}class yv extends SD{constructor(e,t,n,i){super(),this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.blockLen=e,this.outputLen=t,this.padOffset=n,this.isLE=i,this.buffer=new Uint8Array(e),this.view=k1(this.buffer)}update(e){cy(this),e=_1(e),I1(e);const{view:t,buffer:n,blockLen:i}=this,s=e.length;for(let o=0;o<s;){const a=Math.min(i-this.pos,s-o);if(a===i){const c=k1(e);for(;i<=s-o;o+=i)this.process(c,o);continue}n.set(e.subarray(o,o+a),this.pos),this.pos+=a,o+=a,this.pos===i&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){cy(this),cne(e,this),this.finished=!0;const{buffer:t,view:n,blockLen:i,isLE:s}=this;let{pos:o}=this;t[o++]=128,Ms(this.buffer.subarray(o)),this.padOffset>i-o&&(this.process(n,0),o=0);for(let h=o;h<i;h++)t[h]=0;pne(n,i-8,BigInt(this.length*8),s),this.process(n,0);const a=k1(e),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const l=c/4,d=this.get();if(l>d.length)throw new Error("_sha2: outputLen bigger than state");for(let h=0;h<l;h++)a.setUint32(4*h,d[h],s)}digest(){const{buffer:e,outputLen:t}=this;this.digestInto(e);const n=e.slice(0,t);return this.destroy(),n}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());const{blockLen:t,buffer:n,length:i,finished:s,destroyed:o,pos:a}=this;return e.destroyed=o,e.finished=s,e.length=i,e.pos=a,i%t&&e.buffer.set(n),e}clone(){return this._cloneInto()}}const ec=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),Fr=Uint32Array.from([1779033703,4089235720,3144134277,2227873595,1013904242,4271175723,2773480762,1595750129,1359893119,2917565137,2600822924,725511199,528734635,4215389547,1541459225,327033209]),ly=BigInt(2**32-1),kD=BigInt(32);function gne(r,e=!1){return e?{h:Number(r&ly),l:Number(r>>kD&ly)}:{h:Number(r>>kD&ly)|0,l:Number(r&ly)|0}}function yne(r,e=!1){const t=r.length;let n=new Uint32Array(t),i=new Uint32Array(t);for(let s=0;s<t;s++){const{h:o,l:a}=gne(r[s],e);[n[s],i[s]]=[o,a]}return[n,i]}const _D=(r,e,t)=>r>>>t,TD=(r,e,t)=>r<<32-t|e>>>t,Nd=(r,e,t)=>r>>>t|e<<32-t,Md=(r,e,t)=>r<<32-t|e>>>t,uy=(r,e,t)=>r<<64-t|e>>>t-32,dy=(r,e,t)=>r>>>t-32|e<<64-t;function ko(r,e,t,n){const i=(e>>>0)+(n>>>0);return{h:r+t+(i/2**32|0)|0,l:i|0}}const mne=(r,e,t)=>(r>>>0)+(e>>>0)+(t>>>0),wne=(r,e,t,n)=>e+t+n+(r/2**32|0)|0,bne=(r,e,t,n)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0),vne=(r,e,t,n,i)=>e+t+n+i+(r/2**32|0)|0,Ene=(r,e,t,n,i)=>(r>>>0)+(e>>>0)+(t>>>0)+(n>>>0)+(i>>>0),Sne=(r,e,t,n,i,s)=>e+t+n+i+s+(r/2**32|0)|0,xne=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),tc=new Uint32Array(64);class Ane extends yv{constructor(e=32){super(64,e,8,!1),this.A=ec[0]|0,this.B=ec[1]|0,this.C=ec[2]|0,this.D=ec[3]|0,this.E=ec[4]|0,this.F=ec[5]|0,this.G=ec[6]|0,this.H=ec[7]|0}get(){const{A:e,B:t,C:n,D:i,E:s,F:o,G:a,H:c}=this;return[e,t,n,i,s,o,a,c]}set(e,t,n,i,s,o,a,c){this.A=e|0,this.B=t|0,this.C=n|0,this.D=i|0,this.E=s|0,this.F=o|0,this.G=a|0,this.H=c|0}process(e,t){for(let h=0;h<16;h++,t+=4)tc[h]=e.getUint32(t,!1);for(let h=16;h<64;h++){const p=tc[h-15],m=tc[h-2],f=Os(p,7)^Os(p,18)^p>>>3,g=Os(m,17)^Os(m,19)^m>>>10;tc[h]=g+tc[h-7]+f+tc[h-16]|0}let{A:n,B:i,C:s,D:o,E:a,F:c,G:l,H:d}=this;for(let h=0;h<64;h++){const p=Os(a,6)^Os(a,11)^Os(a,25),m=d+p+CD(a,c,l)+xne[h]+tc[h]|0,g=(Os(n,2)^Os(n,13)^Os(n,22))+ID(n,i,s)|0;d=l,l=c,c=a,a=o+m|0,o=s,s=i,i=n,n=m+g|0}n=n+this.A|0,i=i+this.B|0,s=s+this.C|0,o=o+this.D|0,a=a+this.E|0,c=c+this.F|0,l=l+this.G|0,d=d+this.H|0,this.set(n,i,s,o,a,c,l,d)}roundClean(){Ms(tc)}destroy(){this.set(0,0,0,0,0,0,0,0),Ms(this.buffer)}}const PD=yne(["0x428a2f98d728ae22","0x7137449123ef65cd","0xb5c0fbcfec4d3b2f","0xe9b5dba58189dbbc","0x3956c25bf348b538","0x59f111f1b605d019","0x923f82a4af194f9b","0xab1c5ed5da6d8118","0xd807aa98a3030242","0x12835b0145706fbe","0x243185be4ee4b28c","0x550c7dc3d5ffb4e2","0x72be5d74f27b896f","0x80deb1fe3b1696b1","0x9bdc06a725c71235","0xc19bf174cf692694","0xe49b69c19ef14ad2","0xefbe4786384f25e3","0x0fc19dc68b8cd5b5","0x240ca1cc77ac9c65","0x2de92c6f592b0275","0x4a7484aa6ea6e483","0x5cb0a9dcbd41fbd4","0x76f988da831153b5","0x983e5152ee66dfab","0xa831c66d2db43210","0xb00327c898fb213f","0xbf597fc7beef0ee4","0xc6e00bf33da88fc2","0xd5a79147930aa725","0x06ca6351e003826f","0x142929670a0e6e70","0x27b70a8546d22ffc","0x2e1b21385c26c926","0x4d2c6dfc5ac42aed","0x53380d139d95b3df","0x650a73548baf63de","0x766a0abb3c77b2a8","0x81c2c92e47edaee6","0x92722c851482353b","0xa2bfe8a14cf10364","0xa81a664bbc423001","0xc24b8b70d0f89791","0xc76c51a30654be30","0xd192e819d6ef5218","0xd69906245565a910","0xf40e35855771202a","0x106aa07032bbd1b8","0x19a4c116b8d2d0c8","0x1e376c085141ab53","0x2748774cdf8eeb99","0x34b0bcb5e19b48a8","0x391c0cb3c5c95a63","0x4ed8aa4ae3418acb","0x5b9cca4f7763e373","0x682e6ff3d6b2b8a3","0x748f82ee5defb2fc","0x78a5636f43172f60","0x84c87814a1f0ab72","0x8cc702081a6439ec","0x90befffa23631e28","0xa4506cebde82bde9","0xbef9a3f7b2c67915","0xc67178f2e372532b","0xca273eceea26619c","0xd186b8c721c0c207","0xeada7dd6cde0eb1e","0xf57d4f7fee6ed178","0x06f067aa72176fba","0x0a637dc5a2c898a6","0x113f9804bef90dae","0x1b710b35131c471b","0x28db77f523047d84","0x32caab7b40c72493","0x3c9ebe0a15c9bebc","0x431d67c49c100d4c","0x4cc5d4becb3e42b6","0x597f299cfc657e2a","0x5fcb6fab3ad6faec","0x6c44198c4a475817"].map(r=>BigInt(r))),Cne=PD[0],Ine=PD[1],rc=new Uint32Array(80),nc=new Uint32Array(80);class kne extends yv{constructor(e=64){super(128,e,16,!1),this.Ah=Fr[0]|0,this.Al=Fr[1]|0,this.Bh=Fr[2]|0,this.Bl=Fr[3]|0,this.Ch=Fr[4]|0,this.Cl=Fr[5]|0,this.Dh=Fr[6]|0,this.Dl=Fr[7]|0,this.Eh=Fr[8]|0,this.El=Fr[9]|0,this.Fh=Fr[10]|0,this.Fl=Fr[11]|0,this.Gh=Fr[12]|0,this.Gl=Fr[13]|0,this.Hh=Fr[14]|0,this.Hl=Fr[15]|0}get(){const{Ah:e,Al:t,Bh:n,Bl:i,Ch:s,Cl:o,Dh:a,Dl:c,Eh:l,El:d,Fh:h,Fl:p,Gh:m,Gl:f,Hh:g,Hl:w}=this;return[e,t,n,i,s,o,a,c,l,d,h,p,m,f,g,w]}set(e,t,n,i,s,o,a,c,l,d,h,p,m,f,g,w){this.Ah=e|0,this.Al=t|0,this.Bh=n|0,this.Bl=i|0,this.Ch=s|0,this.Cl=o|0,this.Dh=a|0,this.Dl=c|0,this.Eh=l|0,this.El=d|0,this.Fh=h|0,this.Fl=p|0,this.Gh=m|0,this.Gl=f|0,this.Hh=g|0,this.Hl=w|0}process(e,t){for(let v=0;v<16;v++,t+=4)rc[v]=e.getUint32(t),nc[v]=e.getUint32(t+=4);for(let v=16;v<80;v++){const E=rc[v-15]|0,C=nc[v-15]|0,k=Nd(E,C,1)^Nd(E,C,8)^_D(E,C,7),x=Md(E,C,1)^Md(E,C,8)^TD(E,C,7),I=rc[v-2]|0,T=nc[v-2]|0,L=Nd(I,T,19)^uy(I,T,61)^_D(I,T,6),z=Md(I,T,19)^dy(I,T,61)^TD(I,T,6),B=bne(x,z,nc[v-7],nc[v-16]),G=vne(B,k,L,rc[v-7],rc[v-16]);rc[v]=G|0,nc[v]=B|0}let{Ah:n,Al:i,Bh:s,Bl:o,Ch:a,Cl:c,Dh:l,Dl:d,Eh:h,El:p,Fh:m,Fl:f,Gh:g,Gl:w,Hh:y,Hl:b}=this;for(let v=0;v<80;v++){const E=Nd(h,p,14)^Nd(h,p,18)^uy(h,p,41),C=Md(h,p,14)^Md(h,p,18)^dy(h,p,41),k=h&m^~h&g,x=p&f^~p&w,I=Ene(b,C,x,Ine[v],nc[v]),T=Sne(I,y,E,k,Cne[v],rc[v]),L=I|0,z=Nd(n,i,28)^uy(n,i,34)^uy(n,i,39),B=Md(n,i,28)^dy(n,i,34)^dy(n,i,39),G=n&s^n&a^s&a,K=i&o^i&c^o&c;y=g|0,b=w|0,g=m|0,w=f|0,m=h|0,f=p|0,{h,l:p}=ko(l|0,d|0,T|0,L|0),l=a|0,d=c|0,a=s|0,c=o|0,s=n|0,o=i|0;const q=mne(L,B,K);n=wne(q,T,z,G),i=q|0}({h:n,l:i}=ko(this.Ah|0,this.Al|0,n|0,i|0)),{h:s,l:o}=ko(this.Bh|0,this.Bl|0,s|0,o|0),{h:a,l:c}=ko(this.Ch|0,this.Cl|0,a|0,c|0),{h:l,l:d}=ko(this.Dh|0,this.Dl|0,l|0,d|0),{h,l:p}=ko(this.Eh|0,this.El|0,h|0,p|0),{h:m,l:f}=ko(this.Fh|0,this.Fl|0,m|0,f|0),{h:g,l:w}=ko(this.Gh|0,this.Gl|0,g|0,w|0),{h:y,l:b}=ko(this.Hh|0,this.Hl|0,y|0,b|0),this.set(n,i,s,o,a,c,l,d,h,p,m,f,g,w,y,b)}roundClean(){Ms(rc,nc)}destroy(){Ms(this.buffer),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}}const _ne=gv(()=>new Ane),Tne=gv(()=>new kne),Nl=_ne;let mv=class{constructor(e,t){u(this,"type","RSA");u(this,"jwk");u(this,"_raw");u(this,"_multihash");this.jwk=e,this._multihash=t}get raw(){return this._raw==null&&(this._raw=bv(this.jwk)),this._raw}toMultihash(){return this._multihash}toCID(){return V2.createV1(114,this._multihash)}toString(){return Ii.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:qe(this.raw,e.raw)}verify(e,t){return Kne(this.jwk,t,e)}},DD=class{constructor(e,t){u(this,"type","RSA");u(this,"jwk");u(this,"_raw");u(this,"publicKey");this.jwk=e,this.publicKey=t}get raw(){return this._raw==null&&(this._raw=Nne(this.jwk)),this._raw}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:qe(this.raw,e.raw)}sign(e){return Vne(this.jwk,e)}};const $D=8192,wv=18,Pne=1062,Dne=Uint8Array.from([48,13,6,9,42,134,72,134,247,13,1,1,1,5,0]);function $ne(r){return{n:re(r[1],"base64url"),e:re(r[2],"base64url"),d:re(r[3],"base64url"),p:re(r[4],"base64url"),q:re(r[5],"base64url"),dp:re(r[6],"base64url"),dq:re(r[7],"base64url"),qi:re(r[8],"base64url"),kty:"RSA"}}function Nne(r){if(r.n==null||r.e==null||r.d==null||r.p==null||r.q==null||r.dp==null||r.dq==null||r.qi==null)throw new Z("JWK was missing components");return Ao([Xn(Uint8Array.from([0])),Xn(ie(r.n,"base64url")),Xn(ie(r.e,"base64url")),Xn(ie(r.d,"base64url")),Xn(ie(r.p,"base64url")),Xn(ie(r.q,"base64url")),Xn(ie(r.dp,"base64url")),Xn(ie(r.dq,"base64url")),Xn(ie(r.qi,"base64url"))]).subarray()}function Mne(r){const e=Ha(r[1],{offset:0});return{kty:"RSA",n:re(e[0],"base64url"),e:re(e[1],"base64url")}}function bv(r){if(r.n==null||r.e==null)throw new Z("JWK was missing components");return Ao([Dne,Ob(Ao([Xn(ie(r.n,"base64url")),Xn(ie(r.e,"base64url"))]))]).subarray()}function One(r){const e=Ha(r);return ND(e)}function ND(r){const e=$ne(r);return Lne(e)}function Rne(r,e){if(r.byteLength>=Pne)throw new d1("Key size is too large");const t=Ha(r,{offset:0});return MD(t,r,e)}function MD(r,e,t){const n=Mne(r);if(t==null){const i=Nl(Xa.encode({Type:Mt.RSA,Data:e}));t=_l(wv,i)}return new mv(n,t)}function Lne(r){if(Hne(r)>$D)throw new Z("Key size is too large");const e=Une(r),t=Nl(Xa.encode({Type:Mt.RSA,Data:bv(e.publicKey)})),n=_l(wv,t);return new DD(e.privateKey,new mv(e.publicKey,n))}async function Bne(r){if(r>$D)throw new Z("Key size is too large");const e=await zne(r),t=Nl(Xa.encode({Type:Mt.RSA,Data:bv(e.publicKey)})),n=_l(wv,t);return new DD(e.privateKey,new mv(e.publicKey,n))}function Une(r){if(r==null)throw new Z("Missing key parameter");return{privateKey:r,publicKey:{kty:r.kty,n:r.n,e:r.e}}}const Fne="1.2.840.113549.1.1.1";async function zne(r){const e=await Rs.get().subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:r,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign","verify"]),t=await jne(e);return{privateKey:t[0],publicKey:t[1]}}async function Vne(r,e){const t=await Rs.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["sign"]),n=await Rs.get().subtle.sign({name:"RSASSA-PKCS1-v1_5"},t,e instanceof Uint8Array?e:e.subarray());return new Uint8Array(n,0,n.byteLength)}async function Kne(r,e,t){const n=await Rs.get().subtle.importKey("jwk",r,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]);return Rs.get().subtle.verify({name:"RSASSA-PKCS1-v1_5"},n,e,t instanceof Uint8Array?t:t.subarray())}async function jne(r){if(r.privateKey==null||r.publicKey==null)throw new Z("Private and public key are required");return Promise.all([Rs.get().subtle.exportKey("jwk",r.privateKey),Rs.get().subtle.exportKey("jwk",r.publicKey)])}function Hne(r){if(r.kty!=="RSA")throw new Z("invalid key type");if(r.n==null)throw new Z("invalid key modulus");return ie(r.n,"base64url").length*8}let OD=class extends FP{constructor(e,t){super(),this.finished=!1,this.destroyed=!1,Tte(e);const n=Lb(t);if(this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const i=this.blockLen,s=new Uint8Array(i);s.set(n.length>i?e.create().update(n).digest():n);for(let o=0;o<s.length;o++)s[o]^=54;this.iHash.update(s),this.oHash=e.create();for(let o=0;o<s.length;o++)s[o]^=106;this.oHash.update(s),s.fill(0)}update(e){return G2(this),this.iHash.update(e),this}digestInto(e){G2(this),W2(e,this.outputLen),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){const e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||(e=Object.create(Object.getPrototypeOf(this),{}));const{oHash:t,iHash:n,finished:i,destroyed:s,blockLen:o,outputLen:a}=this;return e=e,e.finished=i,e.destroyed=s,e.blockLen=o,e.outputLen=a,e.oHash=t._cloneInto(e.oHash),e.iHash=n._cloneInto(e.iHash),e}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}};const RD=(r,e,t)=>new OD(r,e).update(t).digest();RD.create=(r,e)=>new OD(r,e);/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */function LD(r){r.lowS!==void 0&&Ya("lowS",r.lowS),r.prehash!==void 0&&Ya("prehash",r.prehash)}function qne(r){const e=Zb(r);Td(e,{a:"field",b:"field"},{allowedPrivateKeyLengths:"array",wrapPrivateKey:"boolean",isTorsionFree:"function",clearCofactor:"function",allowInfinityPoint:"boolean",fromBytes:"function",toBytes:"function"});const{endo:t,Fp:n,a:i}=e;if(t){if(!n.eql(i,n.ZERO))throw new Error("invalid endomorphism, can only be defined for Koblitz curves that have a=0");if(typeof t!="object"||typeof t.beta!="bigint"||typeof t.splitScalar!="function")throw new Error("invalid endomorphism, expected beta: bigint and splitScalar: function")}return Object.freeze({...e})}class Wne extends Error{constructor(e=""){super(e)}}const _o={Err:Wne,_tlv:{encode:(r,e)=>{const{Err:t}=_o;if(r<0||r>256)throw new t("tlv.encode: wrong tag");if(e.length&1)throw new t("tlv.encode: unpadded data");const n=e.length/2,i=Y2(n);if(i.length/2&128)throw new t("tlv.encode: long form length too big");const s=n>127?Y2(i.length/2|128):"";return Y2(r)+s+i+e},decode(r,e){const{Err:t}=_o;let n=0;if(r<0||r>256)throw new t("tlv.encode: wrong tag");if(e.length<2||e[n++]!==r)throw new t("tlv.decode: wrong tlv");const i=e[n++],s=!!(i&128);let o=0;if(!s)o=i;else{const c=i&127;if(!c)throw new t("tlv.decode(long): indefinite length not supported");if(c>4)throw new t("tlv.decode(long): byte length is too big");const l=e.subarray(n,n+c);if(l.length!==c)throw new t("tlv.decode: length bytes not complete");if(l[0]===0)throw new t("tlv.decode(long): zero leftmost byte");for(const d of l)o=o<<8|d;if(n+=c,o<128)throw new t("tlv.decode(long): not minimal encoding")}const a=e.subarray(n,n+o);if(a.length!==o)throw new t("tlv.decode: wrong value length");return{v:a,l:e.subarray(n+o)}}},_int:{encode(r){const{Err:e}=_o;if(r<To)throw new e("integer: negative integers are not allowed");let t=Y2(r);if(Number.parseInt(t[0],16)&8&&(t="00"+t),t.length&1)throw new e("unexpected DER parsing assertion: unpadded hex");return t},decode(r){const{Err:e}=_o;if(r[0]&128)throw new e("invalid signature integer: negative");if(r[0]===0&&!(r[1]&128))throw new e("invalid signature integer: unnecessary leading zero");return Tl(r)}},toSig(r){const{Err:e,_int:t,_tlv:n}=_o,i=Ht("signature",r),{v:s,l:o}=n.decode(48,i);if(o.length)throw new e("invalid signature: left bytes after parsing");const{v:a,l:c}=n.decode(2,s),{v:l,l:d}=n.decode(2,c);if(d.length)throw new e("invalid signature: left bytes after parsing");return{r:t.decode(a),s:t.decode(l)}},hexFromSig(r){const{_tlv:e,_int:t}=_o,n=e.encode(2,t.encode(r.r)),i=e.encode(2,t.encode(r.s)),s=n+i;return e.encode(48,s)}},To=BigInt(0),hr=BigInt(1);BigInt(2);const BD=BigInt(3);BigInt(4);function Gne(r){const e=qne(r),{Fp:t}=e,n=ey(e.n,e.nBitLength),i=e.toBytes||((g,w,y)=>{const b=w.toAffine();return _d(Uint8Array.from([4]),t.toBytes(b.x),t.toBytes(b.y))}),s=e.fromBytes||(g=>{const w=g.subarray(1),y=t.fromBytes(w.subarray(0,t.BYTES)),b=t.fromBytes(w.subarray(t.BYTES,2*t.BYTES));return{x:y,y:b}});function o(g){const{a:w,b:y}=e,b=t.sqr(g),v=t.mul(b,g);return t.add(t.add(v,t.mul(g,w)),y)}if(!t.eql(t.sqr(e.Gy),o(e.Gx)))throw new Error("bad generator point: equation left != right");function a(g){return jb(g,hr,e.n)}function c(g){const{allowedPrivateKeyLengths:w,nByteLength:y,wrapPrivateKey:b,n:v}=e;if(w&&typeof g!="bigint"){if(Id(g)&&(g=kd(g)),typeof g!="string"||!w.includes(g.length))throw new Error("invalid private key");g=g.padStart(y*2,"0")}let E;try{E=typeof g=="bigint"?g:Tl(Ht("private key",g,y))}catch{throw new Error("invalid private key, expected hex or "+y+" bytes, got "+typeof g)}return b&&(E=xt(E,v)),Zn("private key",E,hr,v),E}function l(g){if(!(g instanceof p))throw new Error("ProjectivePoint expected")}const d=Z2((g,w)=>{const{px:y,py:b,pz:v}=g;if(t.eql(v,t.ONE))return{x:y,y:b};const E=g.is0();w==null&&(w=E?t.ONE:t.inv(v));const C=t.mul(y,w),k=t.mul(b,w),x=t.mul(v,w);if(E)return{x:t.ZERO,y:t.ZERO};if(!t.eql(x,t.ONE))throw new Error("invZ was invalid");return{x:C,y:k}}),h=Z2(g=>{if(g.is0()){if(e.allowInfinityPoint&&!t.is0(g.py))return;throw new Error("bad point: ZERO")}const{x:w,y}=g.toAffine();if(!t.isValid(w)||!t.isValid(y))throw new Error("bad point: x or y not FE");const b=t.sqr(y),v=o(w);if(!t.eql(b,v))throw new Error("bad point: equation left != right");if(!g.isTorsionFree())throw new Error("bad point: not in prime-order subgroup");return!0});class p{constructor(w,y,b){if(w==null||!t.isValid(w))throw new Error("x required");if(y==null||!t.isValid(y))throw new Error("y required");if(b==null||!t.isValid(b))throw new Error("z required");this.px=w,this.py=y,this.pz=b,Object.freeze(this)}static fromAffine(w){const{x:y,y:b}=w||{};if(!w||!t.isValid(y)||!t.isValid(b))throw new Error("invalid affine point");if(w instanceof p)throw new Error("projective point not allowed");const v=E=>t.eql(E,t.ZERO);return v(y)&&v(b)?p.ZERO:new p(y,b,t.ONE)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}static normalizeZ(w){const y=t.invertBatch(w.map(b=>b.pz));return w.map((b,v)=>b.toAffine(y[v])).map(p.fromAffine)}static fromHex(w){const y=p.fromAffine(s(Ht("pointHex",w)));return y.assertValidity(),y}static fromPrivateKey(w){return p.BASE.multiply(c(w))}static msm(w,y){return sD(p,n,w,y)}_setWindowSize(w){f.setWindowSize(this,w)}assertValidity(){h(this)}hasEvenY(){const{y:w}=this.toAffine();if(t.isOdd)return!t.isOdd(w);throw new Error("Field doesn't support isOdd")}equals(w){l(w);const{px:y,py:b,pz:v}=this,{px:E,py:C,pz:k}=w,x=t.eql(t.mul(y,k),t.mul(E,v)),I=t.eql(t.mul(b,k),t.mul(C,v));return x&&I}negate(){return new p(this.px,t.neg(this.py),this.pz)}double(){const{a:w,b:y}=e,b=t.mul(y,BD),{px:v,py:E,pz:C}=this;let k=t.ZERO,x=t.ZERO,I=t.ZERO,T=t.mul(v,v),L=t.mul(E,E),z=t.mul(C,C),B=t.mul(v,E);return B=t.add(B,B),I=t.mul(v,C),I=t.add(I,I),k=t.mul(w,I),x=t.mul(b,z),x=t.add(k,x),k=t.sub(L,x),x=t.add(L,x),x=t.mul(k,x),k=t.mul(B,k),I=t.mul(b,I),z=t.mul(w,z),B=t.sub(T,z),B=t.mul(w,B),B=t.add(B,I),I=t.add(T,T),T=t.add(I,T),T=t.add(T,z),T=t.mul(T,B),x=t.add(x,T),z=t.mul(E,C),z=t.add(z,z),T=t.mul(z,B),k=t.sub(k,T),I=t.mul(z,L),I=t.add(I,I),I=t.add(I,I),new p(k,x,I)}add(w){l(w);const{px:y,py:b,pz:v}=this,{px:E,py:C,pz:k}=w;let x=t.ZERO,I=t.ZERO,T=t.ZERO;const L=e.a,z=t.mul(e.b,BD);let B=t.mul(y,E),G=t.mul(b,C),K=t.mul(v,k),q=t.add(y,b),Q=t.add(E,C);q=t.mul(q,Q),Q=t.add(B,G),q=t.sub(q,Q),Q=t.add(y,v);let j=t.add(E,k);return Q=t.mul(Q,j),j=t.add(B,K),Q=t.sub(Q,j),j=t.add(b,v),x=t.add(C,k),j=t.mul(j,x),x=t.add(G,K),j=t.sub(j,x),T=t.mul(L,Q),x=t.mul(z,K),T=t.add(x,T),x=t.sub(G,T),T=t.add(G,T),I=t.mul(x,T),G=t.add(B,B),G=t.add(G,B),K=t.mul(L,K),Q=t.mul(z,Q),G=t.add(G,K),K=t.sub(B,K),K=t.mul(L,K),Q=t.add(Q,K),B=t.mul(G,Q),I=t.add(I,B),B=t.mul(j,Q),x=t.mul(q,x),x=t.sub(x,B),B=t.mul(q,G),T=t.mul(j,T),T=t.add(T,B),new p(x,I,T)}subtract(w){return this.add(w.negate())}is0(){return this.equals(p.ZERO)}wNAF(w){return f.wNAFCached(this,w,p.normalizeZ)}multiplyUnsafe(w){const{endo:y,n:b}=e;Zn("scalar",w,To,b);const v=p.ZERO;if(w===To)return v;if(this.is0()||w===hr)return this;if(!y||f.hasPrecomputes(this))return f.wNAFCachedUnsafe(this,w,p.normalizeZ);let{k1neg:E,k1:C,k2neg:k,k2:x}=y.splitScalar(w),I=v,T=v,L=this;for(;C>To||x>To;)C&hr&&(I=I.add(L)),x&hr&&(T=T.add(L)),L=L.double(),C>>=hr,x>>=hr;return E&&(I=I.negate()),k&&(T=T.negate()),T=new p(t.mul(T.px,y.beta),T.py,T.pz),I.add(T)}multiply(w){const{endo:y,n:b}=e;Zn("scalar",w,hr,b);let v,E;if(y){const{k1neg:C,k1:k,k2neg:x,k2:I}=y.splitScalar(w);let{p:T,f:L}=this.wNAF(k),{p:z,f:B}=this.wNAF(I);T=f.constTimeNegate(C,T),z=f.constTimeNegate(x,z),z=new p(t.mul(z.px,y.beta),z.py,z.pz),v=T.add(z),E=L.add(B)}else{const{p:C,f:k}=this.wNAF(w);v=C,E=k}return p.normalizeZ([v,E])[0]}multiplyAndAddUnsafe(w,y,b){const v=p.BASE,E=(k,x)=>x===To||x===hr||!k.equals(v)?k.multiplyUnsafe(x):k.multiply(x),C=E(this,y).add(E(w,b));return C.is0()?void 0:C}toAffine(w){return d(this,w)}isTorsionFree(){const{h:w,isTorsionFree:y}=e;if(w===hr)return!0;if(y)return y(p,this);throw new Error("isTorsionFree() has not been declared for the elliptic curve")}clearCofactor(){const{h:w,clearCofactor:y}=e;return w===hr?this:y?y(p,this):this.multiplyUnsafe(e.h)}toRawBytes(w=!0){return Ya("isCompressed",w),this.assertValidity(),i(p,this,w)}toHex(w=!0){return Ya("isCompressed",w),kd(this.toRawBytes(w))}}p.BASE=new p(e.Gx,e.Gy,t.ONE),p.ZERO=new p(t.ZERO,t.ONE,t.ZERO);const m=e.nBitLength,f=iD(p,e.endo?Math.ceil(m/2):m);return{CURVE:e,ProjectivePoint:p,normPrivateKeyToScalar:c,weierstrassEquation:o,isWithinCurveOrder:a}}function Qne(r){const e=Zb(r);return Td(e,{hash:"hash",hmac:"function",randomBytes:"function"},{bits2int:"function",bits2int_modN:"function",lowS:"boolean"}),Object.freeze({lowS:!0,...e})}function Yne(r){const e=Qne(r),{Fp:t,n}=e,i=t.BYTES+1,s=2*t.BYTES+1;function o(K){return xt(K,n)}function a(K){return Wb(K,n)}const{ProjectivePoint:c,normPrivateKeyToScalar:l,weierstrassEquation:d,isWithinCurveOrder:h}=Gne({...e,toBytes(K,q,Q){const j=q.toAffine(),O=t.toBytes(j.x),U=_d;return Ya("isCompressed",Q),Q?U(Uint8Array.from([q.hasEvenY()?2:3]),O):U(Uint8Array.from([4]),O,t.toBytes(j.y))},fromBytes(K){const q=K.length,Q=K[0],j=K.subarray(1);if(q===i&&(Q===2||Q===3)){const O=Tl(j);if(!jb(O,hr,t.ORDER))throw new Error("Point is not on curve");const U=d(O);let W;try{W=t.sqrt(U)}catch(oe){const ye=oe instanceof Error?": "+oe.message:"";throw new Error("Point is not on curve"+ye)}const Y=(W&hr)===hr;return(Q&1)===1!==Y&&(W=t.neg(W)),{x:O,y:W}}else if(q===s&&Q===4){const O=t.fromBytes(j.subarray(0,t.BYTES)),U=t.fromBytes(j.subarray(t.BYTES,2*t.BYTES));return{x:O,y:U}}else{const O=i,U=s;throw new Error("invalid Point, expected length of "+O+", or uncompressed "+U+", got "+q)}}}),p=K=>kd(b1(K,e.nByteLength));function m(K){const q=n>>hr;return K>q}function f(K){return m(K)?o(-K):K}const g=(K,q,Q)=>Tl(K.slice(q,Q));class w{constructor(q,Q,j){Zn("r",q,hr,n),Zn("s",Q,hr,n),this.r=q,this.s=Q,j!=null&&(this.recovery=j),Object.freeze(this)}static fromCompact(q){const Q=e.nByteLength;return q=Ht("compactSignature",q,Q*2),new w(g(q,0,Q),g(q,Q,2*Q))}static fromDER(q){const{r:Q,s:j}=_o.toSig(Ht("DER",q));return new w(Q,j)}assertValidity(){}addRecoveryBit(q){return new w(this.r,this.s,q)}recoverPublicKey(q){const{r:Q,s:j,recovery:O}=this,U=k(Ht("msgHash",q));if(O==null||![0,1,2,3].includes(O))throw new Error("recovery id invalid");const W=O===2||O===3?Q+e.n:Q;if(W>=t.ORDER)throw new Error("recovery id 2 or 3 invalid");const Y=O&1?"03":"02",H=c.fromHex(Y+p(W)),oe=a(W),ye=o(-U*oe),de=o(j*oe),le=c.BASE.multiplyAndAddUnsafe(H,ye,de);if(!le)throw new Error("point at infinify");return le.assertValidity(),le}hasHighS(){return m(this.s)}normalizeS(){return this.hasHighS()?new w(this.r,o(-this.s),this.recovery):this}toDERRawBytes(){return J2(this.toDERHex())}toDERHex(){return _o.hexFromSig({r:this.r,s:this.s})}toCompactRawBytes(){return J2(this.toCompactHex())}toCompactHex(){return p(this.r)+p(this.s)}}const y={isValidPrivateKey(K){try{return l(K),!0}catch{return!1}},normPrivateKeyToScalar:l,randomPrivateKey:()=>{const K=ZP(e.n);return yre(e.randomBytes(K),e.n)},precompute(K=8,q=c.BASE){return q._setWindowSize(K),q.multiply(BigInt(3)),q}};function b(K,q=!0){return c.fromPrivateKey(K).toRawBytes(q)}function v(K){const q=Id(K),Q=typeof K=="string",j=(q||Q)&&K.length;return q?j===i||j===s:Q?j===2*i||j===2*s:K instanceof c}function E(K,q,Q=!0){if(v(K))throw new Error("first arg must be private key");if(!v(q))throw new Error("second arg must be public key");return c.fromHex(q).multiply(l(K)).toRawBytes(Q)}const C=e.bits2int||function(K){if(K.length>8192)throw new Error("input is too large");const q=Tl(K),Q=K.length*8-e.nBitLength;return Q>0?q>>BigInt(Q):q},k=e.bits2int_modN||function(K){return o(C(K))},x=X2(e.nBitLength);function I(K){return Zn("num < 2^"+e.nBitLength,K,To,x),b1(K,e.nByteLength)}function T(K,q,Q=L){if(["recovered","canonical"].some(Ne=>Ne in Q))throw new Error("sign() legacy options not supported");const{hash:j,randomBytes:O}=e;let{lowS:U,prehash:W,extraEntropy:Y}=Q;U==null&&(U=!0),K=Ht("msgHash",K),LD(Q),W&&(K=Ht("prehashed msgHash",j(K)));const H=k(K),oe=l(q),ye=[I(oe),I(H)];if(Y!=null&&Y!==!1){const Ne=Y===!0?O(t.BYTES):Y;ye.push(Ht("extraEntropy",Ne))}const de=_d(...ye),le=H;function $e(Ne){const Ie=C(Ne);if(!h(Ie))return;const tt=a(Ie),bt=c.BASE.multiply(Ie).toAffine(),vt=o(bt.x);if(vt===To)return;const kt=o(tt*o(le+vt*oe));if(kt===To)return;let Yt=(bt.x===vt?0:2)|Number(bt.y&hr),wn=kt;return U&&m(kt)&&(wn=f(kt),Yt^=1),new w(vt,wn,Yt)}return{seed:de,k2sig:$e}}const L={lowS:e.lowS,prehash:!1},z={lowS:e.lowS,prehash:!1};function B(K,q,Q=L){const{seed:j,k2sig:O}=T(K,q,Q),U=e;return ore(U.hash.outputLen,U.nByteLength,U.hmac)(j,O)}c.BASE._setWindowSize(8);function G(K,q,Q,j=z){var Yt;const O=K;q=Ht("msgHash",q),Q=Ht("publicKey",Q);const{lowS:U,prehash:W,format:Y}=j;if(LD(j),"strict"in j)throw new Error("options.strict was renamed to lowS");if(Y!==void 0&&Y!=="compact"&&Y!=="der")throw new Error("format must be compact or der");const H=typeof O=="string"||Id(O),oe=!H&&!Y&&typeof O=="object"&&O!==null&&typeof O.r=="bigint"&&typeof O.s=="bigint";if(!H&&!oe)throw new Error("invalid signature, expected Uint8Array, hex string or Signature instance");let ye,de;try{if(oe&&(ye=new w(O.r,O.s)),H){try{Y!=="compact"&&(ye=w.fromDER(O))}catch(wn){if(!(wn instanceof _o.Err))throw wn}!ye&&Y!=="der"&&(ye=w.fromCompact(O))}de=c.fromHex(Q)}catch{return!1}if(!ye||U&&ye.hasHighS())return!1;W&&(q=e.hash(q));const{r:le,s:$e}=ye,Ne=k(q),Ie=a($e),tt=o(Ne*Ie),bt=o(le*Ie),vt=(Yt=c.BASE.multiplyAndAddUnsafe(de,tt,bt))==null?void 0:Yt.toAffine();return vt?o(vt.x)===le:!1}return{CURVE:e,getPublicKey:b,getSharedSecret:E,sign:B,verify:G,ProjectivePoint:c,Signature:w,utils:y}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */function Jne(r){return{hash:r,hmac:(e,...t)=>RD(r,e,$te(...t)),randomBytes:Bb}}function Xne(r,e){const t=n=>Yne({...r,...Jne(n)});return{...t(e),create:t}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const UD=BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),FD=BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),Zne=BigInt(1),vv=BigInt(2),zD=(r,e)=>(r+e/vv)/e;function eie(r){const e=UD,t=BigInt(3),n=BigInt(6),i=BigInt(11),s=BigInt(22),o=BigInt(23),a=BigInt(44),c=BigInt(88),l=r*r*r%e,d=l*l*r%e,h=Ft(d,t,e)*d%e,p=Ft(h,t,e)*d%e,m=Ft(p,vv,e)*l%e,f=Ft(m,i,e)*m%e,g=Ft(f,s,e)*f%e,w=Ft(g,a,e)*g%e,y=Ft(w,c,e)*w%e,b=Ft(y,a,e)*g%e,v=Ft(b,t,e)*d%e,E=Ft(v,o,e)*f%e,C=Ft(E,n,e)*l%e,k=Ft(C,vv,e);if(!Ev.eql(Ev.sqr(k),r))throw new Error("Cannot find square root");return k}const Ev=ey(UD,void 0,void 0,{sqrt:eie}),Ls=Xne({a:BigInt(0),b:BigInt(7),Fp:Ev,n:FD,Gx:BigInt("55066263022277343669578718895168534326250603453777594175500187360389116729240"),Gy:BigInt("32670510020758816978083085130507043184471273380659243275938904335757337482424"),h:BigInt(1),lowS:!0,endo:{beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),splitScalar:r=>{const e=FD,t=BigInt("0x3086d221a7d46bcde86c90e49284eb15"),n=-Zne*BigInt("0xe4437ed6010e88286f547fa90abfe4c3"),i=BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),s=t,o=BigInt("0x100000000000000000000000000000000"),a=zD(s*r,e),c=zD(-n*r,e);let l=xt(r-a*t-c*i,e),d=xt(-a*n-c*s,e);const h=l>o,p=d>o;if(h&&(l=e-l),p&&(d=e-d),l>o||d>o)throw new Error("splitScalar: Endomorphism failed, k="+r);return{k1neg:h,k1:l,k2neg:p,k2:d}}}},Bte);BigInt(0),Ls.ProjectivePoint;function tie({name:r,code:e,encode:t}){return new rie(r,e,t)}let rie=class{constructor(e,t,n){u(this,"name");u(this,"code");u(this,"encode");this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?_l(this.code,t):t.then(n=>_l(this.code,n))}else throw Error("Unknown type, must be binary type")}};function nie(r){return async e=>new Uint8Array(await crypto.subtle.digest(r,e))}const VD=tie({name:"sha2-256",code:18,encode:nie("SHA-256")});function KD(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}const iie=33,sie=32;function oie(r,e){const t=VD.digest(e instanceof Uint8Array?e:e.subarray());if(KD(t))return t.then(({digest:n})=>Ls.sign(n,r).toDERRawBytes()).catch(n=>{throw new xD(String(n))});try{return Ls.sign(t.digest,r).toDERRawBytes()}catch(n){throw new xD(String(n))}}function aie(r,e,t){const n=VD.digest(t instanceof Uint8Array?t:t.subarray());if(KD(n))return n.then(({digest:i})=>Ls.verify(e,i,r)).catch(i=>{throw new AD(String(i))});try{return Ls.verify(e,n.digest,r)}catch(i){throw new AD(String(i))}}class jD{constructor(e){u(this,"type","secp256k1");u(this,"raw");u(this,"_key");this._key=die(e),this.raw=lie(this._key)}toMultihash(){return $b.digest(ki(this))}toCID(){return V2.createV1(114,this.toMultihash())}toString(){return Ii.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:qe(this.raw,e.raw)}verify(e,t){return aie(this._key,t,e)}}class HD{constructor(e,t){u(this,"type","secp256k1");u(this,"raw");u(this,"publicKey");this.raw=uie(e),this.publicKey=new jD(t??hie(e))}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:qe(this.raw,e.raw)}sign(e){return oie(this.raw,e)}}function qD(r){return new HD(r)}function Sv(r){return new jD(r)}async function cie(){const r=fie();return new HD(r)}function lie(r){return Ls.ProjectivePoint.fromHex(r).toRawBytes(!0)}function uie(r){try{return Ls.getPublicKey(r,!0),r}catch(e){throw new Eb(String(e))}}function die(r){try{return Ls.ProjectivePoint.fromHex(r),r}catch(e){throw new d1(String(e))}}function hie(r){try{return Ls.getPublicKey(r,!0)}catch(e){throw new Eb(String(e))}}function fie(){return Ls.utils.randomPrivateKey()}async function hy(r,e){if(r==="Ed25519")return Ore();if(r==="secp256k1")return cie();if(r==="RSA")return Bne(yie(e));if(r==="ECDSA")return kte(mie(e));throw new kl}function kn(r,e){const{Type:t,Data:n}=Xa.decode(r),i=n??new Uint8Array;switch(t){case Mt.RSA:return Rne(i,e);case Mt.Ed25519:return nv(i);case Mt.secp256k1:return Sv(i);case Mt.ECDSA:return RP(i);default:throw new kl}}function pie(r){var n,i;if(r.byteLength===S1)return nv(r);if(r.byteLength===iie)return Sv(r);const e=Ha(r),t=(n=e[1])==null?void 0:n[0];if(t===TP||t===PP||t===DP)return LP(e);if(((i=e[0])==null?void 0:i[0])===Fne)return MD(e,r);throw new Z("Could not extract public key from raw bytes")}function WD(r){const{Type:e,Data:t}=Xa.decode(r.digest),n=t??new Uint8Array;switch(e){case Mt.Ed25519:return nv(n);case Mt.secp256k1:return Sv(n);case Mt.ECDSA:return RP(n);default:throw new kl}}function ki(r){return Xa.encode({Type:Mt[r.type],Data:r.raw})}function gie(r){const e=oy.decode(r),t=e.Data??new Uint8Array;switch(e.Type){case Mt.RSA:return One(t);case Mt.Ed25519:return fD(t);case Mt.secp256k1:return qD(t);case Mt.ECDSA:return Ate(t);default:throw new kl}}function xv(r){var n;if(r.byteLength===Io)return fD(r);if(r.byteLength===sie)return qD(r);const e=Ha(r),t=(n=e[2])==null?void 0:n[0];if(t===TP||t===PP||t===DP)return OP(e);if(e.length>8)return ND(e);throw new Z("Could not extract private key from raw bytes")}function T1(r){return oy.encode({Type:Mt[r.type],Data:r.raw})}function yie(r){return r==null?2048:parseInt(r,10)}function mie(r){if(r==="P-256"||r==null)return"P-256";if(r==="P-384")return"P-384";if(r==="P-521")return"P-521";throw new Z("Unsupported curve, should be P-256, P-384 or P-521")}async function GD(r){if(r.type==="RSA")return{privateKey:await crypto.subtle.importKey("jwk",r.jwk,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["sign"]),publicKey:await crypto.subtle.importKey("jwk",r.publicKey.jwk,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["verify"])};if(r.type==="ECDSA")return{privateKey:await crypto.subtle.importKey("jwk",r.jwk,{name:"ECDSA",namedCurve:r.jwk.crv??"P-256"},!0,["sign"]),publicKey:await crypto.subtle.importKey("jwk",r.publicKey.jwk,{name:"ECDSA",namedCurve:r.publicKey.jwk.crv??"P-256"},!0,["verify"])};throw new Z("Only RSA and ECDSA keys are supported")}function wie(r,e){for(let t=0;t<r.byteLength;t++){if(r[t]<e[t])return-1;if(r[t]>e[t])return 1}return r.byteLength>e.byteLength?1:r.byteLength<e.byteLength?-1:0}const bie=async(r,e,t)=>{if(!r)throw new Error("No signature given");if(!e)throw new Error("Given publicKey was undefined");if(!t)throw new Error("Given input data was undefined");t instanceof Uint8Array||(t=typeof t=="string"?ie(t):new Uint8Array(t));const n=(s,o,a)=>s.verify(o,a);let i=!1;try{const s=pie(ie(e,"base16"));i=await n(s,t,ie(r,"base16"))}catch{}return Promise.resolve(i)},Av=async(r,e)=>{if(!r)throw new Error("No signing key given");if(!e)throw new Error("Given input data was undefined");return e instanceof Uint8Array||(e=typeof e=="string"?ie(e):new Uint8Array(e)),re(await r.sign(e),"base16")},vie=Ds({size:1e3}),QD=async(r,e,t)=>{const n=await vie,i=await n.get(r);let s=!1;if(i){const o=(a,c)=>c instanceof Uint8Array?wie(a,c)===0:a.toString()===c.toString();s=i.publicKey===e&&o(i.data,t)}else{const o=await bie(r,e,t);s=o,o&&await n.put(r,{publicKey:e,data:t})}return s},Eie="./keystore",YD=async({storage:r,path:e}={})=>{r=r||await ul(await Ds({size:1e3}),await pb({path:e||Eie}));const t=await Ds({size:1e3}),n=async()=>{await r.close(),await t.close()},i=async()=>{await r.clear(),await t.clear()},s=async d=>{if(!d)throw new Error("id needed to check a key");let h=!1,p=await t.get(d);if(p)h=!0;else try{p=await r.get("private_"+d),h=p!=null}catch{console.error("Error: ENOENT: no such file or directory")}return h},o=async(d,h)=>{const{privateKey:p}=h;await r.put("private_"+d,p);const m=xv(p);await t.put(d,m)};return{clear:i,close:n,hasKey:s,addKey:o,createKey:async d=>{if(!d)throw new Error("id needed to create a key");const h=await hy("secp256k1"),p={publicKey:h.publicKey.raw,privateKey:h.raw};return await o(d,p),h},getKey:async d=>{if(!d)throw new Error("id needed to get a key");let h=await t.get(d);if(!h){let p;try{p=await r.get("private_"+d)}catch{}if(!p)return;h=xv(p),await t.put(d,h)}return h},getPublic:(d,h={})=>{const p=["hex","buffer"],m=h.format||"hex";if(p.indexOf(m)===-1)throw new Error("Supported formats are `hex` and `buffer`");const f=d.publicKey.raw;return m==="buffer"?f:re(f,"base16")}}},JD=Jf,XD=i2,Sie=ln,ZD=async({id:r,publicKey:e,signatures:t,type:n,sign:i,verify:s}={})=>{if(!r)throw new Error("Identity id is required");if(!e)throw new Error("Invalid public key");if(!t)throw new Error("Signatures object is required");if(!t.id)throw new Error("Signature of id is required");if(!t.publicKey)throw new Error("Signature of publicKey+id is required");if(!n)throw new Error("Identity type is required");t=Object.assign({},t);const o={id:r,publicKey:e,signatures:t,type:n,sign:i,verify:s},{hash:a,bytes:c}=await xie(o);return o.hash=a,o.bytes=c,o},xie=async r=>{const{id:e,publicKey:t,signatures:n,type:i}=r,s={id:e,publicKey:t,signatures:n,type:i},{cid:o,bytes:a}=await nd({value:s,codec:JD,hasher:XD});return{hash:o.toString(Sie),bytes:Uint8Array.from(a)}},Aie=async r=>{const{value:e}=await Kg({bytes:r,codec:JD,hasher:XD});return ZD({...e})},Cie=r=>!!(r.id&&r.hash&&r.bytes&&r.publicKey&&r.signatures&&r.signatures.id&&r.signatures.publicKey&&r.type),Iie=(r,e)=>r.id===e.id&&r.hash===e.hash&&r.type===e.type&&r.publicKey===e.publicKey&&r.signatures.id===e.signatures.id&&r.signatures.publicKey===e.signatures.publicKey,e$="publickey",kie=async r=>{const{id:e,publicKey:t,signatures:n}=r;return QD(n.publicKey,e,t+n.id)},Cv=({keystore:r})=>async()=>{if(!r)throw new Error("PublicKeyIdentityProvider requires a keystore parameter");return{type:e$,getId:async({id:n}={})=>{if(!n)throw new Error("id is required");const i=await r.getKey(n)||await r.createKey(n);return re(i.publicKey.raw,"base16")},signIdentity:async(n,{id:i}={})=>{if(!i)throw new Error("id is required");const s=await r.getKey(i);if(!s)throw new Error(`Signing key for '${i}' not found`);return Av(s,n)}}};Cv.verifyIdentity=kie,Cv.type=e$;const Iv={},_ie=r=>Object.keys(Iv).includes(r),kv=r=>{if(!_ie(r))throw new Error(`IdentityProvider type '${r}' is not supported`);return Iv[r]};(r=>{if(!r.type||typeof r.type!="string")throw new Error("Given IdentityProvider doesn't have a field 'type'.");if(!r.verifyIdentity)throw new Error("Given IdentityProvider doesn't have a function 'verifyIdentity'.");Iv[r.type]=r})(Cv);const Tie=Da("./orbitdb","identities"),Pie=async({keystore:r,path:e,storage:t,ipfs:n}={})=>{r=r||await YD({path:e||Tie}),t||(t=n?await ul(await Ds({size:1e3}),await a2({ipfs:n,pin:!0})):await R6());const i=await Ds({size:1e3}),s=async d=>{const h=await t.get(d);if(h)return Aie(h)},o=async(d={})=>{d.keystore=r;const h=kv("publickey"),m=await(d.provider||h({keystore:r}))();if(!kv(m.type))throw new Error("Identity provider is unknown. Use useIdentityProvider(provider) to register the identity provider");const f=await m.getId(d),g=await r.getKey(f)||await r.createKey(f),w=r.getPublic(g),y=await Av(g,f),b=await m.signIdentity(w+y,d),E=await ZD({id:f,publicKey:w,signatures:{id:y,publicKey:b},type:m.type,sign:c,verify:l});return await t.put(E.hash,E.bytes),E},a=async d=>{if(!Cie(d))return!1;const{id:h,publicKey:p,signatures:m}=d;if(!await l(m.id,p,h))return!1;const g=await i.get(m.id);if(g)return Iie(d,g);const y=await kv(d.type).verifyIdentity(d);return y&&await i.put(m.id,d),y},c=async(d,h)=>{const p=await r.getKey(d.id);if(!p)throw new Error("Private signing key not found from KeyStore");return await Av(p,h)},l=async(d,h,p)=>await QD(d,h,p);return{createIdentity:o,verifyIdentity:a,getIdentity:s,sign:c,verify:l,keystore:r}},Die=r=>{if(r=r.toString(),!r.startsWith("/orbitdb")&&!r.startsWith("\\orbitdb"))return!1;r=r.replaceAll("/orbitdb/",""),r=r.replaceAll("\\orbitdb\\",""),r=r.replaceAll("/",""),r=r.replaceAll("\\","");let e;try{e=Yi.parse(r,ln)}catch{return!1}return e!==void 0},t$=r=>{if(r&&r.protocol==="orbitdb"&&r.hash)return r;const e="orbitdb",t=r.replace("/orbitdb/","").replace("\\orbitdb\\","");return{protocol:e,hash:t,address:r,toString:()=>Da("/",e,t)}},r$=Jf,n$=i2,$ie=ln,Nie=async({ipfs:r,storage:e}={})=>(e=e||await ul(await Ds({size:1e5}),await a2({ipfs:r,pin:!0})),{get:async s=>{const o=await e.get(s),{value:a}=await Kg({bytes:o,codec:r$,hasher:n$});return a&&await e.put(s,o),a},create:async({name:s,type:o,accessController:a,meta:c})=>{if(!s)throw new Error("name is required");if(!o)throw new Error("type is required");if(!a)throw new Error("accessController is required");const l=Object.assign({name:s,type:o,accessController:a},c!==void 0?{meta:c}:{}),{cid:d,bytes:h}=await nd({value:l,codec:r$,hasher:n$}),p=d.toString($ie);return await e.put(p,h),{hash:p,manifest:l}},close:async()=>{await e.close()}}),i$=async(r=32)=>{const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";let t="",n=0;for(;n<r;)t+=e.charAt(Math.floor(Math.random()*e.length)),n+=1;return t},s$=Jf,o$=i2,Mie=ln,Oie=async({storage:r,type:e,params:t})=>{const n={type:e,...t},{cid:i,bytes:s}=await nd({value:n,codec:s$,hasher:o$}),o=i.toString(Mie);return await r.put(o,s),o},fy="ipfs",py=({write:r,storage:e}={})=>async({orbitdb:t,identities:n,address:i})=>{if(e=e||await ul(await Ds({size:1e3}),await a2({ipfs:t.ipfs,pin:!0})),r=r||[t.identity.id],i){const o=await e.get(i.replaceAll("/ipfs/","")),{value:a}=await Kg({bytes:o,codec:s$,hasher:o$});r=a.write}else i=await Oie({storage:e,type:fy,params:{write:r}}),i=Da("/",fy,i);return{type:fy,address:i,write:r,canAppend:async o=>{const a=await n.getIdentity(o.identity);if(!a)return!1;const{id:c}=a;return r.includes(c)||r.includes("*")?await n.verifyIdentity(a):!1}}};py.type=fy;const a$="orbitdb",c$=({write:r}={})=>async({orbitdb:e,identities:t,address:n,name:i})=>{n=n||i||await i$(64),r=r||[e.identity.id];const s=await e.open(n,{type:"keyvalue",AccessController:py({write:r})});n=s.address;const o=async f=>{const g=await t.getIdentity(f.identity);if(!g)return!1;const{id:w}=g;return await h("write",w)||await h("admin",w)?await t.verifyIdentity(g):!1},a=async()=>{const f=[];for await(const w of s.iterator())f[w.key]=w.value;const g=w=>{const y=w[0];f[y]=new Set([...f[y]||[],...w[1]])};return Object.entries({...f,admin:new Set([...f.admin||[],...s.access.write])}).forEach(g),f},c=async f=>(await a())[f]||new Set([]),l=async()=>{await s.close()},d=async()=>{await s.drop()},h=async(f,g)=>{const w=new Set(await c(f));return w.has(g)||w.has("*")};return{type:a$,address:n,write:r,canAppend:o,capabilities:a,get:c,grant:async(f,g)=>{const w=new Set([...await s.get(f)||[],g]);await s.put(f,Array.from(w.values()))},revoke:async(f,g)=>{const w=new Set(await s.get(f)||[]);w.delete(g),w.size>0?await s.put(f,Array.from(w.values())):await s.del(f)},close:l,drop:d,events:s.events}};c$.type=a$;const _v={},Rie=r=>{if(!_v[r])throw new Error(`AccessController type '${r}' is not supported`);return _v[r]},l$=r=>{if(!r.type)throw new Error("AccessController does not contain required field 'type'.");_v[r.type]=r};l$(py),l$(c$);const Lie="events",Bie=py,u$=async({ipfs:r,id:e,identity:t,identities:n,directory:i}={})=>{if(r==null)throw new Error("IPFS instance is a required argument.");e=e||await i$();const s=r.libp2p.peerId;i=i||"./orbitdb";let o;n?o=n.keystore:(o=await YD({path:Da(i,"./keystore")}),n=await Pie({ipfs:r,keystore:o})),t?t.provider&&(t=await n.createIdentity({...t})):t=await n.createIdentity({id:e});const a=await Nie({ipfs:r});let c={};const l=async(p,{type:m,meta:f,sync:g,Database:w,AccessController:y,headsStorage:b,entryStorage:v,indexStorage:E,referencesCount:C}={})=>{let k,x,I;if(c[p])return c[p];if(Die(p)){const L=t$(p);x=await a.get(L.hash);const z=x.accessController.split("/",2).pop();y=Rie(z)(),I=await y({orbitdb:{open:l,identity:t,ipfs:r},identities:n,address:x.accessController}),k=x.name,m=m||x.type,f=x.meta}else{m=m||Lie,y=y||Bie(),I=await y({orbitdb:{open:l,identity:t,ipfs:r},identities:n,name:p});const L=await a.create({name:p,type:m,accessController:I.address,meta:f});if(x=L.manifest,p=t$(L.hash),k=x.name,f=x.meta,c[p])return c[p]}if(w=w||TZ(m)(),!w)throw new Error(`Unsupported database type: '${m}'`);p=p.toString();const T=await w({ipfs:r,identity:t,address:p,name:k,access:I,directory:i,meta:f,syncAutomatically:g,headsStorage:b,entryStorage:v,indexStorage:E,referencesCount:C});return T.events.on("close",d(p)),c[p]=T,T},d=p=>()=>{delete c[p]};return{id:e,open:l,stop:async()=>{for(const p of Object.values(c))await p.close();o&&await o.close(),a&&await a.close(),c={}},ipfs:r,directory:i,keystore:o,identities:n,identity:t,peerId:s}};function ft(r){const e=new globalThis.AbortController;function t(){e.abort();for(const s of r)(s==null?void 0:s.removeEventListener)!=null&&s.removeEventListener("abort",t)}for(const s of r){if((s==null?void 0:s.aborted)===!0){t();break}(s==null?void 0:s.addEventListener)!=null&&s.addEventListener("abort",t)}function n(){for(const s of r)(s==null?void 0:s.removeEventListener)!=null&&s.removeEventListener("abort",t)}const i=e.signal;return i.clear=n,i}let Uie=class extends Error{constructor(t,n){super(t??"The operation was aborted");u(this,"type");u(this,"code");this.type="aborted",this.name="AbortError",this.code=n??"ABORT_ERR"}};async function _i(r,e,t,n){const i=new Uie(n==null?void 0:n.errorMessage,n==null?void 0:n.errorCode);return(t==null?void 0:t.aborted)===!0?Promise.reject(i):new Promise((s,o)=>{function a(){t==null||t.removeEventListener("abort",d),r.removeEventListener(e,c),(n==null?void 0:n.errorEvent)!=null&&r.removeEventListener(n.errorEvent,l)}const c=h=>{var p;try{if(((p=n==null?void 0:n.filter)==null?void 0:p.call(n,h))===!1)return}catch(m){a(),o(m);return}a(),s(h)},l=h=>{a(),o(h.detail)},d=()=>{a(),o(i)};t==null||t.addEventListener("abort",d),r.addEventListener(e,c),(n==null?void 0:n.errorEvent)!=null&&r.addEventListener(n.errorEvent,l)})}class Fie extends Error{constructor(t="Rate limit exceeded",n){super(t);u(this,"remainingPoints");u(this,"msBeforeNext");u(this,"consumedPoints");u(this,"isFirstInDuration");this.name="RateLimitError",this.remainingPoints=n.remainingPoints,this.msBeforeNext=n.msBeforeNext,this.consumedPoints=n.consumedPoints,this.isFirstInDuration=n.isFirstInDuration}}class d$ extends Error{constructor(e="The queue was full"){super(e),this.name="QueueFullError"}}u(d$,"name","QueueFullError");class zie{constructor(e){u(this,"deferred");u(this,"signal");var t;this.signal=e,this.deferred=Re(),this.onAbort=this.onAbort.bind(this),(t=this.signal)==null||t.addEventListener("abort",this.onAbort)}onAbort(){var e;this.deferred.reject(((e=this.signal)==null?void 0:e.reason)??new Al)}cleanup(){var e;(e=this.signal)==null||e.removeEventListener("abort",this.onAbort)}}function Vie(){return`${parseInt(String(Math.random()*1e9),10).toString()}${Date.now()}`}class Kie{constructor(e,t){u(this,"id");u(this,"fn");u(this,"options");u(this,"recipients");u(this,"status");u(this,"timeline");u(this,"controller");this.id=Vie(),this.status="queued",this.fn=e,this.options=t,this.recipients=[],this.timeline={created:Date.now()},this.controller=new AbortController,this.controller.signal,this.onAbort=this.onAbort.bind(this)}abort(e){this.controller.abort(e)}onAbort(){this.recipients.reduce((t,n)=>{var i;return t&&((i=n.signal)==null?void 0:i.aborted)===!0},!0)&&(this.controller.abort(new Al),this.cleanup())}async join(e={}){var n;const t=new zie(e.signal);return this.recipients.push(t),(n=e.signal)==null||n.addEventListener("abort",this.onAbort),t.deferred.promise}async run(){this.status="running",this.timeline.started=Date.now();try{this.controller.signal.throwIfAborted();const e=await an(this.fn({...this.options??{},signal:this.controller.signal}),this.controller.signal);this.recipients.forEach(t=>{t.deferred.resolve(e)}),this.status="complete"}catch(e){this.recipients.forEach(t=>{t.deferred.reject(e)}),this.status="errored"}finally{this.timeline.finished=Date.now(),this.cleanup()}}cleanup(){this.recipients.forEach(e=>{var t;e.cleanup(),(t=e.signal)==null||t.removeEventListener("abort",this.onAbort)})}}class Ml extends er{constructor(t={}){var n;super();u(this,"concurrency");u(this,"maxSize");u(this,"queue");u(this,"pending");u(this,"sort");this.concurrency=t.concurrency??Number.POSITIVE_INFINITY,this.maxSize=t.maxSize??Number.POSITIVE_INFINITY,this.pending=0,t.metricName!=null&&((n=t.metrics)==null||n.registerMetricGroup(t.metricName,{calculate:()=>({size:this.queue.length,running:this.pending,queued:this.queue.length-this.pending})})),this.sort=t.sort,this.queue=[]}tryToStartAnother(){if(this.size===0)return queueMicrotask(()=>{this.safeDispatchEvent("empty")}),this.running===0&&queueMicrotask(()=>{this.safeDispatchEvent("idle")}),!1;if(this.pending<this.concurrency){let t;for(const n of this.queue)if(n.status==="queued"){t=n;break}return t==null?!1:(this.safeDispatchEvent("active"),this.pending++,t.run().finally(()=>{for(let n=0;n<this.queue.length;n++)if(this.queue[n]===t){this.queue.splice(n,1);break}this.pending--,this.tryToStartAnother(),this.safeDispatchEvent("next")}),!0)}return!1}enqueue(t){this.queue.push(t),this.sort!=null&&this.queue.sort(this.sort)}async add(t,n){var s;if((s=n==null?void 0:n.signal)==null||s.throwIfAborted(),this.size===this.maxSize)throw new d$;const i=new Kie(t,n);return this.enqueue(i),this.safeDispatchEvent("add"),this.tryToStartAnother(),i.join(n).then(o=>(this.safeDispatchEvent("completed",{detail:o}),this.safeDispatchEvent("success",{detail:{job:i,result:o}}),o)).catch(o=>{if(i.status==="queued"){for(let a=0;a<this.queue.length;a++)if(this.queue[a]===i){this.queue.splice(a,1);break}}throw this.safeDispatchEvent("error",{detail:o}),this.safeDispatchEvent("failure",{detail:{job:i,error:o}}),o})}clear(){this.queue.splice(0,this.queue.length)}abort(){this.queue.forEach(t=>{t.abort(new Al)}),this.clear()}async onEmpty(t){this.size!==0&&await _i(this,"empty",t==null?void 0:t.signal)}async onSizeLessThan(t,n){this.size<t||await _i(this,"next",n==null?void 0:n.signal,{filter:()=>this.size<t})}async onIdle(t){this.pending===0&&this.size===0||await _i(this,"idle",t==null?void 0:t.signal)}get size(){return this.queue.length}get queued(){return this.queue.length-this.pending}get running(){return this.pending}async*toGenerator(t){var l,d,h;(l=t==null?void 0:t.signal)==null||l.throwIfAborted();const n=ho({objectMode:!0}),i=p=>{p!=null?this.abort():this.clear(),n.end(p)},s=p=>{p.detail!=null&&n.push(p.detail)},o=p=>{i(p.detail)},a=()=>{i()},c=()=>{i(new Al("Queue aborted"))};this.addEventListener("completed",s),this.addEventListener("error",o),this.addEventListener("idle",a),(d=t==null?void 0:t.signal)==null||d.addEventListener("abort",c);try{yield*n}finally{this.removeEventListener("completed",s),this.removeEventListener("error",o),this.removeEventListener("idle",a),(h=t==null?void 0:t.signal)==null||h.removeEventListener("abort",c),i()}}}class ic extends Ml{has(e){return this.find(e)!=null}find(e){return this.queue.find(t=>e.equals(t.options.peerId))}}const jie=8,Tv=1024*1024*4;let Hie=class extends Error{constructor(){super(...arguments);u(this,"name","InvalidMessageLengthError");u(this,"code","ERR_INVALID_MSG_LENGTH")}},h$=class extends Error{constructor(){super(...arguments);u(this,"name","InvalidDataLengthError");u(this,"code","ERR_MSG_DATA_TOO_LONG")}},qie=class extends Error{constructor(){super(...arguments);u(this,"name","InvalidDataLengthLengthError");u(this,"code","ERR_MSG_LENGTH_TOO_LONG")}},f$=class extends Error{constructor(){super(...arguments);u(this,"name","UnexpectedEOFError");u(this,"code","ERR_UNEXPECTED_EOF")}};function p$(r){return r[Symbol.asyncIterator]!=null}function g$(r,e){if(r.byteLength>e)throw new h$("Message length too long")}const gy=r=>{const e=gt(r),t=Cn(e);return Er(r,t),gy.bytes=e,t};gy.bytes=0;function Od(r,e){e=e??{};const t=e.lengthEncoder??gy,n=(e==null?void 0:e.maxDataLength)??Tv;function*i(s){g$(s,n);const o=t(s.byteLength);o instanceof Uint8Array?yield o:yield*o,s instanceof Uint8Array?yield s:yield*s}return p$(r)?async function*(){for await(const s of r)yield*i(s)}():function*(){for(const s of r)yield*i(s)}()}Od.single=(r,e)=>{e=e??{};const t=e.lengthEncoder??gy,n=(e==null?void 0:e.maxDataLength)??Tv;return g$(r,n),new Le(t(r.byteLength),r)};var Ol;(function(r){r[r.LENGTH=0]="LENGTH",r[r.DATA=1]="DATA"})(Ol||(Ol={}));const Pv=r=>{const e=Zi(r);return Pv.bytes=gt(e),e};Pv.bytes=0;function Rd(r,e){const t=new Le;let n=Ol.LENGTH,i=-1;const s=(e==null?void 0:e.lengthDecoder)??Pv,o=(e==null?void 0:e.maxLengthLength)??jie,a=(e==null?void 0:e.maxDataLength)??Tv;function*c(){for(;t.byteLength>0;){if(n===Ol.LENGTH)try{if(i=s(t),i<0)throw new Hie("Invalid message length");if(i>a)throw new h$("Message length too long");const l=s.bytes;t.consume(l),(e==null?void 0:e.onLength)!=null&&e.onLength(i),n=Ol.DATA}catch(l){if(l instanceof RangeError){if(t.byteLength>o)throw new qie("Message length length too long");break}throw l}if(n===Ol.DATA){if(t.byteLength<i)break;const l=t.sublist(0,i);t.consume(i),(e==null?void 0:e.onData)!=null&&e.onData(l),yield l,n=Ol.LENGTH}}}return p$(r)?async function*(){for await(const l of r)t.append(l),yield*c();if(t.byteLength>0)throw new f$("Unexpected end of input")}():function*(){for(const l of r)t.append(l),yield*c();if(t.byteLength>0)throw new f$("Unexpected end of input")}()}Rd.fromReader=(r,e)=>{let t=1;const n=async function*(){for(;;)try{const{done:s,value:o}=await r.next(t);if(s===!0)return;o!=null&&(yield o)}catch(s){if(s.code==="ERR_UNDER_READ")return{done:!0,value:null};throw s}finally{t=1}}();return Rd(n,{...e??{},onLength:s=>{t=s}})};function Dv(r){const[e,t]=r[Symbol.asyncIterator]!=null?[r[Symbol.asyncIterator](),Symbol.asyncIterator]:[r[Symbol.iterator](),Symbol.iterator],n=[];return{peek:()=>e.next(),push:i=>{n.push(i)},next:()=>n.length>0?{done:!1,value:n.shift()}:e.next(),[t](){return this}}}function Wie(r){return r[Symbol.asyncIterator]!=null}function Ld(r,e){let t=0;if(Wie(r))return async function*(){for await(const c of r)yield e(c,t++)}();const n=Dv(r),{value:i,done:s}=n.next();if(s===!0)return function*(){}();const o=e(i,t++);if(typeof o.then=="function")return async function*(){yield await o;for await(const c of n)yield e(c,t++)}();const a=e;return function*(){yield o;for(const c of n)yield a(c,t++)}()}function Gie(r){return r[Symbol.asyncIterator]!=null}function yy(r,e){return Gie(r)?async function*(){let t=0;if(!(e<1)){for await(const n of r)if(yield n,t++,t===e)return}}():function*(){let t=0;if(!(e<1)){for(const n of r)if(yield n,t++,t===e)return}}()}class ke extends Event{constructor(t,n){super(t);u(this,"type");u(this,"detail");this.type=t,this.detail=n}}const my="/ipfs/bitswap/1.2.0",Qie=1024,Yie=1024,Jie=1024,Xie=5e3,Zie=10,ese=50,tse=!1,rse=3,y$=1024*1024*4,nse=y$;var fr;(function(r){r.WantBlock="WantBlock",r.WantHave="WantHave"})(fr||(fr={}));var $v;(function(r){r[r.WantBlock=0]="WantBlock",r[r.WantHave=1]="WantHave"})($v||($v={})),function(r){r.codec=()=>In($v)}(fr||(fr={}));var P1;(function(r){let e;r.codec=()=>(e==null&&(e=De((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.cid!=null&&t.cid.byteLength>0&&(n.uint32(10),n.bytes(t.cid)),t.priority!=null&&t.priority!==0&&(n.uint32(16),n.int32(t.priority)),t.cancel!=null&&(n.uint32(24),n.bool(t.cancel)),t.wantType!=null&&(n.uint32(32),fr.codec().encode(t.wantType,n)),t.sendDontHave!=null&&(n.uint32(40),n.bool(t.sendDontHave)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{const s={cid:We(0),priority:0},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.cid=t.bytes();break}case 2:{s.priority=t.int32();break}case 3:{s.cancel=t.bool();break}case 4:{s.wantType=fr.codec().decode(t);break}case 5:{s.sendDontHave=t.bool();break}default:{t.skipType(a&7);break}}}return s})),e),r.encode=t=>Pe(t,r.codec()),r.decode=(t,n)=>Te(t,r.codec(),n)})(P1||(P1={}));var wy;(function(r){let e;r.codec=()=>(e==null&&(e=De((t,n,i={})=>{if(i.lengthDelimited!==!1&&n.fork(),t.entries!=null)for(const s of t.entries)n.uint32(10),P1.codec().encode(s,n);t.full!=null&&(n.uint32(16),n.bool(t.full)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{var a,c;const s={entries:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{if(((a=i.limits)==null?void 0:a.entries)!=null&&s.entries.length===i.limits.entries)throw new yt('Decode error - map field "entries" had too many elements');s.entries.push(P1.codec().decode(t,t.uint32(),{limits:(c=i.limits)==null?void 0:c.entries$}));break}case 2:{s.full=t.bool();break}default:{t.skipType(l&7);break}}}return s})),e),r.encode=t=>Pe(t,r.codec()),r.decode=(t,n)=>Te(t,r.codec(),n)})(wy||(wy={}));var D1;(function(r){let e;r.codec=()=>(e==null&&(e=De((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.prefix!=null&&t.prefix.byteLength>0&&(n.uint32(10),n.bytes(t.prefix)),t.data!=null&&t.data.byteLength>0&&(n.uint32(18),n.bytes(t.data)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{const s={prefix:We(0),data:We(0)},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.prefix=t.bytes();break}case 2:{s.data=t.bytes();break}default:{t.skipType(a&7);break}}}return s})),e),r.encode=t=>Pe(t,r.codec()),r.decode=(t,n)=>Te(t,r.codec(),n)})(D1||(D1={}));var Bs;(function(r){r.HaveBlock="HaveBlock",r.DoNotHaveBlock="DoNotHaveBlock"})(Bs||(Bs={}));var by;(function(r){r[r.HaveBlock=0]="HaveBlock",r[r.DoNotHaveBlock=1]="DoNotHaveBlock"})(by||(by={})),function(r){r.codec=()=>In(by)}(Bs||(Bs={}));var $1;(function(r){let e;r.codec=()=>(e==null&&(e=De((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.cid!=null&&t.cid.byteLength>0&&(n.uint32(10),n.bytes(t.cid)),t.type!=null&&by[t.type]!==0&&(n.uint32(16),Bs.codec().encode(t.type,n)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{const s={cid:We(0),type:Bs.HaveBlock},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.cid=t.bytes();break}case 2:{s.type=Bs.codec().decode(t);break}default:{t.skipType(a&7);break}}}return s})),e),r.encode=t=>Pe(t,r.codec()),r.decode=(t,n)=>Te(t,r.codec(),n)})($1||($1={}));var N1;(function(r){let e;r.codec=()=>(e==null&&(e=De((t,n,i={})=>{if(i.lengthDelimited!==!1&&n.fork(),t.wantlist!=null&&(n.uint32(10),wy.codec().encode(t.wantlist,n)),t.blocks!=null)for(const s of t.blocks)n.uint32(26),D1.codec().encode(s,n);if(t.blockPresences!=null)for(const s of t.blockPresences)n.uint32(34),$1.codec().encode(s,n);t.pendingBytes!=null&&t.pendingBytes!==0&&(n.uint32(40),n.int32(t.pendingBytes)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{var a,c,l,d,h;const s={blocks:[],blockPresences:[],pendingBytes:0},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const p=t.uint32();switch(p>>>3){case 1:{s.wantlist=wy.codec().decode(t,t.uint32(),{limits:(a=i.limits)==null?void 0:a.wantlist});break}case 3:{if(((c=i.limits)==null?void 0:c.blocks)!=null&&s.blocks.length===i.limits.blocks)throw new yt('Decode error - map field "blocks" had too many elements');s.blocks.push(D1.codec().decode(t,t.uint32(),{limits:(l=i.limits)==null?void 0:l.blocks$}));break}case 4:{if(((d=i.limits)==null?void 0:d.blockPresences)!=null&&s.blockPresences.length===i.limits.blockPresences)throw new yt('Decode error - map field "blockPresences" had too many elements');s.blockPresences.push($1.codec().decode(t,t.uint32(),{limits:(h=i.limits)==null?void 0:h.blockPresences$}));break}case 5:{s.pendingBytes=t.int32();break}default:{t.skipType(p&7);break}}}return s})),e),r.encode=t=>Pe(t,r.codec()),r.decode=(t,n)=>Te(t,r.codec(),n)})(N1||(N1={}));function ise(r,e){for(const[t,n]of e.wantlist.entries()){const i=r.wantlist.get(t);i!=null&&(i.priority>n.priority&&(n.priority=i.priority),n.cancel=n.cancel??i.cancel,n.wantType=n.wantType??i.wantType,n.sendDontHave=n.sendDontHave??i.sendDontHave),r.wantlist.set(t,n)}for(const[t,n]of e.blockPresences.entries())r.blockPresences.set(t,n);for(const[t,n]of e.blocks.entries())r.blocks.set(t,n);return e.full&&!r.full&&(r.full=!0),r}class m$ extends Error{constructor(e="Block too large"){super(e),this.name="BlockTooLargeError"}}u(m$,"name","BlockTooLargeError");const sse=4193648+16;function*ose(r,e){const t=[...r.wantlist.values()],n=[...r.blockPresences.values()],i=[...r.blocks.values()];let s=0,o=0,a=0,c=!1;for(;;){const l={wantlist:{full:r.full??!1,entries:[]},blockPresences:[],blocks:[],pendingBytes:0};let d=N1.encode(l).byteLength,{added:h,hasMore:p,newSize:m}=Nv(i,l.blocks,a,e,d,ase);a+=h,d=m;const f=p;({added:h,hasMore:p,newSize:m}=Nv(n,l.blockPresences,o,e,d,cse)),o+=h,d=m;const g=p;if({added:h,hasMore:p,newSize:m}=Nv(t,l.wantlist.entries,s,e,d,lse),s+=h,d=m,c=!f&&!g&&!p,c||(l.wantlist.full=!1),yield N1.encode(l),c)break}}function Nv(r,e,t,n,i,s){let o=0,a=!1;for(let c=t;c<r.length;c++){const l=r[c],d=s(l);if(d>sse)throw new m$("Cannot send block as after encoding it is over the max message size");const h=i+d;if(h>n){a=!0;break}e.push(l),o++,i=h}return{hasMore:a,added:o,newSize:i}}function ase(r){return Mv(3,D1.encode(r))}function cse(r){return Mv(4,$1.encode(r))}function lse(r){return Mv(1,P1.encode(r))}function Mv(r,e){const t=gt(r),n=gt(e.byteLength);return t+n+e.byteLength}let use=class extends er{constructor(t,n={}){var i,s;super();u(this,"log");u(this,"libp2p");u(this,"routing");u(this,"protocols");u(this,"running");u(this,"maxInboundStreams");u(this,"maxOutboundStreams");u(this,"messageReceiveTimeout");u(this,"registrarIds");u(this,"metrics");u(this,"sendQueue");u(this,"runOnLimitedConnections");u(this,"maxOutgoingMessageSize");u(this,"maxIncomingMessageSize");this.log=t.logger.forComponent("helia:bitswap:network"),this.libp2p=t.libp2p,this.routing=t.routing,this.protocols=n.protocols??[my],this.registrarIds=[],this.running=!1,this._onStream=this._onStream.bind(this),this.maxInboundStreams=n.maxInboundStreams??Yie,this.maxOutboundStreams=n.maxOutboundStreams??Jie,this.messageReceiveTimeout=n.messageReceiveTimeout??Xie,this.runOnLimitedConnections=n.runOnLimitedConnections??tse,this.maxIncomingMessageSize=n.maxIncomingMessageSize??y$,this.maxOutgoingMessageSize=n.maxOutgoingMessageSize??n.maxIncomingMessageSize??nse,this.metrics={blocksSent:(i=t.metrics)==null?void 0:i.registerCounter("helia_bitswap_sent_blocks_total"),dataSent:(s=t.metrics)==null?void 0:s.registerCounter("helia_bitswap_sent_data_bytes_total")},this.sendQueue=new ic({concurrency:n.messageSendConcurrency??ese,metrics:t.metrics,metricName:"helia_bitswap_message_send_queue"}),this.sendQueue.addEventListener("error",o=>{this.log.error("error sending wantlist to peer",o.detail)})}async start(){if(this.running)return;this.running=!0,await this.libp2p.handle(this.protocols,this._onStream,{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:this.runOnLimitedConnections});const t={onConnect:n=>{this.safeDispatchEvent("peer:connected",{detail:n})},onDisconnect:n=>{this.safeDispatchEvent("peer:disconnected",{detail:n})}};this.registrarIds=[];for(const n of this.protocols)this.registrarIds.push(await this.libp2p.register(n,t));this.libp2p.getConnections().forEach(n=>{this.safeDispatchEvent("peer:connected",{detail:n.remotePeer})})}async stop(){if(this.running=!1,await this.libp2p.unhandle(this.protocols),this.registrarIds!=null){for(const t of this.registrarIds)this.libp2p.unregister(t);this.registrarIds=[]}}_onStream(t){if(!this.running)return;const{stream:n,connection:i}=t;Promise.resolve().then(async()=>{this.log("incoming new bitswap %s stream from %p",n.protocol,i.remotePeer);const s=()=>{n.status==="open"?n.abort(new f1(`Incoming Bitswap stream timed out after ${this.messageReceiveTimeout}ms`)):this.log("stream aborted with status %s",n.status)};let o=AbortSignal.timeout(this.messageReceiveTimeout);o.addEventListener("abort",s),await n.closeWrite(),await cn(n,a=>Rd(a,{maxDataLength:this.maxIncomingMessageSize}),async a=>{for await(const c of a)try{const l=N1.decode(c);this.log("incoming new bitswap %s message from %p on stream",n.protocol,i.remotePeer,n.id),this.safeDispatchEvent("bitswap:message",{detail:{peer:i.remotePeer,message:l}}),o.removeEventListener("abort",s),o=AbortSignal.timeout(this.messageReceiveTimeout),o.addEventListener("abort",s)}catch(l){this.log.error("error reading incoming bitswap message from %p on stream",i.remotePeer,n.id,l),n.abort(l);break}})}).catch(s=>{this.log.error("error handling incoming stream from %p",i.remotePeer,s),n.abort(s)})}async*findProviders(t,n){var i;(i=n==null?void 0:n.onProgress)==null||i.call(n,new ke("bitswap:network:find-providers",t));for await(const s of this.routing.findProviders(t,n))await this.libp2p.isDialable(s.multiaddrs,{runOnLimitedConnection:this.runOnLimitedConnections})&&(yield s)}async findAndConnect(t,n){await mo(Ld(yy(this.findProviders(t,n),(n==null?void 0:n.maxProviders)??rse),async i=>this.connectTo(i.id,n))).catch(i=>{this.log.error(i)})}async sendMessage(t,n,i){if(!this.running)throw new Error("network isn't running");const s=this.sendQueue.queue.find(o=>t.equals(o.options.peerId)&&o.status==="queued");if(s!=null){s.options.message=ise(s.options.message,n),await s.join({signal:i==null?void 0:i.signal});return}await this.sendQueue.add(async o=>{var l,d;const a=o==null?void 0:o.message;if(a==null)throw new Z("No message to send");this.log("sendMessage to %p",t),(l=o==null?void 0:o.onProgress)==null||l.call(o,new ke("bitswap:network:send-wantlist",t));const c=await this.libp2p.dialProtocol(t,my,o);await c.closeRead();try{await cn(ose(a,this.maxOutgoingMessageSize),h=>Od(h),c),await c.close(o)}catch(h){(d=o==null?void 0:o.onProgress)==null||d.call(o,new ke("bitswap:network:send-wantlist:error",{peer:t,error:h})),this.log.error("error sending message to %p",t,h),c.abort(h)}this._updateSentStats(a.blocks)},{peerId:t,signal:i==null?void 0:i.signal,message:n})}async connectTo(t,n){var s;if(!this.running)throw new Il("Network isn't running");(s=n==null?void 0:n.onProgress)==null||s.call(n,new ke("bitswap:network:dial",t));const[i]=await Promise.all([this.libp2p.dial(t,n),_i(this.libp2p,"peer:identify",n==null?void 0:n.signal,{filter:o=>{if(!o.detail.peerId.equals(t))return!1;if(o.detail.protocols.includes(my))return!0;throw new h1(`${t} did not support ${my}`)}})]);return i}_updateSentStats(t){var i,s;let n=0;for(const o of t.values())n+=o.data.byteLength;(i=this.metrics.dataSent)==null||i.increment(n),(s=this.metrics.blocksSent)==null||s.increment(t.size)}};function dse(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function vy(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function hse(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var i=0;i<r.length;i++){var s=r.charAt(i),o=s.charCodeAt(0);if(t[o]!==255)throw new TypeError(s+" is ambiguous");t[o]=i}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),d=Math.log(256)/Math.log(a);function h(f){if(f instanceof Uint8Array||(ArrayBuffer.isView(f)?f=new Uint8Array(f.buffer,f.byteOffset,f.byteLength):Array.isArray(f)&&(f=Uint8Array.from(f))),!(f instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(f.length===0)return"";for(var g=0,w=0,y=0,b=f.length;y!==b&&f[y]===0;)y++,g++;for(var v=(b-y)*d+1>>>0,E=new Uint8Array(v);y!==b;){for(var C=f[y],k=0,x=v-1;(C!==0||k<w)&&x!==-1;x--,k++)C+=256*E[x]>>>0,E[x]=C%a>>>0,C=C/a>>>0;if(C!==0)throw new Error("Non-zero carry");w=k,y++}for(var I=v-w;I!==v&&E[I]===0;)I++;for(var T=c.repeat(g);I<v;++I)T+=r.charAt(E[I]);return T}function p(f){if(typeof f!="string")throw new TypeError("Expected String");if(f.length===0)return new Uint8Array;var g=0;if(f[g]!==" "){for(var w=0,y=0;f[g]===c;)w++,g++;for(var b=(f.length-g)*l+1>>>0,v=new Uint8Array(b);f[g];){var E=t[f.charCodeAt(g)];if(E===255)return;for(var C=0,k=b-1;(E!==0||C<y)&&k!==-1;k--,C++)E+=a*v[k]>>>0,v[k]=E%256>>>0,E=E/256>>>0;if(E!==0)throw new Error("Non-zero carry");y=C,g++}if(f[g]!==" "){for(var x=b-y;x!==b&&v[x]===0;)x++;for(var I=new Uint8Array(w+(b-x)),T=w;x!==b;)I[T++]=v[x++];return I}}}function m(f){var g=p(f);if(g)return g;throw new Error(`Non-${e} character`)}return{encode:h,decodeUnsafe:p,decode:m}}var fse=hse,pse=fse;let gse=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseEncode");this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},yse=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseDecode");u(this,"prefixCodePoint");this.name=e,this.prefix=t;const i=t.codePointAt(0);if(i===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=i,this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return w$(this,e)}},mse=class{constructor(e){u(this,"decoders");this.decoders=e}or(e){return w$(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};function w$(r,e){return new mse({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}let wse=class{constructor(e,t,n,i){u(this,"name");u(this,"prefix");u(this,"baseEncode");u(this,"baseDecode");u(this,"encoder");u(this,"decoder");this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=i,this.encoder=new gse(e,t,n),this.decoder=new yse(e,t,i)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};function b$({name:r,prefix:e,encode:t,decode:n}){return new wse(r,e,t,n)}function Ey({name:r,prefix:e,alphabet:t}){const{encode:n,decode:i}=pse(t,r);return b$({prefix:e,name:r,encode:n,decode:s=>vy(i(s))})}function bse(r,e,t,n){const i={};for(let d=0;d<e.length;++d)i[e[d]]=d;let s=r.length;for(;r[s-1]==="=";)--s;const o=new Uint8Array(s*t/8|0);let a=0,c=0,l=0;for(let d=0;d<s;++d){const h=i[r[d]];if(h===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|h,a+=t,a>=8&&(a-=8,o[l++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o}function vse(r,e,t){const n=e[e.length-1]==="=",i=(1<<t)-1;let s="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,s+=e[i&a>>o];if(o!==0&&(s+=e[i&a<<t-o]),n)for(;s.length*t&7;)s+="=";return s}function Po({name:r,prefix:e,bitsPerChar:t,alphabet:n}){return b$({prefix:e,name:r,encode(i){return vse(i,n,t)},decode(i){return bse(i,n,t,r)}})}const Us=Ey({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});Ey({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});const Sy=Po({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});Po({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),Po({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),Po({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),Po({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),Po({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),Po({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),Po({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),Po({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const Ov=Ey({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"});Ey({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});var Ese=E$,v$=128,Sse=-128,xse=Math.pow(2,31);function E$(r,e,t){e=e||[],t=t||0;for(var n=t;r>=xse;)e[t++]=r&255|v$,r/=128;for(;r&Sse;)e[t++]=r&255|v$,r>>>=7;return e[t]=r|0,E$.bytes=t-n+1,e}var Ase=Rv,Cse=128,S$=127;function Rv(r,n){var t=0,n=n||0,i=0,s=n,o,a=r.length;do{if(s>=a)throw Rv.bytes=0,new RangeError("Could not decode varint");o=r[s++],t+=i<28?(o&S$)<<i:(o&S$)*Math.pow(2,i),i+=7}while(o>=Cse);return Rv.bytes=s-n,t}var Ise=Math.pow(2,7),kse=Math.pow(2,14),_se=Math.pow(2,21),Tse=Math.pow(2,28),Pse=Math.pow(2,35),Dse=Math.pow(2,42),$se=Math.pow(2,49),Nse=Math.pow(2,56),Mse=Math.pow(2,63),Ose=function(r){return r<Ise?1:r<kse?2:r<_se?3:r<Tse?4:r<Pse?5:r<Dse?6:r<$se?7:r<Nse?8:r<Mse?9:10},Rse={encode:Ese,decode:Ase,encodingLength:Ose},xy=Rse;function Lv(r,e=0){return[xy.decode(r,e),xy.decode.bytes]}function Ay(r,e,t=0){return xy.encode(r,e,t),e}function Cy(r){return xy.encodingLength(r)}function Iy(r,e){const t=e.byteLength,n=Cy(r),i=n+Cy(t),s=new Uint8Array(i+t);return Ay(r,s,0),Ay(t,s,n),s.set(e,i),new Bv(r,t,e,s)}function x$(r){const e=vy(r),[t,n]=Lv(e),[i,s]=Lv(e.subarray(n)),o=e.subarray(n+s);if(o.byteLength!==i)throw new Error("Incorrect length");return new Bv(t,i,o,e)}function Lse(r,e){if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&dse(r.bytes,t.bytes)}}let Bv=class{constructor(e,t,n,i){u(this,"code");u(this,"size");u(this,"digest");u(this,"bytes");this.code=e,this.size=t,this.digest=n,this.bytes=i}};function A$(r,e){const{bytes:t,version:n}=r;switch(n){case 0:return Use(t,Uv(r),e??Us.encoder);default:return Fse(t,Uv(r),e??Sy.encoder)}}const C$=new WeakMap;function Uv(r){const e=C$.get(r);if(e==null){const t=new Map;return C$.set(r,t),t}return e}let Fv=class Hr{constructor(e,t,n,i){u(this,"code");u(this,"version");u(this,"multihash");u(this,"bytes");u(this,"/");u(this,Aj,"CID");this.code=t,this.version=e,this.multihash=n,this.bytes=i,this["/"]=i}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==M1)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==zse)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return Hr.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=Iy(e,t);return Hr.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return Hr.equals(this,e)}static equals(e,t){const n=t;return n!=null&&e.code===n.code&&e.version===n.version&&Lse(e.multihash,n.multihash)}toString(e){return A$(this,e)}toJSON(){return{"/":A$(this)}}link(){return this}[(Aj=Symbol.toStringTag,Symbol.for("nodejs.util.inspect.custom"))](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof Hr)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:i,multihash:s,bytes:o}=t;return new Hr(n,i,s,o??I$(n,i,s.bytes))}else if(t[Vse]===!0){const{version:n,multihash:i,code:s}=t,o=x$(i);return Hr.create(n,s,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==M1)throw new Error(`Version 0 CID must use dag-pb (code: ${M1}) block encoding`);return new Hr(e,t,n,n.bytes)}case 1:{const i=I$(e,t,n.bytes);return new Hr(e,t,n,i)}default:throw new Error("Invalid version")}}static createV0(e){return Hr.create(0,M1,e)}static createV1(e,t){return Hr.create(1,e,t)}static decode(e){const[t,n]=Hr.decodeFirst(e);if(n.length!==0)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=Hr.inspectBytes(e),n=t.size-t.multihashSize,i=vy(e.subarray(n,n+t.multihashSize));if(i.byteLength!==t.multihashSize)throw new Error("Incorrect length");const s=i.subarray(t.multihashSize-t.digestSize),o=new Bv(t.multihashCode,t.digestSize,s,i);return[t.version===0?Hr.createV0(o):Hr.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[h,p]=Lv(e.subarray(t));return t+=p,h};let i=n(),s=M1;if(i===18?(i=0,t=0):s=n(),i!==0&&i!==1)throw new RangeError(`Invalid CID version ${i}`);const o=t,a=n(),c=n(),l=t+c,d=l-o;return{version:i,codec:s,multihashCode:a,digestSize:c,multihashSize:d,size:l}}static parse(e,t){const[n,i]=Bse(e,t),s=Hr.decode(i);if(s.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return Uv(s).set(n,e),s}};function Bse(r,e){switch(r[0]){case"Q":{const t=e??Us;return[Us.prefix,t.decode(`${Us.prefix}${r}`)]}case Us.prefix:{const t=e??Us;return[Us.prefix,t.decode(r)]}case Sy.prefix:{const t=e??Sy;return[Sy.prefix,t.decode(r)]}case Ov.prefix:{const t=e??Ov;return[Ov.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}}function Use(r,e,t){const{prefix:n}=t;if(n!==Us.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const i=e.get(n);if(i==null){const s=t.encode(r).slice(1);return e.set(n,s),s}else return i}function Fse(r,e,t){const{prefix:n}=t,i=e.get(n);if(i==null){const s=t.encode(r);return e.set(n,s),s}else return i}const M1=112,zse=18;function I$(r,e,t){const n=Cy(r),i=n+Cy(e),s=new Uint8Array(i+t.byteLength);return Ay(r,s,0),Ay(e,s,n),s.set(t,i),s}const Vse=Symbol.for("@ipld/js-cid/CID"),k$=0,Kse="identity",_$=vy;function jse(r){return Iy(k$,_$(r))}const T$={code:k$,name:Kse,encode:_$,digest:jse};function Hse({name:r,code:e,encode:t}){return new qse(r,e,t)}let qse=class{constructor(e,t,n){u(this,"name");u(this,"code");u(this,"encode");this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?Iy(this.code,t):t.then(n=>Iy(this.code,n))}else throw Error("Unknown type, must be binary type")}};function Wse(r){return async e=>new Uint8Array(await crypto.subtle.digest(r,e))}const Gse=Hse({name:"sha2-256",code:18,encode:Wse("SHA-256")}),P$=Symbol.for("nodejs.util.inspect.custom"),Qse=114;class zv{constructor(e){u(this,"type");u(this,"multihash");u(this,"publicKey");u(this,"string");u(this,Cj,!0);this.type=e.type,this.multihash=e.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}toString(){return this.string==null&&(this.string=Us.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return Fv.createV1(Qse,this.multihash)}toJSON(){return this.toString()}equals(e){var t;if(e==null)return!1;if(e instanceof Uint8Array)return qe(this.multihash.bytes,e);if(typeof e=="string")return this.toString()===e;if(((t=e==null?void 0:e.toMultihash())==null?void 0:t.bytes)!=null)return qe(this.multihash.bytes,e.toMultihash().bytes);throw new Error("not valid Id")}[(Cj=bb,P$)](){return`PeerId(${this.toString()})`}}class D$ extends zv{constructor(t){super({...t,type:"RSA"});u(this,"type","RSA");u(this,"publicKey");this.publicKey=t.publicKey}}class $$ extends zv{constructor(t){super({...t,type:"Ed25519"});u(this,"type","Ed25519");u(this,"publicKey");this.publicKey=t.publicKey}}class N$ extends zv{constructor(t){super({...t,type:"secp256k1"});u(this,"type","secp256k1");u(this,"publicKey");this.publicKey=t.publicKey}}const Yse=2336;class M${constructor(e){u(this,"type","url");u(this,"multihash");u(this,"publicKey");u(this,"url");u(this,Ij,!0);this.url=e.toString(),this.multihash=T$.digest(ie(this.url))}[(kj=P$,Ij=bb,kj)](){return`PeerId(${this.url})`}toString(){return this.toCID().toString()}toMultihash(){return this.multihash}toCID(){return Fv.createV1(Yse,this.toMultihash())}toJSON(){return this.toString()}equals(e){return e==null?!1:(e instanceof Uint8Array&&(e=re(e)),e.toString()===this.toString())}}const Jse=114,O$=2336;function tr(r,e){let t;if(r.charAt(0)==="1"||r.charAt(0)==="Q")t=x$(Us.decode(`z${r}`));else{if(r.startsWith("k51qzi5uqu5")||r.startsWith("kzwfwjn5ji4")||r.startsWith("k2k4r8")||r.startsWith("bafz"))return Ud(Fv.parse(r));throw new Z('Please pass a multibase decoder for strings that do not start with "1" or "Q"')}return ei(t)}function Bd(r){if(r.type==="Ed25519")return new $$({multihash:r.toCID().multihash,publicKey:r});if(r.type==="secp256k1")return new N$({multihash:r.toCID().multihash,publicKey:r});if(r.type==="RSA")return new D$({multihash:r.toCID().multihash,publicKey:r});throw new kl}function Xse(r){return Bd(r.publicKey)}function ei(r){if(eoe(r))return new D$({multihash:r});if(Zse(r))try{const e=WD(r);if(e.type==="Ed25519")return new $$({multihash:r,publicKey:e});if(e.type==="secp256k1")return new N$({multihash:r,publicKey:e})}catch{const t=re(r.digest);return new M$(new URL(t))}throw new N2("Supplied PeerID Multihash is invalid")}function Ud(r){if((r==null?void 0:r.multihash)==null||r.version==null||r.version===1&&r.code!==Jse&&r.code!==O$)throw new aP("Supplied PeerID CID is invalid");if(r.code===O$){const e=re(r.multihash.digest);return new M$(new URL(e))}return ei(r.multihash)}function Zse(r){return r.code===T$.code}function eoe(r){return r.code===Gse.code}function R$(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function toe(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var i=0;i<r.length;i++){var s=r.charAt(i),o=s.charCodeAt(0);if(t[o]!==255)throw new TypeError(s+" is ambiguous");t[o]=i}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),d=Math.log(256)/Math.log(a);function h(f){if(f instanceof Uint8Array||(ArrayBuffer.isView(f)?f=new Uint8Array(f.buffer,f.byteOffset,f.byteLength):Array.isArray(f)&&(f=Uint8Array.from(f))),!(f instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(f.length===0)return"";for(var g=0,w=0,y=0,b=f.length;y!==b&&f[y]===0;)y++,g++;for(var v=(b-y)*d+1>>>0,E=new Uint8Array(v);y!==b;){for(var C=f[y],k=0,x=v-1;(C!==0||k<w)&&x!==-1;x--,k++)C+=256*E[x]>>>0,E[x]=C%a>>>0,C=C/a>>>0;if(C!==0)throw new Error("Non-zero carry");w=k,y++}for(var I=v-w;I!==v&&E[I]===0;)I++;for(var T=c.repeat(g);I<v;++I)T+=r.charAt(E[I]);return T}function p(f){if(typeof f!="string")throw new TypeError("Expected String");if(f.length===0)return new Uint8Array;var g=0;if(f[g]!==" "){for(var w=0,y=0;f[g]===c;)w++,g++;for(var b=(f.length-g)*l+1>>>0,v=new Uint8Array(b);f[g];){var E=t[f.charCodeAt(g)];if(E===255)return;for(var C=0,k=b-1;(E!==0||C<y)&&k!==-1;k--,C++)E+=a*v[k]>>>0,v[k]=E%256>>>0,E=E/256>>>0;if(E!==0)throw new Error("Non-zero carry");y=C,g++}if(f[g]!==" "){for(var x=b-y;x!==b&&v[x]===0;)x++;for(var I=new Uint8Array(w+(b-x)),T=w;x!==b;)I[T++]=v[x++];return I}}}function m(f){var g=p(f);if(g)return g;throw new Error(`Non-${e} character`)}return{encode:h,decodeUnsafe:p,decode:m}}var roe=toe,noe=roe;let ioe=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseEncode");this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},soe=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseDecode");u(this,"prefixCodePoint");this.name=e,this.prefix=t;const i=t.codePointAt(0);if(i===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=i,this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return L$(this,e)}},ooe=class{constructor(e){u(this,"decoders");this.decoders=e}or(e){return L$(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};function L$(r,e){return new ooe({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}let aoe=class{constructor(e,t,n,i){u(this,"name");u(this,"prefix");u(this,"baseEncode");u(this,"baseDecode");u(this,"encoder");u(this,"decoder");this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=i,this.encoder=new ioe(e,t,n),this.decoder=new soe(e,t,i)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};function coe({name:r,prefix:e,encode:t,decode:n}){return new aoe(r,e,t,n)}function B$({name:r,prefix:e,alphabet:t}){const{encode:n,decode:i}=noe(t,r);return coe({prefix:e,name:r,encode:n,decode:s=>R$(i(s))})}const loe=B$({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});B$({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var uoe=F$,U$=128,doe=-128,hoe=Math.pow(2,31);function F$(r,e,t){e=e||[],t=t||0;for(var n=t;r>=hoe;)e[t++]=r&255|U$,r/=128;for(;r&doe;)e[t++]=r&255|U$,r>>>=7;return e[t]=r|0,F$.bytes=t-n+1,e}var foe=Vv,poe=128,z$=127;function Vv(r,n){var t=0,n=n||0,i=0,s=n,o,a=r.length;do{if(s>=a)throw Vv.bytes=0,new RangeError("Could not decode varint");o=r[s++],t+=i<28?(o&z$)<<i:(o&z$)*Math.pow(2,i),i+=7}while(o>=poe);return Vv.bytes=s-n,t}var goe=Math.pow(2,7),yoe=Math.pow(2,14),moe=Math.pow(2,21),woe=Math.pow(2,28),boe=Math.pow(2,35),voe=Math.pow(2,42),Eoe=Math.pow(2,49),Soe=Math.pow(2,56),xoe=Math.pow(2,63),Aoe=function(r){return r<goe?1:r<yoe?2:r<moe?3:r<woe?4:r<boe?5:r<voe?6:r<Eoe?7:r<Soe?8:r<xoe?9:10},Coe={encode:uoe,decode:foe,encodingLength:Aoe},V$=Coe;function K$(r,e=0){return[V$.decode(r,e),V$.decode.bytes]}function Ioe(r){const e=R$(r),[t,n]=K$(e),[i,s]=K$(e.subarray(n)),o=e.subarray(n+s);if(o.byteLength!==i)throw new Error("Incorrect length");return new koe(t,i,o,e)}let koe=class{constructor(e,t,n,i){u(this,"code");u(this,"size");u(this,"digest");u(this,"bytes");this.code=e,this.size=t,this.digest=n,this.bytes=i}};function O1(r,e){const t={[Symbol.iterator]:()=>t,next:()=>{const n=r.next(),i=n.value;return n.done===!0||i==null?{done:!0,value:void 0}:{done:!1,value:e(i)}}};return t}function Kv(r){const e=Ioe(loe.decode(`z${r}`));return ei(e)}class sc{constructor(e){u(this,"map");if(this.map=new Map,e!=null)for(const[t,n]of e.entries())this.map.set(t.toString(),{key:t,value:n})}[Symbol.iterator](){return this.entries()}clear(){this.map.clear()}delete(e){return this.map.delete(e.toString())}entries(){return O1(this.map.entries(),e=>[e[1].key,e[1].value])}forEach(e){this.map.forEach((t,n)=>{e(t.value,t.key,this)})}get(e){var t;return(t=this.map.get(e.toString()))==null?void 0:t.value}has(e){return this.map.has(e.toString())}set(e,t){this.map.set(e.toString(),{key:e,value:t})}keys(){return O1(this.map.values(),e=>e.key)}values(){return O1(this.map.values(),e=>e.value)}get size(){return this.map.size}}class ts{constructor(e){u(this,"set");if(this.set=new Set,e!=null)for(const t of e)this.set.add(t.toString())}get size(){return this.set.size}[Symbol.iterator](){return this.values()}add(e){this.set.add(e.toString())}clear(){this.set.clear()}delete(e){this.set.delete(e.toString())}entries(){return O1(this.set.entries(),e=>{const t=Kv(e[0]);return[t,t]})}forEach(e){this.set.forEach(t=>{const n=Kv(t);e(n,n,this)})}has(e){return this.set.has(e.toString())}values(){return O1(this.set.values(),e=>Kv(e))}intersection(e){const t=new ts;for(const n of e)this.has(n)&&t.add(n);return t}difference(e){const t=new ts;for(const n of this)e.has(n)||t.add(n);return t}union(e){const t=new ts;for(const n of e)t.add(n);for(const n of this)t.add(n);return t}}function _oe(){return new ts}class j$ extends SD{constructor(e,t){super(),this.finished=!1,this.destroyed=!1,ay(e);const n=_1(t);if(this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const i=this.blockLen,s=new Uint8Array(i);s.set(n.length>i?e.create().update(n).digest():n);for(let o=0;o<s.length;o++)s[o]^=54;this.iHash.update(s),this.oHash=e.create();for(let o=0;o<s.length;o++)s[o]^=106;this.oHash.update(s),Ms(s)}update(e){return cy(this),this.iHash.update(e),this}digestInto(e){cy(this),I1(e,this.outputLen),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){const e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||(e=Object.create(Object.getPrototypeOf(this),{}));const{oHash:t,iHash:n,finished:i,destroyed:s,blockLen:o,outputLen:a}=this;return e=e,e.finished=i,e.destroyed=s,e.blockLen=o,e.outputLen=a,e.oHash=t._cloneInto(e.oHash),e.iHash=n._cloneInto(e.iHash),e}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}}const ky=(r,e,t)=>new j$(r,e).update(t).digest();ky.create=(r,e)=>new j$(r,e);function H$(r,e,t,n){ay(r);const i=dne({dkLen:32,asyncTick:10},n),{c:s,dkLen:o,asyncTick:a}=i;if($d(s),$d(o),$d(a),s<1)throw new Error("iterations (c) should be >= 1");const c=ED(e),l=ED(t),d=new Uint8Array(o),h=ky.create(r,c),p=h._cloneInto().update(l);return{c:s,dkLen:o,asyncTick:a,DK:d,PRF:h,PRFSalt:p}}function q$(r,e,t,n,i){return r.destroy(),e.destroy(),n&&n.destroy(),Ms(i),t}function Toe(r,e,t,n){const{c:i,dkLen:s,DK:o,PRF:a,PRFSalt:c}=H$(r,e,t,n);let l;const d=new Uint8Array(4),h=k1(d),p=new Uint8Array(a.outputLen);for(let m=1,f=0;f<s;m++,f+=a.outputLen){const g=o.subarray(f,f+a.outputLen);h.setInt32(0,m,!1),(l=c._cloneInto(l)).update(d).digestInto(p),g.set(p.subarray(0,g.length));for(let w=1;w<i;w++){a._cloneInto(l).update(p).digestInto(p);for(let y=0;y<g.length;y++)g[y]^=p[y]}}return q$(a,c,o,l,p)}async function W$(r,e,t,n){const{c:i,dkLen:s,asyncTick:o,DK:a,PRF:c,PRFSalt:l}=H$(r,e,t,n);let d;const h=new Uint8Array(4),p=k1(h),m=new Uint8Array(c.outputLen);for(let f=1,g=0;g<s;f++,g+=c.outputLen){const w=a.subarray(g,g+c.outputLen);p.setInt32(0,f,!1),(d=l._cloneInto(d)).update(h).digestInto(m),w.set(m.subarray(0,w.length)),await une(i-1,o,()=>{c._cloneInto(d).update(m).digestInto(m);for(let y=0;y<w.length;y++)w[y]^=m[y]})}return q$(c,l,a,d,m)}const R1=Uint32Array.from([1732584193,4023233417,2562383102,271733878,3285377520]),oc=new Uint32Array(80);class Poe extends yv{constructor(){super(64,20,8,!1),this.A=R1[0]|0,this.B=R1[1]|0,this.C=R1[2]|0,this.D=R1[3]|0,this.E=R1[4]|0}get(){const{A:e,B:t,C:n,D:i,E:s}=this;return[e,t,n,i,s]}set(e,t,n,i,s){this.A=e|0,this.B=t|0,this.C=n|0,this.D=i|0,this.E=s|0}process(e,t){for(let c=0;c<16;c++,t+=4)oc[c]=e.getUint32(t,!1);for(let c=16;c<80;c++)oc[c]=pv(oc[c-3]^oc[c-8]^oc[c-14]^oc[c-16],1);let{A:n,B:i,C:s,D:o,E:a}=this;for(let c=0;c<80;c++){let l,d;c<20?(l=CD(i,s,o),d=1518500249):c<40?(l=i^s^o,d=1859775393):c<60?(l=ID(i,s,o),d=2400959708):(l=i^s^o,d=3395469782);const h=pv(n,5)+l+a+d+oc[c]|0;a=o,o=s,s=pv(i,30),i=n,n=h}n=n+this.A|0,i=i+this.B|0,s=s+this.C|0,o=o+this.D|0,a=a+this.E|0,this.set(n,i,s,o,a)}roundClean(){Ms(oc)}destroy(){this.set(0,0,0,0,0),Ms(this.buffer)}}const Doe=gv(()=>new Poe),jv=Tne,$oe=Jn({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6});Jn({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),Jn({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),Jn({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});const G$={sha1:Doe,"sha2-256":Nl,"sha2-512":jv};function Q$(r,e,t,n,i){if(i!=="sha1"&&i!=="sha2-256"&&i!=="sha2-512"){const a=Object.keys(G$).join(" / ");throw new Z(`Hash '${i}' is unknown or not supported. Must be ${a}`)}const s=G$[i],o=Toe(s,r,e,{c:t,dkLen:n});return $oe.encode(o).substring(1)}const Hv={32:16777619n,64:1099511628211n,128:309485009821345068724781371n,256:374144419156711147060143317175368453031918731002211n,512:35835915874844867368919076489095108449946327955754392558399825615420669938882575126094039892345713852759n,1024:5016456510113118655434598811035278955030765345404790744303017523831112055108147451509157692220295382716162651878526895249385292291816524375083746691371804094271873160484737966720260389217684476157468082573n},Y$={32:2166136261n,64:14695981039346656037n,128:144066263297769815596495629667062367629n,256:100029257958052580907070968620625704837092796014241193945225284501741471925557n,512:9659303129496669498009435400716310466090418745672637896108374329434462657994582932197716438449813051892206539805784495328239340083876191928701583869517785n,1024:14197795064947621068722070641403218320880622795441933960878474914617582723252296732303717722150864096521202355549365628174669108571814760471015076148029755969804077320157692458563003215304957150157403644460363550505412711285966361610267868082893823963790439336411086884584107735010676915n},J$=new globalThis.TextEncoder;function Noe(r,e){const t=Hv[e];let n=Y$[e];for(let i=0;i<r.length;i++)n^=BigInt(r[i]),n=BigInt.asUintN(e,n*t);return n}function Moe(r,e,t){if(t.length===0)throw new Error("The `utf8Buffer` option must have a length greater than zero");const n=Hv[e];let i=Y$[e],s=r;for(;s.length>0;){const o=J$.encodeInto(s,t);s=s.slice(o.read);for(let a=0;a<o.written;a++)i^=BigInt(t[a]),i=BigInt.asUintN(e,i*n)}return i}function Ooe(r,{size:e=32,utf8Buffer:t}={}){if(!Hv[e])throw new Error("The `size` option must be one of 32, 64, 128, 256, 512, or 1024");if(typeof r=="string"){if(t)return Moe(r,e,t);r=J$.encode(r)}return Noe(r,e)}const qv={hash:r=>Number(Ooe(r,{size:32})),hashV:(r,e)=>Roe(qv.hash(r,e))};function Roe(r){let e=r.toString(16);return e.length%2===1&&(e=`0${e}`),ie(e,"base16")}const X$=64;class Rl{constructor(e,t,n,i=2){u(this,"fp");u(this,"h");u(this,"seed");if(i>X$)throw new TypeError("Invalid Fingerprint Size");const s=t.hashV(e,n),o=We(i);for(let a=0;a<o.length;a++)o[a]=s[a];o.length===0&&(o[0]=7),this.fp=o,this.h=t,this.seed=n}hash(){return this.h.hash(this.fp,this.seed)}equals(e){return(e==null?void 0:e.fp)instanceof Uint8Array?qe(this.fp,e.fp):!1}}function _y(r,e){return Math.floor(Math.random()*(e-r))+r}class Ty{constructor(e){u(this,"contents");this.contents=new Array(e).fill(null)}has(e){if(!(e instanceof Rl))throw new TypeError("Invalid Fingerprint");return this.contents.some(t=>e.equals(t))}add(e){if(!(e instanceof Rl))throw new TypeError("Invalid Fingerprint");for(let t=0;t<this.contents.length;t++)if(this.contents[t]==null)return this.contents[t]=e,!0;return!0}swap(e){if(!(e instanceof Rl))throw new TypeError("Invalid Fingerprint");const t=_y(0,this.contents.length-1),n=this.contents[t];return this.contents[t]=e,n}remove(e){if(!(e instanceof Rl))throw new TypeError("Invalid Fingerprint");const t=this.contents.findIndex(n=>e.equals(n));return t>-1?(this.contents[t]=null,!0):!1}}const Loe=500;class Z${constructor(e){u(this,"bucketSize");u(this,"filterSize");u(this,"fingerprintSize");u(this,"buckets");u(this,"count");u(this,"hash");u(this,"seed");this.filterSize=e.filterSize,this.bucketSize=e.bucketSize??4,this.fingerprintSize=e.fingerprintSize??2,this.count=0,this.buckets=[],this.hash=e.hash??qv,this.seed=e.seed??_y(0,Math.pow(2,10))}add(e){typeof e=="string"&&(e=ie(e));const t=new Rl(e,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(e,this.seed)%this.filterSize,i=(n^t.hash())%this.filterSize;if(this.buckets[n]==null&&(this.buckets[n]=new Ty(this.bucketSize)),this.buckets[i]==null&&(this.buckets[i]=new Ty(this.bucketSize)),this.buckets[n].add(t)||this.buckets[i].add(t))return this.count++,!0;const s=[n,i];let o=s[_y(0,s.length-1)];this.buckets[o]==null&&(this.buckets[o]=new Ty(this.bucketSize));for(let a=0;a<Loe;a++){const c=this.buckets[o].swap(t);if(c!=null&&(o=(o^c.hash())%this.filterSize,this.buckets[o]==null&&(this.buckets[o]=new Ty(this.bucketSize)),this.buckets[o].add(c)))return this.count++,!0}return!1}has(e){var o,a;typeof e=="string"&&(e=ie(e));const t=new Rl(e,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(e,this.seed)%this.filterSize,i=((o=this.buckets[n])==null?void 0:o.has(t))??!1;if(i)return i;const s=(n^t.hash())%this.filterSize;return((a=this.buckets[s])==null?void 0:a.has(t))??!1}remove(e){var a,c;typeof e=="string"&&(e=ie(e));const t=new Rl(e,this.hash,this.seed,this.fingerprintSize),n=this.hash.hash(e,this.seed)%this.filterSize,i=((a=this.buckets[n])==null?void 0:a.remove(t))??!1;if(i)return this.count--,i;const s=(n^t.hash())%this.filterSize,o=((c=this.buckets[s])==null?void 0:c.remove(t))??!1;return o&&this.count--,o}get reliable(){return Math.floor(100*(this.count/this.filterSize))<=90}}const Boe={1:.5,2:.84,4:.95,8:.98};function Uoe(r=.001){return r>.002?2:r>1e-5?4:8}function Foe(r,e=.001){const t=Uoe(e),n=Boe[t],i=Math.round(r/n),s=Math.min(Math.ceil(Math.log2(1/e)+Math.log2(2*t)),X$);return{filterSize:i,bucketSize:t,fingerprintSize:s}}class zoe{constructor(e){u(this,"filterSize");u(this,"bucketSize");u(this,"fingerprintSize");u(this,"scale");u(this,"filterSeries");u(this,"hash");u(this,"seed");this.bucketSize=e.bucketSize??4,this.filterSize=e.filterSize??(1<<18)/this.bucketSize,this.fingerprintSize=e.fingerprintSize??2,this.scale=e.scale??2,this.hash=e.hash??qv,this.seed=e.seed??_y(0,Math.pow(2,10)),this.filterSeries=[new Z$({filterSize:this.filterSize,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed})]}add(e){if(typeof e=="string"&&(e=ie(e)),this.has(e))return!0;let t=this.filterSeries.find(n=>n.reliable);if(t==null){const n=this.filterSize*Math.pow(this.scale,this.filterSeries.length);t=new Z$({filterSize:n,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed}),this.filterSeries.push(t)}return t.add(e)}has(e){typeof e=="string"&&(e=ie(e));for(let t=0;t<this.filterSeries.length;t++)if(this.filterSeries[t].has(e))return!0;return!1}remove(e){typeof e=="string"&&(e=ie(e));for(let t=0;t<this.filterSeries.length;t++)if(this.filterSeries[t].remove(e))return!0;return!1}get count(){return this.filterSeries.reduce((e,t)=>e+t.count,0)}}function Ll(r,e=.001,t){return new zoe({...Foe(r,e)})}class Voe{constructor(e,t){u(this,"filter");this.filter=Ll(e,t)}has(e){return this.filter.has(e.toMultihash().bytes)}add(e){this.filter.add(e.toMultihash().bytes)}remove(e){var t,n;(n=(t=this.filter).remove)==null||n.call(t,e.toMultihash().bytes)}}function Koe(r,e=.001){return new Voe(r,e)}class joe extends sc{constructor(t){super();u(this,"metric");const{name:n,metrics:i}=t;this.metric=i.registerMetric(n),this.updateComponentMetric()}set(t,n){return super.set(t,n),this.updateComponentMetric(),this}delete(t){const n=super.delete(t);return this.updateComponentMetric(),n}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}}function eN(r){const{name:e,metrics:t}=r;let n;return t!=null?n=new joe({name:e,metrics:t}):n=new sc,n}function Hoe(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function Wv(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function qoe(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var i=0;i<r.length;i++){var s=r.charAt(i),o=s.charCodeAt(0);if(t[o]!==255)throw new TypeError(s+" is ambiguous");t[o]=i}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),d=Math.log(256)/Math.log(a);function h(f){if(f instanceof Uint8Array||(ArrayBuffer.isView(f)?f=new Uint8Array(f.buffer,f.byteOffset,f.byteLength):Array.isArray(f)&&(f=Uint8Array.from(f))),!(f instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(f.length===0)return"";for(var g=0,w=0,y=0,b=f.length;y!==b&&f[y]===0;)y++,g++;for(var v=(b-y)*d+1>>>0,E=new Uint8Array(v);y!==b;){for(var C=f[y],k=0,x=v-1;(C!==0||k<w)&&x!==-1;x--,k++)C+=256*E[x]>>>0,E[x]=C%a>>>0,C=C/a>>>0;if(C!==0)throw new Error("Non-zero carry");w=k,y++}for(var I=v-w;I!==v&&E[I]===0;)I++;for(var T=c.repeat(g);I<v;++I)T+=r.charAt(E[I]);return T}function p(f){if(typeof f!="string")throw new TypeError("Expected String");if(f.length===0)return new Uint8Array;var g=0;if(f[g]!==" "){for(var w=0,y=0;f[g]===c;)w++,g++;for(var b=(f.length-g)*l+1>>>0,v=new Uint8Array(b);f[g];){var E=t[f.charCodeAt(g)];if(E===255)return;for(var C=0,k=b-1;(E!==0||C<y)&&k!==-1;k--,C++)E+=a*v[k]>>>0,v[k]=E%256>>>0,E=E/256>>>0;if(E!==0)throw new Error("Non-zero carry");y=C,g++}if(f[g]!==" "){for(var x=b-y;x!==b&&v[x]===0;)x++;for(var I=new Uint8Array(w+(b-x)),T=w;x!==b;)I[T++]=v[x++];return I}}}function m(f){var g=p(f);if(g)return g;throw new Error(`Non-${e} character`)}return{encode:h,decodeUnsafe:p,decode:m}}var Woe=qoe,Goe=Woe;let Qoe=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseEncode");this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},Yoe=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseDecode");u(this,"prefixCodePoint");this.name=e,this.prefix=t;const i=t.codePointAt(0);if(i===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=i,this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return tN(this,e)}},Joe=class{constructor(e){u(this,"decoders");this.decoders=e}or(e){return tN(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};function tN(r,e){return new Joe({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}let Xoe=class{constructor(e,t,n,i){u(this,"name");u(this,"prefix");u(this,"baseEncode");u(this,"baseDecode");u(this,"encoder");u(this,"decoder");this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=i,this.encoder=new Qoe(e,t,n),this.decoder=new Yoe(e,t,i)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};function rN({name:r,prefix:e,encode:t,decode:n}){return new Xoe(r,e,t,n)}function Py({name:r,prefix:e,alphabet:t}){const{encode:n,decode:i}=Goe(t,r);return rN({prefix:e,name:r,encode:n,decode:s=>Wv(i(s))})}function Zoe(r,e,t,n){const i={};for(let d=0;d<e.length;++d)i[e[d]]=d;let s=r.length;for(;r[s-1]==="=";)--s;const o=new Uint8Array(s*t/8|0);let a=0,c=0,l=0;for(let d=0;d<s;++d){const h=i[r[d]];if(h===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|h,a+=t,a>=8&&(a-=8,o[l++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o}function eae(r,e,t){const n=e[e.length-1]==="=",i=(1<<t)-1;let s="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,s+=e[i&a>>o];if(o!==0&&(s+=e[i&a<<t-o]),n)for(;s.length*t&7;)s+="=";return s}function ti({name:r,prefix:e,bitsPerChar:t,alphabet:n}){return rN({prefix:e,name:r,encode(i){return eae(i,n,t)},decode(i){return Zoe(i,n,t,r)}})}const Dy=ti({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});ti({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),ti({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),ti({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),ti({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),ti({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),ti({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),ti({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),ti({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const Gv=Py({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"});Py({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});const ac=Py({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});Py({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var tae=iN,nN=128,rae=-128,nae=Math.pow(2,31);function iN(r,e,t){e=e||[],t=t||0;for(var n=t;r>=nae;)e[t++]=r&255|nN,r/=128;for(;r&rae;)e[t++]=r&255|nN,r>>>=7;return e[t]=r|0,iN.bytes=t-n+1,e}var iae=Qv,sae=128,sN=127;function Qv(r,n){var t=0,n=n||0,i=0,s=n,o,a=r.length;do{if(s>=a)throw Qv.bytes=0,new RangeError("Could not decode varint");o=r[s++],t+=i<28?(o&sN)<<i:(o&sN)*Math.pow(2,i),i+=7}while(o>=sae);return Qv.bytes=s-n,t}var oae=Math.pow(2,7),aae=Math.pow(2,14),cae=Math.pow(2,21),lae=Math.pow(2,28),uae=Math.pow(2,35),dae=Math.pow(2,42),hae=Math.pow(2,49),fae=Math.pow(2,56),pae=Math.pow(2,63),gae=function(r){return r<oae?1:r<aae?2:r<cae?3:r<lae?4:r<uae?5:r<dae?6:r<hae?7:r<fae?8:r<pae?9:10},yae={encode:tae,decode:iae,encodingLength:gae},$y=yae;function Yv(r,e=0){return[$y.decode(r,e),$y.decode.bytes]}function Ny(r,e,t=0){return $y.encode(r,e,t),e}function My(r){return $y.encodingLength(r)}function Jv(r,e){const t=e.byteLength,n=My(r),i=n+My(t),s=new Uint8Array(i+t);return Ny(r,s,0),Ny(t,s,n),s.set(e,i),new Xv(r,t,e,s)}function mae(r){const e=Wv(r),[t,n]=Yv(e),[i,s]=Yv(e.subarray(n)),o=e.subarray(n+s);if(o.byteLength!==i)throw new Error("Incorrect length");return new Xv(t,i,o,e)}function wae(r,e){if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&Hoe(r.bytes,t.bytes)}}let Xv=class{constructor(e,t,n,i){u(this,"code");u(this,"size");u(this,"digest");u(this,"bytes");this.code=e,this.size=t,this.digest=n,this.bytes=i}};function oN(r,e){const{bytes:t,version:n}=r;switch(n){case 0:return vae(t,Zv(r),e??ac.encoder);default:return Eae(t,Zv(r),e??Dy.encoder)}}const aN=new WeakMap;function Zv(r){const e=aN.get(r);if(e==null){const t=new Map;return aN.set(r,t),t}return e}let e7=class qr{constructor(e,t,n,i){u(this,"code");u(this,"version");u(this,"multihash");u(this,"bytes");u(this,"/");u(this,_j,"CID");this.code=t,this.version=e,this.multihash=n,this.bytes=i,this["/"]=i}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==L1)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==Sae)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return qr.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=Jv(e,t);return qr.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return qr.equals(this,e)}static equals(e,t){const n=t;return n!=null&&e.code===n.code&&e.version===n.version&&wae(e.multihash,n.multihash)}toString(e){return oN(this,e)}toJSON(){return{"/":oN(this)}}link(){return this}[(_j=Symbol.toStringTag,Symbol.for("nodejs.util.inspect.custom"))](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof qr)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:i,multihash:s,bytes:o}=t;return new qr(n,i,s,o??cN(n,i,s.bytes))}else if(t[xae]===!0){const{version:n,multihash:i,code:s}=t,o=mae(i);return qr.create(n,s,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==L1)throw new Error(`Version 0 CID must use dag-pb (code: ${L1}) block encoding`);return new qr(e,t,n,n.bytes)}case 1:{const i=cN(e,t,n.bytes);return new qr(e,t,n,i)}default:throw new Error("Invalid version")}}static createV0(e){return qr.create(0,L1,e)}static createV1(e,t){return qr.create(1,e,t)}static decode(e){const[t,n]=qr.decodeFirst(e);if(n.length!==0)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=qr.inspectBytes(e),n=t.size-t.multihashSize,i=Wv(e.subarray(n,n+t.multihashSize));if(i.byteLength!==t.multihashSize)throw new Error("Incorrect length");const s=i.subarray(t.multihashSize-t.digestSize),o=new Xv(t.multihashCode,t.digestSize,s,i);return[t.version===0?qr.createV0(o):qr.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[h,p]=Yv(e.subarray(t));return t+=p,h};let i=n(),s=L1;if(i===18?(i=0,t=0):s=n(),i!==0&&i!==1)throw new RangeError(`Invalid CID version ${i}`);const o=t,a=n(),c=n(),l=t+c,d=l-o;return{version:i,codec:s,multihashCode:a,digestSize:c,multihashSize:d,size:l}}static parse(e,t){const[n,i]=bae(e,t),s=qr.decode(i);if(s.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return Zv(s).set(n,e),s}};function bae(r,e){switch(r[0]){case"Q":{const t=e??ac;return[ac.prefix,t.decode(`${ac.prefix}${r}`)]}case ac.prefix:{const t=e??ac;return[ac.prefix,t.decode(r)]}case Dy.prefix:{const t=e??Dy;return[Dy.prefix,t.decode(r)]}case Gv.prefix:{const t=e??Gv;return[Gv.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}}function vae(r,e,t){const{prefix:n}=t;if(n!==ac.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const i=e.get(n);if(i==null){const s=t.encode(r).slice(1);return e.set(n,s),s}else return i}function Eae(r,e,t){const{prefix:n}=t,i=e.get(n);if(i==null){const s=t.encode(r);return e.set(n,s),s}else return i}const L1=112,Sae=18;function cN(r,e,t){const n=My(r),i=n+My(e),s=new Uint8Array(i+t.byteLength);return Ny(r,s,0),Ny(e,s,n),s.set(t,i),s}const xae=Symbol.for("@ipld/js-cid/CID"),t7=ti({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6});ti({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),ti({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),ti({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});class B1{constructor(e=!1,t=0){u(this,"full");u(this,"pendingBytes");u(this,"wantlist");u(this,"blocks");u(this,"blockPresences");this.full=e,this.wantlist=new Map,this.blocks=new Map,this.blockPresences=new Map,this.pendingBytes=0}addWantlistEntry(e,t){const n=t7.encode(e.multihash.bytes);this.wantlist.set(n,t)}addBlockPresence(e,t){const n=t7.encode(e.multihash.bytes);this.blockPresences.set(n,t)}addBlock(e,t){const n=t7.encode(e.multihash.bytes);this.blocks.set(n,t)}}function Aae(r){let e=new Uint8Array(r.reduce((n,i)=>n+gt(i),0)),t=0;for(const n of r)e=Er(n,e,t),t+=gt(n);return e}function lN(r){return Aae([r.version,r.code,r.multihash.code,r.multihash.digest.byteLength])}class Cae{constructor(e,t){u(this,"peerId");u(this,"blockstore");u(this,"network");u(this,"wants");u(this,"exchangeCount");u(this,"bytesSent");u(this,"bytesReceived");u(this,"lastExchange");u(this,"maxSizeReplaceHasWithBlock");u(this,"log");this.peerId=e.peerId,this.blockstore=e.blockstore,this.network=e.network,this.wants=new Map,this.log=e.logger.forComponent(`helia:bitswap:ledger:${e.peerId}`),this.exchangeCount=0,this.bytesSent=0,this.bytesReceived=0,this.maxSizeReplaceHasWithBlock=t.maxSizeReplaceHasWithBlock??Qie}sentBytes(e){this.exchangeCount++,this.lastExchange=new Date().getTime(),this.bytesSent+=e}receivedBytes(e){this.exchangeCount++,this.lastExchange=new Date().getTime(),this.bytesReceived+=e}debtRatio(){return this.bytesSent/(this.bytesReceived+1)}async sendBlocksToPeer(e){const t=new B1,n=new Set;for(const[i,s]of this.wants.entries())try{const o=await this.blockstore.get(s.cid,e);s.wantType===fr.WantHave?o.byteLength<this.maxSizeReplaceHasWithBlock?(this.log("sending have and block for %c",s.cid),n.add(i),t.addBlock(s.cid,{data:o,prefix:lN(s.cid)})):(this.log("sending have for %c",s.cid),t.addBlockPresence(s.cid,{cid:s.cid.bytes,type:Bs.HaveBlock})):(this.log("sending block for %c",s.cid),n.add(i),t.addBlock(s.cid,{data:o,prefix:lN(s.cid)}))}catch(o){if(o.name!=="NotFoundError")throw o;if(this.log("do not have block for %c",s.cid),!s.sendDontHave||s.sentDoNotHave===!0)continue;s.sentDoNotHave=!0,t.addBlockPresence(s.cid,{cid:s.cid.bytes,type:Bs.DoNotHaveBlock})}if(t.blocks.size>0||t.blockPresences.size>0){this.log("sending message"),await this.network.sendMessage(this.peerId,t,e),this.log("sent message"),this.sentBytes([...t.blocks.values()].reduce((i,s)=>i+s.data.byteLength,0));for(const i of n)this.wants.delete(i)}}}class Iae{constructor(e,t={}){u(this,"blockstore");u(this,"network");u(this,"ledgerMap");u(this,"maxSizeReplaceHasWithBlock");u(this,"log");u(this,"logger");this.blockstore=e.blockstore,this.network=e.network,this.maxSizeReplaceHasWithBlock=t.maxSizeReplaceHasWithBlock,this.log=e.logger.forComponent("helia:bitswap:peer-want-lists"),this.logger=e.logger,this.ledgerMap=eN({name:"helia_bitswap_ledger_map",metrics:e.metrics}),this.network.addEventListener("bitswap:message",n=>{this.receiveMessage(n.detail.peer,n.detail.message).catch(i=>{this.log.error("error receiving bitswap message from %p",n.detail.peer,i)})}),this.network.addEventListener("peer:disconnected",n=>{this.peerDisconnected(n.detail)})}ledgerForPeer(e){const t=this.ledgerMap.get(e);if(t!=null)return{peer:t.peerId,value:t.debtRatio(),sent:t.bytesSent,received:t.bytesReceived,exchanged:t.exchangeCount}}wantListForPeer(e){const t=this.ledgerMap.get(e);if(t!=null)return[...t.wants.values()]}peers(){return Array.from(this.ledgerMap.values()).map(e=>e.peerId)}async receiveMessage(e,t){var i;let n=this.ledgerMap.get(e);if(n==null&&(n=new Cae({peerId:e,blockstore:this.blockstore,network:this.network,logger:this.logger},{maxSizeReplaceHasWithBlock:this.maxSizeReplaceHasWithBlock}),this.ledgerMap.set(e,n)),n.receivedBytes(((i=t.blocks)==null?void 0:i.reduce((s,o)=>s+o.data.byteLength,0))??0),t.wantlist!=null){t.wantlist.full===!0&&n.wants.clear();for(const s of t.wantlist.entries){const o=e7.decode(s.cid),a=re(o.multihash.bytes,"base64");s.cancel===!0?(this.log("peer %p cancelled want of block for %c",e,o),n.wants.delete(a)):(s.wantType===fr.WantHave?this.log("peer %p wanted block presence for %c",e,o):this.log("peer %p wanted block for %c",e,o),n.wants.set(a,{cid:o,priority:s.priority,wantType:s.wantType??fr.WantBlock,sendDontHave:s.sendDontHave??!1}))}}this.log("send blocks to peer"),await n.sendBlocksToPeer()}async receivedBlock(e,t){const n=re(e.multihash.bytes,"base64"),i=[];for(const s of this.ledgerMap.values())s.wants.has(n)&&i.push(s);await Promise.all(i.map(async s=>s.sendBlocksToPeer(t)))}peerDisconnected(e){this.ledgerMap.delete(e)}}function kae(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function _ae(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var i=0;i<r.length;i++){var s=r.charAt(i),o=s.charCodeAt(0);if(t[o]!==255)throw new TypeError(s+" is ambiguous");t[o]=i}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),d=Math.log(256)/Math.log(a);function h(f){if(f instanceof Uint8Array||(ArrayBuffer.isView(f)?f=new Uint8Array(f.buffer,f.byteOffset,f.byteLength):Array.isArray(f)&&(f=Uint8Array.from(f))),!(f instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(f.length===0)return"";for(var g=0,w=0,y=0,b=f.length;y!==b&&f[y]===0;)y++,g++;for(var v=(b-y)*d+1>>>0,E=new Uint8Array(v);y!==b;){for(var C=f[y],k=0,x=v-1;(C!==0||k<w)&&x!==-1;x--,k++)C+=256*E[x]>>>0,E[x]=C%a>>>0,C=C/a>>>0;if(C!==0)throw new Error("Non-zero carry");w=k,y++}for(var I=v-w;I!==v&&E[I]===0;)I++;for(var T=c.repeat(g);I<v;++I)T+=r.charAt(E[I]);return T}function p(f){if(typeof f!="string")throw new TypeError("Expected String");if(f.length===0)return new Uint8Array;var g=0;if(f[g]!==" "){for(var w=0,y=0;f[g]===c;)w++,g++;for(var b=(f.length-g)*l+1>>>0,v=new Uint8Array(b);f[g];){var E=t[f.charCodeAt(g)];if(E===255)return;for(var C=0,k=b-1;(E!==0||C<y)&&k!==-1;k--,C++)E+=a*v[k]>>>0,v[k]=E%256>>>0,E=E/256>>>0;if(E!==0)throw new Error("Non-zero carry");y=C,g++}if(f[g]!==" "){for(var x=b-y;x!==b&&v[x]===0;)x++;for(var I=new Uint8Array(w+(b-x)),T=w;x!==b;)I[T++]=v[x++];return I}}}function m(f){var g=p(f);if(g)return g;throw new Error(`Non-${e} character`)}return{encode:h,decodeUnsafe:p,decode:m}}var Tae=_ae,Pae=Tae;let Dae=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseEncode");this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},$ae=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseDecode");u(this,"prefixCodePoint");this.name=e,this.prefix=t;const i=t.codePointAt(0);if(i===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=i,this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return uN(this,e)}},Nae=class{constructor(e){u(this,"decoders");this.decoders=e}or(e){return uN(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};function uN(r,e){return new Nae({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}let Mae=class{constructor(e,t,n,i){u(this,"name");u(this,"prefix");u(this,"baseEncode");u(this,"baseDecode");u(this,"encoder");u(this,"decoder");this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=i,this.encoder=new Dae(e,t,n),this.decoder=new $ae(e,t,i)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};function dN({name:r,prefix:e,encode:t,decode:n}){return new Mae(r,e,t,n)}function hN({name:r,prefix:e,alphabet:t}){const{encode:n,decode:i}=Pae(t,r);return dN({prefix:e,name:r,encode:n,decode:s=>kae(i(s))})}function Oae(r,e,t,n){const i={};for(let d=0;d<e.length;++d)i[e[d]]=d;let s=r.length;for(;r[s-1]==="=";)--s;const o=new Uint8Array(s*t/8|0);let a=0,c=0,l=0;for(let d=0;d<s;++d){const h=i[r[d]];if(h===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|h,a+=t,a>=8&&(a-=8,o[l++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o}function Rae(r,e,t){const n=e[e.length-1]==="=",i=(1<<t)-1;let s="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,s+=e[i&a>>o];if(o!==0&&(s+=e[i&a<<t-o]),n)for(;s.length*t&7;)s+="=";return s}function ri({name:r,prefix:e,bitsPerChar:t,alphabet:n}){return dN({prefix:e,name:r,encode(i){return Rae(i,n,t)},decode(i){return Oae(i,n,t,r)}})}const Lae=ri({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});ri({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),ri({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),ri({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),ri({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),ri({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),ri({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),ri({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),ri({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const Bae=hN({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});hN({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});const Uae=ri({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6});ri({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),ri({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),ri({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});const Fd=1e3,zd=Fd*60,Vd=zd*60,Bl=Vd*24,Fae=Bl*7,zae=Bl*365.25;function fN(r,e){try{if(typeof r=="string"&&r.length>0)return Vae(r);if(typeof r=="number"&&isFinite(r))return e!=null&&e.long?jae(r):Kae(r);throw new Error("Value is not a string or number.")}catch(t){const n=Hae(t)?`${t.message}. value=${JSON.stringify(r)}`:"An unknown error has occured.";throw new Error(n)}}function Vae(r){if(r=String(r),r.length>100)throw new Error("Value exceeds the maximum length of 100 characters.");const e=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(r);if(!e)return NaN;const t=parseFloat(e[1]),n=(e[2]||"ms").toLowerCase();switch(n){case"years":case"year":case"yrs":case"yr":case"y":return t*zae;case"weeks":case"week":case"w":return t*Fae;case"days":case"day":case"d":return t*Bl;case"hours":case"hour":case"hrs":case"hr":case"h":return t*Vd;case"minutes":case"minute":case"mins":case"min":case"m":return t*zd;case"seconds":case"second":case"secs":case"sec":case"s":return t*Fd;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return t;default:throw new Error(`The unit ${n} was matched, but no matching case exists.`)}}function Kae(r){const e=Math.abs(r);return e>=Bl?`${Math.round(r/Bl)}d`:e>=Vd?`${Math.round(r/Vd)}h`:e>=zd?`${Math.round(r/zd)}m`:e>=Fd?`${Math.round(r/Fd)}s`:`${r}ms`}function jae(r){const e=Math.abs(r);return e>=Bl?Oy(r,e,Bl,"day"):e>=Vd?Oy(r,e,Vd,"hour"):e>=zd?Oy(r,e,zd,"minute"):e>=Fd?Oy(r,e,Fd,"second"):`${r} ms`}function Oy(r,e,t,n){const i=e>=t*1.5;return`${Math.round(r/t)} ${n}${i?"s":""}`}function Hae(r){return typeof r=="object"&&r!==null&&"message"in r}function qae(r){t.debug=t,t.default=t,t.coerce=c,t.disable=s,t.enable=i,t.enabled=o,t.humanize=fN,t.destroy=l,Object.keys(r).forEach(d=>{t[d]=r[d]}),t.names=[],t.skips=[],t.formatters={};function e(d){let h=0;for(let p=0;p<d.length;p++)h=(h<<5)-h+d.charCodeAt(p),h|=0;return t.colors[Math.abs(h)%t.colors.length]}t.selectColor=e;function t(d){let h,p=null,m,f;function g(...w){if(!g.enabled)return;const y=g,b=Number(new Date),v=b-(h||b);y.diff=v,y.prev=h,y.curr=b,h=b,w[0]=t.coerce(w[0]),typeof w[0]!="string"&&w.unshift("%O");let E=0;w[0]=w[0].replace(/%([a-zA-Z%])/g,(k,x)=>{if(k==="%%")return"%";E++;const I=t.formatters[x];if(typeof I=="function"){const T=w[E];k=I.call(y,T),w.splice(E,1),E--}return k}),t.formatArgs.call(y,w),(y.log||t.log).apply(y,w)}return g.namespace=d,g.useColors=t.useColors(),g.color=t.selectColor(d),g.extend=n,g.destroy=t.destroy,Object.defineProperty(g,"enabled",{enumerable:!0,configurable:!1,get:()=>p!==null?p:(m!==t.namespaces&&(m=t.namespaces,f=t.enabled(d)),f),set:w=>{p=w}}),typeof t.init=="function"&&t.init(g),g}function n(d,h){const p=t(this.namespace+(typeof h>"u"?":":h)+d);return p.log=this.log,p}function i(d){t.save(d),t.namespaces=d,t.names=[],t.skips=[];let h;const p=(typeof d=="string"?d:"").split(/[\s,]+/),m=p.length;for(h=0;h<m;h++)p[h]&&(d=p[h].replace(/\*/g,".*?"),d[0]==="-"?t.skips.push(new RegExp("^"+d.substr(1)+"$")):t.names.push(new RegExp("^"+d+"$")))}function s(){const d=[...t.names.map(a),...t.skips.map(a).map(h=>"-"+h)].join(",");return t.enable(""),d}function o(d){if(d[d.length-1]==="*")return!0;let h,p;for(h=0,p=t.skips.length;h<p;h++)if(t.skips[h].test(d))return!1;for(h=0,p=t.names.length;h<p;h++)if(t.names[h].test(d))return!0;return!1}function a(d){return d.toString().substring(2,d.toString().length-2).replace(/\.\*\?$/,"*")}function c(d){return d instanceof Error?d.stack??d.message:d}function l(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return t.setupFormatters(t.formatters),t.enable(t.load()),t}var Wae={};const Fs=ece(),Gae=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function Qae(){var r,e,t,n,i;return typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs)?!0:typeof navigator<"u"&&((r=navigator.userAgent)==null?void 0:r.toLowerCase().match(/(edge|trident)\/(\d+)/))!=null?!1:typeof document<"u"&&((t=(e=document.documentElement)==null?void 0:e.style)==null?void 0:t.WebkitAppearance)||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&((n=navigator.userAgent)==null?void 0:n.toLowerCase().match(/firefox\/(\d+)/))!=null&&parseInt(RegExp.$1,10)>=31||typeof navigator<"u"&&((i=navigator.userAgent)==null?void 0:i.toLowerCase().match(/applewebkit\/(\d+)/))}function Yae(r){if(r[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+r[0]+(this.useColors?"%c ":" ")+"+"+fN(this.diff),!this.useColors)return;const e="color: "+this.color;r.splice(1,0,e,"color: inherit");let t=0,n=0;r[0].replace(/%[a-zA-Z%]/g,i=>{i!=="%%"&&(t++,i==="%c"&&(n=t))}),r.splice(n,0,e)}const Jae=console.debug??console.log??(()=>{});function Xae(r){try{r?Fs==null||Fs.setItem("debug",r):Fs==null||Fs.removeItem("debug")}catch{}}function Zae(){let r;try{r=Fs==null?void 0:Fs.getItem("debug")}catch{}return!r&&typeof globalThis.process<"u"&&"env"in globalThis.process&&(r=Wae.DEBUG),r}function ece(){try{return localStorage}catch{}}function tce(r){r.j=function(e){try{return JSON.stringify(e)}catch(t){return"[UnexpectedJSONParseError]: "+t.message}}}const ni=qae({formatArgs:Yae,save:Xae,load:Zae,useColors:Qae,setupFormatters:tce,colors:Gae,storage:Fs,log:Jae});ni.formatters.b=r=>r==null?"undefined":Bae.baseEncode(r),ni.formatters.t=r=>r==null?"undefined":Lae.baseEncode(r),ni.formatters.m=r=>r==null?"undefined":Uae.baseEncode(r),ni.formatters.p=r=>r==null?"undefined":r.toString(),ni.formatters.c=r=>r==null?"undefined":r.toString(),ni.formatters.k=r=>r==null?"undefined":r.toString(),ni.formatters.a=r=>r==null?"undefined":r.toString(),ni.formatters.e=r=>r==null?"undefined":pN(r.stack)??pN(r.message)??r.toString();function rce(r){const e=()=>{};return e.enabled=!1,e.color="",e.diff=0,e.log=()=>{},e.namespace=r,e.destroy=()=>!0,e.extend=()=>e,e}function Ry(){return{forComponent(r){return Kd(r)}}}function Kd(r){let e=rce(`${r}:trace`);return ni.enabled(`${r}:trace`)&&ni.names.map(t=>t.toString()).find(t=>t.includes(":trace"))!=null&&(e=ni(`${r}:trace`)),Object.assign(ni(r),{error:ni(`${r}:error`),trace:e})}function pN(r){if(r!=null&&(r=r.trim(),r.length!==0))return r}function gN(r){const e=[cc.A];return r==null?e:Array.isArray(r)?r.length===0?e:r:[r]}const yN=60;function mN(r){return{Status:r.Status??0,TC:r.TC??r.flag_tc??!1,RD:r.RD??r.flag_rd??!1,RA:r.RA??r.flag_ra??!1,AD:r.AD??r.flag_ad??!1,CD:r.CD??r.flag_cd??!1,Question:(r.Question??r.questions??[]).map(e=>({name:e.name,type:cc[e.type]})),Answer:(r.Answer??r.answers??[]).map(e=>({name:e.name,type:cc[e.type],TTL:e.TTL??e.ttl??yN,data:e.data instanceof Uint8Array?re(e.data):e.data}))}}const nce=4;function wN(r,e={}){const t=new Ta({concurrency:e.queryConcurrency??nce});return async(n,i={})=>{var a;const s=new URLSearchParams;s.set("name",n),gN(i.types).forEach(c=>{s.append("type",cc[c])}),(a=i.onProgress)==null||a.call(i,new ke("dns:query",{detail:n}));const o=await t.add(async()=>{var d;const c=await fetch(`${r}?${s}`,{headers:{accept:"application/dns-json"},signal:i==null?void 0:i.signal});if(c.status!==200)throw new Error(`Unexpected HTTP status: ${c.status} - ${c.statusText}`);const l=mN(await c.json());return(d=i.onProgress)==null||d.call(i,new ke("dns:response",{detail:l})),l},{signal:i.signal});if(o==null)throw new Error("No DNS response received");return o}}function ice(){return[wN("https://cloudflare-dns.com/dns-query"),wN("https://dns.google/resolve")]}var sce=function(r){if(!r)throw Error("hashlru must have a max value, of type number, greater than 0");var e=0,t=Object.create(null),n=Object.create(null);function i(s,o){t[s]=o,e++,e>=r&&(e=0,n=t,t=Object.create(null))}return{has:function(s){return t[s]!==void 0||n[s]!==void 0},remove:function(s){t[s]!==void 0&&(t[s]=void 0),n[s]!==void 0&&(n[s]=void 0)},get:function(s){var o=t[s];if(o!==void 0)return o;if((o=n[s])!==void 0)return i(s,o),o},set:function(s,o){t[s]!==void 0?t[s]=o:i(s,o)},clear:function(){t=Object.create(null),n=Object.create(null)}}};const oce=Je(sce);class ace{constructor(e){u(this,"lru");this.lru=oce(e)}get(e,t){let n=!0;const i=[];for(const s of t){const o=this.getAnswers(e,s);if(o.length===0){n=!1;break}i.push(...o)}if(n)return mN({answers:i})}getAnswers(e,t){const n=`${e.toLowerCase()}-${t}`,i=this.lru.get(n);if(i!=null){const s=i.filter(o=>o.expires>Date.now()).map(({expires:o,value:a})=>({...a,TTL:Math.round((o-Date.now())/1e3),type:cc[a.type]}));return s.length===0&&this.lru.remove(n),s}return[]}add(e,t){const n=`${e.toLowerCase()}-${t.type}`,i=this.lru.get(n)??[];i.push({expires:Date.now()+(t.TTL??yN)*1e3,value:t}),this.lru.set(n,i)}remove(e,t){const n=`${e.toLowerCase()}-${t}`;this.lru.remove(n)}clear(){this.lru.clear()}}function cce(r){return new ace(r)}const lce=1e3;let uce=class{constructor(e){u(this,"resolvers");u(this,"cache");this.resolvers={},this.cache=cce(e.cacheSize??lce),Object.entries(e.resolvers??{}).forEach(([t,n])=>{Array.isArray(n)||(n=[n]),t.endsWith(".")||(t=`${t}.`),this.resolvers[t]=n}),this.resolvers["."]==null&&(this.resolvers["."]=ice())}async query(e,t={}){var c,l,d;const n=gN(t.types),i=t.cached!==!1?this.cache.get(e,n):void 0;if(i!=null)return(c=t.onProgress)==null||c.call(t,new ke("dns:cache",{detail:i})),i;const s=`${e.split(".").pop()}.`,o=(this.resolvers[s]??this.resolvers["."]).sort(()=>Math.random()>.5?-1:1),a=[];for(const h of o){if(((l=t.signal)==null?void 0:l.aborted)===!0)break;try{const p=await h(e,{...t,types:n});for(const m of p.Answer)this.cache.add(e,m);return p}catch(p){a.push(p),(d=t.onProgress)==null||d.call(t,new ke("dns:error",{detail:p}))}}throw a.length===1?a[0]:new AggregateError(a,`DNS lookup of ${e} ${n} failed`)}};var cc;(function(r){r[r.A=1]="A",r[r.CNAME=5]="CNAME",r[r.TXT=16]="TXT",r[r.AAAA=28]="AAAA"})(cc||(cc={}));function bN(r={}){return new uce(r)}const Do="/",vN=new TextEncoder().encode(Do),Ly=vN[0];class At{constructor(e,t){u(this,"_buf");if(typeof e=="string")this._buf=ie(e);else if(e instanceof Uint8Array)this._buf=e;else throw new Error("Invalid key, should be String of Uint8Array");if(t==null&&(t=!0),t&&this.clean(),this._buf.byteLength===0||this._buf[0]!==Ly)throw new Error("Invalid key")}toString(e="utf8"){return re(this._buf,e)}uint8Array(){return this._buf}get[Symbol.toStringTag](){return`Key(${this.toString()})`}static withNamespaces(e){return new At(e.join(Do))}static random(){return new At(Math.random().toString().substring(2))}static asKey(e){return e instanceof Uint8Array||typeof e=="string"?new At(e):typeof e.uint8Array=="function"?new At(e.uint8Array()):null}clean(){if((this._buf==null||this._buf.byteLength===0)&&(this._buf=vN),this._buf[0]!==Ly){const e=new Uint8Array(this._buf.byteLength+1);e.fill(Ly,0,1),e.set(this._buf,1),this._buf=e}for(;this._buf.byteLength>1&&this._buf[this._buf.byteLength-1]===Ly;)this._buf=this._buf.subarray(0,-1)}less(e){const t=this.list(),n=e.list();for(let i=0;i<t.length;i++){if(n.length<i+1)return!1;const s=t[i],o=n[i];if(s<o)return!0;if(s>o)return!1}return t.length<n.length}reverse(){return At.withNamespaces(this.list().slice().reverse())}namespaces(){return this.list()}baseNamespace(){const e=this.namespaces();return e[e.length-1]}list(){return this.toString().split(Do).slice(1)}type(){return dce(this.baseNamespace())}name(){return hce(this.baseNamespace())}instance(e){return new At(this.toString()+":"+e)}path(){let e=this.parent().toString();return e.endsWith(Do)||(e+=Do),e+=this.type(),new At(e)}parent(){const e=this.list();return e.length===1?new At(Do):new At(e.slice(0,-1).join(Do))}child(e){return this.toString()===Do?e:e.toString()===Do?this:new At(this.toString()+e.toString(),!1)}isAncestorOf(e){return e.toString()===this.toString()?!1:e.toString().startsWith(this.toString())}isDecendantOf(e){return e.toString()===this.toString()?!1:this.toString().startsWith(e.toString())}isTopLevel(){return this.list().length===1}concat(...e){return At.withNamespaces([...this.namespaces(),...fce(e.map(t=>t.namespaces()))])}}function dce(r){const e=r.split(":");return e.length<2?"":e.slice(0,-1).join(":")}function hce(r){const e=r.split(":");return e[e.length-1]}function fce(r){return[].concat(...r)}function pce(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function jd(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function gce(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var i=0;i<r.length;i++){var s=r.charAt(i),o=s.charCodeAt(0);if(t[o]!==255)throw new TypeError(s+" is ambiguous");t[o]=i}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),d=Math.log(256)/Math.log(a);function h(f){if(f instanceof Uint8Array||(ArrayBuffer.isView(f)?f=new Uint8Array(f.buffer,f.byteOffset,f.byteLength):Array.isArray(f)&&(f=Uint8Array.from(f))),!(f instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(f.length===0)return"";for(var g=0,w=0,y=0,b=f.length;y!==b&&f[y]===0;)y++,g++;for(var v=(b-y)*d+1>>>0,E=new Uint8Array(v);y!==b;){for(var C=f[y],k=0,x=v-1;(C!==0||k<w)&&x!==-1;x--,k++)C+=256*E[x]>>>0,E[x]=C%a>>>0,C=C/a>>>0;if(C!==0)throw new Error("Non-zero carry");w=k,y++}for(var I=v-w;I!==v&&E[I]===0;)I++;for(var T=c.repeat(g);I<v;++I)T+=r.charAt(E[I]);return T}function p(f){if(typeof f!="string")throw new TypeError("Expected String");if(f.length===0)return new Uint8Array;var g=0;if(f[g]!==" "){for(var w=0,y=0;f[g]===c;)w++,g++;for(var b=(f.length-g)*l+1>>>0,v=new Uint8Array(b);f[g];){var E=t[f.charCodeAt(g)];if(E===255)return;for(var C=0,k=b-1;(E!==0||C<y)&&k!==-1;k--,C++)E+=a*v[k]>>>0,v[k]=E%256>>>0,E=E/256>>>0;if(E!==0)throw new Error("Non-zero carry");y=C,g++}if(f[g]!==" "){for(var x=b-y;x!==b&&v[x]===0;)x++;for(var I=new Uint8Array(w+(b-x)),T=w;x!==b;)I[T++]=v[x++];return I}}}function m(f){var g=p(f);if(g)return g;throw new Error(`Non-${e} character`)}return{encode:h,decodeUnsafe:p,decode:m}}var yce=gce,mce=yce;let wce=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseEncode");this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},bce=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseDecode");u(this,"prefixCodePoint");this.name=e,this.prefix=t;const i=t.codePointAt(0);if(i===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=i,this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return EN(this,e)}},vce=class{constructor(e){u(this,"decoders");this.decoders=e}or(e){return EN(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};function EN(r,e){return new vce({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}let Ece=class{constructor(e,t,n,i){u(this,"name");u(this,"prefix");u(this,"baseEncode");u(this,"baseDecode");u(this,"encoder");u(this,"decoder");this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=i,this.encoder=new wce(e,t,n),this.decoder=new bce(e,t,i)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};function SN({name:r,prefix:e,encode:t,decode:n}){return new Ece(r,e,t,n)}function By({name:r,prefix:e,alphabet:t}){const{encode:n,decode:i}=mce(t,r);return SN({prefix:e,name:r,encode:n,decode:s=>jd(i(s))})}function Sce(r,e,t,n){const i={};for(let d=0;d<e.length;++d)i[e[d]]=d;let s=r.length;for(;r[s-1]==="=";)--s;const o=new Uint8Array(s*t/8|0);let a=0,c=0,l=0;for(let d=0;d<s;++d){const h=i[r[d]];if(h===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|h,a+=t,a>=8&&(a-=8,o[l++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o}function xce(r,e,t){const n=e[e.length-1]==="=",i=(1<<t)-1;let s="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,s+=e[i&a>>o];if(o!==0&&(s+=e[i&a<<t-o]),n)for(;s.length*t&7;)s+="=";return s}function ii({name:r,prefix:e,bitsPerChar:t,alphabet:n}){return SN({prefix:e,name:r,encode(i){return xce(i,n,t)},decode(i){return Sce(i,n,t,r)}})}const Hd=By({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"});By({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});const Uy=ii({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});ii({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),ii({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),ii({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),ii({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),ii({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),ii({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),ii({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),ii({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const lc=By({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});By({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var Ace=AN,xN=128,Cce=-128,Ice=Math.pow(2,31);function AN(r,e,t){e=e||[],t=t||0;for(var n=t;r>=Ice;)e[t++]=r&255|xN,r/=128;for(;r&Cce;)e[t++]=r&255|xN,r>>>=7;return e[t]=r|0,AN.bytes=t-n+1,e}var kce=r7,_ce=128,CN=127;function r7(r,n){var t=0,n=n||0,i=0,s=n,o,a=r.length;do{if(s>=a)throw r7.bytes=0,new RangeError("Could not decode varint");o=r[s++],t+=i<28?(o&CN)<<i:(o&CN)*Math.pow(2,i),i+=7}while(o>=_ce);return r7.bytes=s-n,t}var Tce=Math.pow(2,7),Pce=Math.pow(2,14),Dce=Math.pow(2,21),$ce=Math.pow(2,28),Nce=Math.pow(2,35),Mce=Math.pow(2,42),Oce=Math.pow(2,49),Rce=Math.pow(2,56),Lce=Math.pow(2,63),Bce=function(r){return r<Tce?1:r<Pce?2:r<Dce?3:r<$ce?4:r<Nce?5:r<Mce?6:r<Oce?7:r<Rce?8:r<Lce?9:10},Uce={encode:Ace,decode:kce,encodingLength:Bce},Fy=Uce;function n7(r,e=0){return[Fy.decode(r,e),Fy.decode.bytes]}function zy(r,e,t=0){return Fy.encode(r,e,t),e}function Vy(r){return Fy.encodingLength(r)}function Ky(r,e){const t=e.byteLength,n=Vy(r),i=n+Vy(t),s=new Uint8Array(i+t);return zy(r,s,0),zy(t,s,n),s.set(e,i),new i7(r,t,e,s)}function Fce(r){const e=jd(r),[t,n]=n7(e),[i,s]=n7(e.subarray(n)),o=e.subarray(n+s);if(o.byteLength!==i)throw new Error("Incorrect length");return new i7(t,i,o,e)}function zce(r,e){if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&pce(r.bytes,t.bytes)}}let i7=class{constructor(e,t,n,i){u(this,"code");u(this,"size");u(this,"digest");u(this,"bytes");this.code=e,this.size=t,this.digest=n,this.bytes=i}};function IN(r,e){const{bytes:t,version:n}=r;switch(n){case 0:return Kce(t,s7(r),e??lc.encoder);default:return jce(t,s7(r),e??Uy.encoder)}}const kN=new WeakMap;function s7(r){const e=kN.get(r);if(e==null){const t=new Map;return kN.set(r,t),t}return e}let Ul=class Wr{constructor(e,t,n,i){u(this,"code");u(this,"version");u(this,"multihash");u(this,"bytes");u(this,"/");u(this,Tj,"CID");this.code=t,this.version=e,this.multihash=n,this.bytes=i,this["/"]=i}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==U1)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==Hce)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return Wr.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=Ky(e,t);return Wr.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return Wr.equals(this,e)}static equals(e,t){const n=t;return n!=null&&e.code===n.code&&e.version===n.version&&zce(e.multihash,n.multihash)}toString(e){return IN(this,e)}toJSON(){return{"/":IN(this)}}link(){return this}[(Tj=Symbol.toStringTag,Symbol.for("nodejs.util.inspect.custom"))](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof Wr)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:i,multihash:s,bytes:o}=t;return new Wr(n,i,s,o??_N(n,i,s.bytes))}else if(t[qce]===!0){const{version:n,multihash:i,code:s}=t,o=Fce(i);return Wr.create(n,s,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==U1)throw new Error(`Version 0 CID must use dag-pb (code: ${U1}) block encoding`);return new Wr(e,t,n,n.bytes)}case 1:{const i=_N(e,t,n.bytes);return new Wr(e,t,n,i)}default:throw new Error("Invalid version")}}static createV0(e){return Wr.create(0,U1,e)}static createV1(e,t){return Wr.create(1,e,t)}static decode(e){const[t,n]=Wr.decodeFirst(e);if(n.length!==0)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=Wr.inspectBytes(e),n=t.size-t.multihashSize,i=jd(e.subarray(n,n+t.multihashSize));if(i.byteLength!==t.multihashSize)throw new Error("Incorrect length");const s=i.subarray(t.multihashSize-t.digestSize),o=new i7(t.multihashCode,t.digestSize,s,i);return[t.version===0?Wr.createV0(o):Wr.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[h,p]=n7(e.subarray(t));return t+=p,h};let i=n(),s=U1;if(i===18?(i=0,t=0):s=n(),i!==0&&i!==1)throw new RangeError(`Invalid CID version ${i}`);const o=t,a=n(),c=n(),l=t+c,d=l-o;return{version:i,codec:s,multihashCode:a,digestSize:c,multihashSize:d,size:l}}static parse(e,t){const[n,i]=Vce(e,t),s=Wr.decode(i);if(s.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return s7(s).set(n,e),s}};function Vce(r,e){switch(r[0]){case"Q":{const t=e??lc;return[lc.prefix,t.decode(`${lc.prefix}${r}`)]}case lc.prefix:{const t=e??lc;return[lc.prefix,t.decode(r)]}case Uy.prefix:{const t=e??Uy;return[Uy.prefix,t.decode(r)]}case Hd.prefix:{const t=e??Hd;return[Hd.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}}function Kce(r,e,t){const{prefix:n}=t;if(n!==lc.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const i=e.get(n);if(i==null){const s=t.encode(r).slice(1);return e.set(n,s),s}else return i}function jce(r,e,t){const{prefix:n}=t,i=e.get(n);if(i==null){const s=t.encode(r);return e.set(n,s),s}else return i}const U1=112,Hce=18;function _N(r,e,t){const n=Vy(r),i=n+Vy(e),s=new Uint8Array(i+t.byteLength);return zy(r,s,0),zy(e,s,n),s.set(t,i),s}const qce=Symbol.for("@ipld/js-cid/CID");function TN({name:r,code:e,encode:t}){return new Wce(r,e,t)}let Wce=class{constructor(e,t,n){u(this,"name");u(this,"code");u(this,"encode");this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?Ky(this.code,t):t.then(n=>Ky(this.code,n))}else throw Error("Unknown type, must be binary type")}};function jy({enumerable:r=!0,configurable:e=!1}={}){return{enumerable:r,configurable:e,writable:!1}}function*Gce(r,e){if(e!=null&&typeof e=="object")if(Array.isArray(e))for(const[t,n]of e.entries()){const i=[...r,t],s=Ul.asCID(n);s!=null?yield[i.join("/"),s]:typeof n=="object"&&(yield*o7(n,i))}else{const t=Ul.asCID(e);t!=null?yield[r.join("/"),t]:yield*o7(e,r)}}function*o7(r,e){if(r==null||r instanceof Uint8Array)return;const t=Ul.asCID(r);t!=null&&(yield[e.join("/"),t]);for(const[n,i]of Object.entries(r)){const s=[...e,n];yield*Gce(s,i)}}function*Qce(r,e){if(Array.isArray(e))for(const[t,n]of e.entries()){const i=[...r,t];yield i.join("/"),typeof n=="object"&&Ul.asCID(n)==null&&(yield*a7(n,i))}else yield*a7(e,r)}function*a7(r,e){if(!(r==null||typeof r!="object"))for(const[t,n]of Object.entries(r)){const i=[...e,t];yield i.join("/"),n!=null&&!(n instanceof Uint8Array)&&typeof n=="object"&&Ul.asCID(n)==null&&(yield*Qce(i,n))}}function Yce(r,e){let t=r;for(const[n,i]of e.entries()){if(t=t[i],t==null)throw new Error(`Object has no property at ${e.slice(0,n+1).map(o=>`[${JSON.stringify(o)}]`).join("")}`);const s=Ul.asCID(t);if(s!=null)return{value:s,remaining:e.slice(n+1).join("/")}}return{value:t}}class Jce{constructor({cid:e,bytes:t,value:n}){u(this,"cid");u(this,"bytes");u(this,"value");u(this,"asBlock");if(e==null||t==null||typeof n>"u")throw new Error("Missing required argument");this.cid=e,this.bytes=t,this.value=n,this.asBlock=this,Object.defineProperties(this,{cid:jy(),bytes:jy(),value:jy(),asBlock:jy()})}links(){return o7(this.value,[])}tree(){return a7(this.value,[])}get(e="/"){return Yce(this.value,e.split("/").filter(Boolean))}}function Xce({bytes:r,cid:e,value:t,codec:n}){const i=t!==void 0?t:n==null?void 0:n.decode(r);if(i===void 0)throw new Error('Missing required argument, must either provide "value" or "codec"');return new Jce({cid:e,bytes:r,value:i})}const PN="/pin/",DN="/pinned-block/",c7=Hd,$N=1;function Hy(r){return r.version===0&&(r=r.toV1()),new At(`${PN}${r.toString(c7)}`)}class Zce{constructor(e,t,n){Ye(this,aa);u(this,"datastore");u(this,"blockstore");u(this,"getCodec");this.datastore=e,this.blockstore=t,this.getCodec=n}async*add(e,t={}){const n=Hy(e);if(await this.datastore.has(n))throw new Error("Already pinned");const i=Math.round(t.depth??1/0);if(i<0)throw new Error("Depth must be greater than or equal to 0");const s=new Ml({concurrency:$N});for await(const a of Ae(this,aa,B4).call(this,e,s,{...t,depth:i}))await Ae(this,aa,LA).call(this,a,c=>c.pinnedBy.find(l=>qe(l,e.bytes))!=null?!1:(c.pinCount++,c.pinnedBy.push(e.bytes),!0),t),yield a;const o={depth:i,metadata:t.metadata??{}};await this.datastore.put(n,Yg(o),t)}async*rm(e,t={}){const n=Hy(e),i=await this.datastore.get(n,t),s=Ma(i);await this.datastore.delete(n,t);const o=new Ml({concurrency:$N});for await(const a of Ae(this,aa,B4).call(this,e,o,{...t,depth:s.depth}))await Ae(this,aa,LA).call(this,a,c=>(c.pinCount--,c.pinnedBy=c.pinnedBy.filter(l=>qe(l,e.bytes)),!0),{...t,depth:s.depth}),yield a}async*ls(e={}){for await(const{key:t,value:n}of this.datastore.query({prefix:PN+(e.cid!=null?`${e.cid.toString(Hd)}`:"")},e)){const i=Ul.parse(t.toString().substring(5),Hd),s=Ma(n);yield{cid:i,...s}}}async isPinned(e,t={}){const n=new At(`${DN}${c7.encode(e.multihash.bytes)}`);return this.datastore.has(n,t)}async get(e,t){const n=Hy(e),i=await this.datastore.get(n,t);return Ma(i)}async setMetadata(e,t,n){const i=Hy(e),s=await this.datastore.get(i,n),o=Ma(s);o.metadata=t??{},await this.datastore.put(i,Yg(o),n)}}aa=new WeakSet,B4=async function*(e,t,n){if(n.depth===-1)return;const i=await this.getCodec(e.code),s=await this.blockstore.get(e,n),o=Xce({bytes:s,cid:e,codec:i});yield e;for await(const[,a]of o.links())yield*await t.add(async()=>Ae(this,aa,B4).call(this,a,t,{...n,depth:n.depth-1}))},LA=async function(e,t,n){var a;const i=new At(`${DN}${c7.encode(e.multihash.bytes)}`);let s={pinCount:0,pinnedBy:[]};try{s=Ma(await this.datastore.get(i,n))}catch(c){if(c.name!=="NotFoundError")throw c}if(t(s)){if(s.pinCount===0&&await this.datastore.has(i)){await this.datastore.delete(i);return}await this.datastore.put(i,Yg(s),n),(a=n.onProgress)==null||a.call(n,new ke("helia:pin:add",e))}};const ele=1,tle=5;class NN extends Error{constructor(e="Insufficient providers found"){super(e),this.name="InsufficientProvidersError"}}u(NN,"name","InsufficientProvidersError");class F1 extends Error{constructor(e="No routers available"){super(e),this.name="NoRoutersAvailableError"}}u(F1,"name","NoRoutersAvailableError");class MN extends Error{constructor(e="Unknown hash algorithm"){super(e),this.name="UnknownHashAlgorithmError"}}u(MN,"name","UnknownHashAlgorithmError");class ON extends Error{constructor(e="Unknown codec"){super(e),this.name="UnknownCodecError"}}u(ON,"name","UnknownCodecError");const rle=5;class nle{constructor(e,t){u(this,"log");u(this,"routers");u(this,"providerLookupConcurrency");var n,i,s,o,a,c,l;this.log=e.logger.forComponent("helia:routing"),this.routers=t.routers??[],this.providerLookupConcurrency=t.providerLookupConcurrency??rle,this.findProviders=((n=e.metrics)==null?void 0:n.traceFunction("helia.routing.findProviders",this.findProviders.bind(this),{optionsIndex:1}))??this.findProviders,this.provide=((i=e.metrics)==null?void 0:i.traceFunction("helia.routing.provide",this.provide.bind(this),{optionsIndex:1}))??this.provide,this.cancelReprovide=((s=e.metrics)==null?void 0:s.traceFunction("helia.routing.cancelReprovide",this.cancelReprovide.bind(this),{optionsIndex:1}))??this.cancelReprovide,this.put=((o=e.metrics)==null?void 0:o.traceFunction("helia.routing.put",this.put.bind(this),{optionsIndex:2}))??this.put,this.get=((a=e.metrics)==null?void 0:a.traceFunction("helia.routing.get",this.get.bind(this),{optionsIndex:1}))??this.get,this.findPeer=((c=e.metrics)==null?void 0:c.traceFunction("helia.routing.findPeer",this.findPeer.bind(this),{optionsIndex:1}))??this.findPeer,this.getClosestPeers=((l=e.metrics)==null?void 0:l.traceFunction("helia.routing.getClosestPeers",this.getClosestPeers.bind(this),{optionsIndex:1}))??this.getClosestPeers}async start(){await xo(...this.routers)}async stop(){await Ka(...this.routers)}async*findProviders(e,t={}){if(this.routers.length===0)throw new F1("No content routers available");const n=new ic({concurrency:this.providerLookupConcurrency});n.addEventListener("error",()=>{});for await(const i of Pa(n.toGenerator(),...Fl(this.routers,"findProviders").map(s=>s.findProviders(e,t))))if(i!=null){if(i.multiaddrs.length===0){if(n.find(i.id)!=null)continue;n.add(async()=>{try{const s=await this.findPeer(i.id,t);return s.multiaddrs.length===0?null:s}catch(s){return this.log.error("could not load multiaddrs for peer %p",i.id,s),null}},{peerId:i.id,signal:t.signal}).catch(s=>{this.log.error("could not load multiaddrs for peer %p",i.id,s)})}yield i}}async provide(e,t={}){if(this.routers.length===0)throw new F1("No content routers available");await Promise.all(Fl(this.routers,"provide").map(async n=>{await n.provide(e,t)}))}async cancelReprovide(e,t={}){await Promise.all(Fl(this.routers,"cancelReprovide").map(async n=>{await n.cancelReprovide(e,t)}))}async put(e,t,n){await Promise.all(Fl(this.routers,"put").map(async i=>{await i.put(e,t,n)}))}async get(e,t){return Promise.any(Fl(this.routers,"get").map(async n=>n.get(e,t)))}async findPeer(e,t){if(this.routers.length===0)throw new F1("No peer routers available");const n=this,i=Pa(...Fl(this.routers,"findPeer").map(s=>async function*(){try{yield await s.findPeer(e,t)}catch(o){n.log.error(o)}}()));for await(const s of i)if(s!=null)return s;throw new Zt("Could not find peer in routing")}async*getClosestPeers(e,t={}){if(this.routers.length===0)throw new F1("No peer routers available");for await(const n of Pa(...Fl(this.routers,"getClosestPeers").map(i=>i.getClosestPeers(e,t))))n!=null&&(yield n)}}function Fl(r,e){return r.filter(t=>t[e]!=null)}const uc={},zl=r=>{r.addEventListener("message",e=>{zl.dispatchEvent("message",r,e)}),r.port!=null&&r.port.addEventListener("message",e=>{zl.dispatchEvent("message",r,e)})};zl.addEventListener=(r,e)=>{uc[r]==null&&(uc[r]=[]),uc[r].push(e)},zl.removeEventListener=(r,e)=>{uc[r]!=null&&(uc[r]=uc[r].filter(t=>t===e))},zl.dispatchEvent=function(r,e,t){uc[r]!=null&&uc[r].forEach(n=>n(e,t))};const RN="lock:worker:request-read",LN="lock:worker:release-read",BN="lock:master:grant-read",UN="lock:worker:request-write",FN="lock:worker:release-write",zN="lock:master:grant-write",ile=(r=21)=>Math.random().toString().substring(2),VN=(r,e,t,n,i)=>(s,o)=>{if(o.data.type!==t)return;const a={type:o.data.type,name:o.data.name,identifier:o.data.identifier};r.dispatchEvent(new MessageEvent(e,{data:{name:a.name,handler:async()=>{s.postMessage({type:i,name:a.name,identifier:a.identifier}),await new Promise(c=>{const l=d=>{if((d==null?void 0:d.data)==null)return;const h={type:d.data.type,name:d.data.name,identifier:d.data.identifier};h.type===n&&h.identifier===a.identifier&&(s.removeEventListener("message",l),c())};s.addEventListener("message",l)})}}}))},KN=(r,e,t,n)=>async()=>{const i=ile();return globalThis.postMessage({type:e,identifier:i,name:r}),new Promise(s=>{const o=a=>{if((a==null?void 0:a.data)==null)return;const c={type:a.data.type,identifier:a.data.identifier};c.type===t&&c.identifier===i&&(globalThis.removeEventListener("message",o),s(()=>{globalThis.postMessage({type:n,identifier:i,name:r})}))};globalThis.addEventListener("message",o)})},sle={singleProcess:!1},ole=r=>{if(r=Object.assign({},sle,r),!!globalThis.document||r.singleProcess){const t=new EventTarget;return zl.addEventListener("message",VN(t,"requestReadLock",RN,LN,BN)),zl.addEventListener("message",VN(t,"requestWriteLock",UN,FN,zN)),t}return{isWorker:!0,readLock:t=>KN(t,RN,BN,LN),writeLock:t=>KN(t,UN,zN,FN)}},Vl={};let dc;async function l7(r,e){let t;const n=new Promise(i=>{t=i});return r.add(async()=>jf((async()=>{await new Promise(i=>{t(()=>{i()})})})(),{milliseconds:e.timeout})),n}const ale=(r,e)=>{if(dc.isWorker===!0)return{readLock:dc.readLock(r,e),writeLock:dc.writeLock(r,e)};const t=new Ta({concurrency:1});let n;return{async readLock(){if(n!=null)return l7(n,e);n=new Ta({concurrency:e.concurrency,autoStart:!1});const i=n,s=l7(n,e);return t.add(async()=>{i.start(),await i.onIdle().then(()=>{n===i&&(n=null)})}),s},async writeLock(){return n=null,l7(t,e)}}},cle={name:"lock",concurrency:1/0,timeout:846e5,singleProcess:!1};function u7(r){const e=Object.assign({},cle,r);return dc==null&&(dc=ole(e),dc.isWorker!==!0&&(dc.addEventListener("requestReadLock",t=>{Vl[t.data.name]!=null&&Vl[t.data.name].readLock().then(async n=>t.data.handler().finally(()=>{n()}))}),dc.addEventListener("requestWriteLock",async t=>{Vl[t.data.name]!=null&&Vl[t.data.name].writeLock().then(async n=>t.data.handler().finally(()=>{n()}))}))),Vl[e.name]==null&&(Vl[e.name]=ale(e.name,e)),Vl[e.name]}class lle{constructor(e,t,n={}){u(this,"lock");u(this,"child");u(this,"pins");u(this,"started");this.child=e,this.pins=t,this.lock=u7({singleProcess:n.holdGcLock}),this.started=!1}isStarted(){return this.started}async start(){await xo(this.child),this.started=!0}async stop(){await Ka(this.child),this.started=!1}unwrap(){return this.child}async put(e,t,n={}){var s;(s=n==null?void 0:n.signal)==null||s.throwIfAborted();const i=await this.lock.readLock();try{return await this.child.put(e,t,n)}finally{i()}}async*putMany(e,t={}){var i;(i=t==null?void 0:t.signal)==null||i.throwIfAborted();const n=await this.lock.readLock();try{yield*this.child.putMany(e,t)}finally{n()}}async get(e,t={}){var i;(i=t==null?void 0:t.signal)==null||i.throwIfAborted();const n=await this.lock.readLock();try{return await this.child.get(e,t)}finally{n()}}async*getMany(e,t={}){var i;(i=t==null?void 0:t.signal)==null||i.throwIfAborted();const n=await this.lock.readLock();try{yield*this.child.getMany(e,t)}finally{n()}}async delete(e,t={}){var i;(i=t==null?void 0:t.signal)==null||i.throwIfAborted();const n=await this.lock.writeLock();try{if(await this.pins.isPinned(e))throw new Error("CID was pinned");await this.child.delete(e,t)}finally{n()}}async*deleteMany(e,t={}){var i;(i=t==null?void 0:t.signal)==null||i.throwIfAborted();const n=await this.lock.writeLock();try{const s=this;yield*this.child.deleteMany(async function*(){for await(const o of e){if(await s.pins.isPinned(o))throw new Error("CID was pinned");yield o}}(),t)}finally{n()}}async has(e,t={}){var i;(i=t==null?void 0:t.signal)==null||i.throwIfAborted();const n=await this.lock.readLock();try{return await this.child.has(e,t)}finally{n()}}async*getAll(e={}){var n;(n=e==null?void 0:e.signal)==null||n.throwIfAborted();const t=await this.lock.readLock();try{yield*this.child.getAll(e)}finally{t()}}createSession(e,t){var n;return(n=t==null?void 0:t.signal)==null||n.throwIfAborted(),this.child.createSession(e,t)}}const d7=new At("/version"),jN=1;async function ule(r){if(!await r.has(d7)){await r.put(d7,ie(`${jN}`));return}const e=await r.get(d7),t=re(e);if(parseInt(t,10)!==jN)throw new Error("Unknown datastore version, a datastore migration may be required")}class dle extends Array{constructor(){super(),this.inRecursive=[]}prefix(e){const t=this.inRecursive[this.inRecursive.length-1];t&&(t.type===V.array&&(t.elements++,t.elements!==1&&e.push([44])),t.type===V.map&&(t.elements++,t.elements!==1&&(t.elements%2===1?e.push([44]):e.push([58]))))}[V.uint.major](e,t){this.prefix(e);const n=String(t.value),i=[];for(let s=0;s<n.length;s++)i[s]=n.charCodeAt(s);e.push(i)}[V.negint.major](e,t){this[V.uint.major](e,t)}[V.bytes.major](e,t){throw new Error(`${il} unsupported type: Uint8Array`)}[V.string.major](e,t){this.prefix(e);const n=R_(JSON.stringify(t.value));e.push(n.length>32?m6(n):n)}[V.array.major](e,t){this.prefix(e),this.inRecursive.push({type:V.array,elements:0}),e.push([91])}[V.map.major](e,t){this.prefix(e),this.inRecursive.push({type:V.map,elements:0}),e.push([123])}[V.tag.major](e,t){}[V.float.major](e,t){if(t.type.name==="break"){const o=this.inRecursive.pop();if(o){if(o.type===V.array)e.push([93]);else if(o.type===V.map)e.push([125]);else throw new Error("Unexpected recursive type; this should not happen!");return}throw new Error("Unexpected break; this should not happen!")}if(t.value===void 0)throw new Error(`${il} unsupported type: undefined`);if(this.prefix(e),t.type.name==="true"){e.push([116,114,117,101]);return}else if(t.type.name==="false"){e.push([102,97,108,115,101]);return}else if(t.type.name==="null"){e.push([110,117,108,108]);return}const n=String(t.value),i=[];let s=!1;for(let o=0;o<n.length;o++)i[o]=n.charCodeAt(o),!s&&(i[o]===46||i[o]===101||i[o]===69)&&(s=!0);s||(i.push(46),i.push(48)),e.push(i)}}function hle(r,e){if(Array.isArray(r[0])||Array.isArray(e[0]))throw new Error(`${il} complex map keys are not supported`);const t=r[0],n=e[0];if(t.type!==V.string||n.type!==V.string)throw new Error(`${il} non-string map keys are not supported`);if(t<n)return-1;if(t>n)return 1;throw new Error(`${il} unexpected duplicate map keys, this is not supported`)}const fle={addBreakTokens:!0,mapSorter:hle};function ple(r,e){return e=Object.assign({},fle,e),Q_(r,new dle,e)}class HN{constructor(e,t={}){this._pos=0,this.data=e,this.options=t,this.modeStack=["value"],this.lastToken=""}pos(){return this._pos}done(){return this._pos>=this.data.length}ch(){return this.data[this._pos]}currentMode(){return this.modeStack[this.modeStack.length-1]}skipWhitespace(){let e=this.ch();for(;e===32||e===9||e===13||e===10;)e=this.data[++this._pos]}expect(e){if(this.data.length-this._pos<e.length)throw new Error(`${Ce} unexpected end of input at position ${this._pos}`);for(let t=0;t<e.length;t++)if(this.data[this._pos++]!==e[t])throw new Error(`${Ce} unexpected token at position ${this._pos}, expected to find '${String.fromCharCode(...e)}'`)}parseNumber(){const e=this._pos;let t=!1,n=!1;const i=a=>{for(;!this.done();){const c=this.ch();if(a.includes(c))this._pos++;else break}};if(this.ch()===45&&(t=!0,this._pos++),this.ch()===48)if(this._pos++,this.ch()===46)this._pos++,n=!0;else return new ne(V.uint,0,this._pos-e);if(i([48,49,50,51,52,53,54,55,56,57]),t&&this._pos===e+1)throw new Error(`${Ce} unexpected token at position ${this._pos}`);if(!this.done()&&this.ch()===46){if(n)throw new Error(`${Ce} unexpected token at position ${this._pos}`);n=!0,this._pos++,i([48,49,50,51,52,53,54,55,56,57])}!this.done()&&(this.ch()===101||this.ch()===69)&&(n=!0,this._pos++,!this.done()&&(this.ch()===43||this.ch()===45)&&this._pos++,i([48,49,50,51,52,53,54,55,56,57]));const s=String.fromCharCode.apply(null,this.data.subarray(e,this._pos)),o=parseFloat(s);return n?new ne(V.float,o,this._pos-e):this.options.allowBigInt!==!0||Number.isSafeInteger(o)?new ne(o>=0?V.uint:V.negint,o,this._pos-e):new ne(o>=0?V.uint:V.negint,BigInt(s),this._pos-e)}parseString(){if(this.ch()!==34)throw new Error(`${Ce} unexpected character at position ${this._pos}; this shouldn't happen`);this._pos++;for(let s=this._pos,o=0;s<this.data.length&&o<65536;s++,o++){const a=this.data[s];if(a===92||a<32||a>=128)break;if(a===34){const c=String.fromCharCode.apply(null,this.data.subarray(this._pos,s));return this._pos=s+1,new ne(V.string,c,o)}}const e=this._pos,t=[],n=()=>{if(this._pos+4>=this.data.length)throw new Error(`${Ce} unexpected end of unicode escape sequence at position ${this._pos}`);let s=0;for(let o=0;o<4;o++){let a=this.ch();if(a>=48&&a<=57)a-=48;else if(a>=97&&a<=102)a=a-97+10;else if(a>=65&&a<=70)a=a-65+10;else throw new Error(`${Ce} unexpected unicode escape character at position ${this._pos}`);s=s*16+a,this._pos++}return s},i=()=>{const s=this.ch();let o=null,a=s>239?4:s>223?3:s>191?2:1;if(this._pos+a>this.data.length)throw new Error(`${Ce} unexpected unicode sequence at position ${this._pos}`);let c,l,d,h;switch(a){case 1:s<128&&(o=s);break;case 2:c=this.data[this._pos+1],(c&192)===128&&(h=(s&31)<<6|c&63,h>127&&(o=h));break;case 3:c=this.data[this._pos+1],l=this.data[this._pos+2],(c&192)===128&&(l&192)===128&&(h=(s&15)<<12|(c&63)<<6|l&63,h>2047&&(h<55296||h>57343)&&(o=h));break;case 4:c=this.data[this._pos+1],l=this.data[this._pos+2],d=this.data[this._pos+3],(c&192)===128&&(l&192)===128&&(d&192)===128&&(h=(s&15)<<18|(c&63)<<12|(l&63)<<6|d&63,h>65535&&h<1114112&&(o=h))}o===null?(o=65533,a=1):o>65535&&(o-=65536,t.push(o>>>10&1023|55296),o=56320|o&1023),t.push(o),this._pos+=a};for(;!this.done();){const s=this.ch();let o;switch(s){case 92:if(this._pos++,this.done())throw new Error(`${Ce} unexpected string termination at position ${this._pos}`);switch(o=this.ch(),this._pos++,o){case 34:case 39:case 92:case 47:t.push(o);break;case 98:t.push(8);break;case 116:t.push(9);break;case 110:t.push(10);break;case 102:t.push(12);break;case 114:t.push(13);break;case 117:t.push(n());break;default:throw new Error(`${Ce} unexpected string escape character at position ${this._pos}`)}break;case 34:return this._pos++,new ne(V.string,F_(t),this._pos-e);default:if(s<32)throw new Error(`${Ce} invalid control character at position ${this._pos}`);s<128?(t.push(s),this._pos++):i()}}throw new Error(`${Ce} unexpected end of string at position ${this._pos}`)}parseValue(){switch(this.ch()){case 123:return this.modeStack.push("obj-start"),this._pos++,new ne(V.map,1/0,1);case 91:return this.modeStack.push("array-start"),this._pos++,new ne(V.array,1/0,1);case 34:return this.parseString();case 110:return this.expect([110,117,108,108]),new ne(V.null,null,4);case 102:return this.expect([102,97,108,115,101]),new ne(V.false,!1,5);case 116:return this.expect([116,114,117,101]),new ne(V.true,!0,4);case 45:case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:return this.parseNumber();default:throw new Error(`${Ce} unexpected character at position ${this._pos}`)}}next(){switch(this.skipWhitespace(),this.currentMode()){case"value":return this.modeStack.pop(),this.parseValue();case"array-value":{if(this.modeStack.pop(),this.ch()===93)return this._pos++,this.skipWhitespace(),new ne(V.break,void 0,1);if(this.ch()!==44)throw new Error(`${Ce} unexpected character at position ${this._pos}, was expecting array delimiter but found '${String.fromCharCode(this.ch())}'`);return this._pos++,this.modeStack.push("array-value"),this.skipWhitespace(),this.parseValue()}case"array-start":return this.modeStack.pop(),this.ch()===93?(this._pos++,this.skipWhitespace(),new ne(V.break,void 0,1)):(this.modeStack.push("array-value"),this.skipWhitespace(),this.parseValue());case"obj-key":if(this.ch()===125)return this.modeStack.pop(),this._pos++,this.skipWhitespace(),new ne(V.break,void 0,1);if(this.ch()!==44)throw new Error(`${Ce} unexpected character at position ${this._pos}, was expecting object delimiter but found '${String.fromCharCode(this.ch())}'`);this._pos++,this.skipWhitespace();case"obj-start":{if(this.modeStack.pop(),this.ch()===125)return this._pos++,this.skipWhitespace(),new ne(V.break,void 0,1);const e=this.parseString();if(this.skipWhitespace(),this.ch()!==58)throw new Error(`${Ce} unexpected character at position ${this._pos}, was expecting key/value delimiter ':' but found '${String.fromCharCode(this.ch())}'`);return this._pos++,this.modeStack.push("obj-value"),e}case"obj-value":return this.modeStack.pop(),this.modeStack.push("obj-key"),this.skipWhitespace(),this.parseValue();default:throw new Error(`${Ce} unexpected parse state at position ${this._pos}; this shouldn't happen`)}}}function gle(r,e){return e=Object.assign({tokenizer:new HN(r,e)},e),Ma(r,e)}function yle(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function h7(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function mle(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var i=0;i<r.length;i++){var s=r.charAt(i),o=s.charCodeAt(0);if(t[o]!==255)throw new TypeError(s+" is ambiguous");t[o]=i}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),d=Math.log(256)/Math.log(a);function h(f){if(f instanceof Uint8Array||(ArrayBuffer.isView(f)?f=new Uint8Array(f.buffer,f.byteOffset,f.byteLength):Array.isArray(f)&&(f=Uint8Array.from(f))),!(f instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(f.length===0)return"";for(var g=0,w=0,y=0,b=f.length;y!==b&&f[y]===0;)y++,g++;for(var v=(b-y)*d+1>>>0,E=new Uint8Array(v);y!==b;){for(var C=f[y],k=0,x=v-1;(C!==0||k<w)&&x!==-1;x--,k++)C+=256*E[x]>>>0,E[x]=C%a>>>0,C=C/a>>>0;if(C!==0)throw new Error("Non-zero carry");w=k,y++}for(var I=v-w;I!==v&&E[I]===0;)I++;for(var T=c.repeat(g);I<v;++I)T+=r.charAt(E[I]);return T}function p(f){if(typeof f!="string")throw new TypeError("Expected String");if(f.length===0)return new Uint8Array;var g=0;if(f[g]!==" "){for(var w=0,y=0;f[g]===c;)w++,g++;for(var b=(f.length-g)*l+1>>>0,v=new Uint8Array(b);f[g];){var E=t[f.charCodeAt(g)];if(E===255)return;for(var C=0,k=b-1;(E!==0||C<y)&&k!==-1;k--,C++)E+=a*v[k]>>>0,v[k]=E%256>>>0,E=E/256>>>0;if(E!==0)throw new Error("Non-zero carry");y=C,g++}if(f[g]!==" "){for(var x=b-y;x!==b&&v[x]===0;)x++;for(var I=new Uint8Array(w+(b-x)),T=w;x!==b;)I[T++]=v[x++];return I}}}function m(f){var g=p(f);if(g)return g;throw new Error(`Non-${e} character`)}return{encode:h,decodeUnsafe:p,decode:m}}var wle=mle,ble=wle;let vle=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseEncode");this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},Ele=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseDecode");u(this,"prefixCodePoint");this.name=e,this.prefix=t;const i=t.codePointAt(0);if(i===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=i,this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return qN(this,e)}},Sle=class{constructor(e){u(this,"decoders");this.decoders=e}or(e){return qN(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};function qN(r,e){return new Sle({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}let xle=class{constructor(e,t,n,i){u(this,"name");u(this,"prefix");u(this,"baseEncode");u(this,"baseDecode");u(this,"encoder");u(this,"decoder");this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=i,this.encoder=new vle(e,t,n),this.decoder=new Ele(e,t,i)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};function WN({name:r,prefix:e,encode:t,decode:n}){return new xle(r,e,t,n)}function qy({name:r,prefix:e,alphabet:t}){const{encode:n,decode:i}=ble(t,r);return WN({prefix:e,name:r,encode:n,decode:s=>h7(i(s))})}function Ale(r,e,t,n){const i={};for(let d=0;d<e.length;++d)i[e[d]]=d;let s=r.length;for(;r[s-1]==="=";)--s;const o=new Uint8Array(s*t/8|0);let a=0,c=0,l=0;for(let d=0;d<s;++d){const h=i[r[d]];if(h===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|h,a+=t,a>=8&&(a-=8,o[l++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o}function Cle(r,e,t){const n=e[e.length-1]==="=",i=(1<<t)-1;let s="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,s+=e[i&a>>o];if(o!==0&&(s+=e[i&a<<t-o]),n)for(;s.length*t&7;)s+="=";return s}function si({name:r,prefix:e,bitsPerChar:t,alphabet:n}){return WN({prefix:e,name:r,encode(i){return Cle(i,n,t)},decode(i){return Ale(i,n,t,r)}})}const Wy=si({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});si({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),si({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),si({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),si({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),si({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),si({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),si({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),si({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const f7=qy({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"});qy({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});const hc=qy({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});qy({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var Ile=QN,GN=128,kle=-128,_le=Math.pow(2,31);function QN(r,e,t){e=e||[],t=t||0;for(var n=t;r>=_le;)e[t++]=r&255|GN,r/=128;for(;r&kle;)e[t++]=r&255|GN,r>>>=7;return e[t]=r|0,QN.bytes=t-n+1,e}var Tle=p7,Ple=128,YN=127;function p7(r,n){var t=0,n=n||0,i=0,s=n,o,a=r.length;do{if(s>=a)throw p7.bytes=0,new RangeError("Could not decode varint");o=r[s++],t+=i<28?(o&YN)<<i:(o&YN)*Math.pow(2,i),i+=7}while(o>=Ple);return p7.bytes=s-n,t}var Dle=Math.pow(2,7),$le=Math.pow(2,14),Nle=Math.pow(2,21),Mle=Math.pow(2,28),Ole=Math.pow(2,35),Rle=Math.pow(2,42),Lle=Math.pow(2,49),Ble=Math.pow(2,56),Ule=Math.pow(2,63),Fle=function(r){return r<Dle?1:r<$le?2:r<Nle?3:r<Mle?4:r<Ole?5:r<Rle?6:r<Lle?7:r<Ble?8:r<Ule?9:10},zle={encode:Ile,decode:Tle,encodingLength:Fle},Gy=zle;function g7(r,e=0){return[Gy.decode(r,e),Gy.decode.bytes]}function Qy(r,e,t=0){return Gy.encode(r,e,t),e}function Yy(r){return Gy.encodingLength(r)}function Vle(r,e){const t=e.byteLength,n=Yy(r),i=n+Yy(t),s=new Uint8Array(i+t);return Qy(r,s,0),Qy(t,s,n),s.set(e,i),new y7(r,t,e,s)}function Kle(r){const e=h7(r),[t,n]=g7(e),[i,s]=g7(e.subarray(n)),o=e.subarray(n+s);if(o.byteLength!==i)throw new Error("Incorrect length");return new y7(t,i,o,e)}function jle(r,e){if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&yle(r.bytes,t.bytes)}}let y7=class{constructor(e,t,n,i){u(this,"code");u(this,"size");u(this,"digest");u(this,"bytes");this.code=e,this.size=t,this.digest=n,this.bytes=i}};function JN(r,e){const{bytes:t,version:n}=r;switch(n){case 0:return qle(t,m7(r),e??hc.encoder);default:return Wle(t,m7(r),e??Wy.encoder)}}const XN=new WeakMap;function m7(r){const e=XN.get(r);if(e==null){const t=new Map;return XN.set(r,t),t}return e}let ZN=class Gr{constructor(e,t,n,i){u(this,"code");u(this,"version");u(this,"multihash");u(this,"bytes");u(this,"/");u(this,Pj,"CID");this.code=t,this.version=e,this.multihash=n,this.bytes=i,this["/"]=i}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==z1)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==Gle)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return Gr.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=Vle(e,t);return Gr.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return Gr.equals(this,e)}static equals(e,t){const n=t;return n!=null&&e.code===n.code&&e.version===n.version&&jle(e.multihash,n.multihash)}toString(e){return JN(this,e)}toJSON(){return{"/":JN(this)}}link(){return this}[(Pj=Symbol.toStringTag,Symbol.for("nodejs.util.inspect.custom"))](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof Gr)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:i,multihash:s,bytes:o}=t;return new Gr(n,i,s,o??eM(n,i,s.bytes))}else if(t[Qle]===!0){const{version:n,multihash:i,code:s}=t,o=Kle(i);return Gr.create(n,s,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==z1)throw new Error(`Version 0 CID must use dag-pb (code: ${z1}) block encoding`);return new Gr(e,t,n,n.bytes)}case 1:{const i=eM(e,t,n.bytes);return new Gr(e,t,n,i)}default:throw new Error("Invalid version")}}static createV0(e){return Gr.create(0,z1,e)}static createV1(e,t){return Gr.create(1,e,t)}static decode(e){const[t,n]=Gr.decodeFirst(e);if(n.length!==0)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=Gr.inspectBytes(e),n=t.size-t.multihashSize,i=h7(e.subarray(n,n+t.multihashSize));if(i.byteLength!==t.multihashSize)throw new Error("Incorrect length");const s=i.subarray(t.multihashSize-t.digestSize),o=new y7(t.multihashCode,t.digestSize,s,i);return[t.version===0?Gr.createV0(o):Gr.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[h,p]=g7(e.subarray(t));return t+=p,h};let i=n(),s=z1;if(i===18?(i=0,t=0):s=n(),i!==0&&i!==1)throw new RangeError(`Invalid CID version ${i}`);const o=t,a=n(),c=n(),l=t+c,d=l-o;return{version:i,codec:s,multihashCode:a,digestSize:c,multihashSize:d,size:l}}static parse(e,t){const[n,i]=Hle(e,t),s=Gr.decode(i);if(s.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return m7(s).set(n,e),s}};function Hle(r,e){switch(r[0]){case"Q":{const t=e??hc;return[hc.prefix,t.decode(`${hc.prefix}${r}`)]}case hc.prefix:{const t=e??hc;return[hc.prefix,t.decode(r)]}case Wy.prefix:{const t=e??Wy;return[Wy.prefix,t.decode(r)]}case f7.prefix:{const t=e??f7;return[f7.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}}function qle(r,e,t){const{prefix:n}=t;if(n!==hc.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const i=e.get(n);if(i==null){const s=t.encode(r).slice(1);return e.set(n,s),s}else return i}function Wle(r,e,t){const{prefix:n}=t,i=e.get(n);if(i==null){const s=t.encode(r);return e.set(n,s),s}else return i}const z1=112,Gle=18;function eM(r,e,t){const n=Yy(r),i=n+Yy(e),s=new Uint8Array(i+t.byteLength);return Qy(r,s,0),Qy(e,s,n),s.set(t,i),s}const Qle=Symbol.for("@ipld/js-cid/CID"),tM=si({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6});si({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),si({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),si({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});function Yle(r){return r instanceof ArrayBuffer?new Uint8Array(r,0,r.byteLength):r}function Jle(r){if(r.asCID!==r&&r["/"]!==r.bytes)return null;const e=ZN.asCID(r);if(!e)return null;const t=e.toString();return[new ne(V.map,1/0,1),new ne(V.string,"/",1),new ne(V.string,t,t.length),new ne(V.break,void 0,1)]}function Jy(r){const e=tM.encode(r).slice(1);return[new ne(V.map,1/0,1),new ne(V.string,"/",1),new ne(V.map,1/0,1),new ne(V.string,"bytes",5),new ne(V.string,e,e.length),new ne(V.break,void 0,1),new ne(V.break,void 0,1)]}function rs(r){return Jy(new Uint8Array(r.buffer,r.byteOffset,r.byteLength))}function Xle(r){return Jy(new Uint8Array(r))}function Zle(){throw new Error("`undefined` is not supported by the IPLD Data Model and cannot be encoded")}function eue(r){if(Number.isNaN(r))throw new Error("`NaN` is not supported by the IPLD Data Model and cannot be encoded");if(r===1/0||r===-1/0)throw new Error("`Infinity` and `-Infinity` is not supported by the IPLD Data Model and cannot be encoded");return null}const tue={typeEncoders:{Object:Jle,Buffer:Jy,Uint8Array:Jy,Int8Array:rs,Uint16Array:rs,Int16Array:rs,Uint32Array:rs,Int32Array:rs,Float32Array:rs,Float64Array:rs,Uint8ClampedArray:rs,BigInt64Array:rs,BigUint64Array:rs,DataView:rs,ArrayBuffer:Xle,undefined:Zle,number:eue}};class rue extends HN{constructor(e,t){super(e,t),this.tokenBuffer=[]}done(){return this.tokenBuffer.length===0&&super.done()}_next(){return this.tokenBuffer.length>0?this.tokenBuffer.pop():super.next()}next(){const e=this._next();if(e.type===V.map){const t=this._next();if(t.type===V.string&&t.value==="/"){const n=this._next();if(n.type===V.string){if(this._next().type!==V.break)throw new Error("Invalid encoded CID form");return this.tokenBuffer.push(n),new ne(V.tag,42,0)}if(n.type===V.map){const i=this._next();if(i.type===V.string&&i.value==="bytes"){const s=this._next();if(s.type===V.string){for(let a=0;a<2;a++)if(this._next().type!==V.break)throw new Error("Invalid encoded Bytes form");const o=tM.decode(`m${s.value}`);return new ne(V.bytes,o,s.value.length)}this.tokenBuffer.push(s)}this.tokenBuffer.push(i)}this.tokenBuffer.push(n)}this.tokenBuffer.push(t)}return e}}const w7={allowIndefinite:!1,allowUndefined:!1,allowNaN:!1,allowInfinity:!1,allowBigInt:!0,strict:!0,useMaps:!1,rejectDuplicateMapKeys:!0,tags:[]};w7.tags[42]=ZN.parse;const nue="dag-json",rM=297,nM=r=>ple(r,tue),iM=r=>{const e=Yle(r),t=Object.assign(w7,{tokenizer:new rue(e,w7)});return gle(e,t)},sM=r=>iue.decode(nM(r)),iue=new TextDecoder,sue=r=>iM(oue.encode(r)),oue=new TextEncoder,aue=Object.freeze(Object.defineProperty({__proto__:null,code:rM,decode:iM,encode:nM,format:sM,name:nue,parse:sue,stringify:sM},Symbol.toStringTag,{value:"Module"}));function cue(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function b7(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function lue(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var i=0;i<r.length;i++){var s=r.charAt(i),o=s.charCodeAt(0);if(t[o]!==255)throw new TypeError(s+" is ambiguous");t[o]=i}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),d=Math.log(256)/Math.log(a);function h(f){if(f instanceof Uint8Array||(ArrayBuffer.isView(f)?f=new Uint8Array(f.buffer,f.byteOffset,f.byteLength):Array.isArray(f)&&(f=Uint8Array.from(f))),!(f instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(f.length===0)return"";for(var g=0,w=0,y=0,b=f.length;y!==b&&f[y]===0;)y++,g++;for(var v=(b-y)*d+1>>>0,E=new Uint8Array(v);y!==b;){for(var C=f[y],k=0,x=v-1;(C!==0||k<w)&&x!==-1;x--,k++)C+=256*E[x]>>>0,E[x]=C%a>>>0,C=C/a>>>0;if(C!==0)throw new Error("Non-zero carry");w=k,y++}for(var I=v-w;I!==v&&E[I]===0;)I++;for(var T=c.repeat(g);I<v;++I)T+=r.charAt(E[I]);return T}function p(f){if(typeof f!="string")throw new TypeError("Expected String");if(f.length===0)return new Uint8Array;var g=0;if(f[g]!==" "){for(var w=0,y=0;f[g]===c;)w++,g++;for(var b=(f.length-g)*l+1>>>0,v=new Uint8Array(b);f[g];){var E=t[f.charCodeAt(g)];if(E===255)return;for(var C=0,k=b-1;(E!==0||C<y)&&k!==-1;k--,C++)E+=a*v[k]>>>0,v[k]=E%256>>>0,E=E/256>>>0;if(E!==0)throw new Error("Non-zero carry");y=C,g++}if(f[g]!==" "){for(var x=b-y;x!==b&&v[x]===0;)x++;for(var I=new Uint8Array(w+(b-x)),T=w;x!==b;)I[T++]=v[x++];return I}}}function m(f){var g=p(f);if(g)return g;throw new Error(`Non-${e} character`)}return{encode:h,decodeUnsafe:p,decode:m}}var uue=lue,due=uue;let hue=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseEncode");this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},fue=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseDecode");u(this,"prefixCodePoint");this.name=e,this.prefix=t;const i=t.codePointAt(0);if(i===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=i,this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return oM(this,e)}},pue=class{constructor(e){u(this,"decoders");this.decoders=e}or(e){return oM(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};function oM(r,e){return new pue({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}let gue=class{constructor(e,t,n,i){u(this,"name");u(this,"prefix");u(this,"baseEncode");u(this,"baseDecode");u(this,"encoder");u(this,"decoder");this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=i,this.encoder=new hue(e,t,n),this.decoder=new fue(e,t,i)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};function aM({name:r,prefix:e,encode:t,decode:n}){return new gue(r,e,t,n)}function Xy({name:r,prefix:e,alphabet:t}){const{encode:n,decode:i}=due(t,r);return aM({prefix:e,name:r,encode:n,decode:s=>b7(i(s))})}function yue(r,e,t,n){const i={};for(let d=0;d<e.length;++d)i[e[d]]=d;let s=r.length;for(;r[s-1]==="=";)--s;const o=new Uint8Array(s*t/8|0);let a=0,c=0,l=0;for(let d=0;d<s;++d){const h=i[r[d]];if(h===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|h,a+=t,a>=8&&(a-=8,o[l++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o}function mue(r,e,t){const n=e[e.length-1]==="=",i=(1<<t)-1;let s="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,s+=e[i&a>>o];if(o!==0&&(s+=e[i&a<<t-o]),n)for(;s.length*t&7;)s+="=";return s}function $o({name:r,prefix:e,bitsPerChar:t,alphabet:n}){return aM({prefix:e,name:r,encode(i){return mue(i,n,t)},decode(i){return yue(i,n,t,r)}})}const Zy=$o({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});$o({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),$o({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),$o({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),$o({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),$o({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),$o({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),$o({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),$o({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const v7=Xy({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"});Xy({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});const fc=Xy({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});Xy({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var wue=lM,cM=128,bue=-128,vue=Math.pow(2,31);function lM(r,e,t){e=e||[],t=t||0;for(var n=t;r>=vue;)e[t++]=r&255|cM,r/=128;for(;r&bue;)e[t++]=r&255|cM,r>>>=7;return e[t]=r|0,lM.bytes=t-n+1,e}var Eue=E7,Sue=128,uM=127;function E7(r,n){var t=0,n=n||0,i=0,s=n,o,a=r.length;do{if(s>=a)throw E7.bytes=0,new RangeError("Could not decode varint");o=r[s++],t+=i<28?(o&uM)<<i:(o&uM)*Math.pow(2,i),i+=7}while(o>=Sue);return E7.bytes=s-n,t}var xue=Math.pow(2,7),Aue=Math.pow(2,14),Cue=Math.pow(2,21),Iue=Math.pow(2,28),kue=Math.pow(2,35),_ue=Math.pow(2,42),Tue=Math.pow(2,49),Pue=Math.pow(2,56),Due=Math.pow(2,63),$ue=function(r){return r<xue?1:r<Aue?2:r<Cue?3:r<Iue?4:r<kue?5:r<_ue?6:r<Tue?7:r<Pue?8:r<Due?9:10},Nue={encode:wue,decode:Eue,encodingLength:$ue},em=Nue;function S7(r,e=0){return[em.decode(r,e),em.decode.bytes]}function tm(r,e,t=0){return em.encode(r,e,t),e}function rm(r){return em.encodingLength(r)}function Mue(r,e){const t=e.byteLength,n=rm(r),i=n+rm(t),s=new Uint8Array(i+t);return tm(r,s,0),tm(t,s,n),s.set(e,i),new x7(r,t,e,s)}function Oue(r){const e=b7(r),[t,n]=S7(e),[i,s]=S7(e.subarray(n)),o=e.subarray(n+s);if(o.byteLength!==i)throw new Error("Incorrect length");return new x7(t,i,o,e)}function Rue(r,e){if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&cue(r.bytes,t.bytes)}}let x7=class{constructor(e,t,n,i){u(this,"code");u(this,"size");u(this,"digest");u(this,"bytes");this.code=e,this.size=t,this.digest=n,this.bytes=i}};function dM(r,e){const{bytes:t,version:n}=r;switch(n){case 0:return Bue(t,A7(r),e??fc.encoder);default:return Uue(t,A7(r),e??Zy.encoder)}}const hM=new WeakMap;function A7(r){const e=hM.get(r);if(e==null){const t=new Map;return hM.set(r,t),t}return e}let V1=class Qr{constructor(e,t,n,i){u(this,"code");u(this,"version");u(this,"multihash");u(this,"bytes");u(this,"/");u(this,Dj,"CID");this.code=t,this.version=e,this.multihash=n,this.bytes=i,this["/"]=i}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==K1)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==Fue)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return Qr.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=Mue(e,t);return Qr.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return Qr.equals(this,e)}static equals(e,t){const n=t;return n!=null&&e.code===n.code&&e.version===n.version&&Rue(e.multihash,n.multihash)}toString(e){return dM(this,e)}toJSON(){return{"/":dM(this)}}link(){return this}[(Dj=Symbol.toStringTag,Symbol.for("nodejs.util.inspect.custom"))](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof Qr)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:i,multihash:s,bytes:o}=t;return new Qr(n,i,s,o??fM(n,i,s.bytes))}else if(t[zue]===!0){const{version:n,multihash:i,code:s}=t,o=Oue(i);return Qr.create(n,s,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==K1)throw new Error(`Version 0 CID must use dag-pb (code: ${K1}) block encoding`);return new Qr(e,t,n,n.bytes)}case 1:{const i=fM(e,t,n.bytes);return new Qr(e,t,n,i)}default:throw new Error("Invalid version")}}static createV0(e){return Qr.create(0,K1,e)}static createV1(e,t){return Qr.create(1,e,t)}static decode(e){const[t,n]=Qr.decodeFirst(e);if(n.length!==0)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=Qr.inspectBytes(e),n=t.size-t.multihashSize,i=b7(e.subarray(n,n+t.multihashSize));if(i.byteLength!==t.multihashSize)throw new Error("Incorrect length");const s=i.subarray(t.multihashSize-t.digestSize),o=new x7(t.multihashCode,t.digestSize,s,i);return[t.version===0?Qr.createV0(o):Qr.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[h,p]=S7(e.subarray(t));return t+=p,h};let i=n(),s=K1;if(i===18?(i=0,t=0):s=n(),i!==0&&i!==1)throw new RangeError(`Invalid CID version ${i}`);const o=t,a=n(),c=n(),l=t+c,d=l-o;return{version:i,codec:s,multihashCode:a,digestSize:c,multihashSize:d,size:l}}static parse(e,t){const[n,i]=Lue(e,t),s=Qr.decode(i);if(s.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return A7(s).set(n,e),s}};function Lue(r,e){switch(r[0]){case"Q":{const t=e??fc;return[fc.prefix,t.decode(`${fc.prefix}${r}`)]}case fc.prefix:{const t=e??fc;return[fc.prefix,t.decode(r)]}case Zy.prefix:{const t=e??Zy;return[Zy.prefix,t.decode(r)]}case v7.prefix:{const t=e??v7;return[v7.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}}function Bue(r,e,t){const{prefix:n}=t;if(n!==fc.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const i=e.get(n);if(i==null){const s=t.encode(r).slice(1);return e.set(n,s),s}else return i}function Uue(r,e,t){const{prefix:n}=t,i=e.get(n);if(i==null){const s=t.encode(r);return e.set(n,s),s}else return i}const K1=112,Fue=18;function fM(r,e,t){const n=rm(r),i=n+rm(e),s=new Uint8Array(i+t.byteLength);return tm(r,s,0),tm(e,s,n),s.set(t,i),s}const zue=Symbol.for("@ipld/js-cid/CID"),Vue=new TextDecoder;function C7(r,e){let t=0;for(let n=0;;n+=7){if(n>=64)throw new Error("protobuf: varint overflow");if(e>=r.length)throw new Error("protobuf: unexpected end of data");const i=r[e++];if(t+=n<28?(i&127)<<n:(i&127)*2**n,i<128)break}return[t,e]}function nm(r,e){let t;[t,e]=C7(r,e);const n=e+t;if(t<0||n<0)throw new Error("protobuf: invalid length");if(n>r.length)throw new Error("protobuf: unexpected end of data");return[r.subarray(e,n),n]}function pM(r,e){let t;return[t,e]=C7(r,e),[t&7,t>>3,e]}function Kue(r){const e={},t=r.length;let n=0;for(;n<t;){let i,s;if([i,s,n]=pM(r,n),s===1){if(e.Hash)throw new Error("protobuf: (PBLink) duplicate Hash section");if(i!==2)throw new Error(`protobuf: (PBLink) wrong wireType (${i}) for Hash`);if(e.Name!==void 0)throw new Error("protobuf: (PBLink) invalid order, found Name before Hash");if(e.Tsize!==void 0)throw new Error("protobuf: (PBLink) invalid order, found Tsize before Hash");[e.Hash,n]=nm(r,n)}else if(s===2){if(e.Name!==void 0)throw new Error("protobuf: (PBLink) duplicate Name section");if(i!==2)throw new Error(`protobuf: (PBLink) wrong wireType (${i}) for Name`);if(e.Tsize!==void 0)throw new Error("protobuf: (PBLink) invalid order, found Tsize before Name");let o;[o,n]=nm(r,n),e.Name=Vue.decode(o)}else if(s===3){if(e.Tsize!==void 0)throw new Error("protobuf: (PBLink) duplicate Tsize section");if(i!==0)throw new Error(`protobuf: (PBLink) wrong wireType (${i}) for Tsize`);[e.Tsize,n]=C7(r,n)}else throw new Error(`protobuf: (PBLink) invalid fieldNumber, expected 1, 2 or 3, got ${s}`)}if(n>t)throw new Error("protobuf: (PBLink) unexpected end of data");return e}function jue(r){const e=r.length;let t=0,n,i=!1,s;for(;t<e;){let a,c;if([a,c,t]=pM(r,t),a!==2)throw new Error(`protobuf: (PBNode) invalid wireType, expected 2, got ${a}`);if(c===1){if(s)throw new Error("protobuf: (PBNode) duplicate Data section");[s,t]=nm(r,t),n&&(i=!0)}else if(c===2){if(i)throw new Error("protobuf: (PBNode) duplicate Links section");n||(n=[]);let l;[l,t]=nm(r,t),n.push(Kue(l))}else throw new Error(`protobuf: (PBNode) invalid fieldNumber, expected 1 or 2, got ${c}`)}if(t>e)throw new Error("protobuf: (PBNode) unexpected end of data");const o={};return s&&(o.Data=s),o.Links=n||[],o}const gM=new TextEncoder,yM=2**32,Hue=2**31;function que(r,e){let t=e.length;if(typeof r.Tsize=="number"){if(r.Tsize<0)throw new Error("Tsize cannot be negative");if(!Number.isSafeInteger(r.Tsize))throw new Error("Tsize too large for encoding");t=j1(e,t,r.Tsize)-1,e[t]=24}if(typeof r.Name=="string"){const n=gM.encode(r.Name);t-=n.length,e.set(n,t),t=j1(e,t,n.length)-1,e[t]=18}return r.Hash&&(t-=r.Hash.length,e.set(r.Hash,t),t=j1(e,t,r.Hash.length)-1,e[t]=10),e.length-t}function Wue(r){const e=Que(r),t=new Uint8Array(e);let n=e;if(r.Data&&(n-=r.Data.length,t.set(r.Data,n),n=j1(t,n,r.Data.length)-1,t[n]=10),r.Links)for(let i=r.Links.length-1;i>=0;i--){const s=que(r.Links[i],t.subarray(0,n));n-=s,n=j1(t,n,s)-1,t[n]=18}return t}function Gue(r){let e=0;if(r.Hash){const t=r.Hash.length;e+=1+t+qd(t)}if(typeof r.Name=="string"){const t=gM.encode(r.Name).length;e+=1+t+qd(t)}return typeof r.Tsize=="number"&&(e+=1+qd(r.Tsize)),e}function Que(r){let e=0;if(r.Data){const t=r.Data.length;e+=1+t+qd(t)}if(r.Links)for(const t of r.Links){const n=Gue(t);e+=1+n+qd(n)}return e}function j1(r,e,t){e-=qd(t);const n=e;for(;t>=Hue;)r[e++]=t&127|128,t/=128;for(;t>=128;)r[e++]=t&127|128,t>>>=7;return r[e]=t,n}function qd(r){return r%2===0&&r++,Math.floor((Yue(r)+6)/7)}function Yue(r){let e=0;return r>=yM&&(r=Math.floor(r/yM),e=32),r>=65536&&(r>>>=16,e+=16),r>=256&&(r>>>=8,e+=8),e+Jue[r]}const Jue=[0,1,2,2,3,3,3,3,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8],Xue=["Data","Links"],Zue=["Hash","Name","Tsize"],I7=new TextEncoder;function mM(r,e){if(r===e)return 0;const t=r.Name?I7.encode(r.Name):[],n=e.Name?I7.encode(e.Name):[];let i=t.length,s=n.length;for(let o=0,a=Math.min(i,s);o<a;++o)if(t[o]!==n[o]){i=t[o],s=n[o];break}return i<s?-1:s<i?1:0}function wM(r,e){return!Object.keys(r).some(t=>!e.includes(t))}function bM(r){if(typeof r.asCID=="object"){const t=V1.asCID(r);if(!t)throw new TypeError("Invalid DAG-PB form");return{Hash:t}}if(typeof r!="object"||Array.isArray(r))throw new TypeError("Invalid DAG-PB form");const e={};if(r.Hash){let t=V1.asCID(r.Hash);try{t||(typeof r.Hash=="string"?t=V1.parse(r.Hash):r.Hash instanceof Uint8Array&&(t=V1.decode(r.Hash)))}catch(n){throw new TypeError(`Invalid DAG-PB form: ${n.message}`)}t&&(e.Hash=t)}if(!e.Hash)throw new TypeError("Invalid DAG-PB form");return typeof r.Name=="string"&&(e.Name=r.Name),typeof r.Tsize=="number"&&(e.Tsize=r.Tsize),e}function vM(r){if((r instanceof Uint8Array||typeof r=="string")&&(r={Data:r}),typeof r!="object"||Array.isArray(r))throw new TypeError("Invalid DAG-PB form");const e={};if(r.Data!==void 0)if(typeof r.Data=="string")e.Data=I7.encode(r.Data);else if(r.Data instanceof Uint8Array)e.Data=r.Data;else throw new TypeError("Invalid DAG-PB form");if(r.Links!==void 0)if(Array.isArray(r.Links))e.Links=r.Links.map(bM),e.Links.sort(mM);else throw new TypeError("Invalid DAG-PB form");else e.Links=[];return e}function EM(r){if(!r||typeof r!="object"||Array.isArray(r)||r instanceof Uint8Array||r["/"]&&r["/"]===r.bytes)throw new TypeError("Invalid DAG-PB form");if(!wM(r,Xue))throw new TypeError("Invalid DAG-PB form (extraneous properties)");if(r.Data!==void 0&&!(r.Data instanceof Uint8Array))throw new TypeError("Invalid DAG-PB form (Data must be bytes)");if(!Array.isArray(r.Links))throw new TypeError("Invalid DAG-PB form (Links must be a list)");for(let e=0;e<r.Links.length;e++){const t=r.Links[e];if(!t||typeof t!="object"||Array.isArray(t)||t instanceof Uint8Array||t["/"]&&t["/"]===t.bytes)throw new TypeError("Invalid DAG-PB form (bad link)");if(!wM(t,Zue))throw new TypeError("Invalid DAG-PB form (extraneous properties on link)");if(t.Hash===void 0)throw new TypeError("Invalid DAG-PB form (link must have a Hash)");if(t.Hash==null||!t.Hash["/"]||t.Hash["/"]!==t.Hash.bytes)throw new TypeError("Invalid DAG-PB form (link Hash must be a CID)");if(t.Name!==void 0&&typeof t.Name!="string")throw new TypeError("Invalid DAG-PB form (link Name must be a string)");if(t.Tsize!==void 0){if(typeof t.Tsize!="number"||t.Tsize%1!==0)throw new TypeError("Invalid DAG-PB form (link Tsize must be an integer)");if(t.Tsize<0)throw new TypeError("Invalid DAG-PB form (link Tsize cannot be negative)")}if(e>0&&mM(t,r.Links[e-1])===-1)throw new TypeError("Invalid DAG-PB form (links must be sorted by Name bytes)")}}function ede(r,e=[]){return vM({Data:r,Links:e})}function tde(r,e,t){return bM({Hash:t,Name:r,Tsize:e})}function rde(r){return r instanceof ArrayBuffer?new Uint8Array(r,0,r.byteLength):r}const nde="dag-pb",SM=112;function ide(r){EM(r);const e={};return r.Links&&(e.Links=r.Links.map(t=>{const n={};return t.Hash&&(n.Hash=t.Hash.bytes),t.Name!==void 0&&(n.Name=t.Name),t.Tsize!==void 0&&(n.Tsize=t.Tsize),n})),r.Data&&(e.Data=r.Data),Wue(e)}function sde(r){const e=rde(r),t=jue(e),n={};return t.Data&&(n.Data=t.Data),t.Links&&(n.Links=t.Links.map(i=>{const s={};try{s.Hash=V1.decode(i.Hash)}catch{}if(!s.Hash)throw new Error("Invalid Hash field found in link, expected CID");return i.Name!==void 0&&(s.Name=i.Name),i.Tsize!==void 0&&(s.Tsize=i.Tsize),s})),n}const ode=Object.freeze(Object.defineProperty({__proto__:null,code:SM,createLink:tde,createNode:ede,decode:sde,encode:ide,name:nde,prepare:vM,validate:EM},Symbol.toStringTag,{value:"Module"})),ade=new TextEncoder,cde=new TextDecoder,lde="json",xM=512;function ude(r){return ade.encode(JSON.stringify(r))}function dde(r){return JSON.parse(cde.decode(r))}const hde=Object.freeze(Object.defineProperty({__proto__:null,code:xM,decode:dde,encode:ude,name:lde},Symbol.toStringTag,{value:"Module"})),fde="raw",AM=85;function pde(r){return jd(r)}function gde(r){return jd(r)}const yde=Object.freeze(Object.defineProperty({__proto__:null,code:AM,decode:gde,encode:pde,name:fde},Symbol.toStringTag,{value:"Module"}));function k7(r){return(r==null?void 0:r.then)!=null}function mde(r=[],e){const t={[SM]:ode,[AM]:yde,[aT]:Jf,[rM]:aue,[xM]:hde};return r.forEach(n=>{t[n.code]=n}),async n=>{let i=t[n];if(i==null&&e!=null){const s=e(n);k7(s)?i=await s:i=s,t[i.code]=i}if(i!=null)return i;throw new ON(`Could not load codec for ${n}`)}}const CM=0,wde="identity",IM=jd;function bde(r){return Ky(CM,IM(r))}const kM={code:CM,name:wde,encode:IM,digest:bde};function _M(r){return async e=>new Uint8Array(await crypto.subtle.digest(r,e))}const TM=TN({name:"sha2-256",code:18,encode:_M("SHA-256")}),PM=TN({name:"sha2-512",code:19,encode:_M("SHA-512")});function vde(r=[],e){const t={[TM.code]:TM,[PM.code]:PM,[kM.code]:kM};return r.forEach(n=>{t[n.code]=n}),async n=>{let i=t[n];if(i==null&&e!=null){const s=e(n);k7(s)?i=await s:i=s,t[i.code]=i}if(i!=null)return i;throw new MN(`No hasher configured for multihash code 0x${n.toString(16)}, please configure one. You can look up which hash this is at https://github.com/multiformats/multicodec/blob/master/table.csv`)}}const Hh=class Hh extends Error{constructor(t="Not Found"){super(t);u(this,"name",Hh.name);u(this,"code",Hh.code)}};u(Hh,"name","NotFoundError"),u(Hh,"code","ERR_NOT_FOUND");let H1=Hh;class DM{has(e,t){return Promise.reject(new Error(".has is not implemented"))}put(e,t,n){return Promise.reject(new Error(".put is not implemented"))}async*putMany(e,t){for await(const{cid:n,block:i}of e)await this.put(n,i,t),yield n}get(e,t){return Promise.reject(new Error(".get is not implemented"))}async*getMany(e,t){for await(const n of e)yield{cid:n,block:await this.get(n,t)}}delete(e,t){return Promise.reject(new Error(".delete is not implemented"))}async*deleteMany(e,t){for await(const n of e)await this.delete(n,t),yield n}async*getAll(e){throw new Error(".getAll is not implemented")}}const im=0;class Ede extends DM{constructor(t){super();u(this,"child");this.child=t}put(t,n){return t.multihash.code===im||this.child==null?t:this.child.put(t,n)}get(t){if(t.multihash.code===im)return t.multihash.digest;if(this.child==null)throw new H1;return this.child.get(t)}has(t){return t.multihash.code===im?!0:this.child==null?!1:this.child.has(t)}delete(t){if(t.code!==im&&this.child!=null)return this.child.delete(t)}getAll(t){return this.child!=null?this.child.getAll(t):[]}}function Sde(r){return r[Symbol.asyncIterator]!=null}function Kl(r,e){let t=0;if(Sde(r))return async function*(){for await(const c of r)await e(c,t++)&&(yield c)}();const n=Dv(r),{value:i,done:s}=n.next();if(s===!0)return function*(){}();const o=e(i,t++);if(typeof o.then=="function")return async function*(){await o&&(yield i);for await(const c of n)await e(c,t++)&&(yield c)}();const a=e;return function*(){o===!0&&(yield i);for(const c of n)a(c,t++)&&(yield c)}()}function xde(r){return r[Symbol.asyncIterator]!=null}function $M(r){return(r==null?void 0:r.then)!=null}function sm(r,e){let t=0;if(xde(r))return async function*(){for await(const c of r){const l=e(c,t++);$M(l)&&await l,yield c}}();const n=Dv(r),{value:i,done:s}=n.next();if(s===!0)return function*(){}();const o=e(i,t++);if(typeof(o==null?void 0:o.then)=="function")return async function*(){yield i;for await(const c of n){const l=e(c,t++);$M(l)&&await l,yield c}}();const a=e;return function*(){yield i;for(const c of n)a(c,t++),yield c}()}class NM{constructor(e){u(this,"child");u(this,"getHasher");u(this,"log");u(this,"logger");u(this,"components");this.log=e.logger.forComponent("helia:networked-storage"),this.logger=e.logger,this.components=e,this.child=new Ede(e.blockstore),this.getHasher=e.getHasher}async put(e,t,n={}){var i,s,o;return await this.child.has(e,n)?((i=n.onProgress)==null||i.call(n,new ke("blocks:put:duplicate",e)),e):((s=n.onProgress)==null||s.call(n,new ke("blocks:put:providers:notify",e)),await Promise.all(this.components.blockBrokers.map(async a=>{var c;return(c=a.announce)==null?void 0:c.call(a,e,t,n)})),(o=n.onProgress)==null||o.call(n,new ke("blocks:put:blockstore:put",e)),this.child.put(e,t,n))}async*putMany(e,t={}){var s;const n=Kl(e,async({cid:o})=>{var c;const a=await this.child.has(o,t);return a&&((c=t.onProgress)==null||c.call(t,new ke("blocks:put-many:duplicate",o))),!a}),i=sm(n,async({cid:o,block:a})=>{var c;(c=t.onProgress)==null||c.call(t,new ke("blocks:put-many:providers:notify",o)),await Promise.all(this.components.blockBrokers.map(async l=>{var d;return(d=l.announce)==null?void 0:d.call(l,o,a,t)}))});(s=t.onProgress)==null||s.call(t,new ke("blocks:put-many:blockstore:put-many")),yield*this.child.putMany(i,t)}async get(e,t={}){var n,i,s,o;if(t.offline!==!0&&!await this.child.has(e,t)){const a=await this.getHasher(e.multihash.code);(n=t.onProgress)==null||n.call(t,new ke("blocks:get:providers:get",e));const c=await MM(e,this.components.blockBrokers,a,{...t,log:this.log});return(i=t.onProgress)==null||i.call(t,new ke("blocks:get:blockstore:put",e)),await this.child.put(e,c,t),(s=t.onProgress)==null||s.call(t,new ke("blocks:get:providers:notify",e)),await Promise.all(this.components.blockBrokers.map(async l=>{var d;return(d=l.announce)==null?void 0:d.call(l,e,c,t)})),c}return(o=t.onProgress)==null||o.call(t,new ke("blocks:get:blockstore:get",e)),this.child.get(e,t)}async*getMany(e,t={}){var n;(n=t.onProgress)==null||n.call(t,new ke("blocks:get-many:blockstore:get-many")),yield*this.child.getMany(sm(e,async i=>{var s,o,a;if(t.offline!==!0&&!await this.child.has(i,t)){const c=await this.getHasher(i.multihash.code);(s=t.onProgress)==null||s.call(t,new ke("blocks:get-many:providers:get",i));const l=await MM(i,this.components.blockBrokers,c,{...t,log:this.log});(o=t.onProgress)==null||o.call(t,new ke("blocks:get-many:blockstore:put",i)),await this.child.put(i,l,t),(a=t.onProgress)==null||a.call(t,new ke("blocks:get-many:providers:notify",i)),await Promise.all(this.components.blockBrokers.map(async d=>{var h;return(h=d.announce)==null?void 0:h.call(d,i,l,t)}))}}))}async delete(e,t={}){var n;(n=t.onProgress)==null||n.call(t,new ke("blocks:delete:blockstore:delete",e)),await this.child.delete(e,t)}async*deleteMany(e,t={}){var n;(n=t.onProgress)==null||n.call(t,new ke("blocks:delete-many:blockstore:delete-many")),yield*this.child.deleteMany(async function*(){for await(const i of e)yield i}(),t)}async has(e,t={}){return this.child.has(e,t)}async*getAll(e={}){var t;(t=e.onProgress)==null||t.call(e,new ke("blocks:get-all:blockstore:get-many")),yield*this.child.getAll(e)}}class Ade extends NM{constructor(t){super(t);u(this,"started");this.started=!1}isStarted(){return this.started}async start(){await xo(this.child,...this.components.blockBrokers),this.started=!0}async stop(){await Ka(this.child,...this.components.blockBrokers),this.started=!1}unwrap(){return this.child}createSession(t,n){const i=this.components.blockBrokers.map(s=>s.createSession==null?s:s.createSession(n));return new Cde({blockstore:this.child,blockBrokers:i,getHasher:this.getHasher,logger:this.logger},{root:t})}}class Cde extends NM{constructor(t,n){super(t);u(this,"closeController");this.closeController=new AbortController,this.closeController.signal,this.log=t.logger.forComponent(`helia:session-storage:${n.root}`)}close(){this.closeController.abort()}async put(t,n,i={}){const s=ft([this.closeController.signal,i.signal]);try{return await super.put(t,n,{...i,signal:s})}finally{s.clear()}}async*putMany(t,n={}){const i=ft([this.closeController.signal,n.signal]);try{yield*super.putMany(t,{...n,signal:i})}finally{i.clear()}}async get(t,n={}){const i=ft([this.closeController.signal,n.signal]);try{return await super.get(t,{...n,signal:i})}finally{i.clear()}}async*getMany(t,n={}){const i=ft([this.closeController.signal,n.signal]);try{yield*super.getMany(t,{...n,signal:i})}finally{i.clear()}}async delete(t,n={}){const i=ft([this.closeController.signal,n.signal]);try{await super.delete(t,{...n,signal:i})}finally{i.clear()}}async*deleteMany(t,n={}){const i=ft([this.closeController.signal,n.signal]);try{yield*super.deleteMany(t,{...n,signal:i})}finally{i.clear()}}async has(t,n={}){const i=ft([this.closeController.signal,n.signal]);try{return await super.has(t,{...n,signal:i})}finally{i.clear()}}async*getAll(t={}){const n=ft([this.closeController.signal,t.signal]);try{yield*super.getAll({...t,signal:n})}finally{n.clear()}}}function Ide(r){return typeof r.retrieve=="function"}const kde=(r,e)=>{if(e==null)throw new Z(`No hasher configured for multihash code 0x${r.multihash.code.toString(16)}, please configure one. You can look up which hash this is at https://github.com/multiformats/multicodec/blob/master/table.csv`);return async t=>{let n;const i=e.digest(t);if(k7(i)?n=await i:n=i,!qe(n.digest,r.multihash.digest))throw new N2("Hash of downloaded block did not match multihash from passed CID")}};async function MM(r,e,t,n){const i=kde(r,t),s=new AbortController,o=ft([s.signal,n.signal]);s.signal;const a=[];for(const c of e)Ide(c)&&a.push(c);try{return await Promise.any(a.map(async c=>{try{let l=!1;const d=await c.retrieve(r,{...n,signal:o,validateFn:async h=>{await i(h),l=!0}});return l||await i(d),d}catch(l){throw n.log.error("could not retrieve verified block for %c",r,l),l}}))}finally{s.abort(),o.clear()}}const _de=ii({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6});ii({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),ii({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),ii({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});class OM extends er{constructor(t,n){super();u(this,"initialPeerSearchComplete");u(this,"requests");u(this,"name");u(this,"log");u(this,"logger");u(this,"minProviders");u(this,"maxProviders");u(this,"providers");u(this,"evictionFilter");this.name=n.name,this.logger=t.logger,this.log=t.logger.forComponent(this.name),this.requests=new Map,this.minProviders=n.minProviders??ele,this.maxProviders=n.maxProviders??tle,this.providers=[],this.evictionFilter=Ll(this.maxProviders)}async retrieve(t,n={}){const i=_de.encode(t.multihash.bytes),s=this.requests.get(i);if(s!=null)return this.log("join existing request for %c",t),s;const o=Re();if(this.requests.set(i,o.promise),this.providers.length===0){let d=!1;this.initialPeerSearchComplete==null&&(d=!0,this.log=this.logger.forComponent(`${this.name}:${t}`),this.initialPeerSearchComplete=this.findProviders(t,this.minProviders,n)),await this.initialPeerSearchComplete,d&&this.log("found initial session peers for %c",t)}let a=!1;const c=new Ml({concurrency:this.maxProviders});c.addEventListener("error",()=>{}),c.addEventListener("failure",d=>{this.log.error("error querying provider %o, evicting from session",d.detail.job.options.provider,d.detail.error),this.evict(d.detail.job.options.provider)}),c.addEventListener("success",d=>{a=!0,o.resolve(d.detail.result)}),c.addEventListener("idle",()=>{var d;a||((d=n.signal)==null?void 0:d.aborted)===!0||Promise.resolve().then(async()=>{this.log("no session peers had block for for %c, finding new providers",t);for(let h=0;h<this.minProviders&&this.providers.length!==0;h++){const p=this.providers[Math.floor(Math.random()*this.providers.length)];this.evict(p)}await this.findProviders(t,this.minProviders,n),this.log("found new providers re-retrieving %c",t),this.requests.delete(i),o.resolve(await this.retrieve(t,n))}).catch(h=>{this.log.error("could not find new providers for %c",t,h),o.reject(h)})});const l=d=>{c.add(async()=>this.queryProvider(t,d.detail,n),{provider:d.detail}).catch(h=>{var p;((p=n.signal)==null?void 0:p.aborted)!==!0&&this.log.error("error retrieving session block for %c",t,h)})};this.addEventListener("provider",l),Promise.all([...this.providers].map(async d=>c.add(async()=>this.queryProvider(t,d,n),{provider:d}))).catch(d=>{var h;((h=n.signal)==null?void 0:h.aborted)!==!0&&this.log.error("error retrieving session block for %c",t,d)});try{return await o.promise}finally{this.removeEventListener("provider",l),c.clear(),this.requests.delete(i)}}evict(t){this.evictionFilter.add(this.toEvictionKey(t));const n=this.providers.findIndex(i=>this.equals(i,t));n!==-1&&this.providers.splice(n,1)}isEvicted(t){return this.evictionFilter.has(this.toEvictionKey(t))}hasProvider(t){return!!(this.providers.find(n=>this.equals(n,t))!=null||this.isEvicted(t))}async findProviders(t,n,i){const s=Re();let o=0;return Promise.resolve().then(async()=>{var a;this.log("finding %d-%d new provider(s) for %c",n,this.maxProviders,t);for await(const c of this.findNewProviders(t,i)){if(o===this.maxProviders||((a=i.signal)==null?void 0:a.aborted)===!0)break;if(!this.hasProvider(c)&&(this.log("found %d/%d new providers",o,this.maxProviders),this.providers.push(c),this.safeDispatchEvent("provider",{detail:c}),o++,o===n&&(this.log("session is ready"),s.resolve()),this.providers.length===this.maxProviders)){this.log("found max session peers",o);break}}if(this.log("found %d/%d new session peers",o,this.maxProviders),o<n)throw new NN(`Found ${o} of ${n} ${this.name} providers for ${t}`)}).catch(a=>{this.log.error("error searching routing for potential session peers for %c",t,a.errors??a),s.reject(a)}),s.promise}}class Tde{constructor(e){u(this,"blockstore");u(this,"datastore");u(this,"pins");u(this,"logger");u(this,"routing");u(this,"getCodec");u(this,"getHasher");u(this,"dns");u(this,"metrics");u(this,"log");this.logger=e.logger??Ry(),this.log=this.logger.forComponent("helia"),this.getHasher=vde(e.hashers,e.loadHasher),this.getCodec=mde(e.codecs,e.loadCodec),this.dns=e.dns??bN(),this.metrics=e.metrics;const t={blockstore:e.blockstore,datastore:e.datastore,logger:this.logger,blockBrokers:[],getHasher:this.getHasher,getCodec:this.getCodec,dns:this.dns,metrics:this.metrics,...e.components??{}};this.routing=t.routing=new nle(t,{routers:(e.routers??[]).flatMap(i=>{const s=[i];return i[bd]!=null&&s.push(i[bd]),i[vd]!=null&&s.push(i[vd]),s}),providerLookupConcurrency:e.providerLookupConcurrency});const n=new Ade(t);this.pins=new Zce(e.datastore,n,this.getCodec),this.blockstore=new lle(n,this.pins,{holdGcLock:e.holdGcLock??!0}),this.datastore=e.datastore,t.blockBrokers=e.blockBrokers.map(i=>i(t))}async start(){await ule(this.datastore),await xo(this.blockstore,this.datastore,this.routing)}async stop(){await Ka(this.blockstore,this.datastore,this.routing)}async gc(e={}){const t=await this.blockstore.lock.writeLock();try{const n=this,i=this.blockstore.unwrap();this.log("gc start"),await mo(i.deleteMany(async function*(){var s,o;for await(const{cid:a}of i.getAll())try{if(await n.pins.isPinned(a,e))continue;yield a,(s=e.onProgress)==null||s.call(e,new ke("helia:gc:deleted",a))}catch(c){n.log.error("Error during gc",c),(o=e.onProgress)==null||o.call(e,new ke("helia:gc:error",c))}}()))}finally{t()}this.log("gc finished")}}class Pde extends OM{constructor(t,n){super(t,{...n,name:"helia:bitswap:session"});u(this,"wantList");u(this,"network");this.wantList=t.wantList,this.network=t.network}async queryProvider(t,n,i){this.log("sending WANT-BLOCK for %c to %p",t,n);const s=await this.wantList.wantSessionBlock(t,n,i);if(this.log("%p %s %c",n,s.has?"has":"does not have",t),s.has&&s.block!=null)return s.block;throw new Error("Provider did not have block")}async*findNewProviders(t,n={}){for await(const i of this.network.findProviders(t,n))yield i.id}toEvictionKey(t){return t.toMultihash().bytes}equals(t,n){return t.equals(n)}}function Dde(r,e){return new Pde(r,e)}class $de{constructor(e){u(this,"blocksReceived");u(this,"duplicateBlocksReceived");u(this,"dataReceived");u(this,"duplicateDataReceived");var t,n,i,s;this.blocksReceived=(t=e.metrics)==null?void 0:t.registerMetricGroup("helia_bitswap_received_blocks"),this.duplicateBlocksReceived=(n=e.metrics)==null?void 0:n.registerMetricGroup("helia_bitswap_duplicate_received_blocks"),this.dataReceived=(i=e.metrics)==null?void 0:i.registerMetricGroup("helia_bitswap_data_received_bytes"),this.duplicateDataReceived=(s=e.metrics)==null?void 0:s.registerMetricGroup("helia_bitswap_duplicate_data_received_bytes")}updateBlocksReceived(e=1,t){var i;const n={global:e};t!=null&&(n[t.toString()]=e),(i=this.blocksReceived)==null||i.increment(n)}updateDuplicateBlocksReceived(e=1,t){var i;const n={global:e};t!=null&&(n[t.toString()]=e),(i=this.duplicateBlocksReceived)==null||i.increment(n)}updateDataReceived(e,t){var i;const n={global:e};t!=null&&(n[t.toString()]=e),(i=this.dataReceived)==null||i.increment(n)}updateDuplicateDataReceived(e,t){var i;const n={global:e};t!=null&&(n[t.toString()]=e),(i=this.duplicateDataReceived)==null||i.increment(n)}}class Nde extends Map{constructor(t){super();u(this,"metric");const{name:n,metrics:i}=t;this.metric=i.registerMetric(n),this.updateComponentMetric()}set(t,n){return super.set(t,n),this.updateComponentMetric(),this}delete(t){const n=super.delete(t);return this.updateComponentMetric(),n}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}}function RM(r){const{name:e,metrics:t}=r;let n;return t!=null?n=new Nde({name:e,metrics:t}):n=new Map,n}function Mde({name:r,code:e,encode:t}){return new Ode(r,e,t)}let Ode=class{constructor(e,t,n){u(this,"name");u(this,"code");u(this,"encode");this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?Jv(this.code,t):t.then(n=>Jv(this.code,n))}else throw Error("Unknown type, must be binary type")}};function Rde(r){return async e=>new Uint8Array(await crypto.subtle.digest(r,e))}const LM=Mde({name:"sha2-256",code:18,encode:Rde("SHA-256")});function Lde(r){if(!(r instanceof Uint8Array))throw new Error("arg needs to be a Uint8Array");const e=[];for(;r.length>0;){const t=Zi(r);e.push(t),r=r.slice(gt(t))}return e}class Bde extends er{constructor(t,n={}){super();u(this,"peers");u(this,"wants");u(this,"network");u(this,"log");u(this,"sendMessagesDelay");u(this,"sendMessagesTimeout");u(this,"hashLoader");u(this,"sendingMessages");this.peers=eN({name:"helia_bitswap_peers",metrics:t.metrics}),this.wants=RM({name:"helia_bitswap_wantlist",metrics:t.metrics}),this.network=t.network,this.sendMessagesDelay=n.sendMessagesDelay??Zie,this.log=t.logger.forComponent("helia:bitswap:wantlist"),this.hashLoader=n.hashLoader,this.network.addEventListener("bitswap:message",i=>{this.receiveMessage(i.detail.peer,i.detail.message).catch(s=>{this.log.error("error receiving bitswap message from %p",i.detail.peer,s)})}),this.network.addEventListener("peer:connected",i=>{this.peerConnected(i.detail).catch(s=>{this.log.error("error processing newly connected bitswap peer %p",i.detail,s)})}),this.network.addEventListener("peer:disconnected",i=>{this.peerDisconnected(i.detail)})}async addEntry(t,n){var o;const i=re(t.multihash.bytes,"base64");let s=this.wants.get(i);s==null&&(s={cid:t,priority:n.priority??1,wantType:n.wantType??fr.WantBlock,cancel:!1,sendDontHave:!0},this.wants.set(i,s)),s.wantType===fr.WantHave&&n.wantType===fr.WantBlock&&(s.wantType=fr.WantBlock),await this.sendMessagesDebounced();try{return n.wantType===fr.WantBlock?(await _i(this,"block",n==null?void 0:n.signal,{filter:l=>qe(t.multihash.digest,l.detail.cid.multihash.digest),errorMessage:"Want was aborted"})).detail:(await _i(this,"presence",n==null?void 0:n.signal,{filter:c=>qe(t.multihash.digest,c.detail.cid.multihash.digest),errorMessage:"Want was aborted"})).detail}finally{((o=n.signal)==null?void 0:o.aborted)===!0&&(this.log("want for %c was aborted, cancelling want",t),s.cancel=!0,await this.sendMessagesDebounced())}}async sendMessagesDebounced(){var t;await((t=this.sendingMessages)==null?void 0:t.promise),clearTimeout(this.sendMessagesTimeout),this.sendMessagesTimeout=setTimeout(()=>{this.sendMessages().catch(n=>{this.log("error sending messages to peers",n)})},this.sendMessagesDelay)}async sendMessages(){this.sendingMessages=Re(),await Promise.all([...this.peers.entries()].map(async([t,n])=>{const i=new Set,s=new B1;for(const[o,a]of this.wants.entries())n.has(o)||a.cancel||(i.add(o),s.addWantlistEntry(a.cid,{cid:a.cid.bytes,priority:a.priority,wantType:a.wantType,cancel:a.cancel,sendDontHave:a.sendDontHave}));if(s.wantlist.size!==0)try{await this.network.sendMessage(t,s);for(const o of i)n.add(o)}catch(o){this.log.error("error sending full wantlist to new peer",o)}})).catch(t=>{this.log.error("error sending messages",t)});for(const[t,n]of this.wants)if(n.cancel){this.wants.delete(t);for(const i of this.peers.values())i.delete(t)}this.sendingMessages.resolve()}has(t){const n=re(t.multihash.bytes,"base64");return this.wants.has(n)}async wantSessionPresence(t,n,i={}){const s=new B1;return s.addWantlistEntry(t,{cid:t.bytes,sendDontHave:!0,wantType:fr.WantHave,priority:1}),await this.network.sendMessage(n,s),(await _i(this,"presence",i.signal,{filter:a=>n.equals(a.detail.sender)&&qe(t.multihash.digest,a.detail.cid.multihash.digest)})).detail}async wantBlock(t,n={}){return this.addEntry(t,{...n,wantType:fr.WantBlock})}async wantSessionBlock(t,n,i={}){const s=new B1;return s.addWantlistEntry(t,{cid:t.bytes,sendDontHave:!0,wantType:fr.WantBlock,priority:1}),await this.network.sendMessage(n,s),(await _i(this,"presence",i.signal,{filter:a=>n.equals(a.detail.sender)&&qe(t.multihash.digest,a.detail.cid.multihash.digest)})).detail}async receivedBlock(t,n){const i=re(t.multihash.bytes,"base64"),s=this.wants.get(i);s!=null&&(s.cancel=!0,await this.sendMessagesDebounced())}async receiveMessage(t,n){var s;this.log("received message from %p with %d blocks",t,n.blocks.length);let i=!1;for(const o of n.blocks){if(o.prefix==null||o.data==null)continue;const a=Lde(o.prefix),c=a[0],l=a[1],d=a[2],h=d===LM.code?LM:await((s=this.hashLoader)==null?void 0:s.getHasher(d));if(h==null){this.log.error("unknown hash algorithm",d);continue}let p=h.digest(o.data);p.then!=null&&(p=await p);const m=e7.create(c===0?0:1,l,p);this.log("received block from %p for %c",t,m),this.safeDispatchEvent("block",{detail:{sender:t,cid:m,block:o.data}}),this.safeDispatchEvent("presence",{detail:{sender:t,cid:m,has:!0,block:o.data}});const f=re(m.multihash.bytes,"base64"),g=this.wants.get(f);g!=null&&(g.cancel=!0,i=!0)}for(const{cid:o,type:a}of n.blockPresences){const c=e7.decode(o);this.log("received %s from %p for %c",a,t,c),this.safeDispatchEvent("presence",{detail:{sender:t,cid:c,has:a===Bs.HaveBlock}})}i&&await this.sendMessagesDebounced()}async peerConnected(t){const n=new Set,i=new B1(!0);for(const[s,o]of this.wants.entries())o.cancel||(n.add(s),i.addWantlistEntry(o.cid,{cid:o.cid.bytes,priority:1,wantType:fr.WantBlock,cancel:!1,sendDontHave:!1}));if(i.wantlist.size===0){this.peers.set(t,n);return}try{await this.network.sendMessage(t,i),this.peers.set(t,n)}catch(s){this.log.error("error sending full wantlist to new peer %p",t,s)}}peerDisconnected(t){this.peers.delete(t)}start(){}stop(){this.peers.clear(),clearTimeout(this.sendMessagesTimeout)}}class Ude{constructor(e,t={}){u(this,"log");u(this,"logger");u(this,"stats");u(this,"network");u(this,"blockstore");u(this,"peerWantLists");u(this,"wantList");this.logger=e.logger,this.log=e.logger.forComponent("helia:bitswap"),this.blockstore=e.blockstore,this.stats=new $de(e),this.network=new use(e,t),this.peerWantLists=new Iae({...e,network:this.network},t),this.wantList=new Bde({...e,network:this.network},t)}createSession(e={}){return Dde({wantList:this.wantList,network:this.network,logger:this.logger},e)}async want(e,t={}){const n=new AbortController,i=ft([n.signal,t.signal]);n.signal,this.network.findAndConnect(e,{...t,signal:i}).catch(s=>{n.signal.aborted||this.log.error("error during finding and connect for cid %c",e,s)});try{return(await this.wantList.wantBlock(e,{...t,signal:i})).block}finally{n.abort(),i.clear()}}async notify(e,t,n={}){await Promise.all([this.peerWantLists.receivedBlock(e,n),this.wantList.receivedBlock(e,n)])}getWantlist(){return[...this.wantList.wants.values()].filter(e=>!e.cancel).map(e=>({cid:e.cid,priority:e.priority,wantType:e.wantType}))}getPeerWantlist(e){return this.peerWantLists.wantListForPeer(e)}async start(){this.wantList.start(),await this.network.start()}async stop(){this.wantList.stop(),await this.network.stop()}}const Fde=(r,e={})=>new Ude(r,e);class zde{constructor(e,t={}){u(this,"bitswap");u(this,"started");const{getHasher:n}=e;this.bitswap=Fde(e,{hashLoader:{getHasher:async i=>n(i)},...t}),this.started=!1}isStarted(){return this.started}async start(){await this.bitswap.start(),this.started=!0}async stop(){await this.bitswap.stop(),this.started=!1}async announce(e,t,n){await this.bitswap.notify(e,t,n)}async retrieve(e,t={}){return this.bitswap.want(e,t)}createSession(e){const t=this.bitswap.createSession(e);return{announce:async(n,i,s)=>{await this.bitswap.notify(n,i,s)},retrieve:async(n,i)=>t.retrieve(n,i)}}}function Vde(r={}){return e=>new zde(e,r)}class Kde{constructor(){u(this,"index",0);u(this,"input","")}new(e){return this.index=0,this.input=e,this}readAtomically(e){const t=this.index,n=e();return n===void 0&&(this.index=t),n}parseWith(e){const t=e();if(this.index===this.input.length)return t}peekChar(){if(!(this.index>=this.input.length))return this.input[this.index]}readChar(){if(!(this.index>=this.input.length))return this.input[this.index++]}readGivenChar(e){return this.readAtomically(()=>{const t=this.readChar();if(t===e)return t})}readSeparator(e,t,n){return this.readAtomically(()=>{if(!(t>0&&this.readGivenChar(e)===void 0))return n()})}readNumber(e,t,n,i){return this.readAtomically(()=>{let s=0,o=0;const a=this.peekChar();if(a===void 0)return;const c=a==="0",l=2**(8*i)-1;for(;;){const d=this.readAtomically(()=>{const h=this.readChar();if(h===void 0)return;const p=Number.parseInt(h,e);if(!Number.isNaN(p))return p});if(d===void 0)break;if(s*=e,s+=d,s>l||(o+=1,t!==void 0&&o>t))return}if(o!==0)return!n&&c&&o>1?void 0:s})}readIPv4Addr(){return this.readAtomically(()=>{const e=new Uint8Array(4);for(let t=0;t<e.length;t++){const n=this.readSeparator(".",t,()=>this.readNumber(10,3,!1,1));if(n===void 0)return;e[t]=n}return e})}readIPv6Addr(){const e=t=>{for(let n=0;n<t.length/2;n++){const i=n*2;if(n<t.length-3){const o=this.readSeparator(":",n,()=>this.readIPv4Addr());if(o!==void 0)return t[i]=o[0],t[i+1]=o[1],t[i+2]=o[2],t[i+3]=o[3],[i+4,!0]}const s=this.readSeparator(":",n,()=>this.readNumber(16,4,!0,2));if(s===void 0)return[i,!1];t[i]=s>>8,t[i+1]=s&255}return[t.length,!1]};return this.readAtomically(()=>{const t=new Uint8Array(16),[n,i]=e(t);if(n===16)return t;if(i||this.readGivenChar(":")===void 0||this.readGivenChar(":")===void 0)return;const s=new Uint8Array(14),o=16-(n+2),[a]=e(s.subarray(0,o));return t.set(s.subarray(0,a),16-a),t})}readIPAddr(){return this.readIPv4Addr()??this.readIPv6Addr()}}const BM=45,jde=15,Wd=new Kde;function UM(r){if(!(r.length>jde))return Wd.new(r).parseWith(()=>Wd.readIPv4Addr())}function FM(r){if(r.includes("%")&&(r=r.split("%")[0]),!(r.length>BM))return Wd.new(r).parseWith(()=>Wd.readIPv6Addr())}function om(r,e=!1){if(r.includes("%")&&(r=r.split("%")[0]),r.length>BM)return;const t=Wd.new(r).parseWith(()=>Wd.readIPAddr());if(t)return e&&t.length===4?Uint8Array.from([0,0,0,0,0,0,0,0,0,0,255,255,t[0],t[1],t[2],t[3]]):t}function Gd(r){return!!UM(r)}function _7(r){return!!FM(r)}function zM(r){return!!om(r)}var VM;(function(){var r,e,t,n,i,s,o,a;a=function(c){var l,d,h,p;return l=(c&255<<24)>>>24,d=(c&255<<16)>>>16,h=(c&65280)>>>8,p=c&255,[l,d,h,p].join(".")},o=function(c){var l,d,h,p,m,f;for(l=[],h=p=0;p<=3&&c.length!==0;h=++p){if(h>0){if(c[0]!==".")throw new Error("Invalid IP");c=c.substring(1)}f=e(c),m=f[0],d=f[1],c=c.substring(d),l.push(m)}if(c.length!==0)throw new Error("Invalid IP");switch(l.length){case 1:if(l[0]>4294967295)throw new Error("Invalid IP");return l[0]>>>0;case 2:if(l[0]>255||l[1]>16777215)throw new Error("Invalid IP");return(l[0]<<24|l[1])>>>0;case 3:if(l[0]>255||l[1]>255||l[2]>65535)throw new Error("Invalid IP");return(l[0]<<24|l[1]<<16|l[2])>>>0;case 4:if(l[0]>255||l[1]>255||l[2]>255||l[3]>255)throw new Error("Invalid IP");return(l[0]<<24|l[1]<<16|l[2]<<8|l[3])>>>0;default:throw new Error("Invalid IP")}},t=function(c){return c.charCodeAt(0)},n=t("0"),s=t("a"),i=t("A"),e=function(c){var l,d,h,p,m;for(p=0,l=10,d="9",h=0,c.length>1&&c[h]==="0"&&(c[h+1]==="x"||c[h+1]==="X"?(h+=2,l=16):"0"<=c[h+1]&&c[h+1]<="9"&&(h++,l=8,d="7")),m=h;h<c.length;){if("0"<=c[h]&&c[h]<=d)p=p*l+(t(c[h])-n)>>>0;else if(l===16)if("a"<=c[h]&&c[h]<="f")p=p*l+(10+t(c[h])-s)>>>0;else if("A"<=c[h]&&c[h]<="F")p=p*l+(10+t(c[h])-i)>>>0;else break;else break;if(p>4294967295)throw new Error("too large");h++}if(h===m)throw new Error("empty octet");return[p,h]},r=function(){function c(l,d){var h,p,m;if(typeof l!="string")throw new Error("Missing `net' parameter");if(d||(m=l.split("/",2),l=m[0],d=m[1]),d||(d=32),typeof d=="string"&&d.indexOf(".")>-1){try{this.maskLong=o(d)}catch{throw new Error("Invalid mask: "+d)}for(h=p=32;p>=0;h=--p)if(this.maskLong===4294967295<<32-h>>>0){this.bitmask=h;break}}else if(d||d===0)this.bitmask=parseInt(d,10),this.maskLong=0,this.bitmask>0&&(this.maskLong=4294967295<<32-this.bitmask>>>0);else throw new Error("Invalid mask: empty");try{this.netLong=(o(l)&this.maskLong)>>>0}catch{throw new Error("Invalid net address: "+l)}if(!(this.bitmask<=32))throw new Error("Invalid mask for ip4: "+d);this.size=Math.pow(2,32-this.bitmask),this.base=a(this.netLong),this.mask=a(this.maskLong),this.hostmask=a(~this.maskLong),this.first=this.bitmask<=30?a(this.netLong+1):this.base,this.last=this.bitmask<=30?a(this.netLong+this.size-2):a(this.netLong+this.size-1),this.broadcast=this.bitmask<=30?a(this.netLong+this.size-1):void 0}return c.prototype.contains=function(l){return typeof l=="string"&&(l.indexOf("/")>0||l.split(".").length!==4)&&(l=new c(l)),l instanceof c?this.contains(l.base)&&this.contains(l.broadcast||l.last):(o(l)&this.maskLong)>>>0===(this.netLong&this.maskLong)>>>0},c.prototype.next=function(l){return l==null&&(l=1),new c(a(this.netLong+this.size*l),this.mask)},c.prototype.forEach=function(l){var d,h,p;for(p=o(this.first),h=o(this.last),d=0;p<=h;)l(a(p),p,d),d++,p++},c.prototype.toString=function(){return this.base+"/"+this.bitmask},c}(),VM=r}).call(rt);const Hde=["0.0.0.0/8","10.0.0.0/8","100.64.0.0/10","127.0.0.0/8","169.254.0.0/16","172.16.0.0/12","192.0.0.0/24","192.0.0.0/29","192.0.0.8/32","192.0.0.9/32","192.0.0.10/32","192.0.0.170/32","192.0.0.171/32","192.0.2.0/24","192.31.196.0/24","192.52.193.0/24","192.88.99.0/24","192.168.0.0/16","192.175.48.0/24","198.18.0.0/15","198.51.100.0/24","203.0.113.0/24","240.0.0.0/4","255.255.255.255/32"].map(r=>new VM(r));function T7(r){for(const e of Hde)if(e.contains(r))return!0;return!1}function qde(r){return/^::ffff:([0-9a-fA-F]{1,4}):([0-9a-fA-F]{1,4})$/.test(r)}function Wde(r){const e=r.split(":");if(e.length<2)return!1;const t=e[e.length-1].padStart(4,"0"),n=e[e.length-2].padStart(4,"0"),i=`${parseInt(n.substring(0,2),16)}.${parseInt(n.substring(2),16)}.${parseInt(t.substring(0,2),16)}.${parseInt(t.substring(2),16)}`;return T7(i)}function Gde(r){return/^::ffff:([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(r)}function Qde(r){const e=r.split(":"),t=e[e.length-1];return T7(t)}function Yde(r){return/^::$/.test(r)||/^::1$/.test(r)||/^64:ff9b::([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(r)||/^100::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001:2[0-9a-fA-F]:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2001:db8:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^2002:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(r)||/^f[c-d]([0-9a-fA-F]{2,2}):/i.test(r)||/^fe[8-9a-bA-B][0-9a-fA-F]:/i.test(r)||/^ff([0-9a-fA-F]{2,2}):/i.test(r)}function pc(r){return Gd(r)?T7(r):qde(r)?Wde(r):Gde(r)?Qde(r):_7(r)?Yde(r):void 0}function Jde(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function Xde(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var i=0;i<r.length;i++){var s=r.charAt(i),o=s.charCodeAt(0);if(t[o]!==255)throw new TypeError(s+" is ambiguous");t[o]=i}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),d=Math.log(256)/Math.log(a);function h(f){if(f instanceof Uint8Array||(ArrayBuffer.isView(f)?f=new Uint8Array(f.buffer,f.byteOffset,f.byteLength):Array.isArray(f)&&(f=Uint8Array.from(f))),!(f instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(f.length===0)return"";for(var g=0,w=0,y=0,b=f.length;y!==b&&f[y]===0;)y++,g++;for(var v=(b-y)*d+1>>>0,E=new Uint8Array(v);y!==b;){for(var C=f[y],k=0,x=v-1;(C!==0||k<w)&&x!==-1;x--,k++)C+=256*E[x]>>>0,E[x]=C%a>>>0,C=C/a>>>0;if(C!==0)throw new Error("Non-zero carry");w=k,y++}for(var I=v-w;I!==v&&E[I]===0;)I++;for(var T=c.repeat(g);I<v;++I)T+=r.charAt(E[I]);return T}function p(f){if(typeof f!="string")throw new TypeError("Expected String");if(f.length===0)return new Uint8Array;var g=0;if(f[g]!==" "){for(var w=0,y=0;f[g]===c;)w++,g++;for(var b=(f.length-g)*l+1>>>0,v=new Uint8Array(b);f[g];){var E=t[f.charCodeAt(g)];if(E===255)return;for(var C=0,k=b-1;(E!==0||C<y)&&k!==-1;k--,C++)E+=a*v[k]>>>0,v[k]=E%256>>>0,E=E/256>>>0;if(E!==0)throw new Error("Non-zero carry");y=C,g++}if(f[g]!==" "){for(var x=b-y;x!==b&&v[x]===0;)x++;for(var I=new Uint8Array(w+(b-x)),T=w;x!==b;)I[T++]=v[x++];return I}}}function m(f){var g=p(f);if(g)return g;throw new Error(`Non-${e} character`)}return{encode:h,decodeUnsafe:p,decode:m}}var Zde=Xde,ehe=Zde;let the=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseEncode");this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},rhe=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseDecode");u(this,"prefixCodePoint");this.name=e,this.prefix=t;const i=t.codePointAt(0);if(i===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=i,this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return KM(this,e)}},nhe=class{constructor(e){u(this,"decoders");this.decoders=e}or(e){return KM(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};function KM(r,e){return new nhe({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}let ihe=class{constructor(e,t,n,i){u(this,"name");u(this,"prefix");u(this,"baseEncode");u(this,"baseDecode");u(this,"encoder");u(this,"decoder");this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=i,this.encoder=new the(e,t,n),this.decoder=new rhe(e,t,i)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};function jM({name:r,prefix:e,encode:t,decode:n}){return new ihe(r,e,t,n)}function HM({name:r,prefix:e,alphabet:t}){const{encode:n,decode:i}=ehe(t,r);return jM({prefix:e,name:r,encode:n,decode:s=>Jde(i(s))})}function she(r,e,t,n){const i={};for(let d=0;d<e.length;++d)i[e[d]]=d;let s=r.length;for(;r[s-1]==="=";)--s;const o=new Uint8Array(s*t/8|0);let a=0,c=0,l=0;for(let d=0;d<s;++d){const h=i[r[d]];if(h===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|h,a+=t,a>=8&&(a-=8,o[l++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o}function ohe(r,e,t){const n=e[e.length-1]==="=",i=(1<<t)-1;let s="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,s+=e[i&a>>o];if(o!==0&&(s+=e[i&a<<t-o]),n)for(;s.length*t&7;)s+="=";return s}function am({name:r,prefix:e,bitsPerChar:t,alphabet:n}){return jM({prefix:e,name:r,encode(i){return ohe(i,n,t)},decode(i){return she(i,n,t,r)}})}const ahe=HM({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});HM({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),am({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),am({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6});const che=am({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6});am({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});const lhe=r=>r.toString().split("/").slice(1),q1=r=>({match:e=>e.length<1?!1:r(e[0])?e.slice(1):!1,pattern:"fn"}),Ge=r=>({match:e=>q1(t=>t===r).match(e),pattern:r}),Qd=()=>({match:r=>q1(e=>typeof e=="string").match(r),pattern:"{string}"}),cm=()=>({match:r=>q1(e=>!isNaN(parseInt(e))).match(r),pattern:"{number}"}),mt=()=>({match:r=>{if(r.length<2||r[0]!=="p2p"&&r[0]!=="ipfs")return!1;if(r[1].startsWith("Q")||r[1].startsWith("1"))try{ahe.decode(`z${r[1]}`)}catch{return!1}else return!1;return r.slice(2)},pattern:"/p2p/{peerid}"}),lm=()=>({match:r=>{if(r.length<2||r[0]!=="certhash")return!1;try{che.decode(r[1])}catch{return!1}return r.slice(2)},pattern:"/certhash/{certhash}"}),ut=r=>({match:e=>{const t=r.match(e);return t===!1?e:t},pattern:`optional(${r.pattern})`}),dn=(...r)=>({match:e=>{let t;for(const n of r){const i=n.match(e);i!==!1&&(t==null||i.length<t.length)&&(t=i)}return t??!1},pattern:`or(${r.map(e=>e.pattern).join(", ")})`}),Xe=(...r)=>({match:e=>{for(const t of r){const n=t.match(e);if(n===!1)return!1;e=n}return e},pattern:`and(${r.map(e=>e.pattern).join(", ")})`});function Ct(...r){function e(i){let s=lhe(i);for(const o of r){const a=o.match(s);if(a===!1)return!1;s=a}return s}function t(i){return e(i)!==!1}function n(i){const s=e(i);return s===!1?!1:s.length===0}return{matchers:r,matches:t,exactMatch:n}}const uhe=mt(),dhe=Ct(uhe),um=Xe(Ge("dns4"),Qd()),dm=Xe(Ge("dns6"),Qd()),hm=Xe(Ge("dnsaddr"),Qd()),P7=Xe(Ge("dns"),Qd());Ct(um,ut(mt())),Ct(dm,ut(mt())),Ct(hm,ut(mt()));const qM=Ct(dn(P7,hm,um,dm),ut(mt())),WM=Xe(Ge("ip4"),q1(Gd)),GM=Xe(Ge("ip6"),q1(_7)),D7=dn(WM,GM),No=dn(D7,P7,um,dm,hm),hhe=Ct(dn(D7,Xe(dn(P7,hm,um,dm),ut(mt())))),QM=Ct(WM),YM=Ct(GM),fhe=Ct(D7),$7=Xe(No,Ge("tcp"),cm()),W1=Xe(No,Ge("udp"),cm()),fm=Ct(Xe($7,ut(mt())));Ct(W1);const N7=Xe(W1,Ge("quic"),ut(mt())),pm=Xe(W1,Ge("quic-v1"),ut(mt())),phe=dn(N7,pm);Ct(N7);const ghe=Ct(pm),M7=dn(No,$7,W1,N7,pm),JM=dn(Xe(M7,Ge("ws"),ut(mt()))),G1=Ct(JM),XM=dn(Xe(M7,Ge("wss"),ut(mt())),Xe(M7,Ge("tls"),ut(Xe(Ge("sni"),Qd())),Ge("ws"),ut(mt()))),gm=Ct(XM),ZM=Xe(W1,Ge("webrtc-direct"),ut(lm()),ut(lm()),ut(mt())),O7=Ct(ZM),eO=Xe(pm,Ge("webtransport"),ut(lm()),ut(lm()),ut(mt())),tO=Ct(eO),ym=dn(JM,XM,Xe($7,ut(mt())),Xe(phe,ut(mt())),Xe(No,ut(mt())),ZM,eO,mt()),rO=Ct(ym),yhe=Xe(ym,Ge("p2p-circuit"),mt()),gc=Ct(yhe),mhe=dn(Xe(ym,Ge("p2p-circuit"),Ge("webrtc"),ut(mt())),Xe(ym,Ge("webrtc"),ut(mt())),Xe(Ge("webrtc"),ut(mt()))),R7=Ct(mhe),whe=dn(Xe(No,Ge("tcp"),cm(),Ge("http"),ut(mt())),Xe(No,Ge("http"),ut(mt()))),bhe=Ct(whe),vhe=dn(Xe(No,Ge("tcp"),dn(Xe(Ge("443"),Ge("http")),Xe(cm(),Ge("https"))),ut(mt())),Xe(No,Ge("tls"),Ge("http"),ut(mt())),Xe(No,Ge("https"),ut(mt()))),Ehe=Ct(vhe),She=dn(Xe(Ge("memory"),Qd(),ut(mt())));Ct(She);function xhe(r,e,t){let n=0;for(const i of r)if(!(n<e)){if(n>t)break;if(i!==255)return!1;n++}return!0}function Ahe(r,e,t,n){let i=0;for(const s of r)if(!(i<t)){if(i>n)break;if(s!==e[i])return!1;i++}return!0}function Che(r){switch(r.length){case Q1:return r.join(".");case Y1:{const e=[];for(let t=0;t<r.length;t++)t%2===0&&e.push(r[t].toString(16).padStart(2,"0")+r[t+1].toString(16).padStart(2,"0"));return e.join(":")}default:throw new Error("Invalid ip length")}}function Ihe(r){let e=0;for(let[t,n]of r.entries()){if(n===255){e+=8;continue}for(;n&128;)e++,n=n<<1;if(n&128)return-1;for(let i=t+1;i<r.length;i++)if(r[i]!=0)return-1;break}return e}function khe(r){let e="0x";for(const t of r)e+=(t>>4).toString(16)+(t&15).toString(16);return e}const Q1=4,Y1=16,_he=new Uint8Array([0,0,0,0,0,0,0,0,0,0,255,255]);function nO(r,e){e.length===Y1&&r.length===Q1&&xhe(e,0,11)&&(e=e.slice(12)),e.length===Q1&&r.length===Y1&&Ahe(r,_he,0,11)&&(r=r.slice(12));const t=r.length;if(t!=e.length)throw new Error("Failed to mask ip");const n=new Uint8Array(t);for(let i=0;i<t;i++)n[i]=r[i]&e[i];return n}function The(r,e){if(typeof e=="string"&&(e=om(e)),e==null)throw new Error("Invalid ip");if(e.length!==r.network.length)return!1;for(let t=0;t<e.length;t++)if((r.network[t]&r.mask[t])!==(e[t]&r.mask[t]))return!1;return!0}function Phe(r){const[e,t]=r.split("/");if(!e||!t)throw new Error("Failed to parse given CIDR: "+r);let n=Q1,i=UM(e);if(i==null&&(n=Y1,i=FM(e),i==null))throw new Error("Failed to parse given CIDR: "+r);const s=parseInt(t,10);if(Number.isNaN(s)||String(s).length!==t.length||s<0||s>n*8)throw new Error("Failed to parse given CIDR: "+r);const o=iO(s,8*n);return{network:nO(i,o),mask:o}}function iO(r,e){if(e!==8*Q1&&e!==8*Y1)throw new Error("Invalid CIDR mask");if(r<0||r>e)throw new Error("Invalid CIDR mask");const t=e/8,n=new Uint8Array(t);for(let i=0;i<t;i++){if(r>=8){n[i]=255,r-=8;continue}n[i]=255-(255>>r),r=0}return n}class sO{constructor(e,t){if(t==null)({network:this.network,mask:this.mask}=Phe(e));else{const n=om(e);if(n==null)throw new Error("Failed to parse network");t=String(t);const i=parseInt(t,10);if(Number.isNaN(i)||String(i).length!==t.length||i<0||i>n.length*8){const s=om(t);if(s==null)throw new Error("Failed to parse mask");this.mask=s}else this.mask=iO(i,8*n.length);this.network=nO(n,this.mask)}}contains(e){return The({network:this.network,mask:this.mask},e)}toString(){const e=Ihe(this.mask),t=e!==-1?String(e):khe(this.mask);return Che(this.network)+"/"+t}}function Dhe(r,e){return new sO(r).contains(e)}function $he(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function L7(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function Nhe(r){return new TextEncoder().encode(r)}function Mhe(r){return new TextDecoder().decode(r)}function Ohe(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var i=0;i<r.length;i++){var s=r.charAt(i),o=s.charCodeAt(0);if(t[o]!==255)throw new TypeError(s+" is ambiguous");t[o]=i}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),d=Math.log(256)/Math.log(a);function h(f){if(f instanceof Uint8Array||(ArrayBuffer.isView(f)?f=new Uint8Array(f.buffer,f.byteOffset,f.byteLength):Array.isArray(f)&&(f=Uint8Array.from(f))),!(f instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(f.length===0)return"";for(var g=0,w=0,y=0,b=f.length;y!==b&&f[y]===0;)y++,g++;for(var v=(b-y)*d+1>>>0,E=new Uint8Array(v);y!==b;){for(var C=f[y],k=0,x=v-1;(C!==0||k<w)&&x!==-1;x--,k++)C+=256*E[x]>>>0,E[x]=C%a>>>0,C=C/a>>>0;if(C!==0)throw new Error("Non-zero carry");w=k,y++}for(var I=v-w;I!==v&&E[I]===0;)I++;for(var T=c.repeat(g);I<v;++I)T+=r.charAt(E[I]);return T}function p(f){if(typeof f!="string")throw new TypeError("Expected String");if(f.length===0)return new Uint8Array;var g=0;if(f[g]!==" "){for(var w=0,y=0;f[g]===c;)w++,g++;for(var b=(f.length-g)*l+1>>>0,v=new Uint8Array(b);f[g];){var E=t[f.charCodeAt(g)];if(E===255)return;for(var C=0,k=b-1;(E!==0||C<y)&&k!==-1;k--,C++)E+=a*v[k]>>>0,v[k]=E%256>>>0,E=E/256>>>0;if(E!==0)throw new Error("Non-zero carry");y=C,g++}if(f[g]!==" "){for(var x=b-y;x!==b&&v[x]===0;)x++;for(var I=new Uint8Array(w+(b-x)),T=w;x!==b;)I[T++]=v[x++];return I}}}function m(f){var g=p(f);if(g)return g;throw new Error(`Non-${e} character`)}return{encode:h,decodeUnsafe:p,decode:m}}var Rhe=Ohe,Lhe=Rhe;let Bhe=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseEncode");this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},Uhe=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseDecode");u(this,"prefixCodePoint");this.name=e,this.prefix=t;const i=t.codePointAt(0);if(i===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=i,this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return oO(this,e)}},Fhe=class{constructor(e){u(this,"decoders");this.decoders=e}or(e){return oO(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};function oO(r,e){return new Fhe({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}let zhe=class{constructor(e,t,n,i){u(this,"name");u(this,"prefix");u(this,"baseEncode");u(this,"baseDecode");u(this,"encoder");u(this,"decoder");this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=i,this.encoder=new Bhe(e,t,n),this.decoder=new Uhe(e,t,i)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};function mm({name:r,prefix:e,encode:t,decode:n}){return new zhe(r,e,t,n)}function J1({name:r,prefix:e,alphabet:t}){const{encode:n,decode:i}=Lhe(t,r);return mm({prefix:e,name:r,encode:n,decode:s=>L7(i(s))})}function Vhe(r,e,t,n){const i={};for(let d=0;d<e.length;++d)i[e[d]]=d;let s=r.length;for(;r[s-1]==="=";)--s;const o=new Uint8Array(s*t/8|0);let a=0,c=0,l=0;for(let d=0;d<s;++d){const h=i[r[d]];if(h===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|h,a+=t,a>=8&&(a-=8,o[l++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o}function Khe(r,e,t){const n=e[e.length-1]==="=",i=(1<<t)-1;let s="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,s+=e[i&a>>o];if(o!==0&&(s+=e[i&a<<t-o]),n)for(;s.length*t&7;)s+="=";return s}function Sr({name:r,prefix:e,bitsPerChar:t,alphabet:n}){return mm({prefix:e,name:r,encode(i){return Khe(i,n,t)},decode(i){return Vhe(i,n,t,r)}})}const jl=Sr({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),jhe=Sr({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),Hhe=Sr({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),qhe=Sr({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),Whe=Sr({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),Ghe=Sr({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),Qhe=Sr({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),Yhe=Sr({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),Jhe=Sr({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),Xhe=Object.freeze(Object.defineProperty({__proto__:null,base32:jl,base32hex:Whe,base32hexpad:Qhe,base32hexpadupper:Yhe,base32hexupper:Ghe,base32pad:Hhe,base32padupper:qhe,base32upper:jhe,base32z:Jhe},Symbol.toStringTag,{value:"Module"})),ns=J1({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),Zhe=J1({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),efe=Object.freeze(Object.defineProperty({__proto__:null,base58btc:ns,base58flickr:Zhe},Symbol.toStringTag,{value:"Module"})),tfe=J1({prefix:"9",name:"base10",alphabet:"0123456789"}),rfe=Object.freeze(Object.defineProperty({__proto__:null,base10:tfe},Symbol.toStringTag,{value:"Module"})),nfe=Sr({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),ife=Sr({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),sfe=Object.freeze(Object.defineProperty({__proto__:null,base16:nfe,base16upper:ife},Symbol.toStringTag,{value:"Module"})),ofe=Sr({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),afe=Object.freeze(Object.defineProperty({__proto__:null,base2:ofe},Symbol.toStringTag,{value:"Module"})),aO=Array.from("🚀🪐☄🛰🌌🌑🌒🌓🌔🌕🌖🌗🌘🌍🌏🌎🐉☀💻🖥💾💿😂❤😍🤣😊🙏💕😭😘👍😅👏😁🔥🥰💔💖💙😢🤔😆🙄💪😉☺👌🤗💜😔😎😇🌹🤦🎉💞✌✨🤷😱😌🌸🙌😋💗💚😏💛🙂💓🤩😄😀🖤😃💯🙈👇🎶😒🤭❣😜💋👀😪😑💥🙋😞😩😡🤪👊🥳😥🤤👉💃😳✋😚😝😴🌟😬🙃🍀🌷😻😓⭐✅🥺🌈😈🤘💦✔😣🏃💐☹🎊💘😠☝😕🌺🎂🌻😐🖕💝🙊😹🗣💫💀👑🎵🤞😛🔴😤🌼😫⚽🤙☕🏆🤫👈😮🙆🍻🍃🐶💁😲🌿🧡🎁⚡🌞🎈❌✊👋😰🤨😶🤝🚶💰🍓💢🤟🙁🚨💨🤬✈🎀🍺🤓😙💟🌱😖👶🥴▶➡❓💎💸⬇😨🌚🦋😷🕺⚠🙅😟😵👎🤲🤠🤧📌🔵💅🧐🐾🍒😗🤑🌊🤯🐷☎💧😯💆👆🎤🙇🍑❄🌴💣🐸💌📍🥀🤢👅💡💩👐📸👻🤐🤮🎼🥵🚩🍎🍊👼💍📣🥂"),cfe=aO.reduce((r,e,t)=>(r[t]=e,r),[]),lfe=aO.reduce((r,e,t)=>{const n=e.codePointAt(0);if(n==null)throw new Error(`Invalid character: ${e}`);return r[n]=t,r},[]);function ufe(r){return r.reduce((e,t)=>(e+=cfe[t],e),"")}function dfe(r){const e=[];for(const t of r){const n=t.codePointAt(0);if(n==null)throw new Error(`Invalid character: ${t}`);const i=lfe[n];if(i==null)throw new Error(`Non-base256emoji character: ${t}`);e.push(i)}return new Uint8Array(e)}const hfe=mm({prefix:"🚀",name:"base256emoji",encode:ufe,decode:dfe}),ffe=Object.freeze(Object.defineProperty({__proto__:null,base256emoji:hfe},Symbol.toStringTag,{value:"Module"})),wm=J1({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),pfe=J1({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),gfe=Object.freeze(Object.defineProperty({__proto__:null,base36:wm,base36upper:pfe},Symbol.toStringTag,{value:"Module"})),yfe=Sr({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),mfe=Sr({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),wfe=Sr({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),bfe=Sr({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),vfe=Object.freeze(Object.defineProperty({__proto__:null,base64:yfe,base64pad:mfe,base64url:wfe,base64urlpad:bfe},Symbol.toStringTag,{value:"Module"})),Efe=Sr({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),Sfe=Object.freeze(Object.defineProperty({__proto__:null,base8:Efe},Symbol.toStringTag,{value:"Module"})),xfe=mm({prefix:"\0",name:"identity",encode:r=>Mhe(r),decode:r=>Nhe(r)}),Afe=Object.freeze(Object.defineProperty({__proto__:null,identity:xfe},Symbol.toStringTag,{value:"Module"}));new TextEncoder,new TextDecoder;var Cfe=lO,cO=128,Ife=-128,kfe=Math.pow(2,31);function lO(r,e,t){e=e||[],t=t||0;for(var n=t;r>=kfe;)e[t++]=r&255|cO,r/=128;for(;r&Ife;)e[t++]=r&255|cO,r>>>=7;return e[t]=r|0,lO.bytes=t-n+1,e}var _fe=B7,Tfe=128,uO=127;function B7(r,n){var t=0,n=n||0,i=0,s=n,o,a=r.length;do{if(s>=a)throw B7.bytes=0,new RangeError("Could not decode varint");o=r[s++],t+=i<28?(o&uO)<<i:(o&uO)*Math.pow(2,i),i+=7}while(o>=Tfe);return B7.bytes=s-n,t}var Pfe=Math.pow(2,7),Dfe=Math.pow(2,14),$fe=Math.pow(2,21),Nfe=Math.pow(2,28),Mfe=Math.pow(2,35),Ofe=Math.pow(2,42),Rfe=Math.pow(2,49),Lfe=Math.pow(2,56),Bfe=Math.pow(2,63),Ufe=function(r){return r<Pfe?1:r<Dfe?2:r<$fe?3:r<Nfe?4:r<Mfe?5:r<Ofe?6:r<Rfe?7:r<Lfe?8:r<Bfe?9:10},Ffe={encode:Cfe,decode:_fe,encodingLength:Ufe},bm=Ffe;function U7(r,e=0){return[bm.decode(r,e),bm.decode.bytes]}function vm(r,e,t=0){return bm.encode(r,e,t),e}function Em(r){return bm.encodingLength(r)}function zfe(r,e){const t=e.byteLength,n=Em(r),i=n+Em(t),s=new Uint8Array(i+t);return vm(r,s,0),vm(t,s,n),s.set(e,i),new F7(r,t,e,s)}function dO(r){const e=L7(r),[t,n]=U7(e),[i,s]=U7(e.subarray(n)),o=e.subarray(n+s);if(o.byteLength!==i)throw new Error("Incorrect length");return new F7(t,i,o,e)}function Vfe(r,e){if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&$he(r.bytes,t.bytes)}}let F7=class{constructor(e,t,n,i){u(this,"code");u(this,"size");u(this,"digest");u(this,"bytes");this.code=e,this.size=t,this.digest=n,this.bytes=i}};function hO(r,e){const{bytes:t,version:n}=r;switch(n){case 0:return jfe(t,z7(r),e??ns.encoder);default:return Hfe(t,z7(r),e??jl.encoder)}}const fO=new WeakMap;function z7(r){const e=fO.get(r);if(e==null){const t=new Map;return fO.set(r,t),t}return e}let pO=class Yr{constructor(e,t,n,i){u(this,"code");u(this,"version");u(this,"multihash");u(this,"bytes");u(this,"/");u(this,$j,"CID");this.code=t,this.version=e,this.multihash=n,this.bytes=i,this["/"]=i}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==X1)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==qfe)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return Yr.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=zfe(e,t);return Yr.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return Yr.equals(this,e)}static equals(e,t){const n=t;return n!=null&&e.code===n.code&&e.version===n.version&&Vfe(e.multihash,n.multihash)}toString(e){return hO(this,e)}toJSON(){return{"/":hO(this)}}link(){return this}[($j=Symbol.toStringTag,Symbol.for("nodejs.util.inspect.custom"))](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof Yr)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:i,multihash:s,bytes:o}=t;return new Yr(n,i,s,o??gO(n,i,s.bytes))}else if(t[Wfe]===!0){const{version:n,multihash:i,code:s}=t,o=dO(i);return Yr.create(n,s,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==X1)throw new Error(`Version 0 CID must use dag-pb (code: ${X1}) block encoding`);return new Yr(e,t,n,n.bytes)}case 1:{const i=gO(e,t,n.bytes);return new Yr(e,t,n,i)}default:throw new Error("Invalid version")}}static createV0(e){return Yr.create(0,X1,e)}static createV1(e,t){return Yr.create(1,e,t)}static decode(e){const[t,n]=Yr.decodeFirst(e);if(n.length!==0)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=Yr.inspectBytes(e),n=t.size-t.multihashSize,i=L7(e.subarray(n,n+t.multihashSize));if(i.byteLength!==t.multihashSize)throw new Error("Incorrect length");const s=i.subarray(t.multihashSize-t.digestSize),o=new F7(t.multihashCode,t.digestSize,s,i);return[t.version===0?Yr.createV0(o):Yr.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[h,p]=U7(e.subarray(t));return t+=p,h};let i=n(),s=X1;if(i===18?(i=0,t=0):s=n(),i!==0&&i!==1)throw new RangeError(`Invalid CID version ${i}`);const o=t,a=n(),c=n(),l=t+c,d=l-o;return{version:i,codec:s,multihashCode:a,digestSize:c,multihashSize:d,size:l}}static parse(e,t){const[n,i]=Kfe(e,t),s=Yr.decode(i);if(s.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return z7(s).set(n,e),s}};function Kfe(r,e){switch(r[0]){case"Q":{const t=e??ns;return[ns.prefix,t.decode(`${ns.prefix}${r}`)]}case ns.prefix:{const t=e??ns;return[ns.prefix,t.decode(r)]}case jl.prefix:{const t=e??jl;return[jl.prefix,t.decode(r)]}case wm.prefix:{const t=e??wm;return[wm.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}}function jfe(r,e,t){const{prefix:n}=t;if(n!==ns.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const i=e.get(n);if(i==null){const s=t.encode(r).slice(1);return e.set(n,s),s}else return i}function Hfe(r,e,t){const{prefix:n}=t,i=e.get(n);if(i==null){const s=t.encode(r);return e.set(n,s),s}else return i}const X1=112,qfe=18;function gO(r,e,t){const n=Em(r),i=n+Em(e),s=new Uint8Array(i+t.byteLength);return vm(r,s,0),vm(e,s,n),s.set(t,i),s}const Wfe=Symbol.for("@ipld/js-cid/CID"),Gfe={...Afe,...afe,...Sfe,...rfe,...sfe,...Xhe,...gfe,...efe,...vfe,...ffe},yO=Gd,Qfe=_7,mO=function(r){let e=0;if(r=r.toString().trim(),yO(r)){const t=new Uint8Array(e+4);return r.split(/\./g).forEach(n=>{t[e++]=parseInt(n,10)&255}),t}if(Qfe(r)){const t=r.split(":",8);let n;for(n=0;n<t.length;n++){const s=yO(t[n]);let o;s&&(o=mO(t[n]),t[n]=re(o.slice(0,2),"base16")),o!=null&&++n<8&&t.splice(n,0,re(o.slice(2,4),"base16"))}if(t[0]==="")for(;t.length<8;)t.unshift("0");else if(t[t.length-1]==="")for(;t.length<8;)t.push("0");else if(t.length<8){for(n=0;n<t.length&&t[n]!=="";n++);const s=[n,1];for(n=9-t.length;n>0;n--)s.push("0");t.splice.apply(t,s)}const i=new Uint8Array(e+16);for(n=0;n<t.length;n++){const s=parseInt(t[n],16);i[e++]=s>>8&255,i[e++]=s&255}return i}throw new Error("invalid ip address")},Yfe=function(r,e=0,t){e=~~e,t=t??r.length-e;const n=new DataView(r.buffer);if(t===4){const i=[];for(let s=0;s<t;s++)i.push(r[e+s]);return i.join(".")}if(t===16){const i=[];for(let s=0;s<t;s+=2)i.push(n.getUint16(e+s).toString(16));return i.join(":").replace(/(^|:)0(:0)*:0(:|$)/,"$1::$3").replace(/:{3,4}/,"::")}return""},oi=-1,Z1={},V7={};[[4,32,"ip4"],[6,16,"tcp"],[33,16,"dccp"],[41,128,"ip6"],[42,oi,"ip6zone"],[43,8,"ipcidr"],[53,oi,"dns",!0],[54,oi,"dns4",!0],[55,oi,"dns6",!0],[56,oi,"dnsaddr",!0],[132,16,"sctp"],[273,16,"udp"],[275,0,"p2p-webrtc-star"],[276,0,"p2p-webrtc-direct"],[277,0,"p2p-stardust"],[280,0,"webrtc-direct"],[281,0,"webrtc"],[290,0,"p2p-circuit"],[301,0,"udt"],[302,0,"utp"],[400,oi,"unix",!1,!0],[421,oi,"ipfs"],[421,oi,"p2p"],[443,0,"https"],[444,96,"onion"],[445,296,"onion3"],[446,oi,"garlic64"],[448,0,"tls"],[449,oi,"sni"],[460,0,"quic"],[461,0,"quic-v1"],[465,0,"webtransport"],[466,oi,"certhash"],[477,0,"ws"],[478,0,"wss"],[479,0,"p2p-websocket-star"],[480,0,"http"],[481,oi,"http-path"],[777,oi,"memory"]].forEach(r=>{const e=Jfe(...r);V7[e.code]=e,Z1[e.name]=e});function Jfe(r,e,t,n,i){return{code:r,size:e,name:t,resolvable:!!n,path:!!i}}function ze(r){if(typeof r=="number"){if(V7[r]!=null)return V7[r];throw new Error(`no protocol with code: ${r}`)}else if(typeof r=="string"){if(Z1[r]!=null)return Z1[r];throw new Error(`no protocol with name: ${r}`)}throw new Error(`invalid protocol id type: ${typeof r}`)}const Xfe=ze("ip4"),Zfe=ze("ip6"),e1e=ze("ipcidr");function K7(r,e){switch(ze(r).code){case 4:case 41:return n1e(e);case 42:return W7(e);case 43:return re(e,"base10");case 6:case 273:case 33:case 132:return vO(e).toString();case 53:case 54:case 55:case 56:case 400:case 449:case 777:return W7(e);case 421:return a1e(e);case 444:return EO(e);case 445:return EO(e);case 466:return o1e(e);case 481:return globalThis.encodeURIComponent(W7(e));default:return re(e,"base16")}}function wO(r,e){switch(ze(r).code){case 4:return bO(e);case 41:return bO(e);case 42:return q7(e);case 43:return ie(e,"base10");case 6:case 273:case 33:case 132:return H7(parseInt(e,10));case 53:case 54:case 55:case 56:case 400:case 449:case 777:return q7(e);case 421:return i1e(e);case 444:return c1e(e);case 445:return l1e(e);case 466:return s1e(e);case 481:return q7(globalThis.decodeURIComponent(e));default:return ie(e,"base16")}}function t1e(r){let e,t;if(r.stringTuples().forEach(([n,i])=>{(n===Xfe.code||n===Zfe.code)&&(t=i),n===e1e.code&&(e=i)}),e==null||t==null)throw new Error("Invalid multiaddr");return new sO(t,e)}const j7=Object.values(Gfe).map(r=>r.decoder),r1e=function(){let r=j7[0].or(j7[1]);return j7.slice(2).forEach(e=>r=r.or(e)),r}();function bO(r){if(!zM(r))throw new Error("invalid ip address");return mO(r)}function n1e(r){const e=Yfe(r,0,r.length);if(e==null)throw new Error("ipBuff is required");if(!zM(e))throw new Error("invalid ip address");return e}function H7(r){const e=new ArrayBuffer(2);return new DataView(e).setUint16(0,r),new Uint8Array(e)}function vO(r){return new DataView(r.buffer).getUint16(r.byteOffset)}function q7(r){const e=ie(r),t=Uint8Array.from(Er(e.length));return sr([t,e],t.length+e.length)}function W7(r){const e=Zi(r);if(r=r.slice(gt(e)),r.length!==e)throw new Error("inconsistent lengths");return re(r)}function i1e(r){let e;r[0]==="Q"||r[0]==="1"?e=dO(ns.decode(`z${r}`)).bytes:e=pO.parse(r).multihash.bytes;const t=Uint8Array.from(Er(e.length));return sr([t,e],t.length+e.length)}function s1e(r){const e=r1e.decode(r),t=Uint8Array.from(Er(e.length));return sr([t,e],t.length+e.length)}function o1e(r){const e=Zi(r),t=r.slice(gt(e));if(t.length!==e)throw new Error("inconsistent lengths");return"u"+re(t,"base64url")}function a1e(r){const e=Zi(r),t=r.slice(gt(e));if(t.length!==e)throw new Error("inconsistent lengths");return re(t,"base58btc")}function c1e(r){const e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==16)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion address.`);const t=jl.decode("b"+e[0]),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");const i=H7(n);return sr([t,i],t.length+i.length)}function l1e(r){const e=r.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==56)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion3 address.`);const t=jl.decode(`b${e[0]}`),n=parseInt(e[1],10);if(n<1||n>65536)throw new Error("Port number is not in range(1, 65536)");const i=H7(n);return sr([t,i],t.length+i.length)}function EO(r){const e=r.slice(0,r.length-2),t=r.slice(r.length-2),n=re(e,"base32"),i=vO(t);return`${n}:${i}`}function u1e(r){r=G7(r);const e=[],t=[];let n=null;const i=r.split("/").slice(1);if(i.length===1&&i[0]==="")return{bytes:new Uint8Array,string:"/",tuples:[],stringTuples:[],path:null};for(let s=0;s<i.length;s++){const o=i[s],a=ze(o);if(a.size===0){e.push([a.code]),t.push([a.code]);continue}if(s++,s>=i.length)throw new Q7("invalid address: "+r);if(a.path===!0){n=G7(i.slice(s).join("/")),e.push([a.code,wO(a.code,n)]),t.push([a.code,n]);break}const c=wO(a.code,i[s]);e.push([a.code,c]),t.push([a.code,K7(a.code,c)])}return{string:xO(t),bytes:AO(e),tuples:e,stringTuples:t,path:n}}function SO(r){const e=[],t=[];let n=null,i=0;for(;i<r.length;){const s=Zi(r,i),o=gt(s),a=ze(s),c=d1e(a,r.slice(i+o));if(c===0){e.push([s]),t.push([s]),i+=o;continue}const l=r.slice(i+o,i+o+c);if(i+=c+o,i>r.length)throw new Q7("Invalid address Uint8Array: "+re(r,"base16"));e.push([s,l]);const d=K7(s,l);if(t.push([s,d]),a.path===!0){n=d;break}}return{bytes:Uint8Array.from(r),string:xO(t),tuples:e,stringTuples:t,path:n}}function xO(r){const e=[];return r.map(t=>{const n=ze(t[0]);return e.push(n.name),t.length>1&&t[1]!=null&&e.push(t[1]),null}),G7(e.join("/"))}function AO(r){return sr(r.map(e=>{const t=ze(e[0]);let n=Uint8Array.from(Er(t.code));return e.length>1&&e[1]!=null&&(n=sr([n,e[1]])),n}))}function d1e(r,e){if(r.size>0)return r.size/8;if(r.size===0)return 0;{const t=Zi(e instanceof Uint8Array?e:Uint8Array.from(e));return t+gt(t)}}function G7(r){return"/"+r.trim().split("/").filter(e=>e).join("/")}class Q7 extends Error{constructor(t){super(`Error parsing address: ${t}`);u(this,"name","ParseError")}}u(Q7,"name","ParseError");const h1e=Symbol.for("nodejs.util.inspect.custom"),CO=Symbol.for("@multiformats/js-multiaddr/multiaddr"),f1e=[ze("dns").code,ze("dns4").code,ze("dns6").code,ze("dnsaddr").code];class p1e extends Error{constructor(e="No available resolver"){super(e),this.name="NoAvailableResolverError"}}const Wh=class Wh{constructor(e){u(this,"bytes");Ye(this,qh);Ye(this,Fc);Ye(this,u0);Ye(this,d0);u(this,Nj,!0);e==null&&(e="");let t;if(e instanceof Uint8Array)t=SO(e);else if(typeof e=="string"){if(e.length>0&&e.charAt(0)!=="/")throw new Error(`multiaddr "${e}" must start with a "/"`);t=u1e(e)}else if(Sm(e))t=SO(e.bytes);else throw new Error("addr must be a string, Buffer, or another Multiaddr");this.bytes=t.bytes,_t(this,qh,t.string),_t(this,Fc,t.tuples),_t(this,u0,t.stringTuples),_t(this,d0,t.path)}toString(){return se(this,qh)}toJSON(){return this.toString()}toOptions(){let e,t,n,i,s="";const o=ze("tcp"),a=ze("udp"),c=ze("ip4"),l=ze("ip6"),d=ze("dns6"),h=ze("ip6zone");for(const[m,f]of this.stringTuples())m===h.code&&(s=`%${f??""}`),f1e.includes(m)&&(t=o.name==="tcp"?"tcp":"udp",i=443,n=`${f??""}${s}`,e=m===d.code?6:4),(m===o.code||m===a.code)&&(t=ze(m).name==="tcp"?"tcp":"udp",i=parseInt(f??"")),(m===c.code||m===l.code)&&(t=ze(m).name==="tcp"?"tcp":"udp",n=`${f??""}${s}`,e=m===l.code?6:4);if(e==null||t==null||n==null||i==null)throw new Error('multiaddr must have a valid format: "/{ip4, ip6, dns4, dns6, dnsaddr}/{address}/{tcp, udp}/{port}".');return{family:e,host:n,transport:t,port:i}}protos(){return se(this,Fc).map(([e])=>Object.assign({},ze(e)))}protoCodes(){return se(this,Fc).map(([e])=>e)}protoNames(){return se(this,Fc).map(([e])=>ze(e).name)}tuples(){return se(this,Fc).map(([e,t])=>t==null?[e]:[e,t])}stringTuples(){return se(this,u0).map(([e,t])=>t==null?[e]:[e,t])}encapsulate(e){return e=new Wh(e),new Wh(this.toString()+e.toString())}decapsulate(e){const t=e.toString(),n=this.toString(),i=n.lastIndexOf(t);if(i<0)throw new Error(`Address ${this.toString()} does not contain subaddress: ${e.toString()}`);return new Wh(n.slice(0,i))}decapsulateCode(e){const t=this.tuples();for(let n=t.length-1;n>=0;n--)if(t[n][0]===e)return new Wh(AO(t.slice(0,n)));return this}getPeerId(){try{let e=[];this.stringTuples().forEach(([n,i])=>{n===Z1.p2p.code&&e.push([n,i]),n===Z1["p2p-circuit"].code&&(e=[])});const t=e.pop();if((t==null?void 0:t[1])!=null){const n=t[1];return n[0]==="Q"||n[0]==="1"?re(ns.decode(`z${n}`),"base58btc"):re(pO.parse(n).multihash.bytes,"base58btc")}return null}catch{return null}}getPath(){return se(this,d0)}equals(e){return qe(this.bytes,e.bytes)}async resolve(e){const t=this.protos().find(s=>s.resolvable);if(t==null)return[this];const n=J7.get(t.name);if(n==null)throw new p1e(`no available resolver for ${t.name}`);return(await n(this,e)).map(s=>Oe(s))}nodeAddress(){const e=this.toOptions();if(e.transport!=="tcp"&&e.transport!=="udp")throw new Error(`multiaddr must have a valid format - no protocol with name: "${e.transport}". Must have a valid transport protocol: "{tcp, udp}"`);return{family:e.family,address:e.host,port:e.port}}isThinWaistAddress(e){const t=(e??this).protos();return!(t.length!==2||t[0].code!==4&&t[0].code!==41||t[1].code!==6&&t[1].code!==273)}[(Nj=CO,h1e)](){return`Multiaddr(${se(this,qh)})`}};qh=new WeakMap,Fc=new WeakMap,u0=new WeakMap,d0=new WeakMap;let Y7=Wh;const J7=new Map;function Sm(r){return!!(r!=null&&r[CO])}function Oe(r){return new Y7(r)}const g1e=[ze("tcp").code,ze("dns").code,ze("dnsaddr").code,ze("dns4").code,ze("dns6").code];function IO(r){var e;return(e=_O("sni",r))==null?void 0:e[1]}function kO(r){var t;const e=(t=_O("tcp",r))==null?void 0:t[1];return e==null?"":`:${e}`}function _O(r,e){let t;try{t=ze(r).code}catch{return}for(const[n,i]of e)if(n===t&&i!=null)return[n,i]}function TO(r){return r.some(([e,t])=>e===ze("tls").code)}function is(r,e,t){const n=PO[ze(r).name];if(n==null)throw new Error(`Can't interpret protocol ${ze(r).name}`);const i=n(e,t);return r===ze("ip6").code?`[${i}]`:i}const PO={ip4:(r,e)=>r,ip6:(r,e)=>e.length===0?r:`[${r}]`,tcp:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`tcp://${is(t[0],t[1]??"",e)}:${r}`},udp:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`udp://${is(t[0],t[1]??"",e)}:${r}`},dnsaddr:(r,e)=>r,dns4:(r,e)=>r,dns6:(r,e)=>r,dns:(r,e)=>r,ipfs:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`${is(t[0],t[1]??"",e)}`},p2p:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`${is(t[0],t[1]??"",e)}`},http:(r,e)=>{const t=TO(e),n=IO(e),i=kO(e);if(t&&n!=null)return`https://${n}${i}`;const s=t?"https://":"http://",o=e.pop();if(o==null)throw new Error("Unexpected end of multiaddr");let a=is(o[0],o[1]??"",e);return a=a.replace("tcp://",""),`${s}${a}`},"http-path":(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");const n=is(t[0],t[1]??"",e),i=decodeURIComponent(r);return`${n}/${i}`},tls:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return is(t[0],t[1]??"",e)},sni:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return is(t[0],t[1]??"",e)},https:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");let n=is(t[0],t[1]??"",e);return n=n.replace("tcp://",""),`https://${n}`},ws:(r,e)=>{const t=TO(e),n=IO(e),i=kO(e);if(t&&n!=null)return`wss://${n}${i}`;const s=t?"wss://":"ws://",o=e.pop();if(o==null)throw new Error("Unexpected end of multiaddr");let a=is(o[0],o[1]??"",e);return a=a.replace("tcp://",""),`${s}${a}`},wss:(r,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");let n=is(t[0],t[1]??"",e);return n=n.replace("tcp://",""),`wss://${n}`}};function DO(r,e){const n=Oe(r).stringTuples(),i=n.pop();if(i==null)throw new Error("Unexpected end of multiaddr");const s=ze(i[0]),o=PO[s.name];if(o==null)throw new Error(`No interpreter found for ${s.name}`);let a=o(i[1]??"",n);return g1e.includes(i[0])&&(a=a.replace(/^.*:\/\//,""),i[1]==="443"?a=`https://${a}`:a=`http://${a}`),(a.startsWith("http://")||a.startsWith("https://")||a.startsWith("ws://")||a.startsWith("wss://"))&&(a=new URL(a).toString(),a.endsWith("/")&&(a=a.substring(0,a.length-1))),a}let y1e=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseEncode");this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},m1e=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseDecode");u(this,"prefixCodePoint");this.name=e,this.prefix=t;const i=t.codePointAt(0);if(i===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=i,this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return $O(this,e)}},w1e=class{constructor(e){u(this,"decoders");this.decoders=e}or(e){return $O(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};function $O(r,e){return new w1e({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}let b1e=class{constructor(e,t,n,i){u(this,"name");u(this,"prefix");u(this,"baseEncode");u(this,"baseDecode");u(this,"encoder");u(this,"decoder");this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=i,this.encoder=new y1e(e,t,n),this.decoder=new m1e(e,t,i)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};function v1e({name:r,prefix:e,encode:t,decode:n}){return new b1e(r,e,t,n)}function E1e(r,e,t,n){const i={};for(let d=0;d<e.length;++d)i[e[d]]=d;let s=r.length;for(;r[s-1]==="=";)--s;const o=new Uint8Array(s*t/8|0);let a=0,c=0,l=0;for(let d=0;d<s;++d){const h=i[r[d]];if(h===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|h,a+=t,a>=8&&(a-=8,o[l++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o}function S1e(r,e,t){const n=e[e.length-1]==="=",i=(1<<t)-1;let s="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,s+=e[i&a>>o];if(o!==0&&(s+=e[i&a<<t-o]),n)for(;s.length*t&7;)s+="=";return s}function xm({name:r,prefix:e,bitsPerChar:t,alphabet:n}){return v1e({prefix:e,name:r,encode(i){return S1e(i,n,t)},decode(i){return E1e(i,n,t,r)}})}const x1e=xm({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6});xm({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),xm({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),xm({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});class A1e{constructor(e,{logger:t,transformRequestInit:n}){Ye(this,N4);u(this,"url");Ye(this,Eu,0);Ye(this,Su,0);Ye(this,Gh,0);Ye(this,Qh,0);Ye(this,xu,new Map);u(this,"log");u(this,"transformRequestInit");this.url=e instanceof URL?e:new URL(e),this.transformRequestInit=n,this.log=t.forComponent(`helia:trustless-gateway-block-broker:${this.url.hostname}`)}async getRawBlock(e,t){const n=new URL(this.url.toString());if(n.pathname=`/ipfs/${e.toString()}`,n.search="?format=raw",(t==null?void 0:t.aborted)===!0)throw new Error(`Signal to fetch raw block for CID ${e} from gateway ${this.url} was aborted prior to fetch`);const i=Ae(this,N4,ZH).call(this,e),s=new AbortController,o=()=>{s.abort()};t==null||t.addEventListener("abort",o);try{let a=se(this,xu).get(i);if(a==null){Zs(this,Eu)._++;const c={signal:s.signal,headers:{Accept:"application/vnd.ipld.raw"},cache:"force-cache"},l=this.transformRequestInit!=null?await this.transformRequestInit(c):c;a=fetch(n.toString(),l).then(async d=>{if(this.log("GET %s %d",n,d.status),!d.ok)throw Zs(this,Su)._++,new Error(`unable to fetch raw block for CID ${e} from gateway ${this.url}`);return Zs(this,Qh)._++,new Uint8Array(await d.arrayBuffer())}),se(this,xu).set(i,a)}return await a}catch{throw(t==null?void 0:t.aborted)===!0?new Error(`fetching raw block for CID ${e} from gateway ${this.url} was aborted`):(Zs(this,Su)._++,new Error(`unable to fetch raw block for CID ${e}`))}finally{t==null||t.removeEventListener("abort",o),se(this,xu).delete(i)}}reliability(){return se(this,Eu)===0?1:se(this,Gh)>0?-1/0:se(this,Qh)/(se(this,Eu)+se(this,Su)*3)}incrementInvalidBlocks(){Zs(this,Gh)._++}getStats(){return{attempts:se(this,Eu),errors:se(this,Su),invalidBlocks:se(this,Gh),successes:se(this,Qh),pendingResponses:se(this,xu).size}}}Eu=new WeakMap,Su=new WeakMap,Gh=new WeakMap,Qh=new WeakMap,xu=new WeakMap,N4=new WeakSet,ZH=function(e){const t=e.multihash.bytes;return x1e.encode(t)};function C1e(r,e,t){return r.filter(n=>{if(Ehe.matches(n)||e&&bhe.matches(n))return t||qM.matches(n)?!0:pc(n.toOptions().host)===!1;if(!e&&t){const{host:i}=n.toOptions();if(i==="127.0.0.1"||i==="localhost"||i.endsWith(".localhost"))return!0}return!1})}async function*NO(r,e,t,n,i,s={}){for await(const o of e.findProviders(r,s)){const a=C1e(o.multiaddrs,n,i);if(a.length===0)continue;const c=DO(a[0]);yield new A1e(c,{logger:t,transformRequestInit:s.transformRequestInit})}}class I1e extends OM{constructor(t,n){super(t,{...n,name:"helia:trustless-gateway:session"});u(this,"routing");u(this,"allowInsecure");u(this,"allowLocal");u(this,"transformRequestInit");this.routing=t.routing,this.allowInsecure=n.allowInsecure??MO,this.allowLocal=n.allowLocal??OO,this.transformRequestInit=n.transformRequestInit}async queryProvider(t,n,i){var o;this.log("fetching BLOCK for %c from %s",t,n.url);const s=await n.getRawBlock(t,i.signal);return this.log.trace("got block for %c from %s",t,n.url),await((o=i.validateFn)==null?void 0:o.call(i,s)),s}async*findNewProviders(t,n={}){yield*NO(t,this.routing,this.logger,this.allowInsecure,this.allowLocal,{...n,transformRequestInit:this.transformRequestInit})}toEvictionKey(t){return t.url.toString()}equals(t,n){return t.url.toString()===n.url.toString()}}function k1e(r,e){return new I1e(r,e)}class _1e{constructor(e,t={}){u(this,"allowInsecure");u(this,"allowLocal");u(this,"transformRequestInit");u(this,"routing");u(this,"log");u(this,"logger");this.log=e.logger.forComponent("helia:trustless-gateway-block-broker"),this.logger=e.logger,this.routing=e.routing,this.allowInsecure=t.allowInsecure??MO,this.allowLocal=t.allowLocal??OO,this.transformRequestInit=t.transformRequestInit}async retrieve(e,t={}){var i,s;const n=[];for await(const o of NO(e,this.routing,this.logger,this.allowInsecure,this.allowLocal,{...t,transformRequestInit:this.transformRequestInit})){this.log("getting block for %c from %s",e,o.url);try{const a=await o.getRawBlock(e,t.signal);this.log.trace("got block for %c from %s",e,o.url);try{await((i=t.validateFn)==null?void 0:i.call(t,a))}catch(c){this.log.error("failed to validate block for %c from %s",e,o.url,c);continue}return a}catch(a){if(this.log.error("failed to get block for %c from %s",e,o.url,a),a instanceof Error?n.push(a):n.push(new Error(`Unable to fetch raw block for CID ${e} from gateway ${o.url}`)),((s=t.signal)==null?void 0:s.aborted)===!0){this.log.trace("request aborted while fetching raw block for CID %c from gateway %s",e,o.url);break}}}throw n.length>0?new AggregateError(n,`Unable to fetch raw block for CID ${e} from any gateway`):new Error(`Unable to fetch raw block for CID ${e} from any gateway`)}createSession(e={}){return k1e({logger:this.logger,routing:this.routing},{...e,allowLocal:this.allowLocal,allowInsecure:this.allowInsecure,transformRequestInit:this.transformRequestInit})}}const MO=!1,OO=!1;function T1e(r={}){return e=>new _1e(e,r)}async function*RO(r,e={}){const t=r.getReader();try{for(;;){const n=await t.read();if(n.done)return;yield n.value}}finally{e.preventCancel!==!0&&await t.cancel(),t.releaseLock()}}var LO={exports:{}};(function(r){(function(){r.exports=w;var e=86400,t=3200,n=146097*t/400,i=e*n,s=1e3*i,o=864e13,a=4294967296,c=1e6,l="000000000",d=Math.trunc||function(T){var L=T-T%1;return L==0&&(T<0||T===0&&1/T!=1/0)?-0:L},h=w.prototype,p=(w.fromDate=function(T){return new w(+T)},w.fromInt64BE=C(0,1,2,3,0,4),w.fromInt64LE=C(3,2,1,0,4,0),w.fromString=function(B){var L,z=new w,B=(B+="").replace(/^\s*[+\-]?\d+/,function(K){var K=+K,q=1970+(K-1970)%400;return z.year=K-q,q}).replace(/(?:Z|([+\-]\d{2}):?(\d{2}))$/,function(G,K,q){return K<0&&(q*=-1),L=6e4*(60*+K+ +q),""}).replace(/\.\d+$/,function(G){return z.nano=+(G+l).substr(1,9),""}).split(/\D+/);if(1<B.length?B[1]--:B[1]=0,z.time=L=Date.UTC.apply(Date,B)-(L||0),isNaN(L))throw new TypeError("Invalid Date");return y(z)},w.fromTimeT=function(T){return v(T,0)},h.year=0,h.time=0,h.nano=0,h.addNano=function(T){return this.nano+=+T||0,this},h.getNano=function(){var T=y(this);return(T.time%1e3*c+ +T.nano+1e9)%1e9},h.getTimeT=function(){var L=y(this),T=Math.floor(L.time/1e3),L=L.year;return L&&(T+=L*n*e/t),T},h.getYear=function(){return this.toDate().getUTCFullYear()+this.year},h.toDate=function(){return b(y(this).time)},h.toJSON=function(){return this.toString().replace(/0{1,6}Z$/,"Z")},h.toString=function(T){var L=this,z=L.toDate(),B={H:function(){return x(z.getUTCHours())},L:function(){return I(z.getUTCMilliseconds(),3)},M:function(){return x(z.getUTCMinutes())},N:function(){return I(L.getNano(),9)},S:function(){return x(z.getUTCSeconds())},Y:function(){var G=L.getYear();return 999999<G?"+"+G:9999<G?"+"+I(G,6):0<=G?I(G,4):-999999<=G?"-"+I(-G,6):G},a:function(){return f[z.getUTCDay()]},b:function(){return m[z.getUTCMonth()]},d:function(){return x(z.getUTCDate())},e:function(){return function(G){return(9<G?"":" ")+(0|G)}(z.getUTCDate())},m:function(){return x(z.getUTCMonth()+1)}};return function G(K){return K.replace(/%./g,function(q){var j=q[1],Q=g[j],j=B[j];return Q?G(Q):j?j():q})}(T||p)},h.writeInt64BE=E(0,1,2,3,0,4),h.writeInt64LE=E(3,2,1,0,4,0),"%Y-%m-%dT%H:%M:%S.%NZ"),m=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],f=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],g={"%":"%",F:"%Y-%m-%d",n:`
`,R:"%H:%M",T:"%H:%M:%S",t:"	",X:"%T",Z:"GMT",z:"+0000"};return w;function w(T,L,z){var B=this;if(!(B instanceof w))return new w(T,L,z);B.time=+T||0,B.nano=+L||0,B.year=+z||0,y(B)}function y(T){var L,z,B,G=T.year,K=T.time,q=T.nano,Q=((q<0||c<=q)&&(q-=(z=Math.floor(q/c))*c,K+=z,z=1),G%t);return(K<-864e13||o<K||Q)&&((L=d(K/s))&&(G+=L*t,K-=L*s),(B=b(K)).setUTCFullYear(Q+B.getUTCFullYear()),B=(K=+B)+(L=d((G-=Q)/t))*s,L&&-864e13<=B&&B<=o&&(G-=L*t,K=B),z=1),z&&(T.year=G,T.time=K,T.nano=q),T}function b(T){var L=new Date(0);return L.setTime(T),L}function v(G,B){G=+G||0;var z=d((B=(B|0)*a)/i)+d(G/i),B=B%i+G%i,G=d(B/i);return G&&(z+=G,B-=G*i),new w(1e3*B,0,z*t)}function E(T,L,z,B,G,K){return function(Q,j){var U=y(this);Q=Q||new Array(8),k(Q,j|=0);var W=Math.floor(U.time/1e3),U=U.year*(n*e/t),O=d(U/a)+d(W/a),U=U%a+W%a,W=Math.floor(U/a);return W&&(O+=W,U-=W*a),q(Q,j+G,O),q(Q,j+K,U),Q};function q(Q,j,O){Q[j+T]=O>>24&255,Q[j+L]=O>>16&255,Q[j+z]=O>>8&255,Q[j+B]=255&O}}function C(T,L,z,B,G,K){return function(Q,j){k(Q,j|=0);var O=q(Q,j+G);return v(q(Q,j+K),O)};function q(Q,j){return 16777216*Q[j+T]+(Q[j+L]<<16|Q[j+z]<<8|Q[j+B])}}function k(T,L){if(T=T&&T.length,T==null)throw new TypeError("Invalid Buffer");if(T<L+8)throw new RangeError("Out of range")}function x(T){return(9<T?"":"0")+(0|T)}function I(T,L){return(l+(0|T)).substr(-L)}})()})(LO);var P1e=LO.exports;const X7=Je(P1e);class yc extends Error{constructor(e="Record signature verification failed"){super(e),this.name="SignatureVerificationError"}}u(yc,"name","SignatureVerificationError");class BO extends Error{constructor(e="Record has expired"){super(e),this.name="RecordExpiredError"}}u(BO,"name","RecordExpiredError");class Z7 extends Error{constructor(e="The validity type is unsupported"){super(e),this.name="UnsupportedValidityError"}}u(Z7,"name","UnsupportedValidityError");class UO extends Error{constructor(e="The record is too large"){super(e),this.name="RecordTooLargeError"}}u(UO,"name","RecordTooLargeError");class FO extends Error{constructor(e="Value must be a valid content path starting with /"){super(e),this.name="InvalidValueError"}}u(FO,"name","InvalidValueError");class zO extends Error{constructor(e="Invalid record data"){super(e),this.name="InvalidRecordDataError"}}u(zO,"name","InvalidRecordDataError");class e9 extends Error{constructor(e="Invalid embedded public key"){super(e),this.name="InvalidEmbeddedPublicKeyError"}}u(e9,"name","InvalidEmbeddedPublicKeyError");var ss;(function(r){(function(n){n.EOL="EOL"})(r.ValidityType||(r.ValidityType={}));let e;(function(n){n[n.EOL=0]="EOL"})(e||(e={})),function(n){n.codec=()=>In(e)}(r.ValidityType||(r.ValidityType={}));let t;r.codec=()=>(t==null&&(t=De((n,i,s={})=>{s.lengthDelimited!==!1&&i.fork(),n.value!=null&&(i.uint32(10),i.bytes(n.value)),n.signatureV1!=null&&(i.uint32(18),i.bytes(n.signatureV1)),n.validityType!=null&&(i.uint32(24),r.ValidityType.codec().encode(n.validityType,i)),n.validity!=null&&(i.uint32(34),i.bytes(n.validity)),n.sequence!=null&&(i.uint32(40),i.uint64(n.sequence)),n.ttl!=null&&(i.uint32(48),i.uint64(n.ttl)),n.pubKey!=null&&(i.uint32(58),i.bytes(n.pubKey)),n.signatureV2!=null&&(i.uint32(66),i.bytes(n.signatureV2)),n.data!=null&&(i.uint32(74),i.bytes(n.data)),s.lengthDelimited!==!1&&i.ldelim()},(n,i,s={})=>{const o={},a=i==null?n.len:n.pos+i;for(;n.pos<a;){const c=n.uint32();switch(c>>>3){case 1:{o.value=n.bytes();break}case 2:{o.signatureV1=n.bytes();break}case 3:{o.validityType=r.ValidityType.codec().decode(n);break}case 4:{o.validity=n.bytes();break}case 5:{o.sequence=n.uint64();break}case 6:{o.ttl=n.uint64();break}case 7:{o.pubKey=n.bytes();break}case 8:{o.signatureV2=n.bytes();break}case 9:{o.data=n.bytes();break}default:{n.skipType(c&7);break}}}return o})),t),r.encode=n=>Pe(n,r.codec()),r.decode=(n,i)=>Te(n,r.codec(),i)})(ss||(ss={}));function D1e(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function t9(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function $1e(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var i=0;i<r.length;i++){var s=r.charAt(i),o=s.charCodeAt(0);if(t[o]!==255)throw new TypeError(s+" is ambiguous");t[o]=i}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),d=Math.log(256)/Math.log(a);function h(f){if(f instanceof Uint8Array||(ArrayBuffer.isView(f)?f=new Uint8Array(f.buffer,f.byteOffset,f.byteLength):Array.isArray(f)&&(f=Uint8Array.from(f))),!(f instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(f.length===0)return"";for(var g=0,w=0,y=0,b=f.length;y!==b&&f[y]===0;)y++,g++;for(var v=(b-y)*d+1>>>0,E=new Uint8Array(v);y!==b;){for(var C=f[y],k=0,x=v-1;(C!==0||k<w)&&x!==-1;x--,k++)C+=256*E[x]>>>0,E[x]=C%a>>>0,C=C/a>>>0;if(C!==0)throw new Error("Non-zero carry");w=k,y++}for(var I=v-w;I!==v&&E[I]===0;)I++;for(var T=c.repeat(g);I<v;++I)T+=r.charAt(E[I]);return T}function p(f){if(typeof f!="string")throw new TypeError("Expected String");if(f.length===0)return new Uint8Array;var g=0;if(f[g]!==" "){for(var w=0,y=0;f[g]===c;)w++,g++;for(var b=(f.length-g)*l+1>>>0,v=new Uint8Array(b);f[g];){var E=t[f.charCodeAt(g)];if(E===255)return;for(var C=0,k=b-1;(E!==0||C<y)&&k!==-1;k--,C++)E+=a*v[k]>>>0,v[k]=E%256>>>0,E=E/256>>>0;if(E!==0)throw new Error("Non-zero carry");y=C,g++}if(f[g]!==" "){for(var x=b-y;x!==b&&v[x]===0;)x++;for(var I=new Uint8Array(w+(b-x)),T=w;x!==b;)I[T++]=v[x++];return I}}}function m(f){var g=p(f);if(g)return g;throw new Error(`Non-${e} character`)}return{encode:h,decodeUnsafe:p,decode:m}}var N1e=$1e,M1e=N1e;let O1e=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseEncode");this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},R1e=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseDecode");u(this,"prefixCodePoint");this.name=e,this.prefix=t;const i=t.codePointAt(0);if(i===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=i,this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return VO(this,e)}},L1e=class{constructor(e){u(this,"decoders");this.decoders=e}or(e){return VO(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};function VO(r,e){return new L1e({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}let B1e=class{constructor(e,t,n,i){u(this,"name");u(this,"prefix");u(this,"baseEncode");u(this,"baseDecode");u(this,"encoder");u(this,"decoder");this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=i,this.encoder=new O1e(e,t,n),this.decoder=new R1e(e,t,i)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};function KO({name:r,prefix:e,encode:t,decode:n}){return new B1e(r,e,t,n)}function Am({name:r,prefix:e,alphabet:t}){const{encode:n,decode:i}=M1e(t,r);return KO({prefix:e,name:r,encode:n,decode:s=>t9(i(s))})}function U1e(r,e,t,n){const i={};for(let d=0;d<e.length;++d)i[e[d]]=d;let s=r.length;for(;r[s-1]==="=";)--s;const o=new Uint8Array(s*t/8|0);let a=0,c=0,l=0;for(let d=0;d<s;++d){const h=i[r[d]];if(h===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|h,a+=t,a>=8&&(a-=8,o[l++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o}function F1e(r,e,t){const n=e[e.length-1]==="=",i=(1<<t)-1;let s="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,s+=e[i&a>>o];if(o!==0&&(s+=e[i&a<<t-o]),n)for(;s.length*t&7;)s+="=";return s}function Mo({name:r,prefix:e,bitsPerChar:t,alphabet:n}){return KO({prefix:e,name:r,encode(i){return F1e(i,n,t)},decode(i){return U1e(i,n,t,r)}})}const r9=Am({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"});Am({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});const Cm=Mo({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});Mo({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),Mo({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),Mo({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),Mo({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),Mo({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),Mo({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),Mo({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),Mo({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const mc=Am({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});Am({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var z1e=HO,jO=128,V1e=-128,K1e=Math.pow(2,31);function HO(r,e,t){e=e||[],t=t||0;for(var n=t;r>=K1e;)e[t++]=r&255|jO,r/=128;for(;r&V1e;)e[t++]=r&255|jO,r>>>=7;return e[t]=r|0,HO.bytes=t-n+1,e}var j1e=n9,H1e=128,qO=127;function n9(r,n){var t=0,n=n||0,i=0,s=n,o,a=r.length;do{if(s>=a)throw n9.bytes=0,new RangeError("Could not decode varint");o=r[s++],t+=i<28?(o&qO)<<i:(o&qO)*Math.pow(2,i),i+=7}while(o>=H1e);return n9.bytes=s-n,t}var q1e=Math.pow(2,7),W1e=Math.pow(2,14),G1e=Math.pow(2,21),Q1e=Math.pow(2,28),Y1e=Math.pow(2,35),J1e=Math.pow(2,42),X1e=Math.pow(2,49),Z1e=Math.pow(2,56),epe=Math.pow(2,63),tpe=function(r){return r<q1e?1:r<W1e?2:r<G1e?3:r<Q1e?4:r<Y1e?5:r<J1e?6:r<X1e?7:r<Z1e?8:r<epe?9:10},rpe={encode:z1e,decode:j1e,encodingLength:tpe},Im=rpe;function i9(r,e=0){return[Im.decode(r,e),Im.decode.bytes]}function km(r,e,t=0){return Im.encode(r,e,t),e}function _m(r){return Im.encodingLength(r)}function npe(r,e){const t=e.byteLength,n=_m(r),i=n+_m(t),s=new Uint8Array(i+t);return km(r,s,0),km(t,s,n),s.set(e,i),new s9(r,t,e,s)}function WO(r){const e=t9(r),[t,n]=i9(e),[i,s]=i9(e.subarray(n)),o=e.subarray(n+s);if(o.byteLength!==i)throw new Error("Incorrect length");return new s9(t,i,o,e)}function ipe(r,e){if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&D1e(r.bytes,t.bytes)}}let s9=class{constructor(e,t,n,i){u(this,"code");u(this,"size");u(this,"digest");u(this,"bytes");this.code=e,this.size=t,this.digest=n,this.bytes=i}};function GO(r,e){const{bytes:t,version:n}=r;switch(n){case 0:return ope(t,o9(r),e??mc.encoder);default:return ape(t,o9(r),e??Cm.encoder)}}const QO=new WeakMap;function o9(r){const e=QO.get(r);if(e==null){const t=new Map;return QO.set(r,t),t}return e}let YO=class Jr{constructor(e,t,n,i){u(this,"code");u(this,"version");u(this,"multihash");u(this,"bytes");u(this,"/");u(this,Mj,"CID");this.code=t,this.version=e,this.multihash=n,this.bytes=i,this["/"]=i}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==ep)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==cpe)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return Jr.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=npe(e,t);return Jr.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return Jr.equals(this,e)}static equals(e,t){const n=t;return n!=null&&e.code===n.code&&e.version===n.version&&ipe(e.multihash,n.multihash)}toString(e){return GO(this,e)}toJSON(){return{"/":GO(this)}}link(){return this}[(Mj=Symbol.toStringTag,Symbol.for("nodejs.util.inspect.custom"))](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof Jr)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:i,multihash:s,bytes:o}=t;return new Jr(n,i,s,o??JO(n,i,s.bytes))}else if(t[lpe]===!0){const{version:n,multihash:i,code:s}=t,o=WO(i);return Jr.create(n,s,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==ep)throw new Error(`Version 0 CID must use dag-pb (code: ${ep}) block encoding`);return new Jr(e,t,n,n.bytes)}case 1:{const i=JO(e,t,n.bytes);return new Jr(e,t,n,i)}default:throw new Error("Invalid version")}}static createV0(e){return Jr.create(0,ep,e)}static createV1(e,t){return Jr.create(1,e,t)}static decode(e){const[t,n]=Jr.decodeFirst(e);if(n.length!==0)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=Jr.inspectBytes(e),n=t.size-t.multihashSize,i=t9(e.subarray(n,n+t.multihashSize));if(i.byteLength!==t.multihashSize)throw new Error("Incorrect length");const s=i.subarray(t.multihashSize-t.digestSize),o=new s9(t.multihashCode,t.digestSize,s,i);return[t.version===0?Jr.createV0(o):Jr.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[h,p]=i9(e.subarray(t));return t+=p,h};let i=n(),s=ep;if(i===18?(i=0,t=0):s=n(),i!==0&&i!==1)throw new RangeError(`Invalid CID version ${i}`);const o=t,a=n(),c=n(),l=t+c,d=l-o;return{version:i,codec:s,multihashCode:a,digestSize:c,multihashSize:d,size:l}}static parse(e,t){const[n,i]=spe(e,t),s=Jr.decode(i);if(s.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return o9(s).set(n,e),s}};function spe(r,e){switch(r[0]){case"Q":{const t=e??mc;return[mc.prefix,t.decode(`${mc.prefix}${r}`)]}case mc.prefix:{const t=e??mc;return[mc.prefix,t.decode(r)]}case Cm.prefix:{const t=e??Cm;return[Cm.prefix,t.decode(r)]}case r9.prefix:{const t=e??r9;return[r9.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}}function ope(r,e,t){const{prefix:n}=t;if(n!==mc.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const i=e.get(n);if(i==null){const s=t.encode(r).slice(1);return e.set(n,s),s}else return i}function ape(r,e,t){const{prefix:n}=t,i=e.get(n);if(i==null){const s=t.encode(r);return e.set(n,s),s}else return i}const ep=112,cpe=18;function JO(r,e,t){const n=_m(r),i=n+_m(e),s=new Uint8Array(i+t.byteLength);return km(r,s,0),km(e,s,n),s.set(t,i),s}const lpe=Symbol.for("@ipld/js-cid/CID"),upe=Kd("ipns:utils"),XO=ie("/ipns/"),dpe=0,hpe=18;function fpe(r){let e;if(r.pubKey!=null)try{e=kn(r.pubKey)}catch(t){throw upe.error(t),t}if(e!=null)return e}function ppe(r){const e=ie("ipns-signature:");return sr([e,r])}function ZO(r){return"signatureV1"in r?ss.encode({value:ie(r.value),signatureV1:r.signatureV1,validityType:r.validityType,validity:ie(r.validity),sequence:r.sequence,ttl:r.ttl,pubKey:r.pubKey,signatureV2:r.signatureV2,data:r.data}):ss.encode({pubKey:r.pubKey,signatureV2:r.signatureV2,data:r.data})}function tp(r){const e=ss.decode(r);if(e.sequence!=null&&(e.sequence=BigInt(e.sequence)),e.ttl!=null&&(e.ttl=BigInt(e.ttl)),e.signatureV2==null||e.data==null)throw new yc("Missing data or signatureV2");const t=tR(e.data),n=gpe(t.Value),i=re(t.Validity);if(e.value!=null&&e.signatureV1!=null)return ype(e),{value:n,validityType:ss.ValidityType.EOL,validity:i,sequence:t.Sequence,ttl:t.TTL,pubKey:e.pubKey,signatureV1:e.signatureV1,signatureV2:e.signatureV2,data:e.data};if(e.signatureV2!=null)return{value:n,validityType:ss.ValidityType.EOL,validity:i,sequence:t.Sequence,ttl:t.TTL,pubKey:e.pubKey,signatureV2:e.signatureV2,data:e.data};throw new Error("invalid record: does not include signatureV1 or signatureV2")}function eR(r){return sr([XO,r.bytes])}function a9(r){const e=WO(r.slice(XO.length));if(!c9(e,dpe)&&!c9(e,hpe))throw new N2("Multihash in IPNS key was not identity or sha2-256");return e}function tR(r){const e=Ma(r);if(e.ValidityType===0)e.ValidityType=ss.ValidityType.EOL;else throw new Z7("The validity type is unsupported");return Number.isInteger(e.Sequence)&&(e.Sequence=BigInt(e.Sequence)),Number.isInteger(e.TTL)&&(e.TTL=BigInt(e.TTL)),e}function gpe(r){const e=re(r).trim();if(e.startsWith("/"))return e;try{return`/ipfs/${YO.decode(r).toV1().toString()}`}catch{}try{return`/ipfs/${YO.parse(e).toV1().toString()}`}catch{}throw new FO("Value must be a valid content path starting with /")}function ype(r){if(r.data==null)throw new zO("Record data is missing");const e=tR(r.data);if(!qe(e.Value,r.value??new Uint8Array(0)))throw new yc('Field "value" did not match between protobuf and CBOR');if(!qe(e.Validity,r.validity??new Uint8Array(0)))throw new yc('Field "validity" did not match between protobuf and CBOR');if(e.ValidityType!==r.validityType)throw new yc('Field "validityType" did not match between protobuf and CBOR');if(e.Sequence!==r.sequence)throw new yc('Field "sequence" did not match between protobuf and CBOR');if(e.TTL!==r.ttl)throw new yc('Field "ttl" did not match between protobuf and CBOR')}function c9(r,e){return r.code===e}const Tm=Kd("ipns:validator"),mpe=1024*10,wpe=async(r,e)=>{const t=tp(e);let n;try{const i=ppe(t.data);n=await r.verify(i,t.signatureV2)}catch{n=!1}if(!n)throw Tm.error("record signature verification failed"),new yc("Record signature verification failed");if(t.validityType===ss.ValidityType.EOL){if(X7.fromString(t.validity).toDate().getTime()<Date.now())throw Tm.error("record has expired"),new BO("record has expired")}else if(t.validityType!=null)throw Tm.error("the validity type is unsupported"),new Z7("The validity type is unsupported");Tm("ipns record for %s is valid",t.value)};async function rR(r,e){if(e.byteLength>mpe)throw new UO("The record is too large");const t=a9(r);let n;c9(t,0)&&(n=WD(t));const i=tp(e),s=fpe(i)??n;if(s==null)throw new e9("Could not extract public key from IPNS record or routing key");const o=eR(s.toMultihash());if(!qe(o,r))throw new e9("Embedded public key did not match routing key");await wpe(s,e)}let bpe=class extends Error{constructor(){super(...arguments);u(this,"name","InvalidMessageLengthError");u(this,"code","ERR_INVALID_MESSAGE_LENGTH")}};async function*nR(r,e={}){const t=/\r?\n/,n=new TextDecoder("utf8");let i="";for await(let s of r){if(typeof s=="string"&&(s=new TextEncoder().encode(s)),g1(s)&&(s=s.subarray()),i+=n.decode(s,{stream:!0}),i.length>((e==null?void 0:e.maxMessageLength)??i.length))throw new bpe("Incoming message too long");const o=i.split(t);i=o.pop()??"";for(let a=0;a<o.length;a++)yield JSON.parse(o[a])}i+=n.decode(),i!==""&&(yield JSON.parse(i))}class Pm extends Error{constructor(e="Invalid request"){super(e),this.name="InvalidRequestError"}}u(Pm,"name","InvalidRequestError");class Oo extends Error{constructor(e="Bad response"){super(e),this.name="BadResponseError"}}u(Oo,"name","BadResponseError");function vpe(r){return r[Symbol.asyncIterator]!=null}function Epe(r){if(vpe(r))return(async()=>{for await(const e of r)return e})();for(const e of r)return e}function Spe(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function l9(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function xpe(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var i=0;i<r.length;i++){var s=r.charAt(i),o=s.charCodeAt(0);if(t[o]!==255)throw new TypeError(s+" is ambiguous");t[o]=i}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),d=Math.log(256)/Math.log(a);function h(f){if(f instanceof Uint8Array||(ArrayBuffer.isView(f)?f=new Uint8Array(f.buffer,f.byteOffset,f.byteLength):Array.isArray(f)&&(f=Uint8Array.from(f))),!(f instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(f.length===0)return"";for(var g=0,w=0,y=0,b=f.length;y!==b&&f[y]===0;)y++,g++;for(var v=(b-y)*d+1>>>0,E=new Uint8Array(v);y!==b;){for(var C=f[y],k=0,x=v-1;(C!==0||k<w)&&x!==-1;x--,k++)C+=256*E[x]>>>0,E[x]=C%a>>>0,C=C/a>>>0;if(C!==0)throw new Error("Non-zero carry");w=k,y++}for(var I=v-w;I!==v&&E[I]===0;)I++;for(var T=c.repeat(g);I<v;++I)T+=r.charAt(E[I]);return T}function p(f){if(typeof f!="string")throw new TypeError("Expected String");if(f.length===0)return new Uint8Array;var g=0;if(f[g]!==" "){for(var w=0,y=0;f[g]===c;)w++,g++;for(var b=(f.length-g)*l+1>>>0,v=new Uint8Array(b);f[g];){var E=t[f.charCodeAt(g)];if(E===255)return;for(var C=0,k=b-1;(E!==0||C<y)&&k!==-1;k--,C++)E+=a*v[k]>>>0,v[k]=E%256>>>0,E=E/256>>>0;if(E!==0)throw new Error("Non-zero carry");y=C,g++}if(f[g]!==" "){for(var x=b-y;x!==b&&v[x]===0;)x++;for(var I=new Uint8Array(w+(b-x)),T=w;x!==b;)I[T++]=v[x++];return I}}}function m(f){var g=p(f);if(g)return g;throw new Error(`Non-${e} character`)}return{encode:h,decodeUnsafe:p,decode:m}}var Ape=xpe,Cpe=Ape;let Ipe=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseEncode");this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},kpe=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseDecode");u(this,"prefixCodePoint");this.name=e,this.prefix=t;const i=t.codePointAt(0);if(i===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=i,this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return iR(this,e)}},_pe=class{constructor(e){u(this,"decoders");this.decoders=e}or(e){return iR(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};function iR(r,e){return new _pe({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}let Tpe=class{constructor(e,t,n,i){u(this,"name");u(this,"prefix");u(this,"baseEncode");u(this,"baseDecode");u(this,"encoder");u(this,"decoder");this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=i,this.encoder=new Ipe(e,t,n),this.decoder=new kpe(e,t,i)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};function sR({name:r,prefix:e,encode:t,decode:n}){return new Tpe(r,e,t,n)}function Dm({name:r,prefix:e,alphabet:t}){const{encode:n,decode:i}=Cpe(t,r);return sR({prefix:e,name:r,encode:n,decode:s=>l9(i(s))})}function Ppe(r,e,t,n){const i={};for(let d=0;d<e.length;++d)i[e[d]]=d;let s=r.length;for(;r[s-1]==="=";)--s;const o=new Uint8Array(s*t/8|0);let a=0,c=0,l=0;for(let d=0;d<s;++d){const h=i[r[d]];if(h===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|h,a+=t,a>=8&&(a-=8,o[l++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o}function Dpe(r,e,t){const n=e[e.length-1]==="=",i=(1<<t)-1;let s="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,s+=e[i&a>>o];if(o!==0&&(s+=e[i&a<<t-o]),n)for(;s.length*t&7;)s+="=";return s}function Ro({name:r,prefix:e,bitsPerChar:t,alphabet:n}){return sR({prefix:e,name:r,encode(i){return Dpe(i,n,t)},decode(i){return Ppe(i,n,t,r)}})}const $m=Ro({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});Ro({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),Ro({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),Ro({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),Ro({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),Ro({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),Ro({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),Ro({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),Ro({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const u9=Dm({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"});Dm({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});const wc=Dm({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});Dm({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var $pe=aR,oR=128,Npe=-128,Mpe=Math.pow(2,31);function aR(r,e,t){e=e||[],t=t||0;for(var n=t;r>=Mpe;)e[t++]=r&255|oR,r/=128;for(;r&Npe;)e[t++]=r&255|oR,r>>>=7;return e[t]=r|0,aR.bytes=t-n+1,e}var Ope=d9,Rpe=128,cR=127;function d9(r,n){var t=0,n=n||0,i=0,s=n,o,a=r.length;do{if(s>=a)throw d9.bytes=0,new RangeError("Could not decode varint");o=r[s++],t+=i<28?(o&cR)<<i:(o&cR)*Math.pow(2,i),i+=7}while(o>=Rpe);return d9.bytes=s-n,t}var Lpe=Math.pow(2,7),Bpe=Math.pow(2,14),Upe=Math.pow(2,21),Fpe=Math.pow(2,28),zpe=Math.pow(2,35),Vpe=Math.pow(2,42),Kpe=Math.pow(2,49),jpe=Math.pow(2,56),Hpe=Math.pow(2,63),qpe=function(r){return r<Lpe?1:r<Bpe?2:r<Upe?3:r<Fpe?4:r<zpe?5:r<Vpe?6:r<Kpe?7:r<jpe?8:r<Hpe?9:10},Wpe={encode:$pe,decode:Ope,encodingLength:qpe},Nm=Wpe;function h9(r,e=0){return[Nm.decode(r,e),Nm.decode.bytes]}function Mm(r,e,t=0){return Nm.encode(r,e,t),e}function Om(r){return Nm.encodingLength(r)}function Gpe(r,e){const t=e.byteLength,n=Om(r),i=n+Om(t),s=new Uint8Array(i+t);return Mm(r,s,0),Mm(t,s,n),s.set(e,i),new f9(r,t,e,s)}function Qpe(r){const e=l9(r),[t,n]=h9(e),[i,s]=h9(e.subarray(n)),o=e.subarray(n+s);if(o.byteLength!==i)throw new Error("Incorrect length");return new f9(t,i,o,e)}function Ype(r,e){if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&Spe(r.bytes,t.bytes)}}let f9=class{constructor(e,t,n,i){u(this,"code");u(this,"size");u(this,"digest");u(this,"bytes");this.code=e,this.size=t,this.digest=n,this.bytes=i}};function lR(r,e){const{bytes:t,version:n}=r;switch(n){case 0:return Xpe(t,p9(r),e??wc.encoder);default:return Zpe(t,p9(r),e??$m.encoder)}}const uR=new WeakMap;function p9(r){const e=uR.get(r);if(e==null){const t=new Map;return uR.set(r,t),t}return e}let dR=class Xr{constructor(e,t,n,i){u(this,"code");u(this,"version");u(this,"multihash");u(this,"bytes");u(this,"/");u(this,Oj,"CID");this.code=t,this.version=e,this.multihash=n,this.bytes=i,this["/"]=i}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==rp)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==e0e)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return Xr.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=Gpe(e,t);return Xr.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return Xr.equals(this,e)}static equals(e,t){const n=t;return n!=null&&e.code===n.code&&e.version===n.version&&Ype(e.multihash,n.multihash)}toString(e){return lR(this,e)}toJSON(){return{"/":lR(this)}}link(){return this}[(Oj=Symbol.toStringTag,Symbol.for("nodejs.util.inspect.custom"))](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof Xr)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:i,multihash:s,bytes:o}=t;return new Xr(n,i,s,o??hR(n,i,s.bytes))}else if(t[t0e]===!0){const{version:n,multihash:i,code:s}=t,o=Qpe(i);return Xr.create(n,s,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==rp)throw new Error(`Version 0 CID must use dag-pb (code: ${rp}) block encoding`);return new Xr(e,t,n,n.bytes)}case 1:{const i=hR(e,t,n.bytes);return new Xr(e,t,n,i)}default:throw new Error("Invalid version")}}static createV0(e){return Xr.create(0,rp,e)}static createV1(e,t){return Xr.create(1,e,t)}static decode(e){const[t,n]=Xr.decodeFirst(e);if(n.length!==0)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=Xr.inspectBytes(e),n=t.size-t.multihashSize,i=l9(e.subarray(n,n+t.multihashSize));if(i.byteLength!==t.multihashSize)throw new Error("Incorrect length");const s=i.subarray(t.multihashSize-t.digestSize),o=new f9(t.multihashCode,t.digestSize,s,i);return[t.version===0?Xr.createV0(o):Xr.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[h,p]=h9(e.subarray(t));return t+=p,h};let i=n(),s=rp;if(i===18?(i=0,t=0):s=n(),i!==0&&i!==1)throw new RangeError(`Invalid CID version ${i}`);const o=t,a=n(),c=n(),l=t+c,d=l-o;return{version:i,codec:s,multihashCode:a,digestSize:c,multihashSize:d,size:l}}static parse(e,t){const[n,i]=Jpe(e,t),s=Xr.decode(i);if(s.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return p9(s).set(n,e),s}};function Jpe(r,e){switch(r[0]){case"Q":{const t=e??wc;return[wc.prefix,t.decode(`${wc.prefix}${r}`)]}case wc.prefix:{const t=e??wc;return[wc.prefix,t.decode(r)]}case $m.prefix:{const t=e??$m;return[$m.prefix,t.decode(r)]}case u9.prefix:{const t=e??u9;return[u9.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}}function Xpe(r,e,t){const{prefix:n}=t;if(n!==wc.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const i=e.get(n);if(i==null){const s=t.encode(r).slice(1);return e.set(n,s),s}else return i}function Zpe(r,e,t){const{prefix:n}=t,i=e.get(n);if(i==null){const s=t.encode(r);return e.set(n,s),s}else return i}const rp=112,e0e=18;function hR(r,e,t){const n=Om(r),i=n+Om(e),s=new Uint8Array(i+t.byteLength);return Mm(r,s,0),Mm(e,s,n),s.set(t,i),s}const t0e=Symbol.for("@ipld/js-cid/CID"),fR=ie("/ipns/");function pR(r){return qe(r.subarray(0,fR.byteLength),fR)}class r0e{constructor(e){u(this,"client");this.client=e}async*findProviders(e,t={}){yield*Ld(this.client.getProviders(e,t),n=>({id:n.ID,multiaddrs:n.Addrs??[]}))}async provide(){}async cancelReprovide(){}async put(e,t,n){if(!pR(e))return;const i=a9(e),s=dR.createV1(114,i),o=tp(t);await this.client.putIPNS(s,o,n)}async get(e,t){if(!pR(e))throw new Zt("Not found");const n=a9(e),i=dR.createV1(114,n);try{const s=await this.client.getIPNS(i,t);return ZO(s)}catch(s){throw s.name==="BadResponseError"?new Zt("Not found"):s}}}class n0e{constructor(e){u(this,"client");this.client=e}async findPeer(e,t={}){const n=await Epe(this.client.getPeers(e,t));if(n!=null)return{id:n.ID,multiaddrs:n.Addrs??[]};throw new Zt("Not found")}async*getClosestPeers(e,t={}){}}const pr=Kd("delegated-routing-v1-http-api-client"),Rm={concurrentRequests:4,timeout:3e4,cacheTTL:5*60*1e3,cacheName:"delegated-routing-v1-cache"};class i0e{constructor(e,t={}){Ye(this,mn);u(this,"started");u(this,"httpQueue");u(this,"shutDownController");u(this,"clientUrl");u(this,"timeout");u(this,"contentRouting");u(this,"peerRouting");u(this,"filterAddrs");u(this,"filterProtocols");u(this,"inFlightRequests");u(this,"cacheName");u(this,"cache");u(this,"cacheTTL");this.started=!1,this.shutDownController=new AbortController,this.shutDownController.signal,this.httpQueue=new Ta({concurrency:t.concurrentRequests??Rm.concurrentRequests}),this.inFlightRequests=new Map,this.clientUrl=e instanceof URL?e:new URL(e),this.timeout=t.timeout??Rm.timeout,this.filterAddrs=t.filterAddrs,this.filterProtocols=t.filterProtocols,this.contentRouting=new r0e(this),this.peerRouting=new n0e(this),this.cacheName=t.cacheName??Rm.cacheName,this.cacheTTL=t.cacheTTL??Rm.cacheTTL}get[bd](){return this.contentRouting}get[vd](){return this.peerRouting}isStarted(){return this.started}async start(){var e;this.started||(this.started=!0,this.cacheTTL>0&&(this.cache=await((e=globalThis.caches)==null?void 0:e.open(this.cacheName)),this.cache!=null&&pr("cache enabled with ttl %d",this.cacheTTL)))}async stop(){var e;this.httpQueue.clear(),this.shutDownController.abort(),await((e=globalThis.caches)==null?void 0:e.delete(this.cacheName)),this.started=!1}async*getProviders(e,t={}){pr("getProviders starts: %c",e);const n=AbortSignal.timeout(this.timeout),i=ft([this.shutDownController.signal,n,t.signal]),s=Re(),o=Re();this.httpQueue.add(async()=>(s.resolve(),o.promise));try{await s.promise;const a=new URL(`${this.clientUrl}routing/v1/providers/${e.toString()}`);Ae(this,mn,BA).call(this,a,t.filterAddrs,t.filterProtocols);const c={headers:{Accept:"application/x-ndjson"},signal:i},l=await Ae(this,mn,g0).call(this,a.toString(),c);if(l==null)throw new Oo("No response received");if(!l.ok)throw l.status===404?new Zt("No matching records found"):l.status===422?new Pm("Request does not conform to schema or semantic constraints"):new Oo(`Unexpected status code: ${l.status}`);if(l.body==null)throw new Oo("Routing response had no body");const d=l.headers.get("Content-Type");if(d==null)throw new Oo("No Content-Type header received");if(d!=null&&d.startsWith("application/json")){const h=await l.json();for(const p of h.Providers){const m=Ae(this,mn,p0).call(this,p);m!=null&&(yield m)}}else if(d.includes("application/x-ndjson"))for await(const h of nR(RO(l.body))){const p=Ae(this,mn,p0).call(this,h);p!=null&&(yield p)}else throw new Oo(`Unsupported Content-Type: ${d}`)}catch(a){pr.error("getProviders errored:",a)}finally{i.clear(),o.resolve(),pr("getProviders finished: %c",e)}}async*getPeers(e,t={}){pr("getPeers starts: %c",e);const n=AbortSignal.timeout(this.timeout),i=ft([this.shutDownController.signal,n,t.signal]),s=Re(),o=Re();this.httpQueue.add(async()=>(s.resolve(),o.promise));try{await s.promise;const a=new URL(`${this.clientUrl}routing/v1/peers/${e.toCID().toString()}`);Ae(this,mn,BA).call(this,a,t.filterAddrs,t.filterProtocols);const c={headers:{Accept:"application/x-ndjson"},signal:i},l=await Ae(this,mn,g0).call(this,a.toString(),c);if(l.status===404)throw new Zt("No matching records found");if(l.status===422)throw new Pm("Request does not conform to schema or semantic constraints");if(l.body==null)throw new Oo("Routing response had no body");if(l.headers.get("Content-Type")==="application/json"){const h=await l.json();for(const p of h.Peers){const m=Ae(this,mn,p0).call(this,p);m!=null&&(yield m)}}else for await(const h of nR(RO(l.body))){const p=Ae(this,mn,p0).call(this,h);p!=null&&(yield p)}}catch(a){pr.error("getPeers errored:",a)}finally{i.clear(),o.resolve(),pr("getPeers finished: %c",e)}}async getIPNS(e,t={}){pr("getIPNS starts: %s",e);const n=AbortSignal.timeout(this.timeout),i=ft([this.shutDownController.signal,n,t.signal]),s=Re(),o=Re();this.httpQueue.add(async()=>(s.resolve(),o.promise));const a=`${this.clientUrl}routing/v1/ipns/${e}`;try{await s.promise;const c={headers:{Accept:"application/vnd.ipfs.ipns-record"},signal:i},l=await Ae(this,mn,g0).call(this,a,c);if(pr("getIPNS GET %s %d",a,l.status),l.status===404)throw new Zt("No matching records found");if(l.status===422)throw new Pm("Request does not conform to schema or semantic constraints");if(l.body==null)throw new Oo("GET ipns response had no body");const d=await l.arrayBuffer(),h=new Uint8Array(d,0,d.byteLength);return t.validate!==!1&&await rR(eR(e.multihash),h),tp(h)}catch(c){throw pr.error("getIPNS GET %s error:",a,c),c}finally{i.clear(),o.resolve(),pr("getIPNS finished: %s",e)}}async putIPNS(e,t,n={}){pr("putIPNS starts: %c",e);const i=AbortSignal.timeout(this.timeout),s=ft([this.shutDownController.signal,i,n.signal]),o=Re(),a=Re();this.httpQueue.add(async()=>(o.resolve(),a.promise));const c=`${this.clientUrl}routing/v1/ipns/${e}`;try{await o.promise;const l=ZO(t),d={method:"PUT",headers:{"Content-Type":"application/vnd.ipfs.ipns-record"},body:l,signal:s},h=await Ae(this,mn,g0).call(this,c,d);if(pr("putIPNS PUT %s %d",c,h.status),h.status!==200)throw new Oo("PUT ipns response had status other than 200")}catch(l){throw pr.error("putIPNS PUT %s error:",c,l.stack),l}finally{s.clear(),a.resolve(),pr("putIPNS finished: %c",e)}}}mn=new WeakSet,p0=function(e){var t;try{const n=[],i=((t=e.Addrs)==null?void 0:t.map(Oe))??[];return e.Protocols!=null&&n.push(...e.Protocols),e.Protocol!=null&&(n.push(e.Protocol),delete e.Protocol),{...e,Schema:"peer",ID:tr(e.ID),Addrs:i,Protocols:n}}catch(n){pr.error("could not conform record to peer schema",n)}},BA=function(e,t,n){var i,s;if(t!=null||this.filterAddrs!=null){const o=(t==null?void 0:t.join(","))??((i=this.filterAddrs)==null?void 0:i.join(","))??"";o!==""&&e.searchParams.set("filter-addrs",o)}if(n!=null||this.filterProtocols!=null){const o=(n==null?void 0:n.join(","))??((s=this.filterProtocols)==null?void 0:s.join(","))??"";o!==""&&e.searchParams.set("filter-protocols",o)}},g0=async function(e,t){var c,l;const n=t.method??"GET",i=`${n}-${e}`;if(n==="GET"){const d=await((c=this.cache)==null?void 0:c.match(e));if(d!=null){if(parseInt(d.headers.get("x-cache-expires")??"0",10)>Date.now())return pr("returning cached response for %s",i),d;await((l=this.cache)==null?void 0:l.delete(e))}}const s=this.inFlightRequests.get(i);if(s!=null){const d=await s;return pr("deduplicating outgoing request for %s",i),d.clone()}const o=fetch(e,t).then(async d=>{if(this.cache!=null&&d.ok&&n==="GET"){const h=Date.now()+this.cacheTTL,p=new Headers(d.headers);p.set("x-cache-expires",h.toString());const m=new Response(d.clone().body,{status:d.status,statusText:d.statusText,headers:p});await this.cache.put(e,m)}return d}).finally(()=>{this.inFlightRequests.delete(i)});return this.inFlightRequests.set(i,o),await o};function s0e(r,e={}){return new i0e(new URL(r),e)}function o0e(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function Lm(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function a0e(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var i=0;i<r.length;i++){var s=r.charAt(i),o=s.charCodeAt(0);if(t[o]!==255)throw new TypeError(s+" is ambiguous");t[o]=i}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),d=Math.log(256)/Math.log(a);function h(f){if(f instanceof Uint8Array||(ArrayBuffer.isView(f)?f=new Uint8Array(f.buffer,f.byteOffset,f.byteLength):Array.isArray(f)&&(f=Uint8Array.from(f))),!(f instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(f.length===0)return"";for(var g=0,w=0,y=0,b=f.length;y!==b&&f[y]===0;)y++,g++;for(var v=(b-y)*d+1>>>0,E=new Uint8Array(v);y!==b;){for(var C=f[y],k=0,x=v-1;(C!==0||k<w)&&x!==-1;x--,k++)C+=256*E[x]>>>0,E[x]=C%a>>>0,C=C/a>>>0;if(C!==0)throw new Error("Non-zero carry");w=k,y++}for(var I=v-w;I!==v&&E[I]===0;)I++;for(var T=c.repeat(g);I<v;++I)T+=r.charAt(E[I]);return T}function p(f){if(typeof f!="string")throw new TypeError("Expected String");if(f.length===0)return new Uint8Array;var g=0;if(f[g]!==" "){for(var w=0,y=0;f[g]===c;)w++,g++;for(var b=(f.length-g)*l+1>>>0,v=new Uint8Array(b);f[g];){var E=t[f.charCodeAt(g)];if(E===255)return;for(var C=0,k=b-1;(E!==0||C<y)&&k!==-1;k--,C++)E+=a*v[k]>>>0,v[k]=E%256>>>0,E=E/256>>>0;if(E!==0)throw new Error("Non-zero carry");y=C,g++}if(f[g]!==" "){for(var x=b-y;x!==b&&v[x]===0;)x++;for(var I=new Uint8Array(w+(b-x)),T=w;x!==b;)I[T++]=v[x++];return I}}}function m(f){var g=p(f);if(g)return g;throw new Error(`Non-${e} character`)}return{encode:h,decodeUnsafe:p,decode:m}}var c0e=a0e,l0e=c0e;let u0e=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseEncode");this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},d0e=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseDecode");u(this,"prefixCodePoint");this.name=e,this.prefix=t;const i=t.codePointAt(0);if(i===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=i,this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return gR(this,e)}},h0e=class{constructor(e){u(this,"decoders");this.decoders=e}or(e){return gR(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};function gR(r,e){return new h0e({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}let f0e=class{constructor(e,t,n,i){u(this,"name");u(this,"prefix");u(this,"baseEncode");u(this,"baseDecode");u(this,"encoder");u(this,"decoder");this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=i,this.encoder=new u0e(e,t,n),this.decoder=new d0e(e,t,i)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};function yR({name:r,prefix:e,encode:t,decode:n}){return new f0e(r,e,t,n)}function Bm({name:r,prefix:e,alphabet:t}){const{encode:n,decode:i}=l0e(t,r);return yR({prefix:e,name:r,encode:n,decode:s=>Lm(i(s))})}function p0e(r,e,t,n){const i={};for(let d=0;d<e.length;++d)i[e[d]]=d;let s=r.length;for(;r[s-1]==="=";)--s;const o=new Uint8Array(s*t/8|0);let a=0,c=0,l=0;for(let d=0;d<s;++d){const h=i[r[d]];if(h===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|h,a+=t,a>=8&&(a-=8,o[l++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o}function g0e(r,e,t){const n=e[e.length-1]==="=",i=(1<<t)-1;let s="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,s+=e[i&a>>o];if(o!==0&&(s+=e[i&a<<t-o]),n)for(;s.length*t&7;)s+="=";return s}function Lo({name:r,prefix:e,bitsPerChar:t,alphabet:n}){return yR({prefix:e,name:r,encode(i){return g0e(i,n,t)},decode(i){return p0e(i,n,t,r)}})}const Um=Lo({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});Lo({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),Lo({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),Lo({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),Lo({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),Lo({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),Lo({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),Lo({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),Lo({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const g9=Bm({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"});Bm({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});const bc=Bm({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});Bm({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var y0e=wR,mR=128,m0e=-128,w0e=Math.pow(2,31);function wR(r,e,t){e=e||[],t=t||0;for(var n=t;r>=w0e;)e[t++]=r&255|mR,r/=128;for(;r&m0e;)e[t++]=r&255|mR,r>>>=7;return e[t]=r|0,wR.bytes=t-n+1,e}var b0e=y9,v0e=128,bR=127;function y9(r,n){var t=0,n=n||0,i=0,s=n,o,a=r.length;do{if(s>=a)throw y9.bytes=0,new RangeError("Could not decode varint");o=r[s++],t+=i<28?(o&bR)<<i:(o&bR)*Math.pow(2,i),i+=7}while(o>=v0e);return y9.bytes=s-n,t}var E0e=Math.pow(2,7),S0e=Math.pow(2,14),x0e=Math.pow(2,21),A0e=Math.pow(2,28),C0e=Math.pow(2,35),I0e=Math.pow(2,42),k0e=Math.pow(2,49),_0e=Math.pow(2,56),T0e=Math.pow(2,63),P0e=function(r){return r<E0e?1:r<S0e?2:r<x0e?3:r<A0e?4:r<C0e?5:r<I0e?6:r<k0e?7:r<_0e?8:r<T0e?9:10},D0e={encode:y0e,decode:b0e,encodingLength:P0e},Fm=D0e;function m9(r,e=0){return[Fm.decode(r,e),Fm.decode.bytes]}function zm(r,e,t=0){return Fm.encode(r,e,t),e}function Vm(r){return Fm.encodingLength(r)}function vR(r,e){const t=e.byteLength,n=Vm(r),i=n+Vm(t),s=new Uint8Array(i+t);return zm(r,s,0),zm(t,s,n),s.set(e,i),new w9(r,t,e,s)}function $0e(r){const e=Lm(r),[t,n]=m9(e),[i,s]=m9(e.subarray(n)),o=e.subarray(n+s);if(o.byteLength!==i)throw new Error("Incorrect length");return new w9(t,i,o,e)}function N0e(r,e){if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&o0e(r.bytes,t.bytes)}}let w9=class{constructor(e,t,n,i){u(this,"code");u(this,"size");u(this,"digest");u(this,"bytes");this.code=e,this.size=t,this.digest=n,this.bytes=i}};function ER(r,e){const{bytes:t,version:n}=r;switch(n){case 0:return R0e(t,b9(r),e??bc.encoder);default:return L0e(t,b9(r),e??Um.encoder)}}const SR=new WeakMap;function b9(r){const e=SR.get(r);if(e==null){const t=new Map;return SR.set(r,t),t}return e}let M0e=class Zr{constructor(e,t,n,i){u(this,"code");u(this,"version");u(this,"multihash");u(this,"bytes");u(this,"/");u(this,Rj,"CID");this.code=t,this.version=e,this.multihash=n,this.bytes=i,this["/"]=i}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==np)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==B0e)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return Zr.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=vR(e,t);return Zr.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return Zr.equals(this,e)}static equals(e,t){const n=t;return n!=null&&e.code===n.code&&e.version===n.version&&N0e(e.multihash,n.multihash)}toString(e){return ER(this,e)}toJSON(){return{"/":ER(this)}}link(){return this}[(Rj=Symbol.toStringTag,Symbol.for("nodejs.util.inspect.custom"))](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof Zr)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:i,multihash:s,bytes:o}=t;return new Zr(n,i,s,o??xR(n,i,s.bytes))}else if(t[U0e]===!0){const{version:n,multihash:i,code:s}=t,o=$0e(i);return Zr.create(n,s,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==np)throw new Error(`Version 0 CID must use dag-pb (code: ${np}) block encoding`);return new Zr(e,t,n,n.bytes)}case 1:{const i=xR(e,t,n.bytes);return new Zr(e,t,n,i)}default:throw new Error("Invalid version")}}static createV0(e){return Zr.create(0,np,e)}static createV1(e,t){return Zr.create(1,e,t)}static decode(e){const[t,n]=Zr.decodeFirst(e);if(n.length!==0)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=Zr.inspectBytes(e),n=t.size-t.multihashSize,i=Lm(e.subarray(n,n+t.multihashSize));if(i.byteLength!==t.multihashSize)throw new Error("Incorrect length");const s=i.subarray(t.multihashSize-t.digestSize),o=new w9(t.multihashCode,t.digestSize,s,i);return[t.version===0?Zr.createV0(o):Zr.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[h,p]=m9(e.subarray(t));return t+=p,h};let i=n(),s=np;if(i===18?(i=0,t=0):s=n(),i!==0&&i!==1)throw new RangeError(`Invalid CID version ${i}`);const o=t,a=n(),c=n(),l=t+c,d=l-o;return{version:i,codec:s,multihashCode:a,digestSize:c,multihashSize:d,size:l}}static parse(e,t){const[n,i]=O0e(e,t),s=Zr.decode(i);if(s.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return b9(s).set(n,e),s}};function O0e(r,e){switch(r[0]){case"Q":{const t=e??bc;return[bc.prefix,t.decode(`${bc.prefix}${r}`)]}case bc.prefix:{const t=e??bc;return[bc.prefix,t.decode(r)]}case Um.prefix:{const t=e??Um;return[Um.prefix,t.decode(r)]}case g9.prefix:{const t=e??g9;return[g9.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}}function R0e(r,e,t){const{prefix:n}=t;if(n!==bc.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const i=e.get(n);if(i==null){const s=t.encode(r).slice(1);return e.set(n,s),s}else return i}function L0e(r,e,t){const{prefix:n}=t,i=e.get(n);if(i==null){const s=t.encode(r);return e.set(n,s),s}else return i}const np=112,B0e=18;function xR(r,e,t){const n=Vm(r),i=n+Vm(e),s=new Uint8Array(i+t.byteLength);return zm(r,s,0),zm(e,s,n),s.set(t,i),s}const U0e=Symbol.for("@ipld/js-cid/CID");function F0e(){return{filterProtocols:["unknown","transport-bitswap","transport-ipfs-gateway-http"],filterAddrs:["https","webtransport","webrtc","webrtc-direct","wss","tls"]}}const AR="[a-fA-F\\d:]",vc=r=>r&&r.includeBoundaries?`(?:(?<=\\s|^)(?=${AR})|(?<=${AR})(?=\\s|$))`:"",os="(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)(?:\\.(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)){3}",rr="[a-fA-F\\d]{1,4}",Km=`
(?:
(?:${rr}:){7}(?:${rr}|:)|                                    // 1:2:3:4:5:6:7::  1:2:3:4:5:6:7:8
(?:${rr}:){6}(?:${os}|:${rr}|:)|                             // 1:2:3:4:5:6::    1:2:3:4:5:6::8   1:2:3:4:5:6::8  1:2:3:4:5:6::1.2.3.4
(?:${rr}:){5}(?::${os}|(?::${rr}){1,2}|:)|                   // 1:2:3:4:5::      1:2:3:4:5::7:8   1:2:3:4:5::8    1:2:3:4:5::7:1.2.3.4
(?:${rr}:){4}(?:(?::${rr}){0,1}:${os}|(?::${rr}){1,3}|:)| // 1:2:3:4::        1:2:3:4::6:7:8   1:2:3:4::8      1:2:3:4::6:7:1.2.3.4
(?:${rr}:){3}(?:(?::${rr}){0,2}:${os}|(?::${rr}){1,4}|:)| // 1:2:3::          1:2:3::5:6:7:8   1:2:3::8        1:2:3::5:6:7:1.2.3.4
(?:${rr}:){2}(?:(?::${rr}){0,3}:${os}|(?::${rr}){1,5}|:)| // 1:2::            1:2::4:5:6:7:8   1:2::8          1:2::4:5:6:7:1.2.3.4
(?:${rr}:){1}(?:(?::${rr}){0,4}:${os}|(?::${rr}){1,6}|:)| // 1::              1::3:4:5:6:7:8   1::8            1::3:4:5:6:7:1.2.3.4
(?::(?:(?::${rr}){0,5}:${os}|(?::${rr}){1,7}|:))             // ::2:3:4:5:6:7:8  ::2:3:4:5:6:7:8  ::8             ::1.2.3.4
)(?:%[0-9a-zA-Z]{1,})?                                             // %eth0            %1
`.replace(/\s*\/\/.*$/gm,"").replace(/\n/g,"").trim(),z0e=new RegExp(`(?:^${os}$)|(?:^${Km}$)`),V0e=new RegExp(`^${os}$`),K0e=new RegExp(`^${Km}$`),jm=r=>r&&r.exact?z0e:new RegExp(`(?:${vc(r)}${os}${vc(r)})|(?:${vc(r)}${Km}${vc(r)})`,"g");jm.v4=r=>r&&r.exact?V0e:new RegExp(`${vc(r)}${os}${vc(r)}`,"g"),jm.v6=r=>r&&r.exact?K0e:new RegExp(`${vc(r)}${Km}${vc(r)}`,"g");function j0e(r){const e=(...t)=>r(...t);return Object.defineProperty(e,"name",{value:`functionTimeout(${r.name||"<anonymous>"})`,configurable:!0}),e}const{toString:H0e}=Object.prototype;function q0e(r){return H0e.call(r)==="[object RegExp]"}const CR={global:"g",ignoreCase:"i",multiline:"m",dotAll:"s",sticky:"y",unicode:"u"};function W0e(r,e={}){if(!q0e(r))throw new TypeError("Expected a RegExp instance");const t=Object.keys(CR).map(i=>(typeof e[i]=="boolean"?e[i]:r[i])?CR[i]:"").join(""),n=new RegExp(e.source||r.source,t);return n.lastIndex=typeof e.lastIndex=="number"?e.lastIndex:r.lastIndex,n}function IR(r,e,{timeout:t}={}){try{return j0e(()=>W0e(r).test(e),{timeout:t})()}catch(n){throw n}}const G0e=15,Q0e=45,kR={timeout:400};function _R(r){return r.length>Q0e?!1:IR(jm.v6({exact:!0}),r,kR)}function Y0e(r){return r.length>G0e?!1:IR(jm.v4({exact:!0}),r,kR)}const TR={http:"80",https:"443",ws:"80",wss:"443"},J0e=["http","https","ws","wss"];function X0e(r,e){e=e??{};const t=e.defaultDnsType??"dns4",{scheme:n,hostname:i,port:s,path:o}=Z0e(r),a=[ege(i,t),tge(s,n),rge(n)];o!=null&&a.push(nge(o));const c="/"+a.filter(l=>!!l).reduce((l,d)=>l.concat(d),[]).join("/");return Oe(c)}function Z0e(r){const[e]=r.split(":");J0e.includes(e)||(r="http"+r.substring(e.length));let{protocol:t,hostname:n,port:i,pathname:s,search:o}=new URL(r);if(i==null||i===""){const c=ige(e);c!=null&&(i=c),c==null&&t==="http:"&&(i="80")}let a;return s!=null&&s!==""&&s!=="/"&&(s.startsWith("/")&&(s=s.substring(1)),a=s),o!=null&&o!==""&&(a=a??"",a+=o),{scheme:e,hostname:n,port:i,path:a}}function ege(r,e){if(!(r==null||r==="")){if(Y0e(r))return["ip4",r];if(_R(r))return["ip6",r];if(r[0]==="["){const t=r.substring(1,r.length-1);if(_R(t))return["ip6",t]}return[e,r]}}function tge(r,e){if(!(r==null||r===""))return e==="udp"?["udp",r]:["tcp",r]}function rge(r){if(r.match(/^tcp$|^udp$/)==null)return[r]}function nge(r){if(!(r==null||r===""))return["http-path",encodeURIComponent(r)]}function ige(r){if(!(r==null||r===""||TR[r]==null))return TR[r]}const PR=0,sge="identity",DR=Lm;function oge(r){return vR(PR,DR(r))}const age={code:PR,name:sge,encode:DR,digest:oge},cge=["https://trustless-gateway.link","https://4everland.io"],lge=2336;function uge(r){return r=r.toString(),{id:Ud(M0e.createV1(lge,age.digest(ie(r)))),multiaddrs:[X0e(r)]}}class dge{constructor(e={}){u(this,"gateways");this.gateways=(e.gateways??cge).map(t=>uge(t))}async*findProviders(e,t){yield*this.gateways.toSorted(()=>Math.random()>.5?1:-1).map(n=>({...n,protocols:["transport-ipfs-gateway-http"]}))}}function hge(r={}){return new dge(r)}class fge{constructor(e){u(this,"libp2p");this.libp2p=e}async provide(e,t){await this.libp2p.contentRouting.provide(e,t)}async cancelReprovide(e,t){await this.libp2p.contentRouting.cancelReprovide(e,t)}async*findProviders(e,t){yield*this.libp2p.contentRouting.findProviders(e,t)}async put(e,t,n){await this.libp2p.contentRouting.put(e,t,n)}async get(e,t){return this.libp2p.contentRouting.get(e,t)}async findPeer(e,t){return this.libp2p.peerRouting.findPeer(e,t)}async*getClosestPeers(e,t){yield*this.libp2p.peerRouting.getClosestPeers(e,t)}}function pge(r){return new fge(r)}function gge(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function v9(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function yge(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var i=0;i<r.length;i++){var s=r.charAt(i),o=s.charCodeAt(0);if(t[o]!==255)throw new TypeError(s+" is ambiguous");t[o]=i}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),d=Math.log(256)/Math.log(a);function h(f){if(f instanceof Uint8Array||(ArrayBuffer.isView(f)?f=new Uint8Array(f.buffer,f.byteOffset,f.byteLength):Array.isArray(f)&&(f=Uint8Array.from(f))),!(f instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(f.length===0)return"";for(var g=0,w=0,y=0,b=f.length;y!==b&&f[y]===0;)y++,g++;for(var v=(b-y)*d+1>>>0,E=new Uint8Array(v);y!==b;){for(var C=f[y],k=0,x=v-1;(C!==0||k<w)&&x!==-1;x--,k++)C+=256*E[x]>>>0,E[x]=C%a>>>0,C=C/a>>>0;if(C!==0)throw new Error("Non-zero carry");w=k,y++}for(var I=v-w;I!==v&&E[I]===0;)I++;for(var T=c.repeat(g);I<v;++I)T+=r.charAt(E[I]);return T}function p(f){if(typeof f!="string")throw new TypeError("Expected String");if(f.length===0)return new Uint8Array;var g=0;if(f[g]!==" "){for(var w=0,y=0;f[g]===c;)w++,g++;for(var b=(f.length-g)*l+1>>>0,v=new Uint8Array(b);f[g];){var E=t[f.charCodeAt(g)];if(E===255)return;for(var C=0,k=b-1;(E!==0||C<y)&&k!==-1;k--,C++)E+=a*v[k]>>>0,v[k]=E%256>>>0,E=E/256>>>0;if(E!==0)throw new Error("Non-zero carry");y=C,g++}if(f[g]!==" "){for(var x=b-y;x!==b&&v[x]===0;)x++;for(var I=new Uint8Array(w+(b-x)),T=w;x!==b;)I[T++]=v[x++];return I}}}function m(f){var g=p(f);if(g)return g;throw new Error(`Non-${e} character`)}return{encode:h,decodeUnsafe:p,decode:m}}var mge=yge,wge=mge;let bge=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseEncode");this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},vge=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseDecode");u(this,"prefixCodePoint");this.name=e,this.prefix=t;const i=t.codePointAt(0);if(i===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=i,this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return $R(this,e)}},Ege=class{constructor(e){u(this,"decoders");this.decoders=e}or(e){return $R(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};function $R(r,e){return new Ege({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}let Sge=class{constructor(e,t,n,i){u(this,"name");u(this,"prefix");u(this,"baseEncode");u(this,"baseDecode");u(this,"encoder");u(this,"decoder");this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=i,this.encoder=new bge(e,t,n),this.decoder=new vge(e,t,i)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};function NR({name:r,prefix:e,encode:t,decode:n}){return new Sge(r,e,t,n)}function Hm({name:r,prefix:e,alphabet:t}){const{encode:n,decode:i}=wge(t,r);return NR({prefix:e,name:r,encode:n,decode:s=>v9(i(s))})}function xge(r,e,t,n){const i={};for(let d=0;d<e.length;++d)i[e[d]]=d;let s=r.length;for(;r[s-1]==="=";)--s;const o=new Uint8Array(s*t/8|0);let a=0,c=0,l=0;for(let d=0;d<s;++d){const h=i[r[d]];if(h===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|h,a+=t,a>=8&&(a-=8,o[l++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o}function Age(r,e,t){const n=e[e.length-1]==="=",i=(1<<t)-1;let s="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,s+=e[i&a>>o];if(o!==0&&(s+=e[i&a<<t-o]),n)for(;s.length*t&7;)s+="=";return s}function Bo({name:r,prefix:e,bitsPerChar:t,alphabet:n}){return NR({prefix:e,name:r,encode(i){return Age(i,n,t)},decode(i){return xge(i,n,t,r)}})}const Uo=Bo({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});Bo({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),Bo({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),Bo({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),Bo({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),Bo({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),Bo({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),Bo({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),Bo({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const E9=Hm({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"});Hm({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});const Ec=Hm({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});Hm({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var Cge=OR,MR=128,Ige=-128,kge=Math.pow(2,31);function OR(r,e,t){e=e||[],t=t||0;for(var n=t;r>=kge;)e[t++]=r&255|MR,r/=128;for(;r&Ige;)e[t++]=r&255|MR,r>>>=7;return e[t]=r|0,OR.bytes=t-n+1,e}var _ge=S9,Tge=128,RR=127;function S9(r,n){var t=0,n=n||0,i=0,s=n,o,a=r.length;do{if(s>=a)throw S9.bytes=0,new RangeError("Could not decode varint");o=r[s++],t+=i<28?(o&RR)<<i:(o&RR)*Math.pow(2,i),i+=7}while(o>=Tge);return S9.bytes=s-n,t}var Pge=Math.pow(2,7),Dge=Math.pow(2,14),$ge=Math.pow(2,21),Nge=Math.pow(2,28),Mge=Math.pow(2,35),Oge=Math.pow(2,42),Rge=Math.pow(2,49),Lge=Math.pow(2,56),Bge=Math.pow(2,63),Uge=function(r){return r<Pge?1:r<Dge?2:r<$ge?3:r<Nge?4:r<Mge?5:r<Oge?6:r<Rge?7:r<Lge?8:r<Bge?9:10},Fge={encode:Cge,decode:_ge,encodingLength:Uge},qm=Fge;function x9(r,e=0){return[qm.decode(r,e),qm.decode.bytes]}function Wm(r,e,t=0){return qm.encode(r,e,t),e}function Gm(r){return qm.encodingLength(r)}function zge(r,e){const t=e.byteLength,n=Gm(r),i=n+Gm(t),s=new Uint8Array(i+t);return Wm(r,s,0),Wm(t,s,n),s.set(e,i),new A9(r,t,e,s)}function LR(r){const e=v9(r),[t,n]=x9(e),[i,s]=x9(e.subarray(n)),o=e.subarray(n+s);if(o.byteLength!==i)throw new Error("Incorrect length");return new A9(t,i,o,e)}function Vge(r,e){if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&gge(r.bytes,t.bytes)}}let A9=class{constructor(e,t,n,i){u(this,"code");u(this,"size");u(this,"digest");u(this,"bytes");this.code=e,this.size=t,this.digest=n,this.bytes=i}};function BR(r,e){const{bytes:t,version:n}=r;switch(n){case 0:return Hge(t,C9(r),e??Ec.encoder);default:return qge(t,C9(r),e??Uo.encoder)}}const UR=new WeakMap;function C9(r){const e=UR.get(r);if(e==null){const t=new Map;return UR.set(r,t),t}return e}let Kge=class en{constructor(e,t,n,i){u(this,"code");u(this,"version");u(this,"multihash");u(this,"bytes");u(this,"/");u(this,Lj,"CID");this.code=t,this.version=e,this.multihash=n,this.bytes=i,this["/"]=i}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==ip)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==Wge)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return en.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=zge(e,t);return en.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return en.equals(this,e)}static equals(e,t){const n=t;return n!=null&&e.code===n.code&&e.version===n.version&&Vge(e.multihash,n.multihash)}toString(e){return BR(this,e)}toJSON(){return{"/":BR(this)}}link(){return this}[(Lj=Symbol.toStringTag,Symbol.for("nodejs.util.inspect.custom"))](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof en)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:i,multihash:s,bytes:o}=t;return new en(n,i,s,o??FR(n,i,s.bytes))}else if(t[Gge]===!0){const{version:n,multihash:i,code:s}=t,o=LR(i);return en.create(n,s,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==ip)throw new Error(`Version 0 CID must use dag-pb (code: ${ip}) block encoding`);return new en(e,t,n,n.bytes)}case 1:{const i=FR(e,t,n.bytes);return new en(e,t,n,i)}default:throw new Error("Invalid version")}}static createV0(e){return en.create(0,ip,e)}static createV1(e,t){return en.create(1,e,t)}static decode(e){const[t,n]=en.decodeFirst(e);if(n.length!==0)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=en.inspectBytes(e),n=t.size-t.multihashSize,i=v9(e.subarray(n,n+t.multihashSize));if(i.byteLength!==t.multihashSize)throw new Error("Incorrect length");const s=i.subarray(t.multihashSize-t.digestSize),o=new A9(t.multihashCode,t.digestSize,s,i);return[t.version===0?en.createV0(o):en.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[h,p]=x9(e.subarray(t));return t+=p,h};let i=n(),s=ip;if(i===18?(i=0,t=0):s=n(),i!==0&&i!==1)throw new RangeError(`Invalid CID version ${i}`);const o=t,a=n(),c=n(),l=t+c,d=l-o;return{version:i,codec:s,multihashCode:a,digestSize:c,multihashSize:d,size:l}}static parse(e,t){const[n,i]=jge(e,t),s=en.decode(i);if(s.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return C9(s).set(n,e),s}};function jge(r,e){switch(r[0]){case"Q":{const t=e??Ec;return[Ec.prefix,t.decode(`${Ec.prefix}${r}`)]}case Ec.prefix:{const t=e??Ec;return[Ec.prefix,t.decode(r)]}case Uo.prefix:{const t=e??Uo;return[Uo.prefix,t.decode(r)]}case E9.prefix:{const t=e??E9;return[E9.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}}function Hge(r,e,t){const{prefix:n}=t;if(n!==Ec.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const i=e.get(n);if(i==null){const s=t.encode(r).slice(1);return e.set(n,s),s}else return i}function qge(r,e,t){const{prefix:n}=t,i=e.get(n);if(i==null){const s=t.encode(r);return e.set(n,s),s}else return i}const ip=112,Wge=18;function FR(r,e,t){const n=Gm(r),i=n+Gm(e),s=new Uint8Array(i+t.byteLength);return Wm(r,s,0),Wm(e,s,n),s.set(t,i),s}const Gge=Symbol.for("@ipld/js-cid/CID"),Qge=85;class Yge extends DM{constructor(){super();u(this,"data");this.data=new Map}put(t,n){return this.data.set(Uo.encode(t.multihash.bytes),n),t}get(t){const n=this.data.get(Uo.encode(t.multihash.bytes));if(n==null)throw new H1;return n}has(t){return this.data.has(Uo.encode(t.multihash.bytes))}async delete(t){this.data.delete(Uo.encode(t.multihash.bytes))}async*getAll(){for(const[t,n]of this.data.entries())yield{cid:Kge.createV1(Qge,LR(Uo.decode(t))),block:n}}}Kd("blockstore:core:tiered");const Jge="SHARDING";function Xge(r){return r[Symbol.asyncIterator]!=null}function Qm(r){if(Xge(r))return(async()=>{const t=[];for await(const n of r)t.push(n);return t})();const e=[];for(const t of r)e.push(t);return e}function Zge(r){return r[Symbol.asyncIterator]!=null}function zR(r,e){return Zge(r)?async function*(){yield*(await Qm(r)).sort(e)}():function*(){yield*Qm(r).sort(e)}()}class e2e{put(e,t,n){return Promise.reject(new Error(".put is not implemented"))}get(e,t){return Promise.reject(new Error(".get is not implemented"))}has(e,t){return Promise.reject(new Error(".has is not implemented"))}delete(e,t){return Promise.reject(new Error(".delete is not implemented"))}async*putMany(e,t={}){for await(const{key:n,value:i}of e)await this.put(n,i,t),yield n}async*getMany(e,t={}){for await(const n of e)yield{key:n,value:await this.get(n,t)}}async*deleteMany(e,t={}){for await(const n of e)await this.delete(n,t),yield n}batch(){let e=[],t=[];return{put(n,i){e.push({key:n,value:i})},delete(n){t.push(n)},commit:async n=>{await mo(this.putMany(e,n)),e=[],await mo(this.deleteMany(t,n)),t=[]}}}async*_all(e,t){throw new Error("._all is not implemented")}async*_allKeys(e,t){throw new Error("._allKeys is not implemented")}query(e,t){let n=this._all(e,t);if(e.prefix!=null){const i=e.prefix;n=Kl(n,s=>s.key.toString().startsWith(i))}if(Array.isArray(e.filters)&&(n=e.filters.reduce((i,s)=>Kl(i,s),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((i,s)=>zR(i,s),n)),e.offset!=null){let i=0;const s=e.offset;n=Kl(n,()=>i++>=s)}return e.limit!=null&&(n=yy(n,e.limit)),n}queryKeys(e,t){let n=this._allKeys(e,t);if(e.prefix!=null){const i=e.prefix;n=Kl(n,s=>s.toString().startsWith(i))}if(Array.isArray(e.filters)&&(n=e.filters.reduce((i,s)=>Kl(i,s),n)),Array.isArray(e.orders)&&(n=e.orders.reduce((i,s)=>zR(i,s),n)),e.offset!=null){const i=e.offset;let s=0;n=Kl(n,()=>s++>=i)}return e.limit!=null&&(n=yy(n,e.limit)),n}}class VR extends e2e{constructor(){super();u(this,"data");this.data=new Map}put(t,n){return this.data.set(t.toString(),n),t}get(t){const n=this.data.get(t.toString());if(n==null)throw new H1;return n}has(t){return this.data.has(t.toString())}delete(t){this.data.delete(t.toString())}*_all(){for(const[t,n]of this.data.entries())yield{key:new At(t),value:n}}*_allKeys(){for(const t of this.data.keys())yield new At(t)}}new At(Jge),Kd("datastore:core:tiered");class t2e extends Tde{constructor(t){super({...t,components:{libp2p:t.libp2p}});u(this,"libp2p");this.libp2p=t.libp2p}async start(){await super.start(),await this.libp2p.start()}async stop(){await super.stop(),await this.libp2p.stop()}}let r2e=class{constructor(){u(this,"readNext");u(this,"haveNext");u(this,"ended");u(this,"nextResult");u(this,"error");this.ended=!1,this.readNext=Re(),this.haveNext=Re()}[Symbol.asyncIterator](){return this}async next(){if(this.nextResult==null&&await this.haveNext.promise,this.nextResult==null)throw new Error("HaveNext promise resolved but nextResult was undefined");const e=this.nextResult;return this.nextResult=void 0,this.readNext.resolve(),this.readNext=Re(),e}async throw(e){return this.ended=!0,this.error=e,e!=null&&(this.haveNext.promise.catch(()=>{}),this.haveNext.reject(e)),{done:!0,value:void 0}}async return(){const e={done:!0,value:void 0};return this.ended=!0,this.nextResult=e,this.haveNext.resolve(),e}async push(e,t){await this._push(e,t)}async end(e,t){e!=null?await this.throw(e):await this._push(void 0,t)}async _push(e,t){if(e!=null&&this.ended)throw this.error??new Error("Cannot push value onto an ended pushable");for(;this.nextResult!=null;)await this.readNext.promise;e!=null?this.nextResult={done:!1,value:e}:(this.ended=!0,this.nextResult={done:!0,value:void 0}),this.haveNext.resolve(),this.haveNext=Re(),await an(this.readNext.promise,t==null?void 0:t.signal,t)}};function n2e(){return new r2e}let i2e=class extends Error{constructor(){super(...arguments);u(this,"name","UnexpectedEOFError");u(this,"code","ERR_UNEXPECTED_EOF")}};function Ym(r,e){const t=n2e();r.sink(t).catch(async o=>{await t.end(o)}),r.sink=async o=>{for await(const a of o)await t.push(a);await t.end()};let n=r.source;r.source[Symbol.iterator]!=null?n=r.source[Symbol.iterator]():r.source[Symbol.asyncIterator]!=null&&(n=r.source[Symbol.asyncIterator]());const i=new Le;return{read:async o=>{var c;if((c=o==null?void 0:o.signal)==null||c.throwIfAborted(),(o==null?void 0:o.bytes)==null){const{done:l,value:d}=await an(n.next(),o==null?void 0:o.signal);return l===!0?null:d}for(;i.byteLength<o.bytes;){const{value:l,done:d}=await an(n.next(),o==null?void 0:o.signal);if(d===!0)throw new i2e("unexpected end of input");i.append(l)}const a=i.sublist(0,o.bytes);return i.consume(o.bytes),a},write:async(o,a)=>{var c;(c=a==null?void 0:a.signal)==null||c.throwIfAborted(),o instanceof Uint8Array?await t.push(o,a):await t.push(o.subarray(),a)},unwrap:()=>{if(i.byteLength>0){const o=r.source;r.source=async function*(){(e==null?void 0:e.yieldBytes)===!1?yield i:yield*i,yield*o}()}return r}}}let s2e=class extends Error{constructor(){super(...arguments);u(this,"name","InvalidMessageLengthError");u(this,"code","ERR_INVALID_MSG_LENGTH")}},o2e=class extends Error{constructor(){super(...arguments);u(this,"name","InvalidDataLengthError");u(this,"code","ERR_MSG_DATA_TOO_LONG")}},a2e=class extends Error{constructor(){super(...arguments);u(this,"name","InvalidDataLengthLengthError");u(this,"code","ERR_MSG_LENGTH_TOO_LONG")}};function Yd(r,e={}){const t=Ym(r,e);e.maxDataLength!=null&&e.maxLengthLength==null&&(e.maxLengthLength=gt(e.maxDataLength));const n=(e==null?void 0:e.lengthDecoder)??Zi,i=(e==null?void 0:e.lengthEncoder)??Er;return{read:async o=>{let a=-1;const c=new Le;for(;;){c.append(await t.read({...o,bytes:1}));try{a=n(c)}catch(l){if(l instanceof RangeError)continue;throw l}if(a<0)throw new s2e("Invalid message length");if((e==null?void 0:e.maxLengthLength)!=null&&c.byteLength>e.maxLengthLength)throw new a2e("message length length too long");if(a>-1)break}if((e==null?void 0:e.maxDataLength)!=null&&a>e.maxDataLength)throw new o2e("message length too long");return t.read({...o,bytes:a})},write:async(o,a)=>{await t.write(new Le(i(o.byteLength),o),a)},writeV:async(o,a)=>{const c=new Le(...o.flatMap(l=>[i(l.byteLength),l]));await t.write(c,a)},unwrap:()=>t.unwrap()}}function KR(){const r=Re();let e=!1;return{sink:async t=>{if(e)throw new Error("already piped");e=!0,r.resolve(t)},source:async function*(){yield*await r.promise}()}}function c2e(){const r=KR(),e=KR();return[{source:r.source,sink:e.sink},{source:e.source,sink:r.sink}]}const sp=65535,jR=sp-16,op=!!((Uj=(Bj=globalThis.process)==null?void 0:Bj.env)!=null&&Uj.DUMP_SESSION_KEYS);function I9(r){if(!Number.isSafeInteger(r)||r<0)throw new Error("positive integer expected, got "+r)}function HR(r){return r instanceof Uint8Array||ArrayBuffer.isView(r)&&r.constructor.name==="Uint8Array"}function ai(r,...e){if(!HR(r))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(r.length))throw new Error("Uint8Array expected of length "+e+", got length="+r.length)}function qR(r,e=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(e&&r.finished)throw new Error("Hash#digest() has already been called")}function l2e(r,e){ai(r);const t=e.outputLen;if(r.length<t)throw new Error("digestInto() expects output buffer of length at least "+t)}function WR(r){if(typeof r!="boolean")throw new Error(`boolean expected, not ${r}`)}/*! noble-ciphers - MIT License (c) 2023 Paul Miller (paulmillr.com) */const Sc=r=>new Uint32Array(r.buffer,r.byteOffset,Math.floor(r.byteLength/4)),u2e=r=>new DataView(r.buffer,r.byteOffset,r.byteLength);if(!(new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68))throw new Error("Non little-endian hardware is not supported");function d2e(r){if(typeof r!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(r))}function k9(r){if(typeof r=="string")r=d2e(r);else if(HR(r))r=_9(r);else throw new Error("Uint8Array expected, got "+typeof r);return r}function h2e(r,e){if(e==null||typeof e!="object")throw new Error("options must be defined");return Object.assign(r,e)}function f2e(r,e){if(r.length!==e.length)return!1;let t=0;for(let n=0;n<r.length;n++)t|=r[n]^e[n];return t===0}const p2e=(r,e)=>{function t(n,...i){if(ai(n),r.nonceLength!==void 0){const d=i[0];if(!d)throw new Error("nonce / iv required");r.varSizeNonce?ai(d):ai(d,r.nonceLength)}const s=r.tagLength;s&&i[1]!==void 0&&ai(i[1]);const o=e(n,...i),a=(d,h)=>{if(h!==void 0){if(d!==2)throw new Error("cipher output not supported");ai(h)}};let c=!1;return{encrypt(d,h){if(c)throw new Error("cannot encrypt() twice with same key + nonce");return c=!0,ai(d),a(o.encrypt.length,h),o.encrypt(d,h)},decrypt(d,h){if(ai(d),s&&d.length<s)throw new Error("invalid ciphertext length: smaller than tagLength="+s);return a(o.decrypt.length,h),o.decrypt(d,h)}}}return Object.assign(t,r),t};function GR(r,e,t=!0){if(e===void 0)return new Uint8Array(r);if(e.length!==r)throw new Error("invalid output length, expected "+r+", got: "+e.length);if(t&&!g2e(e))throw new Error("invalid output, must be aligned");return e}function QR(r,e,t,n){if(typeof r.setBigUint64=="function")return r.setBigUint64(e,t,n);const i=BigInt(32),s=BigInt(4294967295),o=Number(t>>i&s),a=Number(t&s),c=4,l=0;r.setUint32(e+c,o,n),r.setUint32(e+l,a,n)}function g2e(r){return r.byteOffset%4===0}function _9(r){return Uint8Array.from(r)}function Jd(...r){for(let e=0;e<r.length;e++)r[e].fill(0)}const YR=r=>Uint8Array.from(r.split("").map(e=>e.charCodeAt(0))),y2e=YR("expand 16-byte k"),m2e=YR("expand 32-byte k"),w2e=Sc(y2e),b2e=Sc(m2e);function it(r,e){return r<<e|r>>>32-e}function T9(r){return r.byteOffset%4===0}const Jm=64,v2e=16,JR=2**32-1,XR=new Uint32Array;function E2e(r,e,t,n,i,s,o,a){const c=i.length,l=new Uint8Array(Jm),d=Sc(l),h=T9(i)&&T9(s),p=h?Sc(i):XR,m=h?Sc(s):XR;for(let f=0;f<c;o++){if(r(e,t,n,d,o,a),o>=JR)throw new Error("arx: counter overflow");const g=Math.min(Jm,c-f);if(h&&g===Jm){const w=f/4;if(f%4!==0)throw new Error("arx: invalid block position");for(let y=0,b;y<v2e;y++)b=w+y,m[b]=p[b]^d[y];f+=Jm;continue}for(let w=0,y;w<g;w++)y=f+w,s[y]=i[y]^l[w];f+=g}}function S2e(r,e){const{allowShortKeys:t,extendNonceFn:n,counterLength:i,counterRight:s,rounds:o}=h2e({allowShortKeys:!1,counterLength:8,counterRight:!1,rounds:20},e);if(typeof r!="function")throw new Error("core must be a function");return I9(i),I9(o),WR(s),WR(t),(a,c,l,d,h=0)=>{ai(a),ai(c),ai(l);const p=l.length;if(d===void 0&&(d=new Uint8Array(p)),ai(d),I9(h),h<0||h>=JR)throw new Error("arx: counter overflow");if(d.length<p)throw new Error(`arx: output (${d.length}) is shorter than data (${p})`);const m=[];let f=a.length,g,w;if(f===32)m.push(g=_9(a)),w=b2e;else if(f===16&&t)g=new Uint8Array(32),g.set(a),g.set(a,16),w=w2e,m.push(g);else throw new Error(`arx: invalid 32-byte key, got length=${f}`);T9(c)||m.push(c=_9(c));const y=Sc(g);if(n){if(c.length!==24)throw new Error("arx: extended nonce must be 24 bytes");n(w,y,Sc(c.subarray(0,16)),y),c=c.subarray(16)}const b=16-i;if(b!==c.length)throw new Error(`arx: nonce must be ${b} or 16 bytes`);if(b!==12){const E=new Uint8Array(12);E.set(c,s?0:12-c.length),c=E,m.push(c)}const v=Sc(c);return E2e(r,w,y,v,l,d,h,o),Jd(...m),d}}const xr=(r,e)=>r[e++]&255|(r[e++]&255)<<8;class x2e{constructor(e){this.blockLen=16,this.outputLen=16,this.buffer=new Uint8Array(16),this.r=new Uint16Array(10),this.h=new Uint16Array(10),this.pad=new Uint16Array(8),this.pos=0,this.finished=!1,e=k9(e),ai(e,32);const t=xr(e,0),n=xr(e,2),i=xr(e,4),s=xr(e,6),o=xr(e,8),a=xr(e,10),c=xr(e,12),l=xr(e,14);this.r[0]=t&8191,this.r[1]=(t>>>13|n<<3)&8191,this.r[2]=(n>>>10|i<<6)&7939,this.r[3]=(i>>>7|s<<9)&8191,this.r[4]=(s>>>4|o<<12)&255,this.r[5]=o>>>1&8190,this.r[6]=(o>>>14|a<<2)&8191,this.r[7]=(a>>>11|c<<5)&8065,this.r[8]=(c>>>8|l<<8)&8191,this.r[9]=l>>>5&127;for(let d=0;d<8;d++)this.pad[d]=xr(e,16+2*d)}process(e,t,n=!1){const i=n?0:2048,{h:s,r:o}=this,a=o[0],c=o[1],l=o[2],d=o[3],h=o[4],p=o[5],m=o[6],f=o[7],g=o[8],w=o[9],y=xr(e,t+0),b=xr(e,t+2),v=xr(e,t+4),E=xr(e,t+6),C=xr(e,t+8),k=xr(e,t+10),x=xr(e,t+12),I=xr(e,t+14);let T=s[0]+(y&8191),L=s[1]+((y>>>13|b<<3)&8191),z=s[2]+((b>>>10|v<<6)&8191),B=s[3]+((v>>>7|E<<9)&8191),G=s[4]+((E>>>4|C<<12)&8191),K=s[5]+(C>>>1&8191),q=s[6]+((C>>>14|k<<2)&8191),Q=s[7]+((k>>>11|x<<5)&8191),j=s[8]+((x>>>8|I<<8)&8191),O=s[9]+(I>>>5|i),U=0,W=U+T*a+L*(5*w)+z*(5*g)+B*(5*f)+G*(5*m);U=W>>>13,W&=8191,W+=K*(5*p)+q*(5*h)+Q*(5*d)+j*(5*l)+O*(5*c),U+=W>>>13,W&=8191;let Y=U+T*c+L*a+z*(5*w)+B*(5*g)+G*(5*f);U=Y>>>13,Y&=8191,Y+=K*(5*m)+q*(5*p)+Q*(5*h)+j*(5*d)+O*(5*l),U+=Y>>>13,Y&=8191;let H=U+T*l+L*c+z*a+B*(5*w)+G*(5*g);U=H>>>13,H&=8191,H+=K*(5*f)+q*(5*m)+Q*(5*p)+j*(5*h)+O*(5*d),U+=H>>>13,H&=8191;let oe=U+T*d+L*l+z*c+B*a+G*(5*w);U=oe>>>13,oe&=8191,oe+=K*(5*g)+q*(5*f)+Q*(5*m)+j*(5*p)+O*(5*h),U+=oe>>>13,oe&=8191;let ye=U+T*h+L*d+z*l+B*c+G*a;U=ye>>>13,ye&=8191,ye+=K*(5*w)+q*(5*g)+Q*(5*f)+j*(5*m)+O*(5*p),U+=ye>>>13,ye&=8191;let de=U+T*p+L*h+z*d+B*l+G*c;U=de>>>13,de&=8191,de+=K*a+q*(5*w)+Q*(5*g)+j*(5*f)+O*(5*m),U+=de>>>13,de&=8191;let le=U+T*m+L*p+z*h+B*d+G*l;U=le>>>13,le&=8191,le+=K*c+q*a+Q*(5*w)+j*(5*g)+O*(5*f),U+=le>>>13,le&=8191;let $e=U+T*f+L*m+z*p+B*h+G*d;U=$e>>>13,$e&=8191,$e+=K*l+q*c+Q*a+j*(5*w)+O*(5*g),U+=$e>>>13,$e&=8191;let Ne=U+T*g+L*f+z*m+B*p+G*h;U=Ne>>>13,Ne&=8191,Ne+=K*d+q*l+Q*c+j*a+O*(5*w),U+=Ne>>>13,Ne&=8191;let Ie=U+T*w+L*g+z*f+B*m+G*p;U=Ie>>>13,Ie&=8191,Ie+=K*h+q*d+Q*l+j*c+O*a,U+=Ie>>>13,Ie&=8191,U=(U<<2)+U|0,U=U+W|0,W=U&8191,U=U>>>13,Y+=U,s[0]=W,s[1]=Y,s[2]=H,s[3]=oe,s[4]=ye,s[5]=de,s[6]=le,s[7]=$e,s[8]=Ne,s[9]=Ie}finalize(){const{h:e,pad:t}=this,n=new Uint16Array(10);let i=e[1]>>>13;e[1]&=8191;for(let a=2;a<10;a++)e[a]+=i,i=e[a]>>>13,e[a]&=8191;e[0]+=i*5,i=e[0]>>>13,e[0]&=8191,e[1]+=i,i=e[1]>>>13,e[1]&=8191,e[2]+=i,n[0]=e[0]+5,i=n[0]>>>13,n[0]&=8191;for(let a=1;a<10;a++)n[a]=e[a]+i,i=n[a]>>>13,n[a]&=8191;n[9]-=8192;let s=(i^1)-1;for(let a=0;a<10;a++)n[a]&=s;s=~s;for(let a=0;a<10;a++)e[a]=e[a]&s|n[a];e[0]=(e[0]|e[1]<<13)&65535,e[1]=(e[1]>>>3|e[2]<<10)&65535,e[2]=(e[2]>>>6|e[3]<<7)&65535,e[3]=(e[3]>>>9|e[4]<<4)&65535,e[4]=(e[4]>>>12|e[5]<<1|e[6]<<14)&65535,e[5]=(e[6]>>>2|e[7]<<11)&65535,e[6]=(e[7]>>>5|e[8]<<8)&65535,e[7]=(e[8]>>>8|e[9]<<5)&65535;let o=e[0]+t[0];e[0]=o&65535;for(let a=1;a<8;a++)o=(e[a]+t[a]|0)+(o>>>16)|0,e[a]=o&65535;Jd(n)}update(e){qR(this);const{buffer:t,blockLen:n}=this;e=k9(e);const i=e.length;for(let s=0;s<i;){const o=Math.min(n-this.pos,i-s);if(o===n){for(;n<=i-s;s+=n)this.process(e,s);continue}t.set(e.subarray(s,s+o),this.pos),this.pos+=o,s+=o,this.pos===n&&(this.process(t,0,!1),this.pos=0)}return this}destroy(){Jd(this.h,this.r,this.buffer,this.pad)}digestInto(e){qR(this),l2e(e,this),this.finished=!0;const{buffer:t,h:n}=this;let{pos:i}=this;if(i){for(t[i++]=1;i<16;i++)t[i]=0;this.process(t,0,!0)}this.finalize();let s=0;for(let o=0;o<8;o++)e[s++]=n[o]>>>0,e[s++]=n[o]>>>8;return e}digest(){const{buffer:e,outputLen:t}=this;this.digestInto(e);const n=e.slice(0,t);return this.destroy(),n}}function A2e(r){const e=(n,i)=>r(i).update(k9(n)).digest(),t=r(new Uint8Array(32));return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=n=>r(n),e}const C2e=A2e(r=>new x2e(r));function I2e(r,e,t,n,i,s=20){let o=r[0],a=r[1],c=r[2],l=r[3],d=e[0],h=e[1],p=e[2],m=e[3],f=e[4],g=e[5],w=e[6],y=e[7],b=i,v=t[0],E=t[1],C=t[2],k=o,x=a,I=c,T=l,L=d,z=h,B=p,G=m,K=f,q=g,Q=w,j=y,O=b,U=v,W=E,Y=C;for(let oe=0;oe<s;oe+=2)k=k+L|0,O=it(O^k,16),K=K+O|0,L=it(L^K,12),k=k+L|0,O=it(O^k,8),K=K+O|0,L=it(L^K,7),x=x+z|0,U=it(U^x,16),q=q+U|0,z=it(z^q,12),x=x+z|0,U=it(U^x,8),q=q+U|0,z=it(z^q,7),I=I+B|0,W=it(W^I,16),Q=Q+W|0,B=it(B^Q,12),I=I+B|0,W=it(W^I,8),Q=Q+W|0,B=it(B^Q,7),T=T+G|0,Y=it(Y^T,16),j=j+Y|0,G=it(G^j,12),T=T+G|0,Y=it(Y^T,8),j=j+Y|0,G=it(G^j,7),k=k+z|0,Y=it(Y^k,16),Q=Q+Y|0,z=it(z^Q,12),k=k+z|0,Y=it(Y^k,8),Q=Q+Y|0,z=it(z^Q,7),x=x+B|0,O=it(O^x,16),j=j+O|0,B=it(B^j,12),x=x+B|0,O=it(O^x,8),j=j+O|0,B=it(B^j,7),I=I+G|0,U=it(U^I,16),K=K+U|0,G=it(G^K,12),I=I+G|0,U=it(U^I,8),K=K+U|0,G=it(G^K,7),T=T+L|0,W=it(W^T,16),q=q+W|0,L=it(L^q,12),T=T+L|0,W=it(W^T,8),q=q+W|0,L=it(L^q,7);let H=0;n[H++]=o+k|0,n[H++]=a+x|0,n[H++]=c+I|0,n[H++]=l+T|0,n[H++]=d+L|0,n[H++]=h+z|0,n[H++]=p+B|0,n[H++]=m+G|0,n[H++]=f+K|0,n[H++]=g+q|0,n[H++]=w+Q|0,n[H++]=y+j|0,n[H++]=b+O|0,n[H++]=v+U|0,n[H++]=E+W|0,n[H++]=C+Y|0}const k2e=S2e(I2e,{counterRight:!1,counterLength:4,allowShortKeys:!1}),_2e=new Uint8Array(16),ZR=(r,e)=>{r.update(e);const t=e.length%16;t&&r.update(_2e.subarray(t))},T2e=new Uint8Array(32);function eL(r,e,t,n,i){const s=r(e,t,T2e),o=C2e.create(s);i&&ZR(o,i),ZR(o,n);const a=new Uint8Array(16),c=u2e(a);QR(c,0,BigInt(i?i.length:0),!0),QR(c,8,BigInt(n.length),!0),o.update(a);const l=o.digest();return Jd(s,a),l}const tL=p2e({blockSize:64,nonceLength:12,tagLength:16},(r=>(e,t,n)=>({encrypt(s,o){const a=s.length;o=GR(a+16,o,!1),o.set(s);const c=o.subarray(0,-16);r(e,t,c,c,1);const l=eL(r,e,t,c,n);return o.set(l,a),Jd(l),o},decrypt(s,o){o=GR(s.length-16,o,!1);const a=s.subarray(0,-16),c=s.subarray(-16),l=eL(r,e,t,a,n);if(!f2e(c,l))throw new Error("invalid tag");return o.set(s.subarray(0,-16)),r(e,t,o,o,1),Jd(l),o}}))(k2e));function P2e(r,e,t){return ay(r),t===void 0&&(t=new Uint8Array(r.outputLen)),ky(r,_1(t),_1(e))}const P9=Uint8Array.from([0]),rL=Uint8Array.of();function D2e(r,e,t,n=32){ay(r),$d(n);const i=r.outputLen;if(n>255*i)throw new Error("Length should be <= 255*HashLen");const s=Math.ceil(n/i);t===void 0&&(t=rL);const o=new Uint8Array(s*i),a=ky.create(r,e),c=a._cloneInto(),l=new Uint8Array(a.outputLen);for(let d=0;d<s;d++)P9[0]=d+1,c.update(d===0?rL:l).update(t).update(P9).digestInto(l),o.set(l,i*d),a._cloneInto(c);return a.destroy(),c.destroy(),Ms(l,P9),o.slice(0,n)}const $2e={hashSHA256(r){return Nl(r.subarray())},getHKDF(r,e){const t=P2e(Nl,e,r),i=D2e(Nl,t,void 0,96),s=i.subarray(0,32),o=i.subarray(32,64),a=i.subarray(64,96);return[s,o,a]},generateX25519KeyPair(){const r=ry.utils.randomPrivateKey();return{publicKey:ry.getPublicKey(r),privateKey:r}},generateX25519KeyPairFromSeed(r){return{publicKey:ry.getPublicKey(r),privateKey:r}},generateX25519SharedKey(r,e){return ry.getSharedSecret(r.subarray(),e.subarray())},chaCha20Poly1305Encrypt(r,e,t,n){return tL(n,e,t).encrypt(r.subarray())},chaCha20Poly1305Decrypt(r,e,t,n,i){return tL(n,e,t).decrypt(r.subarray(),i)}};function N2e(r){return{generateKeypair:r.generateX25519KeyPair,dh:(e,t)=>r.generateX25519SharedKey(e.privateKey,t).subarray(0,32),encrypt:r.chaCha20Poly1305Encrypt,decrypt:r.chaCha20Poly1305Decrypt,hash:r.hashSHA256,hkdf:r.getHKDF}}const Xm=r=>{const e=Cn(2);return e[0]=r>>8,e[1]=r,e};Xm.bytes=2;const Zm=r=>{if(r.length<2)throw RangeError("Could not decode int16BE");if(r instanceof Uint8Array){let e=0;return e+=r[0]<<8,e+=r[1],e}return r.getUint16(0)};Zm.bytes=2;function M2e(r){return{xxHandshakeSuccesses:r.registerCounter("libp2p_noise_xxhandshake_successes_total",{help:"Total count of noise xxHandshakes successes_"}),xxHandshakeErrors:r.registerCounter("libp2p_noise_xxhandshake_error_total",{help:"Total count of noise xxHandshakes errors"}),encryptedPackets:r.registerCounter("libp2p_noise_encrypted_packets_total",{help:"Total count of noise encrypted packets successfully"}),decryptedPackets:r.registerCounter("libp2p_noise_decrypted_packets_total",{help:"Total count of noise decrypted packets"}),decryptErrors:r.registerCounter("libp2p_noise_decrypt_errors_total",{help:"Total count of noise decrypt errors"})}}function nL(r,e){!e.enabled||!op||(r?(e(`LOCAL_STATIC_PUBLIC_KEY ${re(r.publicKey,"hex")}`),e(`LOCAL_STATIC_PRIVATE_KEY ${re(r.privateKey,"hex")}`)):e("Missing local static keys."))}function iL(r,e){!e.enabled||!op||(r?(e(`LOCAL_PUBLIC_EPHEMERAL_KEY ${re(r.publicKey,"hex")}`),e(`LOCAL_PRIVATE_EPHEMERAL_KEY ${re(r.privateKey,"hex")}`)):e("Missing local ephemeral keys."))}function O2e(r,e){!e.enabled||!op||e(r?`REMOTE_STATIC_PUBLIC_KEY ${re(r.subarray(),"hex")}`:"Missing remote static public key.")}function sL(r,e){!e.enabled||!op||e(r?`REMOTE_EPHEMERAL_PUBLIC_KEY ${re(r.subarray(),"hex")}`:"Missing remote ephemeral keys.")}function oL(r,e,t){!t.enabled||!op||(t(`CIPHER_STATE_1 ${r.n.getUint64()} ${r.k&&re(r.k,"hex")}`),t(`CIPHER_STATE_2 ${e.n.getUint64()} ${e.k&&re(e.k,"hex")}`))}function xc(r,e){if(r.length!==e.length)throw new Error("Inputs should have the same length");const t=Cn(r.length);for(let n=0;n<r.length;n++)t[n]=r[n]^e[n];return t}const M4=class M4 extends Error{constructor(t="Invalid crypto exchange"){super(t);u(this,"code");this.code=M4.code}};u(M4,"code","ERR_INVALID_CRYPTO_EXCHANGE");let ap=M4;const R2e=0,L2e=4294967295,B2e="Cipherstate has reached maximum n, a new handshake must be performed";class U2e{constructor(e=R2e){u(this,"n");u(this,"bytes");u(this,"view");this.n=e,this.bytes=We(12),this.view=new DataView(this.bytes.buffer,this.bytes.byteOffset,this.bytes.byteLength),this.view.setUint32(4,e,!0)}increment(){this.n++,this.view.setUint32(4,this.n,!0)}getBytes(){return this.bytes}getUint64(){return this.n}assertValue(){if(this.n>L2e)throw new Error(B2e)}}const Xd=We(0);class e3{constructor(e,t=void 0,n=0){u(this,"k");u(this,"n");u(this,"crypto");this.crypto=e,this.k=t,this.n=new U2e(n)}hasKey(){return!!this.k}encryptWithAd(e,t){if(!this.hasKey())return t;this.n.assertValue();const n=this.crypto.encrypt(t,this.n.getBytes(),e,this.k);return this.n.increment(),n}decryptWithAd(e,t,n){if(!this.hasKey())return t;this.n.assertValue();const i=this.crypto.decrypt(t,this.n.getBytes(),e,this.k,n);return this.n.increment(),i}}class F2e{constructor(e,t){u(this,"cs");u(this,"ck");u(this,"h");u(this,"crypto");this.crypto=e;const n=ie(t,"utf-8");this.h=V2e(e,n),this.ck=this.h,this.cs=new e3(e)}mixKey(e){const[t,n]=this.crypto.hkdf(this.ck,e);this.ck=t,this.cs=new e3(this.crypto,n)}mixHash(e){this.h=this.crypto.hash(new Le(this.h,e))}encryptAndHash(e){const t=this.cs.encryptWithAd(this.h,e);return this.mixHash(t),t}decryptAndHash(e){const t=this.cs.decryptWithAd(this.h,e);return this.mixHash(e),t}split(){const[e,t]=this.crypto.hkdf(this.ck,Xd);return[new e3(this.crypto,e),new e3(this.crypto,t)]}}class z2e{constructor(e){u(this,"ss");u(this,"s");u(this,"e");u(this,"rs");u(this,"re");u(this,"initiator");u(this,"crypto");const{crypto:t,protocolName:n,prologue:i,initiator:s,s:o,e:a,rs:c,re:l}=e;this.crypto=t,this.ss=new F2e(t,n),this.ss.mixHash(i),this.initiator=s,this.s=o,this.e=a,this.rs=c,this.re=l}writeE(){if(this.e)throw new Error("ephemeral keypair is already set");const e=this.crypto.generateKeypair();return this.ss.mixHash(e.publicKey),this.e=e,e.publicKey}writeS(){if(!this.s)throw new Error("static keypair is not set");return this.ss.encryptAndHash(this.s.publicKey)}writeEE(){if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.re))}writeES(){if(this.initiator){if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.rs)throw new Error("remote static public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.rs))}else{if(!this.s)throw new Error("static keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.s,this.re))}}writeSE(){if(this.initiator){if(!this.s)throw new Error("static keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.s,this.re))}else{if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.rs)throw new Error("remote static public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.rs))}}readE(e,t=0){if(this.re)throw new Error("remote ephemeral public key is already set");if(e.byteLength<t+32)throw new Error("message is not long enough");this.re=e.sublist(t,t+32),this.ss.mixHash(this.re)}readS(e,t=0){if(this.rs)throw new Error("remote static public key is already set");const n=32+(this.ss.cs.hasKey()?16:0);if(e.byteLength<t+n)throw new Error("message is not long enough");const i=e.sublist(t,t+n);return this.rs=this.ss.decryptAndHash(i),n}readEE(){this.writeEE()}readES(){this.writeES()}readSE(){this.writeSE()}}class aL extends z2e{writeMessageA(e){return new Le(this.writeE(),this.ss.encryptAndHash(e))}writeMessageB(e){const t=this.writeE();this.writeEE();const n=this.writeS();return this.writeES(),new Le(t,n,this.ss.encryptAndHash(e))}writeMessageC(e){const t=this.writeS();return this.writeSE(),new Le(t,this.ss.encryptAndHash(e))}readMessageA(e){try{return this.readE(e),this.ss.decryptAndHash(e.sublist(32))}catch(t){throw new ap(`handshake stage 0 validation fail: ${t.message}`)}}readMessageB(e){try{this.readE(e),this.readEE();const t=this.readS(e,32);return this.readES(),this.ss.decryptAndHash(e.sublist(32+t))}catch(t){throw new ap(`handshake stage 1 validation fail: ${t.message}`)}}readMessageC(e){try{const t=this.readS(e);return this.readSE(),this.ss.decryptAndHash(e.sublist(t))}catch(t){throw new ap(`handshake stage 2 validation fail: ${t.message}`)}}}function V2e(r,e){if(e.length<=32){const t=We(32);return t.set(e),t}else return r.hash(e)}var t3;(function(r){let e;r.codec=()=>(e==null&&(e=De((t,n,i={})=>{if(i.lengthDelimited!==!1&&n.fork(),t.webtransportCerthashes!=null)for(const s of t.webtransportCerthashes)n.uint32(10),n.bytes(s);if(t.streamMuxers!=null)for(const s of t.streamMuxers)n.uint32(18),n.string(s);i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{var a,c;const s={webtransportCerthashes:[],streamMuxers:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{if(((a=i.limits)==null?void 0:a.webtransportCerthashes)!=null&&s.webtransportCerthashes.length===i.limits.webtransportCerthashes)throw new yt('Decode error - map field "webtransportCerthashes" had too many elements');s.webtransportCerthashes.push(t.bytes());break}case 2:{if(((c=i.limits)==null?void 0:c.streamMuxers)!=null&&s.streamMuxers.length===i.limits.streamMuxers)throw new yt('Decode error - map field "streamMuxers" had too many elements');s.streamMuxers.push(t.string());break}default:{t.skipType(l&7);break}}}return s})),e),r.encode=t=>Pe(t,r.codec()),r.decode=(t,n)=>Te(t,r.codec(),n)})(t3||(t3={}));var r3;(function(r){let e;r.codec=()=>(e==null&&(e=De((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.identityKey!=null&&t.identityKey.byteLength>0&&(n.uint32(10),n.bytes(t.identityKey)),t.identitySig!=null&&t.identitySig.byteLength>0&&(n.uint32(18),n.bytes(t.identitySig)),t.extensions!=null&&(n.uint32(34),t3.codec().encode(t.extensions,n)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{var a;const s={identityKey:We(0),identitySig:We(0)},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const c=t.uint32();switch(c>>>3){case 1:{s.identityKey=t.bytes();break}case 2:{s.identitySig=t.bytes();break}case 4:{s.extensions=t3.codec().decode(t,t.uint32(),{limits:(a=i.limits)==null?void 0:a.extensions});break}default:{t.skipType(c&7);break}}}return s})),e),r.encode=t=>Pe(t,r.codec()),r.decode=(t,n)=>Te(t,r.codec(),n)})(r3||(r3={}));async function cL(r,e,t){const n=await r.sign(uL(e));return r3.encode({identityKey:ki(r.publicKey),identitySig:n,extensions:t})}async function lL(r,e,t){try{const n=r3.decode(r),i=kn(n.identityKey);if((t==null?void 0:t.equals(i))===!1)throw new Error(`Payload identity key ${i} does not match expected remote identity key ${t}`);if(!e)throw new Error("Remote static does not exist");const s=uL(e);if(!await i.verify(s,n.identitySig))throw new Error("Invalid payload signature");return n}catch(n){throw new iP(n.message)}}function uL(r){const e=ie("noise-libp2p-static-key:");return r instanceof Uint8Array?sr([e,r],e.length+r.length):(r.prepend(e),r)}async function K2e(r,e){const{log:t,connection:n,crypto:i,privateKey:s,prologue:o,s:a,remoteIdentityKey:c,extensions:l}=r,d=await cL(s,a.publicKey,l),h=new aL({crypto:i,protocolName:"Noise_XX_25519_ChaChaPoly_SHA256",initiator:!0,prologue:o,s:a});nL(h.s,t),t.trace("Stage 0 - Initiator starting to send first message."),await n.write(h.writeMessageA(Xd),e),t.trace("Stage 0 - Initiator finished sending first message."),iL(h.e,t),t.trace("Stage 1 - Initiator waiting to receive first message from responder...");const p=h.readMessageB(await n.read(e));t.trace("Stage 1 - Initiator received the message."),sL(h.re,t),O2e(h.rs,t),t.trace("Initiator going to check remote's signature...");const m=await lL(p,h.rs,c);t.trace("All good with the signature!"),t.trace("Stage 2 - Initiator sending third handshake message."),await n.write(h.writeMessageC(d),e),t.trace("Stage 2 - Initiator sent message with signed payload.");const[f,g]=h.ss.split();return oL(f,g,t),{payload:m,encrypt:w=>f.encryptWithAd(Xd,w),decrypt:(w,y)=>g.decryptWithAd(Xd,w,y)}}async function j2e(r,e){const{log:t,connection:n,crypto:i,privateKey:s,prologue:o,s:a,remoteIdentityKey:c,extensions:l}=r,d=await cL(s,a.publicKey,l),h=new aL({crypto:i,protocolName:"Noise_XX_25519_ChaChaPoly_SHA256",initiator:!1,prologue:o,s:a});nL(h.s,t),t.trace("Stage 0 - Responder waiting to receive first message."),h.readMessageA(await n.read(e)),t.trace("Stage 0 - Responder received first message."),sL(h.re,t),t.trace("Stage 1 - Responder sending out first message with signed payload and static key."),await n.write(h.writeMessageB(d),e),t.trace("Stage 1 - Responder sent the second handshake message with signed payload."),iL(h.e,t),t.trace("Stage 2 - Responder waiting for third handshake message...");const p=h.readMessageC(await n.read(e));t.trace("Stage 2 - Responder received the message, finished handshake.");const m=await lL(p,h.rs,c),[f,g]=h.ss.split();return oL(f,g,t),{payload:m,encrypt:w=>g.encryptWithAd(Xd,w),decrypt:(w,y)=>f.decryptWithAd(Xd,w,y)}}const dL=16;function H2e(r,e){return async function*(t){for await(const n of t)for(let i=0;i<n.length;i+=jR){let s=i+jR;s>n.length&&(s=n.length);let o;n instanceof Uint8Array?o=r.encrypt(n.subarray(i,s)):o=r.encrypt(n.sublist(i,s)),e==null||e.encryptedPackets.increment(),yield new Le(Xm(o.byteLength),o)}}}function q2e(r,e){return async function*(t){for await(const n of t)for(let i=0;i<n.length;i+=sp){let s=i+sp;if(s>n.length&&(s=n.length),s-dL<i)throw new Error("Invalid chunk");const o=n.sublist(i,s),a=n.subarray(i,s-dL);try{const c=r.decrypt(o,a);e==null||e.decryptedPackets.increment(),yield c}catch(c){throw e==null||e.decryptErrors.increment(),c}}}}zj=Symbol.toStringTag,Fj=ur;class W2e{constructor(e,t={}){u(this,"protocol","/noise");u(this,"crypto");u(this,"prologue");u(this,"staticKey");u(this,"extensions");u(this,"metrics");u(this,"components");u(this,zj,"@chainsafe/libp2p-noise");u(this,Fj,["@libp2p/connection-encryption","@chainsafe/libp2p-noise"]);const{staticNoiseKey:n,extensions:i,crypto:s,prologueBytes:o}=t,{metrics:a}=e;this.components=e;const c=s??$2e;this.crypto=N2e(c),this.extensions={webtransportCerthashes:[],...i},this.metrics=a?M2e(a):void 0,n?this.staticKey=c.generateX25519KeyPairFromSeed(n):this.staticKey=c.generateX25519KeyPair(),this.prologue=o??We(0)}async secureOutbound(e,t){var a,c;const n=Yd(e,{lengthEncoder:Xm,lengthDecoder:Zm,maxDataLength:sp}),i=await this.performHandshakeInitiator(n,this.components.privateKey,(a=t==null?void 0:t.remotePeer)==null?void 0:a.publicKey,t),s=await this.createSecureConnection(n,i);e.source=s.source,e.sink=s.sink;const o=kn(i.payload.identityKey);return{conn:e,remoteExtensions:i.payload.extensions,remotePeer:Bd(o),streamMuxer:this.getStreamMuxer((c=i.payload.extensions)==null?void 0:c.streamMuxers)}}getStreamMuxer(e){if(e==null)return;const t=this.components.upgrader.getStreamMuxers();if(t!=null)for(const n of e){const i=t.get(n);if(i!=null)return i}if(e.length)throw new DZ("Early muxer negotiation was requested but the initiator and responder had no common muxers")}async secureInbound(e,t){var a,c;const n=Yd(e,{lengthEncoder:Xm,lengthDecoder:Zm,maxDataLength:sp}),i=await this.performHandshakeResponder(n,this.components.privateKey,(a=t==null?void 0:t.remotePeer)==null?void 0:a.publicKey,t),s=await this.createSecureConnection(n,i);e.source=s.source,e.sink=s.sink;const o=kn(i.payload.identityKey);return{conn:e,remoteExtensions:i.payload.extensions,remotePeer:Bd(o),streamMuxer:this.getStreamMuxer((c=i.payload.extensions)==null?void 0:c.streamMuxers)}}async performHandshakeInitiator(e,t,n,i){var o,a;let s;try{s=await K2e({connection:e,privateKey:t,remoteIdentityKey:n,log:this.components.logger.forComponent("libp2p:noise:xxhandshake"),crypto:this.crypto,prologue:this.prologue,s:this.staticKey,extensions:{streamMuxers:[...this.components.upgrader.getStreamMuxers().keys()],webtransportCerthashes:[],...this.extensions}},i),(o=this.metrics)==null||o.xxHandshakeSuccesses.increment()}catch(c){throw(a=this.metrics)==null||a.xxHandshakeErrors.increment(),c}return s}async performHandshakeResponder(e,t,n,i){var o,a;let s;try{s=await j2e({connection:e,privateKey:t,remoteIdentityKey:n,log:this.components.logger.forComponent("libp2p:noise:xxhandshake"),crypto:this.crypto,prologue:this.prologue,s:this.staticKey,extensions:{streamMuxers:[...this.components.upgrader.getStreamMuxers().keys()],webtransportCerthashes:[],...this.extensions}},i),(o=this.metrics)==null||o.xxHandshakeSuccesses.increment()}catch(c){throw(a=this.metrics)==null||a.xxHandshakeErrors.increment(),c}return s}async createSecureConnection(e,t){const[n,i]=c2e(),s=e.unwrap();return await cn(n,H2e(t,this.metrics),s,o=>Rd(o,{lengthDecoder:Zm}),q2e(t,this.metrics),n),i}}function hL(r={}){return e=>new W2e(e,r)}function fL(r){if(r!=null){if(typeof r[Symbol.iterator]=="function")return r[Symbol.iterator]();if(typeof r[Symbol.asyncIterator]=="function")return r[Symbol.asyncIterator]();if(typeof r.next=="function")return r}throw new Error("argument is not an iterator or iterable")}class Hl extends Error{constructor(e="The frame was invalid"){super(e),this.name="InvalidFrameError"}}u(Hl,"name","InvalidFrameError");class D9 extends Error{constructor(e="Unrequested ping error"){super(e),this.name="UnrequestedPingError"}}u(D9,"name","UnrequestedPingError");class $9 extends Error{constructor(e="Unrequested ping error"){super(e),this.name="NotMatchingPingError"}}u($9,"name","NotMatchingPingError");class pL extends Error{constructor(e="Invalid state"){super(e),this.name="InvalidStateError"}}u(pL,"name","InvalidStateError");class gL extends Error{constructor(e="Strean already exists"){super(e),this.name="StreamAlreadyExistsError"}}u(gL,"name","StreamAlreadyExistsError");class yL extends Error{constructor(e="Decode invalid version"){super(e),this.name="DecodeInvalidVersionError"}}u(yL,"name","DecodeInvalidVersionError");class mL extends Error{constructor(e="Both clients"){super(e),this.name="BothClientsError"}}u(mL,"name","BothClientsError");class N9 extends Error{constructor(e="Receive window exceeded"){super(e),this.name="ReceiveWindowExceededError"}}u(N9,"name","ReceiveWindowExceededError");const G2e=new Set([Hl.name,D9.name,$9.name,gL.name,yL.name,mL.name,N9.name]),M9=256*1024,Q2e=16*1024*1024,Y2e={enableKeepAlive:!0,keepAliveInterval:3e4,maxInboundStreams:1e3,maxOutboundStreams:1e3,initialStreamWindowSize:M9,maxStreamWindowSize:Q2e,maxMessageSize:64*1024};function J2e(r){if(r.keepAliveInterval<=0)throw new Z("keep-alive interval must be positive");if(r.maxInboundStreams<0)throw new Z("max inbound streams must be larger or equal 0");if(r.maxOutboundStreams<0)throw new Z("max outbound streams must be larger or equal 0");if(r.initialStreamWindowSize<M9)throw new Z("InitialStreamWindowSize must be larger or equal 256 kB");if(r.maxStreamWindowSize<r.initialStreamWindowSize)throw new Z("MaxStreamWindowSize must be larger than the InitialStreamWindowSize");if(r.maxStreamWindowSize>2**32-1)throw new Z("MaxStreamWindowSize must be less than equal MAX_UINT32");if(r.maxMessageSize<1024)throw new Z("MaxMessageSize must be greater than a kilobyte")}var or;(function(r){r[r.Data=0]="Data",r[r.WindowUpdate=1]="WindowUpdate",r[r.Ping=2]="Ping",r[r.GoAway=3]="GoAway"})(or||(or={}));var qt;(function(r){r[r.SYN=1]="SYN",r[r.ACK=2]="ACK",r[r.FIN=4]="FIN",r[r.RST=8]="RST"})(qt||(qt={})),Object.values(qt).filter(r=>typeof r!="string");const X2e=0;var zs;(function(r){r[r.NormalTermination=0]="NormalTermination",r[r.ProtocolError=1]="ProtocolError",r[r.InternalError=2]="InternalError"})(zs||(zs={}));const cp=12,wL=2**24;function Z2e(r){if(r[0]!==X2e)throw new Hl("Invalid frame version");return{type:r[1],flag:(r[2]<<8)+r[3],streamID:r[4]*wL+(r[5]<<16)+(r[6]<<8)+r[7],length:r[8]*wL+(r[9]<<16)+(r[10]<<8)+r[11]}}let eye=class{constructor(e){u(this,"source");u(this,"buffer");u(this,"frameInProgress");this.source=tye(e),this.buffer=new Le,this.frameInProgress=!1}async*emitFrames(){for await(const e of this.source)for(this.buffer.append(e);;){const t=this.readHeader();if(t===void 0)break;const{type:n,length:i}=t;n===or.Data?(this.frameInProgress=!0,yield{header:t,readData:this.readBytes.bind(this,i)}):yield{header:t}}}readHeader(){if(this.frameInProgress)throw new pL("decoding frame already in progress");if(this.buffer.length<cp)return;const e=Z2e(this.buffer.subarray(0,cp));return this.buffer.consume(cp),e}async readBytes(e){if(this.buffer.length<e){for await(const n of this.source)if(this.buffer.append(n),this.buffer.length>=e)break}const t=this.buffer.sublist(0,e);return this.buffer.consume(e),this.frameInProgress=!1,t}};function tye(r){if(r[Symbol.iterator]!==void 0){const e=r[Symbol.iterator]();return e.return=void 0,{[Symbol.iterator](){return e}}}else if(r[Symbol.asyncIterator]!==void 0){const e=r[Symbol.asyncIterator]();return e.return=void 0,{[Symbol.asyncIterator](){return e}}}else throw new Error("a source must be either an iterable or an async iterable")}function bL(r){const e=new Uint8Array(cp);return e[1]=r.type,e[2]=r.flag>>>8,e[3]=r.flag,e[4]=r.streamID>>>24,e[5]=r.streamID>>>16,e[6]=r.streamID>>>8,e[7]=r.streamID,e[8]=r.length>>>24,e[9]=r.length>>>16,e[10]=r.length>>>8,e[11]=r.length,e}function rye(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}function vL(r,e){var n,i;const t=(i=(n=fL(r)).return)==null?void 0:i.call(n);rye(t)&&t.catch(s=>{e.error("could not cause iterator to return",s)})}const nye=5e3;function O9(r){return r==null?!1:typeof r.then=="function"&&typeof r.catch=="function"&&typeof r.finally=="function"}class R9{constructor(e){u(this,"id");u(this,"direction");u(this,"timeline");u(this,"protocol");u(this,"metadata");u(this,"source");u(this,"status");u(this,"readStatus");u(this,"writeStatus");u(this,"log");u(this,"sinkController");u(this,"sinkEnd");u(this,"closed");u(this,"endErr");u(this,"streamSource");u(this,"onEnd");u(this,"onCloseRead");u(this,"onCloseWrite");u(this,"onReset");u(this,"onAbort");u(this,"sendCloseWriteTimeout");u(this,"sendingData");this.sinkController=new AbortController,this.sinkEnd=Re(),this.closed=Re(),this.log=e.log,this.status="open",this.readStatus="ready",this.writeStatus="ready",this.id=e.id,this.metadata=e.metadata??{},this.direction=e.direction,this.timeline={open:Date.now()},this.sendCloseWriteTimeout=e.sendCloseWriteTimeout??nye,this.onEnd=e.onEnd,this.onCloseRead=e==null?void 0:e.onCloseRead,this.onCloseWrite=e==null?void 0:e.onCloseWrite,this.onReset=e==null?void 0:e.onReset,this.onAbort=e==null?void 0:e.onAbort,this.source=this.streamSource=ho({onEnd:t=>{t!=null?this.log.trace("source ended with error",t):this.log.trace("source ended"),this.onSourceEnd(t)}}),this.sink=this.sink.bind(this)}async sink(e){if(this.writeStatus!=="ready")throw new D2(`writable end state is "${this.writeStatus}" not "ready"`);try{this.writeStatus="writing";const t={signal:this.sinkController.signal};if(this.direction==="outbound"){const i=this.sendNewStream(t);O9(i)&&await i}const n=()=>{vL(e,this.log)};try{this.sinkController.signal.addEventListener("abort",n),this.log.trace("sink reading from source");for await(let i of e){i=i instanceof Uint8Array?new Le(i):i;const s=this.sendData(i,t);O9(s)&&(this.sendingData=Re(),await s,this.sendingData.resolve(),this.sendingData=void 0)}}finally{this.sinkController.signal.removeEventListener("abort",n)}this.log.trace('sink finished reading from source, write status is "%s"',this.writeStatus),this.writeStatus==="writing"&&(this.writeStatus="closing",this.log.trace("send close write to remote"),await this.sendCloseWrite({signal:AbortSignal.timeout(this.sendCloseWriteTimeout)}),this.writeStatus="closed"),this.onSinkEnd()}catch(t){throw this.log.trace("sink ended with error, calling abort with error",t),this.abort(t),t}finally{this.log.trace("resolve sink end"),this.sinkEnd.resolve()}}onSourceEnd(e){var t;this.timeline.closeRead==null&&(this.timeline.closeRead=Date.now(),this.readStatus="closed",e!=null&&this.endErr==null&&(this.endErr=e),(t=this.onCloseRead)==null||t.call(this),this.timeline.closeWrite!=null?(this.log.trace("source and sink ended"),this.timeline.close=Date.now(),this.status!=="aborted"&&this.status!=="reset"&&(this.status="closed"),this.onEnd!=null&&this.onEnd(this.endErr),this.closed.resolve()):this.log.trace("source ended, waiting for sink to end"))}onSinkEnd(e){var t;this.timeline.closeWrite==null&&(this.timeline.closeWrite=Date.now(),this.writeStatus="closed",e!=null&&this.endErr==null&&(this.endErr=e),(t=this.onCloseWrite)==null||t.call(this),this.timeline.closeRead!=null?(this.log.trace("sink and source ended"),this.timeline.close=Date.now(),this.status!=="aborted"&&this.status!=="reset"&&(this.status="closed"),this.onEnd!=null&&this.onEnd(this.endErr),this.closed.resolve()):this.log.trace("sink ended, waiting for source to end"))}async close(e){this.status==="open"&&(this.log.trace("closing gracefully"),this.status="closing",await an(Promise.all([this.closeWrite(e),this.closeRead(e),this.closed.promise]),e==null?void 0:e.signal),this.status="closed",this.log.trace("closed gracefully"))}async closeRead(e={}){if(this.readStatus==="closing"||this.readStatus==="closed")return;this.log.trace('closing readable end of stream with starting read status "%s"',this.readStatus);const t=this.readStatus;this.readStatus="closing",this.status!=="reset"&&this.status!=="aborted"&&this.timeline.closeRead==null&&(this.log.trace("send close read to remote"),await this.sendCloseRead(e)),t==="ready"&&(this.log.trace("ending internal source queue with %d queued bytes",this.streamSource.readableLength),this.streamSource.end()),this.log.trace("closed readable end of stream")}async closeWrite(e={}){this.writeStatus==="closing"||this.writeStatus==="closed"||(this.log.trace('closing writable end of stream with starting write status "%s"',this.writeStatus),this.writeStatus==="ready"&&(this.log.trace("sink was never sunk, sink an empty array"),await an(this.sink([]),e.signal)),this.writeStatus==="writing"&&(this.sendingData!=null&&await an(this.sendingData.promise,e.signal),this.log.trace("aborting source passed to .sink"),this.sinkController.abort(),await an(this.sinkEnd.promise,e.signal)),this.writeStatus="closed",this.log.trace("closed writable end of stream"))}abort(e){var n;if(this.status==="closed"||this.status==="aborted"||this.status==="reset")return;this.log("abort with error",e),this.log("try to send reset to remote");const t=this.sendReset();O9(t)&&t.catch(i=>{this.log.error("error sending reset message",i)}),this.status="aborted",this.timeline.abort=Date.now(),this._closeSinkAndSource(e),(n=this.onAbort)==null||n.call(this,e)}reset(){var t;if(this.status==="closed"||this.status==="aborted"||this.status==="reset")return;const e=new oP("stream reset");this.status="reset",this.timeline.reset=Date.now(),this._closeSinkAndSource(e),(t=this.onReset)==null||t.call(this)}_closeSinkAndSource(e){this._closeSink(e),this._closeSource(e)}_closeSink(e){this.writeStatus==="writing"&&(this.log.trace("end sink source"),this.sinkController.abort()),this.onSinkEnd(e)}_closeSource(e){this.readStatus!=="closing"&&this.readStatus!=="closed"&&(this.log.trace("ending source with %d bytes to be read by consumer",this.streamSource.readableLength),this.readStatus="closing",this.streamSource.end(e))}remoteCloseWrite(){if(this.readStatus==="closing"||this.readStatus==="closed"){this.log("received remote close write but local source is already closed");return}this.log.trace("remote close write"),this._closeSource()}remoteCloseRead(){if(this.writeStatus==="closing"||this.writeStatus==="closed"){this.log("received remote close read but local sink is already closed");return}this.log.trace("remote close read"),this._closeSink()}destroy(){if(this.status==="closed"||this.status==="aborted"||this.status==="reset"){this.log("received destroy but we are already closed");return}this.log.trace("stream destroyed"),this._closeSinkAndSource()}sourcePush(e){this.streamSource.push(e)}sourceReadableLength(){return this.streamSource.readableLength}}var as;(function(r){r[r.Init=0]="Init",r[r.SYNSent=1]="SYNSent",r[r.SYNReceived=2]="SYNReceived",r[r.Established=3]="Established",r[r.Finished=4]="Finished"})(as||(as={}));class iye extends R9{constructor(t){super({...t,onEnd:n=>{var i;this.state=as.Finished,(i=t.onEnd)==null||i.call(t,n)}});u(this,"name");u(this,"state");u(this,"config");u(this,"_id");u(this,"sendWindowCapacity");u(this,"sendWindowCapacityUpdate");u(this,"recvWindow");u(this,"recvWindowCapacity");u(this,"epochStart");u(this,"getRTT");u(this,"sendFrame");this.config=t.config,this._id=parseInt(t.id,10),this.name=t.name,this.state=t.state,this.sendWindowCapacity=M9,this.recvWindow=this.config.initialStreamWindowSize,this.recvWindowCapacity=this.recvWindow,this.epochStart=Date.now(),this.getRTT=t.getRTT,this.sendFrame=t.sendFrame,this.source=sm(this.source,()=>{this.sendWindowUpdate()})}async sendNewStream(){}async sendData(t,n={}){var i,s;for(t=t.sublist();t.byteLength!==0;){if(this.sendWindowCapacity===0&&((i=this.log)==null||i.trace("wait for send window capacity, status %s",this.status),await this.waitForSendWindowCapacity(n),this.status==="closed"||this.status==="aborted"||this.status==="reset")){(s=this.log)==null||s.trace("%s while waiting for send window capacity",this.status);return}const o=Math.min(this.sendWindowCapacity,this.config.maxMessageSize-cp,t.length),a=this.getSendFlags();this.sendFrame({type:or.Data,flag:a,streamID:this._id,length:o},t.sublist(0,o)),this.sendWindowCapacity-=o,t.consume(o)}}async sendReset(){this.sendFrame({type:or.WindowUpdate,flag:qt.RST,streamID:this._id,length:0})}async sendCloseWrite(){const t=this.getSendFlags()|qt.FIN;this.sendFrame({type:or.WindowUpdate,flag:t,streamID:this._id,length:0})}async sendCloseRead(){}async waitForSendWindowCapacity(t={}){var o,a;if(this.sendWindowCapacity>0)return;let n,i;const s=()=>{this.status==="open"||this.status==="closing"?i(new Al("Stream aborted")):n()};(o=t.signal)==null||o.addEventListener("abort",s);try{await new Promise((c,l)=>{this.sendWindowCapacityUpdate=()=>{c()},i=l,n=c})}finally{(a=t.signal)==null||a.removeEventListener("abort",s)}}handleWindowUpdate(t){var i,s;(i=this.log)==null||i.trace("stream received window update id=%s",this._id),this.processFlags(t.flag);const n=this.sendWindowCapacity;this.sendWindowCapacity+=t.length,n===0&&t.length>0&&((s=this.sendWindowCapacityUpdate)==null||s.call(this))}async handleData(t,n){var s;if((s=this.log)==null||s.trace("stream received data id=%s",this._id),this.processFlags(t.flag),this.recvWindowCapacity<t.length)throw new N9("Receive window exceeded");const i=await n();this.recvWindowCapacity-=t.length,this.sourcePush(i)}processFlags(t){(t&qt.ACK)===qt.ACK&&this.state===as.SYNSent&&(this.state=as.Established),(t&qt.FIN)===qt.FIN&&this.remoteCloseWrite(),(t&qt.RST)===qt.RST&&this.reset()}getSendFlags(){switch(this.state){case as.Init:return this.state=as.SYNSent,qt.SYN;case as.SYNReceived:return this.state=as.Established,qt.ACK;default:return 0}}sendWindowUpdate(){const t=this.getSendFlags(),n=Date.now(),i=this.getRTT();if(t===0&&i>-1&&n-this.epochStart<i*4&&(this.recvWindow=Math.min(this.recvWindow*2,this.config.maxStreamWindowSize)),this.recvWindowCapacity>=this.recvWindow&&t===0)return;const s=this.recvWindow-this.recvWindowCapacity;this.recvWindowCapacity=this.recvWindow,this.epochStart=n,this.sendFrame({type:or.WindowUpdate,flag:t,streamID:this._id,length:s})}}const EL="/yamux/1.0.0",sye=500;Kj=Symbol.toStringTag,Vj=ur;class oye{constructor(e,t={}){u(this,"protocol",EL);u(this,"_components");u(this,"_init");u(this,Kj,"@chainsafe/libp2p-yamux");u(this,Vj,["@libp2p/stream-multiplexing"]);this._components=e,this._init=t}createStreamMuxer(e){return new aye(this._components,{...this._init,...e})}}class aye{constructor(e,t){u(this,"protocol",EL);u(this,"source");u(this,"sink");u(this,"config");u(this,"log");u(this,"logger");u(this,"closeController");u(this,"nextStreamID");u(this,"_streams");u(this,"nextPingID");u(this,"activePing");u(this,"rtt");u(this,"client");u(this,"localGoAway");u(this,"remoteGoAway");u(this,"numInboundStreams");u(this,"numOutboundStreams");u(this,"onIncomingStream");u(this,"onStreamEnd");var n;this.client=t.direction==="outbound",this.config={...Y2e,...t},this.logger=e.logger,this.log=this.logger.forComponent("libp2p:yamux"),J2e(this.config),this.closeController=new AbortController,this.closeController.signal,this.onIncomingStream=t.onIncomingStream,this.onStreamEnd=t.onStreamEnd,this._streams=new Map,this.source=ho({onEnd:()=>{var i;(i=this.log)==null||i.trace("muxer source ended"),this._streams.forEach(s=>{s.destroy()})}}),this.sink=async i=>{var c,l,d;const s=()=>{const h=fL(i);if(h.return!=null){const p=h.return();cye(p)&&p.catch(m=>{var f;(f=this.log)==null||f.call(this,"could not cause sink source to return",m)})}};let o,a;try{const h=new eye(i);try{this.closeController.signal.addEventListener("abort",s);for await(const p of h.emitFrames())await this.handleFrame(p.header,p.readData)}finally{this.closeController.signal.removeEventListener("abort",s)}o=zs.NormalTermination}catch(h){G2e.has(h.name)?((c=this.log)==null||c.error("protocol error in sink",h),o=zs.ProtocolError):((l=this.log)==null||l.error("internal error in sink",h),o=zs.InternalError),a=h}(d=this.log)==null||d.trace("muxer sink ended"),a!=null?this.abort(a,o):await this.close({reason:o})},this.numInboundStreams=0,this.numOutboundStreams=0,this.nextStreamID=this.client?1:2,this.nextPingID=0,this.rtt=-1,(n=this.log)==null||n.trace("muxer created"),this.config.enableKeepAlive&&this.keepAliveLoop().catch(i=>{var s;return(s=this.log)==null?void 0:s.error("keepalive error: %s",i)}),this.ping().catch(i=>{var s;return(s=this.log)==null?void 0:s.error("ping error: %s",i)})}get streams(){return Array.from(this._streams.values())}newStream(e){var i;if(this.remoteGoAway!==void 0)throw new Cl("Muxer closed remotely");if(this.localGoAway!==void 0)throw new Cl("Muxer closed locally");const t=this.nextStreamID;if(this.nextStreamID+=2,this.numOutboundStreams>=this.config.maxOutboundStreams)throw new O2("max outbound streams exceeded");(i=this.log)==null||i.trace("new outgoing stream id=%s",t);const n=this._newStream(t,e,as.Init,"outbound");return this._streams.set(t,n),this.numOutboundStreams++,n.sendWindowUpdate(),n}async ping(){if(this.remoteGoAway!==void 0)throw new Cl("Muxer closed remotely");if(this.localGoAway!==void 0)throw new Cl("Muxer closed locally");if(this.activePing===void 0){let e=()=>{};this.activePing={id:this.nextPingID++,promise:new Promise((i,s)=>{const o=()=>{s(new Cl("Muxer closed locally"))};this.closeController.signal.addEventListener("abort",o,{once:!0}),e=()=>{this.closeController.signal.removeEventListener("abort",o),i()}}),resolve:e};const t=Date.now();this.sendPing(this.activePing.id);try{await this.activePing.promise}finally{delete this.activePing}const n=Date.now();this.rtt=n-t}else await this.activePing.promise;return this.rtt}getRTT(){return this.rtt}async close(e={}){var n;if(this.closeController.signal.aborted)return;const t=(e==null?void 0:e.reason)??zs.NormalTermination;if((n=this.log)==null||n.trace("muxer close reason=%s",t),e.signal==null){const i=AbortSignal.timeout(sye);e={...e,signal:i}}try{await Promise.all([...this._streams.values()].map(async i=>i.close(e))),this.sendGoAway(t),this._closeMuxer()}catch(i){this.abort(i)}}abort(e,t){var n;if(!this.closeController.signal.aborted){t=t??zs.InternalError,(n=this.log)==null||n.error("muxer abort reason=%s error=%s",t,e);for(const i of this._streams.values())i.abort(e);this.sendGoAway(t),this._closeMuxer()}}isClosed(){return this.closeController.signal.aborted}_closeMuxer(){this.closeController.abort(),this.source.end()}_newStream(e,t,n,i){if(this._streams.get(e)!=null)throw new Z("Stream already exists with that id");const s=new iye({id:e.toString(),name:t,state:n,direction:i,sendFrame:this.sendFrame.bind(this),onEnd:()=>{var o;this.closeStream(e),(o=this.onStreamEnd)==null||o.call(this,s)},log:this.logger.forComponent(`libp2p:yamux:${i}:${e}`),config:this.config,getRTT:this.getRTT.bind(this)});return s}closeStream(e){this.client===(e%2===0)?this.numInboundStreams--:this.numOutboundStreams--,this._streams.delete(e)}async keepAliveLoop(){var t;const e=new Promise((n,i)=>{this.closeController.signal.addEventListener("abort",i,{once:!0})});for((t=this.log)==null||t.trace("muxer keepalive enabled interval=%s",this.config.keepAliveInterval);;){let n;try{await Promise.race([e,new Promise(i=>{n=setTimeout(i,this.config.keepAliveInterval)})]),this.ping().catch(i=>{var s;return(s=this.log)==null?void 0:s.error("ping error: %s",i)})}catch{clearInterval(n);return}}}async handleFrame(e,t){var o;const{streamID:n,type:i,length:s}=e;if((o=this.log)==null||o.trace("received frame %o",e),n===0)switch(i){case or.Ping:{this.handlePing(e);return}case or.GoAway:{this.handleGoAway(s);return}default:throw new Hl("Invalid frame type")}else switch(e.type){case or.Data:case or.WindowUpdate:{await this.handleStreamMessage(e,t);return}default:throw new Hl("Invalid frame type")}}handlePing(e){var t,n;if(e.flag===qt.SYN)(t=this.log)==null||t.trace("received ping request pingId=%s",e.length),this.sendPing(e.length,qt.ACK);else if(e.flag===qt.ACK)(n=this.log)==null||n.trace("received ping response pingId=%s",e.length),this.handlePingResponse(e.length);else throw new Hl("Invalid frame flag")}handlePingResponse(e){if(this.activePing===void 0)throw new D9("ping not requested");if(this.activePing.id!==e)throw new $9("ping doesn't match our id");this.activePing.resolve()}handleGoAway(e){var t;(t=this.log)==null||t.trace("received GoAway reason=%s",zs[e]??"unknown"),this.remoteGoAway=e;for(const n of this._streams.values())n.reset();this._closeMuxer()}async handleStreamMessage(e,t){var a,c;const{streamID:n,flag:i,type:s}=e;(i&qt.SYN)===qt.SYN&&this.incomingStream(n);const o=this._streams.get(n);if(o===void 0){if(s===or.Data){if((a=this.log)==null||a.call(this,"discarding data for stream id=%s",n),t===void 0)throw new Error("unreachable");await t()}else(c=this.log)==null||c.trace("frame for missing stream id=%s",n);return}switch(s){case or.WindowUpdate:{o.handleWindowUpdate(e);return}case or.Data:{if(t===void 0)throw new Error("unreachable");await o.handleData(e,t);return}default:throw new Error("unreachable")}}incomingStream(e){var n,i,s;if(this.client!==(e%2===0))throw new Z("Both endpoints are clients");if(this._streams.has(e))return;if((n=this.log)==null||n.trace("new incoming stream id=%s",e),this.localGoAway!==void 0){this.sendFrame({type:or.WindowUpdate,flag:qt.RST,streamID:e,length:0});return}if(this.numInboundStreams>=this.config.maxInboundStreams){(i=this.log)==null||i.call(this,"maxIncomingStreams exceeded, forcing stream reset"),this.sendFrame({type:or.WindowUpdate,flag:qt.RST,streamID:e,length:0});return}const t=this._newStream(e,void 0,as.SYNReceived,"inbound");this.numInboundStreams++,this._streams.set(e,t),(s=this.onIncomingStream)==null||s.call(this,t)}sendFrame(e,t){var n;if((n=this.log)==null||n.trace("sending frame %o",e),e.type===or.Data){if(t===void 0)throw new Hl("Invalid frame");this.source.push(new Le(bL(e),t))}else this.source.push(bL(e))}sendPing(e,t=qt.SYN){var n,i;t===qt.SYN?(n=this.log)==null||n.trace("sending ping request pingId=%s",e):(i=this.log)==null||i.trace("sending ping response pingId=%s",e),this.sendFrame({type:or.Ping,flag:t,streamID:0,length:e})}sendGoAway(e=zs.NormalTermination){var t;(t=this.log)==null||t.call(this,"sending GoAway reason=%s",zs[e]),this.localGoAway=e,this.sendFrame({type:or.GoAway,flag:0,streamID:0,length:e})}}function cye(r){return r!=null&&typeof r.then=="function"}function lye(r={}){return e=>new oye(e,r)}const uye=41;function SL(r){try{const[[e,t]]=r.stringTuples();if(t==null)return!1;if(e===uye)return Dhe("2000::/3",t)}catch{}return!1}const dye=4,hye=41;function xL(r){try{const[[e]]=r.stringTuples();return e===dye||e===hye}catch{}return!1}function ql(r){try{if(!xL(r))return!1;const[[,e]]=r.stringTuples();return e==null?!1:pc(e)??!1}catch{}return!0}function fye(r,e,t){let n,i;function s(){const a={signal:i.signal};if((t==null?void 0:t.timeout)!=null){const c=ft([i.signal,AbortSignal.timeout(t.timeout)]);a.signal=c}Promise.resolve().then(async()=>{await r(a)}).catch(()=>{}).finally(()=>{i.signal.aborted||(n=setTimeout(s,e))})}let o=!1;return{setInterval:a=>{e=a,n!=null&&(clearTimeout(n),n=setTimeout(s,e))},setTimeout:a=>{t==null&&(t={}),t.timeout=a},start:()=>{o||(o=!0,i=new AbortController,i.signal,(t==null?void 0:t.runImmediately)===!0?queueMicrotask(()=>{s()}):n=setTimeout(s,e))},stop:()=>{clearTimeout(n),i==null||i.abort(),o=!1}}}function ci(r,e){const t=Yd(r,e),n={read:async(i,s)=>{const o=await t.read(s);return i.decode(o)},write:async(i,s,o)=>{await t.write(s.encode(i),o)},writeV:async(i,s,o)=>{await t.writeV(i.map(a=>s.encode(a)),o)},pb:i=>({read:async s=>n.read(i,s),write:async(s,o)=>n.write(s,i,o),writeV:async(s,o)=>n.writeV(s,i,o),unwrap:()=>n}),unwrap:()=>t.unwrap()};return n}function pye(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}var gye=CL,AL=128,yye=-128,mye=Math.pow(2,31);function CL(r,e,t){e=e||[],t=t||0;for(var n=t;r>=mye;)e[t++]=r&255|AL,r/=128;for(;r&yye;)e[t++]=r&255|AL,r>>>=7;return e[t]=r|0,CL.bytes=t-n+1,e}var wye=L9,bye=128,IL=127;function L9(r,n){var t=0,n=n||0,i=0,s=n,o,a=r.length;do{if(s>=a)throw L9.bytes=0,new RangeError("Could not decode varint");o=r[s++],t+=i<28?(o&IL)<<i:(o&IL)*Math.pow(2,i),i+=7}while(o>=bye);return L9.bytes=s-n,t}var vye=Math.pow(2,7),Eye=Math.pow(2,14),Sye=Math.pow(2,21),xye=Math.pow(2,28),Aye=Math.pow(2,35),Cye=Math.pow(2,42),Iye=Math.pow(2,49),kye=Math.pow(2,56),_ye=Math.pow(2,63),Tye=function(r){return r<vye?1:r<Eye?2:r<Sye?3:r<xye?4:r<Aye?5:r<Cye?6:r<Iye?7:r<kye?8:r<_ye?9:10},Pye={encode:gye,decode:wye,encodingLength:Tye},kL=Pye;function _L(r,e=0){return[kL.decode(r,e),kL.decode.bytes]}function Dye(r){const e=pye(r),[t,n]=_L(e),[i,s]=_L(e.subarray(n)),o=e.subarray(n+s);if(o.byteLength!==i)throw new Error("Incorrect length");return new $ye(t,i,o,e)}let $ye=class{constructor(e,t,n,i){u(this,"code");u(this,"size");u(this,"digest");u(this,"bytes");this.code=e,this.size=t,this.digest=n,this.bytes=i}};const Nye="libp2p",Mye="autonat",Oye="1.0.0",Rye=3e4,Lye=2,Bye=20,Uye=80,Fye=8192;var Ot;(function(r){(function(i){i.DIAL="DIAL",i.DIAL_RESPONSE="DIAL_RESPONSE"})(r.MessageType||(r.MessageType={}));let e;(function(i){i[i.DIAL=0]="DIAL",i[i.DIAL_RESPONSE=1]="DIAL_RESPONSE"})(e||(e={})),function(i){i.codec=()=>In(e)}(r.MessageType||(r.MessageType={})),function(i){i.OK="OK",i.E_DIAL_ERROR="E_DIAL_ERROR",i.E_DIAL_REFUSED="E_DIAL_REFUSED",i.E_BAD_REQUEST="E_BAD_REQUEST",i.E_INTERNAL_ERROR="E_INTERNAL_ERROR"}(r.ResponseStatus||(r.ResponseStatus={}));let t;(function(i){i[i.OK=0]="OK",i[i.E_DIAL_ERROR=100]="E_DIAL_ERROR",i[i.E_DIAL_REFUSED=101]="E_DIAL_REFUSED",i[i.E_BAD_REQUEST=200]="E_BAD_REQUEST",i[i.E_INTERNAL_ERROR=300]="E_INTERNAL_ERROR"})(t||(t={})),function(i){i.codec=()=>In(t)}(r.ResponseStatus||(r.ResponseStatus={})),function(i){let s;i.codec=()=>(s==null&&(s=De((o,a,c={})=>{if(c.lengthDelimited!==!1&&a.fork(),o.id!=null&&(a.uint32(10),a.bytes(o.id)),o.addrs!=null)for(const l of o.addrs)a.uint32(18),a.bytes(l);c.lengthDelimited!==!1&&a.ldelim()},(o,a,c={})=>{var h;const l={addrs:[]},d=a==null?o.len:o.pos+a;for(;o.pos<d;){const p=o.uint32();switch(p>>>3){case 1:{l.id=o.bytes();break}case 2:{if(((h=c.limits)==null?void 0:h.addrs)!=null&&l.addrs.length===c.limits.addrs)throw new yt('Decode error - map field "addrs" had too many elements');l.addrs.push(o.bytes());break}default:{o.skipType(p&7);break}}}return l})),s),i.encode=o=>Pe(o,i.codec()),i.decode=(o,a)=>Te(o,i.codec(),a)}(r.PeerInfo||(r.PeerInfo={})),function(i){let s;i.codec=()=>(s==null&&(s=De((o,a,c={})=>{c.lengthDelimited!==!1&&a.fork(),o.peer!=null&&(a.uint32(10),r.PeerInfo.codec().encode(o.peer,a)),c.lengthDelimited!==!1&&a.ldelim()},(o,a,c={})=>{var h;const l={},d=a==null?o.len:o.pos+a;for(;o.pos<d;){const p=o.uint32();switch(p>>>3){case 1:{l.peer=r.PeerInfo.codec().decode(o,o.uint32(),{limits:(h=c.limits)==null?void 0:h.peer});break}default:{o.skipType(p&7);break}}}return l})),s),i.encode=o=>Pe(o,i.codec()),i.decode=(o,a)=>Te(o,i.codec(),a)}(r.Dial||(r.Dial={})),function(i){let s;i.codec=()=>(s==null&&(s=De((o,a,c={})=>{c.lengthDelimited!==!1&&a.fork(),o.status!=null&&(a.uint32(8),r.ResponseStatus.codec().encode(o.status,a)),o.statusText!=null&&(a.uint32(18),a.string(o.statusText)),o.addr!=null&&(a.uint32(26),a.bytes(o.addr)),c.lengthDelimited!==!1&&a.ldelim()},(o,a,c={})=>{const l={},d=a==null?o.len:o.pos+a;for(;o.pos<d;){const h=o.uint32();switch(h>>>3){case 1:{l.status=r.ResponseStatus.codec().decode(o);break}case 2:{l.statusText=o.string();break}case 3:{l.addr=o.bytes();break}default:{o.skipType(h&7);break}}}return l})),s),i.encode=o=>Pe(o,i.codec()),i.decode=(o,a)=>Te(o,i.codec(),a)}(r.DialResponse||(r.DialResponse={}));let n;r.codec=()=>(n==null&&(n=De((i,s,o={})=>{o.lengthDelimited!==!1&&s.fork(),i.type!=null&&(s.uint32(8),r.MessageType.codec().encode(i.type,s)),i.dial!=null&&(s.uint32(18),r.Dial.codec().encode(i.dial,s)),i.dialResponse!=null&&(s.uint32(26),r.DialResponse.codec().encode(i.dialResponse,s)),o.lengthDelimited!==!1&&s.ldelim()},(i,s,o={})=>{var l,d;const a={},c=s==null?i.len:i.pos+s;for(;i.pos<c;){const h=i.uint32();switch(h>>>3){case 1:{a.type=r.MessageType.codec().decode(i);break}case 2:{a.dial=r.Dial.codec().decode(i,i.uint32(),{limits:(l=o.limits)==null?void 0:l.dial});break}case 3:{a.dialResponse=r.DialResponse.codec().decode(i,i.uint32(),{limits:(d=o.limits)==null?void 0:d.dialResponse});break}default:{i.skipType(h&7);break}}}return a})),n),r.encode=i=>Pe(i,r.codec()),r.decode=(i,s)=>Te(i,r.codec(),s)})(Ot||(Ot={}));const zye=4,Vye=8;class Kye{constructor(e,t){u(this,"components");u(this,"protocol");u(this,"timeout");u(this,"maxInboundStreams");u(this,"maxOutboundStreams");u(this,"maxMessageSize");u(this,"started");u(this,"log");u(this,"topologyId");u(this,"dialResults");u(this,"findPeers");u(this,"addressFilter");u(this,"connectionThreshold");u(this,Hj,"@libp2p/autonat");u(this,jj,["@libp2p/autonat"]);this.components=e,this.log=e.logger.forComponent("libp2p:auto-nat"),this.started=!1,this.protocol=`/${t.protocolPrefix??Nye}/${Mye}/${Oye}`,this.timeout=t.timeout??Rye,this.maxInboundStreams=t.maxInboundStreams??Lye,this.maxOutboundStreams=t.maxOutboundStreams??Bye,this.connectionThreshold=t.connectionThreshold??Uye,this.maxMessageSize=t.maxMessageSize??Fye,this.dialResults=new Map,this.findPeers=fye(this.findRandomPeers.bind(this),6e4),this.addressFilter=Ll(1024)}get[(Hj=Symbol.toStringTag,jj=ur,ja)](){return["@libp2p/identify"]}isStarted(){return this.started}async start(){this.started||(await this.components.registrar.handle(this.protocol,e=>{this.handleIncomingAutonatStream(e).catch(t=>{this.log.error("error handling incoming autonat stream - %e",t)})},{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams}),this.topologyId=await this.components.registrar.register(this.protocol,{onConnect:(e,t)=>{this.verifyExternalAddresses(t).catch(n=>{this.log.error("could not verify addresses - %e",n)})}}),this.findPeers.start(),this.started=!0)}async stop(){await this.components.registrar.unhandle(this.protocol),this.topologyId!=null&&await this.components.registrar.unhandle(this.topologyId),this.dialResults.clear(),this.findPeers.stop(),this.started=!1}allAddressesAreVerified(){return this.components.addressManager.getAddressesWithMetadata().every(e=>e.expires>Date.now()?!0:e.verified)}async findRandomPeers(e){if(this.allAddressesAreVerified())return;const t=ft([AbortSignal.timeout(1e4),e==null?void 0:e.signal]);try{this.log("starting random walk to find peers to run AutoNAT");for await(const n of this.components.randomWalk.walk({signal:t})){if(!await this.components.connectionManager.isDialable(n.multiaddrs)){this.log.trace("random peer %p was not dialable %s",n.id,n.multiaddrs.map(i=>i.toString()).join(", "));continue}try{this.log.trace("dial random peer %p",n.id),await this.components.connectionManager.openConnection(n.multiaddrs,{signal:t})}catch{}if(this.allAddressesAreVerified()){this.log("stopping random walk, all addresses are verified");return}if(!this.hasConnectionCapacity()){this.log("stopping random walk, too close to max connections");return}}}catch{}}async handleIncomingAutonatStream(e){const t=AbortSignal.timeout(this.timeout),n=ci(e.stream,{maxDataLength:this.maxMessageSize}).pb(Ot);try{const i=await n.read({signal:t}),s=await this.handleAutonatMessage(i,e.connection,{signal:t});await n.write(s,{signal:t}),await n.unwrap().unwrap().close({signal:t})}catch(i){this.log.error("error handling incoming autonat stream - %e",i),e.stream.abort(i)}}async handleAutonatMessage(e,t,n){const i=this.components.addressManager.getAddresses().map(h=>h.toOptions().host),s=e.dial;if(s==null)return this.log.error("dial was missing from message"),{type:Ot.MessageType.DIAL_RESPONSE,dialResponse:{status:Ot.ResponseStatus.E_BAD_REQUEST,statusText:"No Dial message found in message"}};let o;const a=s.peer;if((a==null?void 0:a.id)==null)return this.log.error("PeerId missing from message"),{type:Ot.MessageType.DIAL_RESPONSE,dialResponse:{status:Ot.ResponseStatus.E_BAD_REQUEST,statusText:"missing peer info"}};try{const h=Dye(a.id);o=ei(h)}catch(h){return this.log.error("invalid PeerId - %e",h),{type:Ot.MessageType.DIAL_RESPONSE,dialResponse:{status:Ot.ResponseStatus.E_BAD_REQUEST,statusText:"bad peer id"}}}if(this.log("incoming request from %p",o),!t.remotePeer.equals(o))return this.log("target peer %p did not equal sending peer %p",o,t.remotePeer),{type:Ot.MessageType.DIAL_RESPONSE,dialResponse:{status:Ot.ResponseStatus.E_BAD_REQUEST,statusText:"peer id mismatch"}};const c=a.addrs.map(h=>Oe(h)).filter(h=>{const p=h.toOptions();return ql(h)?!1:p.host!==t.remoteAddr.toOptions().host?(this.log.trace("not dialing %a - target host did not match remote host %a",h,t.remoteAddr),!1):i.includes(p.host)?!1:this.components.transportManager.dialTransportForMultiaddr(h)==null?(this.log.trace("not dialing %a - transport unsupported",h),!1):!0}).map(h=>(h.getPeerId()==null&&(h=h.encapsulate(`/p2p/${o.toString()}`)),h));if(c.length===0)return this.log("refused to dial all multiaddrs for %p from message",o),{type:Ot.MessageType.DIAL_RESPONSE,dialResponse:{status:Ot.ResponseStatus.E_DIAL_REFUSED,statusText:"no dialable addresses"}};this.log("dial multiaddrs %s for peer %p",c.map(h=>h.toString()).join(", "),o);let l="",d=c[0];for await(const h of c){let p;d=h;try{if(p=await this.components.connectionManager.openConnection(h,n),!p.remoteAddr.equals(h))throw this.log.error("tried to dial %a but dialed %a",h,p.remoteAddr),new Error("Unexpected remote address");return this.log("successfully dialed %p via %a",o,h),{type:Ot.MessageType.DIAL_RESPONSE,dialResponse:{status:Ot.ResponseStatus.OK,addr:p.remoteAddr.decapsulateCode(ze("p2p").code).bytes}}}catch(m){this.log.error("could not dial %p - %e",o,m),l=m.message}finally{p!=null&&await p.close()}}return{type:Ot.MessageType.DIAL_RESPONSE,dialResponse:{status:Ot.ResponseStatus.E_DIAL_ERROR,statusText:l,addr:d.bytes}}}getFirstUnverifiedMultiaddr(e,t){var i,s;const n=this.components.addressManager.getAddressesWithMetadata().sort((o,a)=>o.type==="observed"&&a.type!=="observed"?1:a.type==="observed"&&o.type!=="observed"?-1:0).filter(o=>!(!(o.expires<Date.now())||o.multiaddr.toOptions().family===6&&(!t||!SL(o.multiaddr))||ql(o.multiaddr)));for(const o of n){const a=o.multiaddr.toString();let c=this.dialResults.get(a);if(c!=null){if(c.networkSegments.includes(e)){this.log.trace("%a already has a network segment result from %s",c.multiaddr,e);continue}if(c.queue.size>10){this.log.trace("%a already has enough peers queued",c.multiaddr);continue}}if(c==null){const l=o.expires<Date.now();if(l&&((s=(i=this.addressFilter).remove)==null||s.call(i,a)),this.addressFilter.has(a))continue;this.addressFilter.add(a),this.log.trace("creating dial result %s %s",l?"to revalidate":"for",a),c={multiaddr:o.multiaddr,success:0,failure:0,networkSegments:[],verifyingPeers:_oe(),queue:new ic({concurrency:3,maxSize:50}),type:o.type,lastVerified:o.lastVerified},this.dialResults.set(a,c)}return c}}removeOutdatedMultiaddrResults(){const e=new Set(this.components.addressManager.getAddressesWithMetadata().filter(({expires:t})=>t<Date.now()).map(({multiaddr:t})=>t.toString()));for(const t of this.dialResults.keys())e.has(t)||(this.log.trace("remove results for %a",t),this.dialResults.delete(t))}async verifyExternalAddresses(e){if(!this.isStarted())return;this.removeOutdatedMultiaddrResults();const n=(await this.components.peerStore.get(e.remotePeer)).addresses.some(({multiaddr:o})=>o.toOptions().family===6),i=this.getNetworkSegment(e.remoteAddr),s=this.getFirstUnverifiedMultiaddr(i,n);if(s==null){this.log.trace("no unverified public addresses found for peer %p to verify, not requesting verification",e.remotePeer);return}if(!this.hasConnectionCapacity()){s.lastVerified!=null?(this.log("automatically re-verifying %a because we are too close to the connection limit",s.multiaddr),this.confirmAddress(s)):this.log("skipping verifying %a because we are too close to the connection limit",s.multiaddr);return}s.queue.add(async o=>{await this.askPeerToVerify(e,i,o)},{peerId:e.remotePeer,multiaddr:s.multiaddr}).catch(o=>{(s==null?void 0:s.result)==null&&this.log.error("error from %p verifying address %a - %e",e.remotePeer,s==null?void 0:s.multiaddr,o)})}async askPeerToVerify(e,t,n){let i=this.dialResults.get(n.multiaddr.toString());if(i==null){this.log("%a was verified while %p was queued",n.multiaddr,e.remotePeer);return}const s=AbortSignal.timeout(this.timeout);this.log.trace("asking %p to verify multiaddr %s",e.remotePeer,n.multiaddr);const o=await e.newStream(this.protocol,{signal:s});try{const a=ci(o).pb(Ot),[,c]=await Promise.all([a.write({type:Ot.MessageType.DIAL,dial:{peer:{id:this.components.peerId.toMultihash().bytes,addrs:[n.multiaddr.bytes]}}},{signal:s}),a.read({signal:s})]);if(c.type!==Ot.MessageType.DIAL_RESPONSE||c.dialResponse==null){this.log("invalid autonat response from %p - %j",e.remotePeer,c);return}const l=c.dialResponse.status;if(this.log.trace("autonat response from %p for %a is %s",e.remotePeer,n.multiaddr,l),l!==Ot.ResponseStatus.OK&&l!==Ot.ResponseStatus.E_DIAL_ERROR)return;if(i=this.dialResults.get(n.multiaddr.toString()),i==null){this.log.trace("peer reported %a as %s but there is no result object",n.multiaddr,c.dialResponse.status);return}if(i.networkSegments.includes(t)){this.log.trace("%a results included network segment %s",n.multiaddr,t);return}if(i.result!=null){this.log.trace("already resolved result for %a, ignoring response from",n.multiaddr,e.remotePeer);return}if(i.verifyingPeers.has(e.remotePeer)){this.log.trace("peer %p has already verified %a, ignoring response",e.remotePeer,n.multiaddr);return}if(i.verifyingPeers.add(e.remotePeer),i.networkSegments.push(t),l===Ot.ResponseStatus.OK){if(i.success++,i.type!=="observed"){this.confirmAddress(i);return}}else l===Ot.ResponseStatus.E_DIAL_ERROR&&i.failure++;this.log("%a success %d failure %d",i.multiaddr,i.success,i.failure),i.success===zye&&this.confirmAddress(i),i.failure===Vye&&this.unconfirmAddress(i)}finally{try{await o.close({signal:s})}catch(a){o.abort(a)}}}hasConnectionCapacity(){const t=this.components.connectionManager.getConnections().length,n=this.components.connectionManager.getMaxConnections();return t/n*100<this.connectionThreshold}confirmAddress(e){this.log("%s address %a is externally dialable",e.type,e.multiaddr),this.components.addressManager.confirmObservedAddr(e.multiaddr),this.dialResults.delete(e.multiaddr.toString()),e.result=!0,e.queue.abort()}unconfirmAddress(e){this.log("%s address %a is not externally dialable",e.type,e.multiaddr),this.components.addressManager.removeObservedAddr(e.multiaddr),this.dialResults.delete(e.multiaddr.toString()),e.result=!1,e.queue.abort()}getNetworkSegment(e){const t=e.toOptions();return t.family===4?t.host.split(".")[0].padStart(3,"0"):t.host.split(":")[0].padStart(4,"0")}}function jye(r={}){return e=>new Kye(e,r)}const Hye=fe("dns4"),qye=fe("dns6"),Wye=fe("dnsaddr"),Wl=Gt(fe("dns"),Wye,Hye,qye),n3=Gt(fe("ip4"),fe("ip6")),Zd=Gt(_e(n3,fe("tcp")),_e(Wl,fe("tcp"))),i3=_e(n3,fe("udp")),Gye=_e(i3,fe("utp")),Qye=_e(i3,fe("quic")),Yye=_e(i3,fe("quic-v1")),B9=Gt(_e(Zd,fe("ws")),_e(Wl,fe("ws"))),s3=Gt(_e(B9,fe("p2p")),B9),U9=Gt(_e(Zd,fe("wss")),_e(Wl,fe("wss")),_e(Zd,fe("tls"),fe("ws")),_e(Wl,fe("tls"),fe("ws"))),o3=Gt(_e(U9,fe("p2p")),U9),F9=Gt(_e(Zd,fe("http")),_e(n3,fe("http")),_e(Wl,fe("http"))),z9=Gt(_e(Zd,fe("https")),_e(n3,fe("https")),_e(Wl,fe("https"))),TL=_e(i3,fe("webrtc-direct"),fe("certhash")),PL=Gt(_e(TL,fe("p2p")),TL),DL=_e(Yye,fe("webtransport"),fe("certhash"),fe("certhash")),$L=Gt(_e(DL,fe("p2p")),DL),NL=Gt(_e(s3,fe("p2p-webrtc-star"),fe("p2p")),_e(o3,fe("p2p-webrtc-star"),fe("p2p")),_e(s3,fe("p2p-webrtc-star")),_e(o3,fe("p2p-webrtc-star")));Gt(_e(s3,fe("p2p-websocket-star"),fe("p2p")),_e(o3,fe("p2p-websocket-star"),fe("p2p")),_e(s3,fe("p2p-websocket-star")),_e(o3,fe("p2p-websocket-star")));const ML=Gt(_e(F9,fe("p2p-webrtc-direct"),fe("p2p")),_e(z9,fe("p2p-webrtc-direct"),fe("p2p")),_e(F9,fe("p2p-webrtc-direct")),_e(z9,fe("p2p-webrtc-direct"))),Gl=Gt(B9,U9,F9,z9,NL,ML,Zd,Gye,Qye,Wl,PL,$L);Gt(_e(Gl,fe("p2p-stardust"),fe("p2p")),_e(Gl,fe("p2p-stardust")));const Ac=Gt(_e(Gl,fe("p2p")),NL,ML,PL,$L,fe("p2p")),OL=Gt(_e(Ac,fe("p2p-circuit"),Ac),_e(Ac,fe("p2p-circuit")),_e(fe("p2p-circuit"),Ac),_e(Gl,fe("p2p-circuit")),_e(fe("p2p-circuit"),Gl),fe("p2p-circuit")),RL=()=>Gt(_e(OL,RL),OL),Ql=RL(),Jye=Gt(_e(Ql,Ac,Ql),_e(Ac,Ql),_e(Ql,Ac),Ql,Ac);Gt(_e(Ql,fe("webrtc"),fe("p2p")),_e(Ql,fe("webrtc")),_e(Gl,fe("webrtc"),fe("p2p")),_e(Gl,fe("webrtc")),fe("webrtc"));function LL(r){function e(t){let n;try{n=Oe(t)}catch{return!1}const i=r(n.protoNames());return i===null?!1:i===!0||i===!1?i:i.length===0}return e}function _e(...r){function e(t){if(t.length<r.length)return null;let n=t;return r.some(i=>(n=typeof i=="function"?i().partialMatch(t):i.partialMatch(t),Array.isArray(n)&&(t=n),n===null)),n}return{toString:function(){return"{ "+r.join(" ")+" }"},input:r,matches:LL(e),partialMatch:e}}function Gt(...r){function e(n){let i=null;return r.some(s=>{const o=typeof s=="function"?s().partialMatch(n):s.partialMatch(n);return o!=null?(i=o,!0):!1}),i}return{toString:function(){return"{ "+r.join(" ")+" }"},input:r,matches:LL(e),partialMatch:e}}function fe(r){const e=r;function t(i){let s;try{s=Oe(i)}catch{return!1}const o=s.protoNames();return o.length===1&&o[0]===e}function n(i){return i.length===0?null:i[0]===e?i.slice(1):null}return{toString:function(){return e},matches:t,partialMatch:n}}const Xye="bootstrap",Zye=50,eme=1e3;class BL extends(Qj=er,Gj=k2,Wj=Symbol.toStringTag,qj=ur,Qj){constructor(t,n={list:[]}){if(n.list==null||n.list.length===0)throw new Error("Bootstrap requires a list of peer addresses");super();u(this,"log");u(this,"timer");u(this,"list");u(this,"timeout");u(this,"components");u(this,"_init");u(this,Gj,this);u(this,Wj,"@libp2p/bootstrap");u(this,qj,["@libp2p/peer-discovery"]);this.components=t,this.log=t.logger.forComponent("libp2p:bootstrap"),this.timeout=n.timeout??eme,this.list=[];for(const i of n.list){if(!Jye.matches(i)){this.log.error("Invalid multiaddr");continue}const s=Oe(i),o=s.getPeerId();if(o==null){this.log.error("Invalid bootstrap multiaddr without peer id");continue}const a={id:tr(o),multiaddrs:[s]};this.list.push(a)}this._init=n}isStarted(){return!!this.timer}start(){this.isStarted()||(this.log("Starting bootstrap node discovery, discovering peers after %s ms",this.timeout),this.timer=setTimeout(()=>{this._discoverBootstrapPeers().catch(t=>{this.log.error(t)})},this.timeout))}async _discoverBootstrapPeers(){if(this.timer!=null)for(const t of this.list){if(await this.components.peerStore.merge(t.id,{tags:{[this._init.tagName??Xye]:{value:this._init.tagValue??Zye,ttl:this._init.tagTTL}},multiaddrs:t.multiaddrs}),this.timer==null)return;this.safeDispatchEvent("peer",{detail:t}),this.components.connectionManager.openConnection(t.id).catch(n=>{this.log.error("could not dial bootstrap peer %p",t.id,n)})}}stop(){this.timer!=null&&clearTimeout(this.timer),this.timer=void 0}}u(BL,"tag","bootstrap");function V9(r){return e=>new BL(e,r)}var a3;(function(r){let e;r.codec=()=>(e==null&&(e=De((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.publicKey!=null&&t.publicKey.byteLength>0&&(n.uint32(10),n.bytes(t.publicKey)),t.payloadType!=null&&t.payloadType.byteLength>0&&(n.uint32(18),n.bytes(t.payloadType)),t.payload!=null&&t.payload.byteLength>0&&(n.uint32(26),n.bytes(t.payload)),t.signature!=null&&t.signature.byteLength>0&&(n.uint32(42),n.bytes(t.signature)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{const s={publicKey:We(0),payloadType:We(0),payload:We(0),signature:We(0)},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.publicKey=t.bytes();break}case 2:{s.payloadType=t.bytes();break}case 3:{s.payload=t.bytes();break}case 5:{s.signature=t.bytes();break}default:{t.skipType(a&7);break}}}return s})),e),r.encode=t=>Pe(t,r.codec()),r.decode=(t,n)=>Te(t,r.codec(),n)})(a3||(a3={}));class tme extends Error{constructor(e="Invalid signature"){super(e),this.name="InvalidSignatureError"}}const zc=class zc{constructor(e){u(this,"publicKey");u(this,"payloadType");u(this,"payload");u(this,"signature");u(this,"marshaled");const{publicKey:t,payloadType:n,payload:i,signature:s}=e;this.publicKey=t,this.payloadType=n,this.payload=i,this.signature=s}marshal(){return this.marshaled==null&&(this.marshaled=a3.encode({publicKey:ki(this.publicKey),payloadType:this.payloadType,payload:this.payload.subarray(),signature:this.signature})),this.marshaled}equals(e){return qe(this.marshal(),e.marshal())}async validate(e){const t=UL(e,this.payloadType,this.payload);return this.publicKey.verify(t.subarray(),this.signature)}};u(zc,"createFromProtobuf",async e=>{const t=a3.decode(e),n=kn(t.publicKey);return new zc({publicKey:n,payloadType:t.payloadType,payload:t.payload,signature:t.signature})}),u(zc,"seal",async(e,t)=>{if(t==null)throw new Error("Missing private key");const n=e.domain,i=e.codec,s=e.marshal(),o=UL(n,i,s),a=await t.sign(o.subarray());return new zc({publicKey:t.publicKey,payloadType:i,payload:s,signature:a})}),u(zc,"openAndCertify",async(e,t)=>{const n=await zc.createFromProtobuf(e);if(!await n.validate(t))throw new tme("Envelope signature is not valid for the given domain");return n});let Cc=zc;const UL=(r,e,t)=>{const n=ie(r),i=Er(n.byteLength),s=Er(e.length),o=Er(t.length);return new Le(i,n,s,e,o,t)};function rme(r,e){const t=(n,i)=>n.toString().localeCompare(i.toString());return r.length!==e.length?!1:(e.sort(t),r.sort(t).every((n,i)=>e[i].equals(n)))}function nme(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}var ime=zL,FL=128,sme=-128,ome=Math.pow(2,31);function zL(r,e,t){e=e||[],t=t||0;for(var n=t;r>=ome;)e[t++]=r&255|FL,r/=128;for(;r&sme;)e[t++]=r&255|FL,r>>>=7;return e[t]=r|0,zL.bytes=t-n+1,e}var ame=K9,cme=128,VL=127;function K9(r,n){var t=0,n=n||0,i=0,s=n,o,a=r.length;do{if(s>=a)throw K9.bytes=0,new RangeError("Could not decode varint");o=r[s++],t+=i<28?(o&VL)<<i:(o&VL)*Math.pow(2,i),i+=7}while(o>=cme);return K9.bytes=s-n,t}var lme=Math.pow(2,7),ume=Math.pow(2,14),dme=Math.pow(2,21),hme=Math.pow(2,28),fme=Math.pow(2,35),pme=Math.pow(2,42),gme=Math.pow(2,49),yme=Math.pow(2,56),mme=Math.pow(2,63),wme=function(r){return r<lme?1:r<ume?2:r<dme?3:r<hme?4:r<fme?5:r<pme?6:r<gme?7:r<yme?8:r<mme?9:10},bme={encode:ime,decode:ame,encodingLength:wme},KL=bme;function jL(r,e=0){return[KL.decode(r,e),KL.decode.bytes]}function vme(r){const e=nme(r),[t,n]=jL(e),[i,s]=jL(e.subarray(n)),o=e.subarray(n+s);if(o.byteLength!==i)throw new Error("Incorrect length");return new Eme(t,i,o,e)}let Eme=class{constructor(e,t,n,i){u(this,"code");u(this,"size");u(this,"digest");u(this,"bytes");this.code=e,this.size=t,this.digest=n,this.bytes=i}};const Sme="libp2p-peer-record",xme=Uint8Array.from([3,1]);var c3;(function(r){(function(t){let n;t.codec=()=>(n==null&&(n=De((i,s,o={})=>{o.lengthDelimited!==!1&&s.fork(),i.multiaddr!=null&&i.multiaddr.byteLength>0&&(s.uint32(10),s.bytes(i.multiaddr)),o.lengthDelimited!==!1&&s.ldelim()},(i,s,o={})=>{const a={multiaddr:We(0)},c=s==null?i.len:i.pos+s;for(;i.pos<c;){const l=i.uint32();switch(l>>>3){case 1:{a.multiaddr=i.bytes();break}default:{i.skipType(l&7);break}}}return a})),n),t.encode=i=>Pe(i,t.codec()),t.decode=(i,s)=>Te(i,t.codec(),s)})(r.AddressInfo||(r.AddressInfo={}));let e;r.codec=()=>(e==null&&(e=De((t,n,i={})=>{if(i.lengthDelimited!==!1&&n.fork(),t.peerId!=null&&t.peerId.byteLength>0&&(n.uint32(10),n.bytes(t.peerId)),t.seq!=null&&t.seq!==0n&&(n.uint32(16),n.uint64(t.seq)),t.addresses!=null)for(const s of t.addresses)n.uint32(26),r.AddressInfo.codec().encode(s,n);i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{var a,c;const s={peerId:We(0),seq:0n,addresses:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{s.peerId=t.bytes();break}case 2:{s.seq=t.uint64();break}case 3:{if(((a=i.limits)==null?void 0:a.addresses)!=null&&s.addresses.length===i.limits.addresses)throw new yt('Decode error - map field "addresses" had too many elements');s.addresses.push(r.AddressInfo.codec().decode(t,t.uint32(),{limits:(c=i.limits)==null?void 0:c.addresses$}));break}default:{t.skipType(l&7);break}}}return s})),e),r.encode=t=>Pe(t,r.codec()),r.decode=(t,n)=>Te(t,r.codec(),n)})(c3||(c3={}));const ca=class ca{constructor(e){u(this,"peerId");u(this,"multiaddrs");u(this,"seqNumber");u(this,"domain",ca.DOMAIN);u(this,"codec",ca.CODEC);u(this,"marshaled");const{peerId:t,multiaddrs:n,seqNumber:i}=e;this.peerId=t,this.multiaddrs=n??[],this.seqNumber=i??BigInt(Date.now())}marshal(){return this.marshaled==null&&(this.marshaled=c3.encode({peerId:this.peerId.toMultihash().bytes,seq:BigInt(this.seqNumber),addresses:this.multiaddrs.map(e=>({multiaddr:e.bytes}))})),this.marshaled}equals(e){return!(!(e instanceof ca)||!this.peerId.equals(e.peerId)||this.seqNumber!==e.seqNumber||!rme(this.multiaddrs,e.multiaddrs))}};u(ca,"createFromProtobuf",e=>{const t=c3.decode(e),n=ei(vme(t.peerId)),i=(t.addresses??[]).map(o=>Oe(o.multiaddr)),s=t.seq;return new ca({peerId:n,multiaddrs:i,seqNumber:s})}),u(ca,"DOMAIN",Sme),u(ca,"CODEC",xme);let Vs=ca;function HL(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}var Ame=WL,qL=128,Cme=-128,Ime=Math.pow(2,31);function WL(r,e,t){e=e||[],t=t||0;for(var n=t;r>=Ime;)e[t++]=r&255|qL,r/=128;for(;r&Cme;)e[t++]=r&255|qL,r>>>=7;return e[t]=r|0,WL.bytes=t-n+1,e}var kme=j9,_me=128,GL=127;function j9(r,n){var t=0,n=n||0,i=0,s=n,o,a=r.length;do{if(s>=a)throw j9.bytes=0,new RangeError("Could not decode varint");o=r[s++],t+=i<28?(o&GL)<<i:(o&GL)*Math.pow(2,i),i+=7}while(o>=_me);return j9.bytes=s-n,t}var Tme=Math.pow(2,7),Pme=Math.pow(2,14),Dme=Math.pow(2,21),$me=Math.pow(2,28),Nme=Math.pow(2,35),Mme=Math.pow(2,42),Ome=Math.pow(2,49),Rme=Math.pow(2,56),Lme=Math.pow(2,63),Bme=function(r){return r<Tme?1:r<Pme?2:r<Dme?3:r<$me?4:r<Nme?5:r<Mme?6:r<Ome?7:r<Rme?8:r<Lme?9:10},Ume={encode:Ame,decode:kme,encodingLength:Bme},QL=Ume;function YL(r,e=0){return[QL.decode(r,e),QL.decode.bytes]}function Fme(r){const e=HL(r),[t,n]=YL(e),[i,s]=YL(e.subarray(n)),o=e.subarray(n+s);if(o.byteLength!==i)throw new Error("Incorrect length");return new zme(t,i,o,e)}let zme=class{constructor(e,t,n,i){u(this,"code");u(this,"size");u(this,"digest");u(this,"bytes");this.code=e,this.size=t,this.digest=n,this.bytes=i}};const Vme=290,Kme=1,JL=2e3,jme=100,l3=`${_2}-circuit-relay`;BigInt(1<<17);const u3="/libp2p/circuit/relay/0.2.0/hop",XL="/libp2p/circuit/relay/0.2.0/stop",ZL=300,Hme=4096,qme=.001;var eh;(function(r){(function(n){n.RESERVE="RESERVE",n.CONNECT="CONNECT",n.STATUS="STATUS"})(r.Type||(r.Type={}));let e;(function(n){n[n.RESERVE=0]="RESERVE",n[n.CONNECT=1]="CONNECT",n[n.STATUS=2]="STATUS"})(e||(e={})),function(n){n.codec=()=>In(e)}(r.Type||(r.Type={}));let t;r.codec=()=>(t==null&&(t=De((n,i,s={})=>{s.lengthDelimited!==!1&&i.fork(),n.type!=null&&(i.uint32(8),r.Type.codec().encode(n.type,i)),n.peer!=null&&(i.uint32(18),th.codec().encode(n.peer,i)),n.reservation!=null&&(i.uint32(26),d3.codec().encode(n.reservation,i)),n.limit!=null&&(i.uint32(34),rh.codec().encode(n.limit,i)),n.status!=null&&(i.uint32(40),hn.codec().encode(n.status,i)),s.lengthDelimited!==!1&&i.ldelim()},(n,i,s={})=>{var c,l,d;const o={},a=i==null?n.len:n.pos+i;for(;n.pos<a;){const h=n.uint32();switch(h>>>3){case 1:{o.type=r.Type.codec().decode(n);break}case 2:{o.peer=th.codec().decode(n,n.uint32(),{limits:(c=s.limits)==null?void 0:c.peer});break}case 3:{o.reservation=d3.codec().decode(n,n.uint32(),{limits:(l=s.limits)==null?void 0:l.reservation});break}case 4:{o.limit=rh.codec().decode(n,n.uint32(),{limits:(d=s.limits)==null?void 0:d.limit});break}case 5:{o.status=hn.codec().decode(n);break}default:{n.skipType(h&7);break}}}return o})),t),r.encode=n=>Pe(n,r.codec()),r.decode=(n,i)=>Te(n,r.codec(),i)})(eh||(eh={}));var Fo;(function(r){(function(n){n.CONNECT="CONNECT",n.STATUS="STATUS"})(r.Type||(r.Type={}));let e;(function(n){n[n.CONNECT=0]="CONNECT",n[n.STATUS=1]="STATUS"})(e||(e={})),function(n){n.codec=()=>In(e)}(r.Type||(r.Type={}));let t;r.codec=()=>(t==null&&(t=De((n,i,s={})=>{s.lengthDelimited!==!1&&i.fork(),n.type!=null&&(i.uint32(8),r.Type.codec().encode(n.type,i)),n.peer!=null&&(i.uint32(18),th.codec().encode(n.peer,i)),n.limit!=null&&(i.uint32(26),rh.codec().encode(n.limit,i)),n.status!=null&&(i.uint32(32),hn.codec().encode(n.status,i)),s.lengthDelimited!==!1&&i.ldelim()},(n,i,s={})=>{var c,l;const o={},a=i==null?n.len:n.pos+i;for(;n.pos<a;){const d=n.uint32();switch(d>>>3){case 1:{o.type=r.Type.codec().decode(n);break}case 2:{o.peer=th.codec().decode(n,n.uint32(),{limits:(c=s.limits)==null?void 0:c.peer});break}case 3:{o.limit=rh.codec().decode(n,n.uint32(),{limits:(l=s.limits)==null?void 0:l.limit});break}case 4:{o.status=hn.codec().decode(n);break}default:{n.skipType(d&7);break}}}return o})),t),r.encode=n=>Pe(n,r.codec()),r.decode=(n,i)=>Te(n,r.codec(),i)})(Fo||(Fo={}));var th;(function(r){let e;r.codec=()=>(e==null&&(e=De((t,n,i={})=>{if(i.lengthDelimited!==!1&&n.fork(),t.id!=null&&t.id.byteLength>0&&(n.uint32(10),n.bytes(t.id)),t.addrs!=null)for(const s of t.addrs)n.uint32(18),n.bytes(s);i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{var a;const s={id:We(0),addrs:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const c=t.uint32();switch(c>>>3){case 1:{s.id=t.bytes();break}case 2:{if(((a=i.limits)==null?void 0:a.addrs)!=null&&s.addrs.length===i.limits.addrs)throw new yt('Decode error - map field "addrs" had too many elements');s.addrs.push(t.bytes());break}default:{t.skipType(c&7);break}}}return s})),e),r.encode=t=>Pe(t,r.codec()),r.decode=(t,n)=>Te(t,r.codec(),n)})(th||(th={}));var d3;(function(r){let e;r.codec=()=>(e==null&&(e=De((t,n,i={})=>{if(i.lengthDelimited!==!1&&n.fork(),t.expire!=null&&t.expire!==0n&&(n.uint32(8),n.uint64(t.expire)),t.addrs!=null)for(const s of t.addrs)n.uint32(18),n.bytes(s);t.voucher!=null&&(n.uint32(26),f3.codec().encode(t.voucher,n)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{var a,c;const s={expire:0n,addrs:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 1:{s.expire=t.uint64();break}case 2:{if(((a=i.limits)==null?void 0:a.addrs)!=null&&s.addrs.length===i.limits.addrs)throw new yt('Decode error - map field "addrs" had too many elements');s.addrs.push(t.bytes());break}case 3:{s.voucher=f3.codec().decode(t,t.uint32(),{limits:(c=i.limits)==null?void 0:c.voucher});break}default:{t.skipType(l&7);break}}}return s})),e),r.encode=t=>Pe(t,r.codec()),r.decode=(t,n)=>Te(t,r.codec(),n)})(d3||(d3={}));var rh;(function(r){let e;r.codec=()=>(e==null&&(e=De((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.duration!=null&&(n.uint32(8),n.uint32(t.duration)),t.data!=null&&(n.uint32(16),n.uint64(t.data)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{const s={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.duration=t.uint32();break}case 2:{s.data=t.uint64();break}default:{t.skipType(a&7);break}}}return s})),e),r.encode=t=>Pe(t,r.codec()),r.decode=(t,n)=>Te(t,r.codec(),n)})(rh||(rh={}));var hn;(function(r){r.UNUSED="UNUSED",r.OK="OK",r.RESERVATION_REFUSED="RESERVATION_REFUSED",r.RESOURCE_LIMIT_EXCEEDED="RESOURCE_LIMIT_EXCEEDED",r.PERMISSION_DENIED="PERMISSION_DENIED",r.CONNECTION_FAILED="CONNECTION_FAILED",r.NO_RESERVATION="NO_RESERVATION",r.MALFORMED_MESSAGE="MALFORMED_MESSAGE",r.UNEXPECTED_MESSAGE="UNEXPECTED_MESSAGE"})(hn||(hn={}));var H9;(function(r){r[r.UNUSED=0]="UNUSED",r[r.OK=100]="OK",r[r.RESERVATION_REFUSED=200]="RESERVATION_REFUSED",r[r.RESOURCE_LIMIT_EXCEEDED=201]="RESOURCE_LIMIT_EXCEEDED",r[r.PERMISSION_DENIED=202]="PERMISSION_DENIED",r[r.CONNECTION_FAILED=203]="CONNECTION_FAILED",r[r.NO_RESERVATION=204]="NO_RESERVATION",r[r.MALFORMED_MESSAGE=400]="MALFORMED_MESSAGE",r[r.UNEXPECTED_MESSAGE=401]="UNEXPECTED_MESSAGE"})(H9||(H9={})),function(r){r.codec=()=>In(H9)}(hn||(hn={}));var h3;(function(r){let e;r.codec=()=>(e==null&&(e=De((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.relay!=null&&t.relay.byteLength>0&&(n.uint32(10),n.bytes(t.relay)),t.peer!=null&&t.peer.byteLength>0&&(n.uint32(18),n.bytes(t.peer)),t.expiration!=null&&t.expiration!==0n&&(n.uint32(24),n.uint64(t.expiration)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{const s={relay:We(0),peer:We(0),expiration:0n},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.relay=t.bytes();break}case 2:{s.peer=t.bytes();break}case 3:{s.expiration=t.uint64();break}default:{t.skipType(a&7);break}}}return s})),e),r.encode=t=>Pe(t,r.codec()),r.decode=(t,n)=>Te(t,r.codec(),n)})(h3||(h3={}));var f3;(function(r){let e;r.codec=()=>(e==null&&(e=De((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.publicKey!=null&&t.publicKey.byteLength>0&&(n.uint32(10),n.bytes(t.publicKey)),t.payloadType!=null&&t.payloadType.byteLength>0&&(n.uint32(18),n.bytes(t.payloadType)),t.payload!=null&&(n.uint32(26),h3.codec().encode(t.payload,n)),t.signature!=null&&t.signature.byteLength>0&&(n.uint32(42),n.bytes(t.signature)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{var a;const s={publicKey:We(0),payloadType:We(0),signature:We(0)},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const c=t.uint32();switch(c>>>3){case 1:{s.publicKey=t.bytes();break}case 2:{s.payloadType=t.bytes();break}case 3:{s.payload=h3.codec().decode(t,t.uint32(),{limits:(a=i.limits)==null?void 0:a.payload});break}case 5:{s.signature=t.bytes();break}default:{t.skipType(c&7);break}}}return s})),e),r.encode=t=>Pe(t,r.codec()),r.decode=(t,n)=>Te(t,r.codec(),n)})(f3||(f3={}));function Wme(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var i=0;i<r.length;i++){var s=r.charAt(i),o=s.charCodeAt(0);if(t[o]!==255)throw new TypeError(s+" is ambiguous");t[o]=i}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),d=Math.log(256)/Math.log(a);function h(f){if(f instanceof Uint8Array||(ArrayBuffer.isView(f)?f=new Uint8Array(f.buffer,f.byteOffset,f.byteLength):Array.isArray(f)&&(f=Uint8Array.from(f))),!(f instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(f.length===0)return"";for(var g=0,w=0,y=0,b=f.length;y!==b&&f[y]===0;)y++,g++;for(var v=(b-y)*d+1>>>0,E=new Uint8Array(v);y!==b;){for(var C=f[y],k=0,x=v-1;(C!==0||k<w)&&x!==-1;x--,k++)C+=256*E[x]>>>0,E[x]=C%a>>>0,C=C/a>>>0;if(C!==0)throw new Error("Non-zero carry");w=k,y++}for(var I=v-w;I!==v&&E[I]===0;)I++;for(var T=c.repeat(g);I<v;++I)T+=r.charAt(E[I]);return T}function p(f){if(typeof f!="string")throw new TypeError("Expected String");if(f.length===0)return new Uint8Array;var g=0;if(f[g]!==" "){for(var w=0,y=0;f[g]===c;)w++,g++;for(var b=(f.length-g)*l+1>>>0,v=new Uint8Array(b);f[g];){var E=t[f.charCodeAt(g)];if(E===255)return;for(var C=0,k=b-1;(E!==0||C<y)&&k!==-1;k--,C++)E+=a*v[k]>>>0,v[k]=E%256>>>0,E=E/256>>>0;if(E!==0)throw new Error("Non-zero carry");y=C,g++}if(f[g]!==" "){for(var x=b-y;x!==b&&v[x]===0;)x++;for(var I=new Uint8Array(w+(b-x)),T=w;x!==b;)I[T++]=v[x++];return I}}}function m(f){var g=p(f);if(g)return g;throw new Error(`Non-${e} character`)}return{encode:h,decodeUnsafe:p,decode:m}}var Gme=Wme,Qme=Gme;let Yme=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseEncode");this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},Jme=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseDecode");u(this,"prefixCodePoint");this.name=e,this.prefix=t;const i=t.codePointAt(0);if(i===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=i,this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return eB(this,e)}},Xme=class{constructor(e){u(this,"decoders");this.decoders=e}or(e){return eB(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};function eB(r,e){return new Xme({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}let Zme=class{constructor(e,t,n,i){u(this,"name");u(this,"prefix");u(this,"baseEncode");u(this,"baseDecode");u(this,"encoder");u(this,"decoder");this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=i,this.encoder=new Yme(e,t,n),this.decoder=new Jme(e,t,i)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};function tB({name:r,prefix:e,encode:t,decode:n}){return new Zme(r,e,t,n)}function p3({name:r,prefix:e,alphabet:t}){const{encode:n,decode:i}=Qme(t,r);return tB({prefix:e,name:r,encode:n,decode:s=>HL(i(s))})}function e3e(r,e,t,n){const i={};for(let d=0;d<e.length;++d)i[e[d]]=d;let s=r.length;for(;r[s-1]==="=";)--s;const o=new Uint8Array(s*t/8|0);let a=0,c=0,l=0;for(let d=0;d<s;++d){const h=i[r[d]];if(h===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|h,a+=t,a>=8&&(a-=8,o[l++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o}function t3e(r,e,t){const n=e[e.length-1]==="=",i=(1<<t)-1;let s="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,s+=e[i&a>>o];if(o!==0&&(s+=e[i&a<<t-o]),n)for(;s.length*t&7;)s+="=";return s}function zo({name:r,prefix:e,bitsPerChar:t,alphabet:n}){return tB({prefix:e,name:r,encode(i){return t3e(i,n,t)},decode(i){return e3e(i,n,t,r)}})}zo({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),zo({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),zo({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),zo({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),zo({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),zo({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),zo({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),zo({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),zo({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),p3({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),p3({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),p3({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),p3({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});class q9 extends Error{constructor(){super(...arguments);u(this,"name","HadEnoughRelaysError")}}u(q9,"name","HadEnoughRelaysError");class rB extends Error{constructor(){super(...arguments);u(this,"name","DoubleRelayError")}}u(rB,"name","DoubleRelayError");class nB extends Error{constructor(){super(...arguments);u(this,"name","RelayQueueFullError")}}u(nB,"name","RelayQueueFullError");function iB(r){const e=r*BigInt(1e3),t=new Date().getTime();return Number(e-BigInt(t))}class sB{constructor(e){u(this,"expires");u(this,"bytes");(e==null?void 0:e.duration)!=null&&(e==null?void 0:e.duration)!==0&&(this.expires=Date.now()+e.duration*1e3),this.bytes=e==null?void 0:e.data,this.bytes===0n&&(this.bytes=void 0),this.onData=this.onData.bind(this)}onData(e){this.bytes!=null&&(this.bytes-=BigInt(e.byteLength),this.bytes<0n&&(this.bytes=0n))}getLimits(){if(this.expires==null&&this.bytes==null)return;const e={};if(this.bytes!=null){const t=this;Object.defineProperty(e,"bytes",{get(){return t.bytes}})}if(this.expires!=null){const t=this;Object.defineProperty(e,"seconds",{get(){return Math.round(((t.expires??0)-Date.now())/1e3)}})}return e}}const oB=Ct(Xe(rO.matchers[0],Ge("p2p-circuit"))),aB=Ct(Ge("p2p-circuit"));function cB(r){const{stream:e,remoteAddr:t,logger:n,onDataRead:i,onDataWrite:s}=r,o=n.forComponent("libp2p:stream:converter");let a=!1,c=!1;const l=e.close.bind(e);e.close=async f=>{await l(f),m(!0)};const d=e.abort.bind(e);e.abort=f=>{d(f),m(!0)};const h=e.sink.bind(e);e.sink=async f=>{try{await h(cn(f,g=>sm(g,w=>s==null?void 0:s(w))))}catch(g){g.type!=="aborted"&&o.error("%s error in sink",t,g)}finally{c=!0,m()}};const p={log:o,sink:e.sink,source:async function*(){try{for await(const f of e.source)i==null||i(f),yield f}finally{a=!0,m()}}(),remoteAddr:t,timeline:{open:Date.now(),close:void 0},close:e.close,abort:e.abort};function m(f){f===!0&&(a=!0,c=!0),a&&c&&p.timeline.close==null&&(p.timeline.close=Date.now())}return p}class r3e extends er{constructor(t,n={}){super();u(this,"peerStore");u(this,"registrar");u(this,"connectionManager");u(this,"randomWalk");u(this,"started");u(this,"running");u(this,"topologyId");u(this,"log");u(this,"discoveryController");u(this,"filter");u(this,"queue");this.log=t.logger.forComponent("libp2p:circuit-relay:discover-relays"),this.started=!1,this.running=!1,this.peerStore=t.peerStore,this.registrar=t.registrar,this.connectionManager=t.connectionManager,this.randomWalk=t.randomWalk,this.filter=n.filter,this.discoveryController=new AbortController,this.discoveryController.signal}isStarted(){return this.started}async start(){this.topologyId=await this.registrar.register(u3,{filter:this.filter,onConnect:t=>{var n,i;this.log.trace("discovered relay %p queue (length: %d, active %d)",t,(n=this.queue)==null?void 0:n.size,(i=this.queue)==null?void 0:i.running),this.safeDispatchEvent("relay:discover",{detail:t})}}),this.started=!0}stop(){var t;this.topologyId!=null&&this.registrar.unregister(this.topologyId),(t=this.discoveryController)==null||t.abort(),this.started=!1}startDiscovery(){this.running||(this.log("start discovery"),this.running=!0,this.discoveryController=new AbortController,this.discoveryController.signal,Promise.resolve().then(async()=>{var i;this.log("searching peer store for relays");const t=await this.peerStore.all({filters:[s=>s.protocols.includes(u3)],orders:[()=>Math.random()<.5?1:-1,(s,o)=>{const a=lB(s),c=lB(o);return a>c?-1:c>a?1:0}]});for(const s of t)this.log.trace("found relay peer %p in peer store",s.id),this.safeDispatchEvent("relay:discover",{detail:s.id});this.log("found %d relay peers in peer store",t.length);const n=this.queue=new ic({concurrency:5});this.log("start random walk");for await(const s of this.randomWalk.walk({signal:this.discoveryController.signal})){if(this.log.trace("found random peer %p",s.id),n.has(s.id)){this.log.trace("random peer %p was already in queue",s.id);continue}if(((i=this.connectionManager.getConnections(s.id))==null?void 0:i.length)>0){this.log.trace("random peer %p was already connected",s.id);continue}if(!await this.connectionManager.isDialable(s.multiaddrs)){this.log.trace("random peer %p was not dialable",s.id,s.multiaddrs.map(o=>o.toString()));continue}n.queued>10&&(this.log.trace("wait for space in queue for %p",s.id),await n.onSizeLessThan(10,{signal:this.discoveryController.signal})),this.log("adding random peer %p to dial queue (length: %d, active %d)",s.id,n.size,n.running),n.add(async()=>{const o=ft([this.discoveryController.signal,AbortSignal.timeout(5e3)]);try{await this.connectionManager.openConnection(s.id,{signal:o})}finally{o.clear()}},{peerId:s.id,signal:this.discoveryController.signal}).catch(o=>{this.log.error("error opening connection to random peer %p",s.id,o)})}this.log("stop random walk"),await n.onIdle()}).catch(t=>{this.discoveryController.signal.aborted||this.log.error("failed when finding relays on the network",t)}))}stopDiscovery(){var t;this.log("stop discovery"),this.running=!1,(t=this.discoveryController)==null||t.abort()}}function lB(r){const e=r.metadata.get("last-dial-success");return e==null?0:new Date(re(e)).getTime()}class n3e extends er{constructor(t,n={}){super();u(this,"connectionManager");u(this,"addressManager");u(this,"reservationStore");u(this,"listeningAddrs");u(this,"log");u(this,"listenTimeout");u(this,"reservationId");u(this,"relay");u(this,"_onRemoveRelayPeer",t=>{var n,i;this.log("relay removed %p our relay %p",t.detail.relay,this.relay,(n=this.relay)==null?void 0:n.equals(t.detail.relay)),((i=this.relay)==null?void 0:i.equals(t.detail.relay))===!0&&(this.log("relay peer removed %p",t.detail.relay),this.listeningAddrs.forEach(s=>{this.addressManager.removeObservedAddr(s)}),this.listeningAddrs=[],this.safeDispatchEvent("listening"))});u(this,"_onAddRelayPeer",t=>{const{details:n}=t.detail;n.type!=="configured"&&n.id===this.reservationId&&this.addedRelay(t.detail)});this.log=t.logger.forComponent("libp2p:circuit-relay:transport:listener"),this.connectionManager=t.connectionManager,this.addressManager=t.addressManager,this.reservationStore=t.reservationStore,this.listeningAddrs=[],this.listenTimeout=n.listenTimeout??JL,this.reservationStore.addEventListener("relay:removed",this._onRemoveRelayPeer),this.reservationStore.addEventListener("relay:created-reservation",this._onAddRelayPeer)}async listen(t){if(aB.exactMatch(t))this.log("searching for circuit relay servers"),this.reservationId=this.reservationStore.reserveRelay();else if(oB.exactMatch(t)){this.log("listen on specific relay server %a",t);const n=AbortSignal.timeout(this.listenTimeout),i=t.decapsulate("/p2p-circuit"),s=await this.connectionManager.openConnection(i,{signal:n});if(!this.reservationStore.hasReservation(s.remotePeer)){this.log("making reservation on peer %p",s.remotePeer);const o=await this.reservationStore.addRelay(s.remotePeer,"configured");this.addedRelay(o)}}else throw new M2(`Could not listen on p2p-circuit address "${t}"`)}getAddrs(){return[...this.listeningAddrs.values()].flat()}updateAnnounceAddrs(){}async close(){this.reservationStore.cancelReservations(),this.listeningAddrs=[],this.reservationStore.removeEventListener("relay:removed",this._onRemoveRelayPeer),queueMicrotask(()=>{this.safeDispatchEvent("close")})}addedRelay(t){this.log("relay peer added %p",t.relay),this.relay=t.relay,this.listeningAddrs=t.details.reservation.addrs.map(n=>Oe(n).encapsulate("/p2p-circuit")),this.listeningAddrs.forEach(n=>{this.addressManager.confirmObservedAddr(n,{type:"transport"})}),queueMicrotask(()=>{this.safeDispatchEvent("listening")})}}function i3e(r){return new n3e(r)}const s3e="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";let o3e=(r=21)=>{let e="",t=crypto.getRandomValues(new Uint8Array(r|=0));for(;r--;)e+=s3e[t[r]&63];return e};const a3e=60*1e3*10,c3e=60*1e3*5,l3e=30*1e3;class u3e extends er{constructor(t,n){super();Ye(this,Fn);u(this,"peerId");u(this,"connectionManager");u(this,"peerStore");u(this,"events");u(this,"reserveQueue");u(this,"reservations");u(this,"pendingReservations");u(this,"maxReservationQueueLength");u(this,"reservationCompletionTimeout");u(this,"started");u(this,"log");u(this,"relayFilter");this.log=t.logger.forComponent("libp2p:circuit-relay:transport:reservation-store"),this.peerId=t.peerId,this.connectionManager=t.connectionManager,this.peerStore=t.peerStore,this.events=t.events,this.reservations=new sc,this.pendingReservations=[],this.maxReservationQueueLength=(n==null?void 0:n.maxReservationQueueLength)??jme,this.reservationCompletionTimeout=(n==null?void 0:n.reservationCompletionTimeout)??JL,this.started=!1,this.relayFilter=Ll(100),this.reserveQueue=new ic({concurrency:(n==null?void 0:n.reservationConcurrency)??Kme,metricName:"libp2p_relay_reservation_queue",metrics:t.metrics}),this.events.addEventListener("connection:close",i=>{[...this.reservations.values()].find(o=>o.connection===i.detail.id)!=null&&Ae(this,Fn,y0).call(this,i.detail.remotePeer).catch(o=>{this.log("could not remove relay %p - %e",i.detail,o)})})}isStarted(){return this.started}start(){this.started=!0}afterStart(){Promise.resolve().then(async()=>{const t=await this.peerStore.all({filters:[n=>n.tags.has(l3)]});this.log("removing tag from %d old relays",t.length),await Promise.all(t.map(async n=>{await this.peerStore.merge(n.id,{tags:{[l3]:void 0}})})),this.log("redialing %d old relays",t.length),await Promise.all(t.map(async n=>this.addRelay(n.id,"discovered"))),Ae(this,Fn,m0).call(this)}).catch(t=>{this.log.error(t)})}stop(){this.reserveQueue.clear(),this.reservations.forEach(({timeout:t})=>{clearTimeout(t)}),this.reservations.clear(),this.started=!1}reserveRelay(){const t=o3e();return this.pendingReservations.push(t),Ae(this,Fn,m0).call(this),t}async addRelay(t,n){if(this.peerId.equals(t))throw this.log.trace("not trying to use self as relay"),new M2("Cannot use self as relay");if(this.reserveQueue.size>this.maxReservationQueueLength)throw new nB("The reservation queue is full");const i=this.reserveQueue.find(t);if(i!=null)return this.log.trace("potential relay peer %p is already in the reservation queue",t),i.join();if(this.relayFilter.has(t.toMultihash().bytes))throw new M2("The relay was previously invalid");return this.log.trace("try to reserve relay slot with %p",t),this.reserveQueue.add(async()=>{const s=Date.now();try{const o=this.reservations.get(t);if(o!=null){const g=this.connectionManager.getConnections(t);let w=!1;if(g.length===0&&this.log("already have relay reservation with %p but we are no longer connected",t),g.map(y=>y.id).includes(o.connection)&&(this.log("already have relay reservation with %p and the original connection is still open",t),w=!0),w&&iB(o.reservation.expire)>a3e)return this.log("already have relay reservation with %p but we are still connected and it does not expire soon",t),{relay:t,details:o};await Ae(this,Fn,y0).call(this,t)}if(n==="discovered"&&this.pendingReservations.length===0)throw new q9("Not making reservation on discovered relay because we do not need any more relays");const a=AbortSignal.timeout(this.reservationCompletionTimeout);const c=await this.connectionManager.openConnection(t,{signal:a});if(gc.matches(c.remoteAddr))throw new rB("not creating reservation over relayed connection");const l=await Ae(this,Fn,eq).call(this,c,{signal:a}),d=iB(l.expire);this.log("created reservation on relay peer %p, expiry date is %s",t,new Date(Date.now()+d).toString());const h=Math.min(Math.max(d-c3e,l3e),Math.pow(2,31)-1),p=setTimeout(()=>{this.log("refresh reservation to relay %p",t),this.addRelay(t,n).catch(async g=>{this.log.error("could not refresh reservation to relay %p - %e",t,g),await Ae(this,Fn,y0).call(this,t)}).catch(g=>{this.log.error("could not remove expired reservation to relay %p - %e",t,g)})},h);let m;if(n==="discovered"){const g=this.pendingReservations.pop();if(g==null)throw new q9("Made reservation on relay but did not need any more discovered relays");m={timeout:p,reservation:l,type:n,connection:c.id,id:g}}else m={timeout:p,reservation:l,type:n,connection:c.id};this.reservations.set(t,m),await this.peerStore.merge(t,{tags:{[l3]:{value:1,ttl:d}}}),Ae(this,Fn,m0).call(this);const f={relay:t,details:m};return this.safeDispatchEvent("relay:created-reservation",{detail:f}),f}catch(o){throw n==="discovered"&&o.name==="HadEnoughRelaysError"||this.log.error("could not reserve slot on %p after %dms - %e",t,Date.now()-s,o),(o.name==="DialError"||o.name==="UnsupportedProtocolError")&&this.relayFilter.add(t.toMultihash().bytes),Ae(this,Fn,y0).call(this,t).catch(a=>{this.log.error("could not remove reservation on %p after reserving slot failed - %e",t,a)}),o}},{peerId:t})}hasReservation(t){return this.reservations.has(t)}getReservation(t){var n;return(n=this.reservations.get(t))==null?void 0:n.reservation}reservationCount(t){return t==null?this.reservations.size:[...this.reservations.values()].reduce((n,i)=>(i.type===t&&n++,n),0)}cancelReservations(){[...this.reservations.values()].forEach(t=>{clearTimeout(t.timeout)}),this.reservations.clear()}}Fn=new WeakSet,eq=async function(t,n){var l;(l=n.signal)==null||l.throwIfAborted(),this.log("requesting reservation from %p",t.remotePeer);const i=await t.newStream(u3,n),o=ci(i).pb(eh);this.log.trace("send RESERVE to %p",t.remotePeer),await o.write({type:eh.Type.RESERVE},n);let a;try{this.log.trace("reading response from %p",t.remotePeer),a=await o.read(n)}catch(d){throw i.abort(d),d}finally{i.status!=="closed"&&await i.close(n)}if(this.log.trace("read response %o",a),a.status===hn.OK&&a.reservation!=null){const d=new Set;d.add(t.remoteAddr.toString());for(const h of a.reservation.addrs){let p=Oe(h);p.getPeerId()==null&&(p=p.encapsulate(`/p2p/${t.remotePeer}`)),p=Oe(p.toString().replace(`/p2p/${t.remotePeer}/p2p/${t.remotePeer}`,`/p2p/${t.remotePeer}`)),d.add(p.toString())}return a.reservation.addrs=[...d].map(h=>Oe(h).bytes),a.reservation}const c=`reservation failed with status ${a.status??"undefined"}`;throw this.log.error(c),new Error(c)},y0=async function(t){const n=this.reservations.get(t);n!=null&&(this.log("removing relay reservation with %p from local store",t),clearTimeout(n.timeout),this.reservations.delete(t),n.type==="discovered"&&this.pendingReservations.push(n.id),await this.peerStore.merge(t,{tags:{[l3]:void 0}}),this.safeDispatchEvent("relay:removed",{detail:{relay:t,details:n}}),Ae(this,Fn,m0).call(this))},m0=function(){if(this.pendingReservations.length===0){this.log.trace("have discovered enough relays"),this.reserveQueue.clear(),this.safeDispatchEvent("relay:found-enough-relays");return}this.relayFilter=Ll(100),this.log("not discovered enough relays %d/%d",this.reservations.size,this.pendingReservations.length),this.safeDispatchEvent("relay:not-enough-relays")};const d3e=r=>{if(r.peer==null)return!1;try{r.peer.addrs.forEach(Oe)}catch{return!1}return!0},uB={maxInboundStopStreams:ZL,maxOutboundStopStreams:ZL};class h3e{constructor(e,t={}){u(this,"discovery");u(this,"registrar");u(this,"peerStore");u(this,"connectionManager");u(this,"transportManager");u(this,"peerId");u(this,"upgrader");u(this,"addressManager");u(this,"connectionGater");u(this,"reservationStore");u(this,"logger");u(this,"maxInboundStopStreams");u(this,"maxOutboundStopStreams");u(this,"started");u(this,"log");u(this,"shutdownController");u(this,Zj,"@libp2p/circuit-relay-v2-transport");u(this,Xj,["@libp2p/transport","@libp2p/circuit-relay-v2-transport"]);u(this,Yj,!0);this.log=e.logger.forComponent("libp2p:circuit-relay:transport"),this.registrar=e.registrar,this.peerStore=e.peerStore,this.connectionManager=e.connectionManager,this.transportManager=e.transportManager,this.logger=e.logger,this.peerId=e.peerId,this.upgrader=e.upgrader,this.addressManager=e.addressManager,this.connectionGater=e.connectionGater,this.maxInboundStopStreams=t.maxInboundStopStreams??uB.maxInboundStopStreams,this.maxOutboundStopStreams=t.maxOutboundStopStreams??uB.maxOutboundStopStreams,this.shutdownController=new AbortController,this.discovery=new r3e(e,{filter:t.discoveryFilter??Koe(Hme,qme)}),this.discovery.addEventListener("relay:discover",n=>{this.reservationStore.addRelay(n.detail,"discovered").catch(i=>{i.name!=="HadEnoughRelaysError"&&i.name!=="RelayQueueFullError"&&this.log.error("could not add discovered relay %p",n.detail,i)})}),this.reservationStore=new u3e(e,t),this.reservationStore.addEventListener("relay:not-enough-relays",()=>{var n;(n=this.discovery)==null||n.startDiscovery()}),this.reservationStore.addEventListener("relay:found-enough-relays",()=>{var n;(n=this.discovery)==null||n.stopDiscovery()}),this.started=!1}get[(Zj=Symbol.toStringTag,Xj=ur,Jj=ja,Yj=P2,Jj)](){return this.discovery!=null?["@libp2p/identify"]:[]}isStarted(){return this.started}async start(){this.shutdownController=new AbortController,await this.registrar.handle(XL,e=>{const t=this.upgrader.createInboundAbortSignal(this.shutdownController.signal);this.onStop(e,t).catch(n=>{this.log.error("error while handling STOP protocol",n),e.stream.abort(n)}).finally(()=>{t.clear()})},{maxInboundStreams:this.maxInboundStopStreams,maxOutboundStreams:this.maxOutboundStopStreams,runOnLimitedConnection:!0}),await xo(this.discovery,this.reservationStore),this.started=!0}async stop(){this.shutdownController.abort(),await Ka(this.discovery,this.reservationStore),await this.registrar.unhandle(XL),this.started=!1}async dial(e,t){var m,f,g,w,y,b;if(e.protoCodes().filter(v=>v===Vme).length!==1){const v="Invalid circuit relay address";throw this.log.error(v,e),new Ed(v)}const n=e.toString().split("/p2p-circuit"),i=Oe(n[0]),s=Oe(n[n.length-1]),o=i.getPeerId(),a=s.getPeerId();if(o==null||a==null){const v=`ircuit relay dial to ${e.toString()} failed as address did not have both relay and destination PeerIDs`;throw this.log.error(`c${v}`),new Ed(`C${v}`)}const c=tr(o),l=tr(a);let h=this.connectionManager.getConnections(c)[0];h==null?(await this.peerStore.merge(c,{multiaddrs:[i]}),(m=t.onProgress)==null||m.call(t,new ke("circuit-relay:open-connection")),h=await this.connectionManager.openConnection(c,t)):(f=t.onProgress)==null||f.call(t,new ke("circuit-relay:reuse-connection"));let p;try{(g=t.onProgress)==null||g.call(t,new ke("circuit-relay:open-hop-stream")),p=await h.newStream(u3,t);const v=ci(p),E=v.pb(eh);(w=t.onProgress)==null||w.call(t,new ke("circuit-relay:write-connect-message")),await E.write({type:eh.Type.CONNECT,peer:{id:l.toMultihash().bytes,addrs:[Oe(s).bytes]}},t),(y=t.onProgress)==null||y.call(t,new ke("circuit-relay:read-connect-response"));const C=await E.read(t);if(C.status!==hn.OK)throw new St(`failed to connect via relay with status ${((b=C==null?void 0:C.status)==null?void 0:b.toString())??"undefined"}`);const k=new sB(C.limit),x=cB({stream:v.unwrap(),remoteAddr:e,localAddr:i.encapsulate(`/p2p-circuit/p2p/${this.peerId.toString()}`),logger:this.logger,onDataRead:k.onData,onDataWrite:k.onData});return this.log("new outbound relayed connection %a",x.remoteAddr),await this.upgrader.upgradeOutbound(x,{...t,limits:k.getLimits()})}catch(v){throw this.log.error("circuit relay dial to destination %p via relay %p failed",l,c,v),p==null||p.abort(v),v}}createListener(e){return i3e({peerId:this.peerId,connectionManager:this.connectionManager,addressManager:this.addressManager,reservationStore:this.reservationStore,logger:this.logger})}listenFilter(e){return e=Array.isArray(e)?e:[e],e.filter(t=>oB.exactMatch(t)||aB.exactMatch(t))}dialFilter(e){return e=Array.isArray(e)?e:[e],e.filter(t=>gc.exactMatch(t))}async onStop({connection:e,stream:t},n){var d,h;if(!this.reservationStore.hasReservation(e.remotePeer))try{this.log("dialed via relay we did not have a reservation on, start listening on that relay address"),await this.transportManager.listen([e.remoteAddr.encapsulate("/p2p-circuit")])}catch(p){this.log.error("failed to listen on a relay peer we were dialed via but did not have a reservation on",p)}const i=ci(t).pb(Fo),s=await i.read({signal:n});if(this.log("new circuit relay v2 stop stream from %p with type %s",e.remotePeer,s.type),(s==null?void 0:s.type)===void 0){this.log.error("type was missing from circuit v2 stop protocol request from %s",e.remotePeer),await i.write({type:Fo.Type.STATUS,status:hn.MALFORMED_MESSAGE},{signal:n}),await t.close();return}if(s.type!==Fo.Type.CONNECT){this.log.error("invalid stop connect request via peer %p",e.remotePeer),await i.write({type:Fo.Type.STATUS,status:hn.UNEXPECTED_MESSAGE},{signal:n}),await t.close();return}if(!d3e(s)){this.log.error("invalid stop connect request via peer %p",e.remotePeer),await i.write({type:Fo.Type.STATUS,status:hn.MALFORMED_MESSAGE},{signal:n}),await t.close({signal:n});return}const o=ei(Fme(s.peer.id));if(await((h=(d=this.connectionGater).denyInboundRelayedConnection)==null?void 0:h.call(d,e.remotePeer,o))===!0){this.log.error("connection gater denied inbound relayed connection from %p",e.remotePeer),await i.write({type:Fo.Type.STATUS,status:hn.PERMISSION_DENIED},{signal:n}),await t.close({signal:n});return}this.log.trace("sending success response to %p",e.remotePeer),await i.write({type:Fo.Type.STATUS,status:hn.OK},{signal:n});const a=new sB(s.limit),c=e.remoteAddr.encapsulate(`/p2p-circuit/p2p/${o.toString()}`);this.addressManager.getAddresses()[0];const l=cB({stream:i.unwrap().unwrap(),remoteAddr:c,logger:this.logger,onDataRead:a.onData,onDataWrite:a.onData});this.log("new inbound relayed connection %a",l.remoteAddr),await this.upgrader.upgradeInbound(l,{limits:a.getLimits(),signal:n}),this.log("%s connection %a upgraded","inbound",l.remoteAddr)}}function W9(r={}){return e=>new h3e(e,r)}const dB=()=>{const r=new Error("Delay aborted");return r.name="AbortError",r},f3e=new WeakMap;function p3e({clearTimeout:r,setTimeout:e}={}){return(t,{value:n,signal:i}={})=>{if(i!=null&&i.aborted)return Promise.reject(dB());let s,o,a;const c=r??clearTimeout,l=()=>{c(s),a(dB())},d=()=>{i&&i.removeEventListener("abort",l)},h=new Promise((p,m)=>{o=()=>{d(),p(n)},a=m,s=(e??setTimeout)(o,t)});return i&&i.addEventListener("abort",l,{once:!0}),f3e.set(h,()=>{c(s),s=null,o()}),h}}const hB=p3e();var Ks;(function(r){(function(n){n.UNUSED="UNUSED",n.CONNECT="CONNECT",n.SYNC="SYNC"})(r.Type||(r.Type={}));let e;(function(n){n[n.UNUSED=0]="UNUSED",n[n.CONNECT=100]="CONNECT",n[n.SYNC=300]="SYNC"})(e||(e={})),function(n){n.codec=()=>In(e)}(r.Type||(r.Type={}));let t;r.codec=()=>(t==null&&(t=De((n,i,s={})=>{if(s.lengthDelimited!==!1&&i.fork(),n.type!=null&&(i.uint32(8),r.Type.codec().encode(n.type,i)),n.observedAddresses!=null)for(const o of n.observedAddresses)i.uint32(18),i.bytes(o);s.lengthDelimited!==!1&&i.ldelim()},(n,i,s={})=>{var c;const o={observedAddresses:[]},a=i==null?n.len:n.pos+i;for(;n.pos<a;){const l=n.uint32();switch(l>>>3){case 1:{o.type=r.Type.codec().decode(n);break}case 2:{if(((c=s.limits)==null?void 0:c.observedAddresses)!=null&&o.observedAddresses.length===s.limits.observedAddresses)throw new yt('Decode error - map field "observedAddresses" had too many elements');o.observedAddresses.push(n.bytes());break}default:{n.skipType(l&7);break}}}return o})),t),r.encode=n=>Pe(n,r.codec()),r.decode=(n,i)=>Te(n,r.codec(),i)})(Ks||(Ks={}));function fB(r,e){return gc.matches(r)||e.dialTransportForMultiaddr(r)==null?!1:qM.matches(r)?!0:fhe.matches(r)?pc(r.toOptions().host)===!1:!1}const pB=1024*4,gB=100,g3={timeout:5e3,retries:3,maxInboundStreams:1,maxOutboundStreams:1};tH=Symbol.toStringTag,eH=ja;class g3e{constructor(e,t){u(this,"started");u(this,"timeout");u(this,"retries");u(this,"maxInboundStreams");u(this,"maxOutboundStreams");u(this,"peerStore");u(this,"registrar");u(this,"connectionManager");u(this,"addressManager");u(this,"transportManager");u(this,"topologyId");u(this,"log");u(this,tH,"@libp2p/dcutr");u(this,eH,["@libp2p/identify"]);this.log=e.logger.forComponent("libp2p:dcutr"),this.started=!1,this.peerStore=e.peerStore,this.registrar=e.registrar,this.addressManager=e.addressManager,this.connectionManager=e.connectionManager,this.transportManager=e.transportManager,this.timeout=t.timeout??g3.timeout,this.retries=t.retries??g3.retries,this.maxInboundStreams=t.maxInboundStreams??g3.maxInboundStreams,this.maxOutboundStreams=t.maxOutboundStreams??g3.maxOutboundStreams}isStarted(){return this.started}async start(){this.started||(this.topologyId=await this.registrar.register(y3,{notifyOnLimitedConnection:!0,onConnect:(e,t)=>{gc.exactMatch(t.remoteAddr)&&t.direction==="inbound"&&this.upgradeInbound(t).catch(n=>{this.log.error("error during outgoing DCUtR attempt",n)})}}),await this.registrar.handle(y3,e=>{this.handleIncomingUpgrade(e.stream,e.connection).catch(t=>{this.log.error("error during incoming DCUtR attempt",t),e.stream.abort(t)})},{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:!0}),this.started=!0)}async stop(){await this.registrar.unhandle(y3),this.topologyId!=null&&this.registrar.unregister(this.topologyId),this.started=!1}async upgradeInbound(e){if(await this.attemptUnilateralConnectionUpgrade(e))return;let t;for(let n=0;n<this.retries;n++){const i={signal:AbortSignal.timeout(this.timeout)};try{t=await e.newStream([y3],{signal:i.signal,runOnLimitedConnection:!0});const s=ci(t,{maxDataLength:pB}).pb(Ks);this.log("B sending connect to %p",e.remotePeer);const o=Date.now();await s.write({type:Ks.Type.CONNECT,observedAddresses:this.addressManager.getAddresses().map(h=>h.bytes)},i),this.log("B receiving connect from %p",e.remotePeer);const a=await s.read(i);if(a.type!==Ks.Type.CONNECT)throw this.log("A sent wrong message type"),new St("DCUtR message type was incorrect");const c=this.getDialableMultiaddrs(a.observedAddresses);if(c.length===0)throw this.log("A did not have any dialable multiaddrs"),new St("DCUtR connect message had no multiaddrs");const l=Date.now()-o;this.log("A sending sync, rtt %dms",l),await s.write({type:Ks.Type.SYNC,observedAddresses:[]},i),this.log("A waiting for half RTT"),await hB(l/2),this.log("B dialing",c);const d=await this.connectionManager.openConnection(c,{signal:i.signal,priority:gB,force:!0,initiator:!1});this.log("DCUtR to %p succeeded to address %a, closing relayed connection",e.remotePeer,d.remoteAddr),await e.close(i);break}catch(s){if(this.log.error("error while attempting DCUtR on attempt %d of %d",n+1,this.retries,s),t==null||t.abort(s),n===this.retries)throw s}finally{t!=null&&await t.close(i)}}}async attemptUnilateralConnectionUpgrade(e){const n=(await this.peerStore.get(e.remotePeer)).addresses.map(i=>{const s=i.multiaddr;return s.getPeerId()==null?s.encapsulate(`/p2p/${e.remotePeer}`):s}).filter(i=>fB(i,this.transportManager));if(n.length>0){const i=AbortSignal.timeout(this.timeout);try{this.log("attempting unilateral connection upgrade to %a",n);const s=await this.connectionManager.openConnection(n,{signal:i,force:!0});if(gc.exactMatch(s.remoteAddr))throw new Error("Could not open a new, non-limited, connection");return this.log("unilateral connection upgrade to %p succeeded via %a, closing relayed connection",e.remotePeer,s.remoteAddr),await e.close({signal:i}),!0}catch(s){this.log.error("unilateral connection upgrade to %p on addresses %a failed",e.remotePeer,n,s)}}else this.log("peer %p has no public addresses, not attempting unilateral connection upgrade",e.remotePeer);return!1}async handleIncomingUpgrade(e,t){const n={signal:AbortSignal.timeout(this.timeout)};try{const i=ci(e,{maxDataLength:pB}).pb(Ks);this.log("A receiving connect");const s=await i.read(n);if(s.type!==Ks.Type.CONNECT)throw this.log("B sent wrong message type"),new St("DCUtR message type was incorrect");if(s.observedAddresses.length===0)throw this.log("B sent no multiaddrs"),new St("DCUtR connect message had no multiaddrs");const o=this.getDialableMultiaddrs(s.observedAddresses);if(o.length===0)throw this.log("B had no dialable multiaddrs"),new St("DCUtR connect message had no dialable multiaddrs");if(this.log("A sending connect"),await i.write({type:Ks.Type.CONNECT,observedAddresses:this.addressManager.getAddresses().map(l=>l.bytes)}),this.log("A receiving sync"),(await i.read(n)).type!==Ks.Type.SYNC)throw new St("DCUtR message type was incorrect");this.log("A dialing",o);const c=await this.connectionManager.openConnection(o,{signal:n.signal,priority:gB,force:!0});this.log("DCUtR to %p succeeded via %a, closing relayed connection",t.remotePeer,c.remoteAddr),await t.close(n)}catch(i){this.log.error("incoming DCUtR from %p failed",t.remotePeer,i),e.abort(i)}finally{await e.close(n)}}getDialableMultiaddrs(e){const t=[];for(const n of e)if(!(n==null||n.length===0))try{const i=Oe(n);if(!fB(i,this.transportManager))continue;t.push(i)}catch{}return t}}const y3="/libp2p/dcutr";function y3e(r={}){return e=>new g3e(e,r)}const m3=globalThis.CustomEvent??Event;async function*lp(r,e={}){let t=e.concurrency??1/0;t<1&&(t=1/0);const n=e.ordered??!1,i=new EventTarget,s=[];let o=Re(),a=Re(),c=!1,l,d=!1;i.addEventListener("task-complete",()=>{a.resolve()}),Promise.resolve().then(async()=>{try{for await(const f of r){if(s.length===t&&(o=Re(),await o.promise),d)break;const g={done:!1};s.push(g),f().then(w=>{g.done=!0,g.ok=!0,g.value=w,i.dispatchEvent(new m3("task-complete"))},w=>{g.done=!0,g.err=w,i.dispatchEvent(new m3("task-complete"))})}c=!0,i.dispatchEvent(new m3("task-complete"))}catch(f){l=f,i.dispatchEvent(new m3("task-complete"))}});function h(){var f;return n?(f=s[0])==null?void 0:f.done:!!s.find(g=>g.done)}function*p(){for(;s.length>0&&s[0].done;){const f=s[0];if(s.shift(),f.ok)yield f.value;else throw d=!0,o.resolve(),f.err;o.resolve()}}function*m(){for(;h();)for(let f=0;f<s.length;f++)if(s[f].done){const g=s[f];if(s.splice(f,1),f--,g.ok)yield g.value;else throw d=!0,o.resolve(),g.err;o.resolve()}}for(;;){if(h()||(a=Re(),await a.promise),l!=null)throw l;if(n?yield*p():yield*m(),c&&s.length===0)break}}const m3e="0.1.0",w3e="id",b3e="id/push",v3e="1.0.0",E3e="1.0.0",S3e=1024*8,x3e=32;var nh;(function(r){let e;r.codec=()=>(e==null&&(e=De((t,n,i={})=>{if(i.lengthDelimited!==!1&&n.fork(),t.protocolVersion!=null&&(n.uint32(42),n.string(t.protocolVersion)),t.agentVersion!=null&&(n.uint32(50),n.string(t.agentVersion)),t.publicKey!=null&&(n.uint32(10),n.bytes(t.publicKey)),t.listenAddrs!=null)for(const s of t.listenAddrs)n.uint32(18),n.bytes(s);if(t.observedAddr!=null&&(n.uint32(34),n.bytes(t.observedAddr)),t.protocols!=null)for(const s of t.protocols)n.uint32(26),n.string(s);t.signedPeerRecord!=null&&(n.uint32(66),n.bytes(t.signedPeerRecord)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{var a,c;const s={listenAddrs:[],protocols:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const l=t.uint32();switch(l>>>3){case 5:{s.protocolVersion=t.string();break}case 6:{s.agentVersion=t.string();break}case 1:{s.publicKey=t.bytes();break}case 2:{if(((a=i.limits)==null?void 0:a.listenAddrs)!=null&&s.listenAddrs.length===i.limits.listenAddrs)throw new yt('Decode error - map field "listenAddrs" had too many elements');s.listenAddrs.push(t.bytes());break}case 4:{s.observedAddr=t.bytes();break}case 3:{if(((c=i.limits)==null?void 0:c.protocols)!=null&&s.protocols.length===i.limits.protocols)throw new yt('Decode error - map field "protocols" had too many elements');s.protocols.push(t.string());break}case 8:{s.signedPeerRecord=t.bytes();break}default:{t.skipType(l&7);break}}}return s})),e),r.encode=t=>Pe(t,r.codec()),r.decode=(t,n)=>Te(t,r.codec(),n)})(nh||(nh={}));const Ti={protocolPrefix:"ipfs",timeout:5e3,maxInboundStreams:1,maxOutboundStreams:1,maxObservedAddresses:10,maxMessageSize:S3e,runOnConnectionOpen:!0,runOnSelfUpdate:!0,runOnLimitedConnection:!0,concurrency:x3e};function A3e(r){if(r!=null&&r.length>0)try{return Oe(r)}catch{}}function C3e(r,e){return e??r.userAgent}async function yB(r,e,t,n,i){if(t("received identify from %p",n.remotePeer),i==null)throw new St("message was null or undefined");const s={};if(i.listenAddrs.length>0&&(s.addresses=i.listenAddrs.map(c=>({isCertified:!1,multiaddr:Oe(c)}))),i.protocols.length>0&&(s.protocols=i.protocols),i.publicKey!=null){const c=kn(i.publicKey);if(!Bd(c).equals(n.remotePeer))throw new St("public key did not match remote PeerId");s.publicKey=c}let o;if(i.signedPeerRecord!=null){t.trace("received signedPeerRecord from %p",n.remotePeer);let c=i.signedPeerRecord;const l=await Cc.openAndCertify(c,Vs.DOMAIN);let d=Vs.createFromProtobuf(l.payload);const h=Ud(l.publicKey.toCID());if(!d.peerId.equals(h))throw new St("signing key does not match PeerId in the PeerRecord");if(!n.remotePeer.equals(d.peerId))throw new St("signing key does not match remote PeerId");let p;try{p=await r.get(d.peerId)}catch(m){if(m.name!=="NotFoundError")throw m}if(p!=null&&(s.metadata=p.metadata,p.peerRecordEnvelope!=null)){const m=await Cc.createFromProtobuf(p.peerRecordEnvelope),f=Vs.createFromProtobuf(m.payload);f.seqNumber>=d.seqNumber&&(t("sequence number was lower or equal to existing sequence number - stored: %d received: %d",f.seqNumber,d.seqNumber),d=f,c=p.peerRecordEnvelope)}s.peerRecordEnvelope=c,s.addresses=d.multiaddrs.map(m=>({isCertified:!0,multiaddr:m})),o={seq:d.seqNumber,addresses:d.multiaddrs}}else t("%p did not send a signed peer record",n.remotePeer);if(t.trace("patching %p with",n.remotePeer,s),await r.patch(n.remotePeer,s),i.agentVersion!=null||i.protocolVersion!=null){const c={};i.agentVersion!=null&&(c.AgentVersion=ie(i.agentVersion)),i.protocolVersion!=null&&(c.ProtocolVersion=ie(i.protocolVersion)),t.trace("merging %p metadata",n.remotePeer,c),await r.merge(n.remotePeer,{metadata:c})}const a={peerId:n.remotePeer,protocolVersion:i.protocolVersion,agentVersion:i.agentVersion,publicKey:i.publicKey,listenAddrs:i.listenAddrs.map(c=>Oe(c)),observedAddr:i.observedAddr==null?void 0:Oe(i.observedAddr),protocols:i.protocols,signedPeerRecord:o,connection:n};return e.safeDispatchEvent("peer:identify",{detail:a}),a}class mB{constructor(e,t){u(this,"host");u(this,"protocol");u(this,"started");u(this,"timeout");u(this,"peerId");u(this,"privateKey");u(this,"peerStore");u(this,"registrar");u(this,"addressManager");u(this,"maxInboundStreams");u(this,"maxOutboundStreams");u(this,"maxMessageSize");u(this,"maxObservedAddresses");u(this,"events");u(this,"runOnLimitedConnection");u(this,"log");this.protocol=t.protocol,this.started=!1,this.peerId=e.peerId,this.privateKey=e.privateKey,this.peerStore=e.peerStore,this.registrar=e.registrar,this.addressManager=e.addressManager,this.events=e.events,this.log=t.log,this.timeout=t.timeout??Ti.timeout,this.maxInboundStreams=t.maxInboundStreams??Ti.maxInboundStreams,this.maxOutboundStreams=t.maxOutboundStreams??Ti.maxOutboundStreams,this.maxMessageSize=t.maxMessageSize??Ti.maxMessageSize,this.maxObservedAddresses=t.maxObservedAddresses??Ti.maxObservedAddresses,this.runOnLimitedConnection=t.runOnLimitedConnection??Ti.runOnLimitedConnection,this.host={protocolVersion:`${t.protocolPrefix??Ti.protocolPrefix}/${m3e}`,agentVersion:C3e(e.nodeInfo,t.agentVersion)}}isStarted(){return this.started}async start(){this.started||(await this.peerStore.merge(this.peerId,{metadata:{AgentVersion:ie(this.host.agentVersion),ProtocolVersion:ie(this.host.protocolVersion)}}),await this.registrar.handle(this.protocol,e=>{this.handleProtocol(e).catch(t=>{this.log.error(t)})},{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:this.runOnLimitedConnection}),this.started=!0)}async stop(){await this.registrar.unhandle(this.protocol),this.started=!1}}class I3e extends(nH=mB,rH=ur,nH){constructor(t,n={}){super(t,{...n,protocol:`/${n.protocolPrefix??Ti.protocolPrefix}/${b3e}/${E3e}`,log:t.logger.forComponent("libp2p:identify-push")});u(this,"connectionManager");u(this,"concurrency");u(this,rH,["@libp2p/identify-push"]);this.connectionManager=t.connectionManager,this.concurrency=n.concurrency??Ti.concurrency,(n.runOnSelfUpdate??Ti.runOnSelfUpdate)&&t.events.addEventListener("self:peer:update",i=>{this.push().catch(s=>{this.log.error(s)})})}async push(){if(!this.isStarted())return;const t=this.addressManager.getAddresses().map(h=>h.decapsulateCode(ze("p2p").code)),n=new Vs({peerId:this.peerId,multiaddrs:t}),i=await Cc.seal(n,this.privateKey),s=this.registrar.getProtocols(),o=await this.peerStore.get(this.peerId),a=re(o.metadata.get("AgentVersion")??ie(this.host.agentVersion)),c=re(o.metadata.get("ProtocolVersion")??ie(this.host.protocolVersion)),l=this;async function*d(){for(const h of l.connectionManager.getConnections())(await l.peerStore.get(h.remotePeer)).protocols.includes(l.protocol)&&(yield async()=>{let m;const f=AbortSignal.timeout(l.timeout);try{m=await h.newStream(l.protocol,{signal:f,runOnLimitedConnection:l.runOnLimitedConnection}),await ci(m,{maxDataLength:l.maxMessageSize}).pb(nh).write({listenAddrs:t.map(w=>w.bytes),signedPeerRecord:i.marshal(),protocols:s,agentVersion:a,protocolVersion:c},{signal:f}),await m.close({signal:f})}catch(g){l.log.error("could not push identify update to peer",g),m==null||m.abort(g)}})}await mo(lp(d(),{concurrency:this.concurrency}))}async handleProtocol(t){const{connection:n,stream:i}=t;try{if(this.peerId.equals(n.remotePeer))throw new Error("received push from ourselves?");const s={signal:AbortSignal.timeout(this.timeout)},a=await ci(i,{maxDataLength:this.maxMessageSize}).pb(nh).read(s);await i.close(s),await yB(this.peerStore,this.events,this.log,n,a)}catch(s){this.log.error("received invalid message",s),i.abort(s);return}this.log.trace("handled push from %p",n.remotePeer)}}const k3e=41;class _3e extends(sH=mB,iH=ur,sH){constructor(t,n={}){super(t,{...n,protocol:`/${n.protocolPrefix??Ti.protocolPrefix}/${w3e}/${v3e}`,log:t.logger.forComponent("libp2p:identify")});u(this,iH,["@libp2p/identify"]);(n.runOnConnectionOpen??Ti.runOnConnectionOpen)&&t.events.addEventListener("connection:open",i=>{const s=i.detail;this.identify(s).catch(o=>{o.name!==h1.name&&this.log.error("error during identify trigged by connection:open",o)})})}async _identify(t,n={}){let i;if(n.signal==null){const s=AbortSignal.timeout(this.timeout);n={...n,signal:s}}try{i=await t.newStream(this.protocol,{...n,runOnLimitedConnection:this.runOnLimitedConnection});const o=await ci(i,{maxDataLength:this.maxMessageSize}).pb(nh).read(n);return await i.close(n),o}catch(s){throw i==null||i.abort(s),s}}async identify(t,n={}){const i=await this._identify(t,n),{publicKey:s,protocols:o,observedAddr:a}=i;if(s==null)throw new St("public key was missing from identify message");const c=kn(s),l=Ud(c.toCID());if(!t.remotePeer.equals(l))throw new St("identified peer does not match the expected peer");if(this.peerId.equals(l))throw new St("identified peer is our own peer id?");return this.maybeAddObservedAddress(a),this.log("identify completed for peer %p and protocols %o",l,o),yB(this.peerStore,this.events,this.log,t,i)}maybeAddObservedAddress(t){const n=A3e(t);if(n==null)return;if(this.log.trace("our observed address was %a",n),ql(n)){this.log.trace("our observed address was private");return}if(n.stringTuples()[0][0]===k3e&&!SL(n)){this.log.trace("our observed address was IPv6 but not a global unicast address");return}fm.exactMatch(n)||(this.log.trace("storing the observed address"),this.addressManager.addObservedAddr(n))}async handleProtocol(t){const{connection:n,stream:i}=t,s=AbortSignal.timeout(this.timeout);try{const o=await this.peerStore.get(this.peerId),a=this.addressManager.getAddresses().map(h=>h.decapsulateCode(ze("p2p").code));let c=o.peerRecordEnvelope;if(a.length>0&&c==null){const h=new Vs({peerId:this.peerId,multiaddrs:a});c=(await Cc.seal(h,this.privateKey)).marshal().subarray()}let l=n.remoteAddr.bytes;hhe.matches(n.remoteAddr)||(l=void 0),await ci(i).pb(nh).write({protocolVersion:this.host.protocolVersion,agentVersion:this.host.agentVersion,publicKey:ki(this.privateKey.publicKey),listenAddrs:a.map(h=>h.bytes),signedPeerRecord:c,observedAddr:l,protocols:o.protocols},{signal:s}),await i.close({signal:s})}catch(o){this.log.error("could not respond to identify request",o),i.abort(o)}}}function G9(r={}){return e=>new _3e(e,r)}function T3e(r={}){return e=>new I3e(e,r)}const up=1e3,Q9=60*up,w3=60*Q9,P3e=36*w3,D3e="/ipfs/kad/1.0.0",$3e=48*w3,N3e=24*w3,M3e=10,O3e=16384,R3e=w3,wB=20,Y9=3,L3e=5*Q9,B3e=up,U3e=5*up,F3e=5*Q9,z3e=30*up,V3e=180*up,bB=`${_2}-kad-dht`;var b3;(function(r){let e;r.codec=()=>(e==null&&(e=De((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.key!=null&&t.key.byteLength>0&&(n.uint32(10),n.bytes(t.key)),t.value!=null&&t.value.byteLength>0&&(n.uint32(18),n.bytes(t.value)),t.timeReceived!=null&&t.timeReceived!==""&&(n.uint32(42),n.string(t.timeReceived)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{const s={key:We(0),value:We(0),timeReceived:""},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.key=t.bytes();break}case 2:{s.value=t.bytes();break}case 5:{s.timeReceived=t.string();break}default:{t.skipType(a&7);break}}}return s})),e),r.encode=t=>Pe(t,r.codec()),r.decode=(t,n)=>Te(t,r.codec(),n)})(b3||(b3={}));function K3e(r){const e=r.getUTCFullYear(),t=String(r.getUTCMonth()+1).padStart(2,"0"),n=String(r.getUTCDate()).padStart(2,"0"),i=String(r.getUTCHours()).padStart(2,"0"),s=String(r.getUTCMinutes()).padStart(2,"0"),o=String(r.getUTCSeconds()).padStart(2,"0"),a=r.getUTCMilliseconds(),c=String(a*1e3*1e3).padStart(9,"0");return`${e}-${t}-${n}T${i}:${s}:${o}.${c}Z`}function j3e(r){const e=new RegExp("(\\d{4})-(\\d{2})-(\\d{2})T(\\d{2}):(\\d{2}):(\\d{2})\\.(\\d+)Z"),t=String(r).trim().match(e);if(t==null)throw new Error("Invalid format");const n=parseInt(t[1],10),i=parseInt(t[2],10)-1,s=parseInt(t[3],10),o=parseInt(t[4],10),a=parseInt(t[5],10),c=parseInt(t[6],10),l=parseInt(t[7].slice(0,-6),10);return new Date(Date.UTC(n,i,s,o,a,c,l))}class Pi{constructor(e,t,n){u(this,"key");u(this,"value");u(this,"timeReceived");if(!(e instanceof Uint8Array))throw new Error("key must be a Uint8Array");if(!(t instanceof Uint8Array))throw new Error("value must be a Uint8Array");this.key=e,this.value=t,this.timeReceived=n}serialize(){return b3.encode(this.prepareSerialize())}prepareSerialize(){return{key:this.key,value:this.value,timeReceived:K3e(this.timeReceived)}}static deserialize(e){const t=b3.decode(e);return new Pi(t.key,t.value,new Date(t.timeReceived))}static fromDeserialized(e){const t=j3e(e.timeReceived);if(e.key==null)throw new Error("key missing from deserialized object");if(e.value==null)throw new Error("value missing from deserialized object");return new Pi(e.key,e.value,t)}}class v3 extends Error{constructor(e="Query error"){super(e),this.name="QueryError"}}class H3e extends Error{constructor(e="Query aborted"){super(e),this.name="QueryAbortedError"}}class q3e extends Error{constructor(e="Invalid record"){super(e),this.name="InvalidRecordError"}}class W3e extends Error{constructor(e="No selector function configured for prefix"){super(e),this.name="MissingSelectorError"}}var vB;(function(r){let e;r.codec=()=>(e==null&&(e=De((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.key!=null&&(n.uint32(10),n.bytes(t.key)),t.value!=null&&(n.uint32(18),n.bytes(t.value)),t.author!=null&&(n.uint32(26),n.bytes(t.author)),t.signature!=null&&(n.uint32(34),n.bytes(t.signature)),t.timeReceived!=null&&(n.uint32(42),n.string(t.timeReceived)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{const s={},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.key=t.bytes();break}case 2:{s.value=t.bytes();break}case 3:{s.author=t.bytes();break}case 4:{s.signature=t.bytes();break}case 5:{s.timeReceived=t.string();break}default:{t.skipType(a&7);break}}}return s})),e),r.encode=t=>Pe(t,r.codec()),r.decode=(t,n)=>Te(t,r.codec(),n)})(vB||(vB={}));var It;(function(r){r.PUT_VALUE="PUT_VALUE",r.GET_VALUE="GET_VALUE",r.ADD_PROVIDER="ADD_PROVIDER",r.GET_PROVIDERS="GET_PROVIDERS",r.FIND_NODE="FIND_NODE",r.PING="PING"})(It||(It={}));var E3;(function(r){r[r.PUT_VALUE=0]="PUT_VALUE",r[r.GET_VALUE=1]="GET_VALUE",r[r.ADD_PROVIDER=2]="ADD_PROVIDER",r[r.GET_PROVIDERS=3]="GET_PROVIDERS",r[r.FIND_NODE=4]="FIND_NODE",r[r.PING=5]="PING"})(E3||(E3={})),function(r){r.codec=()=>In(E3)}(It||(It={}));var ih;(function(r){r.NOT_CONNECTED="NOT_CONNECTED",r.CONNECTED="CONNECTED",r.CAN_CONNECT="CAN_CONNECT",r.CANNOT_CONNECT="CANNOT_CONNECT"})(ih||(ih={}));var J9;(function(r){r[r.NOT_CONNECTED=0]="NOT_CONNECTED",r[r.CONNECTED=1]="CONNECTED",r[r.CAN_CONNECT=2]="CAN_CONNECT",r[r.CANNOT_CONNECT=3]="CANNOT_CONNECT"})(J9||(J9={})),function(r){r.codec=()=>In(J9)}(ih||(ih={}));var sh;(function(r){let e;r.codec=()=>(e==null&&(e=De((t,n,i={})=>{if(i.lengthDelimited!==!1&&n.fork(),t.id!=null&&t.id.byteLength>0&&(n.uint32(10),n.bytes(t.id)),t.multiaddrs!=null)for(const s of t.multiaddrs)n.uint32(18),n.bytes(s);t.connection!=null&&(n.uint32(24),ih.codec().encode(t.connection,n)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{var a;const s={id:We(0),multiaddrs:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const c=t.uint32();switch(c>>>3){case 1:{s.id=t.bytes();break}case 2:{if(((a=i.limits)==null?void 0:a.multiaddrs)!=null&&s.multiaddrs.length===i.limits.multiaddrs)throw new yt('Decode error - map field "multiaddrs" had too many elements');s.multiaddrs.push(t.bytes());break}case 3:{s.connection=ih.codec().decode(t);break}default:{t.skipType(c&7);break}}}return s})),e),r.encode=t=>Pe(t,r.codec()),r.decode=(t,n)=>Te(t,r.codec(),n)})(sh||(sh={}));var Yl;(function(r){let e;r.codec=()=>(e==null&&(e=De((t,n,i={})=>{if(i.lengthDelimited!==!1&&n.fork(),t.type!=null&&E3[t.type]!==0&&(n.uint32(8),It.codec().encode(t.type,n)),t.clusterLevel!=null&&(n.uint32(80),n.int32(t.clusterLevel)),t.key!=null&&(n.uint32(18),n.bytes(t.key)),t.record!=null&&(n.uint32(26),n.bytes(t.record)),t.closer!=null)for(const s of t.closer)n.uint32(66),sh.codec().encode(s,n);if(t.providers!=null)for(const s of t.providers)n.uint32(74),sh.codec().encode(s,n);i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{var a,c,l,d;const s={type:It.PUT_VALUE,closer:[],providers:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const h=t.uint32();switch(h>>>3){case 1:{s.type=It.codec().decode(t);break}case 10:{s.clusterLevel=t.int32();break}case 2:{s.key=t.bytes();break}case 3:{s.record=t.bytes();break}case 8:{if(((a=i.limits)==null?void 0:a.closer)!=null&&s.closer.length===i.limits.closer)throw new yt('Decode error - map field "closer" had too many elements');s.closer.push(sh.codec().decode(t,t.uint32(),{limits:(c=i.limits)==null?void 0:c.closer$}));break}case 9:{if(((l=i.limits)==null?void 0:l.providers)!=null&&s.providers.length===i.limits.providers)throw new yt('Decode error - map field "providers" had too many elements');s.providers.push(sh.codec().decode(t,t.uint32(),{limits:(d=i.limits)==null?void 0:d.providers$}));break}default:{t.skipType(h&7);break}}}return s})),e),r.encode=t=>Pe(t,r.codec()),r.decode=(t,n)=>Te(t,r.codec(),n)})(Yl||(Yl={}));function EB(r,e={}){var n;const t={...r,name:"SEND_QUERY",type:0,messageName:r.type,messageType:r.type};return(n=e.onProgress)==null||n.call(e,new CustomEvent("kad-dht:query:send-query",{detail:t})),t}function X9(r,e={}){var n;const t={...r,name:"PEER_RESPONSE",type:1,messageName:r.messageType,closer:r.closer??[],providers:r.providers??[]};return(n=e.onProgress)==null||n.call(e,new CustomEvent("kad-dht:query:peer-response",{detail:t})),t}function Z9(r,e={}){var n;const t={...r,name:"FINAL_PEER",type:2};return(n=e.onProgress)==null||n.call(e,new CustomEvent("kad-dht:query:final-peer",{detail:t})),t}function Ic(r,e={}){var n;const t={...r,name:"QUERY_ERROR",type:3};return(n=e.onProgress)==null||n.call(e,new CustomEvent("kad-dht:query:query-error",{detail:t})),t}function SB(r,e={}){var n;const t={...r,name:"PROVIDER",type:4};return(n=e.onProgress)==null||n.call(e,new CustomEvent("kad-dht:query:provider",{detail:t})),t}function eE(r,e={}){var n;const t={...r,name:"VALUE",type:5};return(n=e.onProgress)==null||n.call(e,new CustomEvent("kad-dht:query:value",{detail:t})),t}function xB(r,e={}){var n;const t={...r,name:"DIAL_PEER",type:7};return(n=e.onProgress)==null||n.call(e,new CustomEvent("kad-dht:query:dial-peer",{detail:t})),t}function G3e(r,e,t){if(t.length===0)throw new Z("No records given");const i=re(e).split("/");if(i.length<3)throw new Z("Record key does not have a selector function");const s=r[i[1].toString()];if(s==null)throw new W3e(`No selector function configured for key type "${i[1]}"`);return t.length===1?0:s(e,t)}function Q3e(r,e){return 0}const Y3e={pk:Q3e};async function tE(r,e){const t=e.key,i=re(t).split("/");if(i.length<3)return;const s=r[i[1].toString()];if(s==null)throw new Z(`No validator available for key type "${i[1]}"`);await s(t,e.value)}const J3e={pk:async(r,e)=>{if(!(r instanceof Uint8Array))throw new Z('"key" must be a Uint8Array');if(r.byteLength<5)throw new Z("Invalid public key record");if(re(r.subarray(0,4))!=="/pk/")throw new Z("key was not prefixed with /pk/");const n=kn(e),i=r.slice(4);if(!qe(i,n.toMultihash().bytes))throw new Z("public key does not match passed in key")}};function X3e(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function rE(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function Z3e(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var i=0;i<r.length;i++){var s=r.charAt(i),o=s.charCodeAt(0);if(t[o]!==255)throw new TypeError(s+" is ambiguous");t[o]=i}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),d=Math.log(256)/Math.log(a);function h(f){if(f instanceof Uint8Array||(ArrayBuffer.isView(f)?f=new Uint8Array(f.buffer,f.byteOffset,f.byteLength):Array.isArray(f)&&(f=Uint8Array.from(f))),!(f instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(f.length===0)return"";for(var g=0,w=0,y=0,b=f.length;y!==b&&f[y]===0;)y++,g++;for(var v=(b-y)*d+1>>>0,E=new Uint8Array(v);y!==b;){for(var C=f[y],k=0,x=v-1;(C!==0||k<w)&&x!==-1;x--,k++)C+=256*E[x]>>>0,E[x]=C%a>>>0,C=C/a>>>0;if(C!==0)throw new Error("Non-zero carry");w=k,y++}for(var I=v-w;I!==v&&E[I]===0;)I++;for(var T=c.repeat(g);I<v;++I)T+=r.charAt(E[I]);return T}function p(f){if(typeof f!="string")throw new TypeError("Expected String");if(f.length===0)return new Uint8Array;var g=0;if(f[g]!==" "){for(var w=0,y=0;f[g]===c;)w++,g++;for(var b=(f.length-g)*l+1>>>0,v=new Uint8Array(b);f[g];){var E=t[f.charCodeAt(g)];if(E===255)return;for(var C=0,k=b-1;(E!==0||C<y)&&k!==-1;k--,C++)E+=a*v[k]>>>0,v[k]=E%256>>>0,E=E/256>>>0;if(E!==0)throw new Error("Non-zero carry");y=C,g++}if(f[g]!==" "){for(var x=b-y;x!==b&&v[x]===0;)x++;for(var I=new Uint8Array(w+(b-x)),T=w;x!==b;)I[T++]=v[x++];return I}}}function m(f){var g=p(f);if(g)return g;throw new Error(`Non-${e} character`)}return{encode:h,decodeUnsafe:p,decode:m}}var ewe=Z3e,twe=ewe;let rwe=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseEncode");this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},nwe=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseDecode");u(this,"prefixCodePoint");this.name=e,this.prefix=t;const i=t.codePointAt(0);if(i===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=i,this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return AB(this,e)}},iwe=class{constructor(e){u(this,"decoders");this.decoders=e}or(e){return AB(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};function AB(r,e){return new iwe({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}let swe=class{constructor(e,t,n,i){u(this,"name");u(this,"prefix");u(this,"baseEncode");u(this,"baseDecode");u(this,"encoder");u(this,"decoder");this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=i,this.encoder=new rwe(e,t,n),this.decoder=new nwe(e,t,i)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};function CB({name:r,prefix:e,encode:t,decode:n}){return new swe(r,e,t,n)}function S3({name:r,prefix:e,alphabet:t}){const{encode:n,decode:i}=twe(t,r);return CB({prefix:e,name:r,encode:n,decode:s=>rE(i(s))})}function owe(r,e,t,n){const i={};for(let d=0;d<e.length;++d)i[e[d]]=d;let s=r.length;for(;r[s-1]==="=";)--s;const o=new Uint8Array(s*t/8|0);let a=0,c=0,l=0;for(let d=0;d<s;++d){const h=i[r[d]];if(h===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|h,a+=t,a>=8&&(a-=8,o[l++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o}function awe(r,e,t){const n=e[e.length-1]==="=",i=(1<<t)-1;let s="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,s+=e[i&a>>o];if(o!==0&&(s+=e[i&a<<t-o]),n)for(;s.length*t&7;)s+="=";return s}function Vo({name:r,prefix:e,bitsPerChar:t,alphabet:n}){return CB({prefix:e,name:r,encode(i){return awe(i,n,t)},decode(i){return owe(i,n,t,r)}})}const x3=Vo({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});Vo({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),Vo({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),Vo({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),Vo({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),Vo({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),Vo({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),Vo({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),Vo({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const nE=S3({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"});S3({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});const kc=S3({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});S3({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var cwe=kB,IB=128,lwe=-128,uwe=Math.pow(2,31);function kB(r,e,t){e=e||[],t=t||0;for(var n=t;r>=uwe;)e[t++]=r&255|IB,r/=128;for(;r&lwe;)e[t++]=r&255|IB,r>>>=7;return e[t]=r|0,kB.bytes=t-n+1,e}var dwe=iE,hwe=128,_B=127;function iE(r,n){var t=0,n=n||0,i=0,s=n,o,a=r.length;do{if(s>=a)throw iE.bytes=0,new RangeError("Could not decode varint");o=r[s++],t+=i<28?(o&_B)<<i:(o&_B)*Math.pow(2,i),i+=7}while(o>=hwe);return iE.bytes=s-n,t}var fwe=Math.pow(2,7),pwe=Math.pow(2,14),gwe=Math.pow(2,21),ywe=Math.pow(2,28),mwe=Math.pow(2,35),wwe=Math.pow(2,42),bwe=Math.pow(2,49),vwe=Math.pow(2,56),Ewe=Math.pow(2,63),Swe=function(r){return r<fwe?1:r<pwe?2:r<gwe?3:r<ywe?4:r<mwe?5:r<wwe?6:r<bwe?7:r<vwe?8:r<Ewe?9:10},xwe={encode:cwe,decode:dwe,encodingLength:Swe},A3=xwe;function sE(r,e=0){return[A3.decode(r,e),A3.decode.bytes]}function C3(r,e,t=0){return A3.encode(r,e,t),e}function I3(r){return A3.encodingLength(r)}function oE(r,e){const t=e.byteLength,n=I3(r),i=n+I3(t),s=new Uint8Array(i+t);return C3(r,s,0),C3(t,s,n),s.set(e,i),new aE(r,t,e,s)}function Jl(r){const e=rE(r),[t,n]=sE(e),[i,s]=sE(e.subarray(n)),o=e.subarray(n+s);if(o.byteLength!==i)throw new Error("Incorrect length");return new aE(t,i,o,e)}function Awe(r,e){if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&X3e(r.bytes,t.bytes)}}let aE=class{constructor(e,t,n,i){u(this,"code");u(this,"size");u(this,"digest");u(this,"bytes");this.code=e,this.size=t,this.digest=n,this.bytes=i}};function TB(r,e){const{bytes:t,version:n}=r;switch(n){case 0:return Iwe(t,cE(r),e??kc.encoder);default:return kwe(t,cE(r),e??x3.encoder)}}const PB=new WeakMap;function cE(r){const e=PB.get(r);if(e==null){const t=new Map;return PB.set(r,t),t}return e}let lE=class tn{constructor(e,t,n,i){u(this,"code");u(this,"version");u(this,"multihash");u(this,"bytes");u(this,"/");u(this,oH,"CID");this.code=t,this.version=e,this.multihash=n,this.bytes=i,this["/"]=i}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==dp)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==_we)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return tn.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=oE(e,t);return tn.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return tn.equals(this,e)}static equals(e,t){const n=t;return n!=null&&e.code===n.code&&e.version===n.version&&Awe(e.multihash,n.multihash)}toString(e){return TB(this,e)}toJSON(){return{"/":TB(this)}}link(){return this}[(oH=Symbol.toStringTag,Symbol.for("nodejs.util.inspect.custom"))](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof tn)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:i,multihash:s,bytes:o}=t;return new tn(n,i,s,o??DB(n,i,s.bytes))}else if(t[Twe]===!0){const{version:n,multihash:i,code:s}=t,o=Jl(i);return tn.create(n,s,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==dp)throw new Error(`Version 0 CID must use dag-pb (code: ${dp}) block encoding`);return new tn(e,t,n,n.bytes)}case 1:{const i=DB(e,t,n.bytes);return new tn(e,t,n,i)}default:throw new Error("Invalid version")}}static createV0(e){return tn.create(0,dp,e)}static createV1(e,t){return tn.create(1,e,t)}static decode(e){const[t,n]=tn.decodeFirst(e);if(n.length!==0)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=tn.inspectBytes(e),n=t.size-t.multihashSize,i=rE(e.subarray(n,n+t.multihashSize));if(i.byteLength!==t.multihashSize)throw new Error("Incorrect length");const s=i.subarray(t.multihashSize-t.digestSize),o=new aE(t.multihashCode,t.digestSize,s,i);return[t.version===0?tn.createV0(o):tn.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[h,p]=sE(e.subarray(t));return t+=p,h};let i=n(),s=dp;if(i===18?(i=0,t=0):s=n(),i!==0&&i!==1)throw new RangeError(`Invalid CID version ${i}`);const o=t,a=n(),c=n(),l=t+c,d=l-o;return{version:i,codec:s,multihashCode:a,digestSize:c,multihashSize:d,size:l}}static parse(e,t){const[n,i]=Cwe(e,t),s=tn.decode(i);if(s.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return cE(s).set(n,e),s}};function Cwe(r,e){switch(r[0]){case"Q":{const t=e??kc;return[kc.prefix,t.decode(`${kc.prefix}${r}`)]}case kc.prefix:{const t=e??kc;return[kc.prefix,t.decode(r)]}case x3.prefix:{const t=e??x3;return[x3.prefix,t.decode(r)]}case nE.prefix:{const t=e??nE;return[nE.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}}function Iwe(r,e,t){const{prefix:n}=t;if(n!==kc.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const i=e.get(n);if(i==null){const s=t.encode(r).slice(1);return e.set(n,s),s}else return i}function kwe(r,e,t){const{prefix:n}=t,i=e.get(n);if(i==null){const s=t.encode(r);return e.set(n,s),s}else return i}const dp=112,_we=18;function DB(r,e,t){const n=I3(r),i=n+I3(e),s=new Uint8Array(i+t.byteLength);return C3(r,s,0),C3(e,s,n),s.set(t,i),s}const Twe=Symbol.for("@ipld/js-cid/CID"),Pwe=85;function Dwe({name:r,code:e,encode:t}){return new $we(r,e,t)}let $we=class{constructor(e,t,n){u(this,"name");u(this,"code");u(this,"encode");this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?oE(this.code,t):t.then(n=>oE(this.code,n))}else throw Error("Unknown type, must be binary type")}};function Nwe(r){return async e=>new Uint8Array(await crypto.subtle.digest(r,e))}const $B=Dwe({name:"sha2-256",code:18,encode:Nwe("SHA-256")}),Mwe=ie("/pk/");function Owe(r){return{...r,multiaddrs:r.multiaddrs.filter(e=>{const[[t,n]]=e.stringTuples();if(t===53||t===54||t===55)return n!=="localhost";if(t!==4&&t!==6||n==null)return!1;const i=pc(n);return i==null?!0:!i})}}async function hp(r){return(await $B.digest(r)).digest}async function cs(r){return hp(r.toMultihash().bytes)}function fp(r,e){return new At(`${r}/${re(e,"base32")}`,!1)}function Rwe(r){return sr([Mwe,r.toMultihash().bytes])}function Lwe(r){return re(r.subarray(0,4))==="/pk/"}function Bwe(r){const e=Jl(r.subarray(4));return ei(e)}function NB(r,e){const t=new Date;return new Pi(r,e,t).serialize()}const Uwe=290,Fwe=54,zwe=55,Vwe=56,Kwe=4,jwe=41;function Hwe(r){const e=r.stringTuples();for(const t of e)if(t[0]===Uwe)return!1;if(e[0][0]===Fwe||e[0][0]===zwe||e[0][0]===Vwe)return!0;if(e[0][0]===Kwe||e[0][0]===jwe){const t=pc(`${e[0][1]}`);return t==null||!t}return!1}function MB(r){const e=r.toString().split("/"),t=e.pop(),n=e.pop();if(t==null||n==null)throw new Error(`incorrectly formatted provider entry key in datastore: ${r.toString()}`);return{cid:lE.createV1(Pwe,Jl(ie(n,"base32"))),peerId:tr(t)}}function uE(r,e,t){const n=typeof e=="string"?e:re(e.multihash.bytes,"base32"),i=[r,n];return t!=null&&i.push(t.toString()),new At(i.join("/"))}function OB(r){return new Date(Zi(r))}function oh(r,e,t){return async function*(...n){var a,c,l,d,h;const i=(a=e.queryTime)==null?void 0:a.timer(t),s=(c=e.errorTime)==null?void 0:c.timer(t);let o=!1;try{(l=e.queries)==null||l.increment({[t]:!0}),yield*r(...n)}catch(p){throw o=!0,s==null||s(),(d=e.errors)==null||d.increment({[t]:!0}),p}finally{(h=e.queries)==null||h.decrement({[t]:!0}),o||i==null||i()}}}function RB(r,e,t){return async function(...n){var a,c,l,d,h;const i=(a=e==null?void 0:e.queryTime)==null?void 0:a.timer(t),s=(c=e==null?void 0:e.errorTime)==null?void 0:c.timer(t);let o=!1;try{return(l=e.queries)==null||l.increment({[t]:!0}),await r(...n)}catch(p){throw o=!0,s==null||s(),(d=e.errors)==null||d.increment({[t]:!0}),p}finally{(h=e.queries)==null||h.decrement({[t]:!0}),o||i==null||i()}}}class qwe{constructor(e,t){u(this,"log");u(this,"components");u(this,"validators");u(this,"selectors");u(this,"peerRouting");u(this,"queryManager");u(this,"network");u(this,"datastorePrefix");var l,d;const{validators:n,selectors:i,peerRouting:s,queryManager:o,network:a,logPrefix:c}=t;this.components=e,this.log=e.logger.forComponent(`${c}:content-fetching`),this.datastorePrefix=`${t.datastorePrefix}/record`,this.validators=n,this.selectors=i,this.peerRouting=s,this.queryManager=o,this.network=a,this.get=((l=e.metrics)==null?void 0:l.traceFunction("libp2p.kadDHT.get",this.get.bind(this),{optionsIndex:1}))??this.get,this.put=((d=e.metrics)==null?void 0:d.traceFunction("libp2p.kadDHT.put",this.put.bind(this),{optionsIndex:2}))??this.put}async getLocal(e){this.log("getLocal %b",e);const t=fp(this.datastorePrefix,e);this.log("fetching record for key %k",t);const n=await this.components.datastore.get(t);this.log("found %k in local datastore",t);const i=Pi.deserialize(n);return await tE(this.validators,i),i}async*sendCorrectionRecord(e,t,n,i={}){this.log("sendCorrection for %b",e);const s=NB(e,n);for(const{value:o,from:a}of t){if(qe(o,n)){this.log("record was ok");continue}if(this.components.peerId.equals(a)){try{const d=fp(this.datastorePrefix,e);this.log(`Storing corrected record for key ${d.toString()}`),await this.components.datastore.put(d,s.subarray())}catch(d){this.log.error("Failed error correcting self",d)}continue}let c=!1;const l={type:It.PUT_VALUE,key:e,record:s};for await(const d of this.network.sendRequest(a,l,i))d.name==="PEER_RESPONSE"&&d.record!=null&&qe(d.record.value,Pi.deserialize(s).value)&&(c=!0),yield d;c||(yield Ic({from:a,error:new v3("Value not put correctly")},i)),this.log.error("Failed error correcting entry")}}async*put(e,t,n={}){this.log("put key %b value %b",e,t);const i=NB(e,t),s=fp(this.datastorePrefix,e);this.log(`storing record for key ${s.toString()}`),await this.components.datastore.put(s,i.subarray()),yield*cn(this.peerRouting.getClosestPeers(e,{...n,signal:n.signal}),o=>Ld(o,a=>async()=>{if(a.name!=="FINAL_PEER")return[a];const c=[],l={type:It.PUT_VALUE,key:e,record:i};this.log("send put to %p",a.peer.id);for await(const d of this.network.sendRequest(a.peer.id,l,n))c.push(d),d.name==="PEER_RESPONSE"&&(d.record!=null&&qe(d.record.value,Pi.deserialize(i).value)||c.push(Ic({from:a.peer.id,error:new v3("Value not put correctly")},n)));return c}),o=>lp(o,{ordered:!1,concurrency:Y9}),async function*(o){for await(const a of o)yield*a})}async*get(e,t={}){this.log("get %b",e);const n=[];for await(const a of this.getMany(e,t))a.name==="VALUE"&&n.push(a),yield a;if(n.length===0)return;const i=n.map(a=>a.value);let s=0;try{s=G3e(this.selectors,e,i)}catch(a){if(a.name!=="InvalidParametersError")throw a}const o=i[s];if(this.log("GetValue %b %b",e,o),o==null)throw new Zt("Best value was not found");yield*this.sendCorrectionRecord(e,n,o,t),yield n[s]}async*getMany(e,t={}){this.log("getMany values for %b",e);try{const s=await this.getLocal(e);yield eE({value:s.value,from:this.components.peerId},t)}catch(s){this.log("error getting local value for %b",e,s)}const n=this,i=async function*({peer:s,signal:o}){for await(const a of n.peerRouting.getValueOrPeers(s,e,{...t,signal:o}))yield a,a.name==="PEER_RESPONSE"&&a.record!=null&&(yield eE({from:s,value:a.record.value},t))};yield*this.queryManager.run(e,i,t)}}function Wwe(r,e){return{id:r.id.toMultihash().bytes,multiaddrs:(r.multiaddrs??[]).map(n=>n.bytes),connection:e}}function k3(r){if(r.id==null)throw new Error("Invalid peer in message");const e=Jl(r.id);return{id:ei(e),multiaddrs:(r.multiaddrs??[]).map(t=>Oe(t))}}class Gwe{constructor(e,t){u(this,"log");u(this,"components");u(this,"network");u(this,"peerRouting");u(this,"queryManager");u(this,"routingTable");u(this,"providers");var l,d;const{network:n,peerRouting:i,queryManager:s,routingTable:o,providers:a,logPrefix:c}=t;this.components=e,this.log=e.logger.forComponent(`${c}:content-routing`),this.network=n,this.peerRouting=i,this.queryManager=s,this.routingTable=o,this.providers=a,this.findProviders=((l=e.metrics)==null?void 0:l.traceFunction("libp2p.kadDHT.findProviders",this.findProviders.bind(this),{optionsIndex:1,getAttributesFromYieldedValue:(h,p)=>(h.name==="PROVIDER"&&(p.providers??(p.providers=[]),p.providers.push(...h.providers.map(m=>m.id.toString()))),p)}))??this.findProviders,this.provide=((d=e.metrics)==null?void 0:d.traceFunction("libp2p.kadDHT.provide",this.provide.bind(this),{optionsIndex:1,getAttributesFromYieldedValue:(h,p)=>(h.name==="PEER_RESPONSE"&&h.messageName==="ADD_PROVIDER"&&(p.providers??(p.providers=[]),p.providers.push(h.from.toString())),p)}))??this.provide}async*provide(e,t,n={}){this.log("provide %s",e);const i=e.multihash.bytes;await this.providers.addProvider(e,this.components.peerId);const s={type:It.ADD_PROVIDER,key:i,providers:[Wwe({id:this.components.peerId,multiaddrs:t})]};let o=0;const a=c=>async()=>{if(c.name!=="FINAL_PEER")return[c];const l=[];this.log("putProvider %s to %p",e,c.peer.id);try{this.log("sending provider record for %s to %p",e,c.peer.id);for await(const d of this.network.sendMessage(c.peer.id,s,n))d.name==="PEER_RESPONSE"&&(this.log("sent provider record for %s to %p",e,c.peer.id),o++),l.push(d)}catch(d){this.log.error("error sending provide record to peer %p",c.peer.id,d),l.push(Ic({from:c.peer.id,error:d},n))}return l};yield*cn(this.peerRouting.getClosestPeers(i,n),c=>Ld(c,l=>a(l)),c=>lp(c,{ordered:!1,concurrency:Y9}),async function*(c){for await(const l of c)yield*l}),this.log("sent provider records to %d peers",o)}async*findProviders(e,t){const n=this.routingTable.kBucketSize;let i=0;const s=e.multihash.bytes,o=this;this.log("findProviders %c",e);const a=await this.providers.getProviders(e);if(a.length>0){const d=[];for(const h of a.slice(0,n))try{const p=await this.components.peerStore.get(h);d.push({id:h,multiaddrs:p.addresses.map(({multiaddr:m})=>m)})}catch(p){if(p.name!=="NotFoundError")throw p;this.log("no peer store entry for %p",h)}if(yield X9({from:this.components.peerId,messageType:It.GET_PROVIDERS,providers:d},t),yield SB({from:this.components.peerId,providers:d},t),i+=d.length,i>=n)return}const c=async function*({peer:d,signal:h}){const p={type:It.GET_PROVIDERS,key:s};yield*o.network.sendRequest(d,p,{...t,signal:h})},l=new ts(a);for await(const d of this.queryManager.run(s,c,t))if(yield d,d.name==="PEER_RESPONSE"){this.log("Found %d provider entries for %c and %d closer peers",d.providers.length,e,d.closer.length);const h=[];for(const p of d.providers)l.has(p.id)||(l.add(p.id),h.push(p));if(h.length>0&&(yield SB({from:d.from,providers:h},t),i+=h.length,i>=n))return}}}class dE{constructor(e){u(this,"movingAverage");u(this,"variance");u(this,"deviation");u(this,"forecast");u(this,"timeSpan");u(this,"previousTime");this.timeSpan=e,this.movingAverage=0,this.variance=0,this.deviation=0,this.forecast=0}alpha(e,t){return 1-Math.exp(-(e-t)/this.timeSpan)}push(e,t=Date.now()){if(this.previousTime!=null){const n=this.alpha(t,this.previousTime),i=e-this.movingAverage,s=n*i;this.movingAverage=n*e+(1-n)*this.movingAverage,this.variance=(1-n)*(this.variance+i*s),this.deviation=Math.sqrt(this.variance),this.forecast=this.movingAverage+n*i}else this.movingAverage=e;this.previousTime=t}}const Qwe=1.2,Ywe=2,Jwe=2e3;class pp{constructor(e={}){u(this,"success");u(this,"failure");u(this,"next");u(this,"metric");u(this,"timeoutMultiplier");u(this,"failureMultiplier");u(this,"minTimeout");var t;this.success=new dE(e.interval??5e3),this.failure=new dE(e.interval??5e3),this.next=new dE(e.interval??5e3),this.failureMultiplier=e.failureMultiplier??Ywe,this.timeoutMultiplier=e.timeoutMultiplier??Qwe,this.minTimeout=e.minTimeout??Jwe,e.metricName!=null&&(this.metric=(t=e.metrics)==null?void 0:t.registerMetricGroup(e.metricName))}getTimeoutSignal(e={}){const t=Math.max(Math.round(this.next.movingAverage*(e.timeoutFactor??this.timeoutMultiplier)),this.minTimeout),n=AbortSignal.timeout(t),i=ft([e.signal,n]);return i.start=Date.now(),i.timeout=t,i}cleanUp(e){var n,i;const t=Date.now()-e.start;e.aborted?(this.failure.push(t),this.next.push(t*this.failureMultiplier),(n=this.metric)==null||n.update({failureMovingAverage:this.failure.movingAverage,failureDeviation:this.failure.deviation,failureForecast:this.failure.forecast,failureVariance:this.failure.variance,failure:t})):(this.success.push(t),this.next.push(t),(i=this.metric)==null||i.update({successMovingAverage:this.success.movingAverage,successDeviation:this.success.deviation,successForecast:this.success.forecast,successVariance:this.success.variance,success:t}))}}class Xwe{constructor(){u(this,"readNext");u(this,"haveNext");u(this,"ended");u(this,"nextResult");this.ended=!1,this.readNext=Re(),this.haveNext=Re()}[Symbol.asyncIterator](){return this}async next(){if(this.nextResult==null&&await this.haveNext.promise,this.nextResult==null)throw new Error("HaveNext promise resolved but nextResult was undefined");const e=this.nextResult;return this.nextResult=void 0,this.readNext.resolve(),this.readNext=Re(),e}async throw(e){return this.ended=!0,e!=null&&(this.haveNext.promise.catch(()=>{}),this.haveNext.reject(e)),{done:!0,value:void 0}}async return(){const e={done:!0,value:void 0};return this.ended=!0,this.nextResult=e,this.haveNext.resolve(),e}async push(e,t){await this._push(e,t)}async end(e,t){e!=null?await this.throw(e):await this._push(void 0,t)}async _push(e,t){if(e!=null&&this.ended)throw new Error("Cannot push value onto an ended pushable");for(;this.nextResult!=null;)await this.readNext.promise;e!=null?this.nextResult={done:!1,value:e}:(this.ended=!0,this.nextResult={done:!0,value:void 0}),this.haveNext.resolve(),this.haveNext=Re(),await an(this.readNext.promise,t==null?void 0:t.signal,t)}}function Zwe(){return new Xwe}let e4e=class extends Error{constructor(){super(...arguments);u(this,"name","UnexpectedEOFError");u(this,"code","ERR_UNEXPECTED_EOF")}};class t4e extends Error{constructor(t,n){super(t);u(this,"code");this.code=n}}let r4e=class extends t4e{constructor(t){super(t,"ABORT_ERR");u(this,"type");this.type="aborted",this.name="AbortError"}};function n4e(r,e){const t=Zwe();r.sink(t).catch(async o=>{await t.end(o)}),r.sink=async o=>{for await(const a of o)await t.push(a);await t.end()};let n=r.source;r.source[Symbol.iterator]!=null?n=r.source[Symbol.iterator]():r.source[Symbol.asyncIterator]!=null&&(n=r.source[Symbol.asyncIterator]());const i=new Le;return{read:async(o,a)=>{var d,h;(d=a==null?void 0:a.signal)==null||d.throwIfAborted();let c;const l=new Promise((p,m)=>{var f;c=()=>{m(new r4e("Read aborted"))},(f=a==null?void 0:a.signal)==null||f.addEventListener("abort",c)});try{if(o==null){const{done:m,value:f}=await Promise.race([n.next(),l]);return m===!0?new Le:f}for(;i.byteLength<o;){const{value:m,done:f}=await Promise.race([n.next(),l]);if(f===!0)throw new e4e("unexpected end of input");i.append(m)}const p=i.sublist(0,o);return i.consume(o),p}finally{c!=null&&((h=a==null?void 0:a.signal)==null||h.removeEventListener("abort",c))}},write:async(o,a)=>{var c;(c=a==null?void 0:a.signal)==null||c.throwIfAborted(),o instanceof Uint8Array?await t.push(o,a):await t.push(o.subarray(),a)},unwrap:()=>{if(i.byteLength>0){const o=r.source;r.source=async function*(){(e==null?void 0:e.yieldBytes)===!1?yield i:yield*i,yield*o}()}return r}}}let i4e=class extends Error{constructor(){super(...arguments);u(this,"name","InvalidMessageLengthError");u(this,"code","ERR_INVALID_MSG_LENGTH")}},s4e=class extends Error{constructor(){super(...arguments);u(this,"name","InvalidDataLengthError");u(this,"code","ERR_MSG_DATA_TOO_LONG")}},o4e=class extends Error{constructor(){super(...arguments);u(this,"name","InvalidDataLengthLengthError");u(this,"code","ERR_MSG_LENGTH_TOO_LONG")}};function a4e(r,e={}){const t=n4e(r,e);e.maxDataLength!=null&&e.maxLengthLength==null&&(e.maxLengthLength=gt(e.maxDataLength));const n=(e==null?void 0:e.lengthDecoder)??Zi,i=(e==null?void 0:e.lengthEncoder)??Er;return{read:async o=>{let a=-1;const c=new Le;for(;;){c.append(await t.read(1,o));try{a=n(c)}catch(l){if(l instanceof RangeError)continue;throw l}if(a<0)throw new i4e("Invalid message length");if((e==null?void 0:e.maxLengthLength)!=null&&c.byteLength>e.maxLengthLength)throw new o4e("message length length too long");if(a>-1)break}if((e==null?void 0:e.maxDataLength)!=null&&a>e.maxDataLength)throw new s4e("message length too long");return t.read(a,o)},write:async(o,a)=>{await t.write(new Le(i(o.byteLength),o),a)},writeV:async(o,a)=>{const c=new Le(...o.flatMap(l=>[i(l.byteLength),l]));await t.write(c,a)},unwrap:()=>t.unwrap()}}function LB(r,e){const t=a4e(r,e),n={read:async(i,s)=>{const o=await t.read(s);return i.decode(o)},write:async(i,s,o)=>{await t.write(s.encode(i),o)},writeV:async(i,s,o)=>{await t.writeV(i.map(a=>s.encode(a)),o)},pb:i=>({read:async s=>n.read(i,s),write:async(s,o)=>n.write(s,i,o),writeV:async(s,o)=>n.writeV(s,i,o),unwrap:()=>n}),unwrap:()=>t.unwrap()};return n}class c4e extends er{constructor(t,n){var i,s,o,a;super();u(this,"log");u(this,"protocol");u(this,"running");u(this,"components");u(this,"timeout");u(this,"metrics");this.components=t,this.log=t.logger.forComponent(`${n.logPrefix}:network`),this.running=!1,this.protocol=n.protocol,this.timeout=new pp({...n.timeout??{},metrics:t.metrics,metricName:`${n.metricsPrefix}_network_message_send_times_milliseconds`}),this.metrics={operations:(i=t.metrics)==null?void 0:i.registerCounterGroup(`${n.metricsPrefix}_outbound_rpc_requests_total`),errors:(s=t.metrics)==null?void 0:s.registerCounterGroup(`${n.metricsPrefix}_outbound_rpc_errors_total`)},this.sendRequest=((o=t.metrics)==null?void 0:o.traceFunction("libp2p.kadDHT.sendRequest",this.sendRequest.bind(this),{optionsIndex:2,getAttributesFromArgs([c,l],d){return{...d,to:c.toString(),"message type":`${l.type}`}},getAttributesFromYieldedValue:(c,l)=>(c.name==="PEER_RESPONSE"&&(c.providers.length>0&&c.providers.forEach((d,h)=>{l[`providers-${h}`]=d.id.toString()}),c.closer.length>0&&c.closer.forEach((d,h)=>{l[`closer-${h}`]=d.id.toString()})),l)}))??this.sendRequest,this.sendMessage=((a=t.metrics)==null?void 0:a.traceFunction("libp2p.kadDHT.sendMessage",this.sendMessage.bind(this),{optionsIndex:2,getAttributesFromArgs([c,l],d){return{...d,to:c.toString(),"message type":`${l.type}`}},getAttributesFromYieldedValue:(c,l)=>(c.name==="PEER_RESPONSE"&&(c.providers.length>0&&c.providers.forEach((d,h)=>{l[`providers-${h}`]=d.id.toString()}),c.closer.length>0&&c.closer.forEach((d,h)=>{l[`closer-${h}`]=d.id.toString()})),l)}))??this.sendMessage}async start(){this.running||(this.running=!0)}async stop(){this.running=!1}isStarted(){return this.running}async*sendRequest(t,n,i={}){var c,l,d;if(!this.running)return;const s=n.type;if(s==null)throw new Z("Message type was missing");this.log("sending %s to %p",n.type,t),yield xB({peer:t},i),yield EB({to:t,type:s},i);let o;const a=this.timeout.getTimeoutSignal(i);i={...i,signal:a};try{(c=this.metrics.operations)==null||c.increment({[s]:!0}),o=await(await this.components.connectionManager.openConnection(t,i)).newStream(this.protocol,i);const p=await this._writeReadMessage(o,n,i);o.close(i).catch(m=>{this.log.error("error closing stream to %p",t,m),o==null||o.abort(m)}),yield X9({from:t,messageType:p.type,closer:p.closer.map(k3),providers:p.providers.map(k3),record:p.record==null?void 0:Pi.deserialize(p.record)},i)}catch(h){(l=this.metrics.errors)==null||l.increment({[s]:!0}),o==null||o.abort(h),((d=i.signal)==null?void 0:d.aborted)!==!0&&this.log.error("could not send %s to %p - %e",n.type,t,h),yield Ic({from:t,error:h},i)}finally{this.timeout.cleanUp(a)}}async*sendMessage(t,n,i={}){var c,l;if(!this.running)return;const s=n.type;if(s==null)throw new Z("Message type was missing");this.log("sending %s to %p",n.type,t),yield xB({peer:t},i),yield EB({to:t,type:s},i);let o;const a=this.timeout.getTimeoutSignal(i);i={...i,signal:a};try{(c=this.metrics.operations)==null||c.increment({[s]:!0}),o=await(await this.components.connectionManager.openConnection(t,i)).newStream(this.protocol,i),await this._writeMessage(o,n,i),o.close(i).catch(h=>{this.log.error("error closing stream to %p",t,h),o==null||o.abort(h)}),yield X9({from:t,messageType:s},i)}catch(d){(l=this.metrics.errors)==null||l.increment({[s]:!0}),o==null||o.abort(d),yield Ic({from:t,error:d},i)}finally{this.timeout.cleanUp(a)}}async _writeMessage(t,n,i){await LB(t).write(n,Yl,i)}async _writeReadMessage(t,n,i){const s=LB(t);await s.write(n,Yl,i);const o=await s.read(Yl,i);return o.closer.forEach(a=>{this.safeDispatchEvent("peer",{detail:k3(a)})}),o.providers.forEach(a=>{this.safeDispatchEvent("peer",{detail:k3(a)})}),o}}function gp(r,e){if(r.byteLength!==e.byteLength)throw new Error("Inputs should have the same length");for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return r[t]<e[t]?-1:1;return 0}class hE{constructor(e,t){u(this,"originDhtKey");u(this,"capacity");u(this,"peerDistances");this.originDhtKey=e,this.capacity=t,this.peerDistances=[]}get length(){return this.peerDistances.length}get peers(){return this.peerDistances.map(e=>e.peer)}async add(e){const t=await cs(e.id);this.addWithKadId(e,t)}addWithKadId(e,t){if(this.peerDistances.find(s=>s.peer.id.equals(e.id))!=null)return;const n={peer:e,distance:xc(this.originDhtKey,t)};let i=!1;for(let s=0;s<this.peerDistances.length;s++){const o=gp(this.peerDistances[s].distance,n.distance);if(o===0||o===1){i=!0,this.peerDistances.splice(s,0,n);break}}i||this.peerDistances.push(n),this.peerDistances=this.peerDistances.slice(0,this.capacity)}async isCloser(e){if(this.length===0)return!0;const t=await cs(e),n=xc(t,this.originDhtKey),i=this.peerDistances[this.peerDistances.length-1].distance;return gp(n,i)===-1}async anyCloser(e){return e.length===0?!1:Promise.any(e.map(async t=>this.isCloser(t)))}}class l4e{constructor(e,t){u(this,"log");u(this,"routingTable");u(this,"network");u(this,"validators");u(this,"queryManager");u(this,"peerStore");u(this,"peerId");var n,i;this.routingTable=t.routingTable,this.network=t.network,this.validators=t.validators,this.queryManager=t.queryManager,this.peerStore=e.peerStore,this.peerId=e.peerId,this.log=e.logger.forComponent(`${t.logPrefix}:peer-routing`),this.findPeer=((n=e.metrics)==null?void 0:n.traceFunction("libp2p.kadDHT.findPeer",this.findPeer.bind(this),{optionsIndex:1}))??this.findPeer,this.getClosestPeers=((i=e.metrics)==null?void 0:i.traceFunction("libp2p.kadDHT.getClosestPeers",this.getClosestPeers.bind(this),{optionsIndex:1}))??this.getClosestPeers}async findPeerLocal(e){let t;const n=await this.routingTable.find(e);if(n!=null){this.log("findPeerLocal found %p in routing table",e);try{t=await this.peerStore.get(n)}catch(i){if(i.name!=="NotFoundError")throw i}}if(t==null)try{t=await this.peerStore.get(e)}catch(i){if(i.name!=="NotFoundError")throw i}if(t!=null)return this.log("findPeerLocal found %p in peer store",e),{id:t.id,multiaddrs:t.addresses.map(i=>i.multiaddr)}}async*_getValueSingle(e,t,n={}){const i={type:It.GET_VALUE,key:t};yield*this.network.sendRequest(e,i,n)}async*getPublicKeyFromNode(e,t={}){const n=Rwe(e);for await(const i of this._getValueSingle(e,n,t))if(yield i,i.name==="PEER_RESPONSE"&&i.record!=null){const s=kn(i.record.value),o=Bd(s);if(!o.equals(e))throw new d1("public key does not match id");if(o.publicKey==null)throw new d1("public key missing");yield eE({from:e,value:i.record.value},t)}throw new v3(`Node not responding with its public key: ${e.toString()}`)}async*findPeer(e,t={}){if(this.log("findPeer %p",e),t.useCache!==!1){const i=await this.findPeerLocal(e);if(i!=null){this.log("found local"),yield Z9({from:this.peerId,peer:i},t);return}}let n=!1;if(t.useNetwork!==!1){const i=this,s=async function*({peer:o,signal:a}){const c={type:It.FIND_NODE,key:e.toMultihash().bytes};for await(const l of i.network.sendRequest(o,c,{...t,signal:a}))if(yield l,l.name==="PEER_RESPONSE"){const d=l.closer.find(h=>h.id.equals(e));d!=null&&(yield Z9({from:l.from,peer:d},t))}};for await(const o of this.queryManager.run(e.toMultihash().bytes,s,t))o.name==="FINAL_PEER"&&(n=!0),yield o}n||(yield Ic({from:this.peerId,error:new Zt("Not found")},t))}async*getClosestPeers(e,t={}){this.log("getClosestPeers to %b",e);const n=await hp(e),i=this.routingTable.closestPeers(n),s=this,o=new hE(n,this.routingTable.kBucketSize);await Promise.all(i.map(async c=>{await o.add({id:c,multiaddrs:[]})}));const a=async function*({peer:c,signal:l}){s.log("closerPeersSingle %s from %p",re(e,"base32"),c);const d={type:It.FIND_NODE,key:e};yield*s.network.sendRequest(c,d,{...t,signal:l})};for await(const c of this.queryManager.run(e,a,t))c.name==="PEER_RESPONSE"&&await Promise.all(c.closer.map(async l=>{await o.add(l)})),yield c;this.log("found %d peers close to %b",o.length,e);for(const c of o.peers)yield Z9({from:this.peerId,peer:c},t)}async*getValueOrPeers(e,t,n={}){for await(const i of this._getValueSingle(e,t,n)){if(i.name==="PEER_RESPONSE"&&i.record!=null)try{await this._verifyRecordOnline(i.record)}catch{const o="invalid record received, discarded";this.log(o),yield Ic({from:i.from,error:new v3(o)},n);continue}yield i}}async _verifyRecordOnline(e){if(e.timeReceived==null)throw new q3e("invalid record received");await tE(this.validators,new Pi(e.key,e.value,e.timeReceived))}async getCloserPeersOffline(e,t){const n=[];try{const c=Jl(e),l=ei(c),d=await this.peerStore.get(l);n.push({id:d.id,multiaddrs:d.addresses.map(({multiaddr:h})=>h)})}catch{}const i=await hp(e),s=this.routingTable.closestPeers(i),o=await cs(t),a=xc(o,i);for(const c of s){const l=await cs(c),d=xc(l,i);if(gp(d,a)===-1)try{const h=await this.peerStore.get(c);n.push({id:c,multiaddrs:h.addresses.map(({multiaddr:p})=>p)})}catch(h){if(h.name!=="NotFoundError")throw h}}return n.length>0?this.log("getCloserPeersOffline found %d peer(s) closer to %b than %p",n.length,e,t):this.log("getCloserPeersOffline could not find peer closer to %b than %p with %d peers in the routing table",e,t,this.routingTable.size),n}}class u4e{constructor(e,t){u(this,"log");u(this,"datastore");u(this,"datastorePrefix");u(this,"lock");this.log=e.logger.forComponent(`${t.logPrefix}:providers`),this.datastorePrefix=`${t.datastorePrefix}/provider`,this.datastore=e.datastore,this.lock=t.lock}async addProvider(e,t){const n=await this.lock.readLock();try{this.log("%p provides %s",t,e),await this.writeProviderEntry(e,t)}finally{n()}}async removeProvider(e,t){const n=await this.lock.writeLock();try{const i=uE(this.datastorePrefix,e,t);this.log("%p no longer provides %s",t,e),await this.datastore.delete(i)}finally{n()}}async getProviders(e){const t=await this.lock.readLock();try{this.log("get providers for %c",e);const n=await this.loadProviders(e);return this.log("got %d providers for %c",n.size,e),[...n.keys()]}finally{t()}}async writeProviderEntry(e,t,n=new Date){const i=uE(this.datastorePrefix,e,t),s=Er(n.getTime());await this.datastore.put(i,s)}async loadProviders(e){const t=new sc,n=uE(this.datastorePrefix,e);for await(const i of this.datastore.query({prefix:n.toString()})){const{peerId:s}=MB(i.key);t.set(s,OB(i.value))}return t}}async function*d4e(r){const{key:e,startingPeer:t,ourPeerId:n,signal:i,query:s,alpha:o,pathIndex:a,numPaths:c,queryFuncTimeout:l,log:d,peersSeen:h,connectionManager:p}=r,m=new Ml({concurrency:o,sort:(w,y)=>gp(w.options.distance,y.options.distance)}),f=await hp(e);function g(w,y){if(w==null)return;h.add(w);const b=xc(y,f);m.add(async()=>{const v=[i];l!=null&&v.push(AbortSignal.timeout(l));const E=ft(v);try{for await(const C of s({...r,key:e,peer:w,signal:E,pathIndex:a,numPaths:c})){if(E.aborted)return;if(C.name==="PEER_RESPONSE")for(const k of C.closer){if(h.has(k.id)){d.trace("already seen %p in query",k.id);continue}if(n.equals(k.id)){d("not querying ourselves");continue}if(!await p.isDialable(k.multiaddrs)){d("not querying undialable peer");continue}const x=await cs(k.id),I=xc(x,f);if(gp(I,b)!==-1){d.trace("skipping %p as they are not closer to %b than %p",k.id,e,w);continue}d.trace("querying closer peer %p",k.id),g(k.id,x)}m.safeDispatchEvent("completed",{detail:C})}}catch(C){if(!i.aborted)return Ic({from:w,error:C},r)}finally{E.clear()}},{distance:b}).catch(v=>{d.error(v)})}g(t,await cs(t));try{for await(const w of m.toGenerator({signal:i}))w!=null&&(yield w)}catch(w){throw i.aborted?new H3e("Query aborted"):w}}class h4e{constructor(e,t){u(this,"disjointPaths");u(this,"alpha");u(this,"shutDownController");u(this,"running");u(this,"logger");u(this,"peerId");u(this,"connectionManager");u(this,"routingTable");u(this,"initialQuerySelfHasRun");u(this,"logPrefix");this.logPrefix=t.logPrefix,this.disjointPaths=t.disjointPaths??wB,this.alpha=t.alpha??Y9,this.initialQuerySelfHasRun=t.initialQuerySelfHasRun,this.routingTable=t.routingTable,this.logger=e.logger,this.peerId=e.peerId,this.connectionManager=e.connectionManager,this.shutDownController=new AbortController,this.shutDownController.signal,this.running=!1}isStarted(){return this.running}async start(){this.running||(this.running=!0,this.shutDownController=new AbortController,this.shutDownController.signal,void 0)}async stop(){this.running=!1,this.shutDownController.abort()}async*run(e,t,n={}){if(!this.running)throw new Error("QueryManager not started");if(n.signal==null){const c=AbortSignal.timeout(V3e);n={...n,signal:c}}const i=new AbortController,s=ft([this.shutDownController.signal,i.signal,n.signal]);i.signal;const o=this.logger.forComponent(`${this.logPrefix}:query:`+re(e,"base58btc"));let a=!1;try{n.isSelfQuery!==!0&&this.initialQuerySelfHasRun!=null&&(o("waiting for initial query-self query before continuing"),await an(this.initialQuerySelfHasRun.promise,s),this.initialQuerySelfHasRun=void 0),o("query:start");const c=await hp(e),l=this.routingTable.closestPeers(c),d=l.slice(0,Math.min(this.disjointPaths,l.length));if(l.length===0){o.error("Running query with no peers");return}const h=new ts,p=d.map((m,f)=>d4e({...n,key:e,startingPeer:m,ourPeerId:this.peerId,signal:s,query:t,pathIndex:f,numPaths:d.length,alpha:this.alpha,queryFuncTimeout:n.queryFuncTimeout,log:o,peersSeen:h,onProgress:n.onProgress,connectionManager:this.connectionManager}));for await(const m of Pa(...p)){if(m.name==="QUERY_ERROR"&&o.error("query error",m.error),m.name==="PEER_RESPONSE")for(const f of[...m.closer,...m.providers])await this.connectionManager.isDialable(f.multiaddrs)&&await this.routingTable.add(f.id);yield m}a=!0}catch(c){if(!(!this.running&&c.name==="QueryAbortedError"))throw c}finally{a||(o("query exited early"),i.abort()),s.clear(),o("query:done")}}}function f4e(r){return r[Symbol.asyncIterator]!=null}function BB(r){if(f4e(r))return(async()=>{let e=0;for await(const t of r)e++;return e})();{let e=0;for(const t of r)e++;return e}}const p4e=r=>{const e=r.addEventListener||r.on||r.addListener,t=r.removeEventListener||r.off||r.removeListener;if(!e||!t)throw new TypeError("Emitter is not compatible");return{addListener:e.bind(r),removeListener:t.bind(r)}};function g4e(r,e,t){let n;const i=new Promise((s,o)=>{var m;if(t={rejectionEvents:["error"],multiArgs:!1,resolveImmediately:!1,...t},!(t.count>=0&&(t.count===Number.POSITIVE_INFINITY||Number.isInteger(t.count))))throw new TypeError("The `count` option should be at least 0 or more");(m=t.signal)==null||m.throwIfAborted();const a=[e].flat(),c=[],{addListener:l,removeListener:d}=p4e(r),h=(...f)=>{const g=t.multiArgs?f:f[0];t.filter&&!t.filter(g)||(c.push(g),t.count===c.length&&(n(),s(c)))},p=f=>{n(),o(f)};n=()=>{for(const f of a)d(f,h);for(const f of t.rejectionEvents)d(f,p)};for(const f of a)l(f,h);for(const f of t.rejectionEvents)l(f,p);t.signal&&t.signal.addEventListener("abort",()=>{p(t.signal.reason)},{once:!0}),t.resolveImmediately&&s(c)});if(i.cancel=n,typeof t.timeout=="number"){const s=jf(i,{milliseconds:t.timeout});return s.cancel=n,s}return i}function y4e(r,e,t){typeof t=="function"&&(t={filter:t}),t={...t,count:1,resolveImmediately:!1};const n=g4e(r,e,t),i=n.then(s=>s[0]);return i.cancel=n.cancel,i}class m4e{constructor(e,t){u(this,"log");u(this,"peerId");u(this,"peerRouting");u(this,"routingTable");u(this,"count");u(this,"interval");u(this,"initialInterval");u(this,"queryTimeout");u(this,"running");u(this,"timeoutId");u(this,"controller");u(this,"initialQuerySelfHasRun");u(this,"querySelfPromise");this.peerId=e.peerId,this.log=e.logger.forComponent(`${t.logPrefix}:query-self`),this.running=!1,this.peerRouting=t.peerRouting,this.routingTable=t.routingTable,this.count=t.count??wB,this.interval=t.interval??L3e,this.initialInterval=t.initialInterval??B3e,this.queryTimeout=t.queryTimeout??U3e,this.initialQuerySelfHasRun=t.initialQuerySelfHasRun,this.querySelf=RB(this.querySelf.bind(this),t.operationMetrics,"SELF_QUERY")}isStarted(){return this.running}start(){this.running||(this.running=!0,clearTimeout(this.timeoutId),this.timeoutId=setTimeout(()=>{this.querySelf().catch(e=>{this.log.error("error running self-query",e)})},this.initialInterval))}stop(){this.running=!1,this.timeoutId!=null&&clearTimeout(this.timeoutId),this.controller!=null&&this.controller.abort()}async querySelf(){if(!this.running){this.log("skip self-query because we are not started");return}if(this.querySelfPromise!=null)return this.log("joining existing self query"),this.querySelfPromise.promise;if(this.querySelfPromise=Re(),this.running){this.controller=new AbortController;const e=[this.controller.signal];if(this.initialQuerySelfHasRun==null){const n=AbortSignal.timeout(this.queryTimeout);e.push(n)}const t=ft(e);this.controller.signal;try{this.routingTable.size===0&&(this.log("routing table was empty, waiting for some peers before running query"),await y4e(this.routingTable,"peer:add",{signal:t,filter:s=>!this.peerId.equals(s.detail)}),this.log("routing table has peers, continuing with query")),this.log("run self-query, look for %d peers timing out after %dms",this.count,this.queryTimeout);const n=Date.now(),i=await cn(this.peerRouting.getClosestPeers(this.peerId.toMultihash().bytes,{signal:t,isSelfQuery:!0}),s=>yy(s,this.count),async s=>BB(s));this.log("self-query found %d peers in %dms",i,Date.now()-n)}catch(n){this.log.error("self-query error",n)}finally{t.clear(),this.initialQuerySelfHasRun!=null&&(this.initialQuerySelfHasRun.resolve(),this.initialQuerySelfHasRun=void 0)}}this.querySelfPromise.resolve(),this.querySelfPromise=void 0,this.running&&(this.timeoutId=setTimeout(()=>{this.querySelf().catch(e=>{this.log.error("error running self-query",e)})},this.interval))}}class w4e extends er{constructor(t,n){super();u(this,"log");u(this,"reprovideQueue");u(this,"maxQueueSize");u(this,"datastore");u(this,"timeout");u(this,"reprovideTimeout");u(this,"running");u(this,"shutdownController");u(this,"reprovideThreshold");u(this,"contentRouting");u(this,"datastorePrefix");u(this,"addressManager");u(this,"validity");u(this,"interval");u(this,"lock");u(this,"peerId");this.log=t.logger.forComponent(`${n.logPrefix}:reprovider`),this.peerId=t.peerId,this.reprovideQueue=new Ml({concurrency:n.concurrency??M3e,metrics:t.metrics,metricName:`${n.metricsPrefix}_reprovide_queue`}),this.reprovideTimeout=new pp({...n.timeout??{},metrics:t.metrics,metricName:`${n.metricsPrefix}_reprovide_timeout_milliseconds`}),this.datastore=t.datastore,this.addressManager=t.addressManager,this.datastorePrefix=`${n.datastorePrefix}/provider`,this.reprovideThreshold=n.threshold??N3e,this.maxQueueSize=n.maxQueueSize??O3e,this.validity=n.validity??$3e,this.interval=n.interval??R3e,this.contentRouting=n.contentRouting,this.lock=n.lock,this.running=!1,this.reprovide=RB(this.reprovide.bind(this),n.operationMetrics,"PROVIDE")}start(){this.running||(this.running=!0,this.shutdownController=new AbortController,this.shutdownController.signal,this.timeout=setTimeout(()=>{this.cleanUp().catch(t=>{this.log.error("error running reprovide/cleanup - %e",t)})},this.interval))}stop(){var t;this.running=!1,this.reprovideQueue.clear(),clearTimeout(this.timeout),(t=this.shutdownController)==null||t.abort()}async cleanUp(){const t=await this.lock.writeLock();try{this.safeDispatchEvent("reprovide:start");for await(const n of this.datastore.query({prefix:this.datastorePrefix}))try{const{cid:i,peerId:s}=MB(n.key),o=OB(n.value).getTime(),a=o+this.validity,c=Date.now(),l=c>a;this.log.trace("comparing: %d < %d = %s %s",o,c-this.validity,l,l?"(expired)":""),l&&await this.datastore.delete(n.key),this.peerId.equals(s)&&c-a<this.reprovideThreshold&&this.queueReprovide(i).catch(d=>{this.log.error("could not reprovide %c - %e",i,d)})}catch(i){this.log.error("error processing datastore key %s - %e",n.key,i.message)}this.log("reprovide/cleanup successful")}finally{t(),this.safeDispatchEvent("reprovide:end"),this.running&&(this.timeout=setTimeout(()=>{this.cleanUp().catch(n=>{this.log.error("error running re-provide - %e",n)})},this.interval))}}async queueReprovide(t){var i;if(!this.running)return;this.log.trace("waiting for queue capacity before adding %c to re-provide queue",t),await this.reprovideQueue.onSizeLessThan(this.maxQueueSize);const n=this.reprovideQueue.queue.find(s=>s.options.cid.equals(t));if(n!=null)return this.log.trace("not adding %c to re-provide queue - already in queue",t),n.join();this.log.trace("adding %c to re-provide queue",t),this.reprovideQueue.add(async s=>{var a;if((a=s.signal)==null||a.throwIfAborted(),!this.running)return;this.log.trace("re-providing %c",t);const o=this.reprovideTimeout.getTimeoutSignal(s);try{await this.reprovide(s.cid,s)}finally{this.reprovideTimeout.cleanUp(o)}this.log.trace("re-provided %c",t)},{signal:(i=this.shutdownController)==null?void 0:i.signal,cid:t}).catch(s=>{this.log.error("could not re-provide key %c - %e",t,s)})}async reprovide(t,n){await mo(this.contentRouting.provide(t,this.addressManager.getAddresses(),n))}}const b4e=20,v4e=5e3,E4e="kad-close",S4e=50;class x4e{constructor(e,t){u(this,"routingTable");u(this,"components");u(this,"closestPeers");u(this,"newPeers");u(this,"refreshInterval");u(this,"peerSetSize");u(this,"timeout");u(this,"closeTagName");u(this,"closeTagValue");u(this,"log");u(this,"running");this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:routing-table`),this.routingTable=t.routingTable,this.refreshInterval=t.refreshInterval??v4e,this.peerSetSize=t.peerSetSize??b4e,this.closeTagName=t.closeTagName??E4e,this.closeTagValue=t.closeTagValue??S4e,this.closestPeers=new ts,this.onPeerPing=this.onPeerPing.bind(this),this.running=!1}async start(){if(this.running)return;this.running=!0;const e=await cs(this.components.peerId);this.newPeers=new hE(e,this.peerSetSize),this.routingTable.addEventListener("peer:ping",this.onPeerPing),this.timeout=setInterval(()=>{this.updatePeerTags().catch(t=>{this.log.error("error updating peer tags - %e",t)})},this.refreshInterval)}stop(){this.running=!1,this.routingTable.removeEventListener("peer:ping",this.onPeerPing),clearTimeout(this.timeout)}onPeerPing(e){var t;(t=this.newPeers)==null||t.add({id:e.detail,multiaddrs:[]}).catch(n=>{this.log.error("error adding peer to distance list - %e",n)})}async updatePeerTags(){var i;const e=new ts((i=this.newPeers)==null?void 0:i.peers.map(s=>s.id)),t=e.difference(this.closestPeers),n=this.closestPeers.difference(e);this.closestPeers=e,await Promise.all([...[...t].map(async s=>{await this.components.peerStore.merge(s,{tags:{[this.closeTagName]:{value:this.closeTagValue},[bB]:{value:1}}})}),...[...n].map(async s=>{await this.components.peerStore.merge(s,{tags:{[this.closeTagName]:void 0,[bB]:void 0}})})])}}function _3(r){return Array.isArray(r==null?void 0:r.peers)}class A4e{constructor(e){u(this,"root");u(this,"localPeer");u(this,"prefixLength");u(this,"splitThreshold");u(this,"kBucketSize");u(this,"numberOfNodesToPing");u(this,"lastPingThreshold");u(this,"ping");u(this,"verify");u(this,"onAdd");u(this,"onRemove");u(this,"onMove");u(this,"addingPeerMap");this.prefixLength=e.prefixLength??k4e,this.kBucketSize=e.kBucketSize??UB,this.splitThreshold=e.splitThreshold??this.kBucketSize,this.numberOfNodesToPing=e.numberOfOldContactsToPing??P4e,this.lastPingThreshold=e.lastPingThreshold??M4e,this.ping=e.ping,this.verify=e.verify,this.onAdd=e.onAdd,this.onRemove=e.onRemove,this.addingPeerMap=new sc,this.root={prefix:"",depth:0,peers:[]}}async addSelfPeer(e){this.localPeer={peerId:e,kadId:await cs(e),lastPing:Date.now()}}async add(e,t){const n={peerId:e,kadId:await cs(e),lastPing:0},i=this.addingPeerMap.get(e);if(i!=null)return i;try{const s=this._add(n,t);this.addingPeerMap.set(e,s),await s}finally{this.addingPeerMap.delete(e)}}async _add(e,t){var o;const n=this._determineBucket(e.kadId);if(this._indexOf(n,e.kadId)>-1)return;if(n.peers.length===this.splitThreshold&&n.depth<this.prefixLength){await this._split(n),await this._add(e,t);return}if(n.peers.length<this.kBucketSize){if(!I4e(e,this.lastPingThreshold)){n.peers.push(e),await((o=this.onAdd)==null?void 0:o.call(this,e,n));return}await this.verify(e,t)&&(e.lastPing=Date.now(),await this._add(e,t));return}const i=n.peers.filter(a=>{var c;return!(a.peerId.equals((c=this.localPeer)==null?void 0:c.peerId)||a.lastPing>Date.now()-this.lastPingThreshold)}).sort((a,c)=>a.lastPing<c.lastPing?-1:a.lastPing>c.lastPing?1:0).slice(0,this.numberOfNodesToPing);let s=!1;for await(const a of this.ping(i,t))s=!0,await this.remove(a.kadId);s&&await this._add(e,t)}*closest(e,t=this.kBucketSize){const n=new hE(e,t);for(const i of this.toIterable())n.addWithKadId({id:i.peerId,multiaddrs:[]},i.kadId);yield*Ld(n.peers,i=>i.id)}count(){function e(t){if(_3(t))return t.peers.length;let n=0;return t.left!=null&&(n+=e(t.left)),t.right!=null&&(n+=e(t.right)),n}return e(this.root)}get(e){const t=this._determineBucket(e),n=this._indexOf(t,e);return t.peers[n]}async remove(e){var i;const t=this._determineBucket(e),n=this._indexOf(t,e);if(n>-1){const s=t.peers.splice(n,1)[0];await((i=this.onRemove)==null?void 0:i.call(this,s,t))}}*toIterable(){function*e(t){if(_3(t)){yield*t.peers;return}yield*e(t.left),yield*e(t.right)}yield*e(this.root)}distance(e,t){return BigInt("0x"+re(xc(e,t),"base16"))}_determineBucket(e){const t=re(e,"base2");function n(i,s=0){return _3(i)?i:t[s]==="0"?n(i.left,s+1):n(i.right,s+1)}return n(this.root)}_indexOf(e,t){return e.peers.findIndex(n=>qe(n.kadId,t))}async _split(e){var i,s;const t={prefix:"0",depth:e.depth+1,peers:[]},n={prefix:"1",depth:e.depth+1,peers:[]};for(const o of e.peers)re(o.kadId,"base2")[e.depth]==="0"?(t.peers.push(o),await((i=this.onMove)==null?void 0:i.call(this,o,e,t))):(n.peers.push(o),await((s=this.onMove)==null?void 0:s.call(this,o,e,n)));C4e(e,t,n)}}function C4e(r,e,t){return delete r.peers,r.left=e,r.right=t,r.prefix===""&&(delete r.depth,delete r.prefix),!0}function I4e(r,e){return r.lastPing<Date.now()-e}const UB=20,k4e=6,_4e=20,T4e=100,P4e=3,D4e=20,$4e=100,FB="kad-peer",N4e=1,M4e=6e5,O4e=!0,R4e=1e3;class L4e extends er{constructor(t,n){super();u(this,"kBucketSize");u(this,"kb");u(this,"network");u(this,"closestPeerTagger");u(this,"log");u(this,"components");u(this,"running");u(this,"pingNewContactTimeout");u(this,"pingNewContactQueue");u(this,"pingOldContactTimeout");u(this,"pingOldContactQueue");u(this,"populateFromDatastoreOnStart");u(this,"populateFromDatastoreLimit");u(this,"protocol");u(this,"peerTagName");u(this,"peerTagValue");u(this,"metrics");this.components=t,this.log=t.logger.forComponent(`${n.logPrefix}:routing-table`),this.kBucketSize=n.kBucketSize??UB,this.running=!1,this.protocol=n.protocol,this.network=n.network,this.peerTagName=n.peerTagName??FB,this.peerTagValue=n.peerTagValue??N4e,this.pingOldContacts=this.pingOldContacts.bind(this),this.verifyNewContact=this.verifyNewContact.bind(this),this.peerAdded=this.peerAdded.bind(this),this.peerRemoved=this.peerRemoved.bind(this),this.populateFromDatastoreOnStart=n.populateFromDatastoreOnStart??O4e,this.populateFromDatastoreLimit=n.populateFromDatastoreLimit??R4e,this.pingOldContactQueue=new ic({concurrency:n.pingOldContactConcurrency??D4e,metricName:`${n.metricsPrefix}_ping_old_contact_queue`,metrics:this.components.metrics,maxSize:n.pingOldContactMaxQueueSize??$4e}),this.pingOldContactTimeout=new pp({...n.pingOldContactTimeout??{},metrics:this.components.metrics,metricName:`${n.metricsPrefix}_routing_table_ping_old_contact_time_milliseconds`}),this.pingNewContactQueue=new ic({concurrency:n.pingNewContactConcurrency??_4e,metricName:`${n.metricsPrefix}_ping_new_contact_queue`,metrics:this.components.metrics,maxSize:n.pingNewContactMaxQueueSize??T4e}),this.pingNewContactTimeout=new pp({...n.pingNewContactTimeout??{},metrics:this.components.metrics,metricName:`${n.metricsPrefix}_routing_table_ping_new_contact_time_milliseconds`}),this.kb=new A4e({kBucketSize:n.kBucketSize,prefixLength:n.prefixLength,splitThreshold:n.splitThreshold,numberOfOldContactsToPing:n.numberOfOldContactsToPing,lastPingThreshold:n.lastPingThreshold,ping:this.pingOldContacts,verify:this.verifyNewContact,onAdd:this.peerAdded,onRemove:this.peerRemoved}),this.closestPeerTagger=new x4e(this.components,{logPrefix:n.logPrefix,routingTable:this,peerSetSize:n.closestPeerSetSize,refreshInterval:n.closestPeerSetRefreshInterval,closeTagName:n.closeTagName,closeTagValue:n.closeTagValue}),this.components.metrics!=null&&(this.metrics={routingTableSize:this.components.metrics.registerMetric(`${n.metricsPrefix}_routing_table_size`),routingTableKadBucketTotal:this.components.metrics.registerMetric(`${n.metricsPrefix}_routing_table_kad_bucket_total`),routingTableKadBucketAverageOccupancy:this.components.metrics.registerMetric(`${n.metricsPrefix}_routing_table_kad_bucket_average_occupancy`),routingTableKadBucketMinOccupancy:this.components.metrics.registerMetric(`${n.metricsPrefix}_routing_table_kad_bucket_min_occupancy`),routingTableKadBucketMaxOccupancy:this.components.metrics.registerMetric(`${n.metricsPrefix}_routing_table_kad_bucket_max_occupancy`),routingTableKadBucketMaxDepth:this.components.metrics.registerMetric(`${n.metricsPrefix}_routing_table_kad_bucket_max_depth`),kadBucketEvents:this.components.metrics.registerCounterGroup(`${n.metricsPrefix}_kad_bucket_events_total`)})}isStarted(){return this.running}async start(){this.running||(this.running=!0,await xo(this.closestPeerTagger),await this.kb.addSelfPeer(this.components.peerId))}async afterStart(){Promise.resolve().then(async()=>{if(!this.populateFromDatastoreOnStart)return;let t=0;for(const n of await this.components.peerStore.all({filters:[i=>i.protocols.includes(this.protocol)&&i.tags.has(FB)],limit:this.populateFromDatastoreLimit})){if(!this.running)return;try{await this.add(n.id),t++}catch{this.log("failed to add peer %p to routing table, removing kad-dht peer tags - %e"),await this.components.peerStore.merge(n.id,{tags:{[this.peerTagName]:void 0}})}}this.log("added %d peer store peers to the routing table",t)}).catch(t=>{this.log.error("error adding peer store peers to the routing table %e",t)})}async stop(){this.running=!1,await Ka(this.closestPeerTagger),this.pingOldContactQueue.abort(),this.pingNewContactQueue.abort()}async peerAdded(t,n){var i;this.components.peerId.equals(t.peerId)||await this.components.peerStore.merge(t.peerId,{tags:{[this.peerTagName]:{value:this.peerTagValue}}}),this.updateMetrics(),(i=this.metrics)==null||i.kadBucketEvents.increment({peer_added:!0}),this.safeDispatchEvent("peer:add",{detail:t.peerId})}async peerRemoved(t,n){var i;this.components.peerId.equals(t.peerId)||await this.components.peerStore.merge(t.peerId,{tags:{[this.peerTagName]:void 0}}),this.updateMetrics(),(i=this.metrics)==null||i.kadBucketEvents.increment({peer_removed:!0}),this.safeDispatchEvent("peer:remove",{detail:t.peerId})}async*pingOldContacts(t,n){var s;if(!this.running)return;const i=[];for(const o of t){if(this.kb.get(o.kadId)==null){this.log("asked to ping contact %p that was not in routing table",o.peerId);continue}(s=this.metrics)==null||s.kadBucketEvents.increment({ping_old_contact:!0}),i.push(async()=>{const a=this.pingOldContactQueue.find(o.peerId);if(a!=null)return this.log("asked to ping contact %p was already being pinged",o.peerId),await a.join(n)?void 0:o;if(!await this.pingOldContactQueue.add(async l=>{var p;const d=this.pingOldContactTimeout.getTimeoutSignal(),h=ft([d,l==null?void 0:l.signal]);try{return await this.pingContact(o,l)}catch{return(p=this.metrics)==null||p.kadBucketEvents.increment({ping_old_contact_error:!0}),!0}finally{this.pingOldContactTimeout.cleanUp(d),h.clear()}},{peerId:o.peerId,signal:n==null?void 0:n.signal}))return o})}for await(const o of lp(i))o!=null&&(yield o)}async verifyNewContact(t,n){var o;const i=this.pingNewContactTimeout.getTimeoutSignal(),s=ft([i,n==null?void 0:n.signal]);try{const a=this.pingNewContactQueue.find(t.peerId);return a!=null?(this.log("joining existing ping to add new peer %p to routing table",t.peerId),await a.join({signal:s})):await this.pingNewContactQueue.add(async c=>{var l;return(l=this.metrics)==null||l.kadBucketEvents.increment({ping_new_contact:!0}),this.log("pinging new peer %p before adding to routing table",t.peerId),this.pingContact(t,c)},{peerId:t.peerId,signal:s})}catch{return this.log.trace("tried to add peer %p but they were not online",t.peerId),(o=this.metrics)==null||o.kadBucketEvents.increment({ping_new_contact_error:!0}),!1}finally{this.pingNewContactTimeout.cleanUp(i),s.clear()}}async pingContact(t,n){try{this.log("pinging contact %p",t.peerId);for await(const i of this.network.sendRequest(t.peerId,{type:It.PING},n))if(i.type===fE.PEER_RESPONSE)return i.messageType===It.PING?(this.log("contact %p ping ok",t.peerId),this.safeDispatchEvent("peer:ping",{detail:t.peerId}),!0):!1;return!1}catch(i){return this.log("error pinging old contact %p - %e",t.peerId,i),!1}}get size(){return this.kb==null?0:this.kb.count()}async find(t){var i;const n=await cs(t);return(i=this.kb.get(n))==null?void 0:i.peerId}closestPeer(t){const n=this.closestPeers(t,1);if(n.length>0)return n[0]}closestPeers(t,n=this.kBucketSize){return this.kb==null?[]:[...this.kb.closest(t,n)]}async add(t,n){if(this.kb==null)throw new Error("RoutingTable is not started");await this.kb.add(t,n)}async remove(t){if(this.kb==null)throw new Error("RoutingTable is not started");const n=await cs(t);await this.kb.remove(n)}updateMetrics(){if(this.metrics==null||this.kb==null)return;let t=0,n=0,i=0,s=20,o=0;function a(c){if(_3(c)){c.depth>i&&(i=c.depth),n++,t+=c.peers.length,c.peers.length<s&&(s=c.peers.length),c.peers.length>o&&(o=c.peers.length);return}a(c.left),a(c.right)}a(this.kb.root),this.metrics.routingTableSize.update(t),this.metrics.routingTableKadBucketTotal.update(n),this.metrics.routingTableKadBucketAverageOccupancy.update(Math.round(t/n)),this.metrics.routingTableKadBucketMinOccupancy.update(s),this.metrics.routingTableKadBucketMaxOccupancy.update(o),this.metrics.routingTableKadBucketMaxDepth.update(i)}}const B4e=[77591,22417,43971,28421,740,29829,71467,228973,196661,78537,27689,36431,44415,14362,19456,106025,96308,2882,49509,21149,87173,131409,75844,23676,121838,30291,17492,2953,7564,110620,129477,127283,53113,72417,165166,109690,21200,102125,24049,71504,90342,25307,72039,26812,26715,32264,133800,71161,88956,171987,51779,24425,16671,30251,186294,247761,14202,2121,8465,35024,4876,85917,169730,3638,256836,96184,943,18678,6583,52907,35807,112254,214097,18796,11595,9243,23554,887,268203,382004,24590,111335,11625,16619,29039,102425,69006,97976,92362,32552,63717,41433,128974,137630,59943,10019,13986,35430,33665,108037,43799,43280,38195,29078,58629,18265,14425,46832,235538,40830,77881,110717,58937,3463,325358,51300,47623,117252,19007,10170,20540,91237,294813,4951,79841,56232,36270,128547,69209,66275,100156,32063,73531,34439,80937,28892,44466,88595,216307,32583,49620,16605,82127,45807,21630,78726,20235,40163,111007,96926,5567,72083,21665,58844,39419,179767,48328,42662,51550,5251,37811,49608,81056,50854,55513,20922,18891,197409,164656,32593,71449,220474,58919,85682,67854,13758,35066,3565,61905,214793,119572,141419,21504,10302,27354,67003,46131,32668,15165,64871,34450,17821,2757,11452,34189,5160,12257,85523,560,53385,65887,119549,135620,312353,115979,122356,10867,193231,124537,54783,90675,120791,4715,142253,50943,17271,43358,25331,4917,120566,34580,12878,33786,160528,32523,4869,301307,104817,81491,23276,8832,97911,31265,52065,7998,49622,9715,43998,34091,84587,20664,69041,29419,53205,10838,58288,116145,6185,5154,141795,35924,21307,144738,43730,12085,8279,10002,119,133779,199668,72938,31768,39176,67875,38453,9700,44144,4121,116048,41733,12868,82669,92308,128,34262,11332,7712,90764,36141,13553,71312,77470,117314,96549,49135,23602,54468,28605,6327,62308,17171,67531,21319,14105,894,107722,46157,8503,51069,100472,45138,15246,14577,35609,191464,1757,13364,161349,32067,91705,81144,52339,5408,91066,21983,14157,100545,4372,26630,129112,1423,29676,213626,4397,88436,99190,6877,49958,26122,114348,60661,29818,293118,50042,179738,16400,163423,89627,31040,43973,36638,45952,5153,1894,109322,1898,134021,12402,112077,68309,190269,69866,31938,107383,11522,105232,11248,14868,39852,71707,186525,16530,38162,106212,11700,5130,16608,26998,59586,108399,230033,43683,48135,82179,2073,5015,196684,189293,16378,23452,8301,35640,11632,214551,29240,57644,33137,91949,55157,52384,117313,5090,17717,89668,49363,82238,241035,66216,29066,184088,97206,62820,26595,4241,135635,173672,8202,459,71355,146294,29587,3008,135385,141203,14803,6634,45094,69362,50925,546,51884,62011,83296,234584,44515,56050,89476,87751,19373,12691,149923,19794,13833,35846,87557,58339,2884,19145,25647,12224,11024,77338,64608,122297,53025,7205,36189,36294,170779,21750,7739,173883,75192,35664,224240,113121,30181,26267,27036,117827,92015,106516,55628,203549,67949,60462,60844,35911,20457,1820,920,19773,8738,73173,181993,38521,98254,76257,46008,92796,5384,26868,151566,22124,2411,15919,186872,180021,28099,152961,78811,80237,62352,102653,74259,184890,16792,123702,224945,29940,19512,75283,14059,112691,92811,233329,20411,138569,53341,109802,50600,134528,66747,5529,166531,31578,64732,67189,1596,126357,967,167999,206598,109752,119431,207825,78791,91938,10301,27311,24233,252343,28831,32812,66002,112267,90895,8786,8095,16824,22866,21813,60507,174833,19549,130985,117051,52110,6938,81923,123864,38061,919,18680,53534,46739,112893,161529,85429,26761,11900,81121,91968,15390,217947,56524,1713,6654,37089,85630,138866,61850,16491,75577,16884,98296,73523,6140,44645,6062,36366,29844,57946,37932,42472,5266,20834,19309,33753,127182,134259,35810,41805,45878,312001,14881,47757,49251,120050,44252,3708,25856,107864,120347,1228,36550,41682,34496,47025,8393,173365,246526,12894,161607,35670,90785,126572,2095,124731,157033,58694,554,12786,9642,4817,16136,47864,174698,66992,4639,69284,10625,40710,27763,51738,30404,264105,137904,109882,52487,42824,57514,2740,10479,146799,107390,16586,88038,174951,9410,16185,44158,5568,40658,46108,12763,97385,26175,108859,664,230732,67470,46663,14395,50750,141320,93140,15361,47997,55784,6791,307840,118569,107326,18056,58281,260415,54691,8790,73332,45633,7511,45674,143373,14031,11799,94491,35646,96544,14560,26049,32983,25791,83814,42094,231370,63955,139212,2359,169908,3108,183486,105867,28197,32941,124968,26402,88267,149768,23053,3078,19091,52924,25383,19209,111548,97361,3959,24880,235061,9099,24921,161254,151405,20508,7159,34381,20133,11434,74036,19974,34769,36585,1076,22454,17354,38727,235160,111547,96454,117448,156940,91330,37299,7310,26915,117060,51369,22620,61861,322264,106850,111694,15091,2624,40345,300446,177064,1707,27389,54792,327783,132669,183543,59003,17744,20603,151134,106923,53084,71803,279424,319816,11579,21946,16728,38274,72711,5085,83391,88646,40159,25027,34680,10752,12988,54126,30365,18338,100445,230674,44874,84974,143877,123253,139372,28082,91477,144002,13096,219729,46016,50029,42377,14601,6660,58244,58978,23918,88206,113611,64452,17541,41032,10942,12021,49189,10978,40175,37156,10947,71709,106894,112538,57007,137486,150608,152719,40615,7746,279716,13101,19524,28708,40578,72320,1096,182051,94527,51275,22833,45164,81917,77519,48508,5421,140302,37845,149830,5587,27579,5357,428725,248187,6326,206760,39814,32585,89923,44341,288753,284443,96368,31201,94189,119504,20359,52073,103216,179,27934,32801,96035,34111,34309,101326,18198,20704,210266,37643,27880,141873,106e3,19414,56614,167714,66483,107885,86602,4379,20796,75467,4987,5017,118857,26003,34308,114428,29198,6686,29697,73632,3739,69795,16798,41504,7207,30722,21436,36735,28067,28545,3239,11221,36031,41889,100010,19247,317673,29495,174554,6424,129725,53845,94986,7955,59676,2604,191497,19735,102214,62954,23844,11872,179525,261436,34492,428,78404,142035,16747,17246,27578,37021,33672,57944,26056,135760,2369,61674,122066,31327,19374,157065,40553,130982,69619,71290,38855,72100,92903,95940,51422,165999,65713,57873,50726,7288,20272,2081,42326,22624,81120,57914,79352,19447,1684,72302,11774,302559,161481,96396,13692,414988,3721,79066,56627,46883,21150,11747,12184,5856,113458,176117,84416,52079,27933,3354,59765,141359,2212,216309,2555,23458,196722,142463,45701,44548,28798,19418,215,29916,9396,10574,114226,84475,13520,18694,34056,4524,90302,62930,13539,19407,77209,7728,38088,9535,2263,23875,183945,17750,26274,67172,10585,28042,22199,7478,51331,66030,26774,192929,31434,25850,50197,52926,178158,4679,181256,70184,229600,9959,105594,72158,73974,2726,35085,78087,23284,35568,51713,155676,5401,27254,11966,17569,223253,71993,103357,111477,55722,30504,26034,46774,35392,36285,214814,41143,163465,1051,16094,81044,6636,76489,179102,20712,39178,35683,125177,54219,30617,52994,25324,50123,2543,87529,58995,10688,125199,12388,60158,125481,131646,7642,133350,65874,3438,97277,101450,10075,56344,116821,50778,60547,98016,106135,13859,14255,16300,77373,173521,8285,45932,37426,4054,114295,55947,7703,39114,52,51119,128135,19714,60715,9554,50492,88180,2823,118271,52993,122625,97919,23859,37895,25040,33614,32102,20431,3577,9275,15686,43031,157741,110358,1884,40291,125391,13736,5008,64881,87336,77381,70711,43032,49155,118587,70494,4318,10168,30126,12580,10524,280104,104001,145413,2862,84140,6603,106005,13566,12780,11251,42830,571,179910,82443,13146,469,42714,32591,265217,424024,92553,54721,134100,6007,15242,114681,59030,16718,85465,200214,85982,55174,165013,23493,56964,82529,109150,32706,27568,82442,5350,14976,13165,44890,60021,21343,33978,17264,4655,22328,27819,75730,16567,55483,14510,17926,45827,150609,3704,7385,272531,161543,76904,122163,52405,2039,19165,41623,14423,228354,3369,176360,85491,7122,35789,303724,4465,13628,2233,55311,118771,20713,10006,221519,45115,71021,35650,29775,7337,10864,20665,21142,1746,15080,1624,32449,10905,105743,229797,7701,3940,22997,178467,57208,389057,39683,59403,63344,63125,54847,69691,18336,56448,3362,37202,18282,29648,138224,35867,10495,5911,28814,26653,31514,176702,26550,45621,11734,4525,40543,73944,121080,27858,155561,14887,44670,30742,8796,107455,113472,56369,75581,183777,240095,133699,153299,8768,160464,26058,49078,103971,21875,71486,44888,17156,9678,89541,123019,102337,3972,83930,21245,87852,109660,287918,183019,686,10100,39177,283941,11274,24736,26793,26214,25995,77011,141580,4070,23742,46285,46632,30700,26669,19056,35951,115575,174034,56097,35463,87425,24575,44245,38701,82317,85922,281616,100333,147697,61503,7730,84330,8530,59917,61597,17173,9092,32658,90288,193136,39023,20381,56654,31132,7779,1919,1375,117128,30819,11169,40938,23935,115201,101155,151034,4835,11231,74550,89388,59951,91704,107312,167882,115062,12732,72738,88703,464019,158267,57995,60496,737,14371,123867,4174,243339,159946,7568,16025,134556,110916,38103,191,80226,88794,29688,27230,10454,76308,57647,77409,113483,66864,14745,19808,12023,46583,84805,16015,17102,2231,20611,3547,95740,250131,34559,108894,8498,15853,159169,148920,20942,2813,93160,45188,210613,45531,52587,149062,39782,28194,57849,60965,84954,89766,84453,100927,16501,27658,165311,103841,54192,207341,19558,20084,319622,5672,205467,98462,61849,36279,13609,147177,24726,165015,209489,59591,31157,6551,117580,75060,141146,277310,21072,22023,106474,63041,137443,122965,68371,5383,42146,98961,113467,30863,23794,4843,99630,30392,82679,13699,241612,33601,93146,24319,18643,32155,95669,40440,15333,34089,67799,142144,58245,38633,114531,117400,77861,188726,5507,2568,8853,10987,107222,2663,2421,11530,13345,30075,41785,118661,104786,17459,12490,16281,71936,193555,17431,5944,71758,26485,77317,20803,367167,158,7362,93430,11735,172445,46002,11532,54482,930,62911,2235,23004,179236,4764,101859,208113,22477,55163,95579,14098,67320,162556,90709,156949,3826,57492,4025,34092,87442,104565,6718,186015,28214,14209,10039,107186,233912,58877,81637,55265,39828,6194,145813,50831,105849,4974,88319,122296,10272,197216,95714,51540,72418,23324,91555,8743,140452,250249,51666,34124,7229,38592,129641,78169,174242,22464,149964,51450,14034,10026,95376,26190,120062,14401,8700,265,31386,143573,7203,229889,61567,4227,140981,2466,72052,10787,10062,30958,6099,38471,30103,23202,208101,70847,467,58934,32271,32984,36637,24107,30771,17109,73353,13650,2098,157040,67366,66904,106018,265380,107238,18535,44025,32681,144983,62505,91295,56120,3082,77508,10322,63023,36700,81885,224127,16721,45023,239261,111272,13852,7866,149243,204199,32309,22084,42029,38316,126644,104973,14406,43454,67322,61310,15789,40285,24026,181047,6301,70927,23319,115823,27248,66693,115875,278566,63007,146844,56841,59007,87368,180001,22370,42114,80605,12022,10374,308,25079,14689,12618,63368,7936,264973,212291,136713,95999,105801,18965,32075,48700,52230,35119,96912,32992,8586,16606,101333,101812,14969,39930,759,193090,27387,42914,12937,5058,62646,64528,38624,25743,37502,3716,4435,30352,178687,26461,132611,42002,138442,35833,59582,16345,8048,60319,49349,309,47800,49739,90482,26405,34470,63786,32479,85028,39866,47846,11649,23934,29466,2816,42864,31828,7410,74885,49632,47629,111801,90749,19536,18767,105764,59606,21223,10746,76298,22220,39408,7190,79654,64856,11602,82156,272765,17079,70089,245473,51813,184407,384678,1576,122249,5064,27481,6188,25790,74361,27541,318284,45430,31488,620,93579,45723,192118,22670,51913,4162,70244,35966,26397,16199,50899,209613,121702,287507,2993,36101,132229,67345,33062,76295,118628,78705,52316,34375,107083,107454,44863,127561,33964,3073,154010,190914,55967,39074,6272,31047,5550,41123,26154,98638,47110,19998,148091,50229,31329,59900,195442,19106,61347,73497,70015,682,45850,25776,38022,148951,6288,37411,232526,109277,27286,32342,9262,5220,16651,23175,46740,129438,78614,121925,66914,88710,127952,5563,21500,34521,10739,14863,191006,62956,17359,16749,67027,56284,69134,43301,35039,58883,54466,60823,404451,75743,59856,86979,7923,34273,83785,32142,7693,268986,197428,282681,17049,22346,22990,92245,107180,3357,37104,96724,49153,7683,31197,43267,82231,164276,23696,20848,188364,22309,24821,158707,1018,22514,70922,27792,45589,59709,10765,736,35218,63479,51987,24275,63588,55361,92929,81964,4658,20122,12330,44058,13065,311456,72224,8337,211229,38979,22590,138478,52757,32595,133600,8838,31549,94412,43391,90056,1585,94802,127271,6223,31889,137038,132910,2165,57616,230152,6080,10748,36737,74579,134062,50525,180532,119270,34556,76155,82394,52595,29258,31435,87820,67996,26943,183878,38007,2410,13526,180297,69856,3503,187396,167700,7838,16701,9199,56267,3661,37407,65994,23767,5708,62508,221700,67088,86978,46776,84434,32088,5612,9149,88244,21685,95151,46750,189612,2979,506311,2594,3628,40074,105039,78243,28523,6651,38058,71999,30992,12764,68261,108991,6165,26450,61961,13400,22426,7490,60890,109623,2070,12958,50355,67979,257096,7213,42578,52121,35716,65461,7516,124758,39268,302,64712,14977,1467,219452,2840,34229,11121,21602,19270,63574,8024,1532,17331,79839,78885,52029,180767,57957,6069,91265,61380,55767,8927,32881,287603,22149,35029,68876,6428,199567,46926,13412,104132,21434,366616,45060,110046,81924,128910,45886,52821,130416,29416,77342,21762,67329,121432,79924,11724,38625,81006,102033,28338,13326,3250,82056,82526,38212,21112,12382,111495,3263,7414,86274,93490,40844,30224,45212,24019,48411,71367,24941,76729,57776,3769,38114,202019,197745,31953,237533,33270,201580,255648,100798,44741,32241,98468,106931,10085,15090,170358,33154,66787,18819,69760,25061,234005,82660,6295,131975,16874,9076,4094,25005,17740,40908,19533,220019,44330,99792,50040,19619,13950,55228,24423,31253,95308,103177,184795,28590,82285,5059,3210,75525,49894,70007,56178,10580,36051,139681,21617,98736,3555,106306,164189,37352,63915,47824,24883,145530,61904,28444,11483,19837,145446,30420,112972,85939,11835,191233,2262,20705,58630,1753,148334,1197,144714,6887,11223,107667,60879,77914,4151,57417,81594,96681,169430,1784,20444,95138,254041,27038,596,7117,72808,13759,3353,126776,21074,55322,27081,36942,39547,139830,179275,4453,713,8722,71399,19204,25785,22794,23923,104114,11291,25458,102309,88396,75288,230440,206396,104551,58447,130857,37247,94734,31548,176529,226077,65159,20104,10096,66881,94191,237909,27109,37404,1520,27421,25220,113003,23423,24884,50585,6286,231877,150800,11789,3226,90004,60642,5053,202400,61442,132531,175329,57138,30116,103847,9973,75367,16452,32360,59119,21246,10191,164804,23305,61051,37348,154530,13214,5468,50403,66754,130976,50559,80515,14436,155492,84017,5472,43107,41240,2890,90431,70188,382,76234,48040,50211,281038,237007,32115,142178,1536,22761,96429,1811,31243,1679,49143,55209,17402,235054,61494,7462,77030,34925,87609,78002,9499,9027,73289,201078,101379,63544,27666,5469,10642,30029,49816,132979,95620,58086,351930,116300,2110,2043,30845,6154,11279,16727,4122,2277,27281,4971,3650,39060,61970,65951,39674,75686,38151,11370,130809,177895,32665,63725,122267,7857,39618,118483,44792,157755,178624,136994,24260,41308,22471,12404,21707,12486,30473,52781,50246,20247,39065,909,56825,103158,128603,31542,1089,41935,32744,12428,37963,84420,33134,72921,208449,42622,168151,127335,147107,46699,38216,12591,94342,85814,31423,24944,2605,87542,67473,192551,4496,56321,91819,17630,6300,256183,114569,202090,33209,35289,34897,24967,40520,43470,5344,10199,34810,14283,10381,10017,62923,49924,23233,64539,13051,35686,19698,11570,135555,120868,44924,87065,52318,52335,47586,140906,245885,109834,78668,9065,46990,25258,72022,61243,40838,4545,146387,10537,11557,17470,36930,68104,46711,24264,79401,81043,18225,120488,24746,84338,81652,28266,13776,21878,46973,1047,230465,73357,95777,24973,210160,62210,58404,110633,169651,6937,41870,9909,26822,191062,76553,27519,96256,239070,2478,205678,67955,58532,20601,50120,19148,78501,195724,110740,8249,109665,27446,30568,57631,31425,49752,32820,65504,50079,3663,102256,219898,23849,211315,14645,4359,91767,9528,12449,49366,7941,49763,107848,8930,27086,50686,9744,10447,81935,39513,46514,1670,29229,6172,22312,137280,97759,9806,14445,22976,56458,73391,34983,93760,174219,52573,33149,59747,2429,136277,75123,165263,91040,7446,57632,48633,97140,246081,84766,151684,79918,93268,120346,54059,54875,77858,32996,103590,45276,11968,19600,25849,17159,132907,42828,16817,4913,99462,103303,27395,5737,74184,20749,21160,14377,77062,131403,158735,10999,27799,77785,9320,34366,51593,61070,33746,47048,29268,36675,30262,53297,9832,82e3,20188,122292,39917,7331,18160,68301,185935,134830,15031,4935,10004,165845,185534,46923,30109,44134,122631,18874,22903,112790,26561,18549,348902,82871,140345,255565,135390,63556,103747,145055,179600,145662,296111,61661,211987,23952,52342,126343,48450,32919,44277,82185,9591,62139,205363,376969,394874,108461,18040,120885,14798,39863,16571,16794,58271,81025,55206,14640,118656,6361,44092,85970,6262,153863,108244,180200,72264,79947,38044,10050,5735,61221,80712,5471,115689,11391,11661,184257,20010,60116,30320,19327,134598,45455,27542,18004,125092,452272,1549,91523,46567,180063,156026,2608,11174,58848,37788,65907,80194,30490,5786,40775,119519,106241,11323,156297,8425,61495,2617,29675,2425,59886,112582,49142,59618,4863,50597,86710,50650,168632,27693,85641,83643,18993,25768,84284,28090,93592,36627,312804,43381,9887,9402,100931,97165,3311,173330,66805,28935,4963,184460,3201,78102,19126,21607,37496,24938,22615,16153,32862,134792,153318,61120,6067,2812,12826,12792,23825,37559,64662,202250,102694,155488,85881,149193,46233,65383,15521,106982,11358,176786,25752,39717,34208,24510,32464,77742,39371,72028,138229,60688,71386,102834,132477,2208,11548,63670,271279,28351,30338,38620,32491,99845,143885,152266,13252,2825,178663,108097,1775,78201,14897,113573,163346,62292,171129,22183,96598,38733,64971,166776,117445,9968,146393,44677,74867,20908,97328,12761,25656,26785,9148,112344,26115,99176,110121,22437,49547,6180,79320,5835,31392,43328,33377,75870,119860,69497,80273,7325,155219,43167,111173,28347,20222,3763,71752,55041,47252,14618,28088,15012,97805,194698,54636,2036,41349,6173,96604,61530,51859,43782,13361,24334,22668,24792,7070,23441,16789,3209,36211,208475,26242,32880,122181,182407,21444,31060,88459,29929,77907,12716,10934,97005,20599,31690,8403,58445,30303,22700,10336,86731,103115,337709,72556,46788,112566,47684,67089,53548,36874,56487,41387,125985,26893,40071,106683,73712,18787,40105,72992,67246,137276,50802,36790,70328,138827,22466,39263,183295,29858,50975,9322,57397,10654,24364,30383,55799,41600,23584,127295,296610,129078,143558,244131,86397,36049,1085,80677,3820,108139,5476,34767,24683,7758,13060,7239,131671,250593,59556,103392,29810,4188,252323,39404,116877,7651,43600,40338,13554,157253,39196,25978,144387,61211,234,50104,6129,10449,93777,9240,356378,274148,4439,72970,3724,147770,78680,62570,115877,40027,40547,36817,224392,64609,34795,165027,67440,2477,37206,23431,50754,164797,46018,94995,170982,27051,7957,22767,3674,27900,56419,18930,60701,41302,2692,84749,339721,61996,111094,80221,50129,1045,8153,62945,19202,8250,37208,37418,32560,79477,41106,88569,33963,36693,5892,30570,1581,66471,49647,11922,160717,29442,5643,114865,82962,95982,132098,22633,22838,94726,54556,28566,205039,162340,33216,16849,35847,221339,94851,26533,71469,1805,3804,12935,45483,71020,36310,65381,192960,34240,35165,59773,1248,46954,155332,96864,4246,388800,16129,57133,74592,44807,442014,38203,42574,80818,91592,26377,36424,65760,977,77387,22628,147610,28018,30561,98454,6969,119628,63648,18170,36854,26601,64018,22027,37279,51395,152934,21153,9430,58760,194742,5330,55115,34158,28917,174111,13171,122326,1526,43896,66094,25325,4234,148354,11450,275,18999,112191,44365,22723,68409,8733,57746,96565,75007,14196,108844,29475,88599,177563,100792,106156,86323,93726,14248,135341,194131,40126,47099,14779,8272,39597,95983,171398,65882,28052,10393,47213,40689,22120,72212,106829,34964,109146,753,648,21660,30047,17527,181025,5619,145357,4085,216883,9359,186951,24779,53931,24545,36197,223296,62628,168101,4243,107313,30321,26642,13049,51059,31027,107912,807,73550,26551,84369,122422,165872,49754,74213,234264,33151,52014,33100,87183,22365,52500,40013,23302,5652,72723,21404,26107,48434,587,94049,168493,96418,32871,70860,31709,25128,443,71597,166253,15670,70994,26341,133675,28280,75491,54756,47955,56028,26182,11952,113272,472197,64640,110753,17919,337,50642,22576,142,87371,53391,93210,126694,15285,19642,85667,14148,1506,42092,52962,33243,11970,20734,135843,57044,58880,13002,219134,22876,64754,232519,4257,43120,321573,24799,64526,124728,52579,81472,70831,276848,17403,74359,23021,182101,74597,23744,148267,12055,7976,5349,11772,67540,167347,65318,18720,127832,108238,22828,90233,9987,259080,118185,73209,79270,13775,90100,137742,90799,70569,15699,19961,9087,67475,57872,39731,8810,134897,131868,146849,19898,3334,2281,167061,91073,60356,467742,74712,188,53179,137679,92769,29241,9537,132595,80119,1041,88962,5976,40171,44911,102859,139059,104558,98987,47761,19272,71472,113864,175377,73338,10857,23402,23758,1591,139864,5644,4076,118760,16427,134198,18853,20291,100849,37423,22038,36677,19071,195521,57445,11069,31869,55718,66882,148490,44,41296,75242,49704,166810,9906,20943,122258,49112,105667,15969,10344,6408,187694,21399,72742,58970,14867,14376,81889,41856,23225,15042,56993,16074,131389,74276,72407,53875,383108,53597,37363,68993,44854,122548,430927,198279,38430,80409,12245,2981,628,2818,17760,37437,238229,7968,46892,2200,3730,34190,65983,37959,112291,87850,70827,6522,20750,73913,111621,41652,19587,2780,58668,25916,85259,18200,168962,95781,42445,102050,7776,57662,103313,47742,96358,41964,66174,100396,29069,204735,19679,27978,7479,40264,22534,61183,36081,107436,58223,14680,23002,101311,24716,124108,12908,5646,31750,40380,14215,232799,102772,14122,96775,61398,50917,12096,149880,67833,598749,124194,155871,49216,790,14677,65319,56917,7440,145744,95701,12206,49405,129269,76199,45732,9767,11058,9047,210885,11051,7392,26307,2130,8132,147526,20802,232698,115660,50060,59789,57344,107623,80343,112676,23291,9866,160971,34032,118291,15719,59730,164911,28975,2659,58046,78480,21854,66209,53863,109085,116045,29021,46481,107552,22130,18764,70254,31272,11300,52460,43933,84738,20721,53869,190840,79673,105300,7561,321817,66924,13940,33281,101046,183181,32176,71878,5678,62924,79535,56646,40303,19559,27703,93042,73368,42187,3670,37376,46440,7023,36816,109628,20680,5940,276440,275233,170848,112093,136996,14984,20226,111441,77693,112960,48577,39370,55707,50314,123404,26570,54281,61372,123391,4857,35928,246740,132507,106646,44241,7196,92258,9825,37688,51197,303141,5590,15476,132986,10955,85782,34486,26696,7991,28813,18858,39546,11703,11365,38185,5716,93555,11925,40121,60002,6985,10976,171384,3887,43394,13337,56346,6381,252336,39573,75042,53711,1028,31781,44295,95925,131713,7214,68125,43571,70954,213234,1628,8760,13391,65485,17320,56038,1710,25248,60803,57399,19839,3870,326,281556,50945,72400,21460,316244,75619,56246,98775,481,13513,55765,50427,7388,123519,32929,57908,27124,61316,101097,57467,30228,48792,10788,20402,37318,50526,155730,34456,158065,145305,17832,43733,64052,4506,35072,205355,177028,184004,187081,68616,35938,83703,10367,36892,93186,260137,51934,89970,4985,23445,26755,21558,7948,78741,23376,124405,85594,68596,57536,49351,12619,56593,132668,99924,109728,71844,71935,196018,65464,17617,14987,89701,143773,33997,8687,22701,33258,2914,4436,72108,85610,9671,49067,2327,82988,1361,1672,44033,35777,30269,24057,10605,82236,616,15793,13919,47249,112086,116698,9484,80207,90574,33304,68624,93127,56101,42210,160929,4827,38995,38095,4701,125119,5027,33680,9236,231236,14135,87837,23318,70261,78893,30151,81482,14332,1084,74256,27532,46644,79185,3148,62615,6981,55672,31668,36825,1849,14536,37446,14738,23779,43058,162749,72199,1168,21346,5592,85932,85302,9668,18351,57135,150360,2080,228015,77953,34670,119302,151751,31009,106725,84265,45214,59289,74178,113071,263206,111009,4021,44449,188119,192629,123592,392506,292847,114487,12831,205858,9852,20780,79648,75767,357014,97721,18166,21005,67950,33226,204009,16536,2987,11335,66717,144910,47950,17262,55060,15063,2934,51038,26775,178497,66008,3427,49433,128592,20036,157553,63861,3089,23015,51210,28696,35933,49942,71135,231518,99620,17248,21835,176536,20676,16944,38700,165831,233253,295625,36723,13023,52745,10907,19423,67972,125868,95473,82875,1183,108455,52685,33417,64095,21433,52438,33191,127809,44505,211823,7810,2752,95548,162031,7185,91196,47563,61721,33359,17897,23682,42806,178101,22874,49707,199897,75419,82456,8618,11171,79712,116847,18783,44190,46564,5346,59046,95032,7893,14916,3214,26800,24172,121453,34362,10250,17408,18888,4840,68696,22831,13162,36005,32512,14800,62357,41723,45046,27247,37486,5372,2564,34261,298500,66509,133920,89138,31305,117697,19097,108304,81386,84106,23802,46411,63304,946,51417,41777,41041,19501,115864,60743,294354,37955,94165,18116,1156,17937,20645,57114,90804,58042,48643,92288,9861,2557,88546,61333,101008,12853,5148,87856,4152,144503,73841,18718,9789,147565,10846,42085,12789,30223,8993,56352,67203,2448,28215,6052,23540,126319,75933,36689,80235,23231,23561,21383,38800,77548,102798,21234,31468,158608,46188,63960,191679,8051,67014,11185,170078,42186,28827,34777,41930,212079,12421,34750,24111,110344,73918,45171,70826,141949,40063,23979,24254,37309,26724,27179,24718,83648,54938,14591,17425,29525,102675,48975,48654,12316,8929,60640,41709,50168,63264,89812,50716,48632,38755,138583,160123,55579,71829,24230,233277,46322,39650,166388,34718,24108,98252,7031,106695,62498,18258,35062,217827,78731,34824,33354,19520,60852,2432,60224,8587,2836,62955,702,20227,42285,40560,95592,62486,11094,53035,143291,18842,46177,77994,1770,9657,107422,172915,32655,128716,25886,25164,156740,119928,165875,85817,11007,89110,33956,12652,65156,180266,8494,36889,19958,20955,96,1264,118288,135769,44754,86671,5632,19026,168220,289120,33569,93821,66144,70635,7687,5642,2714,55445,56636,71545,184182,93133,7332,37389,12643,52315,22729,11014,158742,17050,152889,50178,34601,41945,52136,9948,26914,63548,95721,115951,40759,8960,158258,38938,49232,48325,42234,81523,253019,66128,40978,20048,238048,38760,62928,122560,118532,43687,137472,163689,26680,9878,17448,51035,16211,60834,36749,29178,14241,59868,150086,2305,26477,42422,34342,165341,83279,33894,14257,29928,12743,13957,125571,89134,66712,10952,16507,147839,30146,7249,16565,45399,39874,114565,215780,31990,230881,171477,102,196546,44538,10880,84948,281705,86651,10617,31395,2342,453658,43569,60561,132901,21845,17727,58556,258242,22262,58728,4008,77997,11806,37431,30599,81375,109137,185787,114085,217292,97453,169085,30593,60212,11544,102056,65580,2384,91655,4855,95725,7295,157994,16228,20669,53276,141590,105246,17334,25440,76067,17967,39321,38911,11362,28559,63807,21627,26468,85816,40120,1025,15234,58319,69516,66512,124548,75845,78873,22137,46681,51242,85683,32909,76747,35555,43396,101465,1765,73094,1077,2962,39028,66777,57831,42048,15828,13962,36041,63657,52412,5242,58846,2141,5506,219012,134451,3936,182230,17558,17153,152237,22621,49377,170216,35257,68233,65374,6510,11126,212151,7184,2480,22517,3437,33073,30156,16557,3768,55067,86829,91e3,12350,148650,66017,79424,70885,49066,28250,21369,51213,34533,11510,3258,18176,18465,84413,6315,36411,163765,4346,356,107618,598,13727,285026,162695,8749,14583,7132,63521,184253,32378,25991,5604,30961,53675,4874,84693,5086,34811,26978,56564,7904,33519,51221,113942,69253,6664,125563,22055,220680,102008,742,51930,19494,176108,44424,35123,13025,75685,11759,74335,22250,181453,131147,16984,132115,154311,11991,76452,52609,85351,196,30969,9198,74919,2529,56838,71779,29187,116304,3504,62330,41190,86153,28393,254926,104228,105189,13264,84359,3574,12415,8534,57147,10175,188174,59504,60932,66318,16407,107921,17638,99103,49278,28403,39786,145865,8462,3558,43406,142271,29139,21989,36552,93955,72365,7176,13556,106185,37957,321774,17782,129017,51154,27938,24952,1935,39366,2791,33489,41582,56078,24558,9311,5449,218786,27808,190429,68013,36020,86003,29735,3404,87348,119357,115714,2324,86796,81973,40992,43376,93621,28784,16808,36367,2517,2909,191926,24978,55303,53308,205724,60068,3098,21375,64784,23949,26579,63121,12319,80145,39967,97861,6757,70143,67642,37082,34698,69140,122883,46151,62187,80934,429,19437,135071,137885,222647,13331,154065,327,61778,74257,40116,37493,14855,85079,237641,42342,102164,199965,71204,4662,29368,5042,113914,122214,8955,13149,102503,43173,5659,163787,69003,307084,63392,171080,21390,81918,86666,36622,24126,28887,5736,28054,207170,163428,79891,346467,95363,38980,111806,80828,9200,19288,294896,114468,87405,111715,141705,7015,72754,68463,48738,243147,33397,101210,37051,98801,82847,20397,4940,185559,18716,54718,83491,11725,40803,1128,12128,23060,5174,7745,67007,46701,1571,27807,180186,256996,18975,16837,7877,212758,250379,15440,87954,57755,24719,124057,83461,258,50864,8874,29038,71289,31627,15429,9005,4061,113851,107716,82819,13651,79656,117851,17539,111446,12938,39724,190787,4352,15402,21070,62708,8539,23777,73853,13552,38810,86117,16285,56400,1718,75342,142863,29033,378,110113,180321,32586,23606,26393,160984,207987,23783,8406,16904,24596,47274,11693,46539,60524,78595,48423,31718,20170,9009,146268,15183,191060,172765,1349,138436,37365,10970,40509,225817,20021,70394,152138,21541,66559,66544,89352,2725,17258,91345,7313,3815,115868,8660,40362,4071,103524,39388,118275,21950,6549,38226,32754,209574,29201,43495,18028,20296,40597,18370,47520,202450,24134,2219,8195,69545,38041,136934,46374,19041,159811,84865,58620,846,98749,13569,30714,97246,32186,4479,27355,92973,35214,151491,75963,37631,1561,27200,238083,23182,60756,12291,25766,39355,102333,87362,65741,59906,19538,201575,48772,102938,24438,292580,39964,66366,9004,61379,50548,37622,38732,28379,68180,76622,17488,69849,5963,7219,48143,43413,55358,540,58691,29506,19245,52193,48621,5518,13048,118625,44755,191081,42061,89197,2259,60665,66994,71210,51232,3585,142096,55024,7892,8345,58653,463307,65658,64319,137941,136323,53499,12746,43492,6978,95163,29925,60175,5128,7352,41463,184756,121146,20473,18426,4598,5309,54580,14277,121151,10691,56711,43880,63409,76682,11830,172218,264898,32632,66536,81062,31649,25788,92774,60222,11100,63159,9432,224657,25240,53613,152,138620,163829,2397,85345,12501,37507,64932,38575,43522,65789,80198,78796,35226,3851,108891,73311,3060,28391,93671,39663,46142,30982,66041,37281,68157,26553,71872,81142,211527,39747,118119,22695,2859,11066,20232,168911,7933,197005,17066,111071,44434,133994,120798,12766,227798,45756,132852,29917,36076,55352,65281,129800,41958,18944,84678,18580,168093,132621,39997,54092,27740,32354,3770,114118,103242,43918,15899,18574,145944,3190,123469,219903,24169,100571,62403,16776,92779,14535,17168,16475,14304,37231,1712,28218,242754,61688,28980,1318,51359,222657,99200,67989,31772,23932,35351,201251,49041,27306,19128,40135,3986,77333,19649,120683,151927,21081,7076,78375,77501,101599,8011,89585,96715,58179,5378,102138,106793,26051,217276,4197,16297,27014,46721,13322,22806,5278,29629,70632,9647,71519,58818,40603,128530,8903,36770,56900,31483,26935,43845,34265,34920,87658,6114,84767,64250,47318,50720,19264,162514,33357,13117,6705,46696,75032,71054,87004,42035,69138,11903,99854,102328,19611,34525,69312,6431,49842,101600,133178,108751,41829,89939,225664,48916,99556,9195,130387,5960,36857,116724,53518,94002,39077,53996,6945,22261,64291,8314,152785,57588,16522,9091,5048,87671,35441,39509,1945,12423,158923,178413,37549,14095,1475,73188,62878,4819,24012,68534,42606,4010,120809,57497,59564,101758,103718,32701,80116,12345,95834,46918,21468,53213,15665,31200,3867,5140,96013,250744,21016,10069,13968,35449,180829,27683,39704,59956,22893,3115,26293,32785,75934,62445,141162,62720,2018,83638,19949,114012,95006,3330,99829,130935,309272,9565,55874,121727,37017,23586,319858,40970,27602,8625,112329,61060,100088,118525,25922,16232,1907,60671,51583,44553,80993,5262,94679,8676,940,20736,11823,3020,16476,12340,152600,97416,3703,25744,66826,16245,16876,46446,84798,74227,176020,45192,61955,75496,23946,23626,40372,26036,6149,11822,30582,16541,41914,82385,232823,40921,80773,14930,3631,7517,39619,4348,36180,126106,138939,62611,1477,113512,47321,25052,14546,118881,29060,23589,128322,36795,18401,137921,104699,267929,36194,172791,18113,4766,188215,30083,332586,94089,5805,77909,22194,68234,154976,43220,40660,70001,184893,138095,11128,103010,22663,5108,212615,8485,5565,49222,54614,26530,42639,16319,55062,152662,105595,21114,22216,10294,68158,10436,86950,7206,62115,3977,3657,59874,456,118617,18156,106663,112229,80992,17442,8217,55551,5133,34344,251927,51153,39364,201321,7816,66803,23057,156724,145664,14276,95705,979,2796,6875,13429,212525,50602,26276,28284,3424,19465,52397,46963,31420,51399,206476,92317,48851,637,100820,83349,10317,60227,21972,6908,282439,32857,224767,95629,83882,42106,87338,69757,29840,68709,37665,45244,114577,49188,175943,54009,186746,106158,70168,3358,234002,50555,9221,129338,9562,20118,32923,78479,118280,65752,4977,10474,102174,60947,129006,10570,83451,8598,8078,159367,123785,80438,16742,5905,5281,181513,42402,6977,163136,93179,42191,14968,50421,112401,105440,33456,57347,121611,4221,94954,36517,24046,27796,6255,33394,72990,135408,116627,1233,57874,25654,95419,68156,401399,313338,55208,45573,93124,119251,47200,38196,11909,130667,45391,73904,64964,167846,4137,115606,52036,62214,7969,160925,7187,1132,134835,40309,73195,64494,80472,444841,61111,26500,45323,40743,53625,52797,22659,15631,29739,36706,28841,39147,102836,26794,10536,14845,87305,45874,12241,127587,83833,57183,79722,30844,41304,84655,20825,92500,3722,25655,27811,10157,81634,31362,34088,92487,70123,22190,185100,72658,139035,192523,88241,2078,230490,44528,85638,100198,22088,29982,291233,241062,13865,4445,137791,37835,107218,31726,19718,38234,72528,23046,19177,66695,5109,17251,28077,5617,21554,47839,72425,133825,1486,73065,181275,141508,21768,62971,63082,2512,34200,9904,120309,6392,91243,68416,268253,41199,116757,138551,185526,41246,28986,4093,19057,17295,4148,245766,122360,35356,112075,20301,75441,10998,7977,19769,62922,937,63547,100196,26427,157820,20983,236696,22935,8140,90315,156004,47204,140973,7726,45097,52725,22636,23436,257282,105247,522,88389,216031,202204,46812,211666,19693,68828,81691,45925,11256,30292,372,5236,167826,88328,232776,151611,5360,82104,18841,80393,25465,18285,20320,72377,31730,33160,45803,38715,27705,37379,24163,18360,103586,4015,32305,269494,91252,20080,36567,54650,7797,57073,12650,31164,42209,6375,261663,105528,81661,106002,2800,5375,17247,43151,4442,15727,194619,100855,144898,62320,78465,39929,16454,1967,28311,61363,17219,9395,8745,121445,76939,80385,162380,22009,54191,44248,16299,122830,48151,74429,78291,64755,14238,44966,2511,17712,67954,93583,829,105899,49935,84750,11591,33185,85447,42717,27409,208542,28965,62052,52525,5597,25694,65594,16343,63224,276188,12475,9331,127507,38522,57287,24128,133161,79723,105548,133695,48917,27558,43278,46520,13778,141954,110785,83366,17715,46317,105763,66298,147013,41086,94180,16478,220447,44611,730,19722,78975,117889,125643,26254,16574,18480,65006,15806,38549,246418,46052,36056,8440,34984,30170,3163,59800,4458,115442,4283,41970,33507,104078,1653,22,121158,276486,3655,6338,24048,133421,23641,2161,24422,36006,8086,10675,181474,12307,29514,59143,14729,52509,87128,122470,19446,80852,33314,24573,119864,14237,9652,57779,6612,51851,15284,98871,90581,124466,156831,21190,22015,71380,161906,87247,69201,18392,17908,108470,72962,40719,14338,17911,95260,43339,20610,78916,20710,72451,11315,31448,17263,58853,178878,48111,116002,45497,80506,82605,85880,36300,121755,25215,36118,301929,88728,405223,276136,553,34704,212438,49970,78329,922,20711,25036,257130,38295,145369,18128,15385,30829,55656,48345,8012,3561,28004,122041,192900,58338,112508,41085,29976,87040,47117,23905,4336,92061,138880,97407,42083,172121,6256,25192,172671,5,93568,1420,12677,31605,56743,40620,6015,78415,231077,31298,80026,13902,19048,24924,170586,32955,176119,87859,36731,6773,27711,24658,26475,115216,133207,93250,95820,88522,8317,5714,124047,55219,86860,19677,23961,22928,162209,8904,225992,359835,56084,96201,29392,96558,86071,93643,55114,13347,8183,95129,82012,2017,123336,34219,115554,157159,47747,101684,41008,18735,193781,104151,226906,7552,179874,124113,31159,21162,44010,14771,51268,166128,31382,73124,77438,92830,205709,12113,1292,38937,13114,1334,2118,15597,69581,14449,21934,76618,48728,67038,14967,51495,24243,87736,147249,26720,11119,46063,43749,5843,44147,152629,133428,65703,14269,45604,57982,28672,55616,45957,8438,95433,37698,220862,132034,39456,61870,4161,26501,73560,56418,9845,4654,20916,10456,88920,119358,9015,65931,96507,48029,38534,21676,109081,43078,34943,25089,6131,28766,23665,5477,10255,16695,67,45778,42443,42770,29534,23733,100513,62617,42630,48746,14191,43753,50295,26007,8792,57243,43119,54725,164253,58250,112304,131796,25165,4651,3188,24831,47748,3705,19540,13211,102095,5593,18699,23666,32005,117571,33541,60584,74573,86311,99443,25172,27222,168938,7143,11853,53560,18834,19960,86522,28217,53266,117700,72989,34323,18721,66450,34346,74056,47217,202002,46269,9429,68582,75458,37823,82843,96652,32549,145144,27958,19820,158086,31955,201406,135379,31207,192545,12950,51704,9094,248263,76147,64028,110009,79407,89345,99284,223492,47966,26848,15359,201137,2861,110507,71231,72297,31851,118777,71039,151051,240855,16333,50766,14727,7939,4149,80908,418780,88378,59276,1327,7284,38576,79814,65820,42199,84860,49574,62596,12396,70598,40117,8648,7994,16836,7630,14047,359699,106878,525,29037,28064,13380,11675,50669,74216,103539,180314,27449,56299,172344,19274,7301,246099,32043,19422,36506,129317,6806,30140,4614,46639,66926,932,86600,6322,27847,233103,10541,39025,34887,3517,12972,26220,2031,66561,115015,48658,47596,12714,33845,3893,16165,35237,89983,14769,11962,147224,47018,29977,27979,5552,82338,86023,131368,1218,24853,237840,132193,15455,40873,3668,65351,53388,15229,59889,272245,47934,11858,34347,18038,90853,86981,300602,19343,114181,29362,84921,6095,106059,79472,38015,1206,48741,6208,8e4,21916,17423,6002,108083,24479,34931,56661,9511,26995,100694,163853,35997,81254,58321,18919,171890,86877,91341,74503,70477,53412,7027,59281,39892,131302,5864,15947,61301,67466,162369,47956,27874,35624,282324,21270,111847,102548,41482,30955,116737,28264,8592,55458,22301,75090,29821,30697,51709,3041,19208,8038,24634,30467,87509,126428,19389,18814,152686,20701,83474,45832,80891,105808,11378,153223,120770,98186,150633,49838,9141,12755,30962,5260,74490,21256,31678,65062,33326,289838,187831,20595,89768,2805,58535,10844,70085,12090,2451,138068,98544,24461,4511,6754,41684,28203,3383,65355,82833,30161,83924,234361,128424,28921,222594,33975,125491,34069,11508,67464,144226,41850,98703,34371,7901,21254,38398,65651,23549,53883,213340,123269,12028,71764,177701,28758,2623,68395,11549,15232,68603,9660,63116,36079,57093,31198,20475,48467,89984,35619,186847,107469,31389,43631,73867,41949,68841,114250,1605,30564,63403,17588,27680,99533,12641,70325,50428,73426,78379,11855,91651,72081,91720,60198,15743,12065,83398,140046,6761,46598,45900,5068,886,62448,148968,37347,19405,9680,15819,43496,63370,75667,163700,37639,3633,22774,34341,183131,134335,37200,23915,7054,14194,12970,26438,13350,285521,25594,8219,104410,91039,168804,138480,149734,15907,33818,61132,60082,4622,110187,56736,13551,73571,3945,73463,65498,17758,263266,17593,2710,27585,54469,38200,45367,63754,28881,3473,12791,98287,31895,65787,4463,94536,24951,36332,59901,28803,52130,86403,7668,181822,74831,18977,9850,177206,145485,109798,7292,31421,26280,77211,58511,12507,127004,11113,147,8729,56208,43066,79926,129937,31345,83947,39915,46146,98763,42566,1337,13192,18323,105163,80570,117753,16555,72883,11077,159438,40764,70933,83329,26066,12276,72059,21655,173836,126713,69454,153482,91585,70644,102558,110483,6764,127864,190133,3961,101798,20945,71138,82402,90884,69669,44753,923,16939,59700,164258,25969,27082,31399,43846,6306,246093,51342,6153,151581,202801,182731,56475,162188,89426,141356,14355,121815,27536,28023,65257,77523,106668,127314,24947,12790,38796,169698,23555,10725,44573,183083,42088,62716,43265,105958,32050,44067,50118,1668,3874,6243,318411,16599,1691,94999,52378,28671,216728,123258,2059,34969,69225,5913,136280,171443,141515,91662,22175,135282,80020,92270,1663,4808,4482,3495,34691,5226,109830,108512,17342,107488,11606,123190,100247,29666,146527,113014,15794,30894,13224,39585,243192,22351,9903,7836,47699,11078,25468,122291,48821,26780,122679,75521,81450,630,4895,92900,55074,74293,17441,3563,111657,103102,51613,12318,52370,36191,68245,34269,40445,41354,122901,168604,182500,62012,42557,11259,24428,115113,86345,12362,3909,78430,86852,134602,20459,47853,93879,22577,7659,3688,38555,13349,17381,56715,91639,12493,10895,92438,3142,37057,28928,2004,36427,32268,34222,209974,10432,67436,41989,173518,107930,27079,62729,30908,55558,5828,45031,14902,53546,8204,144263,60255,14520,88212,86582,109589,69356,8064,47449,8505,66558,16886,4844,52817,111260,215129,12941,91118,650,20770,6273,73089,40618,62790,2873,35002,14023,97208,19386,102646,36993,143736,135457,35385,113601,17893,32627,84439,100619,56016,6581,57264,172160,45452,111710,203627,70131,24100,322787,1996,35665,70078,22358,90922,83658,4097,63200,58499,14542,99153,52159,6615,12414,63415,31986,16823,1579,65405,137809,8841,16898,48082,259,33014,42375,12260,179850,73667,91389,98882,29532,17311,326251,41092,5928,20742,44964,48019,43505,9317,49265,6643,192712,48424,163487,19861,20113,70848,31928,105333,23685,78563,14638,54755,7158,24142,44018,20774,125255,20331,24280,10163,1285,2336,39851,4299,117269,46714,63816,87779,159624,11731,9971,990,137317,108831,50994,74554,162680,23640,131597,146962,170620,34829,91205,21184,1913,63616,18427,93136,156592,17519,67565,115882,138220,78622,88535,18115,2711,33554,109492,54298,971,24914,25863,36363,45715,27099,194995,14299,178181,111488,72395,322385,157719,130787,11897,81843,83999,11369,49280,118604,40922,61332,110343,53407,75639,40582,300440,54722,25637,13694,48248,48278,194521,56203,52779,48783,72627,10953,376,16733,280238,26351,230789,15132,25168,137270,3588,63704,73376,94031,74284,19443,159557,9697,39901,13351,119050,15406,146455,3460,29556,75195,37673,102524,92329,47289,98413,15311,100684,56345,7116,95480,11590,7200,167,23610,58426,17730,136656,27944,53151,2701,8824,103124,3017,90744,113588,53216,79736,65940,26931,498,29568,80540,143543,21292,1740,59268,16561,180816,42323,50174,40890,52866,10703,57169,4700,17191,4424,93511,49698,166650,26972,48631,165169,82879,69326,202970,4007,2376,231325,139592,22119,62851,37504,68816,58345,67398,186643,43331,277416,53749,15746,23102,17432,4793,151138,48822,54265,48203,198688,14305,54287,2291,18018,113378,123260,7180,97549,87027,120085,2920,76080,8190,102005,5641,64580,14955,59802,54028,58884,19367,81779,412567,85957,97053,103637,78871,29364,27637,141728,4767,30686,112738,130146,42745,12730,105040,14844,232,210944,36581,152317,135543,29744,3129,55647,58149,46319,27265,17499,28005,59948,7170,34138,5702,293047,110892,408,91760,218674,18469,46095,81403,14389,4610,35672,73060,11006,74848,104820,118143,190357,20043,105358,141735,5115,27093,45924,123073,52599,29433,9616,238350,78610,24851,58858,26769,31969,24613,18294,4982,32735,39639,143563,112073,202205,12567,4873,88601,44897,81503,101648,81362,34662,85277,17574,48173,21435,221188,40215,39576,80786,26544,64668,81841,10731,37733,247986,149188,127703,495,18382,54388,72446,43071,30974,198723,89608,41360,190,33045,8386,31658,19992,237838,119015,137622,50890,100913,6460,116233,267230,26621,104129,65114,14190,41542,14888,85962,23342,23041,26453,43725,71809,45186,4770,46452,53894,56616,221286,18973,9038,109299,55365,19366,26863,18808,60909,69353,41738,83463,12100,68561,72860,3980,13796,49340,12332,31311,27418,4255,53430,18976,45523,510,14224,30477,26581,4530,3651,101663,139840,22709,150861,31996,63923,120623,262522,3076,10528,2929,14672,130238,18087,9816,121894,100308,25085,55111,14565,18952,53293,2042,369988,23674,61789,133529,28783,108293,35477,47119,36448,71049,40015,33055,78598,198442,1833,159937,40654,77444,189245,113153,8621,18599,38553,35223,166072,2375,11659,21786,89523,6032,12116,63046,159398,18454,3678,32521,47626,11411,103527,38896,42946,15696,26370,10185,8413,37080,165583,4331,63555,14907,72220,50056,6623,62236,36565,49783,10049,17503,100581,55951,146244,24724,9626,17969,25524,109300,173965,99994,101056,46459,43647,53737,277968,8347,123521,74858,33829,44762,77574,877,81377,222525,123532,30602,43881,53145,2973,16284,81940,61281,127044,63620,9875,14756,114829,19032,9202,52759,119141,23928,120551,19607,3599,33401,76821,73233,117430,39968,36539,7071,5446,121735,194059,15206,45283,6706,15603,65615,1207,165723,92275,34773,104447,8396,32353,205240,164323,13600,60555,79205,25532,22907,33410,57480,107111,69630,32137,47832,70913,33161,20321,2371,117348,10714,86246,1625,11763,17900,268,78457,99175,97940,101092,86660,32221,14041,128504,125080,53744,124263,31017,13897,403,31859,21964,5633,111630,5547,77329,17961,18241,84995,25984,12983,67491,62168,47262,5241,297,51191,7351,8967,147212,82060,16821,782,11033,82431,62957,5026,43459,77963,203477,53528,6247,191852,87774,74164,215654,13467,1522,219964,28589,244104,16242,117821,67725,72570,156792,17186,15979,26990,44128,193014,35276,57125,16212,166451,68017,6905,77608,16364,53777,75921,76426,37975,26203,269296,64099,84122,12077,38533,830,4407,20139,963,43028,38902,42911,37503,83343,85045,16979,1165,60835,137387,58380,86990,110066,134540,56331,193845,81238,17922,163093,38744,110641,12502,56404,34862,26865,125964,12965,111648,25547,7771,27196,136980,9555,29551,107158,57885,18831,37705,35505,101742,13970,102109,62548,124657,23328,11124,89592,146376,248050,6241,22033,18337,80685,29898,11908,216623,67721,106162,146610,21377,15085,91552,42041,62560,122532,125336,102365,121537,142559,29693,223919,11515,110495,18776,22494,5895,185059,103592,229351,51220,100102,37027,257855,29359,54123,36066,106493,12244,79258,32002,432,56205,94836,90182,6726,14762,29391,48938,26864,38083,60364,3310,60192,14766,205567,57504,110760,22649,24666,46333,21517,3430,13135,28873,27052,158809,11597,20529,6695,23138,22960,37137,45574,6545,305877,43423,26153,24769,59844,14501,10430,134352,56169,13213,103432,49523,35181,13435,12408,129475,64620,230854,77390,51990,15653,83248,33466,44571,117828,51481,2187,10559,68019,18021,54895,48247,18354,33737,4554,108595,37288,39767,116707,9175,3726,108877,21616,83684,49862,1938,8543,276466,20134,108498,48770,102254,31914,131520,185291,100559,51890,209,19526,76471,50544,71814,99351,8172,198526,28816,20419,9109,98389,136777,76479,75596,30635,165417,48216,120220,25955,211071,39314,24308,32164,2559,146280,43403,9233,17947,90585,1786,86920,125662,2457,64741,32152,32918,122882,78538,44001,31723,56426,23375,103172,88177,145697,52506,49319,68016,31664,41488,18486,110400,7030,28241,986,109199,19900,42147,56864,65287,49183,7858,24e3,30453,840,16673,25907,68916,89927,6309,158335,36407,199737,130464,13137,59603,201778,195292,21015,42466,179062,172561,89492,11075,180407,31868,72493,20998,60217,9865,19530,39274,130266,54539,21623,12535,13505,40641,73375,4087,85633,2153,3117,70680,55788,92096,47509,98493,37490,271936,151475,3032,16171,96642,34106,78425,125761,19591,3366,19316,54508,24183,50786,194248,91528,33253,34622,108355,41741,705,3814,3883,108929,13203,67831,10142,59754,68208,29128,84820,56880,38794,24972,48571,40821,40476,18137,164254,24064,236309,79181,11282,395,39169,2013,51587,28551,9645,701,109513,115899,113566,12762,62045,58322,103726,41343,40866,244102,143816,2490,70346,40973,52618,15412,30720,104315,38917,42027,93676,17513,107418,20706,123890,13399,97727,24044,87962,65606,44250,98044,65276,74790,101473,19350,91570,1326,87790,172042,7577,100813,86896,85891,41512,108130,27794,14875,71431,12835,156250,58135,3759,22476,42176,115873,34686,56523,73643,108505,51491,20838,12721,32863,45700,29496,13700,34294,55360,29206,155942,123812,7706,163234,203,132720,49358,144431,8130,175788,35818,3270,76832,25710,54095,97274,28779,94621,74396,19092,128242,58067,20885,14670,93255,15107,63291,23654,126900,129421,59294,262659,9798,3251,67344,28600,44629,50672,29072,26999,31526,23183,49175,165843,175455,17282,175411,32022,45989,30298,90690,78118,83156,23749,35636,31317,7069,80381,94561,133756,14960,97404,6138,41065,78041,32843,16601,34123,9559,146529,123377,96395,54441,42012,84257,123541,10745,22139,106459,11720,150883,172651,154996,110538,4728,53447,25704,2009,71152,119354,21166,66604,1429,216162,8637,122250,63520,27180,29172,36124,276428,107787,77184,4680,14952,104903,24418,14793,51561,52931,8371,26342,48526,7118,92066,67280,40653,8847,34597,105438,14198,50163,61188,146286,50315,41205,170829,161496,585,197359,95056,1687,365794,91349,48507,5804,49263,5146,104902,96365,117343,132222,46084,96919,16875,8073,262381,79982,52663,13928,16056,153908,15145,109256,132308,18763,24904,167644,13618,40750,18686,147124,114709,150038,52849,2938,12568,48617,8778,5459,44202,44591,74914,17183,248689,13878,7822,80060,23116,194037,18487,2067,7798,43077,33678,244028,31320,74273,2794,19466,8218,36280,183997,48124,19416,29656,19280,98734,7715,18311,30701,133602,150307,126956,7378,2933,79903,13178,12593,86571,26604,92446,13574,44205,65699,427599,21118,8245,14407,27877,47936,33542,7916,26460,117762,21596,37818,2249,127359,209394,60044,47677,308089,36791,154971,31417,6998,150042,174360,12255,43009,29335,48739,3912,101398,53340,2580,146939,151295,45360,125275,15273,45383,27456,48761,23314,8750,60801,85823,104759,27894,123685,66968,39480,26917,55290,83305,2696,98390,57569,145853,340733,4919,20024,52268,30884,7413,203685,70989,112855,4129,50536,349518,68205,332641,159581,135361,236026,37563,176404,64899,6578,122033,63871,1850,85234,82089,66124,74145,121098,107351,12687,36881,117334,13136,14698,85933,93866,18047,32620,310,15094,46e3,88451,23632,36645,27940,87618,80520,58892,20976,27702,140090,96075,67841,103292,238964,87778,107338,17019,83427,67522,7302,8261,47570,116787,8730,80484,61772,174422,56005,131193,52875,14588,28471,59817,9586,15720,158155,51307,109734,15196,11025,59331,3884,52626,102602,84797,25158,27314,4437,20488,76214,189248,35023,114952,157376,2827,62439,102878,129749,36405,10329,109339,108633,36662,1254,13267,5470,87105,58004,15397,10434,159667,21864,52022,179464,3013,32147,31496,116832,18494,105502,129227,107267,50033,13481,9954,24267,22141,16257,116154,36185,950,115685,11305,176708,2048,178671,112573,287867,162328,497663,95170,50979,193861,50987,30368,136257,31830,46549,15119,169876,23788,17462,249887,57377,1949,35448,14791,43769,210091,3783,34612,282103,88380,245190,5457,20491,98908,11402,86899,117916,16028,162584,60644,320177,156096,31065,55876,22e3,77655,9992,23397,13757,317623,63978,215255,2443,17648,93231,27388,104529,93807,55505,140477,12046,112040,70887,40152,94365,112353,25063,114679,266061,71248,119555,15589,2244,617,14129,211431,70110,100652,7777,4383,85911,89221,21010,120615,58357,86405,37554,41647,18,15143,69662,60491,14714,186134,148344,42347,5410,168175,44535,42449,343894,129417,99682,20659,27272,140483,63455,222159,17536,13722,42637,62324,11976,114691,148109,2283,32057,182393,4295,147364,33705,2075,44303,30274,28331,63740,69740,29148,10346,44862,33716,73937,153333,12930,38784,247159,2515,41053,20256,83368,256189,54639,115240,5096,24661,175419,153552,26516,141,138176,63885,34115,47222,55709,2765,28479,38875,236608,12229,22921,77291,54426,45388,2860,57787,114579,295139,105782,17826,71066,19119,54364,69385,16568,12323,28057,33346,34919,124763,155533,101386,31644,8627,49001,303600,29868,63213,9103,77280,71333,9696,138789,37059,24823,5057,21352,32368,114208,56803,19424,10445,58514,8661,209508,26187,171838,10460,63454,14016,122504,41328,21329,46618,32493,38225,7855,31763,7945,29876,8734,6438,24205,97490,139977,130740,47323,33195,85390,57194,13813,60600,21313,96251,7699,27584,170521,139271,1363,4402,336738,129223,84983,69150,13147,3590,163929,207225,155260,55916,20288,4503,8398,98490,11773,27512,37113,84976,86558,28365,11756,116005,182148,13733,115313,47644,67208,85069,9347,14995,226141,14704,101835,41159,35314,13113,63526,214039,29978,50446,83339,17440,129441,72522,118641,97816,24907,73844,15717,118884,167255,96509,162793,30847,36849,51297,78974,77793,10427,1873,2972,9999,35074,28190,64297,146836,46298,60038,163007,108919,61219,2403,75022,127339,4233,110389,69022,9833,128097,88016,79390,222936,22570,94657,28462,56956,38803,81536,30474,152794,19566,16481,147408,74574,81895,20731,1918,1366,76367,187321,54494,24366,21690,61696,33283,107477,77499,31112,414383,74362,18463,218441,120929,59848,258629,201924,69269,454,19989,13054,59894,3623,58908,20681,35723,78523,102680,38988,184112,108087,50944,132704,52966,21699,18860,96349,201411,82697,85395,95658,5093,6427,177894,44191,32755,26961,155739,6249,31310,81030,26574,84311,120155,86730,113535,7424,48888,13516,45747,98098,20077,183995,81945,43210,26704,40420,75831,45648,11180,6855,57927,65528,124096,34851,2598,156633,107572,127352,38169,123845,60142,62722,105584,232364,23211,68120,1601,22169,89299,747,258039,80572,7258,152249,11862,101204,8834,121434,33761,19175,133142,46343,40178,48723,3589,41977,30210,38868,62257,10087,82658,87827,90646,16415,47552,351723,28298,72225,91146,272760,1701,11295,1652,109651,300747,51863,198800,29446,11794,32345,37538,22356,33102,37590,113544,37970,11478,179743,25454,103417,59905,221970,105196,145604,7817,164809,102360,16974,75840,255333,56902,6659,1954,645,59400,67769,7689,18675,5215,13793,20536,27852,3387,29523,259718,16860,94625,43143,29245,15848,233581,22685,63631,78557,22836,133302,84513,1348,51826,47129,98836,58284,1830,1749,94642,10933,6145,12506,10975,13879,103781,144434,10268,28409,32346,52968,121567,107374,77268,23686,35097,10501,155275,15303,47136,21102,168741,55332,90385,15996,84817,681,137803,25054,142275,6163,38175,8056,124296,240642,65621,4934,178205,16101,62803,60964,18230,100622,76465,44689,14545,9543,47514,16852,93380,28048,12047,107106,37575,101485,77047,57326,34819,96137,76916,6469,46264,115983,75768,87668,69942,13027,165,8373,114231,26434,52844,42799,182044,23580,146254,38081,43236,33883,146220,382894,14606,46035,36481,166621,35417,95382,2957,59384,60428,36358,66343,75378,22267,22950,83528,17577,56474,25285,4619,179691,75355,95836,53295,34588,171410,4487,14679,84208,44015,18562,109133,54101,11531,86052,174479,303157,28095,9953,35642,14564,39802,16145,77606,117406,53038,121117,53624,22062,1212,7632,127157,237292,189087,10478,127345,102515,181997,86752,87623,10966,121602,68783,68681,83042,114380,138349,191305,67176,50085,39016,1427,42384,1412,67118,122616,72389,25260,2237,13576,137346,19938,20304,2191,68759,5373,61364,238507,75814,23931,69565,38993,131741,38364,12528,87762,5679,129853,5310,186831,32653,90338,260176,389531,108118,26843,43985,50175,30563,25106,56965,18130,140428,4542,165503,117991,24219,229605,1819,129663,1240,3797,76093,18398,71339,51919,93043,27175,47060,216257,6483,35051,1217,16512,80798,129064,13225,69339,8548,237079,72298,2575,34280,51379,117910,55671,53345,247552,29486,39328,140821,34681,57045,60177,5004,90269,78522,2479,322607,48474,61296,13057,31558,4678,59271,6699,27044,31988,35944,12503,83480,4389,136508,3781,114121,70279,4488,155829,42214,2898,68191,75695,305850,45041,74344,106509,30087,17429,93292,12477,290,23080,114802,35714,18751,26554,105424,17775,2144,2412,100610,65192,113975,52975,180272,135050,129815,76238,106483,21440,63186,4260,46189,9711,28249,4169,23429,23390,8324,141585,63809,67668,38457,38063,39226,59972,1189,203916,62368,14403,16949,61767,85801,1739,40147,35049,76757,33124,62102,15780,103593,103009,53484,22952,67973,114645,6566,5245,50462,7601,8288,3513,194571,80276,1908,54592,5124,58571,2513,6800,273997,193904,1119,17991,117245,2508,129156,82366,26278,71465,63341,56943,39662,106116,94966,156875,9736,2204,122308,94418,27134,1280,24539,49022,45314,3764,50904,46424,30699,28087,293839,9400,33646,40165,822,147499,50263,116179,29085,11863,31314,5578,17797,5104,12454,1604,15342,219206,10232,67800,94261,25872,13565,90339,78971,75377,26649,41184,47695,11514,35369,20767,14227,41953,309396,148270,147938,33074,14453,27499,109019,39018,25738,240196,158931,52820,8612,95853,21524,137010,84901,70869,70021,116794,48404,38771,6732,1070,70990,187297,49140,5238,576,3564,253975,16027,16483,2811,37775,19034,25259,4053,2e3,70083,95774,19713,33431,92703,91314,42381,288770,48194,95985,3991,77418,13406,241328,245086,56533,35275,62725,9246,51924,70181,95331,16163,31410,79016,39312,120878,119371,275987,80124,27712,9186,220,23598,146167,85209,68238,282190,57048,31273,30555,80913,17594,75779,59160,135002,101219,189377,29225,96735,60126,62522,104e3,27620,86814,17240,147533,11001,5425,43682,410,49460,87270,69480,46315,59448,1816,76201,9431,11788,87960,29063,65539,47347,11678,33846,7008,196704,9895,6753,8633,120892,59970,572824,115934,6646,202559,892,48351,37611,251282,57823,67263,57750,26527,34485,90747,7685,88370,6144,64182,1709,41969,21458,62327,181657,49247,225330,122600,114574,107124,85361,111833,63243,71420,15655,191178,72430,18063,51425,54002,12364,53225,86557,18193,97580,41232,138398,67821,128724,8944,233212,101353,52099,42127,14006,120107,32789,32132,3498,18123,33758,56058,5779,128760,59888,98869,18445,84702,51911,13234,218379,20093,39031,8074,70195,20708,23462,24355,131384,60189,26390,10403,41060,7140,10781,49410,42261,87202,82566,41663,43105,60276,2768,5733,74176,28329,2297,145430,131632,83615,122915,105441,655,224102,5284,136426,67763,16294,188511,32538,61049,27893,3394,13951,159099,28542,17930,145360,9492,190122,32285,78855,26440,13570,58648,73908,4239,124561,2444,74172,53131,11468,10794,73566,11623,35343,64710,30481,4163,10328,38309,29901,10538,154377,76132,92405,24839,11679,3465,13449,11637,7824,2337,57754,1260,14458,41118,19878,38661,13416,159180,37074,163164,54137,28627,52134,184900,8520,40385,29546,30502,22386,66527,107458,6850,24022,47983,30603,35083,8934,304066,39500,9,28261,33026,77251,9374,44833,116312,34990,29236,63563,125639,135405,165398,159055,55690,88141,69643,236964,31983,25572,20436,36746,60896,31850,16179,11828,5888,3043,66368,9750,31167,7915,53111,36430,1333,64344,93659,20061,60596,180191,51630,6792,30244,43509,101058,22409,420,44210,109783,43223,27030,72477,72831,32679,29235,7675,47556,12258,39907,149412,84926,118247,24692,71717,105038,86009,45941,41189,89453,29856,52543,30627,226798,67303,59230,67415,34408,1367,99685,16867,128419,52147,4111,125381,117881,16173,44093,102224,31575,23234,24870,83790,127407,239098,3200,994,1255,100903,242275,117266,55116,38205,16140,29662,11307,40414,208793,123355,56470,4862,75600,30119,58218,70828,24075,26974,7802,192353,4851,5475,78720,66596,3409,28573,64396,30381,30690,59859,88256,5406,99945,103064,34463,37727,24238,86643,60088,4057,23741,5967,162904,38240,28356,93858,25510,122879,6897,3278,7057,11971,4400,35461,211413,21395,59615,39471,87233,55795,128426,3051,22470,41950,14705,3974,180108,80476,78442,204996,91987,15634,67610,139015,142373,35611,51134,10387,4353,153456,57749,181039,14183,68447,151532,21107,36452,20551,3186,46247,46383,129666,88736,140662,146243,2066,8360,7978,64818,106963,17896,47801,10723,114821,223295,74192,3293,3393,16987,74064,11277,91622,4270,29828,27951,387869,103235,1374,61988,120083,477,145892,128378,11779,211263,61354,18221,17869,46530,83061,108538,157981,90608,67199,95080,49064,195814,12302,66307,10348,231346,160732,112859,63633,146558,21271,31037,198802,47622,12862,95710,3910,77850,73961,85585,34752,61e3,4082,24595,103679,71107,8208,79568,150019,16615,24961,139857,32664,197366,4559,54735,32696,4126,162019,75698,13916,70108,159638,19834,9349,24675,175560,49643,18206,52459,27992,10809,88865,401975,133172,29e3,34558,30915,3658,25834,42430,36562,125265,18182,10155,40149,97082,208980,19575,60853,90529,66545,9600,789,46420,2317,88593,55595,98980,115302,5742,169155,1073,177901,3472,11189,63711,78643,65472,50459,127979,93,42202,67053,21720,157650,11145,141378,42033,22824,85705,79114,35584,15974,1510,54172,28562,12451,104226,19190,97151,73024,20948,5151,81741,21499,29006,84183,198074,54003,45120,170125,26240,35177,28389,64863,79974,60778,176915,232183,45342,2038,80253,41564,40703,32689,5430,100689,5366,23007,134279,14266,26712,73993,24934,64242,52113,102887,61801,46415,201049,54251,62133,122757,164883,30815,139966,2319,30842,766,13362,10287,134518,86111,81665,82440,28333,43019,18963,8804,161944,23439,102144,101145,80029,39052,248708,30350,117340,11878,128467,974,138625,63961,5237,74778,61834,67040,43814,13690,65947,33809,232476,115258,181745,28824,94013,9510,10246,93722,81976,7217,114383,3493,16014,69045,72692,12145,80981,9507,6692,1620,60820,330444,35474,33962,4797,7053,295463,46445,27026,12491,77988,49524,35675,90947,29114,166705,101385,133782,32704,6186,84595,176031,185623,45966,151302,63069,1699,107491,947,15458,74452,196212,6046,10498,12163,10239,35191,243951,9277,9090,29539,54460,22820,26514,112549,60372,51753,48756,21812,70861,260326,41,44222,10441,16961,48148,138771,216194,5914,52153,53400,212036,56519,26245,10117,45888,15294,138019,90913,26368,43842,42111,23348,6082,194845,161089,156206,51546,11647,30759,302912,262094,8635,78876,26535,35283,54183,31183,85484,147873,12989,5197,6356,72894,65347,20150,27370,73787,1493,45918,12366,190217,20724,13858,10981,67449,81213,7553,14115,72242,271517,11842,48310,88743,143726,22177,3290,243231,58452,62937,12592,1654,40066,33477,13751,9921,128442,15868,7106,75236,83773,10775,36938,10482,170465,17368,17469,161508,32752,98340,800,19824,264456,3901,87319,2867,26782,9630,113102,185815,24197,44584,86366,40224,3636,140916,31731,267731,9567,53678,72984,29389,27963,17106,50282,284911,60170,8322,12608,23374,89652,5268,39044,229766,8869,151350,31436,177342,12269,183212,120418,116270,2843,78888,69192,7865,184099,1086,129897,18383,70508,20242,18508,229924,124569,35749,50589,55626,9884,83115,40971,30671,18135,14452,38861,17844,201826,5549,26413,17189,13561,38539,10679,143331,3314,36785,171194,49685,187713,67506,4618,104039,17060,195080,50648,33159,19238,67559,134840,28599,157523,17130,38064,117398,94355,31918,13575,34538,40326,13997,3494,348283,62481,26862,3603,104426,244363,153709,112487,304612,199674,41239,35545,54869,293005,28223,26277,26899,4533,18518,15492,38587,80488,70485,160395,263,60162,11382,222152,4696,250751,51921,182609,10707,48463,46243,1227,49111,111564,46502,33342,56846,68541,63559,858,139927,16654,229375,76759,26478,33205,95828,23399,92945,2637,35630,28470,143992,50214,14174,21456,166191,65665,1711,21594,78019,97599,111701,36,147151,110246,189022,43021,30397,40757,131935,42065,73335,48039,26596,28984,15102,2361,7421,202167,69744,43766,52826,3642,83304,33873,75140,63169,192389,36551,92748,13039,123959,233220,21738,84447,77230,20228,187852,19095,25799,92136,108774,29237,53947,2299,118106,2687,8830,42331,202924,33667,2023,73763,30704,19363,19779,16737,35629,48081,24068,101013,162338,291912,13749,24745,328289,167679,70086,48299,23306,16732,17801,43322,54589,3586,63653,43624,53474,925,109177,251316,43805,13082,19511,86565,142182,92461,17117,101033,103319,64589,4022,4351,235897,5352,82705,107142,46391,156084,5860,61365,10558,13045,7717,18357,33922,12590,33065,6928,46993,783,46937,67846,8952,26295,6107,119656,18799,17458,50747,4229,179559,112727,118080,20683,41464,125468,51560,49749,44231,7359,35339,62988,136487,67015,5208,29150,24956,105186,48858,6143,18097,6972,16404,73489,58742,97196,36357,164616,5834,32267,13746,147733,15113,132091,34127,106298,39729,106426,22294,9780,15602,36213,71502,42808,66802,599,60755,5851,39120,67363,108623,126368,72770,91263,32486,30596,151717,7951,52002,43103,11768,68942,40901,39344,24037,127500,116890,48403,16926,86750,17745,48648,159545,34460,58419,5634,114317,67865,31462,23352,24010,98185,125708,69686,68337,13610,26271,70691,2980,4768,27225,102402,75453,28106,8104,6931,1176,6274,6475,112635,22498,6176,238686,26832,28893,90319,14441,15682,15087,39517,45270,109134,104440,45965,47645,81772,7876,52683,87720,12898,4505,185665,2769,113401,15664,57592,105229,137381,97059,119268,6876,43309,33886,128363,35476,144249,67013,143587,83367,25703,91436,59347,53236,2289,16519,19844,46309,58558,99834,23313,218816,231303,36388,51333,183535,109792,139277,54306,90139,18235,8275,32710,37677,82464,86025,92204,88842,117723,37570,128723,234242,76350,73795,34896,148247,58424,11105,11744,45746,63372,17118,49772,199520,81902,38004,22911,33752,3125,1995,53792,4689,26909,108150,146062,69674,41811,161444,84855,8999,28561,16731,93937,3189,21967,24890,22943,1356,145300,51569,28802,517,118679,31703,40607,48098,108854,25003,10233,73969,177495,5248,24516,215347,146192,48712,60626,69188,40735,5866,586,101541,6509,47590,52129,5969,222045,110933,25733,24223,65339,62812,2414,155418,35819,16022,78423,43138,20995,128255,240673,46745,236093,72176,57085,97841,61248,107,36068,193177,105427,55726,215229,20446,47228,100420,87091,14429,121708,23605,21157,187721,21880,2997,203976,99166,95068,25877,7724,98925,83401,4829,13182,18229,13718,239662,38653,116505,153497,30589,89029,38962,181302,43853,78872,180301,4786,248240,7401,106136,112590,77745,19731,60880,77789,125748,135487,5975,48627,34084,12419,215770,47557,254582,10364,106495,21856,67539,88981,38805,21428,48732,42316,12149,16078,52808,25327,51322,33850,51147,12253,122354,46077,56483,254553,115417,81834,150991,94662,86668,7381,12841,100650,18218,15741,22372,68294,50705,15535,84660,61887,22553,72299,31361,24824,17743,46820,64288,31582,77006,111674,116384,30760,80920,86149,77192,51979,79691,60342,122805,103800,240873,160744,233114,78962,54920,8608,3484,316104,72548,24337,5088,230040,21926,10172,36838,26,86221,83458,102176,12062,17571,41929,41170,28428,68239,41750,103930,2634,18313,53019,34825,97837,63115,24606,73157,152474,14715,91439,37033,109806,140259,30668,174760,380,135597,95673,136073,65073,134249,13829,17279,122305,4420,46444,10237,64848,203623,70728,10349,182885,65075,24519,25783,40318,34139,22222,63394,55266,102764,41422,20126,65100,90408,53640,35128,48932,11192,38935,96839,34782,39492,19396,41332,6250,5511,19492,51304,25936,104466,54099,73771,86115,5080,7669,30891,111700,13931,25276,72289,135447,14820,258641,25265,31005,281179,75286,393,95359,14623,13584,6680,101227,80173,44933,76666,54542,13244,39348,458,25379,109451,134348,81143,6959,65554,12027,51311,8716,57589,140731,28467,23316,17272,30458,25980,55229,77197,83798,28302,114784,7428,34548,26241,14712,39336,103304,18928,54080,12870,334,87722,15208,16895,142098,114262,39820,83913,57817,28682,7721,14900,108672,11250,62246,42849,415188,1724,26555,24549,25505,26443,107450,145899,61035,43528,6901,60726,65906,267741,21338,147590,42079,18924,73017,135236,15393,5206,4026,84185,1531,5988,113890,82647,303391,7386,69844,71611,189865,76523,31877,13315,19314,198575,32821,1928,67641,25913,104475,103489,3297,70391,18406,15446,113347,19295,93790,27856,1792,167471,116449,8541,4408,41757,63233,25765,86680,64501,27034,24816,34975,6079,4486,49693,36229,16917,21581,62426,27862,11612,54284,35702,194034,355,24277,48262,87411,70504,310164,118018,12516,47559,43502,57433,107139,9290,66533,80863,14634,34312,91725,28606,21342,67241,72355,43244,375789,37402,174015,105070,8342,44167,67494,1890,16365,11723,271002,1865,47918,8350,45564,27742,25110,125803,8553,49504,81925,62211,4534,15491,19011,80373,206920,667,102405,128623,245524,5553,113309,192739,65766,19567,22832,261958,29679,21293,71134,20962,105123,24721,860,21752,33448,18372,157167,94822,35770,173224,232737,75729,28937,46828,28062,25453,5207,140366,36665,30652,6169,67920,150458,92040,23186,184604,92330,20891,176492,49427,27828,38305,42495,143982,49560,25503,90043,29747,65328,47830,12932,11068,77721,9003,25213,94205,140426,46090,89945,138173,192691,33329,112232,129905,35709,27514,1841,19957,31411,127476,53572,17497,173549,55063,175135,19841,69314,5192,237921,117660,150697,4060,273045,50414,98940,65348,153665,164423,58804,156695,48994,213928,86036,28608,8355,39574,34540,16927,135680,18374,151587,10830,53805,16878,16623,4282,48030,8537,14986,46102,13062,72897,72,33050,108227,39451,45935,651,113320,40535,95176,57450,48843,5003,19019,10407,211163,3848,1068,4988,32091,30095,41692,15099,43602,107434,50744,7627,171349,16313,150832,352665,207750,33937,38256,51091,156e3,87889,90663,84175,24908,114900,50365,31494,83829,5398,169342,47521,54818,18935,8356,43094,41212,174536,10082,92550,6678,60614,23355,69721,14796,34149,128830,58187,3179,208,40325,28399,225029,401412,51150,31580,207268,6657,10993,69818,64282,289845,23308,12961,38447,6681,52944,31855,2572,47646,120728,179148,37240,45196,218274,4816,3695,21961,50084,35209,18073,51452,27004,6100,33941,1377,84831,171214,85,141510,9078,99227,32610,6417,11718,49868,65579,87902,73018,49062,46280,61742,21512,40862,107733,15941,29168,157765,144919,14487,5767,158014,140070,7241,573,71584,16921,223566,40331,179473,35081,47926,140885,41508,52104,59180,42310,32811,29048,123517,102413,80208,10104,14746,12649,153641,126022,37965,113017,4171,83,142592,2809,6362,50416,71323,116894,260776,16204,1524,5760,30351,12658,20703,54403,36083,45408,74772,4946,14485,50759,111222,10890,2195,167147,92962,130534,16283,177256,35016,15472,210156,151187,73922,117691,43250,52051,37392,24811,24358,30830,5775,818,21969,1476,127322,151783,58392,31021,106913,65215,89407,90802,28531,11690,20234,95249,44602,37256,18707,11928,5161,4410,26571,51903,49768,22008,25252,65780,209499,68769,203726,13249,137363,48845,86823,6658,5674,31881,1083,1823,108676,34518,166752,13791,14287,91576,91429,8665,11529,26401,16191,91972,30964,5254,28486,54697,79613,66520,18447,22870,45203,194466,22822,51703,12278,76716,44595,73455,33546,12235,144843,36154,51247,11116,33040,3180,225753,60864,1972,28469,12891,28879,10338,144157,56294,353058,38302,41447,87532,110616,27065,168438,6557,1213,50804,144643,24817,2390,136531,38174,247513,16190,4059,122791,131994,137430,39506,57650,16305,5188,54309,106128,20628,88071,67394,395446,250285,66176,91254,1399,114196,43915,60230,44853,27206,106353,43013,18733,345105,226453,51202,16607,57106,117175,35492,10476,89598,127439,15187,39624,13688,61570,10615,31111,59370,6238,175252,32143,224492,41388,95408,34384,148238,78307,38959,9340,160091,61443,15737,11216,41244,170,38299,102443,113097,26382,14027,33707,3957,76300,66160,19431,18900,6952,1717,108656,82206,188021,257335,27295,43999,41210,31777,46956,57457,12657,11489,15697,48060,204748,53583,82422,284790,30503,137341,8120,19615,220311,15991,10217,63424,9808,67431,70976,98221,4491,15177,28535,144789,751,13230,2394,1504,33977,132104,30316,22230,931,97193,185240,24826,22687,174322,15307,22988,1390,188745,180325,29580,59068,74903,18994,29195,79,15436,7622,38462,11566,138710,44828,45774,37768,99236,68137,84083,19282,22698,17134,74807,126662,173497,46248,16938,119735,3212,28292,213652,49013,9975,32180,45660,86250,4801,68788,95490,77482,113751,11994,44624,94452,46839,128497,100316,5798,58588,73184,202987,65417,37790,88524,1606,43156,97964,105717,34947,11203,100060,37742,130074,93653,107799,94311,196106,41347,8035,10780,16390,27883,118236,167395,1979,25006,19375,31628,18916,144723,78502,114047,103107,86492,107686,5844,20934,206963,23556,22591,16562,146333,20167,10471,117434,33085,2863,9740,36669,41849,37271,22790,18209,28979,8231,12952,54408,21731,25130,45208,55748,138120,75826,414,29593,9925,292865,25999,683,123149,7036,92159,86055,61827,103680,23176,54918,58466,57578,13305,5709,86479,16697,31064,17660,200919,10770,49793,33423,32370,52047,16488,62555,6459,8426,83493,7763,59725,82812,18628,67760,79405,68557,9612,7673,28102,56517,69620,171797,32458,29541,15870,81109,32080,207644,71495,21202,11039,91036,61230,2810,130800,32260,4613,60590,37112,75214,33979,126402,155062,30642,63875,12810,194463,82799,47664,16725,36685,43367,61099,449,172150,102867,21691,301838,36745,7130,18671,57316,34852,38034,54182,35578,65900,99486,19771,3456,2658,16914,99866,28390,28109,8262,21147,34353,20006,4228,137085,1675,203023,283196,198286,214375,163329,290603,152574,40471,83506,30068,14730,23177,131539,34759,27668,32178,71896,104799,116305,85430,119262,42860,25160,8911,23428,49437,105322,6519,16203,6349,74711,1230,38045,8540,75165,44736,25909,51026,317034,4984,32281,91312,27060,44431,17817,45363,155937,239085,35697,59784,91993,29531,126740,213757,76560,167776,285273,24262,8237,65030,41160,74437,48804,118916,13159,37842,1031,75349,1478,11655,108777,23435,277425,101734,67469,70231,124711,43532,28514,65526,54956,1e3,21882,17728,25302,40952,52214,149632,1999,2111,3259,63362,89961,220561,39777,26335,9063,10572,12416,34551,34623,38604,24723,5947,15588,69927,66252,119177,69173,46629,28714,70715,212408,20521,406913,74380,11716,50659,50862,37009,88460,130101,7210,53853,538,65120,151950,55806,163748,52837,13153,21100,16674,64536,6091,138201,44837,58547,3723,163,2177,32288,85454,34033,8497,14282,25742,10535,10741,79559,117493,243787,49337,100718,79495,40139,42956,7551,55433,15421,31509,23034,45081,547,61176,53434,328001,8470,36263,30145,4519,74173,53935,11845,73774,60211,78025,3,4102,73782,109293,315332,48412,26683,13714,6865,20128,18490,104141,325,39470,171970,115860,15707,7268,73301,74336,31370,2368,111827,107757,136231,142844,97138,96638,84053,38691,23801,1588,10573,122098,77039,240,186135,146101,11996,18143,112963,46171,155836,348769,47795,121213,116266,132515,3344,144804,31286,99187,255838,129694,35894,48779,55235,148582,71967,65282,15174,13920,47080,6147,108242,157593,125025,7136,1286,28957,127956,28402,98813,20805,7532,109417,40610,5041,32958,15142,18408,108596,33543,50517,27748,80114,233434,91447,487,37094,100048,30541,43477,10639,89862,155868,37667,8726,60684,237903,73408,99589,12190,38739,97348,3914,13594,2680,149016,13907,30171,28343,23530,115225,61104,35821,147679,14337,4297,244282,24085,326976,56428,7851,21303,131620,71446,83253,68692,111870,5224,15813,38197,49026,45057,13660,3306,76345,40671,27905,91072,996,68527,62085,91351,122634,55109,168209,2024,27560,112707,17352,8306,167115,169921,166958,5031,46020,11844,67284,19130,76185,6920,32849,5450,14610,22451,21002,17392,31872,66682,84796,13709,40210,59898,12029,8719,53564,21462,91884,21647,88379,194428,12754,37797,132826,160016,22567,54383,53186,77611,31107,8339,4694,19185,90355,23597,17222,140675,28442,23668,55977,9128,61555,28774,155229,17658,9390,24379,69357,15752,127381,239631,62460,93181,55913,45133,140155,18676,25249,33164,29581,82837,67223,22362,29975,7317,52813,1943,29613,20012,207130,49617,49651,5636,15334,36313,29226,28084,95247,72072,19e3,224932,15811,114,32127,38097,37508,88507,37225,27359,91626,12193,69279,20608,11055,88156,92808,2152,57259,55275,72789,24475,104414,1708,9882,3818,48661,66897,1631,34806,227930,85815,87753,18321,250664,72733,25107,206797,50891,8082,196411,92596,96764,152823,65514,22819,387277,62176,51225,40329,15563,189,3659,73670,64357,51793,275136,33482,86653,74615,67058,11318,125720,15388,22388,8267,1730,102663,170910,40784,7144,85373,13040,7088,94309,583,44224,140424,77439,18496,164026,36578,4722,9151,5824,63365,26510,35199,40500,79277,32495,44614,35233,9566,203293,152144,7097,2330,183480,98629,13423,330887,44130,68600,30939,97829,31012,345465,56747,94879,4939,160027,149761,99423,46099,32251,15332,8761,96094,128555,5763,235318,222223,55729,30241,55420,201746,3987,81382,8259,49325,23287,7719,24633,251100,92311,18591,110533,64759,170260,393860,7175,21144,132887,3593,75346,101277,91109,16387,259187,11627,57459,173829,44694,55780,49797,89192,120443,62622,3904,14814,23887,1027,112258,64955,99800,11132,66353,36202,48624,18158,88481,96882,43059,11040,2455,7077,21651,181159,99126,100434,61388,68186,19161,110468,120052,8819,55324,41494,7014,37689,3618,87729,92615,207943,9823,128657,12587,15857,6379,67628,51216,71775,157617,63244,1503,3864,218754,110864,5769,21492,7243,1192,87921,85529,31512,18537,42698,35350,73510,84474,34301,8991,21013,35034,566,38832,19838,35586,37216,39413,55006,12178,59742,856,84563,6900,25632,17437,49786,30723,13847,70845,4044,7843,23944,235976,55530,48942,6518,20939,73769,192653,52936,95207,23895,132542,142982,22632,87452,48042,54018,178468,10728,26230,23559,363,81269,142012,5718,346258,31456,84333,246476,51018,66692,101804,120570,39962,30373,70593,2864,60541,19425,54209,104092,7201,31545,48018,25865,15442,46257,40443,8328,6451,111782,47527,97754,33046,470,245116,31095,39,91934,87208,73470,36708,36521,12801,70624,36272,8892,79768,12427,55454,103756,5908,52390,62962,22720,141138,94634,41689,128402,126390,6628,106394,35527,134394,82727,254651,194502,148064,89549,3202,28359,957,21954,27906,49840,142747,8307,24206,48978,1186,71728,133038,71474,91306,6333,110959,74600,70387,18983,62609,56057,22970,1147,135850,1321,28834,3578,59715,102227,32827,81415,99952,55636,257598,390,22702,35701,85872,402916,39216,189795,14929,19467,10112,144422,61514,5279,63421,134686,41436,8424,51925,10598,132295,124416,4604,194739,210929,57866,31829,51626,50007,9976,91878,61906,56168,81906,60918,61859,40017,23059,16887,40927,62064,12785,32893,32913,21782,93965,20169,44387,79084,38463,11457,93950,27127,157050,2697,337088,5116,54128,48255,33279,8821,27352,25515,124022,65710,28906,38557,33390,1722,104435,72215,38551,12094,30978,25113,6671,37355,175109,42862,98024,65406,221276,59624,118012,64637,78760,86697,21426,1639,40350,12584,67193,84144,31396,7863,143011,69629,63112,9454,28666,65798,46372,134721,6314,51402,30837,151922,2847,38676,38008,92823,136245,17540,5504,109295,205242,37606,5211,214892,1586,20670,208711,137743,19328,40652,16995,20023,14657,154919,34422,12996,13918,38221,47690,16398,2959,37680,89122,6721,198469,91876,172043,83898,101992,26084,94570,3635,76958,22853,76497,38266,176590,168403,44464,142840,79180,184594,1984,41806,83147,11985,6546,366068,59732,24533,271505,8736,39084,222992,93429,28962,58985,86665,8432,30028,14548,32439,54424,165029,55175,27458,69046,121277,46168,33732,20661,24581,135574,123110,37556,79260,72611,16957,12939,46162,58238,44907,72936,253758,41324,32518,96480,11949,124438,65280,43256,34107,53533,43531,37037,28366,45970,32741,173438,6121,194202,62969,26355,30314,58370,28455,1848,50519,82830,90393,21761,295490,10936,256940,133568,44050,20269,4089,27457,21610,219460,36743,14821,101388,52005,13124,30979,140816,167362,26054,18458,60789,34917,40447,26606,33422,9066,3452,83614,5761,20263,137238,25038,91310,101,52322,74548,42572,38084,214054,186568,31802,17665,30620,141936,37730,14420,4265,187218,49640,188208,51441,55388,96452,66659,40869,42039,60967,221027,19234,178581,29105,96050,9165,196118,157335,3738,40354,117436,2965,34136,59659,15570,50843,230035,31444,71260,43886,18316,5387,38500,168508,17406,32174,8828,103373,143806,90367,3560,18719,122310,16508,26719,2541,105429,6645,37998,73190,10591,235916,49737,87112,233941,53188,32193,79154,4544,52905,126477,7580,63501,57314,3216,31337,6541,103083,60846,49,9756,15481,1355,43840,14319,13743,27486,10222,73114,230718,418644,16706,6674,279748,23058,45273,295831,86306,2743,5535,88773,21829,35253,120938,31153,3169,16839,42847,8751,80974,33942,36867,35514,16485,26474,77775,56877,5391,48346,3882,108713,31403,27804,55248,26235,43821,136104,40118,175507,28034,203908,18732,1788,34030,106427,36958,54359,7251,44936,15356,69139,455,157915,22173,140291,50348,43275,82066,49621,54952,15216,36226,96695,66855,6936,1987,8227,196087,4631,68827,99004,47541,110265,17953,147605,110242,58520,31312,38724,329975,642,3155,34497,75937,6207,73843,6120,17249,51429,117746,3218,910,68961,319671,14938,29555,34700,1649,66673,72268,9655,76800,153087,6941,210168,27130,35398,1780,73242,3135,56689,19556,165307,8765,35967,121458,13333,70453,17350,117253,22265,13340,44265,39869,441,3742,135025,23581,33309,16543,17731,13291,157637,283005,21408,101360,63887,52312,83873,5338,233779,23759,186949,34531,177320,38069,156465,91004,19353,59852,68160,14891,1338,1072,29823,1950,28901,81407,313445,73038,84807,162348,240257,37162,138934,16111,58013,41253,102951,16457,96056,19541,56402,67217,41638,94381,89674,29481,37456,80815,151579,13937,13683,132537,19699,134545,67020,29816,222341,141235,427578,48868,129557,233342,23077,87871,16213,18728,16184,9469,37913,19680,2798,171356,178328,13216,50049,72690,71904,124644,55455,7504,29052,41036,266546,19899,30391,188755,8659,59469,16,104298,112943,53865,76203,138226,68857,139953,14125,107625,119795,173133,4398,50273,48808,54390,16466,122086,31835,67035,50971,48859,7508,46427,66477,73021,84615,39985,83076,46779,201569,53336,36443,60865,168164,143810,51393,25548,169307,32896,24485,38424,21837,29087,275813,51674,6714,64883,46169,187369,55186,76192,12852,12018,62134,31067,118303,16542,12125,10579,4928,26291,43854,7091,10946,253716,109062,39283,17261,113012,258512,47764,125126,32646,55892,80279,201623,149872,3192,385,1208,48750,5376,58738,22335,5427,82416,47811,32435,143086,38930,94128,59975,156037,37977,38224,62485,7698,50405,71027,16462,21559,136153,34131,107506,162069,63703,3101,215029,40407,4178,3774,9187,80019,17880,97926,67579,2600,18405,8351,47924,86638,70820,92206,86453,29610,42241,119200,3198,15466,67813,57863,35454,4779,99518,4649,104641,144269,33730,38073,65864,6838,109456,193298,154007,5623,45741,30846,182578,25573,157224,1543,58575,138703,146140,44971,49356,18275,59064,20300,13122,11848,24453,11973,9797,86843,2919,25530,49210,1130,161220,76788,75373,85604,34926,36014,17777,17255,51533,11676,92226,51845,119859,21525,5936,18507,28050,1140,31418,14857,34207,47859,10750,36382,32079,106909,59426,87757,38393,110042,15965,97104,33757,35344,97993,53979,33651,45407,41884,82515,173089,7177,58371,35365,47543,51927,35587,10670,23544,29306,84233,39976,76076,62097,9007,8668,28119,78281,120790,19835,143020,54968,18670,64959,20649,34469,42570,33001,136570,87796,120044,1106,58700,63951,127623,12805,83057,40212,31773,49850,7361,54336,347524,101314,23751,19569,48791,29174,49369,20467,7465,75842,38281,623,112457,60210,28849,51003,94720,6426,90047,85560,43761,3579,85105,34607,90410,118528,7224,42907,111163,18168,6960,161135,191298,5247,100584,127552,171568,20121,91173,12636,54615,20199,63730,98105,2396,40387,14438,125012,4765,33235,12865,45299,37728,82098,77872,114037,59253,19675,24838,398016,102561,11446,17069,57508,178277,65836,99941,26114,2585,271882,136866,50126,11027,155648,118367,14585,8910,123015,335383,40434,41016,53021,14439,87098,176860,201543,121888,2358,9286,5739,22666,54270,37884,169381,33984,93859,16124,89364,72207,51639,76366,99029,65812,2198,12147,174891,194289,6986,30252,88822,21284,11445,288337,160821,33034,100869,43852,25761,52882,1144,103809,1924,84458,86079,43411,13542,139276,18141,34978,41298,7276,26481,173800,33210,17951,142652,33616,33677,2210,19941,98568,2486,192414,80136,12058,235883,50963,249638,29572,27221,47034,6124,72107,63346,97620,158513,299699,40388,23235,37176,224244,198386,121323,67992,23827,63170,17838,106622,158590,26807,5345,23489,91891,55474,74834,37981,13058,5977,72552,34706,26828,145172,19904,21367,34043,960,77092,91381,4733,47446,7680,41697,5170,16960,14741,46101,13656,473,51842,37433,11103,11551,121951,13191,97536,165932,50397,51628,129028,9069,44885,6590,59195,47045,32940,225472,90345,21833,13303,29407,96615,141951,5198,6028,18395,7181,3861,14966,156358,167182,36529,55253,25942,173153,30959,27261,50691,150176,162201,38467,48462,80602,42163,118482,168,108756,26011,17166,54149,456538,22512,91374,13816,90358,131615,18132,226707,1824,28139,26860,42253,93877,77351,65575,8980,80574,22020,27948,40422,91324,76376,13528,39281,91685,82215,122541,144066,1983,193851,17283,26320,2739,194978,4790,26845,42627,61300,65815,174612,55133,4200,191130,79771,158321,52280,166796,221620,62461,11278,4067,88152,83409,31717,121367,13522,47325,37945,10406,174348,249321,154101,64912,29938,51775,17220,15776,166138,78890,84425,54121,42861,16368,24572,291647,10197,32073,22651,11677,97509,26952,35787,18424,41910,71614,94977,72318,41594,70024,275419,37702,60199,7335,39107,61315,18271,18394,33768,87884,104277,123724,7277,56288,71981,189803,49320,3352,6798,14240,8954,69220,94433,57372,28620,68863,193727,85575,42309,41667,67689,42081,22543,44824,12719,28540,114236,101553,27638,27296,4300,5353,4663,19379,94098,3758,95888,95144,80344,87320,28447,259518,12718,71391,152731,37063,24132,31911,104896,15672,103782,1521,4945,72541,23717,122632,15619,87175,206120,29428,189780,61416,28350,44457,972,1175,47233,198738,95789,41907,21953,97034,59341,22864,53713,16873,32971,20693,20954,31336,21477,16169,38370,16412,9019,3841,24599,21938,17085,6484,81198,76413,5849,72514,12320,65247,276175,37234,59796,52642,16312,57349,198507,94148,46134,18958,125552,1747,18725,151873,14901,5490,68287,29470,3689,64794,40814,26018,25692,54450,2703,88278,124886,173087,174e3,24159,179477,24276,46004,201876,209202,445,52876,31948,30206,157610,39180,18439,44124,50469,5774,96278,222758,200216,50290,45486,20435,46986,46276,140133,142326,15569,13363,47522,92583,2182,7135,16853,22998,30272,4952,63263,35623,39096,53789,44864,20053,110392,124213,4630,16087,28221,127787,25839,77481,44693,13464,113146,6983,27069,55717,50102,4760,7107,26186,66507,59145,36032,104182,71328,29425,64317,50781,47465,94298,69706,74899,22754,120756,25108,93077,56834,73286,39928,16218,41699,176763,7555,70819,50083,26895,23315,26014,16773,123079,41712,5719,31516,90427,158540,85051,183128,40864,27505,55392,9058,45224,96857,30901,136622,96557,56304,120061,11501,151448,5773,89743,7769,86069,2935,18471,41628,10114,33660,110170,49479,26745,92846,33221,26731,18795,87076,8550,2100,29972,120289,3077,72490,33784,2630,208722,50861,63483,79029,6419,39467,14302,45286,64207,9686,67513,44170,1050,77246,59266,17055,53801,7150,11111,42432,4278,94579,362117,36175,42902,41933,39002,98489,22913,74161,84773,57036,17556,162288,74485,178760,93867,73635,128860,50362,261,67455,80001,46080,35662,4368,25247,19230,74393,22588,1822,27682,235324,13798,85998,13194,235067,23514,71669,147632,23191,134748,214683,105101,1518,25489,247114,7380,54842,26922,3971,26361,20844,68642,170517,77339,123255,8963,77818,150998,48466,36806,2732,23261,11741,236162,18243,126216,28690,50546,16385,92760,197383,246558,201295,88255,67588,71687,176076,172653,169058,33906,63747,24835,157621,43338,30050,46152,132741,2770,51371,94835,6614,15112,11749,56936,1250,19027,399017,58036,100215,23388,55815,308768,124152,94803,9521,64186,8971,28,30427,62163,7616,103838,35079,29203,131235,7743,17389,10882,37420,61460,228512,85363,41581,131077,62822,119647,10130,54445,26925,19968,29016,24446,74028,24176,61448,67185,9254,8563,119129,9771,99184,37716,39514,10532,221512,258753,218630,55980,23394,32141,61924,66749,32411,3741,36475,26678,77010,44946,91203,128749,116953,20476,49625,53116,13735,102335,29376,51946,83407,67892,59212,34685,21083,1546,112982,32972,74397,1078,190545,16082,86140,58591,89611,101531,10061,105104,76319,20035,17551,52611,169061,190842,100780,23907,90413,115619,9675,34710,193435,49443,129734,11183,258877,16318,136182,126808,44635,27304,192375,2599,125648,47051,12091,23814,721,58800,40137,66726,97930,60877,74487,7942,54326,9841,41428,13762,8211,85383,6950,99177,79806,201786,296464,124087,13144,29741,41721,47634,55088,254286,106408,17041,99064,12942,64086,45233,14005,2612,55827,255,7984,13980,38574,12776,46654,73499,249951,2101,26676,25996,132326,116415,119062,50449,31033,23038,11589,179252,20007,14860,129270,21143,17796,144715,60106,70758,69842,34674,282133,44014,16774,57268,38528,24053,46373,201667,28327,471023,51889,102667,21193,114909,84132,69317,96723,67969,16134,68145,15058,28765,32035,2524,101089,98664,25045,76571,14957,86040,118506,262428,154764,81573,39681,283900,73287,127825,544,80448,52347,38512,175971,15180,45467,33086,46552,48894,81107,43213,36672,54025,76703,8053,7608,13299,56619,20752,238099,54164,105133,1444,32942,953,37564,8e3,66316,119463,106817,404,13667,149108,128597,31267,10269,49836,106150,1484,52330,76965,160486,171648,38456,31263,22424,37738,66245,67467,143369,60471,75610,20895,115528,86070,60854,40796,49347,18989,15030,11371,37578,15779,79867,10187,86462,46402,155626,93200,40229,7090,57547,108053,99598,11088,47505,41218,206017,2173,20988,30219,22919,80563,57566,42369,93141,41675,2407,182519,120495,27154,16702,29456,14349,7958,16688,117177,140375,42467,261919,74916,153569,10836,34742,49526,7621,105997,12212,2270,392377,7755,17959,25086,232152,138791,33847,13860,35316,5811,1344,71259,50452,207539,92635,50359,5821,33674,30255,2086,2587,96264,17543,42,6029,9580,43007,139248,82831,12917,29607,25786,51467,42137,85161,100698,31561,88989,121990,278500,3602,109344,37982,15279,116442,28936,30880,87894,58079,128661,126731,67392,28051,146885,4861,16216,97344,42827,147561,153948,22684,21335,47685,1853,43349,15185,59642,10229,25520,187921,108972,5579,98037,24945,6697,19193,63734,137934,75056,89740,19767,224268,56138,63643,151661,39313,70618,84031,89723,84074,13703,85626,35460,8867,64845,3439,57906,99776,63968,49270,81130,34356,16210,23547,36446,34090,140028,72439,2221,22163,57058,363492,113754,18913,95451,48663,54464,54037,176097,68425,3023,34906,29482,117389,341780,80431,58330,16753,92616,60907,94846,147486,4498,48646,7773,46801,7778,18946,464978,47558,33223,177444,7328,15626,63337,94700,11743,9351,255024,39098,16447,42647,96230,39769,58840,10068,63439,35800,65843,58823,413844,9156,51258,7434,61791,85018,6872,3692,28096,7121,33024,6009,75532,31997,192535,9661,3304,9547,14753,31987,25314,55689,15896,20430,39472,31340,99744,25398,115569,54883,28719,205423,23071,57855,64638,149867,25671,82403,37616,20668,39989,77996,74948,140555,175248,64810,36515,46595,4958,248773,24045,28728,136673,168704,20804,114833,100325,27135,21205,96151,153134,45992,7093,13992,76047,1980,19432,145001,75159,87462,17710,1013,45556,34297,144882,20648,26061,11319,129567,108555,18872,464580,33386,22717,65948,167189,5603,135042,79542,8801,202632,18114,91882,5973,5239,67315,4431,60916,47819,71693,32597,32606,18183,45072,80329,76385,24749,51305,40314,156514,14693,130345,13168,66214,18029,12858,34801,27628,14544,10823,40522,40185,33739,148694,23548,9923,61012,28859,17933,19442,34364,99849,164107,141167,30629,21054,6744,36491,8096,42474,41706,155060,30650,10600,163442,1143,96655,61390,52359,7559,51568,64256,203854,4467,22453,14504,436398,7878,6980,8293,63610,293747,16167,35763,19627,147603,15419,18032,110744,51346,33681,54571,40472,48615,39073,21604,13754,173027,92560,11083,47299,63062,11813,52007,29883,9734,139722,15953,1550,20651,13616,49306,16113,90089,92326,7584,30712,72424,164858,6831,152871,55746,197721,34167,196442,6022,112107,55215,7538,123381,4920,43539,77165,8939,50392,34192,20225,79762,22505,58667,40770,29788,97180,82835,4568,8579,13273,363569,35898,49983,436,36598,3237,131691,62418,35591,8101,4073,379438,65218,76072,33887,2968,27573,212619,288680,68278,72851,150504,217896,6913,121339,22017,35340,51072,43616,75043,31437,10833,81487,4364,22968,41454,106687,85446,19863,109625,149241,524,141850,214404,54376,657,237023,9401,108137,53800,32474,49712,53334,126876,27337,45552,177696,8269,15036,12097,42240,2328,125374,119295,99715,2500,19624,39441,27220,102691,60957,94543,39101,18566,67362,13975,78230,25017,34017,239007,90027,39351,41681,35354,43822,1043,916,58587,141983,94818,38799,75459,41114,67432,16195,36606,59568,22272,126769,31424,68659,12287,134302,257977,5756,207285,95637,47248,117689,19583,77451,22373,12200,54993,117118,34244,29386,34562,53819,71267,64172,77665,49368,7716,59301,25749,45426,194789,17297,2650,1766,32501,45198,20403,20984,6600,14171,94604,19037,5402,29896,9938,59935,109708,88081,145182,44844,39167,352626,164173,35374,45982,6122,154,73419,220487,53834,53601,17992,8609,229321,5610,68098,66815,71012,95069,140968,27396,8957,134489,24656,86659,56598,134852,17316,123838,255436,6613,41610,138033,81452,32023,32396,123687,63398,8693,29712,30407,19296,121188,3551,36099,20032,111948,56624,16547,27453,35916,15378,52039,56849,13489,22214,73177,53097,277349,2157,14029,187886,10260,141743,246460,91880,50869,3788,49486,133566,54950,33120,129337,53768,18333,9525,26902,312251,10297,9020,70759,16647,112432,59260,84609,9818,82766,73569,468,46001,75780,55028,52106,11498,43645,108069,17150,17753,29417,16705,31799,9606,289,122254,115975,8620,6133,255357,56908,14456,133464,43554,79224,11247,29630,160,12756,25464,65960,350428,62521,321796,100359,67358,35169,46172,113128,48988,88868,31094,33266,6847,60887,98188,49659,69117,92977,220228,13947,80181,35103,62170,97351,13475,2440,199768,19498,36597,46971,25234,67806,62881,84717,73648,181966,10488,94149,21550,26655,63436,48375,14405,165650,9621,24439,28043,42735,4490,29963,56674,45373,1934,262446,50855,67098,26898,5261,52696,40644,33900,9440,180286,87162,22940,19704,26936,69769,10254,101759,27406,12243,48e3,73926,113215,54935,5726,192787,4312,106216,9366,11550,52949,23457,212271,277152,133895,108374,6191,96477,29980,218916,58024,54696,40853,91124,65894,91170,65908,252552,6793,29212,15389,44516,122515,52617,35058,9017,103536,39510,49136,19242,130652,662077,74699,47024,31422,8517,73351,24399,13867,128360,4810,4434,61779,111983,61036,17798,110240,59722,102960,39688,10001,23803,23039,176498,56659,44814,134295,17188,77577,74466,226175,102472,154333,63900,111747,18062,41171,79669,32773,408933,42562,28931,30907,107388,43487,2946,240310,23938,24354,319,184983,7927,6488,1422,10790,68809,68209,64775,4361,202,17123,59634,51200,44391,18188,17843,2619,74278,3230,9540,47187,21702,36274,56894,43907,16310,34790,16866,6150,5561,13587,107545,108873,126867,86986,28640,33427,19017,5762,80637,17430,46903,2047,131055,25958,13558,5444,47152,13900,44563,122857,45348,70863,39593,54332,38068,33637,318,40310,143467,18502,24520,11377,62013,28942,27246,28269,83545,17999,59015,90707,30065,15161,34720,1263,37008,2012,6060,98575,92933,5721,299,199555,24578,29223,2985,743,115825,109523,136657,47454,26378,53586,3733,174945,93340,244456,5693,37386,28782,89767,27545,23573,18798,136425,34320,84778,20041,48453,38215,7477,71958,40621,8773,5874,187927,105965,51100,43533,18083,8443,10180,43597,2003,183999,69689,12216,129696,146188,62389,34044,68410,12765,43273,26949,266807,3345,34477,79197,5688,47539,213110,21634,22257,50092,32222,42346,39530,63668,98,134978,74022,5152,59088,174145,37220,9934,9545,118937,5724,87240,19875,15784,40143,23263,87513,181654,285152,37881,263241,4966,43934,10433,186657,6470,74416,225854,25908,142677,246262,32280,6192,75890,45546,143264,135305,29742,47013,77787,11732,126658,8763,37950,21806,57557,113464,89465,108995,164574,23894,22996,23169,15369,23117,17642,130607,40503,36239,280990,44666,9981,40427,147487,26869,168452,32886,32991,46798,240839,15111,70502,65697,88548,44145,28701,48767,31139,206777,35659,181164,166262,14554,171445,31786,66523,76607,17956,6507,31279,90476,116611,167918,6560,1243,115324,80128,41867,55897,187323,37069,32596,189444,145931,13390,105530,65709,26805,6999,55714,41300,22915,68951,22138,21120,22264,10058,19945,33635,56123,99085,10032,5818,6016,46649,57476,35264,94413,112522,262288,93686,83038,14341,23204,28807,66084,77987,6101,126673,7133,38126,5923,122091,170240,97772,46874,215746,43948,41622,3272,55596,8332,146411,251315,13533,8561,81521,115449,48616,175175,2063,186556,3036,134537,75772,29728,82360,22973,186559,86348,89100,38388,82297,45610,2613,87082,9986,177812,57884,23591,47485,42543,33582,44713,74439,257444,252451,31825,35631,38540,33066,5147,13973,4343,51830,70378,22827,26448,95560,36896,241741,48067,203953,298860,61620,20450,3220,67272,6586,107662,100160,108684,6929,57226,4762,7457,1320,40404,77204,99309,62750,208653,59977,44e3,74315,34332,5819,172217,64904,114077,18147,84012,1791,98456,90930,21446,116669,103938,7422,85140,59713,5768,326211,16239,75411,13229,29398,10758,236107,1539,112472,95979,152154,151294,306,21196,38146,10700,6891,84282,109646,56492,40539,6589,119491,51354,30685,140209,136906,29622,73617,49553,70525,51671,166869,139616,74395,37439,49595,45678,11959,33211,86560,52434,9282,62690,112155,130810,5243,108261,99970,265613,72551,80049,6391,33365,90721,66737,69872,87011,1860,9032,112544,60905,37371,89015,140351,19076,850,373531,2802,36725,218795,72062,28990,16550,24614,7815,6187,26336,33373,32162,42791,73555,32062,23386,10244,56392,49442,27076,136262,12412,14883,1134,33675,97153,199281,15608,100152,74072,47942,254301,36451,16026,10687,65067,56708,254030,30290,50490,13864,57941,259331,35588,23485,43486,24869,21620,92971,22072,88645,1048,182050,13343,32452,14825,19509,3325,216938,45740,99716,189082,53740,78245,25609,24311,176777,47340,308354,40669,66085,14102,125339,9225,128709,97207,1271,200933,78439,113451,88975,18324,46521,11819,18570,141756,72512,170020,52754,63550,118515,103073,93330,32736,50499,14722,31600,68452,398867,29316,172786,18417,104924,2606,5670,84818,16288,67106,59580,82929,607401,291,85829,359,15897,35830,50696,65630,52672,22115,356968,29895,40837,231192,34024,38957,26722,406,23335,124952,72068,68804,13268,147101,164740,276569,162596,66943,11569,26654,66358,4777,23229,102127,5848,978,2921,59666,5371,28212,90108,42938,39320,2499,4271,108792,33510,125072,71653,65239,38250,66357,38577,13964,86251,35708,50755,36010,29448,12209,3844,38222,206337,100876,67827,137088,14167,252225,84163,195270,1306,5703,54198,779,46802,22028,51124,86759,70560,113164,35685,162145,45471,34561,422,2611,6464,47486,19223,38246,9191,18331,89942,243642,212364,15893,17518,22617,6409,30046,126182,59716,36560,104428,18846,26592,19458,50793,147333,30826,1388,27647,10922,14495,33545,19269,135828,39727,41601,46931,233379,49169,131130,182112,16276,82381,118209,142445,128310,19672,28740,82907,33436,3118,102206,28723,24819,41937,38854,5157,3881,111491,1142,9776,421673,152241,29309,14961,87854,6054,15424,3796,82656,54996,2108,55367,239450,154525,9643,118103,106041,64601,68549,48707,30266,25772,18740,9462,229669,91798,112152,191327,14493,72828,8175,66636,236474,25817,87351,129027,76653,20422,22983,71240,27846,44661,12399,46158,77704,53101,35032,11072,17300,109294,33638,24408,1895,11241,760,17584,82479,125877,63150,141075,34259,23274,81698,15732,43577,48340,91584,14688,16379,24481,150280,96420,262050,48635,43727,61819,56268,72003,88178,17281,79912,13218,122519,125295,166396,11811,2171,118930,67746,17636,178278,174656,95661,173039,83845,79689,17473,98555,127696,203415,54730,22925,232239,9309,12136,175026,20740,180188,10747,39816,314017,266131,10040,175732,112550,220651,31974,37393,888,23008,86799,4303,64905,148467,75337,251,3284,370102,50264,9835,5438,23655,4481,29851,329,12855,7162,64931,78141,12804,42372,296771,83547,18624,34874,86271,3360,48665,77735,88767,11463,63527,28889,22258,29140,194315,113924,25499,6406,31334,1845,4802,49184,43455,35469,127594,92970,61038,115005,38840,87761,106838,8811,20572,55637,11162,96721,132425,108925,2948,125457,36356,3502,75270,27622,127192,2561,123095,49394,61155,16897,110064,9699,89448,53356,19628,220310,21622,83036,9885,112214,6087,26713,17901,161912,91492,3440,68594,9266,92238,8087,6866,150194,72175,80701,13459,31836,43243,239700,95846,44749,50647,21945,230538,120612,132371,244604,5193,105637,34661,41341,68775,85393,1874,8771,33718,49672,77403,595452,99507,6490,58895,128742,7704,39239,73217,43816,62824,37804,199976,22361,80005,87514,94832,14089,4574,139975,59142,75523,100268,43906,53442,15152,2547,186002,17011,19513,204282,3343,60568,128318,119250,4298,51871,41336,71759,21921,45074,98169,145889,99427,11350,1237,5520,28799,7803,53702,21026,136352,38293,128690,12158,90132,44600,10184,26957,39459,126025,78904,82999,59373,39301,150198,120529,153042,20177,50089,14764,271571,30530,123161,38975,101562,22941,5648,124654,109243,69817,71675,49162,106884,21241,107795,30258,16572,188262,141456,7688,60718,8271,11044,32440,104608,103419,236109,93156,43293,128929,42107,67180,25201,115254,185488,130954,72813,167547,20537,39969,38432,22582,184022,1139,27199,5655,17767,97412,122606,209377,27070,35871,326617,188954,42680,73512,80911,22629,3011,95021,315242,157737,383,41821,41808,19335,27950,15674,25677,110950,35375,76835,59108,57370,35262,16569,160415,37706,78086,32041,49691,137143,9782,172080,50148,77917,6323,10110,69172,17711,21795,59511,76184,135114,31046,132319,59105,157578,20549,80778,57649,158421,65143,4575,72235,21899,10797,92745,34035,106079,80159,4508,78304,25350,75457,46458,32937,25623,47,8531,104751,84953,8138,36508,187199,66310,115274,13253,32461,38536,1916,42007,187160,35055,26325,84394,35963,94216,45590,97782],T3=15;class U4e{constructor(e,t){u(this,"log");u(this,"peerRouting");u(this,"routingTable");u(this,"refreshInterval");u(this,"refreshQueryTimeout");u(this,"commonPrefixLengthRefreshedAt");u(this,"refreshTimeoutId");const{peerRouting:n,routingTable:i,refreshInterval:s,refreshQueryTimeout:o,logPrefix:a}=t;this.log=e.logger.forComponent(`${a}:routing-table:refresh`),this.peerRouting=n,this.routingTable=i,this.refreshInterval=s??F3e,this.refreshQueryTimeout=o??z3e,this.commonPrefixLengthRefreshedAt=[],this.refreshTable=this.refreshTable.bind(this)}async afterStart(){this.log(`refreshing routing table every ${this.refreshInterval}ms`),this.refreshTable(!0)}async stop(){this.refreshTimeoutId!=null&&clearTimeout(this.refreshTimeoutId)}refreshTable(e=!1){this.log("refreshing routing table");const t=this._maxCommonPrefix(),n=this._getTrackedCommonPrefixLengthsForRefresh(t);this.log(`max common prefix length ${t}`),this.log(`tracked CPLs [ ${n.map(i=>i.toISOString()).join(", ")} ]`),Promise.all(n.map(async(i,s)=>{try{if(await this._refreshCommonPrefixLength(s,i,e),this._numPeersForCpl(t)===0){const o=Math.min(2*(s+1),n.length-1);for(let a=s+1;a<o+1;a++)try{await this._refreshCommonPrefixLength(a,i,e)}catch(c){this.log.error(c)}}}catch(o){this.log.error(o)}})).catch(i=>{this.log.error(i)}).then(()=>{this.refreshTimeoutId=setTimeout(this.refreshTable,this.refreshInterval),this.refreshTimeoutId.unref!=null&&this.refreshTimeoutId.unref()}).catch(i=>{this.log.error(i)})}async _refreshCommonPrefixLength(e,t,n){if(!n&&t.getTime()>Date.now()-this.refreshInterval){this.log("not running refresh for cpl %s as time since last refresh not above interval",e);return}const i=await this._generateRandomPeerId(e);this.log("starting refreshing cpl %s with key %p (routing table size was %s)",e,i,this.routingTable.size);const s=AbortSignal.timeout(this.refreshQueryTimeout),o=await BB(this.peerRouting.getClosestPeers(i.toMultihash().bytes,{signal:s}));this.log(`found ${o} peers that were close to imaginary peer %p`,i),this.log("finished refreshing cpl %s with key %p (routing table size is now %s)",e,i,this.routingTable.size)}_getTrackedCommonPrefixLengthsForRefresh(e){e>T3&&(e=T3);const t=[];for(let n=0;n<=e;n++)t[n]=this.commonPrefixLengthRefreshedAt[n]??new Date;return t}async _generateRandomPeerId(e){if(this.routingTable.kb==null)throw new Error("Routing table not started");if(this.routingTable.kb.localPeer==null)throw new Error("Local peer not set");const t=Za(2),n=(t[1]<<8)+t[0],i=await this._makePeerId(this.routingTable.kb.localPeer.kadId,n,e),s=Jl(i);return ei(s)}async _makePeerId(e,t,n){if(n>T3)throw new Error(`Cannot generate peer ID for common prefix length greater than ${T3}`);const o=new DataView(e.buffer,e.byteOffset,e.byteLength).getUint16(0,!1)^32768>>n,a=65535<<16-(n+1),c=o&a|t&~a,l=B4e[c],d=new ArrayBuffer(34),h=new DataView(d,0,d.byteLength);return h.setUint8(0,$B.code),h.setUint8(1,32),h.setUint32(2,l,!1),new Uint8Array(h.buffer,h.byteOffset,h.byteLength)}_maxCommonPrefix(){let e=0;for(const t of this._prefixLengths())t>e&&(e=t);return e}_numPeersForCpl(e){let t=0;for(const n of this._prefixLengths())n===e&&t++;return t}*_prefixLengths(){var e;if(((e=this.routingTable.kb)==null?void 0:e.localPeer)!=null)for(const{kadId:t}of this.routingTable.kb.toIterable()){const n=xc(this.routingTable.kb.localPeer.kadId,t);let i=0;for(const s of n)if(s===0)i++;else break;yield i}}}class F4e{constructor(e,t){u(this,"peerId");u(this,"providers");u(this,"peerStore");u(this,"log");this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:add-provider`),this.peerId=e.peerId,this.providers=t.providers,this.peerStore=e.peerStore}async handle(e,t){if(t.key==null||t.key.length===0)throw new St("Missing key");let n;try{n=lE.decode(t.key)}catch{throw new St("Invalid CID")}(t.providers==null||t.providers.length===0)&&this.log.error("no providers found in message"),this.log("%p asked us, %p to store provider record for for %c",e,this.peerId,n),await Promise.all(t.providers.map(async i=>{const s=Jl(i.id),o=ei(s),a=i.multiaddrs.map(c=>Oe(c));if(!e.equals(o)){this.log("invalid provider peer %p from %p",i.id,e);return}if(i.multiaddrs.length<1){this.log("no valid addresses for provider %p. Ignore",e);return}this.log.trace("received provider %p for %s (addrs %s)",e,n,a),await this.providers.addProvider(n,o),await this.peerStore.merge(o,{multiaddrs:a})}))}}class z4e{constructor(e,t){u(this,"peerRouting");u(this,"peerInfoMapper");u(this,"peerId");u(this,"addressManager");u(this,"log");const{peerRouting:n,logPrefix:i}=t;this.log=e.logger.forComponent(`${i}:rpc:handlers:find-node`),this.peerId=e.peerId,this.addressManager=e.addressManager,this.peerRouting=n,this.peerInfoMapper=t.peerInfoMapper}async handle(e,t){if(this.log("incoming request from %p for peers closer to %b",e,t.key),t.key==null)throw new St("Invalid FIND_NODE message received - key was missing");const n=await this.peerRouting.getCloserPeersOffline(t.key,e);qe(this.peerId.toMultihash().bytes,t.key)&&n.push({id:this.peerId,multiaddrs:this.addressManager.getAddresses().map(s=>s.decapsulateCode(ze("p2p").code))});const i={type:It.FIND_NODE,clusterLevel:t.clusterLevel,closer:n.map(this.peerInfoMapper).filter(({multiaddrs:s})=>s.length).map(s=>({id:s.id.toMultihash().bytes,multiaddrs:s.multiaddrs.map(o=>o.bytes)})),providers:[]};return i.closer.length===0&&this.log("could not find any peers closer to %b than %p",t.key,e),i}}class V4e{constructor(e,t){u(this,"peerId");u(this,"peerRouting");u(this,"providers");u(this,"peerStore");u(this,"peerInfoMapper");u(this,"log");const{peerRouting:n,providers:i,logPrefix:s}=t;this.log=e.logger.forComponent(`${s}:rpc:handlers:get-providers`),this.peerId=e.peerId,this.peerStore=e.peerStore,this.peerRouting=n,this.providers=i,this.peerInfoMapper=t.peerInfoMapper}async handle(e,t){if(t.key==null)throw new St("Invalid GET_PROVIDERS message received - key was missing");let n;try{n=lE.decode(t.key)}catch{throw new St("Invalid CID")}this.log("%p asking for providers for %s",e,n);const[i,s]=await Promise.all([Qm(Ld(await this.providers.getProviders(n),async a=>{const c=await this.peerStore.get(a);return{id:c.id,multiaddrs:c.addresses.map(({multiaddr:d})=>d)}})),this.peerRouting.getCloserPeersOffline(t.key,this.peerId)]),o={type:It.GET_PROVIDERS,key:t.key,clusterLevel:t.clusterLevel,closer:s.map(this.peerInfoMapper).filter(({id:a,multiaddrs:c})=>c.length>0).map(a=>({id:a.id.toMultihash().bytes,multiaddrs:a.multiaddrs.map(c=>c.bytes)})),providers:i.map(this.peerInfoMapper).filter(({id:a,multiaddrs:c})=>c.length>0).map(a=>({id:a.id.toMultihash().bytes,multiaddrs:a.multiaddrs.map(c=>c.bytes)}))};return this.log("got %s providers %s closerPeers",o.providers.length,o.closer.length),o}async _getAddresses(e){return[]}}class K4e{constructor(e,t){u(this,"peerStore");u(this,"datastore");u(this,"peerRouting");u(this,"log");u(this,"datastorePrefix");this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:get-value`),this.datastorePrefix=`${t.datastorePrefix}/record`,this.peerStore=e.peerStore,this.datastore=e.datastore,this.peerRouting=t.peerRouting}async handle(e,t){const n=t.key;if(this.log("%p asked for key %b",e,n),n==null||n.length===0)throw new St("Invalid key");const i={type:It.GET_VALUE,key:n,clusterLevel:t.clusterLevel,closer:[],providers:[]};if(Lwe(n)){this.log("is public key");const a=Bwe(n);let c;try{const l=await this.peerStore.get(a);if(l.id.publicKey==null)throw new Zt("No public key found in key book");c=ki(l.id.publicKey)}catch(l){if(l.name!=="NotFoundError")throw l}if(c!=null)return this.log("returning found public key"),i.record=new Pi(n,c,new Date).serialize(),i}const[s,o]=await Promise.all([this._checkLocalDatastore(n),this.peerRouting.getCloserPeersOffline(n,e)]);return s!=null&&(this.log("had record for %b in local datastore",n),i.record=s.serialize()),o.length>0&&(this.log("had %s closer peers in routing table",o.length),i.closer=o.map(a=>({id:a.id.toMultihash().bytes,multiaddrs:a.multiaddrs.map(c=>c.bytes)}))),i}async _checkLocalDatastore(e){this.log("checkLocalDatastore looking for %b",e);const t=fp(this.datastorePrefix,e);let n;try{n=await this.datastore.get(t)}catch(s){if(s.name==="NotFoundError")return;throw s}const i=Pi.deserialize(n);if(i.timeReceived==null||Date.now()-i.timeReceived.getTime()>P3e){await this.datastore.delete(t);return}return i}}class j4e{constructor(e,t){u(this,"log");this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:ping`)}async handle(e,t){return this.log("ping from %p",e),t}}class H4e{constructor(e,t){u(this,"components");u(this,"validators");u(this,"log");u(this,"datastorePrefix");const{validators:n}=t;this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:put-value`),this.datastorePrefix=`${t.datastorePrefix}/record`,this.validators=n}async handle(e,t){const n=t.key;if(this.log("%p asked us to store value for key %b",e,n),t.record==null){const i=`Empty record from: ${e.toString()}`;throw this.log.error(i),new St(i)}try{const i=Pi.deserialize(t.record);await tE(this.validators,i),i.timeReceived=new Date;const s=fp(this.datastorePrefix,i.key);await this.components.datastore.put(s,i.serialize().subarray()),this.log("put record for %b into datastore under key %k",n,s)}catch(i){this.log("did not put record for key %b into datastore %o",n,i)}return t}}let q4e=class{constructor(e,t){u(this,"handlers");u(this,"routingTable");u(this,"log");u(this,"metrics");var n,i;this.metrics={operations:(n=e.metrics)==null?void 0:n.registerCounterGroup(`${t.metricsPrefix}_inbound_rpc_requests_total`),errors:(i=e.metrics)==null?void 0:i.registerCounterGroup(`${t.metricsPrefix}_inbound_rpc_errors_total`)},this.log=e.logger.forComponent(`${t.logPrefix}:rpc`),this.routingTable=t.routingTable,this.handlers={[It.GET_VALUE.toString()]:new K4e(e,t),[It.PUT_VALUE.toString()]:new H4e(e,t),[It.FIND_NODE.toString()]:new z4e(e,t),[It.ADD_PROVIDER.toString()]:new F4e(e,t),[It.GET_PROVIDERS.toString()]:new V4e(e,t),[It.PING.toString()]:new j4e(e,t)}}async handleMessage(e,t){var i,s;const n=this.handlers[t.type];if(n==null){this.log.error(`no handler found for message type: ${t.type}`);return}try{return(i=this.metrics.operations)==null||i.increment({[t.type]:!0}),await n.handle(e,t)}catch{(s=this.metrics.errors)==null||s.increment({[t.type]:!0})}}onIncomingStream(e){let t="unknown";Promise.resolve().then(async()=>{const{stream:n,connection:i}=e,s=i.remotePeer,o=this;await cn(n,a=>Rd(a),async function*(a){for await(const c of a){const l=Yl.decode(c);t=l.type,o.log("incoming %s from %p",l.type,s);const d=await o.handleMessage(s,l);d!=null&&(yield Yl.encode(d))}},a=>Od(a),n)}).catch(n=>{this.log.error("error handling %s RPC message from %p - %e",t,e.connection.remotePeer,n)})}};class W4e extends er{constructor(t,n){super();u(this,"log");u(this,"components");u(this,"protocol");u(this,"running");u(this,"registrarId");const{protocol:i,logPrefix:s}=n;this.components=t,this.log=t.logger.forComponent(`${s}:topology-listener`),this.running=!1,this.protocol=i}isStarted(){return this.running}async start(){this.running||(this.running=!0,this.registrarId=await this.components.registrar.register(this.protocol,{onConnect:t=>{this.log("observed peer %p with protocol %s",t,this.protocol),this.dispatchEvent(new CustomEvent("peer",{detail:t}))}}))}async stop(){this.running=!1,this.registrarId!=null&&(this.components.registrar.unregister(this.registrarId),this.registrarId=void 0)}}class G4e{constructor(e){u(this,"dht");this.dht=e}async provide(e,t={}){await mo(this.dht.provide(e,t))}async cancelReprovide(e){await this.dht.cancelReprovide(e)}async*findProviders(e,t={}){for await(const n of this.dht.findProviders(e,t))n.name==="PROVIDER"&&(yield*n.providers)}async put(e,t,n){await mo(this.dht.put(e,t,n))}async get(e,t){for await(const n of this.dht.get(e,t))if(n.name==="VALUE")return n.value;throw new Zt("Could not find value for key")}}class Q4e{constructor(e){u(this,"dht");this.dht=e}async findPeer(e,t={}){for await(const n of this.dht.findPeer(e,t))if(n.name==="FINAL_PEER")return n.peer;throw new Zt("Peer not found")}async*getClosestPeers(e,t={}){for await(const n of this.dht.getClosestPeers(e,t))n.name==="FINAL_PEER"&&(yield n.peer)}}const Y4e=32,J4e=64;class X4e extends er{constructor(t,n={}){var d,h,p,m;super();u(this,"protocol");u(this,"routingTable");u(this,"providers");u(this,"network");u(this,"peerRouting");u(this,"components");u(this,"log");u(this,"running");u(this,"kBucketSize");u(this,"clientMode");u(this,"validators");u(this,"selectors");u(this,"queryManager");u(this,"contentFetching");u(this,"contentRouting");u(this,"routingTableRefresh");u(this,"rpc");u(this,"topologyListener");u(this,"querySelf");u(this,"maxInboundStreams");u(this,"maxOutboundStreams");u(this,"dhtContentRouting");u(this,"dhtPeerRouting");u(this,"peerInfoMapper");u(this,"reprovider");u(this,lH,"@libp2p/kad-dht");u(this,cH,["@libp2p/content-routing","@libp2p/peer-routing","@libp2p/peer-discovery"]);u(this,aH,["@libp2p/identify"]);const i=n.logPrefix??"libp2p:kad-dht",s=n.datastorePrefix??"/dht",o=n.metricsPrefix??"libp2p_kad_dht",a={queries:(d=t.metrics)==null?void 0:d.registerMetricGroup(`${o}_operations_total`,{label:"operation"}),errors:(h=t.metrics)==null?void 0:h.registerCounterGroup(`${o}_operation_errors_total`,{label:"operation"}),queryTime:(p=t.metrics)==null?void 0:p.registerMetricGroup(`${o}_operation_time_seconds`,{label:"operation"}),errorTime:(m=t.metrics)==null?void 0:m.registerMetricGroup(`${o}_operation_error_time_seconds`,{label:"operation"})};this.running=!1,this.components=t,this.log=t.logger.forComponent(i),this.protocol=n.protocol??D3e,this.kBucketSize=n.kBucketSize??20,this.clientMode=n.clientMode??!0,this.maxInboundStreams=n.maxInboundStreams??Y4e,this.maxOutboundStreams=n.maxOutboundStreams??J4e,this.peerInfoMapper=n.peerInfoMapper??Owe;const c=u7();this.providers=new u4e(t,{...n.providers,logPrefix:i,datastorePrefix:s,lock:c}),this.validators={...J3e,...n.validators},this.selectors={...Y3e,...n.selectors},this.network=new c4e(t,{protocol:this.protocol,logPrefix:i,metricsPrefix:o}),this.routingTable=new L4e(t,{kBucketSize:n.kBucketSize,pingOldContactTimeout:n.pingOldContactTimeout,pingOldContactConcurrency:n.pingOldContactConcurrency,pingOldContactMaxQueueSize:n.pingOldContactMaxQueueSize,pingNewContactTimeout:n.pingNewContactTimeout,pingNewContactConcurrency:n.pingNewContactConcurrency,pingNewContactMaxQueueSize:n.pingNewContactMaxQueueSize,protocol:this.protocol,logPrefix:i,metricsPrefix:o,prefixLength:n.prefixLength,splitThreshold:n.kBucketSplitThreshold,network:this.network});const l=Re();n.allowQueryWithZeroPeers===!0&&l.resolve(),this.queryManager=new h4e(t,{disjointPaths:Math.ceil(this.kBucketSize/2),logPrefix:i,metricsPrefix:o,initialQuerySelfHasRun:l,routingTable:this.routingTable}),this.peerRouting=new l4e(t,{routingTable:this.routingTable,network:this.network,validators:this.validators,queryManager:this.queryManager,logPrefix:i}),this.contentFetching=new qwe(t,{validators:this.validators,selectors:this.selectors,peerRouting:this.peerRouting,queryManager:this.queryManager,network:this.network,logPrefix:i,datastorePrefix:s}),this.contentRouting=new Gwe(t,{network:this.network,peerRouting:this.peerRouting,queryManager:this.queryManager,routingTable:this.routingTable,providers:this.providers,logPrefix:i}),this.routingTableRefresh=new U4e(t,{peerRouting:this.peerRouting,routingTable:this.routingTable,logPrefix:i}),this.rpc=new q4e(t,{routingTable:this.routingTable,providers:this.providers,peerRouting:this.peerRouting,validators:this.validators,logPrefix:i,metricsPrefix:o,datastorePrefix:s,peerInfoMapper:this.peerInfoMapper}),this.topologyListener=new W4e(t,{protocol:this.protocol,logPrefix:i}),this.querySelf=new m4e(t,{peerRouting:this.peerRouting,interval:n.querySelfInterval,initialInterval:n.initialQuerySelfInterval,logPrefix:i,initialQuerySelfHasRun:l,routingTable:this.routingTable,operationMetrics:a}),this.reprovider=new w4e(t,{...n.reprovide,logPrefix:i,metricsPrefix:o,datastorePrefix:s,contentRouting:this.contentRouting,lock:c,operationMetrics:a}),this.network.addEventListener("peer",f=>{const g=f.detail;this.onPeerConnect(g).catch(w=>{this.log.error("could not add %p to routing table",g.id,w)}),this.dispatchEvent(new CustomEvent("peer",{detail:g}))}),this.topologyListener.addEventListener("peer",f=>{const g=f.detail;Promise.resolve().then(async()=>{const w=await this.components.peerStore.get(g),y={id:g,multiaddrs:w.addresses.map(({multiaddr:b})=>b),protocols:w.protocols};await this.onPeerConnect(y)}).catch(w=>{this.log.error("could not add %p to routing table - %e",g,w)})}),this.dhtPeerRouting=new Q4e(this),this.dhtContentRouting=new G4e(this),n.clientMode==null&&t.events.addEventListener("self:peer:update",f=>{this.log("received update of self-peer info"),Promise.resolve().then(async()=>{const g=f.detail.peer.addresses.some(({multiaddr:y})=>Hwe(y)),w=this.getMode();g&&w==="client"?await this.setMode("server"):w==="server"&&!g&&await this.setMode("client")}).catch(g=>{this.log.error("error setting dht server mode",g)})}),this.get=oh(this.get.bind(this),a,"GET_VALUE"),this.findProviders=oh(this.findProviders.bind(this),a,"FIND_PROVIDERS"),this.findPeer=oh(this.findPeer.bind(this),a,"FIND_PEER"),this.getClosestPeers=oh(this.getClosestPeers.bind(this),a,"GET_CLOSEST_PEERS"),this.provide=oh(this.provide.bind(this),a,"PROVIDE"),this.put=oh(this.put.bind(this),a,"PUT_VALUE")}get[(lH=Symbol.toStringTag,cH=ur,aH=ja,bd)](){return this.dhtContentRouting}get[vd](){return this.dhtPeerRouting}get[k2](){return this}async onPeerConnect(t){if(this.log.trace("peer %p connected",t.id),t=this.peerInfoMapper(t),t.multiaddrs.length===0){this.log.trace("ignoring %p as there were no valid addresses in %s after filtering",t.id,t.multiaddrs.map(n=>n.toString()));return}try{await this.routingTable.add(t.id)}catch(n){this.log.error("could not add %p to routing table",t.id,n)}}isStarted(){return this.running}getMode(){return this.clientMode?"client":"server"}async setMode(t,n=!1){if(t===this.getMode()&&!n){this.log("already in %s mode",t);return}if(await this.components.registrar.unhandle(this.protocol),t===this.getMode()&&!n){this.log("already in %s mode",t);return}t==="client"?(this.log("enabling client mode while in %s mode",this.getMode()),this.clientMode=!0):(this.log("enabling server mode while in %s mode",this.getMode()),this.clientMode=!1,await this.components.registrar.handle(this.protocol,this.rpc.onIncomingStream.bind(this.rpc),{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams}))}async start(){this.running||(this.running=!0,await this.setMode(this.clientMode?"client":"server",!0),await xo(this.routingTable,this.queryManager,this.network,this.topologyListener,this.routingTableRefresh,this.reprovider),await xo(this.querySelf))}async stop(){this.running=!1,await Ka(this.querySelf,this.queryManager,this.network,this.routingTable,this.routingTableRefresh,this.topologyListener,this.reprovider)}async*put(t,n,i={}){yield*this.contentFetching.put(t,n,i)}async*get(t,n={}){yield*this.contentFetching.get(t,n)}async*provide(t,n={}){yield*this.contentRouting.provide(t,this.components.addressManager.getAddresses(),n)}async cancelReprovide(t){await this.providers.removeProvider(t,this.components.peerId)}async*findProviders(t,n={}){yield*this.contentRouting.findProviders(t,n)}async*findPeer(t,n={}){yield*this.peerRouting.findPeer(t,n)}async*getClosestPeers(t,n={}){yield*this.peerRouting.getClosestPeers(t,n)}async refreshRoutingTable(){this.routingTableRefresh.refreshTable(!0)}}var fE;(function(r){r[r.SEND_QUERY=0]="SEND_QUERY",r[r.PEER_RESPONSE=1]="PEER_RESPONSE",r[r.FINAL_PEER=2]="FINAL_PEER",r[r.QUERY_ERROR=3]="QUERY_ERROR",r[r.PROVIDER=4]="PROVIDER",r[r.VALUE=5]="VALUE",r[r.ADD_PEER=6]="ADD_PEER",r[r.DIAL_PEER=7]="DIAL_PEER"})(fE||(fE={}));function Z4e(r={}){return e=>new X4e(e,r)}var e8e=r=>{if(Object.prototype.toString.call(r)!=="[object Object]")return!1;const e=Object.getPrototypeOf(r);return e===null||e===Object.prototype};const P3=e8e,{hasOwnProperty:zB}=Object.prototype,{propertyIsEnumerable:t8e}=Object,ah=(r,e,t)=>Object.defineProperty(r,e,{value:t,writable:!0,enumerable:!0,configurable:!0}),r8e=rt,VB={concatArrays:!1,ignoreUndefined:!1},D3=r=>{const e=[];for(const t in r)zB.call(r,t)&&e.push(t);if(Object.getOwnPropertySymbols){const t=Object.getOwnPropertySymbols(r);for(const n of t)t8e.call(r,n)&&e.push(n)}return e};function ch(r){return Array.isArray(r)?n8e(r):P3(r)?i8e(r):r}function n8e(r){const e=r.slice(0,0);return D3(r).forEach(t=>{ah(e,t,ch(r[t]))}),e}function i8e(r){const e=Object.getPrototypeOf(r)===null?Object.create(null):{};return D3(r).forEach(t=>{ah(e,t,ch(r[t]))}),e}const KB=(r,e,t,n)=>(t.forEach(i=>{typeof e[i]>"u"&&n.ignoreUndefined||(i in r&&r[i]!==Object.getPrototypeOf(r)?ah(r,i,pE(r[i],e[i],n)):ah(r,i,ch(e[i])))}),r),s8e=(r,e,t)=>{let n=r.slice(0,0),i=0;return[r,e].forEach(s=>{const o=[];for(let a=0;a<s.length;a++)zB.call(s,a)&&(o.push(String(a)),s===r?ah(n,i++,s[a]):ah(n,i++,ch(s[a])));n=KB(n,s,D3(s).filter(a=>!o.includes(a)),t)}),n};function pE(r,e,t){return t.concatArrays&&Array.isArray(r)&&Array.isArray(e)?s8e(r,e,t):!P3(e)||!P3(r)?ch(e):KB(r,e,D3(e),t)}var o8e=function(...r){const e=pE(ch(VB),this!==r8e&&this||{},VB);let t={_:{}};for(const n of r)if(n!==void 0){if(!P3(n))throw new TypeError("`"+n+"` is not an Option Object");t=pE(t,{_:n},e)}return t._};const gE=Je(o8e);function a8e(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function c8e(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var i=0;i<r.length;i++){var s=r.charAt(i),o=s.charCodeAt(0);if(t[o]!==255)throw new TypeError(s+" is ambiguous");t[o]=i}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),d=Math.log(256)/Math.log(a);function h(f){if(f instanceof Uint8Array||(ArrayBuffer.isView(f)?f=new Uint8Array(f.buffer,f.byteOffset,f.byteLength):Array.isArray(f)&&(f=Uint8Array.from(f))),!(f instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(f.length===0)return"";for(var g=0,w=0,y=0,b=f.length;y!==b&&f[y]===0;)y++,g++;for(var v=(b-y)*d+1>>>0,E=new Uint8Array(v);y!==b;){for(var C=f[y],k=0,x=v-1;(C!==0||k<w)&&x!==-1;x--,k++)C+=256*E[x]>>>0,E[x]=C%a>>>0,C=C/a>>>0;if(C!==0)throw new Error("Non-zero carry");w=k,y++}for(var I=v-w;I!==v&&E[I]===0;)I++;for(var T=c.repeat(g);I<v;++I)T+=r.charAt(E[I]);return T}function p(f){if(typeof f!="string")throw new TypeError("Expected String");if(f.length===0)return new Uint8Array;var g=0;if(f[g]!==" "){for(var w=0,y=0;f[g]===c;)w++,g++;for(var b=(f.length-g)*l+1>>>0,v=new Uint8Array(b);f[g];){var E=t[f.charCodeAt(g)];if(E===255)return;for(var C=0,k=b-1;(E!==0||C<y)&&k!==-1;k--,C++)E+=a*v[k]>>>0,v[k]=E%256>>>0,E=E/256>>>0;if(E!==0)throw new Error("Non-zero carry");y=C,g++}if(f[g]!==" "){for(var x=b-y;x!==b&&v[x]===0;)x++;for(var I=new Uint8Array(w+(b-x)),T=w;x!==b;)I[T++]=v[x++];return I}}}function m(f){var g=p(f);if(g)return g;throw new Error(`Non-${e} character`)}return{encode:h,decodeUnsafe:p,decode:m}}var l8e=c8e,u8e=l8e;let d8e=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseEncode");this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},h8e=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseDecode");u(this,"prefixCodePoint");this.name=e,this.prefix=t;const i=t.codePointAt(0);if(i===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=i,this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return jB(this,e)}},f8e=class{constructor(e){u(this,"decoders");this.decoders=e}or(e){return jB(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};function jB(r,e){return new f8e({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}let p8e=class{constructor(e,t,n,i){u(this,"name");u(this,"prefix");u(this,"baseEncode");u(this,"baseDecode");u(this,"encoder");u(this,"decoder");this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=i,this.encoder=new d8e(e,t,n),this.decoder=new h8e(e,t,i)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};function HB({name:r,prefix:e,encode:t,decode:n}){return new p8e(r,e,t,n)}function qB({name:r,prefix:e,alphabet:t}){const{encode:n,decode:i}=u8e(t,r);return HB({prefix:e,name:r,encode:n,decode:s=>a8e(i(s))})}function g8e(r,e,t,n){const i={};for(let d=0;d<e.length;++d)i[e[d]]=d;let s=r.length;for(;r[s-1]==="=";)--s;const o=new Uint8Array(s*t/8|0);let a=0,c=0,l=0;for(let d=0;d<s;++d){const h=i[r[d]];if(h===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|h,a+=t,a>=8&&(a-=8,o[l++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o}function y8e(r,e,t){const n=e[e.length-1]==="=",i=(1<<t)-1;let s="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,s+=e[i&a>>o];if(o!==0&&(s+=e[i&a<<t-o]),n)for(;s.length*t&7;)s+="=";return s}function $3({name:r,prefix:e,bitsPerChar:t,alphabet:n}){return HB({prefix:e,name:r,encode(i){return y8e(i,n,t)},decode(i){return g8e(i,n,t,r)}})}const m8e=qB({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});qB({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var w8e=GB,WB=128,b8e=-128,v8e=Math.pow(2,31);function GB(r,e,t){e=e||[],t=t||0;for(var n=t;r>=v8e;)e[t++]=r&255|WB,r/=128;for(;r&b8e;)e[t++]=r&255|WB,r>>>=7;return e[t]=r|0,GB.bytes=t-n+1,e}var E8e=yE,S8e=128,QB=127;function yE(r,n){var t=0,n=n||0,i=0,s=n,o,a=r.length;do{if(s>=a)throw yE.bytes=0,new RangeError("Could not decode varint");o=r[s++],t+=i<28?(o&QB)<<i:(o&QB)*Math.pow(2,i),i+=7}while(o>=S8e);return yE.bytes=s-n,t}var x8e=Math.pow(2,7),A8e=Math.pow(2,14),C8e=Math.pow(2,21),I8e=Math.pow(2,28),k8e=Math.pow(2,35),_8e=Math.pow(2,42),T8e=Math.pow(2,49),P8e=Math.pow(2,56),D8e=Math.pow(2,63),$8e=function(r){return r<x8e?1:r<A8e?2:r<C8e?3:r<I8e?4:r<k8e?5:r<_8e?6:r<T8e?7:r<P8e?8:r<D8e?9:10},N8e={encode:w8e,decode:E8e,encodingLength:$8e},YB=N8e;function JB(r,e,t=0){return YB.encode(r,e,t),e}function XB(r){return YB.encodingLength(r)}function ZB(r,e){const t=e.byteLength,n=XB(r),i=n+XB(t),s=new Uint8Array(i+t);return JB(r,s,0),JB(t,s,n),s.set(e,i),new M8e(r,t,e,s)}let M8e=class{constructor(e,t,n,i){u(this,"code");u(this,"size");u(this,"digest");u(this,"bytes");this.code=e,this.size=t,this.digest=n,this.bytes=i}};function O8e({name:r,code:e,encode:t}){return new R8e(r,e,t)}let R8e=class{constructor(e,t,n){u(this,"name");u(this,"code");u(this,"encode");this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?ZB(this.code,t):t.then(n=>ZB(this.code,n))}else throw Error("Unknown type, must be binary type")}};function L8e(r){return async e=>new Uint8Array(await crypto.subtle.digest(r,e))}const B8e=O8e({name:"sha2-256",code:18,encode:L8e("SHA-256")});function U8e(r){return r>=55296&&r<=56319}function F8e(r){return r>=56320&&r<=57343}var z8e=function(e,t,n){if(typeof t!="string")throw new Error("Input must be string");for(var i=t.length,s=0,o,a,c=0;c<i;c+=1){if(o=t.charCodeAt(c),a=t[c],U8e(o)&&F8e(t.charCodeAt(c+1))&&(c+=1,a+=t[c]),s+=e(a),s===n)return t.slice(0,c+1);if(s>n)return t.slice(0,c-a.length+1)}return t};function V8e(r){return r>=55296&&r<=56319}function K8e(r){return r>=56320&&r<=57343}var j8e=function(e){if(typeof e!="string")throw new Error("Input must be string");for(var t=e.length,n=0,i=null,s=null,o=0;o<t;o++)i=e.charCodeAt(o),K8e(i)?s!=null&&V8e(s)?n+=1:n+=3:i<=127?n+=1:i>=128&&i<=2047?n+=2:i>=2048&&i<=65535&&(n+=3),s=i;return n},H8e=z8e,q8e=j8e,W8e=H8e.bind(null,q8e),G8e=W8e,Q8e=/[\/\?<>\\:\*\|"]/g,Y8e=/[\x00-\x1f\x80-\x9f]/g,J8e=/^\.+$/,X8e=/^(con|prn|aux|nul|com[0-9]|lpt[0-9])(\..*)?$/i,Z8e=/[\. ]+$/;function eU(r,e){if(typeof r!="string")throw new Error("Input must be string");var t=r.replace(Q8e,e).replace(Y8e,e).replace(J8e,e).replace(X8e,e).replace(Z8e,e);return G8e(t,255)}var e5e=function(r,e){var t=e&&e.replacement||"",n=eU(r,t);return t===""?n:eU(n,"")};const t5e=Je(e5e),mE={alg:"A128GCM",ext:!0,k:"scm9jmO_4BJAgdwWGVulLg",key_ops:["encrypt","decrypt"],kty:"oct"};function tU(r){const e="AES-GCM";let t=16;const n=12,i="SHA-256",s=16,o=32767,a=Rs.get();t*=8;async function c(h,p){const m=a.getRandomValues(new Uint8Array(s)),f=a.getRandomValues(new Uint8Array(n)),g={name:e,iv:f};typeof p=="string"&&(p=ie(p));let w;if(p.length===0){w=await a.subtle.importKey("jwk",mE,{name:"AES-GCM"},!0,["encrypt"]);try{const b={name:"PBKDF2",salt:m,iterations:o,hash:{name:i}},v=await a.subtle.importKey("raw",p,{name:"PBKDF2"},!1,["deriveKey"]);w=await a.subtle.deriveKey(b,v,{name:e,length:t},!0,["encrypt"])}catch{w=await a.subtle.importKey("jwk",mE,{name:"AES-GCM"},!0,["encrypt"])}}else{const b={name:"PBKDF2",salt:m,iterations:o,hash:{name:i}},v=await a.subtle.importKey("raw",p,{name:"PBKDF2"},!1,["deriveKey"]);w=await a.subtle.deriveKey(b,v,{name:e,length:t},!0,["encrypt"])}const y=await a.subtle.encrypt(g,w,h);return sr([m,g.iv,new Uint8Array(y)])}async function l(h,p){const m=h.subarray(0,s),f=h.subarray(s,s+n),g=h.subarray(s+n),w={name:e,iv:f};typeof p=="string"&&(p=ie(p));let y;if(p.length===0)try{const v={name:"PBKDF2",salt:m,iterations:o,hash:{name:i}},E=await a.subtle.importKey("raw",p,{name:"PBKDF2"},!1,["deriveKey"]);y=await a.subtle.deriveKey(v,E,{name:e,length:t},!0,["decrypt"])}catch{y=await a.subtle.importKey("jwk",mE,{name:"AES-GCM"},!0,["decrypt"])}else{const v={name:"PBKDF2",salt:m,iterations:o,hash:{name:i}},E=await a.subtle.importKey("raw",p,{name:"PBKDF2"},!1,["deriveKey"]);y=await a.subtle.deriveKey(v,E,{name:e,length:t},!0,["decrypt"])}const b=await a.subtle.decrypt(w,y,g);return new Uint8Array(b)}return{encrypt:c,decrypt:l}}/*!
* MIT License
* 
* Copyright (c) 2017-2024 Peculiar Ventures, LLC
* 
* Permission is hereby granted, free of charge, to any person obtaining a copy
* of this software and associated documentation files (the "Software"), to deal
* in the Software without restriction, including without limitation the rights
* to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
* copies of the Software, and to permit persons to whom the Software is
* furnished to do so, subject to the following conditions:
* 
* The above copyright notice and this permission notice shall be included in all
* copies or substantial portions of the Software.
* 
* THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
* IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
* FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
* AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
* LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
* OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
* SOFTWARE.
* 
*/const r5e="[object ArrayBuffer]";class ue{static isArrayBuffer(e){return Object.prototype.toString.call(e)===r5e}static toArrayBuffer(e){return this.isArrayBuffer(e)?e:e.byteLength===e.buffer.byteLength||e.byteOffset===0&&e.byteLength===e.buffer.byteLength?e.buffer:this.toUint8Array(e.buffer).slice(e.byteOffset,e.byteOffset+e.byteLength).buffer}static toUint8Array(e){return this.toView(e,Uint8Array)}static toView(e,t){if(e.constructor===t)return e;if(this.isArrayBuffer(e))return new t(e);if(this.isArrayBufferView(e))return new t(e.buffer,e.byteOffset,e.byteLength);throw new TypeError("The provided value is not of type '(ArrayBuffer or ArrayBufferView)'")}static isBufferSource(e){return this.isArrayBufferView(e)||this.isArrayBuffer(e)}static isArrayBufferView(e){return ArrayBuffer.isView(e)||e&&this.isArrayBuffer(e.buffer)}static isEqual(e,t){const n=ue.toUint8Array(e),i=ue.toUint8Array(t);if(n.length!==i.byteLength)return!1;for(let s=0;s<n.length;s++)if(n[s]!==i[s])return!1;return!0}static concat(...e){let t;Array.isArray(e[0])&&!(e[1]instanceof Function)||Array.isArray(e[0])&&e[1]instanceof Function?t=e[0]:e[e.length-1]instanceof Function?t=e.slice(0,e.length-1):t=e;let n=0;for(const o of t)n+=o.byteLength;const i=new Uint8Array(n);let s=0;for(const o of t){const a=this.toUint8Array(o);i.set(a,s),s+=a.length}return e[e.length-1]instanceof Function?this.toView(i,e[e.length-1]):i.buffer}}const wE="string",n5e=/^[0-9a-f\s]+$/i,i5e=/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/,s5e=/^[a-zA-Z0-9-_]+$/;class rU{static fromString(e){const t=unescape(encodeURIComponent(e)),n=new Uint8Array(t.length);for(let i=0;i<t.length;i++)n[i]=t.charCodeAt(i);return n.buffer}static toString(e){const t=ue.toUint8Array(e);let n="";for(let s=0;s<t.length;s++)n+=String.fromCharCode(t[s]);return decodeURIComponent(escape(n))}}class js{static toString(e,t=!1){const n=ue.toArrayBuffer(e),i=new DataView(n);let s="";for(let o=0;o<n.byteLength;o+=2){const a=i.getUint16(o,t);s+=String.fromCharCode(a)}return s}static fromString(e,t=!1){const n=new ArrayBuffer(e.length*2),i=new DataView(n);for(let s=0;s<e.length;s++)i.setUint16(s*2,e.charCodeAt(s),t);return n}}class Ee{static isHex(e){return typeof e===wE&&n5e.test(e)}static isBase64(e){return typeof e===wE&&i5e.test(e)}static isBase64Url(e){return typeof e===wE&&s5e.test(e)}static ToString(e,t="utf8"){const n=ue.toUint8Array(e);switch(t.toLowerCase()){case"utf8":return this.ToUtf8String(n);case"binary":return this.ToBinary(n);case"hex":return this.ToHex(n);case"base64":return this.ToBase64(n);case"base64url":return this.ToBase64Url(n);case"utf16le":return js.toString(n,!0);case"utf16":case"utf16be":return js.toString(n);default:throw new Error(`Unknown type of encoding '${t}'`)}}static FromString(e,t="utf8"){if(!e)return new ArrayBuffer(0);switch(t.toLowerCase()){case"utf8":return this.FromUtf8String(e);case"binary":return this.FromBinary(e);case"hex":return this.FromHex(e);case"base64":return this.FromBase64(e);case"base64url":return this.FromBase64Url(e);case"utf16le":return js.fromString(e,!0);case"utf16":case"utf16be":return js.fromString(e);default:throw new Error(`Unknown type of encoding '${t}'`)}}static ToBase64(e){const t=ue.toUint8Array(e);if(typeof btoa<"u"){const n=this.ToString(t,"binary");return btoa(n)}else return Buffer.from(t).toString("base64")}static FromBase64(e){const t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!Ee.isBase64(t))throw new TypeError("Argument 'base64Text' is not Base64 encoded");return typeof atob<"u"?this.FromBinary(atob(t)):new Uint8Array(Buffer.from(t,"base64")).buffer}static FromBase64Url(e){const t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!Ee.isBase64Url(t))throw new TypeError("Argument 'base64url' is not Base64Url encoded");return this.FromBase64(this.Base64Padding(t.replace(/\-/g,"+").replace(/\_/g,"/")))}static ToBase64Url(e){return this.ToBase64(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/\=/g,"")}static FromUtf8String(e,t=Ee.DEFAULT_UTF8_ENCODING){switch(t){case"ascii":return this.FromBinary(e);case"utf8":return rU.fromString(e);case"utf16":case"utf16be":return js.fromString(e);case"utf16le":case"usc2":return js.fromString(e,!0);default:throw new Error(`Unknown type of encoding '${t}'`)}}static ToUtf8String(e,t=Ee.DEFAULT_UTF8_ENCODING){switch(t){case"ascii":return this.ToBinary(e);case"utf8":return rU.toString(e);case"utf16":case"utf16be":return js.toString(e);case"utf16le":case"usc2":return js.toString(e,!0);default:throw new Error(`Unknown type of encoding '${t}'`)}}static FromBinary(e){const t=e.length,n=new Uint8Array(t);for(let i=0;i<t;i++)n[i]=e.charCodeAt(i);return n.buffer}static ToBinary(e){const t=ue.toUint8Array(e);let n="";for(let i=0;i<t.length;i++)n+=String.fromCharCode(t[i]);return n}static ToHex(e){const t=ue.toUint8Array(e);let n="";const i=t.length;for(let s=0;s<i;s++){const o=t[s];o<16&&(n+="0"),n+=o.toString(16)}return n}static FromHex(e){let t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!Ee.isHex(t))throw new TypeError("Argument 'hexString' is not HEX encoded");t.length%2&&(t=`0${t}`);const n=new Uint8Array(t.length/2);for(let i=0;i<t.length;i=i+2){const s=t.slice(i,i+2);n[i/2]=parseInt(s,16)}return n.buffer}static ToUtf16String(e,t=!1){return js.toString(e,t)}static FromUtf16String(e,t=!1){return js.fromString(e,t)}static Base64Padding(e){const t=4-e.length%4;if(t<4)for(let n=0;n<t;n++)e+="=";return e}static formatString(e){return(e==null?void 0:e.replace(/[\n\r\t ]/g,""))||""}}Ee.DEFAULT_UTF8_ENCODING="utf8";function o5e(...r){const e=r.map(i=>i.byteLength).reduce((i,s)=>i+s),t=new Uint8Array(e);let n=0;return r.map(i=>new Uint8Array(i)).forEach(i=>{for(const s of i)t[n++]=s}),t.buffer}function nU(r,e){if(!(r&&e)||r.byteLength!==e.byteLength)return!1;const t=new Uint8Array(r),n=new Uint8Array(e);for(let i=0;i<r.byteLength;i++)if(t[i]!==n[i])return!1;return!0}/*!
 Copyright (c) Peculiar Ventures, LLC
*/function lh(r,e){let t=0;if(r.length===1)return r[0];for(let n=r.length-1;n>=0;n--)t+=r[r.length-1-n]*Math.pow(2,e*n);return t}function Xl(r,e,t=-1){const n=t;let i=r,s=0,o=Math.pow(2,e);for(let a=1;a<8;a++){if(r<o){let c;if(n<0)c=new ArrayBuffer(a),s=a;else{if(n<a)return new ArrayBuffer(0);c=new ArrayBuffer(n),s=n}const l=new Uint8Array(c);for(let d=a-1;d>=0;d--){const h=Math.pow(2,d*e);l[s-d-1]=Math.floor(i/h),i-=l[s-d-1]*h}return c}o*=Math.pow(2,e)}return new ArrayBuffer(0)}function bE(...r){let e=0,t=0;for(const s of r)e+=s.length;const n=new ArrayBuffer(e),i=new Uint8Array(n);for(const s of r)i.set(s,t),t+=s.length;return i}function iU(){const r=new Uint8Array(this.valueHex);if(this.valueHex.byteLength>=2){const a=r[0]===255&&r[1]&128,c=r[0]===0&&(r[1]&128)===0;(a||c)&&this.warnings.push("Needlessly long format")}const e=new ArrayBuffer(this.valueHex.byteLength),t=new Uint8Array(e);for(let a=0;a<this.valueHex.byteLength;a++)t[a]=0;t[0]=r[0]&128;const n=lh(t,8),i=new ArrayBuffer(this.valueHex.byteLength),s=new Uint8Array(i);for(let a=0;a<this.valueHex.byteLength;a++)s[a]=r[a];return s[0]&=127,lh(s,8)-n}function a5e(r){const e=r<0?r*-1:r;let t=128;for(let n=1;n<8;n++){if(e<=t){if(r<0){const o=t-e,a=Xl(o,8,n),c=new Uint8Array(a);return c[0]|=128,a}let i=Xl(e,8,n),s=new Uint8Array(i);if(s[0]&128){const o=i.slice(0),a=new Uint8Array(o);i=new ArrayBuffer(i.byteLength+1),s=new Uint8Array(i);for(let c=0;c<o.byteLength;c++)s[c+1]=a[c];s[0]=0}return i}t*=Math.pow(2,8)}return new ArrayBuffer(0)}function c5e(r,e){if(r.byteLength!==e.byteLength)return!1;const t=new Uint8Array(r),n=new Uint8Array(e);for(let i=0;i<t.length;i++)if(t[i]!==n[i])return!1;return!0}function li(r,e){const t=r.toString(10);if(e<t.length)return"";const n=e-t.length,i=new Array(n);for(let o=0;o<n;o++)i[o]="0";return i.join("").concat(t)}/*!
* Copyright (c) 2014, GMO GlobalSign
* Copyright (c) 2015-2022, Peculiar Ventures
* All rights reserved.
* 
* Author 2014-2019, Yury Strozhevsky
* 
* Redistribution and use in source and binary forms, with or without modification,
* are permitted provided that the following conditions are met:
* 
* * Redistributions of source code must retain the above copyright notice, this
*   list of conditions and the following disclaimer.
* 
* * Redistributions in binary form must reproduce the above copyright notice, this
*   list of conditions and the following disclaimer in the documentation and/or
*   other materials provided with the distribution.
* 
* * Neither the name of the copyright holder nor the names of its
*   contributors may be used to endorse or promote products derived from
*   this software without specific prior written permission.
* 
* THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
* ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
* WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
* DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR
* ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
* (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
* LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
* ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
* (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
* SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
* 
*/function N3(){if(typeof BigInt>"u")throw new Error("BigInt is not defined. Your environment doesn't implement BigInt.")}function vE(r){let e=0,t=0;for(let i=0;i<r.length;i++){const s=r[i];e+=s.byteLength}const n=new Uint8Array(e);for(let i=0;i<r.length;i++){const s=r[i];n.set(new Uint8Array(s),t),t+=s.byteLength}return n.buffer}function Ko(r,e,t,n){return e instanceof Uint8Array?e.byteLength?t<0?(r.error="Wrong parameter: inputOffset less than zero",!1):n<0?(r.error="Wrong parameter: inputLength less than zero",!1):e.byteLength-t-n<0?(r.error="End of input reached before message was fully decoded (inconsistent offset and length values)",!1):!0:(r.error="Wrong parameter: inputBuffer has zero length",!1):(r.error="Wrong parameter: inputBuffer must be 'Uint8Array'",!1)}class M3{constructor(){this.items=[]}write(e){this.items.push(e)}final(){return vE(this.items)}}const yp=[new Uint8Array([1])],sU="0123456789",EE="name",oU="valueHexView",l5e="isHexOnly",u5e="idBlock",d5e="tagClass",h5e="tagNumber",f5e="isConstructed",p5e="fromBER",g5e="toBER",y5e="local",_n="",ls=new ArrayBuffer(0),O3=new Uint8Array(0),mp="EndOfContent",aU="OCTET STRING",cU="BIT STRING";function Hs(r){var e;return e=class extends r{get valueHex(){return this.valueHexView.slice().buffer}set valueHex(n){this.valueHexView=new Uint8Array(n)}constructor(...n){var i;super(...n);const s=n[0]||{};this.isHexOnly=(i=s.isHexOnly)!==null&&i!==void 0?i:!1,this.valueHexView=s.valueHex?ue.toUint8Array(s.valueHex):O3}fromBER(n,i,s){const o=n instanceof ArrayBuffer?new Uint8Array(n):n;if(!Ko(this,o,i,s))return-1;const a=i+s;return this.valueHexView=o.subarray(i,a),this.valueHexView.length?(this.blockLength=s,a):(this.warnings.push("Zero buffer length"),i)}toBER(n=!1){return this.isHexOnly?n?new ArrayBuffer(this.valueHexView.byteLength):this.valueHexView.byteLength===this.valueHexView.buffer.byteLength?this.valueHexView.buffer:this.valueHexView.slice().buffer:(this.error="Flag 'isHexOnly' is not set, abort",ls)}toJSON(){return{...super.toJSON(),isHexOnly:this.isHexOnly,valueHex:Ee.ToHex(this.valueHexView)}}},e.NAME="hexBlock",e}class Zl{static blockName(){return this.NAME}get valueBeforeDecode(){return this.valueBeforeDecodeView.slice().buffer}set valueBeforeDecode(e){this.valueBeforeDecodeView=new Uint8Array(e)}constructor({blockLength:e=0,error:t=_n,warnings:n=[],valueBeforeDecode:i=O3}={}){this.blockLength=e,this.error=t,this.warnings=n,this.valueBeforeDecodeView=ue.toUint8Array(i)}toJSON(){return{blockName:this.constructor.NAME,blockLength:this.blockLength,error:this.error,warnings:this.warnings,valueBeforeDecode:Ee.ToHex(this.valueBeforeDecodeView)}}}Zl.NAME="baseBlock";class fn extends Zl{fromBER(e,t,n){throw TypeError("User need to make a specific function in a class which extends 'ValueBlock'")}toBER(e,t){throw TypeError("User need to make a specific function in a class which extends 'ValueBlock'")}}fn.NAME="valueBlock";class lU extends Hs(Zl){constructor({idBlock:e={}}={}){var t,n,i,s;super(),e?(this.isHexOnly=(t=e.isHexOnly)!==null&&t!==void 0?t:!1,this.valueHexView=e.valueHex?ue.toUint8Array(e.valueHex):O3,this.tagClass=(n=e.tagClass)!==null&&n!==void 0?n:-1,this.tagNumber=(i=e.tagNumber)!==null&&i!==void 0?i:-1,this.isConstructed=(s=e.isConstructed)!==null&&s!==void 0?s:!1):(this.tagClass=-1,this.tagNumber=-1,this.isConstructed=!1)}toBER(e=!1){let t=0;switch(this.tagClass){case 1:t|=0;break;case 2:t|=64;break;case 3:t|=128;break;case 4:t|=192;break;default:return this.error="Unknown tag class",ls}if(this.isConstructed&&(t|=32),this.tagNumber<31&&!this.isHexOnly){const i=new Uint8Array(1);if(!e){let s=this.tagNumber;s&=31,t|=s,i[0]=t}return i.buffer}if(!this.isHexOnly){const i=Xl(this.tagNumber,7),s=new Uint8Array(i),o=i.byteLength,a=new Uint8Array(o+1);if(a[0]=t|31,!e){for(let c=0;c<o-1;c++)a[c+1]=s[c]|128;a[o]=s[o-1]}return a.buffer}const n=new Uint8Array(this.valueHexView.byteLength+1);if(n[0]=t|31,!e){const i=this.valueHexView;for(let s=0;s<i.length-1;s++)n[s+1]=i[s]|128;n[this.valueHexView.byteLength]=i[i.length-1]}return n.buffer}fromBER(e,t,n){const i=ue.toUint8Array(e);if(!Ko(this,i,t,n))return-1;const s=i.subarray(t,t+n);if(s.length===0)return this.error="Zero buffer length",-1;switch(s[0]&192){case 0:this.tagClass=1;break;case 64:this.tagClass=2;break;case 128:this.tagClass=3;break;case 192:this.tagClass=4;break;default:return this.error="Unknown tag class",-1}this.isConstructed=(s[0]&32)===32,this.isHexOnly=!1;const a=s[0]&31;if(a!==31)this.tagNumber=a,this.blockLength=1;else{let c=1,l=this.valueHexView=new Uint8Array(255),d=255;for(;s[c]&128;){if(l[c-1]=s[c]&127,c++,c>=s.length)return this.error="End of input reached before message was fully decoded",-1;if(c===d){d+=255;const p=new Uint8Array(d);for(let m=0;m<l.length;m++)p[m]=l[m];l=this.valueHexView=new Uint8Array(d)}}this.blockLength=c+1,l[c-1]=s[c]&127;const h=new Uint8Array(c);for(let p=0;p<c;p++)h[p]=l[p];l=this.valueHexView=new Uint8Array(c),l.set(h),this.blockLength<=9?this.tagNumber=lh(l,7):(this.isHexOnly=!0,this.warnings.push("Tag too long, represented as hex-coded"))}if(this.tagClass===1&&this.isConstructed)switch(this.tagNumber){case 1:case 2:case 5:case 6:case 9:case 13:case 14:case 23:case 24:case 31:case 32:case 33:case 34:return this.error="Constructed encoding used for primitive type",-1}return t+this.blockLength}toJSON(){return{...super.toJSON(),tagClass:this.tagClass,tagNumber:this.tagNumber,isConstructed:this.isConstructed}}}lU.NAME="identificationBlock";class uU extends Zl{constructor({lenBlock:e={}}={}){var t,n,i;super(),this.isIndefiniteForm=(t=e.isIndefiniteForm)!==null&&t!==void 0?t:!1,this.longFormUsed=(n=e.longFormUsed)!==null&&n!==void 0?n:!1,this.length=(i=e.length)!==null&&i!==void 0?i:0}fromBER(e,t,n){const i=ue.toUint8Array(e);if(!Ko(this,i,t,n))return-1;const s=i.subarray(t,t+n);if(s.length===0)return this.error="Zero buffer length",-1;if(s[0]===255)return this.error="Length block 0xFF is reserved by standard",-1;if(this.isIndefiniteForm=s[0]===128,this.isIndefiniteForm)return this.blockLength=1,t+this.blockLength;if(this.longFormUsed=!!(s[0]&128),this.longFormUsed===!1)return this.length=s[0],this.blockLength=1,t+this.blockLength;const o=s[0]&127;if(o>8)return this.error="Too big integer",-1;if(o+1>s.length)return this.error="End of input reached before message was fully decoded",-1;const a=t+1,c=i.subarray(a,a+o);return c[o-1]===0&&this.warnings.push("Needlessly long encoded length"),this.length=lh(c,8),this.longFormUsed&&this.length<=127&&this.warnings.push("Unnecessary usage of long length form"),this.blockLength=o+1,t+this.blockLength}toBER(e=!1){let t,n;if(this.length>127&&(this.longFormUsed=!0),this.isIndefiniteForm)return t=new ArrayBuffer(1),e===!1&&(n=new Uint8Array(t),n[0]=128),t;if(this.longFormUsed){const i=Xl(this.length,8);if(i.byteLength>127)return this.error="Too big length",ls;if(t=new ArrayBuffer(i.byteLength+1),e)return t;const s=new Uint8Array(i);n=new Uint8Array(t),n[0]=i.byteLength|128;for(let o=0;o<i.byteLength;o++)n[o+1]=s[o];return t}return t=new ArrayBuffer(1),e===!1&&(n=new Uint8Array(t),n[0]=this.length),t}toJSON(){return{...super.toJSON(),isIndefiniteForm:this.isIndefiniteForm,longFormUsed:this.longFormUsed,length:this.length}}}uU.NAME="lengthBlock";const me={};class Ar extends Zl{constructor({name:e=_n,optional:t=!1,primitiveSchema:n,...i}={},s){super(i),this.name=e,this.optional=t,n&&(this.primitiveSchema=n),this.idBlock=new lU(i),this.lenBlock=new uU(i),this.valueBlock=s?new s(i):new fn(i)}fromBER(e,t,n){const i=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?n:this.lenBlock.length);return i===-1?(this.error=this.valueBlock.error,i):(this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),i)}toBER(e,t){const n=t||new M3;t||dU(this);const i=this.idBlock.toBER(e);if(n.write(i),this.lenBlock.isIndefiniteForm)n.write(new Uint8Array([128]).buffer),this.valueBlock.toBER(e,n),n.write(new ArrayBuffer(2));else{const s=this.valueBlock.toBER(e);this.lenBlock.length=s.byteLength;const o=this.lenBlock.toBER(e);n.write(o),n.write(s)}return t?ls:n.final()}toJSON(){const e={...super.toJSON(),idBlock:this.idBlock.toJSON(),lenBlock:this.lenBlock.toJSON(),valueBlock:this.valueBlock.toJSON(),name:this.name,optional:this.optional};return this.primitiveSchema&&(e.primitiveSchema=this.primitiveSchema.toJSON()),e}toString(e="ascii"){return e==="ascii"?this.onAsciiEncoding():Ee.ToHex(this.toBER())}onAsciiEncoding(){const e=this.constructor.NAME,t=Ee.ToHex(this.valueBlock.valueBeforeDecodeView);return`${e} : ${t}`}isEqual(e){if(this===e)return!0;if(!(e instanceof this.constructor))return!1;const t=this.toBER(),n=e.toBER();return c5e(t,n)}}Ar.NAME="BaseBlock";function dU(r){var e;if(r instanceof me.Constructed)for(const t of r.valueBlock.value)dU(t)&&(r.lenBlock.isIndefiniteForm=!0);return!!(!((e=r.lenBlock)===null||e===void 0)&&e.isIndefiniteForm)}class SE extends Ar{getValue(){return this.valueBlock.value}setValue(e){this.valueBlock.value=e}constructor({value:e=_n,...t}={},n){super(t,n),e&&this.fromString(e)}fromBER(e,t,n){const i=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?n:this.lenBlock.length);return i===-1?(this.error=this.valueBlock.error,i):(this.fromBuffer(this.valueBlock.valueHexView),this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),i)}onAsciiEncoding(){return`${this.constructor.NAME} : '${this.valueBlock.value}'`}}SE.NAME="BaseStringBlock";class hU extends Hs(fn){constructor({isHexOnly:e=!0,...t}={}){super(t),this.isHexOnly=e}}hU.NAME="PrimitiveValueBlock";var fU;class wp extends Ar{constructor(e={}){super(e,hU),this.idBlock.isConstructed=!1}}fU=wp,me.Primitive=fU,wp.NAME="PRIMITIVE";function m5e(r,e){if(r instanceof e)return r;const t=new e;return t.idBlock=r.idBlock,t.lenBlock=r.lenBlock,t.warnings=r.warnings,t.valueBeforeDecodeView=r.valueBeforeDecodeView,t}function uh(r,e=0,t=r.length){const n=e;let i=new Ar({},fn);const s=new Zl;if(!Ko(s,r,e,t))return i.error=s.error,{offset:-1,result:i};if(!r.subarray(e,e+t).length)return i.error="Zero buffer length",{offset:-1,result:i};let a=i.idBlock.fromBER(r,e,t);if(i.idBlock.warnings.length&&i.warnings.concat(i.idBlock.warnings),a===-1)return i.error=i.idBlock.error,{offset:-1,result:i};if(e=a,t-=i.idBlock.blockLength,a=i.lenBlock.fromBER(r,e,t),i.lenBlock.warnings.length&&i.warnings.concat(i.lenBlock.warnings),a===-1)return i.error=i.lenBlock.error,{offset:-1,result:i};if(e=a,t-=i.lenBlock.blockLength,!i.idBlock.isConstructed&&i.lenBlock.isIndefiniteForm)return i.error="Indefinite length form used for primitive encoding form",{offset:-1,result:i};let c=Ar;switch(i.idBlock.tagClass){case 1:if(i.idBlock.tagNumber>=37&&i.idBlock.isHexOnly===!1)return i.error="UNIVERSAL 37 and upper tags are reserved by ASN.1 standard",{offset:-1,result:i};switch(i.idBlock.tagNumber){case 0:if(i.idBlock.isConstructed&&i.lenBlock.length>0)return i.error="Type [UNIVERSAL 0] is reserved",{offset:-1,result:i};c=me.EndOfContent;break;case 1:c=me.Boolean;break;case 2:c=me.Integer;break;case 3:c=me.BitString;break;case 4:c=me.OctetString;break;case 5:c=me.Null;break;case 6:c=me.ObjectIdentifier;break;case 10:c=me.Enumerated;break;case 12:c=me.Utf8String;break;case 13:c=me.RelativeObjectIdentifier;break;case 14:c=me.TIME;break;case 15:return i.error="[UNIVERSAL 15] is reserved by ASN.1 standard",{offset:-1,result:i};case 16:c=me.Sequence;break;case 17:c=me.Set;break;case 18:c=me.NumericString;break;case 19:c=me.PrintableString;break;case 20:c=me.TeletexString;break;case 21:c=me.VideotexString;break;case 22:c=me.IA5String;break;case 23:c=me.UTCTime;break;case 24:c=me.GeneralizedTime;break;case 25:c=me.GraphicString;break;case 26:c=me.VisibleString;break;case 27:c=me.GeneralString;break;case 28:c=me.UniversalString;break;case 29:c=me.CharacterString;break;case 30:c=me.BmpString;break;case 31:c=me.DATE;break;case 32:c=me.TimeOfDay;break;case 33:c=me.DateTime;break;case 34:c=me.Duration;break;default:{const l=i.idBlock.isConstructed?new me.Constructed:new me.Primitive;l.idBlock=i.idBlock,l.lenBlock=i.lenBlock,l.warnings=i.warnings,i=l}}break;case 2:case 3:case 4:default:c=i.idBlock.isConstructed?me.Constructed:me.Primitive}return i=m5e(i,c),a=i.fromBER(r,e,i.lenBlock.isIndefiniteForm?t:i.lenBlock.length),i.valueBeforeDecodeView=r.subarray(n,n+i.blockLength),{offset:a,result:i}}function jo(r){if(!r.byteLength){const e=new Ar({},fn);return e.error="Input buffer has zero length",{offset:-1,result:e}}return uh(ue.toUint8Array(r).slice(),0,r.byteLength)}function w5e(r,e){return r?1:e}class _c extends fn{constructor({value:e=[],isIndefiniteForm:t=!1,...n}={}){super(n),this.value=e,this.isIndefiniteForm=t}fromBER(e,t,n){const i=ue.toUint8Array(e);if(!Ko(this,i,t,n))return-1;if(this.valueBeforeDecodeView=i.subarray(t,t+n),this.valueBeforeDecodeView.length===0)return this.warnings.push("Zero buffer length"),t;let s=t;for(;w5e(this.isIndefiniteForm,n)>0;){const o=uh(i,s,n);if(o.offset===-1)return this.error=o.result.error,this.warnings.concat(o.result.warnings),-1;if(s=o.offset,this.blockLength+=o.result.blockLength,n-=o.result.blockLength,this.value.push(o.result),this.isIndefiniteForm&&o.result.constructor.NAME===mp)break}return this.isIndefiniteForm&&(this.value[this.value.length-1].constructor.NAME===mp?this.value.pop():this.warnings.push("No EndOfContent block encoded")),s}toBER(e,t){const n=t||new M3;for(let i=0;i<this.value.length;i++)this.value[i].toBER(e,n);return t?ls:n.final()}toJSON(){const e={...super.toJSON(),isIndefiniteForm:this.isIndefiniteForm,value:[]};for(const t of this.value)e.value.push(t.toJSON());return e}}_c.NAME="ConstructedValueBlock";var pU;class Tn extends Ar{constructor(e={}){super(e,_c),this.idBlock.isConstructed=!0}fromBER(e,t,n){this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm;const i=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?n:this.lenBlock.length);return i===-1?(this.error=this.valueBlock.error,i):(this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),i)}onAsciiEncoding(){const e=[];for(const n of this.valueBlock.value)e.push(n.toString("ascii").split(`
`).map(i=>`  ${i}`).join(`
`));const t=this.idBlock.tagClass===3?`[${this.idBlock.tagNumber}]`:this.constructor.NAME;return e.length?`${t} :
${e.join(`
`)}`:`${t} :`}}pU=Tn,me.Constructed=pU,Tn.NAME="CONSTRUCTED";class gU extends fn{fromBER(e,t,n){return t}toBER(e){return ls}}gU.override="EndOfContentValueBlock";var yU;class xE extends Ar{constructor(e={}){super(e,gU),this.idBlock.tagClass=1,this.idBlock.tagNumber=0}}yU=xE,me.EndOfContent=yU,xE.NAME=mp;var mU;class Ho extends Ar{constructor(e={}){super(e,fn),this.idBlock.tagClass=1,this.idBlock.tagNumber=5}fromBER(e,t,n){return this.lenBlock.length>0&&this.warnings.push("Non-zero length of value block for Null type"),this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.blockLength+=n,t+n>e.byteLength?(this.error="End of input reached before message was fully decoded (inconsistent offset and length values)",-1):t+n}toBER(e,t){const n=new ArrayBuffer(2);if(!e){const i=new Uint8Array(n);i[0]=5,i[1]=0}return t&&t.write(n),n}onAsciiEncoding(){return`${this.constructor.NAME}`}}mU=Ho,me.Null=mU,Ho.NAME="NULL";class wU extends Hs(fn){get value(){for(const e of this.valueHexView)if(e>0)return!0;return!1}set value(e){this.valueHexView[0]=e?255:0}constructor({value:e,...t}={}){super(t),t.valueHex?this.valueHexView=ue.toUint8Array(t.valueHex):this.valueHexView=new Uint8Array(1),e&&(this.value=e)}fromBER(e,t,n){const i=ue.toUint8Array(e);return Ko(this,i,t,n)?(this.valueHexView=i.subarray(t,t+n),n>1&&this.warnings.push("Boolean value encoded in more then 1 octet"),this.isHexOnly=!0,iU.call(this),this.blockLength=n,t+n):-1}toBER(){return this.valueHexView.slice()}toJSON(){return{...super.toJSON(),value:this.value}}}wU.NAME="BooleanValueBlock";var bU;let R3=class extends Ar{getValue(){return this.valueBlock.value}setValue(e){this.valueBlock.value=e}constructor(e={}){super(e,wU),this.idBlock.tagClass=1,this.idBlock.tagNumber=1}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.getValue}`}};bU=R3,me.Boolean=bU,R3.NAME="BOOLEAN";class vU extends Hs(_c){constructor({isConstructed:e=!1,...t}={}){super(t),this.isConstructed=e}fromBER(e,t,n){let i=0;if(this.isConstructed){if(this.isHexOnly=!1,i=_c.prototype.fromBER.call(this,e,t,n),i===-1)return i;for(let s=0;s<this.value.length;s++){const o=this.value[s].constructor.NAME;if(o===mp){if(this.isIndefiniteForm)break;return this.error="EndOfContent is unexpected, OCTET STRING may consists of OCTET STRINGs only",-1}if(o!==aU)return this.error="OCTET STRING may consists of OCTET STRINGs only",-1}}else this.isHexOnly=!0,i=super.fromBER(e,t,n),this.blockLength=n;return i}toBER(e,t){return this.isConstructed?_c.prototype.toBER.call(this,e,t):e?new ArrayBuffer(this.valueHexView.byteLength):this.valueHexView.slice().buffer}toJSON(){return{...super.toJSON(),isConstructed:this.isConstructed}}}vU.NAME="OctetStringValueBlock";var AE;let us=class extends Ar{constructor({idBlock:e={},lenBlock:t={},...n}={}){var i,s;(i=n.isConstructed)!==null&&i!==void 0||(n.isConstructed=!!(!((s=n.value)===null||s===void 0)&&s.length)),super({idBlock:{isConstructed:n.isConstructed,...e},lenBlock:{...t,isIndefiniteForm:!!n.isIndefiniteForm},...n},vU),this.idBlock.tagClass=1,this.idBlock.tagNumber=4}fromBER(e,t,n){if(this.valueBlock.isConstructed=this.idBlock.isConstructed,this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm,n===0)return this.idBlock.error.length===0&&(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length===0&&(this.blockLength+=this.lenBlock.blockLength),t;if(!this.valueBlock.isConstructed){const s=(e instanceof ArrayBuffer?new Uint8Array(e):e).subarray(t,t+n);try{if(s.byteLength){const o=uh(s,0,s.byteLength);o.offset!==-1&&o.offset===n&&(this.valueBlock.value=[o.result])}}catch{}}return super.fromBER(e,t,n)}onAsciiEncoding(){if(this.valueBlock.isConstructed||this.valueBlock.value&&this.valueBlock.value.length)return Tn.prototype.onAsciiEncoding.call(this);const e=this.constructor.NAME,t=Ee.ToHex(this.valueBlock.valueHexView);return`${e} : ${t}`}getValue(){if(!this.idBlock.isConstructed)return this.valueBlock.valueHexView.slice().buffer;const e=[];for(const t of this.valueBlock.value)t instanceof AE&&e.push(t.valueBlock.valueHexView);return ue.concat(e)}};AE=us,me.OctetString=AE,us.NAME=aU;class EU extends Hs(_c){constructor({unusedBits:e=0,isConstructed:t=!1,...n}={}){super(n),this.unusedBits=e,this.isConstructed=t,this.blockLength=this.valueHexView.byteLength}fromBER(e,t,n){if(!n)return t;let i=-1;if(this.isConstructed){if(i=_c.prototype.fromBER.call(this,e,t,n),i===-1)return i;for(const a of this.value){const c=a.constructor.NAME;if(c===mp){if(this.isIndefiniteForm)break;return this.error="EndOfContent is unexpected, BIT STRING may consists of BIT STRINGs only",-1}if(c!==cU)return this.error="BIT STRING may consists of BIT STRINGs only",-1;const l=a.valueBlock;if(this.unusedBits>0&&l.unusedBits>0)return this.error='Using of "unused bits" inside constructive BIT STRING allowed for least one only',-1;this.unusedBits=l.unusedBits}return i}const s=ue.toUint8Array(e);if(!Ko(this,s,t,n))return-1;const o=s.subarray(t,t+n);if(this.unusedBits=o[0],this.unusedBits>7)return this.error="Unused bits for BitString must be in range 0-7",-1;if(!this.unusedBits){const a=o.subarray(1);try{if(a.byteLength){const c=uh(a,0,a.byteLength);c.offset!==-1&&c.offset===n-1&&(this.value=[c.result])}}catch{}}return this.valueHexView=o.subarray(1),this.blockLength=o.length,t+n}toBER(e,t){if(this.isConstructed)return _c.prototype.toBER.call(this,e,t);if(e)return new ArrayBuffer(this.valueHexView.byteLength+1);if(!this.valueHexView.byteLength)return ls;const n=new Uint8Array(this.valueHexView.length+1);return n[0]=this.unusedBits,n.set(this.valueHexView,1),n.buffer}toJSON(){return{...super.toJSON(),unusedBits:this.unusedBits,isConstructed:this.isConstructed}}}EU.NAME="BitStringValueBlock";var SU;let eu=class extends Ar{constructor({idBlock:e={},lenBlock:t={},...n}={}){var i,s;(i=n.isConstructed)!==null&&i!==void 0||(n.isConstructed=!!(!((s=n.value)===null||s===void 0)&&s.length)),super({idBlock:{isConstructed:n.isConstructed,...e},lenBlock:{...t,isIndefiniteForm:!!n.isIndefiniteForm},...n},EU),this.idBlock.tagClass=1,this.idBlock.tagNumber=3}fromBER(e,t,n){return this.valueBlock.isConstructed=this.idBlock.isConstructed,this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm,super.fromBER(e,t,n)}onAsciiEncoding(){if(this.valueBlock.isConstructed||this.valueBlock.value&&this.valueBlock.value.length)return Tn.prototype.onAsciiEncoding.call(this);{const e=[],t=this.valueBlock.valueHexView;for(const o of t)e.push(o.toString(2).padStart(8,"0"));const n=e.join(""),i=this.constructor.NAME,s=n.substring(0,n.length-this.valueBlock.unusedBits);return`${i} : ${s}`}}};SU=eu,me.BitString=SU,eu.NAME=cU;var xU;function b5e(r,e){const t=new Uint8Array([0]),n=new Uint8Array(r),i=new Uint8Array(e);let s=n.slice(0);const o=s.length-1,a=i.slice(0),c=a.length-1;let l=0;const d=c<o?o:c;let h=0;for(let p=d;p>=0;p--,h++){switch(!0){case h<a.length:l=s[o-h]+a[c-h]+t[0];break;default:l=s[o-h]+t[0]}switch(t[0]=l/10,!0){case h>=s.length:s=bE(new Uint8Array([l%10]),s);break;default:s[o-h]=l%10}}return t[0]>0&&(s=bE(t,s)),s}function AU(r){if(r>=yp.length)for(let e=yp.length;e<=r;e++){const t=new Uint8Array([0]);let n=yp[e-1].slice(0);for(let i=n.length-1;i>=0;i--){const s=new Uint8Array([(n[i]<<1)+t[0]]);t[0]=s[0]/10,n[i]=s[0]%10}t[0]>0&&(n=bE(t,n)),yp.push(n)}return yp[r]}function v5e(r,e){let t=0;const n=new Uint8Array(r),i=new Uint8Array(e),s=n.slice(0),o=s.length-1,a=i.slice(0),c=a.length-1;let l,d=0;for(let h=c;h>=0;h--,d++)switch(l=s[o-d]-a[c-d]-t,!0){case l<0:t=1,s[o-d]=l+10;break;default:t=0,s[o-d]=l}if(t>0)for(let h=o-c+1;h>=0;h--,d++)if(l=s[o-d]-t,l<0)t=1,s[o-d]=l+10;else{t=0,s[o-d]=l;break}return s.slice()}class CE extends Hs(fn){setValueHex(){this.valueHexView.length>=4?(this.warnings.push("Too big Integer for decoding, hex only"),this.isHexOnly=!0,this._valueDec=0):(this.isHexOnly=!1,this.valueHexView.length>0&&(this._valueDec=iU.call(this)))}constructor({value:e,...t}={}){super(t),this._valueDec=0,t.valueHex&&this.setValueHex(),e!==void 0&&(this.valueDec=e)}set valueDec(e){this._valueDec=e,this.isHexOnly=!1,this.valueHexView=new Uint8Array(a5e(e))}get valueDec(){return this._valueDec}fromDER(e,t,n,i=0){const s=this.fromBER(e,t,n);if(s===-1)return s;const o=this.valueHexView;return o[0]===0&&o[1]&128?this.valueHexView=o.subarray(1):i!==0&&o.length<i&&(i-o.length>1&&(i=o.length+1),this.valueHexView=o.subarray(i-o.length)),s}toDER(e=!1){const t=this.valueHexView;switch(!0){case(t[0]&128)!==0:{const n=new Uint8Array(this.valueHexView.length+1);n[0]=0,n.set(t,1),this.valueHexView=n}break;case(t[0]===0&&(t[1]&128)===0):this.valueHexView=this.valueHexView.subarray(1);break}return this.toBER(e)}fromBER(e,t,n){const i=super.fromBER(e,t,n);return i===-1||this.setValueHex(),i}toBER(e){return e?new ArrayBuffer(this.valueHexView.length):this.valueHexView.slice().buffer}toJSON(){return{...super.toJSON(),valueDec:this.valueDec}}toString(){const e=this.valueHexView.length*8-1;let t=new Uint8Array(this.valueHexView.length*8/3),n=0,i;const s=this.valueHexView;let o="",a=!1;for(let c=s.byteLength-1;c>=0;c--){i=s[c];for(let l=0;l<8;l++){if((i&1)===1)switch(n){case e:t=v5e(AU(n),t),o="-";break;default:t=b5e(t,AU(n))}n++,i>>=1}}for(let c=0;c<t.length;c++)t[c]&&(a=!0),a&&(o+=sU.charAt(t[c]));return a===!1&&(o+=sU.charAt(0)),o}}xU=CE,CE.NAME="IntegerValueBlock",Object.defineProperty(xU.prototype,"valueHex",{set:function(r){this.valueHexView=new Uint8Array(r),this.setValueHex()},get:function(){return this.valueHexView.slice().buffer}});var bp;class qo extends Ar{constructor(e={}){super(e,CE),this.idBlock.tagClass=1,this.idBlock.tagNumber=2}toBigInt(){return N3(),BigInt(this.valueBlock.toString())}static fromBigInt(e){N3();const t=BigInt(e),n=new M3,i=t.toString(16).replace(/^-/,""),s=new Uint8Array(Ee.FromHex(i));if(t<0){const a=new Uint8Array(s.length+(s[0]&128?1:0));a[0]|=128;const l=BigInt(`0x${Ee.ToHex(a)}`)+t,d=ue.toUint8Array(Ee.FromHex(l.toString(16)));d[0]|=128,n.write(d)}else s[0]&128&&n.write(new Uint8Array([0])),n.write(s);return new bp({valueHex:n.final()})}convertToDER(){const e=new bp({valueHex:this.valueBlock.valueHexView});return e.valueBlock.toDER(),e}convertFromDER(){return new bp({valueHex:this.valueBlock.valueHexView[0]===0?this.valueBlock.valueHexView.subarray(1):this.valueBlock.valueHexView})}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()}`}}bp=qo,me.Integer=bp,qo.NAME="INTEGER";var CU;class L3 extends qo{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=10}}CU=L3,me.Enumerated=CU,L3.NAME="ENUMERATED";class IE extends Hs(fn){constructor({valueDec:e=-1,isFirstSid:t=!1,...n}={}){super(n),this.valueDec=e,this.isFirstSid=t}fromBER(e,t,n){if(!n)return t;const i=ue.toUint8Array(e);if(!Ko(this,i,t,n))return-1;const s=i.subarray(t,t+n);this.valueHexView=new Uint8Array(n);for(let a=0;a<n&&(this.valueHexView[a]=s[a]&127,this.blockLength++,!!(s[a]&128));a++);const o=new Uint8Array(this.blockLength);for(let a=0;a<this.blockLength;a++)o[a]=this.valueHexView[a];return this.valueHexView=o,s[this.blockLength-1]&128?(this.error="End of input reached before message was fully decoded",-1):(this.valueHexView[0]===0&&this.warnings.push("Needlessly long format of SID encoding"),this.blockLength<=8?this.valueDec=lh(this.valueHexView,7):(this.isHexOnly=!0,this.warnings.push("Too big SID for decoding, hex only")),t+this.blockLength)}set valueBigInt(e){N3();let t=BigInt(e).toString(2);for(;t.length%7;)t="0"+t;const n=new Uint8Array(t.length/7);for(let i=0;i<n.length;i++)n[i]=parseInt(t.slice(i*7,i*7+7),2)+(i+1<n.length?128:0);this.fromBER(n.buffer,0,n.length)}toBER(e){if(this.isHexOnly){if(e)return new ArrayBuffer(this.valueHexView.byteLength);const i=this.valueHexView,s=new Uint8Array(this.blockLength);for(let o=0;o<this.blockLength-1;o++)s[o]=i[o]|128;return s[this.blockLength-1]=i[this.blockLength-1],s.buffer}const t=Xl(this.valueDec,7);if(t.byteLength===0)return this.error="Error during encoding SID value",ls;const n=new Uint8Array(t.byteLength);if(!e){const i=new Uint8Array(t),s=t.byteLength-1;for(let o=0;o<s;o++)n[o]=i[o]|128;n[s]=i[s]}return n}toString(){let e="";if(this.isHexOnly)e=Ee.ToHex(this.valueHexView);else if(this.isFirstSid){let t=this.valueDec;this.valueDec<=39?e="0.":this.valueDec<=79?(e="1.",t-=40):(e="2.",t-=80),e+=t.toString()}else e=this.valueDec.toString();return e}toJSON(){return{...super.toJSON(),valueDec:this.valueDec,isFirstSid:this.isFirstSid}}}IE.NAME="sidBlock";class IU extends fn{constructor({value:e=_n,...t}={}){super(t),this.value=[],e&&this.fromString(e)}fromBER(e,t,n){let i=t;for(;n>0;){const s=new IE;if(i=s.fromBER(e,i,n),i===-1)return this.blockLength=0,this.error=s.error,i;this.value.length===0&&(s.isFirstSid=!0),this.blockLength+=s.blockLength,n-=s.blockLength,this.value.push(s)}return i}toBER(e){const t=[];for(let n=0;n<this.value.length;n++){const i=this.value[n].toBER(e);if(i.byteLength===0)return this.error=this.value[n].error,ls;t.push(i)}return vE(t)}fromString(e){this.value=[];let t=0,n=0,i="",s=!1;do if(n=e.indexOf(".",t),n===-1?i=e.substring(t):i=e.substring(t,n),t=n+1,s){const o=this.value[0];let a=0;switch(o.valueDec){case 0:break;case 1:a=40;break;case 2:a=80;break;default:this.value=[];return}const c=parseInt(i,10);if(isNaN(c))return;o.valueDec=c+a,s=!1}else{const o=new IE;if(i>Number.MAX_SAFE_INTEGER){N3();const a=BigInt(i);o.valueBigInt=a}else if(o.valueDec=parseInt(i,10),isNaN(o.valueDec))return;this.value.length||(o.isFirstSid=!0,s=!0),this.value.push(o)}while(n!==-1)}toString(){let e="",t=!1;for(let n=0;n<this.value.length;n++){t=this.value[n].isHexOnly;let i=this.value[n].toString();n!==0&&(e=`${e}.`),t?(i=`{${i}}`,this.value[n].isFirstSid?e=`2.{${i} - 80}`:e+=i):e+=i}return e}toJSON(){const e={...super.toJSON(),value:this.toString(),sidArray:[]};for(let t=0;t<this.value.length;t++)e.sidArray.push(this.value[t].toJSON());return e}}IU.NAME="ObjectIdentifierValueBlock";var kU;class Wo extends Ar{getValue(){return this.valueBlock.toString()}setValue(e){this.valueBlock.fromString(e)}constructor(e={}){super(e,IU),this.idBlock.tagClass=1,this.idBlock.tagNumber=6}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()||"empty"}`}toJSON(){return{...super.toJSON(),value:this.getValue()}}}kU=Wo,me.ObjectIdentifier=kU,Wo.NAME="OBJECT IDENTIFIER";class kE extends Hs(Zl){constructor({valueDec:e=0,...t}={}){super(t),this.valueDec=e}fromBER(e,t,n){if(n===0)return t;const i=ue.toUint8Array(e);if(!Ko(this,i,t,n))return-1;const s=i.subarray(t,t+n);this.valueHexView=new Uint8Array(n);for(let a=0;a<n&&(this.valueHexView[a]=s[a]&127,this.blockLength++,!!(s[a]&128));a++);const o=new Uint8Array(this.blockLength);for(let a=0;a<this.blockLength;a++)o[a]=this.valueHexView[a];return this.valueHexView=o,s[this.blockLength-1]&128?(this.error="End of input reached before message was fully decoded",-1):(this.valueHexView[0]===0&&this.warnings.push("Needlessly long format of SID encoding"),this.blockLength<=8?this.valueDec=lh(this.valueHexView,7):(this.isHexOnly=!0,this.warnings.push("Too big SID for decoding, hex only")),t+this.blockLength)}toBER(e){if(this.isHexOnly){if(e)return new ArrayBuffer(this.valueHexView.byteLength);const i=this.valueHexView,s=new Uint8Array(this.blockLength);for(let o=0;o<this.blockLength-1;o++)s[o]=i[o]|128;return s[this.blockLength-1]=i[this.blockLength-1],s.buffer}const t=Xl(this.valueDec,7);if(t.byteLength===0)return this.error="Error during encoding SID value",ls;const n=new Uint8Array(t.byteLength);if(!e){const i=new Uint8Array(t),s=t.byteLength-1;for(let o=0;o<s;o++)n[o]=i[o]|128;n[s]=i[s]}return n.buffer}toString(){let e="";return this.isHexOnly?e=Ee.ToHex(this.valueHexView):e=this.valueDec.toString(),e}toJSON(){return{...super.toJSON(),valueDec:this.valueDec}}}kE.NAME="relativeSidBlock";class _U extends fn{constructor({value:e=_n,...t}={}){super(t),this.value=[],e&&this.fromString(e)}fromBER(e,t,n){let i=t;for(;n>0;){const s=new kE;if(i=s.fromBER(e,i,n),i===-1)return this.blockLength=0,this.error=s.error,i;this.blockLength+=s.blockLength,n-=s.blockLength,this.value.push(s)}return i}toBER(e,t){const n=[];for(let i=0;i<this.value.length;i++){const s=this.value[i].toBER(e);if(s.byteLength===0)return this.error=this.value[i].error,ls;n.push(s)}return vE(n)}fromString(e){this.value=[];let t=0,n=0,i="";do{n=e.indexOf(".",t),n===-1?i=e.substring(t):i=e.substring(t,n),t=n+1;const s=new kE;if(s.valueDec=parseInt(i,10),isNaN(s.valueDec))return!0;this.value.push(s)}while(n!==-1);return!0}toString(){let e="",t=!1;for(let n=0;n<this.value.length;n++){t=this.value[n].isHexOnly;let i=this.value[n].toString();n!==0&&(e=`${e}.`),t&&(i=`{${i}}`),e+=i}return e}toJSON(){const e={...super.toJSON(),value:this.toString(),sidArray:[]};for(let t=0;t<this.value.length;t++)e.sidArray.push(this.value[t].toJSON());return e}}_U.NAME="RelativeObjectIdentifierValueBlock";var TU;class _E extends Ar{getValue(){return this.valueBlock.toString()}setValue(e){this.valueBlock.fromString(e)}constructor(e={}){super(e,_U),this.idBlock.tagClass=1,this.idBlock.tagNumber=13}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()||"empty"}`}toJSON(){return{...super.toJSON(),value:this.getValue()}}}TU=_E,me.RelativeObjectIdentifier=TU,_E.NAME="RelativeObjectIdentifier";var PU;class gr extends Tn{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=16}}PU=gr,me.Sequence=PU,gr.NAME="SEQUENCE";var DU;let Go=class extends Tn{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=17}};DU=Go,me.Set=DU,Go.NAME="SET";class $U extends Hs(fn){constructor({...e}={}){super(e),this.isHexOnly=!0,this.value=_n}toJSON(){return{...super.toJSON(),value:this.value}}}$U.NAME="StringValueBlock";class NU extends $U{}NU.NAME="SimpleStringValueBlock";class ui extends SE{constructor({...e}={}){super(e,NU)}fromBuffer(e){this.valueBlock.value=String.fromCharCode.apply(null,ue.toUint8Array(e))}fromString(e){const t=e.length,n=this.valueBlock.valueHexView=new Uint8Array(t);for(let i=0;i<t;i++)n[i]=e.charCodeAt(i);this.valueBlock.value=e}}ui.NAME="SIMPLE STRING";class MU extends ui{fromBuffer(e){this.valueBlock.valueHexView=ue.toUint8Array(e);try{this.valueBlock.value=Ee.ToUtf8String(e)}catch(t){this.warnings.push(`Error during "decodeURIComponent": ${t}, using raw string`),this.valueBlock.value=Ee.ToBinary(e)}}fromString(e){this.valueBlock.valueHexView=new Uint8Array(Ee.FromUtf8String(e)),this.valueBlock.value=e}}MU.NAME="Utf8StringValueBlock";var OU;class Qo extends MU{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=12}}OU=Qo,me.Utf8String=OU,Qo.NAME="UTF8String";class RU extends ui{fromBuffer(e){this.valueBlock.value=Ee.ToUtf16String(e),this.valueBlock.valueHexView=ue.toUint8Array(e)}fromString(e){this.valueBlock.value=e,this.valueBlock.valueHexView=new Uint8Array(Ee.FromUtf16String(e))}}RU.NAME="BmpStringValueBlock";var LU;class B3 extends RU{constructor({...e}={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=30}}LU=B3,me.BmpString=LU,B3.NAME="BMPString";class BU extends ui{fromBuffer(e){const t=ArrayBuffer.isView(e)?e.slice().buffer:e.slice(0),n=new Uint8Array(t);for(let i=0;i<n.length;i+=4)n[i]=n[i+3],n[i+1]=n[i+2],n[i+2]=0,n[i+3]=0;this.valueBlock.value=String.fromCharCode.apply(null,new Uint32Array(t))}fromString(e){const t=e.length,n=this.valueBlock.valueHexView=new Uint8Array(t*4);for(let i=0;i<t;i++){const s=Xl(e.charCodeAt(i),8),o=new Uint8Array(s);if(o.length>4)continue;const a=4-o.length;for(let c=o.length-1;c>=0;c--)n[i*4+c+a]=o[c]}this.valueBlock.value=e}}BU.NAME="UniversalStringValueBlock";var UU;class U3 extends BU{constructor({...e}={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=28}}UU=U3,me.UniversalString=UU,U3.NAME="UniversalString";var FU;class F3 extends ui{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=18}}FU=F3,me.NumericString=FU,F3.NAME="NumericString";var zU;class z3 extends ui{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=19}}zU=z3,me.PrintableString=zU,z3.NAME="PrintableString";var VU;class V3 extends ui{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=20}}VU=V3,me.TeletexString=VU,V3.NAME="TeletexString";var KU;class K3 extends ui{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=21}}KU=K3,me.VideotexString=KU,K3.NAME="VideotexString";var jU;class j3 extends ui{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=22}}jU=j3,me.IA5String=jU,j3.NAME="IA5String";var HU;class H3 extends ui{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=25}}HU=H3,me.GraphicString=HU,H3.NAME="GraphicString";var qU;class vp extends ui{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=26}}qU=vp,me.VisibleString=qU,vp.NAME="VisibleString";var WU;class q3 extends ui{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=27}}WU=q3,me.GeneralString=WU,q3.NAME="GeneralString";var GU;class W3 extends ui{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=29}}GU=W3,me.CharacterString=GU,W3.NAME="CharacterString";var QU;class Ep extends vp{constructor({value:e,valueDate:t,...n}={}){if(super(n),this.year=0,this.month=0,this.day=0,this.hour=0,this.minute=0,this.second=0,e){this.fromString(e),this.valueBlock.valueHexView=new Uint8Array(e.length);for(let i=0;i<e.length;i++)this.valueBlock.valueHexView[i]=e.charCodeAt(i)}t&&(this.fromDate(t),this.valueBlock.valueHexView=new Uint8Array(this.toBuffer())),this.idBlock.tagClass=1,this.idBlock.tagNumber=23}fromBuffer(e){this.fromString(String.fromCharCode.apply(null,ue.toUint8Array(e)))}toBuffer(){const e=this.toString(),t=new ArrayBuffer(e.length),n=new Uint8Array(t);for(let i=0;i<e.length;i++)n[i]=e.charCodeAt(i);return t}fromDate(e){this.year=e.getUTCFullYear(),this.month=e.getUTCMonth()+1,this.day=e.getUTCDate(),this.hour=e.getUTCHours(),this.minute=e.getUTCMinutes(),this.second=e.getUTCSeconds()}toDate(){return new Date(Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second))}fromString(e){const n=/(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})Z/ig.exec(e);if(n===null){this.error="Wrong input string for conversion";return}const i=parseInt(n[1],10);i>=50?this.year=1900+i:this.year=2e3+i,this.month=parseInt(n[2],10),this.day=parseInt(n[3],10),this.hour=parseInt(n[4],10),this.minute=parseInt(n[5],10),this.second=parseInt(n[6],10)}toString(e="iso"){if(e==="iso"){const t=new Array(7);return t[0]=li(this.year<2e3?this.year-1900:this.year-2e3,2),t[1]=li(this.month,2),t[2]=li(this.day,2),t[3]=li(this.hour,2),t[4]=li(this.minute,2),t[5]=li(this.second,2),t[6]="Z",t.join("")}return super.toString(e)}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.toDate().toISOString()}`}toJSON(){return{...super.toJSON(),year:this.year,month:this.month,day:this.day,hour:this.hour,minute:this.minute,second:this.second}}}QU=Ep,me.UTCTime=QU,Ep.NAME="UTCTime";var YU;class G3 extends Ep{constructor(e={}){var t;super(e),(t=this.millisecond)!==null&&t!==void 0||(this.millisecond=0),this.idBlock.tagClass=1,this.idBlock.tagNumber=24}fromDate(e){super.fromDate(e),this.millisecond=e.getUTCMilliseconds()}toDate(){const e=Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second,this.millisecond);return new Date(e)}fromString(e){let t=!1,n="",i="",s=0,o,a=0,c=0;if(e[e.length-1]==="Z")n=e.substring(0,e.length-1),t=!0;else{const h=new Number(e[e.length-1]);if(isNaN(h.valueOf()))throw new Error("Wrong input string for conversion");n=e}if(t){if(n.indexOf("+")!==-1)throw new Error("Wrong input string for conversion");if(n.indexOf("-")!==-1)throw new Error("Wrong input string for conversion")}else{let h=1,p=n.indexOf("+"),m="";if(p===-1&&(p=n.indexOf("-"),h=-1),p!==-1){if(m=n.substring(p+1),n=n.substring(0,p),m.length!==2&&m.length!==4)throw new Error("Wrong input string for conversion");let f=parseInt(m.substring(0,2),10);if(isNaN(f.valueOf()))throw new Error("Wrong input string for conversion");if(a=h*f,m.length===4){if(f=parseInt(m.substring(2,4),10),isNaN(f.valueOf()))throw new Error("Wrong input string for conversion");c=h*f}}}let l=n.indexOf(".");if(l===-1&&(l=n.indexOf(",")),l!==-1){const h=new Number(`0${n.substring(l)}`);if(isNaN(h.valueOf()))throw new Error("Wrong input string for conversion");s=h.valueOf(),i=n.substring(0,l)}else i=n;switch(!0){case i.length===8:if(o=/(\d{4})(\d{2})(\d{2})/ig,l!==-1)throw new Error("Wrong input string for conversion");break;case i.length===10:if(o=/(\d{4})(\d{2})(\d{2})(\d{2})/ig,l!==-1){let h=60*s;this.minute=Math.floor(h),h=60*(h-this.minute),this.second=Math.floor(h),h=1e3*(h-this.second),this.millisecond=Math.floor(h)}break;case i.length===12:if(o=/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})/ig,l!==-1){let h=60*s;this.second=Math.floor(h),h=1e3*(h-this.second),this.millisecond=Math.floor(h)}break;case i.length===14:if(o=/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})/ig,l!==-1){const h=1e3*s;this.millisecond=Math.floor(h)}break;default:throw new Error("Wrong input string for conversion")}const d=o.exec(i);if(d===null)throw new Error("Wrong input string for conversion");for(let h=1;h<d.length;h++)switch(h){case 1:this.year=parseInt(d[h],10);break;case 2:this.month=parseInt(d[h],10);break;case 3:this.day=parseInt(d[h],10);break;case 4:this.hour=parseInt(d[h],10)+a;break;case 5:this.minute=parseInt(d[h],10)+c;break;case 6:this.second=parseInt(d[h],10);break;default:throw new Error("Wrong input string for conversion")}if(t===!1){const h=new Date(this.year,this.month,this.day,this.hour,this.minute,this.second,this.millisecond);this.year=h.getUTCFullYear(),this.month=h.getUTCMonth(),this.day=h.getUTCDay(),this.hour=h.getUTCHours(),this.minute=h.getUTCMinutes(),this.second=h.getUTCSeconds(),this.millisecond=h.getUTCMilliseconds()}}toString(e="iso"){if(e==="iso"){const t=[];return t.push(li(this.year,4)),t.push(li(this.month,2)),t.push(li(this.day,2)),t.push(li(this.hour,2)),t.push(li(this.minute,2)),t.push(li(this.second,2)),this.millisecond!==0&&(t.push("."),t.push(li(this.millisecond,3))),t.push("Z"),t.join("")}return super.toString(e)}toJSON(){return{...super.toJSON(),millisecond:this.millisecond}}}YU=G3,me.GeneralizedTime=YU,G3.NAME="GeneralizedTime";var JU;class TE extends Qo{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=31}}JU=TE,me.DATE=JU,TE.NAME="DATE";var XU;class PE extends Qo{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=32}}XU=PE,me.TimeOfDay=XU,PE.NAME="TimeOfDay";var ZU;class DE extends Qo{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=33}}ZU=DE,me.DateTime=ZU,DE.NAME="DateTime";var eF;class $E extends Qo{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=34}}eF=$E,me.Duration=eF,$E.NAME="Duration";var tF;class NE extends Qo{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=14}}tF=NE,me.TIME=tF,NE.NAME="TIME";class tu{constructor({name:e=_n,optional:t=!1}={}){this.name=e,this.optional=t}}class ME extends tu{constructor({value:e=[],...t}={}){super(t),this.value=e}}class Q3 extends tu{constructor({value:e=new tu,local:t=!1,...n}={}){super(n),this.value=e,this.local=t}}class E5e{get data(){return this.dataView.slice().buffer}set data(e){this.dataView=ue.toUint8Array(e)}constructor({data:e=O3}={}){this.dataView=ue.toUint8Array(e)}fromBER(e,t,n){const i=t+n;return this.dataView=ue.toUint8Array(e).subarray(t,i),i}toBER(e){return this.dataView.slice().buffer}}function ru(r,e,t){if(t instanceof ME){for(const s of t.value)if(ru(r,e,s).verified)return{verified:!0,result:r};{const s={verified:!1,result:{error:"Wrong values for Choice type"}};return t.hasOwnProperty(EE)&&(s.name=t.name),s}}if(t instanceof tu)return t.hasOwnProperty(EE)&&(r[t.name]=e),{verified:!0,result:r};if(!(r instanceof Object))return{verified:!1,result:{error:"Wrong root object"}};if(!(e instanceof Object))return{verified:!1,result:{error:"Wrong ASN.1 data"}};if(!(t instanceof Object))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(!(u5e in t))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(!(p5e in t.idBlock))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(!(g5e in t.idBlock))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};const n=t.idBlock.toBER(!1);if(n.byteLength===0)return{verified:!1,result:{error:"Error encoding idBlock for ASN.1 schema"}};if(t.idBlock.fromBER(n,0,n.byteLength)===-1)return{verified:!1,result:{error:"Error decoding idBlock for ASN.1 schema"}};if(t.idBlock.hasOwnProperty(d5e)===!1)return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(t.idBlock.tagClass!==e.idBlock.tagClass)return{verified:!1,result:r};if(t.idBlock.hasOwnProperty(h5e)===!1)return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(t.idBlock.tagNumber!==e.idBlock.tagNumber)return{verified:!1,result:r};if(t.idBlock.hasOwnProperty(f5e)===!1)return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(t.idBlock.isConstructed!==e.idBlock.isConstructed)return{verified:!1,result:r};if(!(l5e in t.idBlock))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};if(t.idBlock.isHexOnly!==e.idBlock.isHexOnly)return{verified:!1,result:r};if(t.idBlock.isHexOnly){if(!(oU in t.idBlock))return{verified:!1,result:{error:"Wrong ASN.1 schema"}};const s=t.idBlock.valueHexView,o=e.idBlock.valueHexView;if(s.length!==o.length)return{verified:!1,result:r};for(let a=0;a<s.length;a++)if(s[a]!==o[1])return{verified:!1,result:r}}if(t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,_n),t.name&&(r[t.name]=e)),t instanceof me.Constructed){let s=0,o={verified:!1,result:{error:"Unknown error"}},a=t.valueBlock.value.length;if(a>0&&t.valueBlock.value[0]instanceof Q3&&(a=e.valueBlock.value.length),a===0)return{verified:!0,result:r};if(e.valueBlock.value.length===0&&t.valueBlock.value.length!==0){let c=!0;for(let l=0;l<t.valueBlock.value.length;l++)c=c&&(t.valueBlock.value[l].optional||!1);return c?{verified:!0,result:r}:(t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,_n),t.name&&delete r[t.name]),r.error="Inconsistent object length",{verified:!1,result:r})}for(let c=0;c<a;c++)if(c-s>=e.valueBlock.value.length){if(t.valueBlock.value[c].optional===!1){const l={verified:!1,result:r};return r.error="Inconsistent length between ASN.1 data and schema",t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,_n),t.name&&(delete r[t.name],l.name=t.name)),l}}else if(t.valueBlock.value[0]instanceof Q3){if(o=ru(r,e.valueBlock.value[c],t.valueBlock.value[0].value),o.verified===!1)if(t.valueBlock.value[0].optional)s++;else return t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,_n),t.name&&delete r[t.name]),o;if(EE in t.valueBlock.value[0]&&t.valueBlock.value[0].name.length>0){let l={};y5e in t.valueBlock.value[0]&&t.valueBlock.value[0].local?l=e:l=r,typeof l[t.valueBlock.value[0].name]>"u"&&(l[t.valueBlock.value[0].name]=[]),l[t.valueBlock.value[0].name].push(e.valueBlock.value[c])}}else if(o=ru(r,e.valueBlock.value[c-s],t.valueBlock.value[c]),o.verified===!1)if(t.valueBlock.value[c].optional)s++;else return t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,_n),t.name&&delete r[t.name]),o;if(o.verified===!1){const c={verified:!1,result:r};return t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,_n),t.name&&(delete r[t.name],c.name=t.name)),c}return{verified:!0,result:r}}if(t.primitiveSchema&&oU in e.valueBlock){const s=uh(e.valueBlock.valueHexView);if(s.offset===-1){const o={verified:!1,result:s.result};return t.name&&(t.name=t.name.replace(/^\s+|\s+$/g,_n),t.name&&(delete r[t.name],o.name=t.name)),o}return ru(r,s.result,t.primitiveSchema)}return{verified:!0,result:r}}function S5e(r,e){if(!(e instanceof Object))return{verified:!1,result:{error:"Wrong ASN.1 schema type"}};const t=uh(ue.toUint8Array(r));return t.offset===-1?{verified:!1,result:t.result}:ru(t.result,t.result,e)}const rF=Object.freeze(Object.defineProperty({__proto__:null,Any:tu,BaseBlock:Ar,BaseStringBlock:SE,BitString:eu,BmpString:B3,Boolean:R3,CharacterString:W3,Choice:ME,Constructed:Tn,DATE:TE,DateTime:DE,Duration:$E,EndOfContent:xE,Enumerated:L3,GeneralString:q3,GeneralizedTime:G3,GraphicString:H3,HexBlock:Hs,IA5String:j3,Integer:qo,Null:Ho,NumericString:F3,ObjectIdentifier:Wo,OctetString:us,Primitive:wp,PrintableString:z3,RawData:E5e,RelativeObjectIdentifier:_E,Repeated:Q3,Sequence:gr,Set:Go,TIME:NE,TeletexString:V3,TimeOfDay:PE,UTCTime:Ep,UniversalString:U3,Utf8String:Qo,ValueBlock:fn,VideotexString:K3,ViewWriter:M3,VisibleString:vp,compareSchema:ru,fromBER:jo,verifySchema:S5e},Symbol.toStringTag,{value:"Module"})),nF=$3({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6});$3({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),$3({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),$3({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});const x5e=16,OE=32,RE=1e4;async function Y3(r,e){const n=await tU().encrypt(r,e);return nF.encode(n)}async function iF(r,e,t){if(r.type==="RSA")return k5e(r,e,t);if(r.type==="Ed25519")return A5e(r,e,t);if(r.type==="secp256k1")return C5e(r,e,t);if(r.type==="ECDSA")return I5e(r,e,t);throw new kl}async function A5e(r,e,t="libp2p-key"){if(t==="libp2p-key")return Y3(T1(r),e);throw new Z(`export format '${t}' is not supported`)}async function C5e(r,e,t="libp2p-key"){if(t==="libp2p-key")return Y3(T1(r),e);throw new Z("Export format is not supported")}async function I5e(r,e,t="libp2p-key"){if(t==="libp2p-key")return Y3(T1(r),e);throw new Z(`export format '${t}' is not supported`)}async function k5e(r,e,t="pkcs-8"){if(t==="pkcs-8")return _5e(r,e);if(t==="libp2p-key")return Y3(T1(r),e);throw new Z("Export format is not supported")}async function _5e(r,e){const t=Rs.get(),i=new gr({value:[new qo({value:0}),new gr({value:[new Wo({value:"1.2.840.113549.1.1.1"}),new Ho]}),new us({valueHex:r.raw})]}).toBER(),s=new Uint8Array(i,0,i.byteLength),o=Za(x5e),a=await W$(jv,e,o,{c:RE,dkLen:OE}),c=Za(16),l=await t.subtle.importKey("raw",a,"AES-CBC",!1,["encrypt"]),d=await t.subtle.encrypt({name:"AES-CBC",iv:c},l,s),h=new gr({value:[new us({valueHex:o}),new qo({value:RE}),new qo({value:OE}),new gr({value:[new Wo({value:"1.2.840.113549.2.11"}),new Ho]})]}),p=new gr({value:[new Wo({value:"1.2.840.113549.1.5.13"}),new gr({value:[new gr({value:[new Wo({value:"1.2.840.113549.1.5.12"}),h]}),new gr({value:[new Wo({value:"2.16.840.1.101.3.4.1.42"}),new us({valueHex:c})]})]})]}),f=new gr({value:[p,new us({valueHex:d})]}).toBER(),g=new Uint8Array(f,0,f.byteLength);return["-----BEGIN ENCRYPTED PRIVATE KEY-----",...re(g,"base64pad").split(/(.{64})/).filter(Boolean),"-----END ENCRYPTED PRIVATE KEY-----"].join(`
`)}async function sF(r,e){try{const t=await T5e(r,e);return gie(t)}catch{}if(!r.includes("BEGIN"))throw new Z("Encrypted key was not a libp2p-key or a PEM file");return P5e(r,e)}async function T5e(r,e){const t=nF.decode(r);return tU().decrypt(t,e)}async function P5e(r,e){const t=Rs.get();let n;if(r.includes("-----BEGIN ENCRYPTED PRIVATE KEY-----")){const s=ie(r.replace("-----BEGIN ENCRYPTED PRIVATE KEY-----","").replace("-----END ENCRYPTED PRIVATE KEY-----","").replace(/\n/g,"").trim(),"base64pad"),{result:o}=jo(s),{iv:a,salt:c,iterations:l,keySize:d,cipherText:h}=D5e(o),p=await W$(jv,e,c,{c:l,dkLen:d}),m=await t.subtle.importKey("raw",p,"AES-CBC",!1,["decrypt"]),f=Sp(await t.subtle.decrypt({name:"AES-CBC",iv:a},m,h)),{result:g}=jo(f);n=oF(g)}else if(r.includes("-----BEGIN PRIVATE KEY-----")){const s=ie(r.replace("-----BEGIN PRIVATE KEY-----","").replace("-----END PRIVATE KEY-----","").replace(/\n/g,"").trim(),"base64pad"),{result:o}=jo(s);n=oF(o)}else throw new Z("Could not parse private key from PEM data");const i=xv(n);if(i.type!=="RSA")throw new Z("Could not parse RSA private key from PEM data");return i}function D5e(r){const e=r.valueBlock.value[0];if(e.valueBlock.value[0].toString()!=="OBJECT IDENTIFIER : 1.2.840.113549.1.5.13")throw new Z("Only pkcs5PBES2 encrypted private keys are supported");const n=e.valueBlock.value[1].valueBlock.value[0];if(n.valueBlock.value[0].toString()!=="OBJECT IDENTIFIER : 1.2.840.113549.1.5.12")throw new Z("Only pkcs5PBKDF2 key derivation functions are supported");const s=n.valueBlock.value[1],o=Sp(s.valueBlock.value[0].getValue());let a=RE,c=OE;if(s.valueBlock.value.length===3)a=Number(s.valueBlock.value[1].toBigInt()),c=Number(s.valueBlock.value[2].toBigInt());else if(s.valueBlock.value.length===2)throw new Z("Could not derive key size and iterations from PEM file - please use @libp2p/rsa to re-import your key");const l=e.valueBlock.value[1].valueBlock.value[1],d=l.valueBlock.value[0].toString();if(d!=="OBJECT IDENTIFIER : 1.2.840.113549.3.7"){if(d!=="OBJECT IDENTIFIER : 1.3.14.3.2.7"){if(d!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.2"){if(d!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.22"){if(d!=="OBJECT IDENTIFIER : 2.16.840.1.101.3.4.1.42")throw new Z("Only AES-CBC encryption schemes are supported")}}}}const h=Sp(l.valueBlock.value[1].getValue());return{cipherText:Sp(r.valueBlock.value[1].getValue()),salt:o,iterations:a,keySize:c,iv:h}}function oF(r){return Sp(r.valueBlock.value[2].getValue())}function Sp(r){return new Uint8Array(r,0,r.byteLength)}const $5e="/pkcs8/",LE="/info/",xp=new WeakMap,nu={minKeyLength:112/8,minSaltLength:128/8,minIterationCount:1e3},BE={dek:{keyLength:512/8,iterationCount:1e4,salt:"you should override this value with a crypto secure random number",hash:"sha2-512"}};function dh(r){return r==null||typeof r!="string"?!1:r===t5e(r.trim())&&r.length>0}async function Cr(){const t=Math.random()*800+200;await new Promise(n=>setTimeout(n,t))}function iu(r){return new At($5e+r)}function hh(r){return new At(LE+r)}async function N5e(r){const e=T1(r),t=await B8e.digest(e);return m8e.encode(t.bytes).substring(1)}dH=Symbol.toStringTag,uH=ur;class M5e{constructor(e,t){u(this,"components");u(this,"init");u(this,"log");u(this,"self");u(this,dH,"@libp2p/keychain");u(this,uH,["@libp2p/keychain"]);var i,s,o,a,c,l,d,h,p,m;if(this.components=e,this.log=e.logger.forComponent("libp2p:keychain"),this.init=gE(BE,t),this.self=t.selfKey??"self",this.init.pass!=null&&((i=this.init.pass)==null?void 0:i.length)<20)throw new Error("pass must be least 20 characters");if(((s=this.init.dek)==null?void 0:s.keyLength)!=null&&this.init.dek.keyLength<nu.minKeyLength)throw new Error(`dek.keyLength must be least ${nu.minKeyLength} bytes`);if(((a=(o=this.init.dek)==null?void 0:o.salt)==null?void 0:a.length)!=null&&this.init.dek.salt.length<nu.minSaltLength)throw new Error(`dek.saltLength must be least ${nu.minSaltLength} bytes`);if(((c=this.init.dek)==null?void 0:c.iterationCount)!=null&&this.init.dek.iterationCount<nu.minIterationCount)throw new Error(`dek.iterationCount must be least ${nu.minIterationCount}`);const n=this.init.pass!=null&&((l=this.init.dek)==null?void 0:l.salt)!=null?Q$(this.init.pass,(d=this.init.dek)==null?void 0:d.salt,(h=this.init.dek)==null?void 0:h.iterationCount,(p=this.init.dek)==null?void 0:p.keyLength,(m=this.init.dek)==null?void 0:m.hash):"";xp.set(this,{dek:n})}static generateOptions(){const e=Object.assign({},BE),t=Math.ceil(nu.minSaltLength/3)*3;return e.dek.salt=re(Za(t),"base64"),e}static get options(){return BE}async findKeyByName(e){if(!dh(e))throw await Cr(),new Z(`Invalid key name '${e}'`);const t=hh(e);try{const n=await this.components.datastore.get(t);return JSON.parse(re(n))}catch(n){throw await Cr(),this.log.error(n),new Zt(`Key '${e}' does not exist.`)}}async findKeyById(e){try{const t={prefix:LE};for await(const n of this.components.datastore.query(t)){const i=JSON.parse(re(n.value));if(i.id===e)return i}throw new Z(`Key with id '${e}' does not exist.`)}catch(t){throw await Cr(),t}}async importKey(e,t){if(!dh(e))throw await Cr(),new Z(`Invalid key name '${e}'`);if(t==null)throw await Cr(),new Z("Key is required");const n=iu(e);if(await this.components.datastore.has(n))throw await Cr(),new Z(`Key '${e}' already exists`);let s,o;try{s=await N5e(t);const l=xp.get(this);if(l==null)throw new Z("dek missing");const d=l.dek;o=await iF(t,d,t.type==="RSA"?"pkcs-8":"libp2p-key")}catch(l){throw await Cr(),l}const a={name:e,id:s},c=this.components.datastore.batch();return c.put(n,ie(o)),c.put(hh(e),ie(JSON.stringify(a))),await c.commit(),a}async exportKey(e){if(!dh(e))throw await Cr(),new Z(`Invalid key name '${e}'`);const t=iu(e);try{const n=await this.components.datastore.get(t),i=re(n),s=xp.get(this);if(s==null)throw new Z("dek missing");const o=s.dek;return await sF(i,o)}catch(n){throw await Cr(),n}}async removeKey(e){if(!dh(e)||e===this.self)throw await Cr(),new Z(`Invalid key name '${e}'`);const t=iu(e),n=await this.findKeyByName(e),i=this.components.datastore.batch();return i.delete(t),i.delete(hh(e)),await i.commit(),n}async listKeys(){const e={prefix:LE},t=[];for await(const n of this.components.datastore.query(e))t.push(JSON.parse(re(n.value)));return t}async renameKey(e,t){if(!dh(e)||e===this.self)throw await Cr(),new Z(`Invalid old key name '${e}'`);if(!dh(t)||t===this.self)throw await Cr(),new Z(`Invalid new key name '${t}'`);const n=iu(e),i=iu(t),s=hh(e),o=hh(t);if(await this.components.datastore.has(i))throw await Cr(),new Z(`Key '${t}' already exists`);try{const c=await this.components.datastore.get(n),l=await this.components.datastore.get(s),d=JSON.parse(re(l));d.name=t;const h=this.components.datastore.batch();return h.put(i,c),h.put(o,ie(JSON.stringify(d))),h.delete(n),h.delete(s),await h.commit(),d}catch(c){throw await Cr(),c}}async rotateKeychainPass(e,t){var a,c,l,d;if(typeof e!="string")throw await Cr(),new Z(`Invalid old pass type '${typeof e}'`);if(typeof t!="string")throw await Cr(),new Z(`Invalid new pass type '${typeof t}'`);if(t.length<20)throw await Cr(),new Z(`Invalid pass length ${t.length}`);this.log("recreating keychain");const n=xp.get(this);if(n==null)throw new Z("dek missing");const i=n.dek;this.init.pass=t;const s=t!=null&&((a=this.init.dek)==null?void 0:a.salt)!=null?Q$(t,this.init.dek.salt,(c=this.init.dek)==null?void 0:c.iterationCount,(l=this.init.dek)==null?void 0:l.keyLength,(d=this.init.dek)==null?void 0:d.hash):"";xp.set(this,{dek:s});const o=await this.listKeys();for(const h of o){const p=await this.components.datastore.get(iu(h.name)),m=re(p),f=await sF(m,i),g=s.toString(),w=await iF(f,g,f.type==="RSA"?"pkcs-8":"libp2p-key"),y=this.components.datastore.batch(),b={name:h.name,id:h.id};y.put(iu(h.name),ie(w)),y.put(hh(h.name),ie(JSON.stringify(b))),await y.commit()}this.log("keychain reconstructed")}}function aF(r={}){return e=>new M5e(e,r)}class cF{constructor(e={}){u(this,"memoryStorage");u(this,"points");u(this,"duration");u(this,"blockDuration");u(this,"execEvenly");u(this,"execEvenlyMinDelayMs");u(this,"keyPrefix");this.points=e.points??4,this.duration=e.duration??1,this.blockDuration=e.blockDuration??0,this.execEvenly=e.execEvenly??!1,this.execEvenlyMinDelayMs=e.execEvenlyMinDelayMs??this.duration*1e3/this.points,this.keyPrefix=e.keyPrefix??"rlflx",this.memoryStorage=new O5e}async consume(e,t=1,n={}){const i=this.getKey(e),s=this._getKeySecDuration(n);let o=this.memoryStorage.incrby(i,t,s);if(o.remainingPoints=Math.max(this.points-o.consumedPoints,0),o.consumedPoints>this.points)throw this.blockDuration>0&&o.consumedPoints<=this.points+t&&(o=this.memoryStorage.set(i,o.consumedPoints,this.blockDuration)),new Fie("Rate limit exceeded",o);if(this.execEvenly&&o.msBeforeNext>0&&!o.isFirstInDuration){let a=Math.ceil(o.msBeforeNext/(o.remainingPoints+2));a<this.execEvenlyMinDelayMs&&(a=o.consumedPoints*this.execEvenlyMinDelayMs),await hB(a)}return o}penalty(e,t=1,n={}){const i=this.getKey(e),s=this._getKeySecDuration(n),o=this.memoryStorage.incrby(i,t,s);return o.remainingPoints=Math.max(this.points-o.consumedPoints,0),o}reward(e,t=1,n={}){const i=this.getKey(e),s=this._getKeySecDuration(n),o=this.memoryStorage.incrby(i,-t,s);return o.remainingPoints=Math.max(this.points-o.consumedPoints,0),o}block(e,t){const n=t*1e3,i=this.points+1;return this.memoryStorage.set(this.getKey(e),i,t),{remainingPoints:0,msBeforeNext:n===0?-1:n,consumedPoints:i,isFirstInDuration:!1}}set(e,t,n=0){const i=(n>=0?n:this.duration)*1e3;return this.memoryStorage.set(this.getKey(e),t,n),{remainingPoints:0,msBeforeNext:i===0?-1:i,consumedPoints:t,isFirstInDuration:!1}}get(e){const t=this.memoryStorage.get(this.getKey(e));return t!=null&&(t.remainingPoints=Math.max(this.points-t.consumedPoints,0)),t}delete(e){this.memoryStorage.delete(this.getKey(e))}_getKeySecDuration(e){return(e==null?void 0:e.customDuration)!=null&&e.customDuration>=0?e.customDuration:this.duration}getKey(e){return this.keyPrefix.length>0?`${this.keyPrefix}:${e}`:e}parseKey(e){return e.substring(this.keyPrefix.length)}}class O5e{constructor(){u(this,"storage");this.storage=new Map}incrby(e,t,n){const i=this.storage.get(e);if(i!=null){const s=i.expiresAt!=null?i.expiresAt.getTime()-new Date().getTime():-1;return i.expiresAt==null||s>0?(i.value+=t,{remainingPoints:0,msBeforeNext:s,consumedPoints:i.value,isFirstInDuration:!1}):this.set(e,t,n)}return this.set(e,t,n)}set(e,t,n){const i=n*1e3,s=this.storage.get(e);s!=null&&clearTimeout(s.timeoutId);const o={value:t,expiresAt:i>0?new Date(Date.now()+i):void 0};return this.storage.set(e,o),i>0&&(o.timeoutId=setTimeout(()=>{this.storage.delete(e)},i),o.timeoutId.unref!=null&&o.timeoutId.unref()),{remainingPoints:0,msBeforeNext:i===0?-1:i,consumedPoints:o.value,isFirstInDuration:!0}}get(e){const t=this.storage.get(e);if(t!=null)return{remainingPoints:0,msBeforeNext:t.expiresAt!=null?t.expiresAt.getTime()-new Date().getTime():-1,consumedPoints:t.value,isFirstInDuration:!1}}delete(e){const t=this.storage.get(e);return t!=null?(t.timeoutId!=null&&clearTimeout(t.timeoutId),this.storage.delete(e),!0):!1}}var st;(function(r){r[r.NEW_STREAM=0]="NEW_STREAM",r[r.MESSAGE_RECEIVER=1]="MESSAGE_RECEIVER",r[r.MESSAGE_INITIATOR=2]="MESSAGE_INITIATOR",r[r.CLOSE_RECEIVER=3]="CLOSE_RECEIVER",r[r.CLOSE_INITIATOR=4]="CLOSE_INITIATOR",r[r.RESET_RECEIVER=5]="RESET_RECEIVER",r[r.RESET_INITIATOR=6]="RESET_INITIATOR"})(st||(st={}));const UE=Object.freeze({0:"NEW_STREAM",1:"MESSAGE_RECEIVER",2:"MESSAGE_INITIATOR",3:"CLOSE_RECEIVER",4:"CLOSE_INITIATOR",5:"RESET_RECEIVER",6:"RESET_INITIATOR"}),lF=Object.freeze({NEW_STREAM:st.NEW_STREAM,MESSAGE:st.MESSAGE_INITIATOR,CLOSE:st.CLOSE_INITIATOR,RESET:st.RESET_INITIATOR}),R5e=Object.freeze({MESSAGE:st.MESSAGE_RECEIVER,CLOSE:st.CLOSE_RECEIVER,RESET:st.RESET_RECEIVER}),uF=1<<20,L5e=4<<20;let B5e=class{constructor(e=uF,t=L5e){u(this,"_buffer");u(this,"_headerInfo");u(this,"_maxMessageSize");u(this,"_maxUnprocessedMessageQueueSize");this._buffer=new Le,this._headerInfo=null,this._maxMessageSize=e,this._maxUnprocessedMessageQueueSize=t}write(e){if(e==null||e.length===0)return[];if(this._buffer.append(e),this._buffer.byteLength>this._maxUnprocessedMessageQueueSize)throw new St("Unprocessed message queue size too large!");const t=[];for(;this._buffer.length!==0;){if(this._headerInfo==null)try{this._headerInfo=this._decodeHeader(this._buffer)}catch(l){if(l.name==="InvalidMessageError")throw l;break}const{id:n,type:i,length:s,offset:o}=this._headerInfo;if(this._buffer.length-o<s)break;const c={id:n,type:i};(i===st.NEW_STREAM||i===st.MESSAGE_INITIATOR||i===st.MESSAGE_RECEIVER)&&(c.data=this._buffer.sublist(o,o+s)),t.push(c),this._buffer.consume(o+s),this._headerInfo=null}return t}_decodeHeader(e){const{value:t,offset:n}=hF(e),{value:i,offset:s}=hF(e,n),o=t&7;if(UE[o]==null)throw new Error(`Invalid type received: ${o}`);if(i>this._maxMessageSize)throw new St("Message size too large");return{id:t>>3,type:o,offset:n+s,length:i}}};const U5e=128,dF=127;function hF(r,e=0){let t=0,n=0,i=e,s;const o=r.length;do{if(i>=o||n>49)throw e=0,new RangeError("Could not decode varint");s=r.get(i++),t+=n<28?(s&dF)<<n:(s&dF)*Math.pow(2,n),n+=7}while(s>=U5e);return e=i-e,{value:t,offset:e}}const FE=10*1024;let F5e=class{constructor(){u(this,"_pool");u(this,"_poolOffset");this._pool=Cn(FE),this._poolOffset=0}write(e,t){const n=this._pool;let i=this._poolOffset;Er(e.id<<3|e.type,n,i),i+=gt(e.id<<3|e.type),(e.type===st.NEW_STREAM||e.type===st.MESSAGE_INITIATOR||e.type===st.MESSAGE_RECEIVER)&&e.data!=null?(Er(e.data.length,n,i),i+=gt(e.data.length)):(Er(0,n,i),i+=gt(0));const s=n.subarray(this._poolOffset,i);FE-i<100?(this._pool=Cn(FE),this._poolOffset=0):this._poolOffset=i,t.append(s),(e.type===st.NEW_STREAM||e.type===st.MESSAGE_INITIATOR||e.type===st.MESSAGE_RECEIVER)&&e.data!=null&&t.append(e.data)}};const z5e=new F5e;async function*V5e(r){for await(const e of r){const t=new Le;z5e.write(e,t),yield t}}class K5e extends Error{constructor(e="Stream input buffer error"){super(e),this.name="StreamInputBufferError"}}class j5e extends R9{constructor(t){super(t);u(this,"name");u(this,"streamId");u(this,"send");u(this,"types");u(this,"maxDataSize");this.types=t.direction==="outbound"?lF:R5e,this.send=t.send,this.name=t.name,this.streamId=t.streamId,this.maxDataSize=t.maxDataSize}async sendNewStream(){await this.send({id:this.streamId,type:lF.NEW_STREAM,data:new Le(ie(this.name))})}async sendData(t){for(t=t.sublist();t.byteLength>0;){const n=Math.min(t.byteLength,this.maxDataSize);await this.send({id:this.streamId,type:this.types.MESSAGE,data:t.sublist(0,n)}),t.consume(n)}}async sendReset(){await this.send({id:this.streamId,type:this.types.RESET})}async sendCloseWrite(){await this.send({id:this.streamId,type:this.types.CLOSE})}async sendCloseRead(){}}function H5e(r){const{id:e,name:t,send:n,onEnd:i,type:s="initiator",maxMsgSize:o=uF}=r;return new j5e({id:s==="initiator"?`i${e}`:`r${e}`,streamId:e,name:`${t??e}`,direction:s==="initiator"?"outbound":"inbound",maxDataSize:o,onEnd:i,send:n,log:r.logger.forComponent(`libp2p:mplex:stream:${s}:${e}`)})}const q5e=1024,W5e=1024,G5e=1024*1024*4,Q5e=5,Y5e=500;function fF(r){const e={...r,type:`${UE[r.type]} (${r.type})`};return r.type===st.NEW_STREAM&&(e.data=re(r.data instanceof Uint8Array?r.data:r.data.subarray())),(r.type===st.MESSAGE_INITIATOR||r.type===st.MESSAGE_RECEIVER)&&(e.data=re(r.data instanceof Uint8Array?r.data:r.data.subarray(),"base16")),e}class J5e{constructor(e,t){u(this,"protocol","/mplex/6.7.0");u(this,"sink");u(this,"source");u(this,"log");u(this,"_streamId");u(this,"_streams");u(this,"_init");u(this,"_source");u(this,"closeController");u(this,"rateLimiter");u(this,"closeTimeout");u(this,"logger");t=t??{},this.log=e.logger.forComponent("libp2p:mplex"),this.logger=e.logger,this._streamId=0,this._streams={initiators:new Map,receivers:new Map},this._init=t,this.closeTimeout=t.closeTimeout??Y5e,this.sink=this._createSink(),this._source=ho({objectMode:!0,onEnd:()=>{for(const n of this._streams.initiators.values())n.destroy();for(const n of this._streams.receivers.values())n.destroy()}}),this.source=cn(this._source,n=>V5e(n)),this.closeController=new AbortController,this.rateLimiter=new cF({points:t.disconnectThreshold??Q5e,duration:1})}get streams(){const e=[];for(const t of this._streams.initiators.values())e.push(t);for(const t of this._streams.receivers.values())e.push(t);return e}newStream(e){if(this.closeController.signal.aborted)throw new Cl("Muxer already closed");const t=this._streamId++;e=e==null?t.toString():e.toString();const n=this._streams.initiators;return this._newStream({id:t,name:e,type:"initiator",registry:n})}async close(e){if(this.closeController.signal.aborted)return;const t=(e==null?void 0:e.signal)??AbortSignal.timeout(this.closeTimeout);try{await Promise.all(this.streams.map(async n=>n.close({signal:t}))),this._source.end(),await this._source.onEmpty({signal:t}),this.closeController.abort()}catch(n){this.abort(n)}}abort(e){this.closeController.signal.aborted||(this.streams.forEach(t=>{t.abort(e)}),this.closeController.abort(e))}_newReceiverStream(e){const{id:t,name:n}=e,i=this._streams.receivers;return this._newStream({id:t,name:n,type:"receiver",registry:i})}_newStream(e){const{id:t,name:n,type:i,registry:s}=e;if(this.log("new %s stream %s",i,t),i==="initiator"&&this._streams.initiators.size===(this._init.maxOutboundStreams??W5e))throw new O2("Too many outbound streams open");if(s.has(t))throw new Error(`${i} stream ${t} already exists!`);const c=H5e({id:t,name:n,send:async l=>{this.log.enabled&&this.log.trace("%s stream %s send",i,t,fF(l)),this._source.push(l)},type:i,onEnd:()=>{this.log("%s stream with id %s and protocol %s ended",i,t,c.protocol),s.delete(t),this._init.onStreamEnd!=null&&this._init.onStreamEnd(c)},maxMsgSize:this._init.maxMsgSize,logger:this.logger});return s.set(t,c),c}_createSink(){return async t=>{const n=()=>{vL(t,this.log)};this.closeController.signal.addEventListener("abort",n);try{const i=new B5e(this._init.maxMsgSize,this._init.maxUnprocessedMessageQueueSize);for await(const s of t)for(const o of i.write(s))await this._handleIncoming(o);this._source.end()}catch(i){this.log("error in sink",i),this._source.end(i)}finally{this.closeController.signal.removeEventListener("abort",n)}}}async _handleIncoming(e){const{id:t,type:n}=e;if(this.log.enabled&&this.log.trace("incoming message",fF(e)),e.type===st.NEW_STREAM){if(this._streams.receivers.size===(this._init.maxInboundStreams??q5e)){this.log("too many inbound streams open"),this._source.push({id:t,type:st.RESET_RECEIVER});try{await this.rateLimiter.consume("new-stream",1)}catch{this.log("rate limit hit when opening too many new streams over the inbound stream limit - closing remote connection"),this.abort(new Error("Too many open streams"));return}return}const a=this._newReceiverStream({id:t,name:re(e.data instanceof Uint8Array?e.data:e.data.subarray())});this._init.onIncomingStream!=null&&this._init.onIncomingStream(a);return}const s=((n&1)===1?this._streams.initiators:this._streams.receivers).get(t);if(s==null){this.log("missing stream %s for message type %s",t,UE[n]);try{await this.rateLimiter.consume("missing-stream",1)}catch{this.log("rate limit hit when receiving messages for streams that do not exist - closing remote connection"),this.abort(new Error("Too many messages for missing streams"));return}return}const o=this._init.maxStreamBufferSize??G5e;try{switch(n){case st.MESSAGE_INITIATOR:case st.MESSAGE_RECEIVER:if(s.sourceReadableLength()>o)throw this._source.push({id:e.id,type:n===st.MESSAGE_INITIATOR?st.RESET_RECEIVER:st.RESET_INITIATOR}),new K5e("Input buffer full - increase Mplex maxBufferSize to accommodate slow consumers");s.sourcePush(e.data);break;case st.CLOSE_INITIATOR:case st.CLOSE_RECEIVER:s.remoteCloseWrite();break;case st.RESET_INITIATOR:case st.RESET_RECEIVER:s.reset();break;default:this.log("unknown message type %s",n)}}catch(a){this.log.error("error while processing message",a),s.abort(a)}}}fH=Symbol.toStringTag,hH=ur;class X5e{constructor(e,t={}){u(this,"protocol","/mplex/6.7.0");u(this,"_init");u(this,"components");u(this,fH,"@libp2p/mplex");u(this,hH,["@libp2p/stream-multiplexing"]);this.components=e,this._init=t}createStreamMuxer(e={}){return new J5e(this.components,{...e,...this._init})}}function Z5e(r={}){return e=>new X5e(e,r)}const zE=32,e6e="1.0.0",t6e="ping",r6e="ipfs",n6e=1e4,i6e=2,s6e=1;gH=Symbol.toStringTag,pH=ur;class o6e{constructor(e,t={}){u(this,"protocol");u(this,"components");u(this,"started");u(this,"timeout");u(this,"maxInboundStreams");u(this,"maxOutboundStreams");u(this,"runOnLimitedConnection");u(this,"log");u(this,gH,"@libp2p/ping");u(this,pH,["@libp2p/ping"]);this.components=e,this.log=e.logger.forComponent("libp2p:ping"),this.started=!1,this.protocol=`/${t.protocolPrefix??r6e}/${t6e}/${e6e}`,this.timeout=t.timeout??n6e,this.maxInboundStreams=t.maxInboundStreams??i6e,this.maxOutboundStreams=t.maxOutboundStreams??s6e,this.runOnLimitedConnection=t.runOnLimitedConnection??!0,this.handleMessage=this.handleMessage.bind(this)}async start(){await this.components.registrar.handle(this.protocol,this.handleMessage,{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:this.runOnLimitedConnection}),this.started=!0}async stop(){await this.components.registrar.unhandle(this.protocol),this.started=!1}isStarted(){return this.started}handleMessage(e){this.log("incoming ping from %p",e.connection.remotePeer);const{stream:t}=e,n=Date.now(),i=Ym(t);let s=!1;Promise.resolve().then(async()=>{for(;;){const o=AbortSignal.timeout(this.timeout);o.addEventListener("abort",()=>{t==null||t.abort(new f1("ping timeout"))});const a=await i.read({bytes:zE,signal:o});await i.write(a,{signal:o}),s=!0}}).catch(o=>{s&&o.name==="UnexpectedEOFError"&&t.readStatus!=="ready"||(this.log.error("incoming ping from %p failed with error - %e",e.connection.remotePeer,o),t==null||t.abort(o))}).finally(()=>{const o=Date.now()-n;this.log("incoming ping from %p complete in %dms",e.connection.remotePeer,o);const a=AbortSignal.timeout(this.timeout);t.close({signal:a}).catch(c=>{this.log.error("error closing ping stream from %p - %e",e.connection.remotePeer,c),t==null||t.abort(c)})})}async ping(e,t={}){this.log("pinging %p",e);const n=Date.now(),i=Za(zE),s=await this.components.connectionManager.openConnection(e,t);let o;if(t.signal==null){const a=AbortSignal.timeout(this.timeout);t={...t,signal:a}}try{o=await s.newStream(this.protocol,{...t,runOnLimitedConnection:this.runOnLimitedConnection});const a=Ym(o),[,c]=await Promise.all([a.write(i,t),a.read({...t,bytes:zE})]),l=Date.now()-n;if(!qe(i,c.subarray()))throw new cP(`Received wrong ping ack after ${l}ms`);return this.log("ping %p complete in %dms",s.remotePeer,l),l}catch(a){throw this.log.error("error while pinging %p",s.remotePeer,a),o==null||o.abort(a),a}finally{o!=null&&await o.close(t)}}}function a6e(r={}){return e=>new o6e(e,r)}var Pn;(function(r){(function(n){n.FIN="FIN",n.STOP_SENDING="STOP_SENDING",n.RESET="RESET",n.FIN_ACK="FIN_ACK"})(r.Flag||(r.Flag={}));let e;(function(n){n[n.FIN=0]="FIN",n[n.STOP_SENDING=1]="STOP_SENDING",n[n.RESET=2]="RESET",n[n.FIN_ACK=3]="FIN_ACK"})(e||(e={})),function(n){n.codec=()=>In(e)}(r.Flag||(r.Flag={}));let t;r.codec=()=>(t==null&&(t=De((n,i,s={})=>{s.lengthDelimited!==!1&&i.fork(),n.flag!=null&&(i.uint32(8),r.Flag.codec().encode(n.flag,i)),n.message!=null&&(i.uint32(18),i.bytes(n.message)),s.lengthDelimited!==!1&&i.ldelim()},(n,i,s={})=>{const o={},a=i==null?n.len:n.pos+i;for(;n.pos<a;){const c=n.uint32();switch(c>>>3){case 1:{o.flag=r.Flag.codec().decode(n);break}case 2:{o.message=n.bytes();break}default:{n.skipType(c&7);break}}}return o})),t),r.encode=n=>Pe(n,r.codec()),r.decode=(n,i)=>Te(n,r.codec(),i)})(Pn||(Pn={}));const c6e=["stun:stun.l.google.com:19302","stun:global.stun.twilio.com:3478","stun:stun.cloudflare.com:3478","stun:stun.services.mozilla.com:3478"],pF=Array.from("abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890"),l6e="libp2p+webrtc+v1/",u6e=466,d6e=2*1024*1024,h6e=30*1e3,J3=16*1024;function f6e(r=J3){const e=gt(r-gt(r)),t=1+gt(Object.keys(Pn.Flag).length-1),n=1,i=r-e-t-n,s=gt(i);return e+t+n+s}const p6e=f6e(),g6e=5e3,y6e=5e3,m6e=3e4,gF="/webrtc",VE="/webrtc-signaling/0.0.1",w6e="/libp2p/webrtc-direct/certificate",b6e="webrtc-direct-certificate-private-key",v6e=12096e5,yF=864e5;var mF=function(r,e,t){if(t||arguments.length===2)for(var n=0,i=e.length,s;n<i;n++)(s||!(n in e))&&(s||(s=Array.prototype.slice.call(e,0,n)),s[n]=e[n]);return r.concat(s||Array.prototype.slice.call(e))},E6e=function(){function r(e,t,n){this.name=e,this.version=t,this.os=n,this.type="browser"}return r}(),S6e=function(){function r(e){this.version=e,this.type="node",this.name="node",this.os=process.platform}return r}(),x6e=function(){function r(e,t,n,i){this.name=e,this.version=t,this.os=n,this.bot=i,this.type="bot-device"}return r}(),A6e=function(){function r(){this.type="bot",this.bot=!0,this.name="bot",this.version=null,this.os=null}return r}(),C6e=function(){function r(){this.type="react-native",this.name="react-native",this.version=null,this.os=null}return r}(),I6e=/alexa|bot|crawl(er|ing)|facebookexternalhit|feedburner|google web preview|nagios|postrank|pingdom|slurp|spider|yahoo!|yandex/,k6e=/(nuhk|curl|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask\ Jeeves\/Teoma|ia_archiver)/,wF=3,_6e=[["aol",/AOLShield\/([0-9\._]+)/],["edge",/Edge\/([0-9\._]+)/],["edge-ios",/EdgiOS\/([0-9\._]+)/],["yandexbrowser",/YaBrowser\/([0-9\._]+)/],["kakaotalk",/KAKAOTALK\s([0-9\.]+)/],["samsung",/SamsungBrowser\/([0-9\.]+)/],["silk",/\bSilk\/([0-9._-]+)\b/],["miui",/MiuiBrowser\/([0-9\.]+)$/],["beaker",/BeakerBrowser\/([0-9\.]+)/],["edge-chromium",/EdgA?\/([0-9\.]+)/],["chromium-webview",/(?!Chrom.*OPR)wv\).*Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],["chrome",/(?!Chrom.*OPR)Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],["phantomjs",/PhantomJS\/([0-9\.]+)(:?\s|$)/],["crios",/CriOS\/([0-9\.]+)(:?\s|$)/],["firefox",/Firefox\/([0-9\.]+)(?:\s|$)/],["fxios",/FxiOS\/([0-9\.]+)/],["opera-mini",/Opera Mini.*Version\/([0-9\.]+)/],["opera",/Opera\/([0-9\.]+)(?:\s|$)/],["opera",/OPR\/([0-9\.]+)(:?\s|$)/],["pie",/^Microsoft Pocket Internet Explorer\/(\d+\.\d+)$/],["pie",/^Mozilla\/\d\.\d+\s\(compatible;\s(?:MSP?IE|MSInternet Explorer) (\d+\.\d+);.*Windows CE.*\)$/],["netfront",/^Mozilla\/\d\.\d+.*NetFront\/(\d.\d)/],["ie",/Trident\/7\.0.*rv\:([0-9\.]+).*\).*Gecko$/],["ie",/MSIE\s([0-9\.]+);.*Trident\/[4-7].0/],["ie",/MSIE\s(7\.0)/],["bb10",/BB10;\sTouch.*Version\/([0-9\.]+)/],["android",/Android\s([0-9\.]+)/],["ios",/Version\/([0-9\._]+).*Mobile.*Safari.*/],["safari",/Version\/([0-9\._]+).*Safari/],["facebook",/FB[AS]V\/([0-9\.]+)/],["instagram",/Instagram\s([0-9\.]+)/],["ios-webview",/AppleWebKit\/([0-9\.]+).*Mobile/],["ios-webview",/AppleWebKit\/([0-9\.]+).*Gecko\)$/],["curl",/^curl\/([0-9\.]+)$/],["searchbot",I6e]],bF=[["iOS",/iP(hone|od|ad)/],["Android OS",/Android/],["BlackBerry OS",/BlackBerry|BB10/],["Windows Mobile",/IEMobile/],["Amazon OS",/Kindle/],["Windows 3.11",/Win16/],["Windows 95",/(Windows 95)|(Win95)|(Windows_95)/],["Windows 98",/(Windows 98)|(Win98)/],["Windows 2000",/(Windows NT 5.0)|(Windows 2000)/],["Windows XP",/(Windows NT 5.1)|(Windows XP)/],["Windows Server 2003",/(Windows NT 5.2)/],["Windows Vista",/(Windows NT 6.0)/],["Windows 7",/(Windows NT 6.1)/],["Windows 8",/(Windows NT 6.2)/],["Windows 8.1",/(Windows NT 6.3)/],["Windows 10",/(Windows NT 10.0)/],["Windows ME",/Windows ME/],["Windows CE",/Windows CE|WinCE|Microsoft Pocket Internet Explorer/],["Open BSD",/OpenBSD/],["Sun OS",/SunOS/],["Chrome OS",/CrOS/],["Linux",/(Linux)|(X11)/],["Mac OS",/(Mac_PowerPC)|(Macintosh)/],["QNX",/QNX/],["BeOS",/BeOS/],["OS/2",/OS\/2/]];function T6e(r){return typeof document>"u"&&typeof navigator<"u"&&navigator.product==="ReactNative"?new C6e:typeof navigator<"u"?D6e(navigator.userAgent):N6e()}function P6e(r){return r!==""&&_6e.reduce(function(e,t){var n=t[0],i=t[1];if(e)return e;var s=i.exec(r);return!!s&&[n,s]},!1)}function D6e(r){var e=P6e(r);if(!e)return null;var t=e[0],n=e[1];if(t==="searchbot")return new A6e;var i=n[1]&&n[1].split(".").join("_").split("_").slice(0,3);i?i.length<wF&&(i=mF(mF([],i,!0),M6e(wF-i.length),!0)):i=[];var s=i.join("."),o=$6e(r),a=k6e.exec(r);return a&&a[1]?new x6e(t,s,o,a[1]):new E6e(t,s,o)}function $6e(r){for(var e=0,t=bF.length;e<t;e++){var n=bF[e],i=n[0],s=n[1],o=s.exec(r);if(o)return i}return null}function N6e(){var r=typeof process<"u"&&process.version;return r?new S6e(process.version.slice(1)):null}function M6e(r){for(var e=[],t=0;t<r;t++)e.push("0");return e}const vF=T6e(),KE=vF!=null&&vF.name==="firefox",EF=async function*(){},SF=async r=>{};function O6e(r,e,t=m6e,n){r.readyState==="open"&&Promise.resolve().then(async()=>{if(r.bufferedAmount>0){n.log("%s drain channel with %d buffered bytes",e,r.bufferedAmount);const i=Re();let s=!1;r.bufferedAmountLowThreshold=0;const o=()=>{s||(n.log("%s drain channel closed before drain",e),i.resolve())};r.addEventListener("close",o,{once:!0}),r.addEventListener("bufferedamountlow",()=>{s=!0,r.removeEventListener("close",o),i.resolve()}),await jf(i.promise,{milliseconds:t})}}).then(async()=>{r.readyState==="open"&&r.close()}).catch(i=>{n.log.error("error closing outbound stream",i)})}async function xF(r){return r=r??{},typeof r=="function"&&(r=await r()),r.iceServers=r.iceServers??c6e.map(e=>({urls:[e]})),r}const R6e=(r=32)=>l6e+[...Array(r)].map(()=>pF.at(Math.floor(Math.random()*pF.length))).join("");class jE{constructor(e,t){u(this,"log");u(this,"peerConnection");u(this,"remoteAddr");u(this,"timeline");u(this,"metrics");u(this,"source",EF());u(this,"sink",SF);this.log=e.logger.forComponent("libp2p:webrtc:maconn"),this.remoteAddr=t.remoteAddr,this.timeline=t.timeline,this.peerConnection=t.peerConnection;const n=this.peerConnection,i=n.connectionState;this.peerConnection.onconnectionstatechange=()=>{this.log.trace("peer connection state change",n.connectionState,"initial state",i),(n.connectionState==="disconnected"||n.connectionState==="failed"||n.connectionState==="closed")&&(this.timeline.close=Date.now())}}async close(e){var t;this.log.trace("closing connection"),this.peerConnection.close(),this.timeline.close=Date.now(),(t=this.metrics)==null||t.increment({close:!0})}abort(e){var t;this.log.error("closing connection due to error",e),this.peerConnection.close(),this.timeline.close=Date.now(),(t=this.metrics)==null||t.increment({abort:!0})}}class L6e extends R9{constructor(t){const n=t.onEnd;t.onEnd=s=>{this.log.trace('readable and writeable ends closed with status "%s"',this.status),Promise.resolve(async()=>{if(!(this.timeline.abort!=null||this.timeline.reset!==null))try{await jf(this.receiveFinAck.promise,{milliseconds:this.finAckTimeout})}catch(o){this.log.error("error receiving FIN_ACK",o)}}).then(()=>{this.incomingData.end(),n==null||n(s)}).catch(o=>{this.log.error("error ending stream",o)}).finally(()=>{this.channel.close()})};super(t);u(this,"channel");u(this,"incomingData");u(this,"maxBufferedAmount");u(this,"bufferedAmountLowEventTimeout");u(this,"maxMessageSize");u(this,"receiveFinAck");u(this,"finAckTimeout");u(this,"openTimeout");u(this,"closeController");switch(this.channel=t.channel,this.channel.binaryType="arraybuffer",this.incomingData=ho(),this.bufferedAmountLowEventTimeout=t.bufferedAmountLowEventTimeout??h6e,this.maxBufferedAmount=t.maxBufferedAmount??d6e,this.maxMessageSize=(t.maxMessageSize??J3)-p6e,this.receiveFinAck=Re(),this.finAckTimeout=t.closeTimeout??g6e,this.openTimeout=t.openTimeout??y6e,this.closeController=new AbortController,this.channel.readyState){case"open":this.timeline.open=new Date().getTime();break;case"closed":case"closing":(this.timeline.close===void 0||this.timeline.close===0)&&(this.timeline.close=Date.now());break;case"connecting":break;default:throw this.log.error("unknown datachannel state %s",this.channel.readyState),new D2("Unknown datachannel state")}this.channel.onopen=s=>{this.timeline.open=new Date().getTime()},this.channel.onclose=s=>{this.log.trace("received onclose event"),this.closeController.abort(),this.receiveFinAck.resolve(),this.close().catch(o=>{this.log.error("error closing stream after channel closed",o)})},this.channel.onerror=s=>{this.log.trace("received onerror event"),this.closeController.abort();const o=s.error;this.abort(o)},this.channel.onmessage=async s=>{const{data:o}=s;o===null||o.byteLength===0||this.incomingData.push(new Uint8Array(o,0,o.byteLength))};const i=this;Promise.resolve().then(async()=>{for await(const s of Rd(this.incomingData)){const o=i.processIncomingProtobuf(s);o!=null&&i.sourcePush(new Le(o))}}).catch(s=>{this.log.error("error processing incoming data channel messages",s)})}sendNewStream(){}async _sendMessage(t,n=!0){if(this.channel.readyState==="closed"||this.channel.readyState==="closing")throw new D2(`Invalid datachannel state - ${this.channel.readyState}`);if(this.channel.readyState!=="open"){const i=AbortSignal.timeout(this.openTimeout),s=ft([this.closeController.signal,i]);try{this.log('channel state is "%s" and not "open", waiting for "open" event before sending data',this.channel.readyState),await _i(this.channel,"open",s)}finally{s.clear()}this.log('channel state is now "%s", sending data',this.channel.readyState)}if(n&&this.channel.bufferedAmount>this.maxBufferedAmount){const i=AbortSignal.timeout(this.bufferedAmountLowEventTimeout),s=ft([this.closeController.signal,i]);try{this.log('channel buffer is %d, wait for "bufferedamountlow" event',this.channel.bufferedAmount),await _i(this.channel,"bufferedamountlow",s)}catch(o){throw i.aborted?new f1(`Timed out waiting for DataChannel buffer to clear after ${this.bufferedAmountLowEventTimeout}ms`):o}finally{s.clear()}}try{this.log.trace('sending message, channel state "%s"',this.channel.readyState),this.channel.send(t.subarray())}catch(i){this.log.error("error while sending message",i)}}async sendData(t){const n=t.byteLength;for(t=t.sublist();t.byteLength>0;){const i=Math.min(t.byteLength,this.maxMessageSize),s=t.subarray(0,i),o=Pn.encode({message:s}),a=Od.single(o);this.log.trace("sending %d/%d bytes on channel",s.byteLength,n),await this._sendMessage(a),t.consume(i)}this.log.trace('finished sending data, channel state "%s"',this.channel.readyState)}async sendReset(){try{await this._sendFlag(Pn.Flag.RESET)}catch(t){this.log.error("failed to send reset - %e",t)}finally{this.channel.close()}}async sendCloseWrite(t){if(this.channel.readyState!=="open"){this.receiveFinAck.resolve();return}if(await this._sendFlag(Pn.Flag.FIN)){this.log.trace("awaiting FIN_ACK");try{await an(this.receiveFinAck.promise,t==null?void 0:t.signal,{errorMessage:"sending close-write was aborted before FIN_ACK was received",errorName:"FinAckNotReceivedError"})}catch(i){this.log.error("failed to await FIN_ACK",i)}}else this.log.trace("sending FIN failed, not awaiting FIN_ACK");this.receiveFinAck.resolve()}async sendCloseRead(){this.channel.readyState==="open"&&await this._sendFlag(Pn.Flag.STOP_SENDING)}processIncomingProtobuf(t){const n=Pn.decode(t);if(n.flag!==void 0&&(this.log.trace('incoming flag %s, write status "%s", read status "%s"',n.flag,this.writeStatus,this.readStatus),n.flag===Pn.Flag.FIN&&(this.remoteCloseWrite(),this.log.trace("sending FIN_ACK"),this._sendFlag(Pn.Flag.FIN_ACK).catch(i=>{this.log.error("error sending FIN_ACK immediately",i)})),n.flag===Pn.Flag.RESET&&this.reset(),n.flag===Pn.Flag.STOP_SENDING&&this.remoteCloseRead(),n.flag===Pn.Flag.FIN_ACK&&(this.log.trace("received FIN_ACK"),this.receiveFinAck.resolve())),this.readStatus==="ready")return n.message}async _sendFlag(t){if(this.channel.readyState!=="open")return this.log.trace('not sending flag %s because channel is "%s" and not "open"',t.toString(),this.channel.readyState),!1;this.log.trace("sending flag %s",t.toString());const n=Pn.encode({flag:t}),i=Od.single(n);try{return await this._sendMessage(i,!1),!0}catch(s){this.log.error("could not send flag %s - %e",t.toString(),s)}return!1}}function X3(r){const{channel:e,direction:t,handshake:n}=r;return new L6e({id:`${e.id}`,log:r.logger.forComponent(`libp2p:webrtc:stream:${n===!0?"handshake":t}:${e.id}`),...r})}class HE{constructor(e,t){u(this,"protocol");u(this,"peerConnection");u(this,"bufferedStreams",[]);u(this,"metrics");u(this,"dataChannelOptions");u(this,"components");u(this,"log");this.components=e,this.peerConnection=t.peerConnection,this.metrics=t.metrics,this.protocol=t.protocol??gF,this.dataChannelOptions=t.dataChannelOptions??{},this.log=e.logger.forComponent("libp2p:webrtc:muxerfactory"),this.peerConnection.ondatachannel=({channel:n})=>{if(this.log.trace('incoming early datachannel with channel id %d and label "%s"',n.id),n.label==="init"){this.log.trace("closing early init channel"),n.close();return}const i={},s=X3({channel:n,direction:"inbound",onEnd:o=>{i.onEnd(o)},logger:e.logger,...this.dataChannelOptions});i.stream=s,i.channel=n,i.onEnd=()=>{this.bufferedStreams=this.bufferedStreams.filter(o=>o.stream.id!==s.id)},this.bufferedStreams.push(i)}}createStreamMuxer(e){return new B6e(this.components,{...e,peerConnection:this.peerConnection,dataChannelOptions:this.dataChannelOptions,metrics:this.metrics,streams:this.bufferedStreams,protocol:this.protocol})}}class B6e{constructor(e,t){Ye(this,Yh);u(this,"init");u(this,"streams");u(this,"protocol");u(this,"log");u(this,"peerConnection");u(this,"dataChannelOptions");u(this,"metrics");u(this,"logger");u(this,"source",EF());u(this,"sink",SF);this.init=t,this.log=e.logger.forComponent("libp2p:webrtc:muxer"),this.logger=e.logger,this.streams=t.streams.map(n=>n.stream),this.peerConnection=t.peerConnection,this.protocol=t.protocol??gF,this.metrics=t.metrics,this.dataChannelOptions=t.dataChannelOptions??{},this.peerConnection.ondatachannel=({channel:n})=>{var o,a;if(this.log.trace("incoming datachannel with channel id %d",n.id),n.label==="init"){this.log.trace("closing init channel"),n.close();return}const i=n.id,s=X3({channel:n,direction:"inbound",onEnd:()=>{Ae(this,Yh,U4).call(this,s,n),this.log("incoming channel %s ended",i)},logger:this.logger,...this.dataChannelOptions});this.streams.push(s),(o=this.metrics)==null||o.increment({incoming_stream:!0}),(a=t==null?void 0:t.onIncomingStream)==null||a.call(t,s)},this.init.streams.length>0&&queueMicrotask(()=>{this.init.streams.forEach(n=>{var i,s,o;n.onEnd=()=>{this.log("incoming early channel %s ended with state %s",n.channel.id,n.channel.readyState),Ae(this,Yh,U4).call(this,n.stream,n.channel)},(i=this.metrics)==null||i.increment({incoming_stream:!0}),(o=(s=this.init)==null?void 0:s.onIncomingStream)==null||o.call(s,n.stream)})})}async close(e){try{await Promise.all(this.streams.map(async t=>t.close(e)))}catch(t){this.abort(t)}}abort(e){for(const t of this.streams)t.abort(e)}newStream(){var i;const e=this.peerConnection.createDataChannel(""),t=e.id;this.log.trace("opened outgoing datachannel with channel id %s",t);const n=X3({channel:e,direction:"outbound",onEnd:()=>{Ae(this,Yh,U4).call(this,n,e),this.log("outgoing channel %s ended",t)},logger:this.logger,...this.dataChannelOptions});return this.streams.push(n),(i=this.metrics)==null||i.increment({outgoing_stream:!0}),n}}Yh=new WeakSet,U4=function(e,t){var n,i,s;this.log.trace("stream %s %s %s onEnd",e.direction,e.id,e.protocol),O6e(t,`${e.direction} ${e.id} ${e.protocol}`,this.dataChannelOptions.drainTimeout,{log:this.log}),this.streams=this.streams.filter(o=>o.id!==e.id),(n=this.metrics)==null||n.increment({stream_end:!0}),(s=(i=this.init)==null?void 0:i.onStreamEnd)==null||s.call(i,e)};const AF=globalThis.RTCPeerConnection,CF=globalThis.RTCSessionDescription,U6e=globalThis.RTCIceCandidate;class Ap extends Error{constructor(e){super(`WebRTC transport error: ${e}`),this.name="WebRTCTransportError"}}class Tc extends Ap{constructor(e="SDP handshake failed"){super(e),this.name="SDPHandshakeFailedError"}}class F6e extends Ap{constructor(e,t){super(`Invalid fingerprint "${e}" within ${t}`),this.name="WebRTC/InvalidFingerprintError"}}class z6e extends Ap{constructor(e){super(`A method (${e}) was called though it has been intentionally left unimplemented.`),this.name="WebRTC/UnimplementedError"}}class V6e extends Ap{constructor(e){super(`unsupported hash algorithm code: ${e} please see the codes at https://github.com/multiformats/multicodec/blob/master/table.csv `),this.name="WebRTC/UnsupportedHashAlgorithmError"}}var ds;(function(r){(function(n){n.SDP_OFFER="SDP_OFFER",n.SDP_ANSWER="SDP_ANSWER",n.ICE_CANDIDATE="ICE_CANDIDATE"})(r.Type||(r.Type={}));let e;(function(n){n[n.SDP_OFFER=0]="SDP_OFFER",n[n.SDP_ANSWER=1]="SDP_ANSWER",n[n.ICE_CANDIDATE=2]="ICE_CANDIDATE"})(e||(e={})),function(n){n.codec=()=>In(e)}(r.Type||(r.Type={}));let t;r.codec=()=>(t==null&&(t=De((n,i,s={})=>{s.lengthDelimited!==!1&&i.fork(),n.type!=null&&(i.uint32(8),r.Type.codec().encode(n.type,i)),n.data!=null&&(i.uint32(18),i.string(n.data)),s.lengthDelimited!==!1&&i.ldelim()},(n,i,s={})=>{const o={},a=i==null?n.len:n.pos+i;for(;n.pos<a;){const c=n.uint32();switch(c>>>3){case 1:{o.type=r.Type.codec().decode(n);break}case 2:{o.data=n.string();break}default:{n.skipType(c&7);break}}}return o})),t),r.encode=n=>Pe(n,r.codec()),r.decode=(n,i)=>Te(n,r.codec(),i)})(ds||(ds={}));const IF=async(r,e,t)=>{var n,i,s,o;try{const a=Re();for(K6e(r,a);;){const c=await Promise.race([a.promise,e.read({signal:t.signal}).catch(()=>{})]);if(c==null){(n=t.signal)==null||n.throwIfAborted();break}if(c.type!==ds.Type.ICE_CANDIDATE)throw new St("ICE candidate message expected");const l=JSON.parse(c.data??"null");if(l===""||l===null){(i=t.onProgress)==null||i.call(t,new ke("webrtc:end-of-ice-candidates")),t.log.trace("end-of-candidates received");continue}const d=new U6e(l);t.log.trace("%s received new ICE candidate %o",t.direction,l);try{(s=t.onProgress)==null||s.call(t,new ke("webrtc:add-ice-candidate",d.candidate)),await r.addIceCandidate(d)}catch(h){t.log.error("%s bad candidate received",t.direction,l,h)}}}catch(a){if(t.log.error("%s error parsing ICE candidate",t.direction,a),((o=t.signal)==null?void 0:o.aborted)===!0&&qE(r)!=="connected")throw a}};function qE(r){return KE?r.iceConnectionState:r.connectionState}function K6e(r,e){r[KE?"oniceconnectionstatechange":"onconnectionstatechange"]=t=>{switch(qE(r)){case"connected":e.resolve();break;case"failed":case"disconnected":case"closed":e.reject(new xb("RTCPeerConnection was closed"));break}}}async function j6e({rtcConfiguration:r,dataChannel:e,signal:t,metrics:n,multiaddr:i,connectionManager:s,transportManager:o,log:a,logger:c,onProgress:l}){const{baseAddr:d}=W6e(i);n==null||n.dialerEvents.increment({open:!0}),a.trace("dialing base address: %a",d);const h=d.getPeerId();if(h==null)throw new Z("Relay peer was missing");const p=s.getConnections(tr(h));let m,f=!1;p.length===0?(l==null||l(new ke("webrtc:dial-relay")),m=await o.dial(d,{signal:t,onProgress:l}),f=!0):(l==null||l(new ke("webrtc:reuse-relay-connection")),m=p[0]);try{l==null||l(new ke("webrtc:open-signaling-stream"));const g=await m.newStream(VE,{signal:t,runOnLimitedConnection:!0}),w=ci(g).pb(ds),y=new AF(r),b=new HE({logger:c},{peerConnection:y,dataChannelOptions:e});try{const v=y.createDataChannel("init");y.onicecandidate=({candidate:x})=>{const I=JSON.stringify((x==null?void 0:x.toJSON())??null);a.trace("initiator sending ICE candidate %o",x),w.write({type:ds.Type.ICE_CANDIDATE,data:I},{signal:t}).catch(T=>{a.error("error sending ICE candidate",T)})},y.onicecandidateerror=x=>{a.error("initiator ICE candidate error",x)};const E=await y.createOffer().catch(x=>{throw a.error("could not execute createOffer",x),new Tc("Failed to set createOffer")});a.trace("initiator send SDP offer %s",E.sdp),l==null||l(new ke("webrtc:send-sdp-offer")),await w.write({type:ds.Type.SDP_OFFER,data:E.sdp},{signal:t}),await y.setLocalDescription(E).catch(x=>{throw a.error("could not execute setLocalDescription",x),new Tc("Failed to set localDescription")}),l==null||l(new ke("webrtc:read-sdp-answer")),a.trace("initiator read SDP answer");const C=await w.read({signal:t});if(C.type!==ds.Type.SDP_ANSWER)throw new Tc("Remote should send an SDP answer");a.trace("initiator received SDP answer %s",C.data);const k=new CF({type:"answer",sdp:C.data});return await y.setRemoteDescription(k).catch(x=>{throw a.error("could not execute setRemoteDescription",x),new Tc("Failed to set remoteDescription")}),a.trace("initiator read candidates until connected"),l==null||l(new ke("webrtc:read-ice-candidates")),await IF(y,w,{direction:"initiator",signal:t,log:a,onProgress:l}),a.trace("initiator connected, closing init channel"),v.close(),l==null||l(new ke("webrtc:close-signaling-stream")),a.trace("closing signaling channel"),await g.close({signal:t}),a.trace("initiator connected to remote address %s",i),{remoteAddress:i,peerConnection:y,muxerFactory:b}}catch(v){throw a.error("outgoing signaling error",v),y.close(),g.abort(v),v}finally{y.onicecandidate=null,y.onicecandidateerror=null}}finally{if(f)try{await m.close({signal:t})}catch(g){m.abort(g)}}}const kF=Ct(rO.matchers[0],Ge("p2p-circuit"));class WE extends er{constructor(t,n){super();u(this,"transportManager");u(this,"shutdownController");u(this,"events");this.transportManager=t.transportManager,this.events=t.events,this.shutdownController=n.shutdownController,this.onTransportListening=this.onTransportListening.bind(this)}async listen(){this.events.addEventListener("transport:listening",this.onTransportListening)}onTransportListening(t){t.detail.getAddrs().filter(i=>kF.exactMatch(i)).map(i=>i.encapsulate("/webrtc")).length>0&&this.safeDispatchEvent("listening")}getAddrs(){return this.transportManager.getListeners().filter(t=>!(t instanceof WE)).map(t=>t.getAddrs().filter(n=>kF.exactMatch(n)).map(n=>n.encapsulate("/webrtc"))).flat()}updateAnnounceAddrs(){}async close(){this.events.removeEventListener("transport:listening",this.onTransportListening),this.shutdownController.abort(),queueMicrotask(()=>{this.safeDispatchEvent("close")})}}async function H6e({peerConnection:r,stream:e,signal:t,connection:n,log:i}){i.trace("new inbound signaling stream");const s=ci(e).pb(ds);try{r.onicecandidate=({candidate:d})=>{const h=JSON.stringify((d==null?void 0:d.toJSON())??null);i.trace("recipient sending ICE candidate %s",h),s.write({type:ds.Type.ICE_CANDIDATE,data:h},{signal:t}).catch(p=>{i.error("error sending ICE candidate",p)})},i.trace("recipient read SDP offer");const a=await s.read({signal:t});if(a.type!==ds.Type.SDP_OFFER)throw new Tc(`expected message type SDP_OFFER, received: ${a.type??"undefined"} `);i.trace("recipient received SDP offer %s",a.data);const c=new CF({type:"offer",sdp:a.data});await r.setRemoteDescription(c).catch(d=>{throw i.error("could not execute setRemoteDescription",d),new Tc("Failed to set remoteDescription")});const l=await r.createAnswer().catch(d=>{throw i.error("could not execute createAnswer",d),new Tc("Failed to create answer")});i.trace("recipient send SDP answer %s",l.sdp),await s.write({type:ds.Type.SDP_ANSWER,data:l.sdp},{signal:t}),await r.setLocalDescription(l).catch(d=>{throw i.error("could not execute setLocalDescription",d),new Tc("Failed to set localDescription")}),i.trace("recipient read candidates until connected"),await IF(r,s,{direction:"recipient",signal:t,log:i})}catch(a){if(qE(r)!=="connected")throw i.error("error while handling signaling stream from peer %a",n.remoteAddr,a),r.close(),a;i("error while handling signaling stream from peer %a, ignoring as the RTCPeerConnection is already connected",n.remoteAddr,a)}const o=Oe(`/webrtc/p2p/${n.remoteAddr.getPeerId()}`);return i.trace("recipient connected to remote address %s",o),{remoteAddress:o}}bH=P2,wH=Symbol.toStringTag,mH=ur,yH=ja;class q6e{constructor(e,t={}){u(this,"components");u(this,"init");u(this,"log");u(this,"_started",!1);u(this,"metrics");u(this,"shutdownController");u(this,bH,!0);u(this,wH,"@libp2p/webrtc");u(this,mH,["@libp2p/transport"]);u(this,yH,["@libp2p/identify","@libp2p/circuit-relay-v2-transport"]);this.components=e,this.init=t,this.log=e.logger.forComponent("libp2p:webrtc"),this.shutdownController=new AbortController,this.shutdownController.signal,e.metrics!=null&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_webrtc_dialer_events_total",{label:"event",help:"Total count of WebRTC dialer events by type"}),listenerEvents:e.metrics.registerCounterGroup("libp2p_webrtc_listener_events_total",{label:"event",help:"Total count of WebRTC listener events by type"})})}isStarted(){return this._started}async start(){await this.components.registrar.handle(VE,e=>{const t=this.components.upgrader.createInboundAbortSignal(this.shutdownController.signal);this._onProtocol(e,t).catch(n=>{this.log.error("failed to handle incoming connect from %p",e.connection.remotePeer,n)}).finally(()=>{t.clear()})},{runOnLimitedConnection:!0}),this._started=!0}async stop(){await this.components.registrar.unhandle(VE),this._started=!1}createListener(e){return new WE(this.components,{shutdownController:this.shutdownController})}listenFilter(e){return e.filter(R7.exactMatch)}dialFilter(e){return this.listenFilter(e)}async dial(e,t){var c;this.log.trace("dialing address: %a",e);const{remoteAddress:n,peerConnection:i,muxerFactory:s}=await j6e({rtcConfiguration:await xF(this.init.rtcConfiguration),dataChannel:this.init.dataChannel,multiaddr:e,dataChannelOptions:this.init.dataChannel,signal:t.signal,connectionManager:this.components.connectionManager,transportManager:this.components.transportManager,log:this.log,logger:this.components.logger,onProgress:t.onProgress}),o=new jE(this.components,{peerConnection:i,timeline:{open:Date.now()},remoteAddr:n,metrics:(c=this.metrics)==null?void 0:c.dialerEvents}),a=await t.upgrader.upgradeOutbound(o,{skipProtection:!0,skipEncryption:!0,muxerFactory:s,onProgress:t.onProgress,signal:t.signal});return this._closeOnShutdown(i,o),a}async _onProtocol({connection:e,stream:t},n){var o;const i=new AF(await xF(this.init.rtcConfiguration)),s=new HE(this.components,{peerConnection:i,dataChannelOptions:this.init.dataChannel});try{const{remoteAddress:a}=await H6e({peerConnection:i,connection:e,stream:t,signal:n,log:this.log});await t.close({signal:n});const c=new jE(this.components,{peerConnection:i,timeline:{open:new Date().getTime()},remoteAddr:a,metrics:(o=this.metrics)==null?void 0:o.listenerEvents});await this.components.upgrader.upgradeInbound(c,{skipEncryption:!0,skipProtection:!0,muxerFactory:s,signal:n}),this._closeOnShutdown(i,c)}catch(a){throw this.log.error("incoming signaling error",a),i.close(),t.abort(a),a}}_closeOnShutdown(e,t){const n=()=>{t.close().catch(i=>{this.log.error("could not close WebRTCMultiaddrConnection",i)})};this.shutdownController.signal.addEventListener("abort",n),e.addEventListener("close",()=>{this.shutdownController.signal.removeEventListener("abort",n)})}}function W6e(r){const e=r.toString().split("/webrtc/");if(e.length!==2)throw new Z("webrtc protocol was not present in multiaddr");if(!e[0].includes("/p2p-circuit"))throw new Z("p2p-circuit protocol was not present in multiaddr");let t=Oe(e[0]);const i=Oe("/"+e[1]).getPeerId();if(i==null)throw new Z("destination peer id was missing");const s=t.protos().pop();if(s===void 0)throw new Z("invalid multiaddr");return s.name!=="p2p"&&(t=t.encapsulate(`/p2p/${i}`)),{baseAddr:t,peerId:tr(i)}}/*! *****************************************************************************
Copyright (C) Microsoft. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */var _F;(function(r){(function(e){var t=typeof globalThis=="object"?globalThis:typeof rt=="object"?rt:typeof self=="object"?self:typeof this=="object"?this:a(),n=i(r);typeof t.Reflect<"u"&&(n=i(t.Reflect,n)),e(n,t),typeof t.Reflect>"u"&&(t.Reflect=r);function i(c,l){return function(d,h){Object.defineProperty(c,d,{configurable:!0,writable:!0,value:h}),l&&l(d,h)}}function s(){try{return Function("return this;")()}catch{}}function o(){try{return(0,eval)("(function() { return this; })()")}catch{}}function a(){return s()||o()}})(function(e,t){var n=Object.prototype.hasOwnProperty,i=typeof Symbol=="function",s=i&&typeof Symbol.toPrimitive<"u"?Symbol.toPrimitive:"@@toPrimitive",o=i&&typeof Symbol.iterator<"u"?Symbol.iterator:"@@iterator",a=typeof Object.create=="function",c={__proto__:[]}instanceof Array,l=!a&&!c,d={create:a?function(){return M(Object.create(null))}:c?function(){return M({__proto__:null})}:function(){return M({})},has:l?function(P,N){return n.call(P,N)}:function(P,N){return N in P},get:l?function(P,N){return n.call(P,N)?P[N]:void 0}:function(P,N){return P[N]}},h=Object.getPrototypeOf(Function),p=typeof Map=="function"&&typeof Map.prototype.entries=="function"?Map:D(),m=typeof Set=="function"&&typeof Set.prototype.entries=="function"?Set:S(),f=typeof WeakMap=="function"?WeakMap:A(),g=i?Symbol.for("@reflect-metadata:registry"):void 0,w=f0(),y=NA(w);function b(P,N,R,J){if(H(R)){if(!bt(P))throw new TypeError;if(!kt(N))throw new TypeError;return B(P,N)}else{if(!bt(P))throw new TypeError;if(!de(N))throw new TypeError;if(!de(J)&&!H(J)&&!oe(J))throw new TypeError;return oe(J)&&(J=void 0),R=tt(R),G(P,N,R,J)}}e("decorate",b);function v(P,N){function R(J,he){if(!de(J))throw new TypeError;if(!H(he)&&!Yt(he))throw new TypeError;O(P,N,J,he)}return R}e("metadata",v);function E(P,N,R,J){if(!de(R))throw new TypeError;return H(J)||(J=tt(J)),O(P,N,R,J)}e("defineMetadata",E);function C(P,N,R){if(!de(N))throw new TypeError;return H(R)||(R=tt(R)),K(P,N,R)}e("hasMetadata",C);function k(P,N,R){if(!de(N))throw new TypeError;return H(R)||(R=tt(R)),q(P,N,R)}e("hasOwnMetadata",k);function x(P,N,R){if(!de(N))throw new TypeError;return H(R)||(R=tt(R)),Q(P,N,R)}e("getMetadata",x);function I(P,N,R){if(!de(N))throw new TypeError;return H(R)||(R=tt(R)),j(P,N,R)}e("getOwnMetadata",I);function T(P,N){if(!de(P))throw new TypeError;return H(N)||(N=tt(N)),U(P,N)}e("getMetadataKeys",T);function L(P,N){if(!de(P))throw new TypeError;return H(N)||(N=tt(N)),W(P,N)}e("getOwnMetadataKeys",L);function z(P,N,R){if(!de(N))throw new TypeError;if(H(R)||(R=tt(R)),!de(N))throw new TypeError;H(R)||(R=tt(R));var J=Iu(N,R,!1);return H(J)?!1:J.OrdinaryDeleteMetadata(P,N,R)}e("deleteMetadata",z);function B(P,N){for(var R=P.length-1;R>=0;--R){var J=P[R],he=J(N);if(!H(he)&&!oe(he)){if(!kt(he))throw new TypeError;N=he}}return N}function G(P,N,R,J){for(var he=P.length-1;he>=0;--he){var Me=P[he],Fe=Me(N,R,J);if(!H(Fe)&&!oe(Fe)){if(!de(Fe))throw new TypeError;J=Fe}}return J}function K(P,N,R){var J=q(P,N,R);if(J)return!0;var he=Kc(N);return oe(he)?!1:K(P,he,R)}function q(P,N,R){var J=Iu(N,R,!1);return H(J)?!1:Ne(J.OrdinaryHasOwnMetadata(P,N,R))}function Q(P,N,R){var J=q(P,N,R);if(J)return j(P,N,R);var he=Kc(N);if(!oe(he))return Q(P,he,R)}function j(P,N,R){var J=Iu(N,R,!1);if(!H(J))return J.OrdinaryGetOwnMetadata(P,N,R)}function O(P,N,R,J){var he=Iu(R,J,!0);he.OrdinaryDefineOwnMetadata(P,N,R,J)}function U(P,N){var R=W(P,N),J=Kc(P);if(J===null)return R;var he=U(J,N);if(he.length<=0)return R;if(R.length<=0)return he;for(var Me=new m,Fe=[],ve=0,pe=R;ve<pe.length;ve++){var be=pe[ve],Se=Me.has(be);Se||(Me.add(be),Fe.push(be))}for(var xe=0,Qe=he;xe<Qe.length;xe++){var be=Qe[xe],Se=Me.has(be);Se||(Me.add(be),Fe.push(be))}return Fe}function W(P,N){var R=Iu(P,N,!1);return R?R.OrdinaryOwnMetadataKeys(P,N):[]}function Y(P){if(P===null)return 1;switch(typeof P){case"undefined":return 0;case"boolean":return 2;case"string":return 3;case"symbol":return 4;case"number":return 5;case"object":return P===null?1:6;default:return 6}}function H(P){return P===void 0}function oe(P){return P===null}function ye(P){return typeof P=="symbol"}function de(P){return typeof P=="object"?P!==null:typeof P=="function"}function le(P,N){switch(Y(P)){case 0:return P;case 1:return P;case 2:return P;case 3:return P;case 4:return P;case 5:return P}var R="string",J=Au(P,s);if(J!==void 0){var he=J.call(P,R);if(de(he))throw new TypeError;return he}return $e(P)}function $e(P,N){var R,J,he;{var Me=P.toString;if(vt(Me)){var J=Me.call(P);if(!de(J))return J}var R=P.valueOf;if(vt(R)){var J=R.call(P);if(!de(J))return J}}throw new TypeError}function Ne(P){return!!P}function Ie(P){return""+P}function tt(P){var N=le(P);return ye(N)?N:Ie(N)}function bt(P){return Array.isArray?Array.isArray(P):P instanceof Object?P instanceof Array:Object.prototype.toString.call(P)==="[object Array]"}function vt(P){return typeof P=="function"}function kt(P){return typeof P=="function"}function Yt(P){switch(Y(P)){case 3:return!0;case 4:return!0;default:return!1}}function wn(P,N){return P===N||P!==P&&N!==N}function Au(P,N){var R=P[N];if(R!=null){if(!vt(R))throw new TypeError;return R}}function Vc(P){var N=Au(P,o);if(!vt(N))throw new TypeError;var R=N.call(P);if(!de(R))throw new TypeError;return R}function Xh(P){return P.value}function Zh(P){var N=P.next();return N.done?!1:N}function Cu(P){var N=P.return;N&&N.call(P)}function Kc(P){var N=Object.getPrototypeOf(P);if(typeof P!="function"||P===h||N!==h)return N;var R=P.prototype,J=R&&Object.getPrototypeOf(R);if(J==null||J===Object.prototype)return N;var he=J.constructor;return typeof he!="function"||he===P?N:he}function Vi(){var P;!H(g)&&typeof t.Reflect<"u"&&!(g in t.Reflect)&&typeof t.Reflect.defineMetadata=="function"&&(P=Xs(t.Reflect));var N,R,J,he=new f,Me={registerProvider:Fe,getProvider:pe,setProvider:Se};return Me;function Fe(xe){if(!Object.isExtensible(Me))throw new Error("Cannot add provider to a frozen registry.");switch(!0){case P===xe:break;case H(N):N=xe;break;case N===xe:break;case H(R):R=xe;break;case R===xe:break;default:J===void 0&&(J=new m),J.add(xe);break}}function ve(xe,Qe){if(!H(N)){if(N.isProviderFor(xe,Qe))return N;if(!H(R)){if(R.isProviderFor(xe,Qe))return N;if(!H(J))for(var $t=Vc(J);;){var Jt=Zh($t);if(!Jt)return;var ws=Xh(Jt);if(ws.isProviderFor(xe,Qe))return Cu($t),ws}}}if(!H(P)&&P.isProviderFor(xe,Qe))return P}function pe(xe,Qe){var $t=he.get(xe),Jt;return H($t)||(Jt=$t.get(Qe)),H(Jt)&&(Jt=ve(xe,Qe),H(Jt)||(H($t)&&($t=new p,he.set(xe,$t)),$t.set(Qe,Jt))),Jt}function be(xe){if(H(xe))throw new TypeError;return N===xe||R===xe||!H(J)&&J.has(xe)}function Se(xe,Qe,$t){if(!be($t))throw new Error("Metadata provider not registered.");var Jt=pe(xe,Qe);if(Jt!==$t){if(!H(Jt))return!1;var ws=he.get(xe);H(ws)&&(ws=new p,he.set(xe,ws)),ws.set(Qe,$t)}return!0}}function f0(){var P;return!H(g)&&de(t.Reflect)&&Object.isExtensible(t.Reflect)&&(P=t.Reflect[g]),H(P)&&(P=Vi()),!H(g)&&de(t.Reflect)&&Object.isExtensible(t.Reflect)&&Object.defineProperty(t.Reflect,g,{enumerable:!1,configurable:!1,writable:!1,value:P}),P}function NA(P){var N=new f,R={isProviderFor:function(be,Se){var xe=N.get(be);return H(xe)?!1:xe.has(Se)},OrdinaryDefineOwnMetadata:Fe,OrdinaryHasOwnMetadata:he,OrdinaryGetOwnMetadata:Me,OrdinaryOwnMetadataKeys:ve,OrdinaryDeleteMetadata:pe};return w.registerProvider(R),R;function J(be,Se,xe){var Qe=N.get(be),$t=!1;if(H(Qe)){if(!xe)return;Qe=new p,N.set(be,Qe),$t=!0}var Jt=Qe.get(Se);if(H(Jt)){if(!xe)return;if(Jt=new p,Qe.set(Se,Jt),!P.setProvider(be,Se,R))throw Qe.delete(Se),$t&&N.delete(be),new Error("Wrong provider for target.")}return Jt}function he(be,Se,xe){var Qe=J(Se,xe,!1);return H(Qe)?!1:Ne(Qe.has(be))}function Me(be,Se,xe){var Qe=J(Se,xe,!1);if(!H(Qe))return Qe.get(be)}function Fe(be,Se,xe,Qe){var $t=J(xe,Qe,!0);$t.set(be,Se)}function ve(be,Se){var xe=[],Qe=J(be,Se,!1);if(H(Qe))return xe;for(var $t=Qe.keys(),Jt=Vc($t),ws=0;;){var HH=Zh(Jt);if(!HH)return xe.length=ws,xe;var tCe=Xh(HH);try{xe[ws]=tCe}catch(rCe){try{Cu(Jt)}finally{throw rCe}}ws++}}function pe(be,Se,xe){var Qe=J(Se,xe,!1);if(H(Qe)||!Qe.delete(be))return!1;if(Qe.size===0){var $t=N.get(Se);H($t)||($t.delete(xe),$t.size===0&&N.delete($t))}return!0}}function Xs(P){var N=P.defineMetadata,R=P.hasOwnMetadata,J=P.getOwnMetadata,he=P.getOwnMetadataKeys,Me=P.deleteMetadata,Fe=new f,ve={isProviderFor:function(pe,be){var Se=Fe.get(pe);return!H(Se)&&Se.has(be)?!0:he(pe,be).length?(H(Se)&&(Se=new m,Fe.set(pe,Se)),Se.add(be),!0):!1},OrdinaryDefineOwnMetadata:N,OrdinaryHasOwnMetadata:R,OrdinaryGetOwnMetadata:J,OrdinaryOwnMetadataKeys:he,OrdinaryDeleteMetadata:Me};return ve}function Iu(P,N,R){var J=w.getProvider(P,N);if(!H(J))return J;if(R){if(w.setProvider(P,N,y))return y;throw new Error("Illegal state.")}}function D(){var P={},N=[],R=function(){function ve(pe,be,Se){this._index=0,this._keys=pe,this._values=be,this._selector=Se}return ve.prototype["@@iterator"]=function(){return this},ve.prototype[o]=function(){return this},ve.prototype.next=function(){var pe=this._index;if(pe>=0&&pe<this._keys.length){var be=this._selector(this._keys[pe],this._values[pe]);return pe+1>=this._keys.length?(this._index=-1,this._keys=N,this._values=N):this._index++,{value:be,done:!1}}return{value:void 0,done:!0}},ve.prototype.throw=function(pe){throw this._index>=0&&(this._index=-1,this._keys=N,this._values=N),pe},ve.prototype.return=function(pe){return this._index>=0&&(this._index=-1,this._keys=N,this._values=N),{value:pe,done:!0}},ve}(),J=function(){function ve(){this._keys=[],this._values=[],this._cacheKey=P,this._cacheIndex=-2}return Object.defineProperty(ve.prototype,"size",{get:function(){return this._keys.length},enumerable:!0,configurable:!0}),ve.prototype.has=function(pe){return this._find(pe,!1)>=0},ve.prototype.get=function(pe){var be=this._find(pe,!1);return be>=0?this._values[be]:void 0},ve.prototype.set=function(pe,be){var Se=this._find(pe,!0);return this._values[Se]=be,this},ve.prototype.delete=function(pe){var be=this._find(pe,!1);if(be>=0){for(var Se=this._keys.length,xe=be+1;xe<Se;xe++)this._keys[xe-1]=this._keys[xe],this._values[xe-1]=this._values[xe];return this._keys.length--,this._values.length--,wn(pe,this._cacheKey)&&(this._cacheKey=P,this._cacheIndex=-2),!0}return!1},ve.prototype.clear=function(){this._keys.length=0,this._values.length=0,this._cacheKey=P,this._cacheIndex=-2},ve.prototype.keys=function(){return new R(this._keys,this._values,he)},ve.prototype.values=function(){return new R(this._keys,this._values,Me)},ve.prototype.entries=function(){return new R(this._keys,this._values,Fe)},ve.prototype["@@iterator"]=function(){return this.entries()},ve.prototype[o]=function(){return this.entries()},ve.prototype._find=function(pe,be){if(!wn(this._cacheKey,pe)){this._cacheIndex=-1;for(var Se=0;Se<this._keys.length;Se++)if(wn(this._keys[Se],pe)){this._cacheIndex=Se;break}}return this._cacheIndex<0&&be&&(this._cacheIndex=this._keys.length,this._keys.push(pe),this._values.push(void 0)),this._cacheIndex},ve}();return J;function he(ve,pe){return ve}function Me(ve,pe){return pe}function Fe(ve,pe){return[ve,pe]}}function S(){var P=function(){function N(){this._map=new p}return Object.defineProperty(N.prototype,"size",{get:function(){return this._map.size},enumerable:!0,configurable:!0}),N.prototype.has=function(R){return this._map.has(R)},N.prototype.add=function(R){return this._map.set(R,R),this},N.prototype.delete=function(R){return this._map.delete(R)},N.prototype.clear=function(){this._map.clear()},N.prototype.keys=function(){return this._map.keys()},N.prototype.values=function(){return this._map.keys()},N.prototype.entries=function(){return this._map.entries()},N.prototype["@@iterator"]=function(){return this.keys()},N.prototype[o]=function(){return this.keys()},N}();return P}function A(){var P=16,N=d.create(),R=J();return function(){function pe(){this._key=J()}return pe.prototype.has=function(be){var Se=he(be,!1);return Se!==void 0?d.has(Se,this._key):!1},pe.prototype.get=function(be){var Se=he(be,!1);return Se!==void 0?d.get(Se,this._key):void 0},pe.prototype.set=function(be,Se){var xe=he(be,!0);return xe[this._key]=Se,this},pe.prototype.delete=function(be){var Se=he(be,!1);return Se!==void 0?delete Se[this._key]:!1},pe.prototype.clear=function(){this._key=J()},pe}();function J(){var pe;do pe="@@WeakMap@@"+ve();while(d.has(N,pe));return N[pe]=!0,pe}function he(pe,be){if(!n.call(pe,R)){if(!be)return;Object.defineProperty(pe,R,{value:d.create()})}return pe[R]}function Me(pe,be){for(var Se=0;Se<be;++Se)pe[Se]=Math.random()*255|0;return pe}function Fe(pe){if(typeof Uint8Array=="function"){var be=new Uint8Array(pe);return typeof crypto<"u"?crypto.getRandomValues(be):typeof msCrypto<"u"?msCrypto.getRandomValues(be):Me(be,pe),be}return Me(new Array(pe),pe)}function ve(){var pe=Fe(P);pe[6]=pe[6]&79|64,pe[8]=pe[8]&191|128;for(var be="",Se=0;Se<P;++Se){var xe=pe[Se];(Se===4||Se===6||Se===8)&&(be+="-"),xe<16&&(be+="0"),be+=xe.toString(16).toLowerCase()}return be}}function M(P){return P.__=void 0,delete P.__,P}})})(_F||(_F={}));var X;(function(r){r[r.Sequence=0]="Sequence",r[r.Set=1]="Set",r[r.Choice=2]="Choice"})(X||(X={}));var F;(function(r){r[r.Any=1]="Any",r[r.Boolean=2]="Boolean",r[r.OctetString=3]="OctetString",r[r.BitString=4]="BitString",r[r.Integer=5]="Integer",r[r.Enumerated=6]="Enumerated",r[r.ObjectIdentifier=7]="ObjectIdentifier",r[r.Utf8String=8]="Utf8String",r[r.BmpString=9]="BmpString",r[r.UniversalString=10]="UniversalString",r[r.NumericString=11]="NumericString",r[r.PrintableString=12]="PrintableString",r[r.TeletexString=13]="TeletexString",r[r.VideotexString=14]="VideotexString",r[r.IA5String=15]="IA5String",r[r.GraphicString=16]="GraphicString",r[r.VisibleString=17]="VisibleString",r[r.GeneralString=18]="GeneralString",r[r.CharacterString=19]="CharacterString",r[r.UTCTime=20]="UTCTime",r[r.GeneralizedTime=21]="GeneralizedTime",r[r.DATE=22]="DATE",r[r.TimeOfDay=23]="TimeOfDay",r[r.DateTime=24]="DateTime",r[r.Duration=25]="Duration",r[r.TIME=26]="TIME",r[r.Null=27]="Null"})(F||(F={}));class Z3{constructor(e,t=0){if(this.unusedBits=0,this.value=new ArrayBuffer(0),e)if(typeof e=="number")this.fromNumber(e);else if(ue.isBufferSource(e))this.unusedBits=t,this.value=ue.toArrayBuffer(e);else throw TypeError("Unsupported type of 'params' argument for BitString")}fromASN(e){if(!(e instanceof eu))throw new TypeError("Argument 'asn' is not instance of ASN.1 BitString");return this.unusedBits=e.valueBlock.unusedBits,this.value=e.valueBlock.valueHex,this}toASN(){return new eu({unusedBits:this.unusedBits,valueHex:this.value})}toSchema(e){return new eu({name:e})}toNumber(){let e="";const t=new Uint8Array(this.value);for(const n of t)e+=n.toString(2).padStart(8,"0");return e=e.split("").reverse().join(""),this.unusedBits&&(e=e.slice(this.unusedBits).padStart(this.unusedBits,"0")),parseInt(e,2)}fromNumber(e){let t=e.toString(2);const n=t.length+7>>3;this.unusedBits=(n<<3)-t.length;const i=new Uint8Array(n);t=t.padStart(n<<3,"0").split("").reverse().join("");let s=0;for(;s<n;)i[s]=parseInt(t.slice(s<<3,(s<<3)+8),2),s++;this.value=i.buffer}}class Ze{get byteLength(){return this.buffer.byteLength}get byteOffset(){return 0}constructor(e){typeof e=="number"?this.buffer=new ArrayBuffer(e):ue.isBufferSource(e)?this.buffer=ue.toArrayBuffer(e):Array.isArray(e)?this.buffer=new Uint8Array(e):this.buffer=new ArrayBuffer(0)}fromASN(e){if(!(e instanceof us))throw new TypeError("Argument 'asn' is not instance of ASN.1 OctetString");return this.buffer=e.valueBlock.valueHex,this}toASN(){return new us({valueHex:this.buffer})}toSchema(e){return new us({name:e})}}const G6e={fromASN:r=>r instanceof Ho?null:r.valueBeforeDecodeView,toASN:r=>{if(r===null)return new Ho;const e=jo(r);if(e.result.error)throw new Error(e.result.error);return e.result}},Q6e={fromASN:r=>r.valueBlock.valueHexView.byteLength>=4?r.valueBlock.toString():r.valueBlock.valueDec,toASN:r=>new qo({value:+r})},Y6e={fromASN:r=>r.valueBlock.valueDec,toASN:r=>new L3({value:r})},Dt={fromASN:r=>r.valueBlock.valueHexView,toASN:r=>new qo({valueHex:r})},J6e={fromASN:r=>r.valueBlock.valueHexView,toASN:r=>new eu({valueHex:r})},X6e={fromASN:r=>r.valueBlock.toString(),toASN:r=>new Wo({value:r})},Z6e={fromASN:r=>r.valueBlock.value,toASN:r=>new R3({value:r})},ew={fromASN:r=>r.valueBlock.valueHexView,toASN:r=>new us({valueHex:r})},ebe={fromASN:r=>new Ze(r.getValue()),toASN:r=>r.toASN()};function Di(r){return{fromASN:e=>e.valueBlock.value,toASN:e=>new r({value:e})}}const TF=Di(Qo),tbe=Di(B3),rbe=Di(U3),nbe=Di(F3),ibe=Di(z3),sbe=Di(V3),obe=Di(K3),abe=Di(j3),cbe=Di(H3),lbe=Di(vp),ube=Di(q3),dbe=Di(W3),hbe={fromASN:r=>r.toDate(),toASN:r=>new Ep({valueDate:r})},fbe={fromASN:r=>r.toDate(),toASN:r=>new G3({valueDate:r})},pbe={fromASN:()=>null,toASN:()=>new Ho};function GE(r){switch(r){case F.Any:return G6e;case F.BitString:return J6e;case F.BmpString:return tbe;case F.Boolean:return Z6e;case F.CharacterString:return dbe;case F.Enumerated:return Y6e;case F.GeneralString:return ube;case F.GeneralizedTime:return fbe;case F.GraphicString:return cbe;case F.IA5String:return abe;case F.Integer:return Q6e;case F.Null:return pbe;case F.NumericString:return nbe;case F.ObjectIdentifier:return X6e;case F.OctetString:return ew;case F.PrintableString:return ibe;case F.TeletexString:return sbe;case F.UTCTime:return hbe;case F.UniversalString:return rbe;case F.Utf8String:return TF;case F.VideotexString:return obe;case F.VisibleString:return lbe;default:return null}}function Yo(r){return typeof r=="function"&&r.prototype?r.prototype.toASN&&r.prototype.fromASN?!0:Yo(r.prototype):!!(r&&typeof r=="object"&&"toASN"in r&&"fromASN"in r)}function PF(r){var e;if(r){const t=Object.getPrototypeOf(r);return((e=t==null?void 0:t.prototype)===null||e===void 0?void 0:e.constructor)===Array?!0:PF(t)}return!1}function gbe(r,e){if(!(r&&e)||r.byteLength!==e.byteLength)return!1;const t=new Uint8Array(r),n=new Uint8Array(e);for(let i=0;i<r.byteLength;i++)if(t[i]!==n[i])return!1;return!0}class ybe{constructor(){this.items=new WeakMap}has(e){return this.items.has(e)}get(e,t=!1){const n=this.items.get(e);if(!n)throw new Error(`Cannot get schema for '${e.prototype.constructor.name}' target`);if(t&&!n.schema)throw new Error(`Schema '${e.prototype.constructor.name}' doesn't contain ASN.1 schema. Call 'AsnSchemaStorage.cache'.`);return n}cache(e){const t=this.get(e);t.schema||(t.schema=this.create(e,!0))}createDefault(e){const t={type:X.Sequence,items:{}},n=this.findParentSchema(e);return n&&(Object.assign(t,n),t.items=Object.assign({},t.items,n.items)),t}create(e,t){const n=this.items.get(e)||this.createDefault(e),i=[];for(const s in n.items){const o=n.items[s],a=t?s:"";let c;if(typeof o.type=="number"){const d=F[o.type],h=rF[d];if(!h)throw new Error(`Cannot get ASN1 class by name '${d}'`);c=new h({name:a})}else Yo(o.type)?c=new o.type().toSchema(a):o.optional?this.get(o.type).type===X.Choice?c=new tu({name:a}):(c=this.create(o.type,!1),c.name=a):c=new tu({name:a});const l=!!o.optional||o.defaultValue!==void 0;if(o.repeated){c.name="";const d=o.repeated==="set"?Go:gr;c=new d({name:"",value:[new Q3({name:a,value:c})]})}if(o.context!==null&&o.context!==void 0)if(o.implicit)if(typeof o.type=="number"||Yo(o.type)){const d=o.repeated?Tn:wp;i.push(new d({name:a,optional:l,idBlock:{tagClass:3,tagNumber:o.context}}))}else{this.cache(o.type);const d=!!o.repeated;let h=d?c:this.get(o.type,!0).schema;h="valueBlock"in h?h.valueBlock.value:h.value,i.push(new Tn({name:d?"":a,optional:l,idBlock:{tagClass:3,tagNumber:o.context},value:h}))}else i.push(new Tn({optional:l,idBlock:{tagClass:3,tagNumber:o.context},value:[c]}));else c.optional=l,i.push(c)}switch(n.type){case X.Sequence:return new gr({value:i,name:""});case X.Set:return new Go({value:i,name:""});case X.Choice:return new ME({value:i,name:""});default:throw new Error("Unsupported ASN1 type in use")}}set(e,t){return this.items.set(e,t),this}findParentSchema(e){const t=Object.getPrototypeOf(e);return t?this.items.get(t)||this.findParentSchema(t):null}}const $i=new ybe,te=r=>e=>{let t;$i.has(e)?t=$i.get(e):(t=$i.createDefault(e),$i.set(e,t)),Object.assign(t,r)},$=r=>(e,t)=>{let n;$i.has(e.constructor)?n=$i.get(e.constructor):(n=$i.createDefault(e.constructor),$i.set(e.constructor,n));const i=Object.assign({},r);if(typeof i.type=="number"&&!i.converter){const s=GE(r.type);if(!s)throw new Error(`Cannot get default converter for property '${t}' of ${e.constructor.name}`);i.converter=s}n.items[t]=i};class DF extends Error{constructor(){super(...arguments),this.schemas=[]}}class mbe{static parse(e,t){const n=jo(e);if(n.result.error)throw new Error(n.result.error);return this.fromASN(n.result,t)}static fromASN(e,t){var n;try{if(Yo(t))return new t().fromASN(e);const i=$i.get(t);$i.cache(t);let s=i.schema;if(e.constructor===Tn&&i.type!==X.Choice){s=new Tn({idBlock:{tagClass:3,tagNumber:e.idBlock.tagNumber},value:i.schema.valueBlock.value});for(const c in i.items)delete e[c]}const o=ru({},e,s);if(!o.verified)throw new DF(`Data does not match to ${t.name} ASN1 schema. ${o.result.error}`);const a=new t;if(PF(t)){if(!("value"in e.valueBlock&&Array.isArray(e.valueBlock.value)))throw new Error("Cannot get items from the ASN.1 parsed value. ASN.1 object is not constructed.");const c=i.itemType;if(typeof c=="number"){const l=GE(c);if(!l)throw new Error(`Cannot get default converter for array item of ${t.name} ASN1 schema`);return t.from(e.valueBlock.value,d=>l.fromASN(d))}else return t.from(e.valueBlock.value,l=>this.fromASN(l,c))}for(const c in i.items){const l=o.result[c];if(!l)continue;const d=i.items[c],h=d.type;if(typeof h=="number"||Yo(h)){const p=(n=d.converter)!==null&&n!==void 0?n:Yo(h)?new h:null;if(!p)throw new Error("Converter is empty");if(d.repeated)if(d.implicit){const m=d.repeated==="sequence"?gr:Go,f=new m;f.valueBlock=l.valueBlock;const g=jo(f.toBER(!1));if(g.offset===-1)throw new Error(`Cannot parse the child item. ${g.result.error}`);if(!("value"in g.result.valueBlock&&Array.isArray(g.result.valueBlock.value)))throw new Error("Cannot get items from the ASN.1 parsed value. ASN.1 object is not constructed.");const w=g.result.valueBlock.value;a[c]=Array.from(w,y=>p.fromASN(y))}else a[c]=Array.from(l,m=>p.fromASN(m));else{let m=l;if(d.implicit){let f;if(Yo(h))f=new h().toSchema("");else{const g=F[h],w=rF[g];if(!w)throw new Error(`Cannot get '${g}' class from asn1js module`);f=new w}f.valueBlock=m.valueBlock,m=jo(f.toBER(!1)).result}a[c]=p.fromASN(m)}}else if(d.repeated){if(!Array.isArray(l))throw new Error("Cannot get list of items from the ASN.1 parsed value. ASN.1 value should be iterable.");a[c]=Array.from(l,p=>this.fromASN(p,h))}else a[c]=this.fromASN(l,h)}return a}catch(i){throw i instanceof DF&&i.schemas.push(t.name),i}}}class QE{static serialize(e){return e instanceof Ar?e.toBER(!1):this.toASN(e).toBER(!1)}static toASN(e){if(e&&typeof e=="object"&&Yo(e))return e.toASN();if(!(e&&typeof e=="object"))throw new TypeError("Parameter 1 should be type of Object.");const t=e.constructor,n=$i.get(t);$i.cache(t);let i=[];if(n.itemType){if(!Array.isArray(e))throw new TypeError("Parameter 1 should be type of Array.");if(typeof n.itemType=="number"){const o=GE(n.itemType);if(!o)throw new Error(`Cannot get default converter for array item of ${t.name} ASN1 schema`);i=e.map(a=>o.toASN(a))}else i=e.map(o=>this.toAsnItem({type:n.itemType},"[]",t,o))}else for(const o in n.items){const a=n.items[o],c=e[o];if(c===void 0||a.defaultValue===c||typeof a.defaultValue=="object"&&typeof c=="object"&&gbe(this.serialize(a.defaultValue),this.serialize(c)))continue;const l=QE.toAsnItem(a,o,t,c);if(typeof a.context=="number")if(a.implicit)if(!a.repeated&&(typeof a.type=="number"||Yo(a.type))){const d={};d.valueHex=l instanceof Ho?l.valueBeforeDecodeView:l.valueBlock.toBER(),i.push(new wp({optional:a.optional,idBlock:{tagClass:3,tagNumber:a.context},...d}))}else i.push(new Tn({optional:a.optional,idBlock:{tagClass:3,tagNumber:a.context},value:l.valueBlock.value}));else i.push(new Tn({optional:a.optional,idBlock:{tagClass:3,tagNumber:a.context},value:[l]}));else a.repeated?i=i.concat(l):i.push(l)}let s;switch(n.type){case X.Sequence:s=new gr({value:i});break;case X.Set:s=new Go({value:i});break;case X.Choice:if(!i[0])throw new Error(`Schema '${t.name}' has wrong data. Choice cannot be empty.`);s=i[0];break}return s}static toAsnItem(e,t,n,i){let s;if(typeof e.type=="number"){const o=e.converter;if(!o)throw new Error(`Property '${t}' doesn't have converter for type ${F[e.type]} in schema '${n.name}'`);if(e.repeated){if(!Array.isArray(i))throw new TypeError("Parameter 'objProp' should be type of Array.");const a=Array.from(i,l=>o.toASN(l)),c=e.repeated==="sequence"?gr:Go;s=new c({value:a})}else s=o.toASN(i)}else if(e.repeated){if(!Array.isArray(i))throw new TypeError("Parameter 'objProp' should be type of Array.");const o=Array.from(i,c=>this.toASN(c)),a=e.repeated==="sequence"?gr:Go;s=new a({value:o})}else s=this.toASN(i);return s}}class dt extends Array{constructor(e=[]){if(typeof e=="number")super(e);else{super();for(const t of e)this.push(t)}}}class ae{static serialize(e){return QE.serialize(e)}static parse(e,t){return mbe.parse(e,t)}static toString(e){const t=ue.isBufferSource(e)?ue.toArrayBuffer(e):ae.serialize(e),n=jo(t);if(n.offset===-1)throw new Error(`Cannot decode ASN.1 data. ${n.result.error}`);return n.result.toString()}}function _(r,e,t,n){var i=arguments.length,s=i<3?e:n===null?n=Object.getOwnPropertyDescriptor(e,t):n,o;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(r,e,t,n);else for(var a=r.length-1;a>=0;a--)(o=r[a])&&(s=(i<3?o(s):i>3?o(e,t,s):o(e,t))||s);return i>3&&s&&Object.defineProperty(e,t,s),s}typeof SuppressedError=="function"&&SuppressedError;class $F{static isIPv4(e){return/^(\d{1,3}\.){3}\d{1,3}$/.test(e)}static parseIPv4(e){const t=e.split(".");if(t.length!==4)throw new Error("Invalid IPv4 address");return t.map(n=>{const i=parseInt(n,10);if(isNaN(i)||i<0||i>255)throw new Error("Invalid IPv4 address part");return i})}static parseIPv6(e){const n=this.expandIPv6(e).split(":");if(n.length!==8)throw new Error("Invalid IPv6 address");return n.reduce((i,s)=>{const o=parseInt(s,16);if(isNaN(o)||o<0||o>65535)throw new Error("Invalid IPv6 address part");return i.push(o>>8&255),i.push(o&255),i},[])}static expandIPv6(e){if(!e.includes("::"))return e;const t=e.split("::");if(t.length>2)throw new Error("Invalid IPv6 address");const n=t[0]?t[0].split(":"):[],i=t[1]?t[1].split(":"):[],s=8-(n.length+i.length);if(s<0)throw new Error("Invalid IPv6 address");return[...n,...Array(s).fill("0"),...i].join(":")}static formatIPv6(e){const t=[];for(let n=0;n<16;n+=2)t.push((e[n]<<8|e[n+1]).toString(16));return this.compressIPv6(t.join(":"))}static compressIPv6(e){const t=e.split(":");let n=-1,i=0,s=-1,o=0;for(let a=0;a<t.length;a++)t[a]==="0"?(s===-1&&(s=a),o++):(o>i&&(n=s,i=o),s=-1,o=0);if(o>i&&(n=s,i=o),i>1){const a=t.slice(0,n).join(":"),c=t.slice(n+i).join(":");return`${a}::${c}`}return e}static parseCIDR(e){const[t,n]=e.split("/"),i=parseInt(n,10);if(this.isIPv4(t)){if(i<0||i>32)throw new Error("Invalid IPv4 prefix length");return[this.parseIPv4(t),i]}else{if(i<0||i>128)throw new Error("Invalid IPv6 prefix length");return[this.parseIPv6(t),i]}}static decodeIP(e){if(e.length===64&&parseInt(e,16)===0)return"::/0";if(e.length!==16)return e;const t=parseInt(e.slice(8),16).toString(2).split("").reduce((i,s)=>i+ +s,0);let n=e.slice(0,8).replace(/(.{2})/g,i=>`${parseInt(i,16)}.`);return n=n.slice(0,-1),`${n}/${t}`}static toString(e){const t=new Uint8Array(e);if(t.length===4)return Array.from(t).join(".");if(t.length===16)return this.formatIPv6(t);if(t.length===8||t.length===32){const n=t.length/2,i=t.slice(0,n),s=t.slice(n);if(t.every(c=>c===0))return t.length===8?"0.0.0.0/0":"::/0";const a=s.reduce((c,l)=>c+(l.toString(2).match(/1/g)||[]).length,0);return t.length===8?`${Array.from(i).join(".")}/${a}`:`${this.formatIPv6(i)}/${a}`}return this.decodeIP(Ee.ToHex(e))}static fromString(e){if(e.includes("/")){const[n,i]=this.parseCIDR(e),s=new Uint8Array(n.length);let o=i;for(let c=0;c<s.length;c++)o>=8?(s[c]=255,o-=8):o>0&&(s[c]=255<<8-o,o=0);const a=new Uint8Array(n.length*2);return a.set(n,0),a.set(s,n.length),a.buffer}const t=this.isIPv4(e)?this.parseIPv4(e):this.parseIPv6(e);return new Uint8Array(t).buffer}}var YE,JE,XE;let Ir=class{constructor(e={}){Object.assign(this,e)}toString(){return this.bmpString||this.printableString||this.teletexString||this.universalString||this.utf8String||""}};_([$({type:F.TeletexString})],Ir.prototype,"teletexString",void 0),_([$({type:F.PrintableString})],Ir.prototype,"printableString",void 0),_([$({type:F.UniversalString})],Ir.prototype,"universalString",void 0),_([$({type:F.Utf8String})],Ir.prototype,"utf8String",void 0),_([$({type:F.BmpString})],Ir.prototype,"bmpString",void 0),Ir=_([te({type:X.Choice})],Ir);let fh=class extends Ir{constructor(e={}){super(e),Object.assign(this,e)}toString(){return this.ia5String||(this.anyValue?Ee.ToHex(this.anyValue):super.toString())}};_([$({type:F.IA5String})],fh.prototype,"ia5String",void 0),_([$({type:F.Any})],fh.prototype,"anyValue",void 0),fh=_([te({type:X.Choice})],fh);class tw{constructor(e={}){this.type="",this.value=new fh,Object.assign(this,e)}}_([$({type:F.ObjectIdentifier})],tw.prototype,"type",void 0),_([$({type:fh})],tw.prototype,"value",void 0);let ph=YE=class extends dt{constructor(e){super(e),Object.setPrototypeOf(this,YE.prototype)}};ph=YE=_([te({type:X.Set,itemType:tw})],ph);let ZE=JE=class extends dt{constructor(e){super(e),Object.setPrototypeOf(this,JE.prototype)}};ZE=JE=_([te({type:X.Sequence,itemType:ph})],ZE);let Qt=XE=class extends ZE{constructor(e){super(e),Object.setPrototypeOf(this,XE.prototype)}};Qt=XE=_([te({type:X.Sequence})],Qt);const wbe={fromASN:r=>$F.toString(ew.fromASN(r)),toASN:r=>ew.toASN($F.fromString(r))};class Cp{constructor(e={}){this.typeId="",this.value=new ArrayBuffer(0),Object.assign(this,e)}}_([$({type:F.ObjectIdentifier})],Cp.prototype,"typeId",void 0),_([$({type:F.Any,context:0})],Cp.prototype,"value",void 0);class eS{constructor(e={}){this.partyName=new Ir,Object.assign(this,e)}}_([$({type:Ir,optional:!0,context:0,implicit:!0})],eS.prototype,"nameAssigner",void 0),_([$({type:Ir,context:1,implicit:!0})],eS.prototype,"partyName",void 0);let Be=class{constructor(e={}){Object.assign(this,e)}};_([$({type:Cp,context:0,implicit:!0})],Be.prototype,"otherName",void 0),_([$({type:F.IA5String,context:1,implicit:!0})],Be.prototype,"rfc822Name",void 0),_([$({type:F.IA5String,context:2,implicit:!0})],Be.prototype,"dNSName",void 0),_([$({type:F.Any,context:3,implicit:!0})],Be.prototype,"x400Address",void 0),_([$({type:Qt,context:4,implicit:!1})],Be.prototype,"directoryName",void 0),_([$({type:eS,context:5})],Be.prototype,"ediPartyName",void 0),_([$({type:F.IA5String,context:6,implicit:!0})],Be.prototype,"uniformResourceIdentifier",void 0),_([$({type:F.OctetString,context:7,implicit:!0,converter:wbe})],Be.prototype,"iPAddress",void 0),_([$({type:F.ObjectIdentifier,context:8,implicit:!0})],Be.prototype,"registeredID",void 0),Be=_([te({type:X.Choice})],Be);const tS="1.3.6.1.5.5.7",bbe=`${tS}.1`,gh=`${tS}.3`,rw=`${tS}.48`,NF=`${rw}.1`,MF=`${rw}.2`,OF=`${rw}.3`,RF=`${rw}.5`,Pc="2.5.29";var rS;const nS=`${bbe}.1`;class Ip{constructor(e={}){this.accessMethod="",this.accessLocation=new Be,Object.assign(this,e)}}_([$({type:F.ObjectIdentifier})],Ip.prototype,"accessMethod",void 0),_([$({type:Be})],Ip.prototype,"accessLocation",void 0);let yh=rS=class extends dt{constructor(e){super(e),Object.setPrototypeOf(this,rS.prototype)}};yh=rS=_([te({type:X.Sequence,itemType:Ip})],yh);const iS=`${Pc}.35`;class sS extends Ze{}class su{constructor(e={}){e&&Object.assign(this,e)}}_([$({type:sS,context:0,optional:!0,implicit:!0})],su.prototype,"keyIdentifier",void 0),_([$({type:Be,context:1,optional:!0,implicit:!0,repeated:"sequence"})],su.prototype,"authorityCertIssuer",void 0),_([$({type:F.Integer,context:2,optional:!0,implicit:!0,converter:Dt})],su.prototype,"authorityCertSerialNumber",void 0);const LF=`${Pc}.19`;class nw{constructor(e={}){this.cA=!1,Object.assign(this,e)}}_([$({type:F.Boolean,defaultValue:!1})],nw.prototype,"cA",void 0),_([$({type:F.Integer,optional:!0})],nw.prototype,"pathLenConstraint",void 0);var oS;let pn=oS=class extends dt{constructor(e){super(e),Object.setPrototypeOf(this,oS.prototype)}};pn=oS=_([te({type:X.Sequence,itemType:Be})],pn);var aS;let BF=aS=class extends pn{constructor(e){super(e),Object.setPrototypeOf(this,aS.prototype)}};BF=aS=_([te({type:X.Sequence})],BF);var cS;const UF=`${Pc}.32`;let Jo=class{constructor(e={}){Object.assign(this,e)}toString(){return this.ia5String||this.visibleString||this.bmpString||this.utf8String||""}};_([$({type:F.IA5String})],Jo.prototype,"ia5String",void 0),_([$({type:F.VisibleString})],Jo.prototype,"visibleString",void 0),_([$({type:F.BmpString})],Jo.prototype,"bmpString",void 0),_([$({type:F.Utf8String})],Jo.prototype,"utf8String",void 0),Jo=_([te({type:X.Choice})],Jo);class lS{constructor(e={}){this.organization=new Jo,this.noticeNumbers=[],Object.assign(this,e)}}_([$({type:Jo})],lS.prototype,"organization",void 0),_([$({type:F.Integer,repeated:"sequence"})],lS.prototype,"noticeNumbers",void 0);class uS{constructor(e={}){Object.assign(this,e)}}_([$({type:lS,optional:!0})],uS.prototype,"noticeRef",void 0),_([$({type:Jo,optional:!0})],uS.prototype,"explicitText",void 0);let iw=class{constructor(e={}){Object.assign(this,e)}};_([$({type:F.IA5String})],iw.prototype,"cPSuri",void 0),_([$({type:uS})],iw.prototype,"userNotice",void 0),iw=_([te({type:X.Choice})],iw);class dS{constructor(e={}){this.policyQualifierId="",this.qualifier=new ArrayBuffer(0),Object.assign(this,e)}}_([$({type:F.ObjectIdentifier})],dS.prototype,"policyQualifierId",void 0),_([$({type:F.Any})],dS.prototype,"qualifier",void 0);class sw{constructor(e={}){this.policyIdentifier="",Object.assign(this,e)}}_([$({type:F.ObjectIdentifier})],sw.prototype,"policyIdentifier",void 0),_([$({type:dS,repeated:"sequence",optional:!0})],sw.prototype,"policyQualifiers",void 0);let ow=cS=class extends dt{constructor(e){super(e),Object.setPrototypeOf(this,cS.prototype)}};ow=cS=_([te({type:X.Sequence,itemType:sw})],ow);let aw=class{constructor(e=0){this.value=e}};_([$({type:F.Integer})],aw.prototype,"value",void 0),aw=_([te({type:X.Choice})],aw);let FF=class extends aw{};FF=_([te({type:X.Choice})],FF);var hS;const fS=`${Pc}.31`;var hs;(function(r){r[r.unused=1]="unused",r[r.keyCompromise=2]="keyCompromise",r[r.cACompromise=4]="cACompromise",r[r.affiliationChanged=8]="affiliationChanged",r[r.superseded=16]="superseded",r[r.cessationOfOperation=32]="cessationOfOperation",r[r.certificateHold=64]="certificateHold",r[r.privilegeWithdrawn=128]="privilegeWithdrawn",r[r.aACompromise=256]="aACompromise"})(hs||(hs={}));class zF extends Z3{toJSON(){const e=[],t=this.toNumber();return t&hs.aACompromise&&e.push("aACompromise"),t&hs.affiliationChanged&&e.push("affiliationChanged"),t&hs.cACompromise&&e.push("cACompromise"),t&hs.certificateHold&&e.push("certificateHold"),t&hs.cessationOfOperation&&e.push("cessationOfOperation"),t&hs.keyCompromise&&e.push("keyCompromise"),t&hs.privilegeWithdrawn&&e.push("privilegeWithdrawn"),t&hs.superseded&&e.push("superseded"),t&hs.unused&&e.push("unused"),e}toString(){return`[${this.toJSON().join(", ")}]`}}let ou=class{constructor(e={}){Object.assign(this,e)}};_([$({type:Be,context:0,repeated:"sequence",implicit:!0})],ou.prototype,"fullName",void 0),_([$({type:ph,context:1,implicit:!0})],ou.prototype,"nameRelativeToCRLIssuer",void 0),ou=_([te({type:X.Choice})],ou);class mh{constructor(e={}){Object.assign(this,e)}}_([$({type:ou,context:0,optional:!0})],mh.prototype,"distributionPoint",void 0),_([$({type:zF,context:1,optional:!0,implicit:!0})],mh.prototype,"reasons",void 0),_([$({type:Be,context:2,optional:!0,repeated:"sequence",implicit:!0})],mh.prototype,"cRLIssuer",void 0);let wh=hS=class extends dt{constructor(e){super(e),Object.setPrototypeOf(this,hS.prototype)}};wh=hS=_([te({type:X.Sequence,itemType:mh})],wh);var pS;let VF=pS=class extends wh{constructor(e){super(e),Object.setPrototypeOf(this,pS.prototype)}};VF=pS=_([te({type:X.Sequence,itemType:mh})],VF);class zr{constructor(e={}){this.onlyContainsUserCerts=zr.ONLY,this.onlyContainsCACerts=zr.ONLY,this.indirectCRL=zr.ONLY,this.onlyContainsAttributeCerts=zr.ONLY,Object.assign(this,e)}}zr.ONLY=!1,_([$({type:ou,context:0,optional:!0})],zr.prototype,"distributionPoint",void 0),_([$({type:F.Boolean,context:1,defaultValue:zr.ONLY,implicit:!0})],zr.prototype,"onlyContainsUserCerts",void 0),_([$({type:F.Boolean,context:2,defaultValue:zr.ONLY,implicit:!0})],zr.prototype,"onlyContainsCACerts",void 0),_([$({type:zF,context:3,optional:!0,implicit:!0})],zr.prototype,"onlySomeReasons",void 0),_([$({type:F.Boolean,context:4,defaultValue:zr.ONLY,implicit:!0})],zr.prototype,"indirectCRL",void 0),_([$({type:F.Boolean,context:5,defaultValue:zr.ONLY,implicit:!0})],zr.prototype,"onlyContainsAttributeCerts",void 0);var kp;(function(r){r[r.unspecified=0]="unspecified",r[r.keyCompromise=1]="keyCompromise",r[r.cACompromise=2]="cACompromise",r[r.affiliationChanged=3]="affiliationChanged",r[r.superseded=4]="superseded",r[r.cessationOfOperation=5]="cessationOfOperation",r[r.certificateHold=6]="certificateHold",r[r.removeFromCRL=8]="removeFromCRL",r[r.privilegeWithdrawn=9]="privilegeWithdrawn",r[r.aACompromise=10]="aACompromise"})(kp||(kp={}));let gS=class{constructor(e=kp.unspecified){this.reason=kp.unspecified,this.reason=e}toJSON(){return kp[this.reason]}toString(){return this.toJSON()}};_([$({type:F.Enumerated})],gS.prototype,"reason",void 0),gS=_([te({type:X.Choice})],gS);var yS;const KF=`${Pc}.37`;let cw=yS=class extends dt{constructor(e){super(e),Object.setPrototypeOf(this,yS.prototype)}};cw=yS=_([te({type:X.Sequence,itemType:F.ObjectIdentifier})],cw);const vbe=`${gh}.1`,Ebe=`${gh}.2`,Sbe=`${gh}.3`,xbe=`${gh}.4`,Abe=`${gh}.8`,Cbe=`${gh}.9`;let mS=class{constructor(e=new ArrayBuffer(0)){this.value=e}};_([$({type:F.Integer,converter:Dt})],mS.prototype,"value",void 0),mS=_([te({type:X.Choice})],mS);let wS=class{constructor(e){this.value=new Date,e&&(this.value=e)}};_([$({type:F.GeneralizedTime})],wS.prototype,"value",void 0),wS=_([te({type:X.Choice})],wS);var bS;let jF=bS=class extends pn{constructor(e){super(e),Object.setPrototypeOf(this,bS.prototype)}};jF=bS=_([te({type:X.Sequence})],jF);const HF=`${Pc}.15`;var fs;(function(r){r[r.digitalSignature=1]="digitalSignature",r[r.nonRepudiation=2]="nonRepudiation",r[r.keyEncipherment=4]="keyEncipherment",r[r.dataEncipherment=8]="dataEncipherment",r[r.keyAgreement=16]="keyAgreement",r[r.keyCertSign=32]="keyCertSign",r[r.cRLSign=64]="cRLSign",r[r.encipherOnly=128]="encipherOnly",r[r.decipherOnly=256]="decipherOnly"})(fs||(fs={}));class vS extends Z3{toJSON(){const e=this.toNumber(),t=[];return e&fs.cRLSign&&t.push("crlSign"),e&fs.dataEncipherment&&t.push("dataEncipherment"),e&fs.decipherOnly&&t.push("decipherOnly"),e&fs.digitalSignature&&t.push("digitalSignature"),e&fs.encipherOnly&&t.push("encipherOnly"),e&fs.keyAgreement&&t.push("keyAgreement"),e&fs.keyCertSign&&t.push("keyCertSign"),e&fs.keyEncipherment&&t.push("keyEncipherment"),e&fs.nonRepudiation&&t.push("nonRepudiation"),t}toString(){return`[${this.toJSON().join(", ")}]`}}var ES;class lw{constructor(e={}){this.base=new Be,this.minimum=0,Object.assign(this,e)}}_([$({type:Be})],lw.prototype,"base",void 0),_([$({type:F.Integer,context:0,defaultValue:0,implicit:!0})],lw.prototype,"minimum",void 0),_([$({type:F.Integer,context:1,optional:!0,implicit:!0})],lw.prototype,"maximum",void 0);let uw=ES=class extends dt{constructor(e){super(e),Object.setPrototypeOf(this,ES.prototype)}};uw=ES=_([te({type:X.Sequence,itemType:lw})],uw);class qF{constructor(e={}){Object.assign(this,e)}}_([$({type:uw,context:0,optional:!0,implicit:!0})],qF.prototype,"permittedSubtrees",void 0),_([$({type:uw,context:1,optional:!0,implicit:!0})],qF.prototype,"excludedSubtrees",void 0);class WF{constructor(e={}){Object.assign(this,e)}}_([$({type:F.Integer,context:0,implicit:!0,optional:!0,converter:Dt})],WF.prototype,"requireExplicitPolicy",void 0),_([$({type:F.Integer,context:1,implicit:!0,optional:!0,converter:Dt})],WF.prototype,"inhibitPolicyMapping",void 0);var SS;class xS{constructor(e={}){this.issuerDomainPolicy="",this.subjectDomainPolicy="",Object.assign(this,e)}}_([$({type:F.ObjectIdentifier})],xS.prototype,"issuerDomainPolicy",void 0),_([$({type:F.ObjectIdentifier})],xS.prototype,"subjectDomainPolicy",void 0);let GF=SS=class extends dt{constructor(e){super(e),Object.setPrototypeOf(this,SS.prototype)}};GF=SS=_([te({type:X.Sequence,itemType:xS})],GF);var AS;const QF=`${Pc}.17`;let CS=AS=class extends pn{constructor(e){super(e),Object.setPrototypeOf(this,AS.prototype)}};CS=AS=_([te({type:X.Sequence})],CS);let Xo=class{constructor(e={}){this.type="",this.values=[],Object.assign(this,e)}};_([$({type:F.ObjectIdentifier})],Xo.prototype,"type",void 0),_([$({type:F.Any,repeated:"set"})],Xo.prototype,"values",void 0);var IS;let YF=IS=class extends dt{constructor(e){super(e),Object.setPrototypeOf(this,IS.prototype)}};YF=IS=_([te({type:X.Sequence,itemType:Xo})],YF);const JF=`${Pc}.14`;class Dc extends sS{}class XF{constructor(e={}){Object.assign(this,e)}}_([$({type:F.GeneralizedTime,context:0,implicit:!0,optional:!0})],XF.prototype,"notBefore",void 0),_([$({type:F.GeneralizedTime,context:1,implicit:!0,optional:!0})],XF.prototype,"notAfter",void 0);var _p;(function(r){r[r.keyUpdateAllowed=1]="keyUpdateAllowed",r[r.newExtensions=2]="newExtensions",r[r.pKIXCertificate=4]="pKIXCertificate"})(_p||(_p={}));class ZF extends Z3{toJSON(){const e=[],t=this.toNumber();return t&_p.pKIXCertificate&&e.push("pKIXCertificate"),t&_p.newExtensions&&e.push("newExtensions"),t&_p.keyUpdateAllowed&&e.push("keyUpdateAllowed"),e}toString(){return`[${this.toJSON().join(", ")}]`}}class ez{constructor(e={}){this.entrustVers="",this.entrustInfoFlags=new ZF,Object.assign(this,e)}}_([$({type:F.GeneralString})],ez.prototype,"entrustVers",void 0),_([$({type:ZF})],ez.prototype,"entrustInfoFlags",void 0);var kS;let tz=kS=class extends dt{constructor(e){super(e),Object.setPrototypeOf(this,kS.prototype)}};tz=kS=_([te({type:X.Sequence,itemType:Ip})],tz);class ge{constructor(e={}){this.algorithm="",Object.assign(this,e)}isEqual(e){return e instanceof ge&&e.algorithm==this.algorithm&&(e.parameters&&this.parameters&&nU(e.parameters,this.parameters)||e.parameters===this.parameters)}}_([$({type:F.ObjectIdentifier})],ge.prototype,"algorithm",void 0),_([$({type:F.Any,optional:!0})],ge.prototype,"parameters",void 0);class ps{constructor(e={}){this.algorithm=new ge,this.subjectPublicKey=new ArrayBuffer(0),Object.assign(this,e)}}_([$({type:ge})],ps.prototype,"algorithm",void 0),_([$({type:F.BitString})],ps.prototype,"subjectPublicKey",void 0);let kr=class{constructor(e){if(e)if(typeof e=="string"||typeof e=="number"||e instanceof Date){const t=new Date(e);t.getUTCFullYear()>2049?this.generalTime=t:this.utcTime=t}else Object.assign(this,e)}getTime(){const e=this.utcTime||this.generalTime;if(!e)throw new Error("Cannot get time from CHOICE object");return e}};_([$({type:F.UTCTime})],kr.prototype,"utcTime",void 0),_([$({type:F.GeneralizedTime})],kr.prototype,"generalTime",void 0),kr=_([te({type:X.Choice})],kr);class Tp{constructor(e){this.notBefore=new kr(new Date),this.notAfter=new kr(new Date),e&&(this.notBefore=new kr(e.notBefore),this.notAfter=new kr(e.notAfter))}}_([$({type:kr})],Tp.prototype,"notBefore",void 0),_([$({type:kr})],Tp.prototype,"notAfter",void 0);var _S;let Ni=class tq{constructor(e={}){this.extnID="",this.critical=tq.CRITICAL,this.extnValue=new Ze,Object.assign(this,e)}};Ni.CRITICAL=!1,_([$({type:F.ObjectIdentifier})],Ni.prototype,"extnID",void 0),_([$({type:F.Boolean,defaultValue:Ni.CRITICAL})],Ni.prototype,"critical",void 0),_([$({type:Ze})],Ni.prototype,"extnValue",void 0);let $c=_S=class extends dt{constructor(e){super(e),Object.setPrototypeOf(this,_S.prototype)}};$c=_S=_([te({type:X.Sequence,itemType:Ni})],$c);var au;(function(r){r[r.v1=0]="v1",r[r.v2=1]="v2",r[r.v3=2]="v3"})(au||(au={}));class di{constructor(e={}){this.version=au.v1,this.serialNumber=new ArrayBuffer(0),this.signature=new ge,this.issuer=new Qt,this.validity=new Tp,this.subject=new Qt,this.subjectPublicKeyInfo=new ps,Object.assign(this,e)}}_([$({type:F.Integer,context:0,defaultValue:au.v1})],di.prototype,"version",void 0),_([$({type:F.Integer,converter:Dt})],di.prototype,"serialNumber",void 0),_([$({type:ge})],di.prototype,"signature",void 0),_([$({type:Qt})],di.prototype,"issuer",void 0),_([$({type:Tp})],di.prototype,"validity",void 0),_([$({type:Qt})],di.prototype,"subject",void 0),_([$({type:ps})],di.prototype,"subjectPublicKeyInfo",void 0),_([$({type:F.BitString,context:1,implicit:!0,optional:!0})],di.prototype,"issuerUniqueID",void 0),_([$({type:F.BitString,context:2,implicit:!0,optional:!0})],di.prototype,"subjectUniqueID",void 0),_([$({type:$c,context:3,optional:!0})],di.prototype,"extensions",void 0);class cu{constructor(e={}){this.tbsCertificate=new di,this.signatureAlgorithm=new ge,this.signatureValue=new ArrayBuffer(0),Object.assign(this,e)}}_([$({type:di})],cu.prototype,"tbsCertificate",void 0),_([$({type:ge})],cu.prototype,"signatureAlgorithm",void 0),_([$({type:F.BitString})],cu.prototype,"signatureValue",void 0);class dw{constructor(e={}){this.userCertificate=new ArrayBuffer(0),this.revocationDate=new kr,Object.assign(this,e)}}_([$({type:F.Integer,converter:Dt})],dw.prototype,"userCertificate",void 0),_([$({type:kr})],dw.prototype,"revocationDate",void 0),_([$({type:Ni,optional:!0,repeated:"sequence"})],dw.prototype,"crlEntryExtensions",void 0);class Zo{constructor(e={}){this.signature=new ge,this.issuer=new Qt,this.thisUpdate=new kr,Object.assign(this,e)}}_([$({type:F.Integer,optional:!0})],Zo.prototype,"version",void 0),_([$({type:ge})],Zo.prototype,"signature",void 0),_([$({type:Qt})],Zo.prototype,"issuer",void 0),_([$({type:kr})],Zo.prototype,"thisUpdate",void 0),_([$({type:kr,optional:!0})],Zo.prototype,"nextUpdate",void 0),_([$({type:dw,repeated:"sequence",optional:!0})],Zo.prototype,"revokedCertificates",void 0),_([$({type:Ni,optional:!0,context:0,repeated:"sequence"})],Zo.prototype,"crlExtensions",void 0);class TS{constructor(e={}){this.tbsCertList=new Zo,this.signatureAlgorithm=new ge,this.signature=new ArrayBuffer(0),Object.assign(this,e)}}_([$({type:Zo})],TS.prototype,"tbsCertList",void 0),_([$({type:ge})],TS.prototype,"signatureAlgorithm",void 0),_([$({type:F.BitString})],TS.prototype,"signature",void 0);class bh{constructor(e={}){this.issuer=new Qt,this.serialNumber=new ArrayBuffer(0),Object.assign(this,e)}}_([$({type:Qt})],bh.prototype,"issuer",void 0),_([$({type:F.Integer,converter:Dt})],bh.prototype,"serialNumber",void 0);let vh=class{constructor(e={}){Object.assign(this,e)}};_([$({type:Dc,context:0,implicit:!0})],vh.prototype,"subjectKeyIdentifier",void 0),_([$({type:bh})],vh.prototype,"issuerAndSerialNumber",void 0),vh=_([te({type:X.Choice})],vh);var ea;(function(r){r[r.v0=0]="v0",r[r.v1=1]="v1",r[r.v2=2]="v2",r[r.v3=3]="v3",r[r.v4=4]="v4",r[r.v5=5]="v5"})(ea||(ea={}));let Pp=class extends ge{};Pp=_([te({type:X.Sequence})],Pp);let hw=class extends ge{};hw=_([te({type:X.Sequence})],hw);let qs=class extends ge{};qs=_([te({type:X.Sequence})],qs);let fw=class extends ge{};fw=_([te({type:X.Sequence})],fw);let rz=class extends ge{};rz=_([te({type:X.Sequence})],rz);let PS=class extends ge{};PS=_([te({type:X.Sequence})],PS);let Eh=class{constructor(e={}){this.attrType="",this.attrValues=[],Object.assign(this,e)}};_([$({type:F.ObjectIdentifier})],Eh.prototype,"attrType",void 0),_([$({type:F.Any,repeated:"set"})],Eh.prototype,"attrValues",void 0);var DS;class Ws{constructor(e={}){this.version=ea.v0,this.sid=new vh,this.digestAlgorithm=new Pp,this.signatureAlgorithm=new hw,this.signature=new Ze,Object.assign(this,e)}}_([$({type:F.Integer})],Ws.prototype,"version",void 0),_([$({type:vh})],Ws.prototype,"sid",void 0),_([$({type:Pp})],Ws.prototype,"digestAlgorithm",void 0),_([$({type:Eh,repeated:"set",context:0,implicit:!0,optional:!0})],Ws.prototype,"signedAttrs",void 0),_([$({type:hw})],Ws.prototype,"signatureAlgorithm",void 0),_([$({type:Ze})],Ws.prototype,"signature",void 0),_([$({type:Eh,repeated:"set",context:1,implicit:!0,optional:!0})],Ws.prototype,"unsignedAttrs",void 0);let pw=DS=class extends dt{constructor(e){super(e),Object.setPrototypeOf(this,DS.prototype)}};pw=DS=_([te({type:X.Set,itemType:Ws})],pw);let nz=class extends kr{};nz=_([te({type:X.Choice})],nz);let iz=class extends Ws{};iz=_([te({type:X.Sequence})],iz);class $S{constructor(e={}){this.acIssuer=new Be,this.acSerial=0,this.attrs=[],Object.assign(this,e)}}_([$({type:Be})],$S.prototype,"acIssuer",void 0),_([$({type:F.Integer})],$S.prototype,"acSerial",void 0),_([$({type:Xo,repeated:"sequence"})],$S.prototype,"attrs",void 0);var NS;let gw=NS=class extends dt{constructor(e){super(e),Object.setPrototypeOf(this,NS.prototype)}};gw=NS=_([te({type:X.Sequence,itemType:F.ObjectIdentifier})],gw);class yw{constructor(e={}){this.permitUnSpecified=!0,Object.assign(this,e)}}_([$({type:F.Integer,optional:!0})],yw.prototype,"pathLenConstraint",void 0),_([$({type:gw,implicit:!0,context:0,optional:!0})],yw.prototype,"permittedAttrs",void 0),_([$({type:gw,implicit:!0,context:1,optional:!0})],yw.prototype,"excludedAttrs",void 0),_([$({type:F.Boolean,defaultValue:!0})],yw.prototype,"permitUnSpecified",void 0);class lu{constructor(e={}){this.issuer=new pn,this.serial=new ArrayBuffer(0),this.issuerUID=new ArrayBuffer(0),Object.assign(this,e)}}_([$({type:pn})],lu.prototype,"issuer",void 0),_([$({type:F.Integer,converter:Dt})],lu.prototype,"serial",void 0),_([$({type:F.BitString,optional:!0})],lu.prototype,"issuerUID",void 0);var MS;(function(r){r[r.publicKey=0]="publicKey",r[r.publicKeyCert=1]="publicKeyCert",r[r.otherObjectTypes=2]="otherObjectTypes"})(MS||(MS={}));class uu{constructor(e={}){this.digestedObjectType=MS.publicKey,this.digestAlgorithm=new ge,this.objectDigest=new ArrayBuffer(0),Object.assign(this,e)}}_([$({type:F.Enumerated})],uu.prototype,"digestedObjectType",void 0),_([$({type:F.ObjectIdentifier,optional:!0})],uu.prototype,"otherObjectTypeID",void 0),_([$({type:ge})],uu.prototype,"digestAlgorithm",void 0),_([$({type:F.BitString})],uu.prototype,"objectDigest",void 0);class mw{constructor(e={}){Object.assign(this,e)}}_([$({type:pn,optional:!0})],mw.prototype,"issuerName",void 0),_([$({type:lu,context:0,implicit:!0,optional:!0})],mw.prototype,"baseCertificateID",void 0),_([$({type:uu,context:1,implicit:!0,optional:!0})],mw.prototype,"objectDigestInfo",void 0);let Sh=class{constructor(e={}){Object.assign(this,e)}};_([$({type:Be,repeated:"sequence"})],Sh.prototype,"v1Form",void 0),_([$({type:mw,context:0,implicit:!0})],Sh.prototype,"v2Form",void 0),Sh=_([te({type:X.Choice})],Sh);class ww{constructor(e={}){this.notBeforeTime=new Date,this.notAfterTime=new Date,Object.assign(this,e)}}_([$({type:F.GeneralizedTime})],ww.prototype,"notBeforeTime",void 0),_([$({type:F.GeneralizedTime})],ww.prototype,"notAfterTime",void 0);class Dp{constructor(e={}){Object.assign(this,e)}}_([$({type:lu,implicit:!0,context:0,optional:!0})],Dp.prototype,"baseCertificateID",void 0),_([$({type:pn,implicit:!0,context:1,optional:!0})],Dp.prototype,"entityName",void 0),_([$({type:uu,implicit:!0,context:2,optional:!0})],Dp.prototype,"objectDigestInfo",void 0);var OS;(function(r){r[r.v2=1]="v2"})(OS||(OS={}));class gs{constructor(e={}){this.version=OS.v2,this.holder=new Dp,this.issuer=new Sh,this.signature=new ge,this.serialNumber=new ArrayBuffer(0),this.attrCertValidityPeriod=new ww,this.attributes=[],Object.assign(this,e)}}_([$({type:F.Integer})],gs.prototype,"version",void 0),_([$({type:Dp})],gs.prototype,"holder",void 0),_([$({type:Sh})],gs.prototype,"issuer",void 0),_([$({type:ge})],gs.prototype,"signature",void 0),_([$({type:F.Integer,converter:Dt})],gs.prototype,"serialNumber",void 0),_([$({type:ww})],gs.prototype,"attrCertValidityPeriod",void 0),_([$({type:Xo,repeated:"sequence"})],gs.prototype,"attributes",void 0),_([$({type:F.BitString,optional:!0})],gs.prototype,"issuerUniqueID",void 0),_([$({type:$c,optional:!0})],gs.prototype,"extensions",void 0);class bw{constructor(e={}){this.acinfo=new gs,this.signatureAlgorithm=new ge,this.signatureValue=new ArrayBuffer(0),Object.assign(this,e)}}_([$({type:gs})],bw.prototype,"acinfo",void 0),_([$({type:ge})],bw.prototype,"signatureAlgorithm",void 0),_([$({type:F.BitString})],bw.prototype,"signatureValue",void 0);var vw;(function(r){r[r.unmarked=1]="unmarked",r[r.unclassified=2]="unclassified",r[r.restricted=4]="restricted",r[r.confidential=8]="confidential",r[r.secret=16]="secret",r[r.topSecret=32]="topSecret"})(vw||(vw={}));class RS extends Z3{}class LS{constructor(e={}){this.type="",this.value=new ArrayBuffer(0),Object.assign(this,e)}}_([$({type:F.ObjectIdentifier,implicit:!0,context:0})],LS.prototype,"type",void 0),_([$({type:F.Any,implicit:!0,context:1})],LS.prototype,"value",void 0);class BS{constructor(e={}){this.policyId="",this.classList=new RS(vw.unclassified),Object.assign(this,e)}}_([$({type:F.ObjectIdentifier})],BS.prototype,"policyId",void 0),_([$({type:RS,defaultValue:new RS(vw.unclassified)})],BS.prototype,"classList",void 0),_([$({type:LS,repeated:"set"})],BS.prototype,"securityCategories",void 0);class Ew{constructor(e={}){Object.assign(this,e)}}_([$({type:Ze})],Ew.prototype,"cotets",void 0),_([$({type:F.ObjectIdentifier})],Ew.prototype,"oid",void 0),_([$({type:F.Utf8String})],Ew.prototype,"string",void 0);class sz{constructor(e={}){this.values=[],Object.assign(this,e)}}_([$({type:pn,implicit:!0,context:0,optional:!0})],sz.prototype,"policyAuthority",void 0),_([$({type:Ew,repeated:"sequence"})],sz.prototype,"values",void 0);var US;class Sw{constructor(e={}){this.targetCertificate=new lu,Object.assign(this,e)}}_([$({type:lu})],Sw.prototype,"targetCertificate",void 0),_([$({type:Be,optional:!0})],Sw.prototype,"targetName",void 0),_([$({type:uu,optional:!0})],Sw.prototype,"certDigestInfo",void 0);let xh=class{constructor(e={}){Object.assign(this,e)}};_([$({type:Be,context:0,implicit:!0})],xh.prototype,"targetName",void 0),_([$({type:Be,context:1,implicit:!0})],xh.prototype,"targetGroup",void 0),_([$({type:Sw,context:2,implicit:!0})],xh.prototype,"targetCert",void 0),xh=_([te({type:X.Choice})],xh);let FS=US=class extends dt{constructor(e){super(e),Object.setPrototypeOf(this,US.prototype)}};FS=US=_([te({type:X.Sequence,itemType:xh})],FS);var zS;let oz=zS=class extends dt{constructor(e){super(e),Object.setPrototypeOf(this,zS.prototype)}};oz=zS=_([te({type:X.Sequence,itemType:FS})],oz);class az{constructor(e={}){Object.assign(this,e)}}_([$({type:pn,implicit:!0,context:0,optional:!0})],az.prototype,"roleAuthority",void 0),_([$({type:Be,implicit:!0,context:1})],az.prototype,"roleName",void 0);class VS{constructor(e={}){this.service=new Be,this.ident=new Be,Object.assign(this,e)}}_([$({type:Be})],VS.prototype,"service",void 0),_([$({type:Be})],VS.prototype,"ident",void 0),_([$({type:Ze,optional:!0})],VS.prototype,"authInfo",void 0);var KS;class jS{constructor(e={}){this.otherCertFormat="",this.otherCert=new ArrayBuffer(0),Object.assign(this,e)}}_([$({type:F.ObjectIdentifier})],jS.prototype,"otherCertFormat",void 0),_([$({type:F.Any})],jS.prototype,"otherCert",void 0);let Ah=class{constructor(e={}){Object.assign(this,e)}};_([$({type:cu})],Ah.prototype,"certificate",void 0),_([$({type:bw,context:2,implicit:!0})],Ah.prototype,"v2AttrCert",void 0),_([$({type:jS,context:3,implicit:!0})],Ah.prototype,"other",void 0),Ah=_([te({type:X.Choice})],Ah);let xw=KS=class extends dt{constructor(e){super(e),Object.setPrototypeOf(this,KS.prototype)}};xw=KS=_([te({type:X.Set,itemType:Ah})],xw);class Ch{constructor(e={}){this.contentType="",this.content=new ArrayBuffer(0),Object.assign(this,e)}}_([$({type:F.ObjectIdentifier})],Ch.prototype,"contentType",void 0),_([$({type:F.Any,context:0})],Ch.prototype,"content",void 0);let $p=class{constructor(e={}){Object.assign(this,e)}};_([$({type:Ze})],$p.prototype,"single",void 0),_([$({type:F.Any})],$p.prototype,"any",void 0),$p=_([te({type:X.Choice})],$p);class Aw{constructor(e={}){this.eContentType="",Object.assign(this,e)}}_([$({type:F.ObjectIdentifier})],Aw.prototype,"eContentType",void 0),_([$({type:$p,context:0,optional:!0})],Aw.prototype,"eContent",void 0);let Np=class{constructor(e={}){Object.assign(this,e)}};_([$({type:Ze,context:0,implicit:!0,optional:!0})],Np.prototype,"value",void 0),_([$({type:Ze,converter:ebe,context:0,implicit:!0,optional:!0,repeated:"sequence"})],Np.prototype,"constructedValue",void 0),Np=_([te({type:X.Choice})],Np);class Mp{constructor(e={}){this.contentType="",this.contentEncryptionAlgorithm=new fw,Object.assign(this,e)}}_([$({type:F.ObjectIdentifier})],Mp.prototype,"contentType",void 0),_([$({type:fw})],Mp.prototype,"contentEncryptionAlgorithm",void 0),_([$({type:Np,optional:!0})],Mp.prototype,"encryptedContent",void 0);class Cw{constructor(e={}){this.keyAttrId="",Object.assign(this,e)}}_([$({type:F.ObjectIdentifier})],Cw.prototype,"keyAttrId",void 0),_([$({type:F.Any,optional:!0})],Cw.prototype,"keyAttr",void 0);var HS;class Iw{constructor(e={}){this.subjectKeyIdentifier=new Dc,Object.assign(this,e)}}_([$({type:Dc})],Iw.prototype,"subjectKeyIdentifier",void 0),_([$({type:F.GeneralizedTime,optional:!0})],Iw.prototype,"date",void 0),_([$({type:Cw,optional:!0})],Iw.prototype,"other",void 0);let Ih=class{constructor(e={}){Object.assign(this,e)}};_([$({type:Iw,context:0,implicit:!0,optional:!0})],Ih.prototype,"rKeyId",void 0),_([$({type:bh,optional:!0})],Ih.prototype,"issuerAndSerialNumber",void 0),Ih=_([te({type:X.Choice})],Ih);class qS{constructor(e={}){this.rid=new Ih,this.encryptedKey=new Ze,Object.assign(this,e)}}_([$({type:Ih})],qS.prototype,"rid",void 0),_([$({type:Ze})],qS.prototype,"encryptedKey",void 0);let kw=HS=class extends dt{constructor(e){super(e),Object.setPrototypeOf(this,HS.prototype)}};kw=HS=_([te({type:X.Sequence,itemType:qS})],kw);class WS{constructor(e={}){this.algorithm=new ge,this.publicKey=new ArrayBuffer(0),Object.assign(this,e)}}_([$({type:ge})],WS.prototype,"algorithm",void 0),_([$({type:F.BitString})],WS.prototype,"publicKey",void 0);let du=class{constructor(e={}){Object.assign(this,e)}};_([$({type:Dc,context:0,implicit:!0,optional:!0})],du.prototype,"subjectKeyIdentifier",void 0),_([$({type:WS,context:1,implicit:!0,optional:!0})],du.prototype,"originatorKey",void 0),_([$({type:bh,optional:!0})],du.prototype,"issuerAndSerialNumber",void 0),du=_([te({type:X.Choice})],du);class kh{constructor(e={}){this.version=ea.v3,this.originator=new du,this.keyEncryptionAlgorithm=new qs,this.recipientEncryptedKeys=new kw,Object.assign(this,e)}}_([$({type:F.Integer})],kh.prototype,"version",void 0),_([$({type:du,context:0})],kh.prototype,"originator",void 0),_([$({type:Ze,context:1,optional:!0})],kh.prototype,"ukm",void 0),_([$({type:qs})],kh.prototype,"keyEncryptionAlgorithm",void 0),_([$({type:kw})],kh.prototype,"recipientEncryptedKeys",void 0);let _h=class{constructor(e={}){Object.assign(this,e)}};_([$({type:Dc,context:0,implicit:!0})],_h.prototype,"subjectKeyIdentifier",void 0),_([$({type:bh})],_h.prototype,"issuerAndSerialNumber",void 0),_h=_([te({type:X.Choice})],_h);class Op{constructor(e={}){this.version=ea.v0,this.rid=new _h,this.keyEncryptionAlgorithm=new qs,this.encryptedKey=new Ze,Object.assign(this,e)}}_([$({type:F.Integer})],Op.prototype,"version",void 0),_([$({type:_h})],Op.prototype,"rid",void 0),_([$({type:qs})],Op.prototype,"keyEncryptionAlgorithm",void 0),_([$({type:Ze})],Op.prototype,"encryptedKey",void 0);class Rp{constructor(e={}){this.keyIdentifier=new Ze,Object.assign(this,e)}}_([$({type:Ze})],Rp.prototype,"keyIdentifier",void 0),_([$({type:F.GeneralizedTime,optional:!0})],Rp.prototype,"date",void 0),_([$({type:Cw,optional:!0})],Rp.prototype,"other",void 0);class Lp{constructor(e={}){this.version=ea.v4,this.kekid=new Rp,this.keyEncryptionAlgorithm=new qs,this.encryptedKey=new Ze,Object.assign(this,e)}}_([$({type:F.Integer})],Lp.prototype,"version",void 0),_([$({type:Rp})],Lp.prototype,"kekid",void 0),_([$({type:qs})],Lp.prototype,"keyEncryptionAlgorithm",void 0),_([$({type:Ze})],Lp.prototype,"encryptedKey",void 0);class Bp{constructor(e={}){this.version=ea.v0,this.keyEncryptionAlgorithm=new qs,this.encryptedKey=new Ze,Object.assign(this,e)}}_([$({type:F.Integer})],Bp.prototype,"version",void 0),_([$({type:PS,context:0,optional:!0})],Bp.prototype,"keyDerivationAlgorithm",void 0),_([$({type:qs})],Bp.prototype,"keyEncryptionAlgorithm",void 0),_([$({type:Ze})],Bp.prototype,"encryptedKey",void 0);class GS{constructor(e={}){this.oriType="",this.oriValue=new ArrayBuffer(0),Object.assign(this,e)}}_([$({type:F.ObjectIdentifier})],GS.prototype,"oriType",void 0),_([$({type:F.Any})],GS.prototype,"oriValue",void 0);let Nc=class{constructor(e={}){Object.assign(this,e)}};_([$({type:Op,optional:!0})],Nc.prototype,"ktri",void 0),_([$({type:kh,context:1,implicit:!0,optional:!0})],Nc.prototype,"kari",void 0),_([$({type:Lp,context:2,implicit:!0,optional:!0})],Nc.prototype,"kekri",void 0),_([$({type:Bp,context:3,implicit:!0,optional:!0})],Nc.prototype,"pwri",void 0),_([$({type:GS,context:4,implicit:!0,optional:!0})],Nc.prototype,"ori",void 0),Nc=_([te({type:X.Choice})],Nc);var QS;let _w=QS=class extends dt{constructor(e){super(e),Object.setPrototypeOf(this,QS.prototype)}};_w=QS=_([te({type:X.Set,itemType:Nc})],_w);var YS;class Tw{constructor(e={}){this.otherRevInfoFormat="",this.otherRevInfo=new ArrayBuffer(0),Object.assign(this,e)}}_([$({type:F.ObjectIdentifier})],Tw.prototype,"otherRevInfoFormat",void 0),_([$({type:F.Any})],Tw.prototype,"otherRevInfo",void 0);let Pw=class{constructor(e={}){this.other=new Tw,Object.assign(this,e)}};_([$({type:Tw,context:1,implicit:!0})],Pw.prototype,"other",void 0),Pw=_([te({type:X.Choice})],Pw);let Dw=YS=class extends dt{constructor(e){super(e),Object.setPrototypeOf(this,YS.prototype)}};Dw=YS=_([te({type:X.Set,itemType:Pw})],Dw);class JS{constructor(e={}){Object.assign(this,e)}}_([$({type:xw,context:0,implicit:!0,optional:!0})],JS.prototype,"certs",void 0),_([$({type:Dw,context:1,implicit:!0,optional:!0})],JS.prototype,"crls",void 0);var XS;let ZS=XS=class extends dt{constructor(e){super(e),Object.setPrototypeOf(this,XS.prototype)}};ZS=XS=_([te({type:X.Set,itemType:Eh})],ZS);class Up{constructor(e={}){this.version=ea.v0,this.recipientInfos=new _w,this.encryptedContentInfo=new Mp,Object.assign(this,e)}}_([$({type:F.Integer})],Up.prototype,"version",void 0),_([$({type:JS,context:0,implicit:!0,optional:!0})],Up.prototype,"originatorInfo",void 0),_([$({type:_w})],Up.prototype,"recipientInfos",void 0),_([$({type:Mp})],Up.prototype,"encryptedContentInfo",void 0),_([$({type:ZS,context:1,implicit:!0,optional:!0})],Up.prototype,"unprotectedAttrs",void 0);const Ibe="1.2.840.113549.1.7.2";var ex;let $w=ex=class extends dt{constructor(e){super(e),Object.setPrototypeOf(this,ex.prototype)}};$w=ex=_([te({type:X.Set,itemType:Pp})],$w);class Th{constructor(e={}){this.version=ea.v0,this.digestAlgorithms=new $w,this.encapContentInfo=new Aw,this.signerInfos=new pw,Object.assign(this,e)}}_([$({type:F.Integer})],Th.prototype,"version",void 0),_([$({type:$w})],Th.prototype,"digestAlgorithms",void 0),_([$({type:Aw})],Th.prototype,"encapContentInfo",void 0),_([$({type:xw,context:0,implicit:!0,optional:!0})],Th.prototype,"certificates",void 0),_([$({type:Dw,context:1,implicit:!0,optional:!0})],Th.prototype,"crls",void 0),_([$({type:pw})],Th.prototype,"signerInfos",void 0);const Fp="1.2.840.10045.2.1",tx="1.2.840.10045.4.1",cz="1.2.840.10045.4.3.1",rx="1.2.840.10045.4.3.2",nx="1.2.840.10045.4.3.3",ix="1.2.840.10045.4.3.4",lz="1.2.840.10045.3.1.7",uz="1.3.132.0.34",dz="1.3.132.0.35";function zp(r){return new ge({algorithm:r})}const kbe=zp(tx);zp(cz);const _be=zp(rx),Tbe=zp(nx),Pbe=zp(ix);let Vp=class{constructor(e={}){Object.assign(this,e)}};_([$({type:F.ObjectIdentifier})],Vp.prototype,"fieldType",void 0),_([$({type:F.Any})],Vp.prototype,"parameters",void 0),Vp=_([te({type:X.Sequence})],Vp);class Dbe extends Ze{}let Ph=class{constructor(e={}){Object.assign(this,e)}};_([$({type:F.OctetString})],Ph.prototype,"a",void 0),_([$({type:F.OctetString})],Ph.prototype,"b",void 0),_([$({type:F.BitString,optional:!0})],Ph.prototype,"seed",void 0),Ph=_([te({type:X.Sequence})],Ph);var sx;(function(r){r[r.ecpVer1=1]="ecpVer1"})(sx||(sx={}));let ta=class{constructor(e={}){this.version=sx.ecpVer1,Object.assign(this,e)}};_([$({type:F.Integer})],ta.prototype,"version",void 0),_([$({type:Vp})],ta.prototype,"fieldID",void 0),_([$({type:Ph})],ta.prototype,"curve",void 0),_([$({type:Dbe})],ta.prototype,"base",void 0),_([$({type:F.Integer,converter:Dt})],ta.prototype,"order",void 0),_([$({type:F.Integer,optional:!0})],ta.prototype,"cofactor",void 0),ta=_([te({type:X.Sequence})],ta);let Mc=class{constructor(e={}){Object.assign(this,e)}};_([$({type:F.ObjectIdentifier})],Mc.prototype,"namedCurve",void 0),_([$({type:F.Null})],Mc.prototype,"implicitCurve",void 0),_([$({type:ta})],Mc.prototype,"specifiedCurve",void 0),Mc=_([te({type:X.Choice})],Mc);class Nw{constructor(e={}){this.version=1,this.privateKey=new Ze,Object.assign(this,e)}}_([$({type:F.Integer})],Nw.prototype,"version",void 0),_([$({type:Ze})],Nw.prototype,"privateKey",void 0),_([$({type:Mc,context:0,optional:!0})],Nw.prototype,"parameters",void 0),_([$({type:F.BitString,context:1,optional:!0})],Nw.prototype,"publicKey",void 0);class Mw{constructor(e={}){this.r=new ArrayBuffer(0),this.s=new ArrayBuffer(0),Object.assign(this,e)}}_([$({type:F.Integer,converter:Dt})],Mw.prototype,"r",void 0),_([$({type:F.Integer,converter:Dt})],Mw.prototype,"s",void 0);const Dn="1.2.840.113549.1.1",hu=`${Dn}.1`,$be=`${Dn}.7`,Nbe=`${Dn}.9`,Kp=`${Dn}.10`,Mbe=`${Dn}.2`,Obe=`${Dn}.4`,Ow=`${Dn}.5`,Rbe=`${Dn}.14`,ox=`${Dn}.11`,Rw=`${Dn}.12`,Lw=`${Dn}.13`,hz=`${Dn}.15`,fz=`${Dn}.16`,Bw="1.3.14.3.2.26",pz="2.16.840.1.101.3.4.2.4",Uw="2.16.840.1.101.3.4.2.1",Fw="2.16.840.1.101.3.4.2.2",zw="2.16.840.1.101.3.4.2.3",Lbe="2.16.840.1.101.3.4.2.5",Bbe="2.16.840.1.101.3.4.2.6",Ube="1.2.840.113549.2.2",Fbe="1.2.840.113549.2.5",Vw=`${Dn}.8`;function ar(r){return new ge({algorithm:r,parameters:null})}ar(Ube),ar(Fbe);const fu=ar(Bw);ar(pz),ar(Uw),ar(Fw),ar(zw),ar(Lbe),ar(Bbe);const gz=new ge({algorithm:Vw,parameters:ae.serialize(fu)}),yz=new ge({algorithm:Nbe,parameters:ae.serialize(ew.toASN(new Uint8Array([218,57,163,238,94,107,75,13,50,85,191,239,149,96,24,144,175,216,7,9]).buffer))});ar(hu),ar(Mbe),ar(Obe),ar(Ow),ar(hz),ar(fz),ar(Rw),ar(Lw),ar(hz),ar(fz);class Kw{constructor(e={}){this.hashAlgorithm=new ge(fu),this.maskGenAlgorithm=new ge({algorithm:Vw,parameters:ae.serialize(fu)}),this.pSourceAlgorithm=new ge(yz),Object.assign(this,e)}}_([$({type:ge,context:0,defaultValue:fu})],Kw.prototype,"hashAlgorithm",void 0),_([$({type:ge,context:1,defaultValue:gz})],Kw.prototype,"maskGenAlgorithm",void 0),_([$({type:ge,context:2,defaultValue:yz})],Kw.prototype,"pSourceAlgorithm",void 0),new ge({algorithm:$be,parameters:ae.serialize(new Kw)});class pu{constructor(e={}){this.hashAlgorithm=new ge(fu),this.maskGenAlgorithm=new ge({algorithm:Vw,parameters:ae.serialize(fu)}),this.saltLength=20,this.trailerField=1,Object.assign(this,e)}}_([$({type:ge,context:0,defaultValue:fu})],pu.prototype,"hashAlgorithm",void 0),_([$({type:ge,context:1,defaultValue:gz})],pu.prototype,"maskGenAlgorithm",void 0),_([$({type:F.Integer,context:2,defaultValue:20})],pu.prototype,"saltLength",void 0),_([$({type:F.Integer,context:3,defaultValue:1})],pu.prototype,"trailerField",void 0),new ge({algorithm:Kp,parameters:ae.serialize(new pu)});class jw{constructor(e={}){this.digestAlgorithm=new ge,this.digest=new Ze,Object.assign(this,e)}}_([$({type:ge})],jw.prototype,"digestAlgorithm",void 0),_([$({type:Ze})],jw.prototype,"digest",void 0);var ax;class Hw{constructor(e={}){this.prime=new ArrayBuffer(0),this.exponent=new ArrayBuffer(0),this.coefficient=new ArrayBuffer(0),Object.assign(this,e)}}_([$({type:F.Integer,converter:Dt})],Hw.prototype,"prime",void 0),_([$({type:F.Integer,converter:Dt})],Hw.prototype,"exponent",void 0),_([$({type:F.Integer,converter:Dt})],Hw.prototype,"coefficient",void 0);let cx=ax=class extends dt{constructor(e){super(e),Object.setPrototypeOf(this,ax.prototype)}};cx=ax=_([te({type:X.Sequence,itemType:Hw})],cx);class Gs{constructor(e={}){this.version=0,this.modulus=new ArrayBuffer(0),this.publicExponent=new ArrayBuffer(0),this.privateExponent=new ArrayBuffer(0),this.prime1=new ArrayBuffer(0),this.prime2=new ArrayBuffer(0),this.exponent1=new ArrayBuffer(0),this.exponent2=new ArrayBuffer(0),this.coefficient=new ArrayBuffer(0),Object.assign(this,e)}}_([$({type:F.Integer})],Gs.prototype,"version",void 0),_([$({type:F.Integer,converter:Dt})],Gs.prototype,"modulus",void 0),_([$({type:F.Integer,converter:Dt})],Gs.prototype,"publicExponent",void 0),_([$({type:F.Integer,converter:Dt})],Gs.prototype,"privateExponent",void 0),_([$({type:F.Integer,converter:Dt})],Gs.prototype,"prime1",void 0),_([$({type:F.Integer,converter:Dt})],Gs.prototype,"prime2",void 0),_([$({type:F.Integer,converter:Dt})],Gs.prototype,"exponent1",void 0),_([$({type:F.Integer,converter:Dt})],Gs.prototype,"exponent2",void 0),_([$({type:F.Integer,converter:Dt})],Gs.prototype,"coefficient",void 0),_([$({type:cx,optional:!0})],Gs.prototype,"otherPrimeInfos",void 0);class lx{constructor(e={}){this.modulus=new ArrayBuffer(0),this.publicExponent=new ArrayBuffer(0),Object.assign(this,e)}}_([$({type:F.Integer,converter:Dt})],lx.prototype,"modulus",void 0),_([$({type:F.Integer,converter:Dt})],lx.prototype,"publicExponent",void 0);var ux;(function(r){r[r.Transient=0]="Transient",r[r.Singleton=1]="Singleton",r[r.ResolutionScoped=2]="ResolutionScoped",r[r.ContainerScoped=3]="ContainerScoped"})(ux||(ux={}));const $n=ux;/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */var dx=function(r,e){return dx=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var i in n)n.hasOwnProperty(i)&&(t[i]=n[i])},dx(r,e)};function hx(r,e){dx(r,e);function t(){this.constructor=r}r.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}function zbe(r,e,t,n){function i(s){return s instanceof t?s:new t(function(o){o(s)})}return new(t||(t=Promise))(function(s,o){function a(d){try{l(n.next(d))}catch(h){o(h)}}function c(d){try{l(n.throw(d))}catch(h){o(h)}}function l(d){d.done?s(d.value):i(d.value).then(a,c)}l((n=n.apply(r,[])).next())})}function Vbe(r,e){var t={label:0,sent:function(){if(s[0]&1)throw s[1];return s[1]},trys:[],ops:[]},n,i,s,o;return o={next:a(0),throw:a(1),return:a(2)},typeof Symbol=="function"&&(o[Symbol.iterator]=function(){return this}),o;function a(l){return function(d){return c([l,d])}}function c(l){if(n)throw new TypeError("Generator is already executing.");for(;t;)try{if(n=1,i&&(s=l[0]&2?i.return:l[0]?i.throw||((s=i.return)&&s.call(i),0):i.next)&&!(s=s.call(i,l[1])).done)return s;switch(i=0,s&&(l=[l[0]&2,s.value]),l[0]){case 0:case 1:s=l;break;case 4:return t.label++,{value:l[1],done:!1};case 5:t.label++,i=l[1],l=[0];continue;case 7:l=t.ops.pop(),t.trys.pop();continue;default:if(s=t.trys,!(s=s.length>0&&s[s.length-1])&&(l[0]===6||l[0]===2)){t=0;continue}if(l[0]===3&&(!s||l[1]>s[0]&&l[1]<s[3])){t.label=l[1];break}if(l[0]===6&&t.label<s[1]){t.label=s[1],s=l;break}if(s&&t.label<s[2]){t.label=s[2],t.ops.push(l);break}s[2]&&t.ops.pop(),t.trys.pop();continue}l=e.call(r,t)}catch(d){l=[6,d],i=0}finally{n=s=0}if(l[0]&5)throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}}function qw(r){var e=typeof Symbol=="function"&&Symbol.iterator,t=e&&r[e],n=0;if(t)return t.call(r);if(r&&typeof r.length=="number")return{next:function(){return r&&n>=r.length&&(r=void 0),{value:r&&r[n++],done:!r}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function Ww(r,e){var t=typeof Symbol=="function"&&r[Symbol.iterator];if(!t)return r;var n=t.call(r),i,s=[],o;try{for(;(e===void 0||e-- >0)&&!(i=n.next()).done;)s.push(i.value)}catch(a){o={error:a}}finally{try{i&&!i.done&&(t=n.return)&&t.call(n)}finally{if(o)throw o.error}}return s}function gu(){for(var r=[],e=0;e<arguments.length;e++)r=r.concat(Ww(arguments[e]));return r}var Kbe="injectionTokens";function jbe(r){var e=Reflect.getMetadata("design:paramtypes",r)||[],t=Reflect.getOwnMetadata(Kbe,r)||{};return Object.keys(t).forEach(function(n){e[+n]=t[n]}),e}function mz(r){return!!r.useClass}function fx(r){return!!r.useFactory}var wz=function(){function r(e){this.wrap=e,this.reflectMethods=["get","getPrototypeOf","setPrototypeOf","getOwnPropertyDescriptor","defineProperty","has","set","deleteProperty","apply","construct","ownKeys"]}return r.prototype.createProxy=function(e){var t=this,n={},i=!1,s,o=function(){return i||(s=e(t.wrap()),i=!0),s};return new Proxy(n,this.createHandler(o))},r.prototype.createHandler=function(e){var t={},n=function(i){t[i]=function(){for(var s=[],o=0;o<arguments.length;o++)s[o]=arguments[o];s[0]=e();var a=Reflect[i];return a.apply(void 0,gu(s))}};return this.reflectMethods.forEach(n),t},r}();function Dh(r){return typeof r=="string"||typeof r=="symbol"}function Hbe(r){return typeof r=="object"&&"token"in r&&"multiple"in r}function bz(r){return typeof r=="object"&&"token"in r&&"transform"in r}function qbe(r){return typeof r=="function"||r instanceof wz}function Gw(r){return!!r.useToken}function Qw(r){return r.useValue!=null}function Wbe(r){return mz(r)||Qw(r)||Gw(r)||fx(r)}var px=function(){function r(){this._registryMap=new Map}return r.prototype.entries=function(){return this._registryMap.entries()},r.prototype.getAll=function(e){return this.ensure(e),this._registryMap.get(e)},r.prototype.get=function(e){this.ensure(e);var t=this._registryMap.get(e);return t[t.length-1]||null},r.prototype.set=function(e,t){this.ensure(e),this._registryMap.get(e).push(t)},r.prototype.setAll=function(e,t){this._registryMap.set(e,t)},r.prototype.has=function(e){return this.ensure(e),this._registryMap.get(e).length>0},r.prototype.clear=function(){this._registryMap.clear()},r.prototype.ensure=function(e){this._registryMap.has(e)||this._registryMap.set(e,[])},r}(),Gbe=function(r){hx(e,r);function e(){return r!==null&&r.apply(this,arguments)||this}return e}(px),Yw=function(){function r(){this.scopedResolutions=new Map}return r}();function Qbe(r,e){if(r===null)return"at position #"+e;var t=r.split(",")[e].trim();return'"'+t+'" at position #'+e}function Ybe(r,e,t){return t===void 0&&(t="    "),gu([r],e.message.split(`
`).map(function(n){return t+n})).join(`
`)}function Jbe(r,e,t){var n=Ww(r.toString().match(/constructor\(([\w, ]+)\)/)||[],2),i=n[1],s=i===void 0?null:i,o=Qbe(s,e);return Ybe("Cannot inject the dependency "+o+' of "'+r.name+'" constructor. Reason:',t)}function Xbe(r){if(typeof r.dispose!="function")return!1;var e=r.dispose;return!(e.length>0)}var Zbe=function(r){hx(e,r);function e(){return r!==null&&r.apply(this,arguments)||this}return e}(px),eve=function(r){hx(e,r);function e(){return r!==null&&r.apply(this,arguments)||this}return e}(px),tve=function(){function r(){this.preResolution=new Zbe,this.postResolution=new eve}return r}(),vz=new Map,rve=function(){function r(e){this.parent=e,this._registry=new Gbe,this.interceptors=new tve,this.disposed=!1,this.disposables=new Set}return r.prototype.register=function(e,t,n){n===void 0&&(n={lifecycle:$n.Transient}),this.ensureNotDisposed();var i;if(Wbe(t)?i=t:i={useClass:t},Gw(i))for(var s=[e],o=i;o!=null;){var a=o.useToken;if(s.includes(a))throw new Error("Token registration cycle detected! "+gu(s,[a]).join(" -> "));s.push(a);var c=this._registry.get(a);c&&Gw(c.provider)?o=c.provider:o=null}if((n.lifecycle===$n.Singleton||n.lifecycle==$n.ContainerScoped||n.lifecycle==$n.ResolutionScoped)&&(Qw(i)||fx(i)))throw new Error('Cannot use lifecycle "'+$n[n.lifecycle]+'" with ValueProviders or FactoryProviders');return this._registry.set(e,{provider:i,options:n}),this},r.prototype.registerType=function(e,t){return this.ensureNotDisposed(),Dh(t)?this.register(e,{useToken:t}):this.register(e,{useClass:t})},r.prototype.registerInstance=function(e,t){return this.ensureNotDisposed(),this.register(e,{useValue:t})},r.prototype.registerSingleton=function(e,t){if(this.ensureNotDisposed(),Dh(e)){if(Dh(t))return this.register(e,{useToken:t},{lifecycle:$n.Singleton});if(t)return this.register(e,{useClass:t},{lifecycle:$n.Singleton});throw new Error('Cannot register a type name as a singleton without a "to" token')}var n=e;return t&&!Dh(t)&&(n=t),this.register(e,{useClass:n},{lifecycle:$n.Singleton})},r.prototype.resolve=function(e,t,n){t===void 0&&(t=new Yw),n===void 0&&(n=!1),this.ensureNotDisposed();var i=this.getRegistration(e);if(!i&&Dh(e)){if(n)return;throw new Error('Attempted to resolve unregistered dependency token: "'+e.toString()+'"')}if(this.executePreResolutionInterceptor(e,"Single"),i){var s=this.resolveRegistration(i,t);return this.executePostResolutionInterceptor(e,s,"Single"),s}if(qbe(e)){var s=this.construct(e,t);return this.executePostResolutionInterceptor(e,s,"Single"),s}throw new Error("Attempted to construct an undefined constructor. Could mean a circular dependency problem. Try using `delay` function.")},r.prototype.executePreResolutionInterceptor=function(e,t){var n,i;if(this.interceptors.preResolution.has(e)){var s=[];try{for(var o=qw(this.interceptors.preResolution.getAll(e)),a=o.next();!a.done;a=o.next()){var c=a.value;c.options.frequency!="Once"&&s.push(c),c.callback(e,t)}}catch(l){n={error:l}}finally{try{a&&!a.done&&(i=o.return)&&i.call(o)}finally{if(n)throw n.error}}this.interceptors.preResolution.setAll(e,s)}},r.prototype.executePostResolutionInterceptor=function(e,t,n){var i,s;if(this.interceptors.postResolution.has(e)){var o=[];try{for(var a=qw(this.interceptors.postResolution.getAll(e)),c=a.next();!c.done;c=a.next()){var l=c.value;l.options.frequency!="Once"&&o.push(l),l.callback(e,t,n)}}catch(d){i={error:d}}finally{try{c&&!c.done&&(s=a.return)&&s.call(a)}finally{if(i)throw i.error}}this.interceptors.postResolution.setAll(e,o)}},r.prototype.resolveRegistration=function(e,t){if(this.ensureNotDisposed(),e.options.lifecycle===$n.ResolutionScoped&&t.scopedResolutions.has(e))return t.scopedResolutions.get(e);var n=e.options.lifecycle===$n.Singleton,i=e.options.lifecycle===$n.ContainerScoped,s=n||i,o;return Qw(e.provider)?o=e.provider.useValue:Gw(e.provider)?o=s?e.instance||(e.instance=this.resolve(e.provider.useToken,t)):this.resolve(e.provider.useToken,t):mz(e.provider)?o=s?e.instance||(e.instance=this.construct(e.provider.useClass,t)):this.construct(e.provider.useClass,t):fx(e.provider)?o=e.provider.useFactory(this):o=this.construct(e.provider,t),e.options.lifecycle===$n.ResolutionScoped&&t.scopedResolutions.set(e,o),o},r.prototype.resolveAll=function(e,t,n){var i=this;t===void 0&&(t=new Yw),n===void 0&&(n=!1),this.ensureNotDisposed();var s=this.getAllRegistrations(e);if(!s&&Dh(e)){if(n)return[];throw new Error('Attempted to resolve unregistered dependency token: "'+e.toString()+'"')}if(this.executePreResolutionInterceptor(e,"All"),s){var o=s.map(function(c){return i.resolveRegistration(c,t)});return this.executePostResolutionInterceptor(e,o,"All"),o}var a=[this.construct(e,t)];return this.executePostResolutionInterceptor(e,a,"All"),a},r.prototype.isRegistered=function(e,t){return t===void 0&&(t=!1),this.ensureNotDisposed(),this._registry.has(e)||t&&(this.parent||!1)&&this.parent.isRegistered(e,!0)},r.prototype.reset=function(){this.ensureNotDisposed(),this._registry.clear(),this.interceptors.preResolution.clear(),this.interceptors.postResolution.clear()},r.prototype.clearInstances=function(){var e,t;this.ensureNotDisposed();try{for(var n=qw(this._registry.entries()),i=n.next();!i.done;i=n.next()){var s=Ww(i.value,2),o=s[0],a=s[1];this._registry.setAll(o,a.filter(function(c){return!Qw(c.provider)}).map(function(c){return c.instance=void 0,c}))}}catch(c){e={error:c}}finally{try{i&&!i.done&&(t=n.return)&&t.call(n)}finally{if(e)throw e.error}}},r.prototype.createChildContainer=function(){var e,t;this.ensureNotDisposed();var n=new r(this);try{for(var i=qw(this._registry.entries()),s=i.next();!s.done;s=i.next()){var o=Ww(s.value,2),a=o[0],c=o[1];c.some(function(l){var d=l.options;return d.lifecycle===$n.ContainerScoped})&&n._registry.setAll(a,c.map(function(l){return l.options.lifecycle===$n.ContainerScoped?{provider:l.provider,options:l.options}:l}))}}catch(l){e={error:l}}finally{try{s&&!s.done&&(t=i.return)&&t.call(i)}finally{if(e)throw e.error}}return n},r.prototype.beforeResolution=function(e,t,n){n===void 0&&(n={frequency:"Always"}),this.interceptors.preResolution.set(e,{callback:t,options:n})},r.prototype.afterResolution=function(e,t,n){n===void 0&&(n={frequency:"Always"}),this.interceptors.postResolution.set(e,{callback:t,options:n})},r.prototype.dispose=function(){return zbe(this,void 0,void 0,function(){var e;return Vbe(this,function(t){switch(t.label){case 0:return this.disposed=!0,e=[],this.disposables.forEach(function(n){var i=n.dispose();i&&e.push(i)}),[4,Promise.all(e)];case 1:return t.sent(),[2]}})})},r.prototype.getRegistration=function(e){return this.isRegistered(e)?this._registry.get(e):this.parent?this.parent.getRegistration(e):null},r.prototype.getAllRegistrations=function(e){return this.isRegistered(e)?this._registry.getAll(e):this.parent?this.parent.getAllRegistrations(e):null},r.prototype.construct=function(e,t){var n=this;if(e instanceof wz)return e.createProxy(function(s){return n.resolve(s,t)});var i=function(){var s=vz.get(e);if(!s||s.length===0){if(e.length===0)return new e;throw new Error('TypeInfo not known for "'+e.name+'"')}var o=s.map(n.resolveParams(t,e));return new(e.bind.apply(e,gu([void 0],o)))}();return Xbe(i)&&this.disposables.add(i),i},r.prototype.resolveParams=function(e,t){var n=this;return function(i,s){var o,a,c;try{return Hbe(i)?bz(i)?i.multiple?(o=n.resolve(i.transform)).transform.apply(o,gu([n.resolveAll(i.token,new Yw,i.isOptional)],i.transformArgs)):(a=n.resolve(i.transform)).transform.apply(a,gu([n.resolve(i.token,e,i.isOptional)],i.transformArgs)):i.multiple?n.resolveAll(i.token,new Yw,i.isOptional):n.resolve(i.token,e,i.isOptional):bz(i)?(c=n.resolve(i.transform,e)).transform.apply(c,gu([n.resolve(i.token,e)],i.transformArgs)):n.resolve(i,e)}catch(l){throw new Error(Jbe(t,s,l))}}},r.prototype.ensureNotDisposed=function(){if(this.disposed)throw new Error("This container has been disposed, you cannot interact with a disposed container")},r}(),_r=new rve;function Jw(r){return function(e){vz.set(e,jbe(e))}}if(typeof Reflect>"u"||!Reflect.getMetadata)throw new Error(`tsyringe requires a reflect polyfill. Please add 'import "reflect-metadata"' to the top of your entry point.`);var gx;class Xw{constructor(e={}){this.attrId="",this.attrValues=[],Object.assign(e)}}_([$({type:F.ObjectIdentifier})],Xw.prototype,"attrId",void 0),_([$({type:F.Any,repeated:"set"})],Xw.prototype,"attrValues",void 0);let Ez=gx=class extends dt{constructor(e){super(e),Object.setPrototypeOf(this,gx.prototype)}};Ez=gx=_([te({type:X.Sequence,itemType:Xw})],Ez);var yx;let Sz=yx=class extends dt{constructor(e){super(e),Object.setPrototypeOf(this,yx.prototype)}};Sz=yx=_([te({type:X.Sequence,itemType:Ch})],Sz);class xz{constructor(e={}){this.certId="",this.certValue=new ArrayBuffer(0),Object.assign(this,e)}}_([$({type:F.ObjectIdentifier})],xz.prototype,"certId",void 0),_([$({type:F.Any,context:0})],xz.prototype,"certValue",void 0);class Az{constructor(e={}){this.crlId="",this.crltValue=new ArrayBuffer(0),Object.assign(this,e)}}_([$({type:F.ObjectIdentifier})],Az.prototype,"crlId",void 0),_([$({type:F.Any,context:0})],Az.prototype,"crltValue",void 0);class Cz extends Ze{}let Zw=class{constructor(e={}){this.encryptionAlgorithm=new ge,this.encryptedData=new Cz,Object.assign(this,e)}};_([$({type:ge})],Zw.prototype,"encryptionAlgorithm",void 0),_([$({type:Cz})],Zw.prototype,"encryptedData",void 0);var mx,wx;(function(r){r[r.v1=0]="v1"})(wx||(wx={}));class Iz extends Ze{}let bx=mx=class extends dt{constructor(e){super(e),Object.setPrototypeOf(this,mx.prototype)}};bx=mx=_([te({type:X.Sequence,itemType:Xo})],bx);class jp{constructor(e={}){this.version=wx.v1,this.privateKeyAlgorithm=new ge,this.privateKey=new Iz,Object.assign(this,e)}}_([$({type:F.Integer})],jp.prototype,"version",void 0),_([$({type:ge})],jp.prototype,"privateKeyAlgorithm",void 0),_([$({type:Iz})],jp.prototype,"privateKey",void 0),_([$({type:bx,implicit:!0,context:0,optional:!0})],jp.prototype,"attributes",void 0);let kz=class extends jp{};kz=_([te({type:X.Sequence})],kz);let _z=class extends Zw{};_z=_([te({type:X.Sequence})],_z);class Tz{constructor(e={}){this.secretTypeId="",this.secretValue=new ArrayBuffer(0),Object.assign(this,e)}}_([$({type:F.ObjectIdentifier})],Tz.prototype,"secretTypeId",void 0),_([$({type:F.Any,context:0})],Tz.prototype,"secretValue",void 0);class Hp{constructor(e={}){this.mac=new jw,this.macSalt=new Ze,this.iterations=1,Object.assign(this,e)}}_([$({type:jw})],Hp.prototype,"mac",void 0),_([$({type:Ze})],Hp.prototype,"macSalt",void 0),_([$({type:F.Integer,defaultValue:1})],Hp.prototype,"iterations",void 0);class e4{constructor(e={}){this.version=3,this.authSafe=new Ch,this.macData=new Hp,Object.assign(this,e)}}_([$({type:F.Integer})],e4.prototype,"version",void 0),_([$({type:Ch})],e4.prototype,"authSafe",void 0),_([$({type:Hp,optional:!0})],e4.prototype,"macData",void 0);var vx;class t4{constructor(e={}){this.bagId="",this.bagValue=new ArrayBuffer(0),Object.assign(this,e)}}_([$({type:F.ObjectIdentifier})],t4.prototype,"bagId",void 0),_([$({type:F.Any,context:0})],t4.prototype,"bagValue",void 0),_([$({type:Xw,repeated:"set",optional:!0})],t4.prototype,"bagAttributes",void 0);let Pz=vx=class extends dt{constructor(e){super(e),Object.setPrototypeOf(this,vx.prototype)}};Pz=vx=_([te({type:X.Sequence,itemType:t4})],Pz);var Ex,Sx,xx;const Dz="1.2.840.113549.1.9",$z=`${Dz}.7`,Ax=`${Dz}.14`;let r4=class extends Ir{constructor(e={}){super(e)}toString(){return this.ia5String||super.toString()}};_([$({type:F.IA5String})],r4.prototype,"ia5String",void 0),r4=_([te({type:X.Choice})],r4);let Nz=class extends Ch{};Nz=_([te({type:X.Sequence})],Nz);let Mz=class extends e4{};Mz=_([te({type:X.Sequence})],Mz);let Oz=class extends Zw{};Oz=_([te({type:X.Sequence})],Oz);let Cx=class{constructor(e=""){this.value=e}toString(){return this.value}};_([$({type:F.IA5String})],Cx.prototype,"value",void 0),Cx=_([te({type:X.Choice})],Cx);let Rz=class extends r4{};Rz=_([te({type:X.Choice})],Rz);let Lz=class extends Ir{};Lz=_([te({type:X.Choice})],Lz);let Ix=class{constructor(e=new Date){this.value=e}};_([$({type:F.GeneralizedTime})],Ix.prototype,"value",void 0),Ix=_([te({type:X.Choice})],Ix);let Bz=class extends Ir{};Bz=_([te({type:X.Choice})],Bz);let kx=class{constructor(e="M"){this.value=e}toString(){return this.value}};_([$({type:F.PrintableString})],kx.prototype,"value",void 0),kx=_([te({type:X.Choice})],kx);let n4=class{constructor(e=""){this.value=e}toString(){return this.value}};_([$({type:F.PrintableString})],n4.prototype,"value",void 0),n4=_([te({type:X.Choice})],n4);let Uz=class extends n4{};Uz=_([te({type:X.Choice})],Uz);let Fz=class extends Ir{};Fz=_([te({type:X.Choice})],Fz);let _x=class{constructor(e=""){this.value=e}toString(){return this.value}};_([$({type:F.ObjectIdentifier})],_x.prototype,"value",void 0),_x=_([te({type:X.Choice})],_x);let zz=class extends kr{};zz=_([te({type:X.Choice})],zz);let Tx=class{constructor(e=0){this.value=e}toString(){return this.value.toString()}};_([$({type:F.Integer})],Tx.prototype,"value",void 0),Tx=_([te({type:X.Choice})],Tx);let Vz=class extends Ws{};Vz=_([te({type:X.Sequence})],Vz);let i4=class extends Ir{};i4=_([te({type:X.Choice})],i4);let Kz=Ex=class extends $c{constructor(e){super(e),Object.setPrototypeOf(this,Ex.prototype)}};Kz=Ex=_([te({type:X.Sequence})],Kz);let jz=Sx=class extends dt{constructor(e){super(e),Object.setPrototypeOf(this,Sx.prototype)}};jz=Sx=_([te({type:X.Set,itemType:Eh})],jz);let Px=class{constructor(e=""){this.value=e}toString(){return this.value}};_([$({type:F.BmpString})],Px.prototype,"value",void 0),Px=_([te({type:X.Choice})],Px);let Dx=class extends ge{};Dx=_([te({type:X.Sequence})],Dx);let Hz=xx=class extends dt{constructor(e){super(e),Object.setPrototypeOf(this,xx.prototype)}};Hz=xx=_([te({type:X.Sequence,itemType:Dx})],Hz);var $x;let s4=$x=class extends dt{constructor(e){super(e),Object.setPrototypeOf(this,$x.prototype)}};s4=$x=_([te({type:X.Sequence,itemType:Xo})],s4);class $h{constructor(e={}){this.version=0,this.subject=new Qt,this.subjectPKInfo=new ps,this.attributes=new s4,Object.assign(this,e)}}_([$({type:F.Integer})],$h.prototype,"version",void 0),_([$({type:Qt})],$h.prototype,"subject",void 0),_([$({type:ps})],$h.prototype,"subjectPKInfo",void 0),_([$({type:s4,implicit:!0,context:0})],$h.prototype,"attributes",void 0);class qp{constructor(e={}){this.certificationRequestInfo=new $h,this.signatureAlgorithm=new ge,this.signature=new ArrayBuffer(0),Object.assign(this,e)}}_([$({type:$h})],qp.prototype,"certificationRequestInfo",void 0),_([$({type:ge})],qp.prototype,"signatureAlgorithm",void 0),_([$({type:F.BitString})],qp.prototype,"signature",void 0);/*!
* MIT License
* 
* Copyright (c) Peculiar Ventures. All rights reserved.
* 
* Permission is hereby granted, free of charge, to any person obtaining a copy
* of this software and associated documentation files (the "Software"), to deal
* in the Software without restriction, including without limitation the rights
* to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
* copies of the Software, and to permit persons to whom the Software is
* furnished to do so, subject to the following conditions:
* 
* The above copyright notice and this permission notice shall be included in all
* copies or substantial portions of the Software.
* 
* THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
* IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
* FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
* AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
* LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
* OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
* SOFTWARE.
* 
*/const Wp="crypto.algorithm";class nve{getAlgorithms(){return _r.resolveAll(Wp)}toAsnAlgorithm(e){({...e});for(const t of this.getAlgorithms()){const n=t.toAsnAlgorithm(e);if(n)return n}if(/^[0-9.]+$/.test(e.name)){const t=new ge({algorithm:e.name});if("parameters"in e){const n=e;t.parameters=n.parameters}return t}throw new Error("Cannot convert WebCrypto algorithm to ASN.1 algorithm")}toWebAlgorithm(e){for(const n of this.getAlgorithms()){const i=n.toWebAlgorithm(e);if(i)return i}return{name:e.algorithm,parameters:e.parameters}}}const yu="crypto.algorithmProvider";_r.registerSingleton(yu,nve);var o4;const Nn="1.3.36.3.3.2.8.1.1",qz=`${Nn}.1`,Wz=`${Nn}.2`,Gz=`${Nn}.3`,Qz=`${Nn}.4`,Yz=`${Nn}.5`,Jz=`${Nn}.6`,Xz=`${Nn}.7`,Zz=`${Nn}.8`,eV=`${Nn}.9`,tV=`${Nn}.10`,rV=`${Nn}.11`,nV=`${Nn}.12`,iV=`${Nn}.13`,sV=`${Nn}.14`,oV="brainpoolP160r1",aV="brainpoolP160t1",cV="brainpoolP192r1",lV="brainpoolP192t1",uV="brainpoolP224r1",dV="brainpoolP224t1",hV="brainpoolP256r1",fV="brainpoolP256t1",pV="brainpoolP320r1",gV="brainpoolP320t1",yV="brainpoolP384r1",mV="brainpoolP384t1",wV="brainpoolP512r1",bV="brainpoolP512t1",zt="ECDSA";let Gp=o4=class{toAsnAlgorithm(e){switch(e.name.toLowerCase()){case zt.toLowerCase():if("hash"in e)switch((typeof e.hash=="string"?e.hash:e.hash.name).toLowerCase()){case"sha-1":return kbe;case"sha-256":return _be;case"sha-384":return Tbe;case"sha-512":return Pbe}else if("namedCurve"in e){let t="";switch(e.namedCurve){case"P-256":t=lz;break;case"K-256":t=o4.SECP256K1;break;case"P-384":t=uz;break;case"P-521":t=dz;break;case oV:t=qz;break;case aV:t=Wz;break;case cV:t=Gz;break;case lV:t=Qz;break;case uV:t=Yz;break;case dV:t=Jz;break;case hV:t=Xz;break;case fV:t=Zz;break;case pV:t=eV;break;case gV:t=tV;break;case yV:t=rV;break;case mV:t=nV;break;case wV:t=iV;break;case bV:t=sV;break}if(t)return new ge({algorithm:Fp,parameters:ae.serialize(new Mc({namedCurve:t}))})}}return null}toWebAlgorithm(e){switch(e.algorithm){case tx:return{name:zt,hash:{name:"SHA-1"}};case rx:return{name:zt,hash:{name:"SHA-256"}};case nx:return{name:zt,hash:{name:"SHA-384"}};case ix:return{name:zt,hash:{name:"SHA-512"}};case Fp:{if(!e.parameters)throw new TypeError("Cannot get required parameters from EC algorithm");switch(ae.parse(e.parameters,Mc).namedCurve){case lz:return{name:zt,namedCurve:"P-256"};case o4.SECP256K1:return{name:zt,namedCurve:"K-256"};case uz:return{name:zt,namedCurve:"P-384"};case dz:return{name:zt,namedCurve:"P-521"};case qz:return{name:zt,namedCurve:oV};case Wz:return{name:zt,namedCurve:aV};case Gz:return{name:zt,namedCurve:cV};case Qz:return{name:zt,namedCurve:lV};case Yz:return{name:zt,namedCurve:uV};case Jz:return{name:zt,namedCurve:dV};case Xz:return{name:zt,namedCurve:hV};case Zz:return{name:zt,namedCurve:fV};case eV:return{name:zt,namedCurve:pV};case tV:return{name:zt,namedCurve:gV};case rV:return{name:zt,namedCurve:yV};case nV:return{name:zt,namedCurve:mV};case iV:return{name:zt,namedCurve:wV};case sV:return{name:zt,namedCurve:bV}}}}return null}};Gp.SECP256K1="1.3.132.0.10",Gp=o4=_([Jw()],Gp),_r.registerSingleton(Wp,Gp);const vV=Symbol("name"),EV=Symbol("value");class ot{constructor(e,t={},n=""){this[vV]=e,this[EV]=n;for(const i in t)this[i]=t[i]}}ot.NAME=vV,ot.VALUE=EV;class ive{static toTextObject(e){const t=new ot("Algorithm Identifier",{},Oc.toString(e.algorithm));if(e.parameters)switch(e.algorithm){case Fp:{const n=new Gp().toWebAlgorithm(e);n&&"namedCurve"in n?t["Named Curve"]=n.namedCurve:t.Parameters=e.parameters;break}default:t.Parameters=e.parameters}return t}}class Oc{static toString(e){const t=this.items[e];return t||e}}Oc.items={[Bw]:"sha1",[pz]:"sha224",[Uw]:"sha256",[Fw]:"sha384",[zw]:"sha512",[hu]:"rsaEncryption",[Ow]:"sha1WithRSAEncryption",[Rbe]:"sha224WithRSAEncryption",[ox]:"sha256WithRSAEncryption",[Rw]:"sha384WithRSAEncryption",[Lw]:"sha512WithRSAEncryption",[Fp]:"ecPublicKey",[tx]:"ecdsaWithSHA1",[cz]:"ecdsaWithSHA224",[rx]:"ecdsaWithSHA256",[nx]:"ecdsaWithSHA384",[ix]:"ecdsaWithSHA512",[vbe]:"TLS WWW server authentication",[Ebe]:"TLS WWW client authentication",[Sbe]:"Code Signing",[xbe]:"E-mail Protection",[Abe]:"Time Stamping",[Cbe]:"OCSP Signing",[Ibe]:"Signed Data"};class mu{static serialize(e){return this.serializeObj(e).join(`
`)}static pad(e=0){return"".padStart(2*e," ")}static serializeObj(e,t=0){const n=[];let i=this.pad(t++),s="";const o=e[ot.VALUE];o&&(s=` ${o}`),n.push(`${i}${e[ot.NAME]}:${s}`),i=this.pad(t);for(const a in e){if(typeof a=="symbol")continue;const c=e[a],l=a?`${a}: `:"";if(typeof c=="string"||typeof c=="number"||typeof c=="boolean")n.push(`${i}${l}${c}`);else if(c instanceof Date)n.push(`${i}${l}${c.toUTCString()}`);else if(Array.isArray(c))for(const d of c)d[ot.NAME]=a,n.push(...this.serializeObj(d,t));else if(c instanceof ot)c[ot.NAME]=a,n.push(...this.serializeObj(c,t));else if(ue.isBufferSource(c))a?(n.push(`${i}${l}`),n.push(...this.serializeBufferSource(c,t+1))):n.push(...this.serializeBufferSource(c,t));else if("toTextObject"in c){const d=c.toTextObject();d[ot.NAME]=a,n.push(...this.serializeObj(d,t))}else throw new TypeError("Cannot serialize data in text format. Unsupported type.")}return n}static serializeBufferSource(e,t=0){const n=this.pad(t),i=ue.toUint8Array(e),s=[];for(let o=0;o<i.length;){const a=[];for(let c=0;c<16&&o<i.length;c++){c===8&&a.push("");const l=i[o++].toString(16).padStart(2,"0");a.push(l)}s.push(`${n}${a.join(" ")}`)}return s}static serializeAlgorithm(e){return this.algorithmSerializer.toTextObject(e)}}mu.oidSerializer=Oc,mu.algorithmSerializer=ive;class Rc{constructor(...e){if(e.length===1){const t=e[0];this.rawData=ae.serialize(t),this.onInit(t)}else{const t=ae.parse(e[0],e[1]);this.rawData=ue.toArrayBuffer(e[0]),this.onInit(t)}}equal(e){return e instanceof Rc?nU(e.rawData,this.rawData):!1}toString(e="text"){switch(e){case"asn":return ae.toString(this.rawData);case"text":return mu.serialize(this.toTextObject());case"hex":return Ee.ToHex(this.rawData);case"base64":return Ee.ToBase64(this.rawData);case"base64url":return Ee.ToBase64Url(this.rawData);default:throw TypeError("Argument 'format' is unsupported value")}}getTextName(){return this.constructor.NAME}toTextObject(){const e=this.toTextObjectEmpty();return e[""]=this.rawData,e}toTextObjectEmpty(e){return new ot(this.getTextName(),{},e)}}Rc.NAME="ASN";class Mi extends Rc{constructor(...e){let t;ue.isBufferSource(e[0])?t=ue.toArrayBuffer(e[0]):t=ae.serialize(new Ni({extnID:e[0],critical:e[1],extnValue:new Ze(ue.toArrayBuffer(e[2]))})),super(t,Ni)}onInit(e){this.type=e.extnID,this.critical=e.critical,this.value=e.extnValue.buffer}toTextObject(){const e=this.toTextObjectWithoutValue();return e[""]=this.value,e}toTextObjectWithoutValue(){const e=this.toTextObjectEmpty(this.critical?"critical":void 0);return e[ot.NAME]===Mi.NAME&&(e[ot.NAME]=Oc.toString(this.type)),e}}var SV;class Lc{static isCryptoKeyPair(e){return e&&e.privateKey&&e.publicKey}static isCryptoKey(e){return e&&e.usages&&e.type&&e.algorithm&&e.extractable!==void 0}constructor(){this.items=new Map,this[SV]="CryptoProvider",typeof self<"u"&&typeof crypto<"u"?this.set(Lc.DEFAULT,crypto):typeof global<"u"&&global.crypto&&global.crypto.subtle&&this.set(Lc.DEFAULT,global.crypto)}clear(){this.items.clear()}delete(e){return this.items.delete(e)}forEach(e,t){return this.items.forEach(e,t)}has(e){return this.items.has(e)}get size(){return this.items.size}entries(){return this.items.entries()}keys(){return this.items.keys()}values(){return this.items.values()}[Symbol.iterator](){return this.items[Symbol.iterator]()}get(e=Lc.DEFAULT){const t=this.items.get(e.toLowerCase());if(!t)throw new Error(`Cannot get Crypto by name '${e}'`);return t}set(e,t){if(typeof e=="string"){if(!t)throw new TypeError("Argument 'value' is required");this.items.set(e.toLowerCase(),t)}else this.items.set(Lc.DEFAULT,e);return this}}SV=Symbol.toStringTag,Lc.DEFAULT="default";const Tr=new Lc,sve=/^[0-2](?:\.[1-9][0-9]*)+$/;function ove(r){return new RegExp(sve).test(r)}class xV{constructor(e={}){this.items={};for(const t in e)this.register(t,e[t])}get(e){return this.items[e]||null}findId(e){return ove(e)?e:this.get(e)}register(e,t){this.items[e]=t,this.items[t]=e}}const Mn=new xV;Mn.register("CN","2.5.4.3"),Mn.register("L","2.5.4.7"),Mn.register("ST","2.5.4.8"),Mn.register("O","2.5.4.10"),Mn.register("OU","2.5.4.11"),Mn.register("C","2.5.4.6"),Mn.register("DC","0.9.2342.19200300.100.1.25"),Mn.register("E","1.2.840.113549.1.9.1"),Mn.register("G","2.5.4.42"),Mn.register("I","2.5.4.43"),Mn.register("SN","2.5.4.4"),Mn.register("T","2.5.4.12");function ave(r,e){return`\\${Ee.ToHex(Ee.FromUtf8String(e)).toUpperCase()}`}function cve(r){return r.replace(/([,+"\\<>;])/g,"\\$1").replace(/^([ #])/,"\\$1").replace(/([ ]$)/,"\\$1").replace(/([\r\n\t])/,ave)}class Oi{static isASCII(e){for(let t=0;t<e.length;t++)if(e.charCodeAt(t)>255)return!1;return!0}static isPrintableString(e){return/^[A-Za-z0-9 '()+,-./:=?]*$/g.test(e)}constructor(e,t={}){this.extraNames=new xV,this.asn=new Qt;for(const n in t)if(Object.prototype.hasOwnProperty.call(t,n)){const i=t[n];this.extraNames.register(n,i)}typeof e=="string"?this.asn=this.fromString(e):e instanceof Qt?this.asn=e:ue.isBufferSource(e)?this.asn=ae.parse(e,Qt):this.asn=this.fromJSON(e)}getField(e){const t=this.extraNames.findId(e)||Mn.findId(e),n=[];for(const i of this.asn)for(const s of i)s.type===t&&n.push(s.value.toString());return n}getName(e){return this.extraNames.get(e)||Mn.get(e)}toString(){return this.asn.map(e=>e.map(t=>{const n=this.getName(t.type)||t.type,i=t.value.anyValue?`#${Ee.ToHex(t.value.anyValue)}`:cve(t.value.toString());return`${n}=${i}`}).join("+")).join(", ")}toJSON(){var e;const t=[];for(const n of this.asn){const i={};for(const s of n){const o=this.getName(s.type)||s.type;(e=i[o])!==null&&e!==void 0||(i[o]=[]),i[o].push(s.value.anyValue?`#${Ee.ToHex(s.value.anyValue)}`:s.value.toString())}t.push(i)}return t}fromString(e){const t=new Qt,n=/(\d\.[\d.]*\d|[A-Za-z]+)=((?:"")|(?:".*?[^\\]")|(?:[^,+].*?(?:[^\\][,+]))|(?:))([,+])?/g;let i=null,s=",";for(;i=n.exec(`${e},`);){let[,o,a]=i;const c=a[a.length-1];(c===","||c==="+")&&(a=a.slice(0,a.length-1),i[3]=c);const l=i[3];o=this.getTypeOid(o);const d=this.createAttribute(o,a);s==="+"?t[t.length-1].push(d):t.push(new ph([d])),s=l}return t}fromJSON(e){const t=new Qt;for(const n of e){const i=new ph;for(const s in n){const o=this.getTypeOid(s),a=n[s];for(const c of a){const l=this.createAttribute(o,c);i.push(l)}}t.push(i)}return t}getTypeOid(e){if(/[\d.]+/.test(e)||(e=this.getName(e)||""),!e)throw new Error(`Cannot get OID for name type '${e}'`);return e}createAttribute(e,t){const n=new tw({type:e});if(typeof t=="object")for(const i in t)switch(i){case"ia5String":n.value.ia5String=t[i];break;case"utf8String":n.value.utf8String=t[i];break;case"universalString":n.value.universalString=t[i];break;case"bmpString":n.value.bmpString=t[i];break;case"printableString":n.value.printableString=t[i];break}else if(t[0]==="#")n.value.anyValue=Ee.FromHex(t.slice(1));else{const i=this.processStringValue(t);e===this.getName("E")||e===this.getName("DC")?n.value.ia5String=i:Oi.isPrintableString(i)?n.value.printableString=i:n.value.utf8String=i}return n}processStringValue(e){const t=/"(.*?[^\\])?"/.exec(e);return t&&(e=t[1]),e.replace(/\\0a/ig,`
`).replace(/\\0d/ig,"\r").replace(/\\0g/ig,"	").replace(/\\(.)/g,"$1")}toArrayBuffer(){return ae.serialize(this.asn)}async getThumbprint(...e){var t;let n,i="SHA-1";return e.length>=1&&!(!((t=e[0])===null||t===void 0)&&t.subtle)?(i=e[0]||i,n=e[1]||Tr.get()):n=e[0]||Tr.get(),await n.subtle.digest(i,this.toArrayBuffer())}}const AV="Cannot initialize GeneralName from ASN.1 data.",CV=`${AV} Unsupported string format in use.`,lve=`${AV} Value doesn't match to GUID regular expression.`,IV=/^([0-9a-f]{8})-?([0-9a-f]{4})-?([0-9a-f]{4})-?([0-9a-f]{4})-?([0-9a-f]{12})$/i,kV="1.3.6.1.4.1.311.25.1",_V="1.3.6.1.4.1.311.20.2.3",Nx="dns",Mx="dn",Ox="email",Rx="ip",Lx="url",Bx="guid",Ux="upn",a4="id";class Bc extends Rc{constructor(...e){let t;if(e.length===2)switch(e[0]){case Mx:{const n=new Oi(e[1]).toArrayBuffer(),i=ae.parse(n,Qt);t=new Be({directoryName:i});break}case Nx:t=new Be({dNSName:e[1]});break;case Ox:t=new Be({rfc822Name:e[1]});break;case Bx:{const n=new RegExp(IV,"i").exec(e[1]);if(!n)throw new Error("Cannot parse GUID value. Value doesn't match to regular expression");const i=n.slice(1).map((s,o)=>o<3?Ee.ToHex(new Uint8Array(Ee.FromHex(s)).reverse()):s).join("");t=new Be({otherName:new Cp({typeId:kV,value:ae.serialize(new Ze(Ee.FromHex(i)))})});break}case Rx:t=new Be({iPAddress:e[1]});break;case a4:t=new Be({registeredID:e[1]});break;case Ux:{t=new Be({otherName:new Cp({typeId:_V,value:ae.serialize(TF.toASN(e[1]))})});break}case Lx:t=new Be({uniformResourceIdentifier:e[1]});break;default:throw new Error("Cannot create GeneralName. Unsupported type of the name")}else ue.isBufferSource(e[0])?t=ae.parse(e[0],Be):t=e[0];super(t)}onInit(e){if(e.dNSName!=null)this.type=Nx,this.value=e.dNSName;else if(e.rfc822Name!=null)this.type=Ox,this.value=e.rfc822Name;else if(e.iPAddress!=null)this.type=Rx,this.value=e.iPAddress;else if(e.uniformResourceIdentifier!=null)this.type=Lx,this.value=e.uniformResourceIdentifier;else if(e.registeredID!=null)this.type=a4,this.value=e.registeredID;else if(e.directoryName!=null)this.type=Mx,this.value=new Oi(e.directoryName).toString();else if(e.otherName!=null)if(e.otherName.typeId===kV){this.type=Bx;const t=ae.parse(e.otherName.value,Ze),n=new RegExp(IV,"i").exec(Ee.ToHex(t));if(!n)throw new Error(lve);this.value=n.slice(1).map((i,s)=>s<3?Ee.ToHex(new Uint8Array(Ee.FromHex(i)).reverse()):i).join("-")}else if(e.otherName.typeId===_V)this.type=Ux,this.value=ae.parse(e.otherName.value,Ir).toString();else throw new Error(CV);else throw new Error(CV)}toJSON(){return{type:this.type,value:this.value}}toTextObject(){let e;switch(this.type){case Mx:case Nx:case Bx:case Rx:case a4:case Ux:case Lx:e=this.type.toUpperCase();break;case Ox:e="Email";break;default:throw new Error("Unsupported GeneralName type")}let t=this.value;return this.type===a4&&(t=Oc.toString(t)),new ot(e,void 0,t)}}class Qp extends Rc{constructor(e){let t;if(e instanceof pn)t=e;else if(Array.isArray(e)){const n=[];for(const i of e)if(i instanceof Be)n.push(i);else{const s=ae.parse(new Bc(i.type,i.value).rawData,Be);n.push(s)}t=new pn(n)}else if(ue.isBufferSource(e))t=ae.parse(e,pn);else throw new Error("Cannot initialize GeneralNames. Incorrect incoming arguments");super(t)}onInit(e){const t=[];for(const n of e){let i=null;try{i=new Bc(n)}catch{continue}t.push(i)}this.items=t}toJSON(){return this.items.map(e=>e.toJSON())}toTextObject(){const e=super.toTextObjectEmpty();for(const t of this.items){const n=t.toTextObject();let i=e[n[ot.NAME]];Array.isArray(i)||(i=[],e[n[ot.NAME]]=i),i.push(n)}return e}}Qp.NAME="GeneralNames";const Yp="-{5}",Jp="\\n",uve=`[^${Jp}]+`,dve=`${Yp}BEGIN (${uve}(?=${Yp}))${Yp}`,hve=`${Yp}END \\1${Yp}`,Nh="\\n",fve=`[^:${Jp}]+`,pve=`(?:[^${Jp}]+${Nh}(?: +[^${Jp}]+${Nh})*)`,gve=`(?:[a-zA-Z0-9=+/]+${Nh})+`,TV=`${dve}${Nh}(?:((?:${fve}: ${pve})+))?${Nh}?(${gve})${hve}`;class hi{static isPem(e){return typeof e=="string"&&new RegExp(TV,"g").test(e)}static decodeWithHeaders(e){e=e.replace(/\r/g,"");const t=new RegExp(TV,"g"),n=[];let i=null;for(;i=t.exec(e);){const s=i[3].replace(new RegExp(`[${Jp}]+`,"g"),""),o={type:i[1],headers:[],rawData:Ee.FromBase64(s)},a=i[2];if(a){const c=a.split(new RegExp(Nh,"g"));let l=null;for(const d of c){const[h,p]=d.split(/:(.*)/);if(p===void 0){if(!l)throw new Error("Cannot parse PEM string. Incorrect header value");l.value+=h.trim()}else l&&o.headers.push(l),l={key:h,value:p.trim()}}l&&o.headers.push(l)}n.push(o)}return n}static decode(e){return this.decodeWithHeaders(e).map(n=>n.rawData)}static decodeFirst(e){const t=this.decode(e);if(!t.length)throw new RangeError("PEM string doesn't contain any objects");return t[0]}static encode(e,t){if(Array.isArray(e)){const n=new Array;return t?e.forEach(i=>{if(!ue.isBufferSource(i))throw new TypeError("Cannot encode array of BufferSource in PEM format. Not all items of the array are BufferSource");n.push(this.encodeStruct({type:t,rawData:ue.toArrayBuffer(i)}))}):e.forEach(i=>{if(!("type"in i))throw new TypeError("Cannot encode array of PemStruct in PEM format. Not all items of the array are PemStrut");n.push(this.encodeStruct(i))}),n.join(`
`)}else{if(!t)throw new Error("Required argument 'tag' is missed");return this.encodeStruct({type:t,rawData:ue.toArrayBuffer(e)})}}static encodeStruct(e){var t;const n=e.type.toLocaleUpperCase(),i=[];if(i.push(`-----BEGIN ${n}-----`),!((t=e.headers)===null||t===void 0)&&t.length){for(const l of e.headers)i.push(`${l.key}: ${l.value}`);i.push("")}const s=Ee.ToBase64(e.rawData);let o,a=0;const c=Array();for(;a<s.length&&(s.length-a<64?o=s.substring(a):(o=s.substring(a,a+64),a+=64),o.length!==0);)if(c.push(o),o.length<64)break;return i.push(...c),i.push(`-----END ${n}-----`),i.join(`
`)}}hi.CertificateTag="CERTIFICATE",hi.CrlTag="CRL",hi.CertificateRequestTag="CERTIFICATE REQUEST",hi.PublicKeyTag="PUBLIC KEY",hi.PrivateKeyTag="PRIVATE KEY";class ra extends Rc{static isAsnEncoded(e){return ue.isBufferSource(e)||typeof e=="string"}static toArrayBuffer(e){if(typeof e=="string"){if(hi.isPem(e))return hi.decode(e)[0];if(Ee.isHex(e))return Ee.FromHex(e);if(Ee.isBase64(e))return Ee.FromBase64(e);if(Ee.isBase64Url(e))return Ee.FromBase64Url(e);throw new TypeError("Unsupported format of 'raw' argument. Must be one of DER, PEM, HEX, Base64, or Base4Url")}else{const t=Ee.ToBinary(e);return hi.isPem(t)?hi.decode(t)[0]:Ee.isHex(t)?Ee.FromHex(t):Ee.isBase64(t)?Ee.FromBase64(t):Ee.isBase64Url(t)?Ee.FromBase64Url(t):ue.toArrayBuffer(e)}}constructor(...e){ra.isAsnEncoded(e[0])?super(ra.toArrayBuffer(e[0]),e[1]):super(e[0])}toString(e="pem"){switch(e){case"pem":return hi.encode(this.rawData,this.tag);default:return super.toString(e)}}}class ys extends ra{static async create(e,t=Tr.get()){if(e instanceof ys)return e;if(Lc.isCryptoKey(e)){if(e.type!=="public")throw new TypeError("Public key is required");const n=await t.subtle.exportKey("spki",e);return new ys(n)}else{if(e.publicKey)return e.publicKey;if(ue.isBufferSource(e))return new ys(e);throw new TypeError("Unsupported PublicKeyType")}}constructor(e){ra.isAsnEncoded(e)?super(e,ps):super(e),this.tag=hi.PublicKeyTag}async export(...e){let t,n=["verify"],i={hash:"SHA-256",...this.algorithm};e.length>1?(i=e[0]||i,n=e[1]||n,t=e[2]||Tr.get()):t=e[0]||Tr.get();let s=this.rawData;const o=ae.parse(this.rawData,ps);return o.algorithm.algorithm===Kp&&(s=yve(o,s)),t.subtle.importKey("spki",s,i,!0,n)}onInit(e){const t=_r.resolve(yu),n=this.algorithm=t.toWebAlgorithm(e.algorithm);switch(e.algorithm.algorithm){case hu:{const i=ae.parse(e.subjectPublicKey,lx),s=ue.toUint8Array(i.modulus);n.publicExponent=ue.toUint8Array(i.publicExponent),n.modulusLength=(s[0]?s:s.slice(1)).byteLength<<3;break}}}async getThumbprint(...e){var t;let n,i="SHA-1";return e.length>=1&&!(!((t=e[0])===null||t===void 0)&&t.subtle)?(i=e[0]||i,n=e[1]||Tr.get()):n=e[0]||Tr.get(),await n.subtle.digest(i,this.rawData)}async getKeyIdentifier(...e){let t,n="SHA-1";e.length===1?typeof e[0]=="string"?(n=e[0],t=Tr.get()):t=e[0]:e.length===2?(n=e[0],t=e[1]):t=Tr.get();const i=ae.parse(this.rawData,ps);return await t.subtle.digest(n,i.subjectPublicKey)}toTextObject(){const e=this.toTextObjectEmpty(),t=ae.parse(this.rawData,ps);switch(e.Algorithm=mu.serializeAlgorithm(t.algorithm),t.algorithm.algorithm){case Fp:e["EC Point"]=t.subjectPublicKey;break;case hu:default:e["Raw Data"]=t.subjectPublicKey}return e}}function yve(r,e){return r.algorithm=new ge({algorithm:hu,parameters:null}),e=ae.serialize(r),e}class Xp extends Mi{static async create(e,t=!1,n=Tr.get()){if("name"in e&&"serialNumber"in e)return new Xp(e,t);const s=await(await ys.create(e,n)).getKeyIdentifier(n);return new Xp(Ee.ToHex(s),t)}constructor(...e){if(ue.isBufferSource(e[0]))super(e[0]);else if(typeof e[0]=="string"){const t=new su({keyIdentifier:new sS(Ee.FromHex(e[0]))});super(iS,e[1],ae.serialize(t))}else{const t=e[0],n=t.name instanceof Qp?ae.parse(t.name.rawData,pn):t.name,i=new su({authorityCertIssuer:n,authorityCertSerialNumber:Ee.FromHex(t.serialNumber)});super(iS,e[1],ae.serialize(i))}}onInit(e){super.onInit(e);const t=ae.parse(e.extnValue,su);t.keyIdentifier&&(this.keyId=Ee.ToHex(t.keyIdentifier)),(t.authorityCertIssuer||t.authorityCertSerialNumber)&&(this.certId={name:t.authorityCertIssuer||[],serialNumber:t.authorityCertSerialNumber?Ee.ToHex(t.authorityCertSerialNumber):""})}toTextObject(){const e=this.toTextObjectWithoutValue(),t=ae.parse(this.value,su);return t.authorityCertIssuer&&(e["Authority Issuer"]=new Qp(t.authorityCertIssuer).toTextObject()),t.authorityCertSerialNumber&&(e["Authority Serial Number"]=t.authorityCertSerialNumber),t.keyIdentifier&&(e[""]=t.keyIdentifier),e}}Xp.NAME="Authority Key Identifier";class Fx extends Mi{constructor(...e){if(ue.isBufferSource(e[0])){super(e[0]);const t=ae.parse(this.value,nw);this.ca=t.cA,this.pathLength=t.pathLenConstraint}else{const t=new nw({cA:e[0],pathLenConstraint:e[1]});super(LF,e[2],ae.serialize(t)),this.ca=e[0],this.pathLength=e[1]}}toTextObject(){const e=this.toTextObjectWithoutValue();return this.ca&&(e.CA=this.ca),this.pathLength!==void 0&&(e["Path Length"]=this.pathLength),e}}Fx.NAME="Basic Constraints";var PV;(function(r){r.serverAuth="1.3.6.1.5.5.7.3.1",r.clientAuth="1.3.6.1.5.5.7.3.2",r.codeSigning="1.3.6.1.5.5.7.3.3",r.emailProtection="1.3.6.1.5.5.7.3.4",r.timeStamping="1.3.6.1.5.5.7.3.8",r.ocspSigning="1.3.6.1.5.5.7.3.9"})(PV||(PV={}));class DV extends Mi{constructor(...e){if(ue.isBufferSource(e[0])){super(e[0]);const t=ae.parse(this.value,cw);this.usages=t.map(n=>n)}else{const t=new cw(e[0]);super(KF,e[1],ae.serialize(t)),this.usages=e[0]}}toTextObject(){const e=this.toTextObjectWithoutValue();return e[""]=this.usages.map(t=>Oc.toString(t)).join(", "),e}}DV.NAME="Extended Key Usages";var $V;(function(r){r[r.digitalSignature=1]="digitalSignature",r[r.nonRepudiation=2]="nonRepudiation",r[r.keyEncipherment=4]="keyEncipherment",r[r.dataEncipherment=8]="dataEncipherment",r[r.keyAgreement=16]="keyAgreement",r[r.keyCertSign=32]="keyCertSign",r[r.cRLSign=64]="cRLSign",r[r.encipherOnly=128]="encipherOnly",r[r.decipherOnly=256]="decipherOnly"})($V||($V={}));class NV extends Mi{constructor(...e){if(ue.isBufferSource(e[0])){super(e[0]);const t=ae.parse(this.value,vS);this.usages=t.toNumber()}else{const t=new vS(e[0]);super(HF,e[1],ae.serialize(t)),this.usages=e[0]}}toTextObject(){const e=this.toTextObjectWithoutValue(),t=ae.parse(this.value,vS);return e[""]=t.toJSON().join(", "),e}}NV.NAME="Key Usages";class c4 extends Mi{static async create(e,t=!1,n=Tr.get()){const s=await(await ys.create(e,n)).getKeyIdentifier(n);return new c4(Ee.ToHex(s),t)}constructor(...e){if(ue.isBufferSource(e[0])){super(e[0]);const t=ae.parse(this.value,Dc);this.keyId=Ee.ToHex(t)}else{const t=typeof e[0]=="string"?Ee.FromHex(e[0]):e[0],n=new Dc(t);super(JF,e[1],ae.serialize(n)),this.keyId=Ee.ToHex(t)}}toTextObject(){const e=this.toTextObjectWithoutValue(),t=ae.parse(this.value,Dc);return e[""]=t,e}}c4.NAME="Subject Key Identifier";class MV extends Mi{constructor(...e){ue.isBufferSource(e[0])?super(e[0]):super(QF,e[1],new Qp(e[0]||[]).rawData)}onInit(e){super.onInit(e);const t=ae.parse(e.extnValue,CS);this.names=new Qp(t)}toTextObject(){const e=this.toTextObjectWithoutValue(),t=this.names.toTextObject();for(const n in t)e[n]=t[n];return e}}MV.NAME="Subject Alternative Name";class Ri{static register(e,t){this.items.set(e,t)}static create(e){const t=new Mi(e),n=this.items.get(t.type);return n?new n(e):t}}Ri.items=new Map;class OV extends Mi{constructor(...e){var t;if(ue.isBufferSource(e[0])){super(e[0]);const n=ae.parse(this.value,ow);this.policies=n.map(i=>i.policyIdentifier)}else{const n=e[0],i=(t=e[1])!==null&&t!==void 0?t:!1,s=new ow(n.map(o=>new sw({policyIdentifier:o})));super(UF,i,ae.serialize(s)),this.policies=n}}toTextObject(){const e=this.toTextObjectWithoutValue();return e.Policy=this.policies.map(t=>new ot("",{},Oc.toString(t))),e}}OV.NAME="Certificate Policies",Ri.register(UF,OV);class RV extends Mi{constructor(...e){var t;if(ue.isBufferSource(e[0]))super(e[0]);else if(Array.isArray(e[0])&&typeof e[0][0]=="string"){const i=e[0].map(o=>new mh({distributionPoint:new ou({fullName:[new Be({uniformResourceIdentifier:o})]})})),s=new wh(i);super(fS,e[1],ae.serialize(s))}else{const n=new wh(e[0]);super(fS,e[1],ae.serialize(n))}(t=this.distributionPoints)!==null&&t!==void 0||(this.distributionPoints=[])}onInit(e){super.onInit(e);const t=ae.parse(e.extnValue,wh);this.distributionPoints=t}toTextObject(){const e=this.toTextObjectWithoutValue();return e["Distribution Point"]=this.distributionPoints.map(t=>{var n;const i={};return t.distributionPoint&&(i[""]=(n=t.distributionPoint.fullName)===null||n===void 0?void 0:n.map(s=>new Bc(s).toString()).join(", ")),t.reasons&&(i.Reasons=t.reasons.toString()),t.cRLIssuer&&(i["CRL Issuer"]=t.cRLIssuer.map(s=>s.toString()).join(", ")),i}),e}}RV.NAME="CRL Distribution Points";class LV extends Mi{constructor(...e){var t,n,i,s;if(ue.isBufferSource(e[0]))super(e[0]);else if(e[0]instanceof yh){const o=new yh(e[0]);super(nS,e[1],ae.serialize(o))}else{const o=e[0],a=new yh;u4(a,o,NF,"ocsp"),u4(a,o,MF,"caIssuers"),u4(a,o,OF,"timeStamping"),u4(a,o,RF,"caRepository"),super(nS,e[1],ae.serialize(a))}(t=this.ocsp)!==null&&t!==void 0||(this.ocsp=[]),(n=this.caIssuers)!==null&&n!==void 0||(this.caIssuers=[]),(i=this.timeStamping)!==null&&i!==void 0||(this.timeStamping=[]),(s=this.caRepository)!==null&&s!==void 0||(this.caRepository=[])}onInit(e){super.onInit(e),this.ocsp=[],this.caIssuers=[],this.timeStamping=[],this.caRepository=[],ae.parse(e.extnValue,yh).forEach(n=>{switch(n.accessMethod){case NF:this.ocsp.push(new Bc(n.accessLocation));break;case MF:this.caIssuers.push(new Bc(n.accessLocation));break;case OF:this.timeStamping.push(new Bc(n.accessLocation));break;case RF:this.caRepository.push(new Bc(n.accessLocation));break}})}toTextObject(){const e=this.toTextObjectWithoutValue();return this.ocsp.length&&l4(e,"OCSP",this.ocsp),this.caIssuers.length&&l4(e,"CA Issuers",this.caIssuers),this.timeStamping.length&&l4(e,"Time Stamping",this.timeStamping),this.caRepository.length&&l4(e,"CA Repository",this.caRepository),e}}LV.NAME="Authority Info Access";function l4(r,e,t){if(t.length===1)r[e]=t[0].toTextObject();else{const n=new ot("");t.forEach((i,s)=>{const o=i.toTextObject(),a=`${o[ot.NAME]} ${s+1}`;let c=n[a];Array.isArray(c)||(c=[],n[a]=c),c.push(o)}),r[e]=n}}function u4(r,e,t,n){const i=e[n];i&&(Array.isArray(i)?i:[i]).forEach(o=>{typeof o=="string"&&(o=new Bc("url",o)),r.push(new Ip({accessMethod:t,accessLocation:ae.parse(o.rawData,Be)}))})}class Mh extends Rc{constructor(...e){let t;if(ue.isBufferSource(e[0]))t=ue.toArrayBuffer(e[0]);else{const n=e[0],i=Array.isArray(e[1])?e[1].map(s=>ue.toArrayBuffer(s)):[];t=ae.serialize(new Xo({type:n,values:i}))}super(t,Xo)}onInit(e){this.type=e.type,this.values=e.values}toTextObject(){const e=this.toTextObjectWithoutValue();return e.Value=this.values.map(t=>new ot("",{"":t})),e}toTextObjectWithoutValue(){const e=this.toTextObjectEmpty();return e[ot.NAME]===Mh.NAME&&(e[ot.NAME]=Oc.toString(this.type)),e}}Mh.NAME="Attribute";class BV extends Mh{constructor(...e){var t;if(ue.isBufferSource(e[0]))super(e[0]);else{const n=new i4({printableString:e[0]});super($z,[ae.serialize(n)])}(t=this.password)!==null&&t!==void 0||(this.password="")}onInit(e){if(super.onInit(e),this.values[0]){const t=ae.parse(this.values[0],i4);this.password=t.toString()}}toTextObject(){const e=this.toTextObjectWithoutValue();return e[ot.VALUE]=this.password,e}}BV.NAME="Challenge Password";class zx extends Mh{constructor(...e){var t;if(ue.isBufferSource(e[0]))super(e[0]);else{const n=e[0],i=new $c;for(const s of n)i.push(ae.parse(s.rawData,Ni));super(Ax,[ae.serialize(i)])}(t=this.items)!==null&&t!==void 0||(this.items=[])}onInit(e){if(super.onInit(e),this.values[0]){const t=ae.parse(this.values[0],$c);this.items=t.map(n=>Ri.create(ae.serialize(n)))}}toTextObject(){const e=this.toTextObjectWithoutValue(),t=this.items.map(n=>n.toTextObject());for(const n of t)e[n[ot.NAME]]=n;return e}}zx.NAME="Extensions";class d4{static register(e,t){this.items.set(e,t)}static create(e){const t=new Mh(e),n=this.items.get(t.type);return n?new n(e):t}}d4.items=new Map;const Zp="crypto.signatureFormatter";class mve{toAsnSignature(e,t){return ue.toArrayBuffer(t)}toWebSignature(e,t){return ue.toArrayBuffer(t)}}var h4;let Vx=h4=class{static createPssParams(e,t){const n=h4.getHashAlgorithm(e);return n?new pu({hashAlgorithm:n,maskGenAlgorithm:new ge({algorithm:Vw,parameters:ae.serialize(n)}),saltLength:t}):null}static getHashAlgorithm(e){const t=_r.resolve(yu);return typeof e=="string"?t.toAsnAlgorithm({name:e}):typeof e=="object"&&e&&"name"in e?t.toAsnAlgorithm(e):null}toAsnAlgorithm(e){switch(e.name.toLowerCase()){case"rsassa-pkcs1-v1_5":if("hash"in e){let t;if(typeof e.hash=="string")t=e.hash;else if(e.hash&&typeof e.hash=="object"&&"name"in e.hash&&typeof e.hash.name=="string")t=e.hash.name.toUpperCase();else throw new Error("Cannot get hash algorithm name");switch(t.toLowerCase()){case"sha-1":return new ge({algorithm:Ow,parameters:null});case"sha-256":return new ge({algorithm:ox,parameters:null});case"sha-384":return new ge({algorithm:Rw,parameters:null});case"sha-512":return new ge({algorithm:Lw,parameters:null})}}else return new ge({algorithm:hu,parameters:null});break;case"rsa-pss":if("hash"in e){if(!("saltLength"in e&&typeof e.saltLength=="number"))throw new Error("Cannot get 'saltLength' from 'alg' argument");const t=h4.createPssParams(e.hash,e.saltLength);if(!t)throw new Error("Cannot create PSS parameters");return new ge({algorithm:Kp,parameters:ae.serialize(t)})}else return new ge({algorithm:Kp,parameters:null})}return null}toWebAlgorithm(e){switch(e.algorithm){case hu:return{name:"RSASSA-PKCS1-v1_5"};case Ow:return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-1"}};case ox:return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}};case Rw:return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-384"}};case Lw:return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-512"}};case Kp:if(e.parameters){const t=ae.parse(e.parameters,pu);return{name:"RSA-PSS",hash:_r.resolve(yu).toWebAlgorithm(t.hashAlgorithm),saltLength:t.saltLength}}else return{name:"RSA-PSS"}}return null}};Vx=h4=_([Jw()],Vx),_r.registerSingleton(Wp,Vx);let Kx=class{toAsnAlgorithm(e){switch(e.name.toLowerCase()){case"sha-1":return new ge({algorithm:Bw});case"sha-256":return new ge({algorithm:Uw});case"sha-384":return new ge({algorithm:Fw});case"sha-512":return new ge({algorithm:zw})}return null}toWebAlgorithm(e){switch(e.algorithm){case Bw:return{name:"SHA-1"};case Uw:return{name:"SHA-256"};case Fw:return{name:"SHA-384"};case zw:return{name:"SHA-512"}}return null}};Kx=_([Jw()],Kx),_r.registerSingleton(Wp,Kx);class Li{addPadding(e,t){const n=ue.toUint8Array(t),i=new Uint8Array(e);return i.set(n,e-n.length),i}removePadding(e,t=!1){let n=ue.toUint8Array(e);for(let i=0;i<n.length;i++)if(n[i]){n=n.slice(i);break}if(t&&n[0]>127){const i=new Uint8Array(n.length+1);return i.set(n,1),i.buffer}return n.buffer}toAsnSignature(e,t){if(e.name==="ECDSA"){const n=e.namedCurve,i=Li.namedCurveSize.get(n)||Li.defaultNamedCurveSize,s=new Mw,o=ue.toUint8Array(t);return s.r=this.removePadding(o.slice(0,i),!0),s.s=this.removePadding(o.slice(i,i+i),!0),ae.serialize(s)}return null}toWebSignature(e,t){if(e.name==="ECDSA"){const n=ae.parse(t,Mw),i=e.namedCurve,s=Li.namedCurveSize.get(i)||Li.defaultNamedCurveSize,o=this.addPadding(s,this.removePadding(n.r)),a=this.addPadding(s,this.removePadding(n.s));return o5e(o,a)}return null}}Li.namedCurveSize=new Map,Li.defaultNamedCurveSize=32;const jx="1.3.101.110",UV="1.3.101.111",Hx="1.3.101.112",FV="1.3.101.113";let qx=class{toAsnAlgorithm(e){let t=null;switch(e.name.toLowerCase()){case"ed25519":t=Hx;break;case"x25519":t=jx;break;case"eddsa":switch(e.namedCurve.toLowerCase()){case"ed25519":t=Hx;break;case"ed448":t=FV;break}break;case"ecdh-es":switch(e.namedCurve.toLowerCase()){case"x25519":t=jx;break;case"x448":t=UV;break}}return t?new ge({algorithm:t}):null}toWebAlgorithm(e){switch(e.algorithm){case Hx:return{name:"Ed25519"};case FV:return{name:"EdDSA",namedCurve:"Ed448"};case jx:return{name:"X25519"};case UV:return{name:"ECDH-ES",namedCurve:"X448"}}return null}};qx=_([Jw()],qx),_r.registerSingleton(Wp,qx);class wve extends ra{constructor(e){ra.isAsnEncoded(e)?super(e,qp):super(e),this.tag=hi.CertificateRequestTag}onInit(e){this.tbs=ae.serialize(e.certificationRequestInfo),this.publicKey=new ys(e.certificationRequestInfo.subjectPKInfo);const t=_r.resolve(yu);this.signatureAlgorithm=t.toWebAlgorithm(e.signatureAlgorithm),this.signature=e.signature,this.attributes=e.certificationRequestInfo.attributes.map(i=>d4.create(ae.serialize(i)));const n=this.getAttribute(Ax);this.extensions=[],n instanceof zx&&(this.extensions=n.items),this.subjectName=new Oi(e.certificationRequestInfo.subject),this.subject=this.subjectName.toString()}getAttribute(e){for(const t of this.attributes)if(t.type===e)return t;return null}getAttributes(e){return this.attributes.filter(t=>t.type===e)}getExtension(e){for(const t of this.extensions)if(t.type===e)return t;return null}getExtensions(e){return this.extensions.filter(t=>t.type===e)}async verify(e=Tr.get()){const t={...this.publicKey.algorithm,...this.signatureAlgorithm},n=await this.publicKey.export(t,["verify"],e),i=_r.resolveAll(Zp).reverse();let s=null;for(const a of i)if(s=a.toWebSignature(t,this.signature),s)break;if(!s)throw Error("Cannot convert WebCrypto signature value to ASN.1 format");return await e.subtle.verify(this.signatureAlgorithm,n,s,this.tbs)}toTextObject(){const e=this.toTextObjectEmpty(),t=ae.parse(this.rawData,qp),n=t.certificationRequestInfo,i=new ot("",{Version:`${au[n.version]} (${n.version})`,Subject:this.subject,"Subject Public Key Info":this.publicKey});if(this.attributes.length){const s=new ot("");for(const o of this.attributes){const a=o.toTextObject();s[a[ot.NAME]]=a}i.Attributes=s}return e.Data=i,e.Signature=new ot("",{Algorithm:mu.serializeAlgorithm(t.signatureAlgorithm),"":t.signature}),e}}wve.NAME="PKCS#10 Certificate Request";class Wx extends ra{constructor(e){ra.isAsnEncoded(e)?super(e,cu):super(e),this.tag=hi.CertificateTag}onInit(e){const t=e.tbsCertificate;this.tbs=ae.serialize(t),this.serialNumber=Ee.ToHex(t.serialNumber),this.subjectName=new Oi(t.subject),this.subject=new Oi(t.subject).toString(),this.issuerName=new Oi(t.issuer),this.issuer=this.issuerName.toString();const n=_r.resolve(yu);this.signatureAlgorithm=n.toWebAlgorithm(e.signatureAlgorithm),this.signature=e.signatureValue;const i=t.validity.notBefore.utcTime||t.validity.notBefore.generalTime;if(!i)throw new Error("Cannot get 'notBefore' value");this.notBefore=i;const s=t.validity.notAfter.utcTime||t.validity.notAfter.generalTime;if(!s)throw new Error("Cannot get 'notAfter' value");this.notAfter=s,this.extensions=[],t.extensions&&(this.extensions=t.extensions.map(o=>Ri.create(ae.serialize(o)))),this.publicKey=new ys(t.subjectPublicKeyInfo)}getExtension(e){for(const t of this.extensions)if(typeof e=="string"){if(t.type===e)return t}else if(t instanceof e)return t;return null}getExtensions(e){return this.extensions.filter(t=>typeof e=="string"?t.type===e:t instanceof e)}async verify(e={},t=Tr.get()){let n,i;const s=e.publicKey;try{if(!s)n={...this.publicKey.algorithm,...this.signatureAlgorithm},i=await this.publicKey.export(n,["verify"],t);else if("publicKey"in s)n={...s.publicKey.algorithm,...this.signatureAlgorithm},i=await s.publicKey.export(n,["verify"],t);else if(s instanceof ys)n={...s.algorithm,...this.signatureAlgorithm},i=await s.export(n,["verify"],t);else if(ue.isBufferSource(s)){const l=new ys(s);n={...l.algorithm,...this.signatureAlgorithm},i=await l.export(n,["verify"],t)}else n={...s.algorithm,...this.signatureAlgorithm},i=s}catch{return!1}const o=_r.resolveAll(Zp).reverse();let a=null;for(const l of o)if(a=l.toWebSignature(n,this.signature),a)break;if(!a)throw Error("Cannot convert ASN.1 signature value to WebCrypto format");const c=await t.subtle.verify(this.signatureAlgorithm,i,a,this.tbs);if(e.signatureOnly)return c;{const d=(e.date||new Date).getTime();return c&&this.notBefore.getTime()<d&&d<this.notAfter.getTime()}}async getThumbprint(...e){let t,n="SHA-1";return e[0]&&(e[0].subtle?t=e[0]:(n=e[0]||n,t=e[1])),t??(t=Tr.get()),await t.subtle.digest(n,this.rawData)}async isSelfSigned(e=Tr.get()){return this.subject===this.issuer&&await this.verify({signatureOnly:!0},e)}toTextObject(){const e=this.toTextObjectEmpty(),t=ae.parse(this.rawData,cu),n=t.tbsCertificate,i=new ot("",{Version:`${au[n.version]} (${n.version})`,"Serial Number":n.serialNumber,"Signature Algorithm":mu.serializeAlgorithm(n.signature),Issuer:this.issuer,Validity:new ot("",{"Not Before":n.validity.notBefore.getTime(),"Not After":n.validity.notAfter.getTime()}),Subject:this.subject,"Subject Public Key Info":this.publicKey});if(n.issuerUniqueID&&(i["Issuer Unique ID"]=n.issuerUniqueID),n.subjectUniqueID&&(i["Subject Unique ID"]=n.subjectUniqueID),this.extensions.length){const s=new ot("");for(const o of this.extensions){const a=o.toTextObject();s[a[ot.NAME]]=a}i.Extensions=s}return e.Data=i,e.Signature=new ot("",{Algorithm:mu.serializeAlgorithm(t.signatureAlgorithm),"":t.signatureValue}),e}}Wx.NAME="Certificate";class bve{static async createSelfSigned(e,t=Tr.get()){if(!e.keys.privateKey)throw new Error("Bad field 'keys' in 'params' argument. 'privateKey' is empty");if(!e.keys.publicKey)throw new Error("Bad field 'keys' in 'params' argument. 'publicKey' is empty");return this.create({serialNumber:e.serialNumber,subject:e.name,issuer:e.name,notBefore:e.notBefore,notAfter:e.notAfter,publicKey:e.keys.publicKey,signingKey:e.keys.privateKey,signingAlgorithm:e.signingAlgorithm,extensions:e.extensions},t)}static async create(e,t=Tr.get()){var n;let i;e.publicKey instanceof ys?i=e.publicKey.rawData:"publicKey"in e.publicKey?i=e.publicKey.publicKey.rawData:ue.isBufferSource(e.publicKey)?i=e.publicKey:i=await t.subtle.exportKey("spki",e.publicKey);const s=e.serialNumber?ue.toUint8Array(Ee.FromHex(e.serialNumber)):t.getRandomValues(new Uint8Array(16));s[0]>127&&(s[0]&=127),s.length>1&&s[0]===0&&(s[1]|=128);const o=e.notBefore||new Date,a=e.notAfter||new Date(o.getTime()+31536e6),c=new cu({tbsCertificate:new di({version:au.v3,serialNumber:s,validity:new Tp({notBefore:o,notAfter:a}),extensions:new $c(((n=e.extensions)===null||n===void 0?void 0:n.map(w=>ae.parse(w.rawData,Ni)))||[]),subjectPublicKeyInfo:ae.parse(i,ps)})});if(e.subject){const w=e.subject instanceof Oi?e.subject:new Oi(e.subject);c.tbsCertificate.subject=ae.parse(w.toArrayBuffer(),Qt)}if(e.issuer){const w=e.issuer instanceof Oi?e.issuer:new Oi(e.issuer);c.tbsCertificate.issuer=ae.parse(w.toArrayBuffer(),Qt)}const l={hash:"SHA-256"},d="signingKey"in e?{...l,...e.signingAlgorithm,...e.signingKey.algorithm}:{...l,...e.signingAlgorithm},h=_r.resolve(yu);c.tbsCertificate.signature=c.signatureAlgorithm=h.toAsnAlgorithm(d);const p=ae.serialize(c.tbsCertificate),m="signingKey"in e?await t.subtle.sign(d,e.signingKey,p):e.signature,f=_r.resolveAll(Zp).reverse();let g=null;for(const w of f)if(g=w.toAsnSignature(d,m),g)break;if(!g)throw Error("Cannot convert ASN.1 signature value to WebCrypto format");return c.signatureValue=g,new Wx(ae.serialize(c))}}var zV;(function(r){r[r.unspecified=0]="unspecified",r[r.keyCompromise=1]="keyCompromise",r[r.cACompromise=2]="cACompromise",r[r.affiliationChanged=3]="affiliationChanged",r[r.superseded=4]="superseded",r[r.cessationOfOperation=5]="cessationOfOperation",r[r.certificateHold=6]="certificateHold",r[r.removeFromCRL=8]="removeFromCRL",r[r.privilegeWithdrawn=9]="privilegeWithdrawn",r[r.aACompromise=10]="aACompromise"})(zV||(zV={})),Ri.register(LF,Fx),Ri.register(KF,DV),Ri.register(HF,NV),Ri.register(JF,c4),Ri.register(iS,Xp),Ri.register(QF,MV),Ri.register(fS,RV),Ri.register(nS,LV),d4.register($z,BV),d4.register(Ax,zx),_r.registerSingleton(Zp,mve),_r.registerSingleton(Zp,Li),Li.namedCurveSize.set("P-256",32),Li.namedCurveSize.set("K-256",32),Li.namedCurveSize.set("P-384",48),Li.namedCurveSize.set("P-521",66);function VV(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function vve(r){return new TextEncoder().encode(r)}function Eve(r){return new TextDecoder().decode(r)}function Sve(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var i=0;i<r.length;i++){var s=r.charAt(i),o=s.charCodeAt(0);if(t[o]!==255)throw new TypeError(s+" is ambiguous");t[o]=i}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),d=Math.log(256)/Math.log(a);function h(f){if(f instanceof Uint8Array||(ArrayBuffer.isView(f)?f=new Uint8Array(f.buffer,f.byteOffset,f.byteLength):Array.isArray(f)&&(f=Uint8Array.from(f))),!(f instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(f.length===0)return"";for(var g=0,w=0,y=0,b=f.length;y!==b&&f[y]===0;)y++,g++;for(var v=(b-y)*d+1>>>0,E=new Uint8Array(v);y!==b;){for(var C=f[y],k=0,x=v-1;(C!==0||k<w)&&x!==-1;x--,k++)C+=256*E[x]>>>0,E[x]=C%a>>>0,C=C/a>>>0;if(C!==0)throw new Error("Non-zero carry");w=k,y++}for(var I=v-w;I!==v&&E[I]===0;)I++;for(var T=c.repeat(g);I<v;++I)T+=r.charAt(E[I]);return T}function p(f){if(typeof f!="string")throw new TypeError("Expected String");if(f.length===0)return new Uint8Array;var g=0;if(f[g]!==" "){for(var w=0,y=0;f[g]===c;)w++,g++;for(var b=(f.length-g)*l+1>>>0,v=new Uint8Array(b);f[g];){var E=t[f.charCodeAt(g)];if(E===255)return;for(var C=0,k=b-1;(E!==0||C<y)&&k!==-1;k--,C++)E+=a*v[k]>>>0,v[k]=E%256>>>0,E=E/256>>>0;if(E!==0)throw new Error("Non-zero carry");y=C,g++}if(f[g]!==" "){for(var x=b-y;x!==b&&v[x]===0;)x++;for(var I=new Uint8Array(w+(b-x)),T=w;x!==b;)I[T++]=v[x++];return I}}}function m(f){var g=p(f);if(g)return g;throw new Error(`Non-${e} character`)}return{encode:h,decodeUnsafe:p,decode:m}}var xve=Sve,Ave=xve;let Cve=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseEncode");this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},Ive=class{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseDecode");u(this,"prefixCodePoint");this.name=e,this.prefix=t;const i=t.codePointAt(0);if(i===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=i,this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return KV(this,e)}},kve=class{constructor(e){u(this,"decoders");this.decoders=e}or(e){return KV(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};function KV(r,e){return new kve({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}let _ve=class{constructor(e,t,n,i){u(this,"name");u(this,"prefix");u(this,"baseEncode");u(this,"baseDecode");u(this,"encoder");u(this,"decoder");this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=i,this.encoder=new Cve(e,t,n),this.decoder=new Ive(e,t,i)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};function f4({name:r,prefix:e,encode:t,decode:n}){return new _ve(r,e,t,n)}function e0({name:r,prefix:e,alphabet:t}){const{encode:n,decode:i}=Ave(t,r);return f4({prefix:e,name:r,encode:n,decode:s=>VV(i(s))})}function Tve(r,e,t,n){const i={};for(let d=0;d<e.length;++d)i[e[d]]=d;let s=r.length;for(;r[s-1]==="=";)--s;const o=new Uint8Array(s*t/8|0);let a=0,c=0,l=0;for(let d=0;d<s;++d){const h=i[r[d]];if(h===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|h,a+=t,a>=8&&(a-=8,o[l++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o}function Pve(r,e,t){const n=e[e.length-1]==="=",i=(1<<t)-1;let s="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,s+=e[i&a>>o];if(o!==0&&(s+=e[i&a<<t-o]),n)for(;s.length*t&7;)s+="=";return s}function Pr({name:r,prefix:e,bitsPerChar:t,alphabet:n}){return f4({prefix:e,name:r,encode(i){return Pve(i,n,t)},decode(i){return Tve(i,n,t,r)}})}const Dve=Pr({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),$ve=Pr({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),Gx=Pr({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),Nve=Pr({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),Mve=Object.freeze(Object.defineProperty({__proto__:null,base64:Dve,base64pad:$ve,base64url:Gx,base64urlpad:Nve},Symbol.toStringTag,{value:"Module"}));var Ove=HV,jV=128,Rve=-128,Lve=Math.pow(2,31);function HV(r,e,t){e=e||[],t=t||0;for(var n=t;r>=Lve;)e[t++]=r&255|jV,r/=128;for(;r&Rve;)e[t++]=r&255|jV,r>>>=7;return e[t]=r|0,HV.bytes=t-n+1,e}var Bve=Qx,Uve=128,qV=127;function Qx(r,n){var t=0,n=n||0,i=0,s=n,o,a=r.length;do{if(s>=a)throw Qx.bytes=0,new RangeError("Could not decode varint");o=r[s++],t+=i<28?(o&qV)<<i:(o&qV)*Math.pow(2,i),i+=7}while(o>=Uve);return Qx.bytes=s-n,t}var Fve=Math.pow(2,7),zve=Math.pow(2,14),Vve=Math.pow(2,21),Kve=Math.pow(2,28),jve=Math.pow(2,35),Hve=Math.pow(2,42),qve=Math.pow(2,49),Wve=Math.pow(2,56),Gve=Math.pow(2,63),Qve=function(r){return r<Fve?1:r<zve?2:r<Vve?3:r<Kve?4:r<jve?5:r<Hve?6:r<qve?7:r<Wve?8:r<Gve?9:10},Yve={encode:Ove,decode:Bve,encodingLength:Qve},p4=Yve;function WV(r,e=0){return[p4.decode(r,e),p4.decode.bytes]}function GV(r,e,t=0){return p4.encode(r,e,t),e}function QV(r){return p4.encodingLength(r)}function g4(r,e){const t=e.byteLength,n=QV(r),i=n+QV(t),s=new Uint8Array(i+t);return GV(r,s,0),GV(t,s,n),s.set(e,i),new YV(r,t,e,s)}function Jve(r){const e=VV(r),[t,n]=WV(e),[i,s]=WV(e.subarray(n)),o=e.subarray(n+s);if(o.byteLength!==i)throw new Error("Incorrect length");return new YV(t,i,o,e)}let YV=class{constructor(e,t,n,i){u(this,"code");u(this,"size");u(this,"digest");u(this,"bytes");this.code=e,this.size=t,this.digest=n,this.bytes=i}};function Xve({name:r,code:e,encode:t}){return new Zve(r,e,t)}let Zve=class{constructor(e,t,n){u(this,"name");u(this,"code");u(this,"encode");this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?g4(this.code,t):t.then(n=>g4(this.code,n))}else throw Error("Unknown type, must be binary type")}};function e7e(r){return async e=>new Uint8Array(await crypto.subtle.digest(r,e))}const Yx=Xve({name:"sha2-256",code:18,encode:e7e("SHA-256")});class t7e extends er{async listen(){throw new z6e("WebRTCTransport.createListener")}getAddrs(){return[]}updateAnnounceAddrs(){}async close(){}}const r7e=e0({prefix:"9",name:"base10",alphabet:"0123456789"}),n7e=Object.freeze(Object.defineProperty({__proto__:null,base10:r7e},Symbol.toStringTag,{value:"Module"})),i7e=Pr({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),s7e=Pr({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),o7e=Object.freeze(Object.defineProperty({__proto__:null,base16:i7e,base16upper:s7e},Symbol.toStringTag,{value:"Module"})),a7e=Pr({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),c7e=Object.freeze(Object.defineProperty({__proto__:null,base2:a7e},Symbol.toStringTag,{value:"Module"})),JV=Array.from("🚀🪐☄🛰🌌🌑🌒🌓🌔🌕🌖🌗🌘🌍🌏🌎🐉☀💻🖥💾💿😂❤😍🤣😊🙏💕😭😘👍😅👏😁🔥🥰💔💖💙😢🤔😆🙄💪😉☺👌🤗💜😔😎😇🌹🤦🎉💞✌✨🤷😱😌🌸🙌😋💗💚😏💛🙂💓🤩😄😀🖤😃💯🙈👇🎶😒🤭❣😜💋👀😪😑💥🙋😞😩😡🤪👊🥳😥🤤👉💃😳✋😚😝😴🌟😬🙃🍀🌷😻😓⭐✅🥺🌈😈🤘💦✔😣🏃💐☹🎊💘😠☝😕🌺🎂🌻😐🖕💝🙊😹🗣💫💀👑🎵🤞😛🔴😤🌼😫⚽🤙☕🏆🤫👈😮🙆🍻🍃🐶💁😲🌿🧡🎁⚡🌞🎈❌✊👋😰🤨😶🤝🚶💰🍓💢🤟🙁🚨💨🤬✈🎀🍺🤓😙💟🌱😖👶🥴▶➡❓💎💸⬇😨🌚🦋😷🕺⚠🙅😟😵👎🤲🤠🤧📌🔵💅🧐🐾🍒😗🤑🌊🤯🐷☎💧😯💆👆🎤🙇🍑❄🌴💣🐸💌📍🥀🤢👅💡💩👐📸👻🤐🤮🎼🥵🚩🍎🍊👼💍📣🥂"),l7e=JV.reduce((r,e,t)=>(r[t]=e,r),[]),u7e=JV.reduce((r,e,t)=>{const n=e.codePointAt(0);if(n==null)throw new Error(`Invalid character: ${e}`);return r[n]=t,r},[]);function d7e(r){return r.reduce((e,t)=>(e+=l7e[t],e),"")}function h7e(r){const e=[];for(const t of r){const n=t.codePointAt(0);if(n==null)throw new Error(`Invalid character: ${t}`);const i=u7e[n];if(i==null)throw new Error(`Non-base256emoji character: ${t}`);e.push(i)}return new Uint8Array(e)}const f7e=f4({prefix:"🚀",name:"base256emoji",encode:d7e,decode:h7e}),p7e=Object.freeze(Object.defineProperty({__proto__:null,base256emoji:f7e},Symbol.toStringTag,{value:"Module"})),g7e=Pr({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),y7e=Pr({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),m7e=Pr({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),w7e=Pr({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),b7e=Pr({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),v7e=Pr({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),E7e=Pr({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),S7e=Pr({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),x7e=Pr({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),A7e=Object.freeze(Object.defineProperty({__proto__:null,base32:g7e,base32hex:b7e,base32hexpad:E7e,base32hexpadupper:S7e,base32hexupper:v7e,base32pad:m7e,base32padupper:w7e,base32upper:y7e,base32z:x7e},Symbol.toStringTag,{value:"Module"})),C7e=e0({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),I7e=e0({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),k7e=Object.freeze(Object.defineProperty({__proto__:null,base36:C7e,base36upper:I7e},Symbol.toStringTag,{value:"Module"})),_7e=e0({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),T7e=e0({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),P7e=Object.freeze(Object.defineProperty({__proto__:null,base58btc:_7e,base58flickr:T7e},Symbol.toStringTag,{value:"Module"})),D7e=Pr({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),$7e=Object.freeze(Object.defineProperty({__proto__:null,base8:D7e},Symbol.toStringTag,{value:"Module"})),N7e=f4({prefix:"\0",name:"identity",encode:r=>Eve(r),decode:r=>vve(r)}),M7e=Object.freeze(Object.defineProperty({__proto__:null,identity:N7e},Symbol.toStringTag,{value:"Module"}));new TextEncoder,new TextDecoder;const O7e={...M7e,...c7e,...$7e,...n7e,...o7e,...A7e,...k7e,...P7e,...Mve,...p7e},XV=Object.values(O7e).map(r=>r.decoder).reduce((r,e)=>r.or(e)),R7e=/^a=fingerprint:(?:\w+-[0-9]+)\s(?<fingerprint>(:?[0-9a-fA-F]{2})+)$/m;function L7e(r){var t;if(r==null)return;const e=r.match(R7e);return(t=e==null?void 0:e.groups)==null?void 0:t.fingerprint}function ZV(r){const t=r.stringTuples().filter(n=>n[0]===u6e).map(n=>n[1])[0];if(t===void 0||t==="")throw new Z(`Couldn't find a certhash component of multiaddr: ${r.toString()}`);return t}function B7e(r){return Jve(XV.decode(r))}function U7e(r){const e=B7e(ZV(r)),t=z7e(e.code),n=e.digest.reduce((s,o)=>s+o.toString(16).padStart(2,"0"),""),i=n.match(/.{1,2}/g);if(i==null)throw new F6e(n,r.toString());return`${t} ${i.join(":").toUpperCase()}`}function F7e(r){const e=r.split(":").map(i=>parseInt(i,16)),t=Uint8Array.from(e),n=g4(Yx.code,t);return Oe(`/certhash/${Gx.encode(n.bytes)}`)}function z7e(r){switch(r){case 17:return"sha-1";case 18:return"sha-256";case 19:return"sha-512";default:throw new V6e(r)}}function V7e(r,e){const{host:t,port:n,family:i}=r.toOptions(),s=U7e(r);return{type:"answer",sdp:`v=0
o=- 0 0 IN IP${i} ${t}
s=-
t=0 0
a=ice-lite
m=application ${n} UDP/DTLS/SCTP webrtc-datachannel
c=IN IP${i} ${t}
a=mid:0
a=ice-options:ice2
a=ice-ufrag:${e}
a=ice-pwd:${e}
a=fingerprint:${s}
a=setup:passive
a=sctp-port:5000
a=max-message-size:${J3}
a=candidate:1467250027 1 UDP 1467250027 ${t} ${n} typ host
a=end-of-candidates
`}}function K7e(r,e){const{host:t,port:n,family:i}=r.toOptions();return{type:"offer",sdp:`v=0
o=- 0 0 IN IP${i} ${t}
s=-
c=IN IP${i} ${t}
t=0 0
a=ice-options:ice2,trickle
m=application ${n} UDP/DTLS/SCTP webrtc-datachannel
a=mid:0
a=setup:active
a=ice-ufrag:${e}
a=ice-pwd:${e}
a=fingerprint:sha-256 00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00
a=sctp-port:5000
a=max-message-size:${J3}
a=candidate:1467250027 1 UDP 1467250027 ${t} ${n} typ host
a=end-of-candidates
`}}function eK(r,e){if(r.sdp===void 0)throw new Z("Can't munge a missing SDP");const t=r.sdp.includes(`\r
`)?`\r
`:`
`;return r.sdp=r.sdp.replace(/\na=ice-ufrag:[^\n]*\n/,`
a=ice-ufrag:`+e+t).replace(/\na=ice-pwd:[^\n]*\n/,`
a=ice-pwd:`+e+t),r}const Jx=ie("libp2p-webrtc-noise:");function j7e(r,e,t){const n=r.trim().toLowerCase().replaceAll(":",""),i=ie(n,"hex"),s=g4(Yx.code,i),o=XV.decode(ZV(e)),a=Jx.byteLength+s.bytes.byteLength+o.byteLength;return sr(t==="server"?[Jx,o,s.bytes]:[Jx,s.bytes,o],a)}const H7e=KE?"iceconnectionstatechange":"connectionstatechange";async function q7e(r,e,t){var i,s,o;const n=r.createDataChannel("",{negotiated:!0,id:0});try{if(t.role==="client"){t.log.trace("client creating local offer");const f=await r.createOffer();t.log.trace("client created local offer %s",f.sdp);const g=eK(f,e);t.log.trace("client setting local offer %s",g.sdp),await r.setLocalDescription(g);const w=V7e(t.remoteAddr,e);t.log.trace("client setting server description %s",w.sdp),await r.setRemoteDescription(w)}else{const f=K7e(t.remoteAddr,e);t.log.trace("server setting client %s %s",f.type,f.sdp),await r.setRemoteDescription(f),t.log.trace("server creating local answer");const g=await r.createAnswer();t.log.trace("server created local answer");const w=eK(g,e);t.log.trace("server setting local description %s",g.sdp),await r.setLocalDescription(w)}if(n.readyState!=="open"&&(t.log.trace("%s wait for handshake channel to open, starting status %s",t.role,n.readyState),await _i(n,"open",t.signal)),t.log.trace("%s handshake channel opened",t.role),t.role==="server"){const f=((i=r.remoteFingerprint())==null?void 0:i.value)??"";t.remoteAddr=t.remoteAddr.encapsulate(F7e(f))}const a=L7e((s=r.localDescription)==null?void 0:s.sdp);if(a==null)throw new Ap("Could not get fingerprint from local description sdp");t.log.trace("%s performing noise handshake",t.role);const c=j7e(a,t.remoteAddr,t.role),l=hL({prologueBytes:c})(t),d=X3({channel:n,direction:"outbound",handshake:!0,logger:t.logger,...t.dataChannel??{}}),h=new jE(t,{peerConnection:r,remoteAddr:t.remoteAddr,timeline:{open:Date.now()},metrics:t.events});r.addEventListener(H7e,()=>{switch(r.connectionState){case"failed":case"disconnected":case"closed":h.close().catch(f=>{t.log.error("error closing connection",f),h.abort(f)});break;default:break}}),(o=t.events)==null||o.increment({peer_connection:!0});const p=new HE(t,{peerConnection:r,metrics:t.events,dataChannelOptions:t.dataChannel});if(t.role==="client")return t.log.trace("%s secure inbound",t.role),await l.secureInbound(d,{remotePeer:t.remotePeerId,signal:t.signal,skipStreamMuxerNegotiation:!0}),t.log.trace("%s upgrade outbound",t.role),await t.upgrader.upgradeOutbound(h,{skipProtection:!0,skipEncryption:!0,muxerFactory:p,signal:t.signal});t.log.trace("%s secure outbound",t.role);const m=await l.secureOutbound(d,{remotePeer:t.remotePeerId,signal:t.signal,skipStreamMuxerNegotiation:!0});h.remoteAddr=h.remoteAddr.encapsulate(`/p2p/${m.remotePeer}`),t.log.trace("%s upgrade inbound",t.role),await t.upgrader.upgradeInbound(h,{skipProtection:!0,skipEncryption:!0,muxerFactory:p,signal:t.signal})}catch(a){throw n.close(),a}}async function W7e(r,e,t,n){n==null&&(n=await RTCPeerConnection.generateCertificate({name:"ECDSA",namedCurve:"P-256"}));const i=typeof t=="function"?await t():t;return new RTCPeerConnection({...i??{},certificates:[n]})}async function G7e(r){const e=await GD(r),t=await crypto.subtle.exportKey("pkcs8",e.privateKey);return["-----BEGIN PRIVATE KEY-----",...re(new Uint8Array(t),"base64pad").split(/(.{64})/).filter(Boolean),"-----END PRIVATE KEY-----"].join(`
`)}SH=P2,EH=Symbol.toStringTag,vH=ur;class Q7e{constructor(e,t={}){u(this,"log");u(this,"metrics");u(this,"components");u(this,"init");u(this,"certificate");u(this,"privateKey");u(this,"emitter");u(this,"renewCertificateTask");u(this,SH,!0);u(this,EH,"@libp2p/webrtc-direct");u(this,vH,["@libp2p/transport"]);if(this.log=e.logger.forComponent("libp2p:webrtc-direct"),this.components=e,this.init=t,this.emitter=new er,t.certificateLifespan!=null&&t.certificateRenewalThreshold!=null&&t.certificateRenewalThreshold>=t.certificateLifespan)throw new Z("Certificate renewal threshold must be less than certificate lifespan");e.metrics!=null&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_webrtc-direct_dialer_events_total",{label:"event",help:"Total count of WebRTC-direct dial events by type"})})}async start(){this.certificate=await this.getCertificate()}async stop(){this.renewCertificateTask!=null&&clearTimeout(this.renewCertificateTask),this.certificate=void 0}async dial(e,t){var a;this.log("dial %a",e),t.signal.throwIfAborted();let n;const i=e.getPeerId();i!=null&&(n=tr(i));const s=R6e(),o=await W7e("client",s,typeof this.init.rtcConfiguration=="function"?await this.init.rtcConfiguration():this.init.rtcConfiguration??{});try{return await q7e(o,s,{role:"client",log:this.log,logger:this.components.logger,metrics:this.components.metrics,events:(a=this.metrics)==null?void 0:a.dialerEvents,signal:t.signal,remoteAddr:e,dataChannel:this.init.dataChannel,upgrader:t.upgrader,peerId:this.components.peerId,remotePeerId:n,privateKey:this.components.privateKey})}catch(c){throw o.close(),c}}createListener(e){if(this.certificate==null)throw new Il;return new t7e(this.components,{...this.init,...e,certificate:this.certificate,emitter:this.emitter})}listenFilter(e){return e.filter(O7.exactMatch)}dialFilter(e){return this.listenFilter(e)}async getCertificate(e){if(Y7e(this.init.certificate))return this.log("using provided TLS certificate"),this.init.certificate;const t=await this.loadOrCreatePrivateKey(),{pem:n,certhash:i}=await this.loadOrCreateCertificate(t,e);return{privateKey:await G7e(t),pem:n,certhash:i}}async loadOrCreatePrivateKey(){if(this.privateKey!=null)return this.privateKey;const e=this.init.certificateKeychainName??b6e,t=this.getKeychain();try{if(t==null)throw this.log("no keychain configured - not checking for stored private key"),new Zt;this.log.trace("checking for stored private key"),this.privateKey=await t.exportKey(e)}catch(n){if(n.name!=="NotFoundError")throw n;this.log.trace("generating private key"),this.privateKey=await hy("ECDSA","P-256"),t!=null?(this.log.trace("storing private key"),await t.importKey(e,this.privateKey)):this.log("no keychain configured - not storing private key")}return this.privateKey}async loadOrCreateCertificate(e,t){if(this.certificate!=null&&t!==!0)return this.certificate;let n;const i=new At(this.init.certificateDatastoreKey??w6e),s=await GD(e);try{if(t===!0)throw this.log.trace("forcing renewal of TLS certificate"),new Zt;this.log.trace("checking for stored TLS certificate"),n=await this.loadCertificate(i,s)}catch(a){if(a.name!=="NotFoundError")throw a;this.log.trace("generating new TLS certificate"),n=await this.createCertificate(i,s)}let o=n.notAfter.getTime()-(this.init.certificateRenewalThreshold??yF)-Date.now();return o<0&&(o=100),this.log("will renew TLS certificate after %d ms",o),this.renewCertificateTask=setTimeout(()=>{this.log("renewing TLS certificate"),this.getCertificate(!0).then(a=>{this.certificate=a,this.emitter.safeDispatchEvent("certificate:renew",{detail:a})}).catch(a=>{this.log.error("could not renew certificate - %e",a)})},o),{pem:n.toString("pem"),certhash:Gx.encode((await Yx.digest(new Uint8Array(n.rawData))).bytes)}}async loadCertificate(e,t){const n=await this.components.datastore.get(e),i=new Wx(n),s=i.notAfter.getTime()-(this.init.certificateRenewalThreshold??yF);if(Date.now()>s)throw this.log("stored TLS certificate has expired"),new Zt;this.log("loaded certificate, expires in %d ms",s);const o=await i.publicKey.export(crypto),a=await crypto.subtle.exportKey("raw",o),c=await crypto.subtle.exportKey("raw",t.publicKey);if(!qe(new Uint8Array(a,0,a.byteLength),new Uint8Array(c,0,c.byteLength)))throw this.log("stored TLS certificate public key did not match public key from private key"),new Zt;return this.log("loaded certificate, expiry time is %o",s),i}async createCertificate(e,t){const n=new Date,i=new Date(Date.now()+(this.init.certificateLifespan??v6e));n.setMilliseconds(0),i.setMilliseconds(0);const s=await bve.createSelfSigned({serialNumber:(BigInt(Math.random().toString().replace(".",""))*100000n).toString(16),name:"CN=example.com, C=US, L=CA, O=example, ST=CA",notBefore:n,notAfter:i,keys:t,extensions:[new Fx(!1,void 0,!0)]},crypto);return this.getKeychain()!=null?(this.log.trace("storing TLS certificate"),await this.components.datastore.put(e,ie(s.toString("pem")))):this.log("no keychain is configured so not storing TLS certificate since the private key will not be reused"),s}getKeychain(){try{return this.components.keychain}catch{}}}function Y7e(r){return r==null?!1:typeof r.privateKey=="string"&&typeof r.pem=="string"&&typeof r.certhash=="string"}function J7e(r){return e=>new Q7e(e,r)}function Xx(r){return e=>new q6e(e,r)}const X7e=async r=>{if(r.readyState>=2)throw new Error("socket closed");r.readyState!==1&&await new Promise((e,t)=>{function n(){r.removeEventListener("open",i),r.removeEventListener("error",s)}function i(){n(),e()}function s(o){n(),t(o.error??new Error(`connect ECONNREFUSED ${r.url}`))}r.addEventListener("open",i),r.addEventListener("error",s)})},Z7e=(r,e)=>(e=e??{},e.closeOnEnd=e.closeOnEnd!==!1,async n=>{for await(const i of n){try{await X7e(r)}catch(s){if(s.message==="socket closed")break;throw s}if(r.readyState===r.CLOSING||r.readyState===r.CLOSED)break;r.send(i)}e.closeOnEnd!=null&&r.readyState<=1&&await new Promise((i,s)=>{r.addEventListener("close",o=>{if(o.wasClean||o.code===1006)i();else{const a=Object.assign(new Error("ws error"),{event:o});s(a)}}),setTimeout(()=>{r.close()})})});var y4={},m4={};Object.defineProperty(m4,"__esModule",{value:!0});class e9e{constructor(){this.pullQueue=[],this.pushQueue=[],this.eventHandlers={},this.isPaused=!1,this.isStopped=!1}push(e){if(this.isStopped)return;const t={value:e,done:!1};if(this.pullQueue.length){const n=this.pullQueue.shift();n&&n.resolve(t)}else this.pushQueue.push(Promise.resolve(t)),this.highWaterMark!==void 0&&this.pushQueue.length>=this.highWaterMark&&!this.isPaused&&(this.isPaused=!0,this.eventHandlers.highWater?this.eventHandlers.highWater():console&&console.warn(`EventIterator queue reached ${this.pushQueue.length} items`))}stop(){if(!this.isStopped){this.isStopped=!0,this.remove();for(const e of this.pullQueue)e.resolve({value:void 0,done:!0});this.pullQueue.length=0}}fail(e){if(!this.isStopped)if(this.isStopped=!0,this.remove(),this.pullQueue.length){for(const t of this.pullQueue)t.reject(e);this.pullQueue.length=0}else{const t=Promise.reject(e);t.catch(()=>{}),this.pushQueue.push(t)}}remove(){Promise.resolve().then(()=>{this.removeCallback&&this.removeCallback()})}[Symbol.asyncIterator](){return{next:e=>{const t=this.pushQueue.shift();return t?(this.lowWaterMark!==void 0&&this.pushQueue.length<=this.lowWaterMark&&this.isPaused&&(this.isPaused=!1,this.eventHandlers.lowWater&&this.eventHandlers.lowWater()),t):this.isStopped?Promise.resolve({value:void 0,done:!0}):new Promise((n,i)=>{this.pullQueue.push({resolve:n,reject:i})})},return:()=>(this.isStopped=!0,this.pushQueue.length=0,this.remove(),Promise.resolve({value:void 0,done:!0}))}}}let tK=class{constructor(e,{highWaterMark:t=100,lowWaterMark:n=1}={}){const i=new e9e;i.highWaterMark=t,i.lowWaterMark=n,i.removeCallback=e({push:s=>i.push(s),stop:()=>i.stop(),fail:s=>i.fail(s),on:(s,o)=>{i.eventHandlers[s]=o}})||(()=>{}),this[Symbol.asyncIterator]=()=>i[Symbol.asyncIterator](),Object.freeze(this)}};m4.EventIterator=tK,m4.default=tK,Object.defineProperty(y4,"__esModule",{value:!0});const Zx=m4;var t9e=y4.EventIterator=Zx.EventIterator;function r9e(r,e,t){return new Zx.EventIterator(({push:n})=>(this.addEventListener(r,n,e),()=>this.removeEventListener(r,n,e)),t)}y4.subscribe=r9e,y4.default=Zx.EventIterator;function rK(r){var e;return r instanceof ArrayBuffer||((e=r==null?void 0:r.constructor)==null?void 0:e.name)==="ArrayBuffer"&&typeof(r==null?void 0:r.byteLength)=="number"}const n9e=r=>{r.binaryType="arraybuffer";const e=async()=>{await new Promise((s,o)=>{if(n){s();return}if(i!=null){o(i);return}const a=d=>{r.removeEventListener("open",c),r.removeEventListener("error",l),d()},c=()=>{a(s)},l=d=>{a(()=>{o(d.error??new Error(`connect ECONNREFUSED ${r.url}`))})};r.addEventListener("open",c),r.addEventListener("error",l)})},t=async function*(){const s=new t9e(({push:o,stop:a,fail:c})=>{const l=h=>{let p=null;typeof h.data=="string"&&(p=ie(h.data)),rK(h.data)&&(p=new Uint8Array(h.data)),h.data instanceof Uint8Array&&(p=h.data),p!=null&&o(p)},d=h=>{c(h.error??new Error("Socket error"))};return r.addEventListener("message",l),r.addEventListener("error",d),r.addEventListener("close",a),()=>{r.removeEventListener("message",l),r.removeEventListener("error",d),r.removeEventListener("close",a)}},{highWaterMark:1/0});await e();for await(const o of s)yield rK(o)?new Uint8Array(o):o}();let n=r.readyState===1,i;return r.addEventListener("open",()=>{n=!0,i=null}),r.addEventListener("close",()=>{n=!1,i=null}),r.addEventListener("error",s=>{n||(i=s.error??new Error(`connect ECONNREFUSED ${r.url}`))}),Object.assign(t,{connected:e})},i9e=(r,e)=>{e=e??{};const t=n9e(r);let n=e.remoteAddress,i=e.remotePort;if(r.url!=null)try{const o=new URL(r.url);n=o.hostname,i=parseInt(o.port,10)}catch{}if(n==null||i==null)throw new Error("Remote connection did not have address and/or port");return{sink:Z7e(r,e),source:t,connected:async()=>{await t.connected()},close:async()=>{(r.readyState===r.CONNECTING||r.readyState===r.OPEN)&&await new Promise(o=>{r.addEventListener("close",()=>{o()}),r.close()})},destroy:()=>{r.terminate!=null?r.terminate():r.close()},remoteAddress:n,remotePort:i,socket:r}},s9e=WebSocket,o9e={"http:":"ws:","https:":"wss:"},nK="ws:",a9e=(r,e)=>{if(r.startsWith("//")&&(r=`${(e==null?void 0:e.protocol)??nK}${r}`),r.startsWith("/")&&e!=null){const n=e.protocol??nK,i=e.host,s=e.port!=null&&(i==null?void 0:i.endsWith(`:${e.port}`))!==!0?`:${e.port}`:"";r=`${n}//${i}${s}${r}`}const t=new URL(r);for(const[n,i]of Object.entries(o9e))t.protocol===n&&(t.protocol=i);return t};function c9e(r,e){const t=typeof window>"u"?void 0:window.location;e=e??{};const n=a9e(r,t),i=new s9e(n.toString(),e.websocket);return i9e(i,e)}function l9e(r){return r.filter(e=>gm.exactMatch(e)||G1.exactMatch(e))}function u9e(){throw new Error("WebSocket Servers can not be created in the browser!")}const d9e=500;function h9e(r,e,t){const n=t.logger.forComponent("libp2p:websockets:maconn"),i=t.metrics,s=t.metricPrefix??"",o={log:n,async sink(a){try{await r.sink(async function*(){for await(const c of a)c instanceof Uint8Array?yield c:yield c.subarray()}())}catch(c){c.type!=="aborted"&&n.error(c)}},source:r.source,remoteAddr:e,timeline:{open:Date.now()},async close(a={}){var d,h;const c=Date.now();if(a.signal==null){const p=AbortSignal.timeout(d9e);a={...a,signal:p}}const l=()=>{const{host:p,port:m}=o.remoteAddr.toOptions();n("timeout closing stream to %s:%s after %dms, destroying it manually",p,m,Date.now()-c),this.abort(new Al("Socket close timeout"))};(d=a.signal)==null||d.addEventListener("abort",l);try{await r.close()}catch(p){n.error("error closing WebSocket gracefully",p),this.abort(p)}finally{(h=a.signal)==null||h.removeEventListener("abort",l),o.timeline.close=Date.now()}},abort(a){const{host:c,port:l}=o.remoteAddr.toOptions();n("timeout closing stream to %s:%s due to error",c,l,a),r.destroy(),o.timeline.close=Date.now(),i==null||i.increment({[`${s}error`]:!0})}};return r.socket.addEventListener("close",()=>{i==null||i.increment({[`${s}close`]:!0}),o.timeline.close==null&&(o.timeline.close=Date.now())},{once:!0}),o}CH=P2,AH=Symbol.toStringTag,xH=ur;class f9e{constructor(e,t={}){u(this,"log");u(this,"init");u(this,"logger");u(this,"metrics");u(this,"components");u(this,CH,!0);u(this,AH,"@libp2p/websockets");u(this,xH,["@libp2p/transport"]);this.log=e.logger.forComponent("libp2p:websockets"),this.logger=e.logger,this.components=e,this.init=t,e.metrics!=null&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_websockets_dialer_events_total",{label:"event",help:"Total count of WebSockets dialer events by type"})})}async dial(e,t){var o;this.log("dialing %s",e),t=t??{};const n=await this._connect(e,t),i=h9e(n,e,{logger:this.logger,metrics:(o=this.metrics)==null?void 0:o.dialerEvents});this.log("new outbound connection %s",i.remoteAddr);const s=await t.upgrader.upgradeOutbound(i,t);return this.log("outbound connection %s upgraded",i.remoteAddr),s}async _connect(e,t){var o,a,c,l,d;(o=t==null?void 0:t.signal)==null||o.throwIfAborted();const n=e.toOptions();this.log("dialing %s:%s",n.host,n.port);const i=Re(),s=c9e(DO(e),this.init);s.socket.addEventListener("error",()=>{var p;const h=new xb(`Could not connect to ${e.toString()}`);this.log.error("connection error:",h),(p=this.metrics)==null||p.dialerEvents.increment({error:!0}),i.reject(h)});try{(a=t.onProgress)==null||a.call(t,new ke("websockets:open-connection")),await an(Promise.race([s.connected(),i.promise]),t.signal)}catch(h){throw(c=t.signal)!=null&&c.aborted&&((l=this.metrics)==null||l.dialerEvents.increment({abort:!0})),s.close().catch(p=>{this.log.error("error closing raw socket",p)}),h}return this.log("connected %s",e),(d=this.metrics)==null||d.dialerEvents.increment({connect:!0}),s}createListener(e){return u9e({logger:this.logger,events:this.components.events,metrics:this.components.metrics},{...this.init,...e})}listenFilter(e){var t,n;return e=Array.isArray(e)?e:[e],((t=this.init)==null?void 0:t.filter)!=null?(n=this.init)==null?void 0:n.filter(e):l9e(e)}dialFilter(e){return this.listenFilter(e)}}function eA(r={}){return e=>new f9e(e,r)}function p9e(r,e){const t=e.map((n,i)=>({record:tp(n),index:i}));return t.sort((n,i)=>{const s=n.record.sequence,o=i.record.sequence;if(s>o)return-1;if(s<o)return 1;if(n.record.validityType===ss.ValidityType.EOL&&i.record.validityType===ss.ValidityType.EOL){const a=X7.fromString(n.record.validity).toDate(),c=X7.fromString(i.record.validity).toDate();if(a.getTime()>c.getTime())return-1;if(a.getTime()<c.getTime())return 1}return 0}),t[0].index}const iK="2.8.5",sK="js-libp2p";function oK(r,e){return`${r??sK}/${e??iK} browser/${globalThis.navigator.userAgent}`}const g9e="5.3.0",y9e="helia",m9e={list:["/dnsaddr/bootstrap.libp2p.io/p2p/QmNnooDu7bfjPFoTZYxMNLWUQJyrVwtbZg5gBMjTezGAJN","/dnsaddr/bootstrap.libp2p.io/p2p/QmbLHAnMoJPWSCR5Zhtx6BHJX9KiKNN6tpvbUcqanj75Nb","/dnsaddr/bootstrap.libp2p.io/p2p/QmcZf59bWwK5XFi76CZX8cbJ4BhTzzA3gU1ZjYZcYW3dwt","/dnsaddr/va1.bootstrap.libp2p.io/p2p/12D3KooWKnDdG3iXw9eTFijk3EWSunZcFi54Zka4wmtqtt6rPxc8","/ip4/104.131.131.82/tcp/4001/p2p/QmaCpDMGvV2BGHeYERUEnRQAwe3N8SzbUtfsmvsqQLuvuJ"]};function w9e(r={}){const e=`${y9e}/${g9e} ${oK()}`;return{privateKey:r.privateKey,dns:r.dns,nodeInfo:{userAgent:e},addresses:{listen:["/p2p-circuit","/webrtc"]},transports:[W9(),Xx(),J7e(),eA()],connectionEncrypters:[hL()],streamMuxers:[lye(),Z5e()],peerDiscovery:[V9(m9e)],services:{autoNAT:jye(),dcutr:y3e(),delegatedRouting:()=>s0e("https://delegated-ipfs.dev",F0e()),dht:Z4e({clientMode:!0,validators:{ipns:rR},selectors:{ipns:p9e}}),identify:G9(),identifyPush:T3e(),keychain:aF(r.keychain),ping:a6e()}}}async function b9e(r,e={}){const t=e.selfKey??"self",n=aF(e)({datastore:r,logger:Ry()});let i;return await r.has(new At(`/pkcs8/${t}`))?i=await n.exportKey(t):(i=await hy(e.keyType??"Ed25519"),await n.importKey(t,i)),i}const v9e=32,{code:E9e}=ze("dnsaddr");class S9e extends Error{constructor(e="Max recursive depth reached"){super(e),this.name="RecursionLimitError"}}const aK=async function(e,t={}){const n=t.maxRecursiveDepth??v9e;if(n===0)throw new S9e("Max recursive depth reached");const[,i]=e.stringTuples().find(([l])=>l===E9e)??[],o=await((t==null?void 0:t.dns)??bN()).query(`_dnsaddr.${i}`,{signal:t==null?void 0:t.signal,types:[cc.TXT]}),a=e.getPeerId(),c=[];for(const l of o.Answer){const d=l.data.replace(/["']/g,"").trim().split("=")[1];if(d==null||a!=null&&!d.includes(a))continue;const h=Oe(d);if(d.startsWith("/dnsaddr")){const p=await h.resolve({...t,maxRecursiveDepth:n-1});c.push(...p.map(m=>m.toString()))}else c.push(h.toString())}return c},x9e={addresses:{listen:[],announce:[],noAnnounce:[],announceFilter:r=>r},connectionManager:{resolvers:{dnsaddr:aK}},transportManager:{faultTolerance:xl.FATAL_ALL}};async function A9e(r){var t,n;const e=gE(x9e,r);if(e.connectionProtector===null&&((n=(t=globalThis.process)==null?void 0:t.env)==null?void 0:n.LIBP2P_FORCE_PNET)!=null)throw new Z("Private network is enforced, but no protector was provided");return e}function C9e(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function tA(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function I9e(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var i=0;i<r.length;i++){var s=r.charAt(i),o=s.charCodeAt(0);if(t[o]!==255)throw new TypeError(s+" is ambiguous");t[o]=i}var a=r.length,c=r.charAt(0),l=Math.log(a)/Math.log(256),d=Math.log(256)/Math.log(a);function h(f){if(f instanceof Uint8Array||(ArrayBuffer.isView(f)?f=new Uint8Array(f.buffer,f.byteOffset,f.byteLength):Array.isArray(f)&&(f=Uint8Array.from(f))),!(f instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(f.length===0)return"";for(var g=0,w=0,y=0,b=f.length;y!==b&&f[y]===0;)y++,g++;for(var v=(b-y)*d+1>>>0,E=new Uint8Array(v);y!==b;){for(var C=f[y],k=0,x=v-1;(C!==0||k<w)&&x!==-1;x--,k++)C+=256*E[x]>>>0,E[x]=C%a>>>0,C=C/a>>>0;if(C!==0)throw new Error("Non-zero carry");w=k,y++}for(var I=v-w;I!==v&&E[I]===0;)I++;for(var T=c.repeat(g);I<v;++I)T+=r.charAt(E[I]);return T}function p(f){if(typeof f!="string")throw new TypeError("Expected String");if(f.length===0)return new Uint8Array;var g=0;if(f[g]!==" "){for(var w=0,y=0;f[g]===c;)w++,g++;for(var b=(f.length-g)*l+1>>>0,v=new Uint8Array(b);f[g];){var E=t[f.charCodeAt(g)];if(E===255)return;for(var C=0,k=b-1;(E!==0||C<y)&&k!==-1;k--,C++)E+=a*v[k]>>>0,v[k]=E%256>>>0,E=E/256>>>0;if(E!==0)throw new Error("Non-zero carry");y=C,g++}if(f[g]!==" "){for(var x=b-y;x!==b&&v[x]===0;)x++;for(var I=new Uint8Array(w+(b-x)),T=w;x!==b;)I[T++]=v[x++];return I}}}function m(f){var g=p(f);if(g)return g;throw new Error(`Non-${e} character`)}return{encode:h,decodeUnsafe:p,decode:m}}var k9e=I9e,_9e=k9e;class T9e{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseEncode");this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}}class P9e{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseDecode");u(this,"prefixCodePoint");this.name=e,this.prefix=t;const i=t.codePointAt(0);if(i===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=i,this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return cK(this,e)}}class D9e{constructor(e){u(this,"decoders");this.decoders=e}or(e){return cK(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}}function cK(r,e){return new D9e({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}class $9e{constructor(e,t,n,i){u(this,"name");u(this,"prefix");u(this,"baseEncode");u(this,"baseDecode");u(this,"encoder");u(this,"decoder");this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=i,this.encoder=new T9e(e,t,n),this.decoder=new P9e(e,t,i)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}}function lK({name:r,prefix:e,encode:t,decode:n}){return new $9e(r,e,t,n)}function w4({name:r,prefix:e,alphabet:t}){const{encode:n,decode:i}=_9e(t,r);return lK({prefix:e,name:r,encode:n,decode:s=>tA(i(s))})}function N9e(r,e,t,n){const i={};for(let d=0;d<e.length;++d)i[e[d]]=d;let s=r.length;for(;r[s-1]==="=";)--s;const o=new Uint8Array(s*t/8|0);let a=0,c=0,l=0;for(let d=0;d<s;++d){const h=i[r[d]];if(h===void 0)throw new SyntaxError(`Non-${n} character`);c=c<<t|h,a+=t,a>=8&&(a-=8,o[l++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o}function M9e(r,e,t){const n=e[e.length-1]==="=",i=(1<<t)-1;let s="",o=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],o+=8;o>t;)o-=t,s+=e[i&a>>o];if(o!==0&&(s+=e[i&a<<t-o]),n)for(;s.length*t&7;)s+="=";return s}function na({name:r,prefix:e,bitsPerChar:t,alphabet:n}){return lK({prefix:e,name:r,encode(i){return M9e(i,n,t)},decode(i){return N9e(i,n,t,r)}})}const t0=na({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});na({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),na({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),na({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),na({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),na({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),na({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),na({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),na({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const rA=w4({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"});w4({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});const ia=w4({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});w4({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var O9e=dK,uK=128,R9e=-128,L9e=Math.pow(2,31);function dK(r,e,t){e=e||[],t=t||0;for(var n=t;r>=L9e;)e[t++]=r&255|uK,r/=128;for(;r&R9e;)e[t++]=r&255|uK,r>>>=7;return e[t]=r|0,dK.bytes=t-n+1,e}var B9e=nA,U9e=128,hK=127;function nA(r,n){var t=0,n=n||0,i=0,s=n,o,a=r.length;do{if(s>=a)throw nA.bytes=0,new RangeError("Could not decode varint");o=r[s++],t+=i<28?(o&hK)<<i:(o&hK)*Math.pow(2,i),i+=7}while(o>=U9e);return nA.bytes=s-n,t}var F9e=Math.pow(2,7),z9e=Math.pow(2,14),V9e=Math.pow(2,21),K9e=Math.pow(2,28),j9e=Math.pow(2,35),H9e=Math.pow(2,42),q9e=Math.pow(2,49),W9e=Math.pow(2,56),G9e=Math.pow(2,63),Q9e=function(r){return r<F9e?1:r<z9e?2:r<V9e?3:r<K9e?4:r<j9e?5:r<H9e?6:r<q9e?7:r<W9e?8:r<G9e?9:10},Y9e={encode:O9e,decode:B9e,encodingLength:Q9e},b4=Y9e;function iA(r,e=0){return[b4.decode(r,e),b4.decode.bytes]}function v4(r,e,t=0){return b4.encode(r,e,t),e}function E4(r){return b4.encodingLength(r)}function J9e(r,e){const t=e.byteLength,n=E4(r),i=n+E4(t),s=new Uint8Array(i+t);return v4(r,s,0),v4(t,s,n),s.set(e,i),new sA(r,t,e,s)}function fK(r){const e=tA(r),[t,n]=iA(e),[i,s]=iA(e.subarray(n)),o=e.subarray(n+s);if(o.byteLength!==i)throw new Error("Incorrect length");return new sA(t,i,o,e)}function X9e(r,e){if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&C9e(r.bytes,t.bytes)}}let sA=class{constructor(e,t,n,i){u(this,"code");u(this,"size");u(this,"digest");u(this,"bytes");this.code=e,this.size=t,this.digest=n,this.bytes=i}};function pK(r,e){const{bytes:t,version:n}=r;switch(n){case 0:return eEe(t,oA(r),e??ia.encoder);default:return tEe(t,oA(r),e??t0.encoder)}}const gK=new WeakMap;function oA(r){const e=gK.get(r);if(e==null){const t=new Map;return gK.set(r,t),t}return e}class Dr{constructor(e,t,n,i){u(this,"code");u(this,"version");u(this,"multihash");u(this,"bytes");u(this,"/");u(this,IH,"CID");this.code=t,this.version=e,this.multihash=n,this.bytes=i,this["/"]=i}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==r0)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==rEe)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return Dr.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=J9e(e,t);return Dr.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return Dr.equals(this,e)}static equals(e,t){const n=t;return n!=null&&e.code===n.code&&e.version===n.version&&X9e(e.multihash,n.multihash)}toString(e){return pK(this,e)}toJSON(){return{"/":pK(this)}}link(){return this}[(IH=Symbol.toStringTag,Symbol.for("nodejs.util.inspect.custom"))](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof Dr)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:i,multihash:s,bytes:o}=t;return new Dr(n,i,s,o??yK(n,i,s.bytes))}else if(t[nEe]===!0){const{version:n,multihash:i,code:s}=t,o=fK(i);return Dr.create(n,s,o)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==r0)throw new Error(`Version 0 CID must use dag-pb (code: ${r0}) block encoding`);return new Dr(e,t,n,n.bytes)}case 1:{const i=yK(e,t,n.bytes);return new Dr(e,t,n,i)}default:throw new Error("Invalid version")}}static createV0(e){return Dr.create(0,r0,e)}static createV1(e,t){return Dr.create(1,e,t)}static decode(e){const[t,n]=Dr.decodeFirst(e);if(n.length!==0)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=Dr.inspectBytes(e),n=t.size-t.multihashSize,i=tA(e.subarray(n,n+t.multihashSize));if(i.byteLength!==t.multihashSize)throw new Error("Incorrect length");const s=i.subarray(t.multihashSize-t.digestSize),o=new sA(t.multihashCode,t.digestSize,s,i);return[t.version===0?Dr.createV0(o):Dr.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[h,p]=iA(e.subarray(t));return t+=p,h};let i=n(),s=r0;if(i===18?(i=0,t=0):s=n(),i!==0&&i!==1)throw new RangeError(`Invalid CID version ${i}`);const o=t,a=n(),c=n(),l=t+c,d=l-o;return{version:i,codec:s,multihashCode:a,digestSize:c,multihashSize:d,size:l}}static parse(e,t){const[n,i]=Z9e(e,t),s=Dr.decode(i);if(s.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return oA(s).set(n,e),s}}function Z9e(r,e){switch(r[0]){case"Q":{const t=e??ia;return[ia.prefix,t.decode(`${ia.prefix}${r}`)]}case ia.prefix:{const t=e??ia;return[ia.prefix,t.decode(r)]}case t0.prefix:{const t=e??t0;return[t0.prefix,t.decode(r)]}case rA.prefix:{const t=e??rA;return[rA.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}}function eEe(r,e,t){const{prefix:n}=t;if(n!==ia.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const i=e.get(n);if(i==null){const s=t.encode(r).slice(1);return e.set(n,s),s}else return i}function tEe(r,e,t){const{prefix:n}=t,i=e.get(n);if(i==null){const s=t.encode(r);return e.set(n,s),s}else return i}const r0=112,rEe=18;function yK(r,e,t){const n=E4(r),i=n+E4(e),s=new Uint8Array(i+t.byteLength);return v4(r,s,0),v4(e,s,n),s.set(t,i),s}const nEe=Symbol.for("@ipld/js-cid/CID"),iEe=36e5,sEe=216e5;var wu;(function(r){(function(t){let n;t.codec=()=>(n==null&&(n=De((i,s,o={})=>{o.lengthDelimited!==!1&&s.fork(),i.key!=null&&i.key!==""&&(s.uint32(10),s.string(i.key)),i.value!=null&&i.value.byteLength>0&&(s.uint32(18),s.bytes(i.value)),o.lengthDelimited!==!1&&s.ldelim()},(i,s,o={})=>{const a={key:"",value:We(0)},c=s==null?i.len:i.pos+s;for(;i.pos<c;){const l=i.uint32();switch(l>>>3){case 1:{a.key=i.string();break}case 2:{a.value=i.bytes();break}default:{i.skipType(l&7);break}}}return a})),n),t.encode=i=>Pe(i,t.codec()),t.decode=(i,s)=>Te(i,t.codec(),s)})(r.Peer$metadataEntry||(r.Peer$metadataEntry={})),function(t){let n;t.codec=()=>(n==null&&(n=De((i,s,o={})=>{o.lengthDelimited!==!1&&s.fork(),i.key!=null&&i.key!==""&&(s.uint32(10),s.string(i.key)),i.value!=null&&(s.uint32(18),x4.codec().encode(i.value,s)),o.lengthDelimited!==!1&&s.ldelim()},(i,s,o={})=>{var l;const a={key:""},c=s==null?i.len:i.pos+s;for(;i.pos<c;){const d=i.uint32();switch(d>>>3){case 1:{a.key=i.string();break}case 2:{a.value=x4.codec().decode(i,i.uint32(),{limits:(l=o.limits)==null?void 0:l.value});break}default:{i.skipType(d&7);break}}}return a})),n),t.encode=i=>Pe(i,t.codec()),t.decode=(i,s)=>Te(i,t.codec(),s)}(r.Peer$tagsEntry||(r.Peer$tagsEntry={}));let e;r.codec=()=>(e==null&&(e=De((t,n,i={})=>{if(i.lengthDelimited!==!1&&n.fork(),t.addresses!=null)for(const s of t.addresses)n.uint32(10),S4.codec().encode(s,n);if(t.protocols!=null)for(const s of t.protocols)n.uint32(18),n.string(s);if(t.publicKey!=null&&(n.uint32(34),n.bytes(t.publicKey)),t.peerRecordEnvelope!=null&&(n.uint32(42),n.bytes(t.peerRecordEnvelope)),t.metadata!=null&&t.metadata.size!==0)for(const[s,o]of t.metadata.entries())n.uint32(50),r.Peer$metadataEntry.codec().encode({key:s,value:o},n);if(t.tags!=null&&t.tags.size!==0)for(const[s,o]of t.tags.entries())n.uint32(58),r.Peer$tagsEntry.codec().encode({key:s,value:o},n);t.updated!=null&&(n.uint32(64),n.uint64Number(t.updated)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{var a,c,l,d,h,p;const s={addresses:[],protocols:[],metadata:new Map,tags:new Map},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const m=t.uint32();switch(m>>>3){case 1:{if(((a=i.limits)==null?void 0:a.addresses)!=null&&s.addresses.length===i.limits.addresses)throw new yt('Decode error - map field "addresses" had too many elements');s.addresses.push(S4.codec().decode(t,t.uint32(),{limits:(c=i.limits)==null?void 0:c.addresses$}));break}case 2:{if(((l=i.limits)==null?void 0:l.protocols)!=null&&s.protocols.length===i.limits.protocols)throw new yt('Decode error - map field "protocols" had too many elements');s.protocols.push(t.string());break}case 4:{s.publicKey=t.bytes();break}case 5:{s.peerRecordEnvelope=t.bytes();break}case 6:{if(((d=i.limits)==null?void 0:d.metadata)!=null&&s.metadata.size===i.limits.metadata)throw new bD('Decode error - map field "metadata" had too many elements');const f=r.Peer$metadataEntry.codec().decode(t,t.uint32());s.metadata.set(f.key,f.value);break}case 7:{if(((h=i.limits)==null?void 0:h.tags)!=null&&s.tags.size===i.limits.tags)throw new bD('Decode error - map field "tags" had too many elements');const f=r.Peer$tagsEntry.codec().decode(t,t.uint32(),{limits:{value:(p=i.limits)==null?void 0:p.tags$value}});s.tags.set(f.key,f.value);break}case 8:{s.updated=t.uint64Number();break}default:{t.skipType(m&7);break}}}return s})),e),r.encode=t=>Pe(t,r.codec()),r.decode=(t,n)=>Te(t,r.codec(),n)})(wu||(wu={}));var S4;(function(r){let e;r.codec=()=>(e==null&&(e=De((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.multiaddr!=null&&t.multiaddr.byteLength>0&&(n.uint32(10),n.bytes(t.multiaddr)),t.isCertified!=null&&(n.uint32(16),n.bool(t.isCertified)),t.observed!=null&&(n.uint32(24),n.uint64Number(t.observed)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{const s={multiaddr:We(0)},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.multiaddr=t.bytes();break}case 2:{s.isCertified=t.bool();break}case 3:{s.observed=t.uint64Number();break}default:{t.skipType(a&7);break}}}return s})),e),r.encode=t=>Pe(t,r.codec()),r.decode=(t,n)=>Te(t,r.codec(),n)})(S4||(S4={}));var x4;(function(r){let e;r.codec=()=>(e==null&&(e=De((t,n,i={})=>{i.lengthDelimited!==!1&&n.fork(),t.value!=null&&t.value!==0&&(n.uint32(8),n.uint32(t.value)),t.expiry!=null&&(n.uint32(16),n.uint64(t.expiry)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{const s={value:0},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const a=t.uint32();switch(a>>>3){case 1:{s.value=t.uint32();break}case 2:{s.expiry=t.uint64();break}default:{t.skipType(a&7);break}}}return s})),e),r.encode=t=>Pe(t,r.codec()),r.decode=(t,n)=>Te(t,r.codec(),n)})(x4||(x4={}));function oEe(r,e){if(r.publicKey!=null||e.publicKey==null)return r;let t;if(r.type==="RSA"){const i=ia.decode(`z${r}`);t=fK(i)}const n=kn(e.publicKey,t);return Bd(n)}function aA(r,e,t){const n=wu.decode(e);return cA(r,n,t)}function cA(r,e,t){const n=new Map,i=BigInt(Date.now());for(const[s,o]of e.tags.entries())o.expiry!=null&&o.expiry<i||n.set(s,o);return{...e,id:oEe(r,e),addresses:e.addresses.filter(({observed:s})=>s!=null&&s>Date.now()-t).map(({multiaddr:s,isCertified:o})=>({multiaddr:Oe(s),isCertified:o??!1})),metadata:e.metadata,peerRecordEnvelope:e.peerRecordEnvelope??void 0,tags:n}}function aEe(r,e){return cEe(r.addresses,e.addresses)&&lEe(r.protocols,e.protocols)&&uEe(r.publicKey,e.publicKey)&&dEe(r.peerRecordEnvelope,e.peerRecordEnvelope)&&hEe(r.metadata,e.metadata)&&fEe(r.tags,e.tags)}function cEe(r,e){return wK(r,e,(t,n)=>!(t.isCertified!==n.isCertified||!qe(t.multiaddr,n.multiaddr)))}function lEe(r,e){return wK(r,e,(t,n)=>t===n)}function uEe(r,e){return mK(r,e)}function dEe(r,e){return mK(r,e)}function hEe(r,e){return bK(r,e,(t,n)=>qe(t,n))}function fEe(r,e){return bK(r,e,(t,n)=>t.value===n.value&&t.expiry===n.expiry)}function mK(r,e){return r==null&&e==null?!0:r!=null&&e!=null?qe(r,e):!1}function wK(r,e,t){if(r.length!==e.length)return!1;for(let n=0;n<r.length;n++)if(!t(r[n],e[n]))return!1;return!0}function bK(r,e,t){if(r.size!==e.size)return!1;for(const[n,i]of r.entries()){const s=e.get(n);if(s==null||!t(i,s))return!1}return!0}const vK="/peers/";function A4(r){if(!nP(r)||r.type==null)throw new Z("Invalid PeerId");const e=r.toCID().toString();return new At(`${vK}${e}`)}async function pEe(r,e,t,n){const i=new Map;for(const s of t){if(s==null)continue;if(s.multiaddr instanceof Uint8Array&&(s.multiaddr=Oe(s.multiaddr)),!Sm(s.multiaddr))throw new Z("Multiaddr was invalid");if(!await e(r,s.multiaddr))continue;const o=s.isCertified??!1,a=s.multiaddr.toString(),c=i.get(a);c!=null?s.isCertified=c.isCertified||o:i.set(a,{multiaddr:s.multiaddr,isCertified:o})}return[...i.values()].sort((s,o)=>s.multiaddr.toString().localeCompare(o.multiaddr.toString())).map(({isCertified:s,multiaddr:o})=>({isCertified:s,multiaddr:o.bytes}))}async function lA(r,e,t,n){var p,m;if(e==null)throw new Z("Invalid PeerData");if(e.publicKey!=null&&r.publicKey!=null&&!e.publicKey.equals(r.publicKey))throw new Z("publicKey bytes do not match peer id publicKey bytes");const i=(p=n.existingPeer)==null?void 0:p.peer;if(i!=null&&!r.equals(i.id))throw new Z("peer id did not match existing peer id");let s=(i==null?void 0:i.addresses)??[],o=new Set((i==null?void 0:i.protocols)??[]),a=(i==null?void 0:i.metadata)??new Map,c=(i==null?void 0:i.tags)??new Map,l=i==null?void 0:i.peerRecordEnvelope;if(t==="patch"){if((e.multiaddrs!=null||e.addresses!=null)&&(s=[],e.multiaddrs!=null&&s.push(...e.multiaddrs.map(f=>({isCertified:!1,multiaddr:f}))),e.addresses!=null&&s.push(...e.addresses)),e.protocols!=null&&(o=new Set(e.protocols)),e.metadata!=null){const f=e.metadata instanceof Map?[...e.metadata.entries()]:Object.entries(e.metadata);a=C4(f,{validate:EK})}if(e.tags!=null){const f=e.tags instanceof Map?[...e.tags.entries()]:Object.entries(e.tags);c=C4(f,{validate:SK,map:xK})}e.peerRecordEnvelope!=null&&(l=e.peerRecordEnvelope)}if(t==="merge"){if(e.multiaddrs!=null&&s.push(...e.multiaddrs.map(f=>({isCertified:!1,multiaddr:f}))),e.addresses!=null&&s.push(...e.addresses),e.protocols!=null&&(o=new Set([...o,...e.protocols])),e.metadata!=null){const f=e.metadata instanceof Map?[...e.metadata.entries()]:Object.entries(e.metadata);for(const[g,w]of f)w==null?a.delete(g):a.set(g,w);a=C4([...a.entries()],{validate:EK})}if(e.tags!=null){const f=e.tags instanceof Map?[...e.tags.entries()]:Object.entries(e.tags),g=new Map(c);for(const[w,y]of f)y==null?g.delete(w):g.set(w,y);c=C4([...g.entries()],{validate:SK,map:xK})}e.peerRecordEnvelope!=null&&(l=e.peerRecordEnvelope)}let d;(i==null?void 0:i.id.publicKey)!=null?d=ki(i.id.publicKey):e.publicKey!=null?d=ki(e.publicKey):r.publicKey!=null&&(d=ki(r.publicKey));const h={addresses:await pEe(r,n.addressFilter??(async()=>!0),s,(m=n.existingPeer)==null?void 0:m.peerPB.addresses),protocols:[...o.values()].sort((f,g)=>f.localeCompare(g)),metadata:a,tags:c,publicKey:d,peerRecordEnvelope:l};return h.addresses.forEach(f=>{var g,w,y;f.observed=((y=(w=(g=n.existingPeer)==null?void 0:g.peerPB.addresses)==null?void 0:w.find(b=>qe(b.multiaddr,b.multiaddr)))==null?void 0:y.observed)??Date.now()}),r.type!=="RSA"&&delete h.publicKey,h}function C4(r,e){var n;const t=new Map;for(const[i,s]of r)s!=null&&e.validate(i,s);for(const[i,s]of r.sort(([o],[a])=>o.localeCompare(a)))s!=null&&t.set(i,((n=e.map)==null?void 0:n.call(e,i,s))??s);return t}function EK(r,e){if(typeof r!="string")throw new Z("Metadata key must be a string");if(!(e instanceof Uint8Array))throw new Z("Metadata value must be a Uint8Array")}function SK(r,e){if(typeof r!="string")throw new Z("Tag name must be a string");if(e.value!=null){if(parseInt(`${e.value}`,10)!==e.value)throw new Z("Tag value must be an integer");if(e.value<0||e.value>100)throw new Z("Tag value must be between 0-100")}if(e.ttl!=null){if(parseInt(`${e.ttl}`,10)!==e.ttl)throw new Z("Tag ttl must be an integer");if(e.ttl<0)throw new Z("Tag ttl must be between greater than 0")}}function xK(r,e){let t;return e.expiry!=null&&(t=e.expiry),e.ttl!=null&&(t=BigInt(Date.now()+Number(e.ttl))),{value:e.value??0,expiry:t}}function AK(r){const e=r.toString().split("/")[2],t=Dr.parse(e,t0);return Ud(t)}function uA(r,e,t){const n=AK(r);return aA(n,e,t)}function gEe(r,e){return{prefix:vK,filters:(r.filters??[]).map(t=>({key:n,value:i})=>t(uA(n,i,e))),orders:(r.orders??[]).map(t=>(n,i)=>t(uA(n.key,n.value,e),uA(i.key,i.value,e)))}}class yEe{constructor(e,t={}){Ye(this,zn);u(this,"peerId");u(this,"datastore");u(this,"lock");u(this,"addressFilter");u(this,"log");u(this,"maxAddressAge");u(this,"maxPeerAge");this.log=e.logger.forComponent("libp2p:peer-store"),this.peerId=e.peerId,this.datastore=e.datastore,this.addressFilter=t.addressFilter,this.lock=u7({name:"peer-store",singleProcess:!0}),this.maxAddressAge=t.maxAddressAge??iEe,this.maxPeerAge=t.maxPeerAge??sEe}async has(e){try{return await this.load(e),!0}catch(t){if(t.name!=="NotFoundError")throw t}return!1}async delete(e){this.peerId.equals(e)||await this.datastore.delete(A4(e))}async load(e){const t=A4(e),n=await this.datastore.get(t),i=wu.decode(n);if(Ae(this,zn,V4).call(this,e,i))throw await this.datastore.delete(t),new Zt;return cA(e,i,this.peerId.equals(e)?1/0:this.maxAddressAge)}async save(e,t){const n=await Ae(this,zn,F4).call(this,e),i=await lA(e,t,"patch",{addressFilter:this.addressFilter});return Ae(this,zn,z4).call(this,e,i,n)}async patch(e,t){const n=await Ae(this,zn,F4).call(this,e),i=await lA(e,t,"patch",{addressFilter:this.addressFilter,existingPeer:n});return Ae(this,zn,z4).call(this,e,i,n)}async merge(e,t){const n=await Ae(this,zn,F4).call(this,e),i=await lA(e,t,"merge",{addressFilter:this.addressFilter,existingPeer:n});return Ae(this,zn,z4).call(this,e,i,n)}async*all(e){for await(const{key:t,value:n}of this.datastore.query(gEe(e??{},this.maxAddressAge))){const i=AK(t);if(i.equals(this.peerId))continue;const s=wu.decode(n);if(Ae(this,zn,V4).call(this,i,s)){await this.datastore.delete(t);continue}yield cA(i,s,this.peerId.equals(i)?1/0:this.maxAddressAge)}}}zn=new WeakSet,F4=async function(e){try{const t=A4(e),n=await this.datastore.get(t),i=wu.decode(n);if(Ae(this,zn,V4).call(this,e,i))throw await this.datastore.delete(t),new Zt;return{peerPB:i,peer:aA(e,n,this.maxAddressAge)}}catch(t){t.name!=="NotFoundError"&&this.log.error("invalid peer data found in peer store - %e",t)}},z4=async function(e,t,n){t.updated=Date.now();const i=wu.encode(t);return await this.datastore.put(A4(e),i),{peer:aA(e,i,this.maxAddressAge),previous:n==null?void 0:n.peer,updated:n==null||!aEe(t,n.peerPB)}},V4=function(e,t){if(t.updated==null)return!0;if(this.peerId.equals(e))return!1;const n=t.updated<Date.now()-this.maxPeerAge,i=Date.now()-this.maxAddressAge,s=t.addresses.filter(o=>o.observed!=null&&o.observed>i);return n&&s.length===0},kH=Symbol.toStringTag;class mEe{constructor(e,t={}){Ye(this,Jh);u(this,"store");u(this,"events");u(this,"peerId");u(this,"log");u(this,kH,"@libp2p/peer-store");this.log=e.logger.forComponent("libp2p:peer-store"),this.events=e.events,this.peerId=e.peerId,this.store=new yEe(e,t)}async forEach(e,t){this.log.trace("forEach await read lock");const n=await this.store.lock.readLock();this.log.trace("forEach got read lock");try{for await(const i of this.store.all(t))e(i)}finally{this.log.trace("forEach release read lock"),n()}}async all(e){this.log.trace("all await read lock");const t=await this.store.lock.readLock();this.log.trace("all got read lock");try{return await Qm(this.store.all(e))}finally{this.log.trace("all release read lock"),t()}}async delete(e){this.log.trace("delete await write lock");const t=await this.store.lock.writeLock();this.log.trace("delete got write lock");try{await this.store.delete(e)}finally{this.log.trace("delete release write lock"),t()}}async has(e){this.log.trace("has await read lock");const t=await this.store.lock.readLock();this.log.trace("has got read lock");try{return await this.store.has(e)}finally{this.log.trace("has release read lock"),t()}}async get(e){this.log.trace("get await read lock");const t=await this.store.lock.readLock();this.log.trace("get got read lock");try{return await this.store.load(e)}finally{this.log.trace("get release read lock"),t()}}async save(e,t){this.log.trace("save await write lock");const n=await this.store.lock.writeLock();this.log.trace("save got write lock");try{const i=await this.store.save(e,t);return Ae(this,Jh,K4).call(this,e,i),i.peer}finally{this.log.trace("save release write lock"),n()}}async patch(e,t){this.log.trace("patch await write lock");const n=await this.store.lock.writeLock();this.log.trace("patch got write lock");try{const i=await this.store.patch(e,t);return Ae(this,Jh,K4).call(this,e,i),i.peer}finally{this.log.trace("patch release write lock"),n()}}async merge(e,t){this.log.trace("merge await write lock");const n=await this.store.lock.writeLock();this.log.trace("merge got write lock");try{const i=await this.store.merge(e,t);return Ae(this,Jh,K4).call(this,e,i),i.peer}finally{this.log.trace("merge release write lock"),n()}}async consumePeerRecord(e,t){const n=await Cc.openAndCertify(e,Vs.DOMAIN),i=Ud(n.publicKey.toCID());if((t==null?void 0:t.equals(i))===!1)return this.log("envelope peer id was not the expected peer id - expected: %p received: %p",t,i),!1;const s=Vs.createFromProtobuf(n.payload);let o;try{o=await this.get(i)}catch(a){if(a.name!=="NotFoundError")throw a}if((o==null?void 0:o.peerRecordEnvelope)!=null){const a=await Cc.createFromProtobuf(o.peerRecordEnvelope),c=Vs.createFromProtobuf(a.payload);if(c.seqNumber>=s.seqNumber)return this.log("sequence number was lower or equal to existing sequence number - stored: %d received: %d",c.seqNumber,s.seqNumber),!1}return await this.patch(s.peerId,{peerRecordEnvelope:e,addresses:s.multiaddrs.map(a=>({isCertified:!0,multiaddr:a}))}),!0}}Jh=new WeakSet,K4=function(e,t){t.updated&&(this.peerId.equals(e)?this.events.safeDispatchEvent("self:peer:update",{detail:t}):this.events.safeDispatchEvent("peer:update",{detail:t}))};function wEe(r,e={}){return new mEe(r,e)}function bEe(r,e){let t;const n=function(){const i=function(){t=void 0,r()};clearTimeout(t),t=setTimeout(i,e)};return n.start=()=>{},n.stop=()=>{clearTimeout(t)},n}const CK=864e13,vEe=448,dA=449,EEe=53,SEe=54,xEe=55,AEe=56;class CEe{constructor(e,t={}){u(this,"log");u(this,"mappings");this.log=e.logger.forComponent("libp2p:address-manager:dns-mappings"),this.mappings=new Map}has(e){const t=this.findHost(e);for(const n of this.mappings.values())if(n.domain===t)return!0;return!1}add(e,t){t.forEach(n=>{this.log("add DNS mapping %s to %s",n,e);const i=pc(n)===!0;this.mappings.set(n,{domain:e,verified:i,expires:i?CK-Date.now():0,lastVerified:i?CK-Date.now():void 0})})}remove(e){const t=this.findHost(e);let n=!1;for(const[i,s]of this.mappings.entries())s.domain===t&&(this.log("removing %s to %s DNS mapping %e",i,s.domain,new Error("where")),this.mappings.delete(i),n=n||s.verified);return n}getAll(e){const t=[];for(let n=0;n<e.length;n++){const s=e[n].multiaddr.stringTuples(),o=s[0][1];if(o!=null)for(const[a,c]of this.mappings.entries()){if(o!==a)continue;this.maybeAddSNITuple(s,c.domain)&&(e.splice(n,1),n--,t.push({multiaddr:Oe(`/${s.map(d=>[ze(d[0]).name,d[1]].join("/")).join("/")}`),verified:c.verified,type:"dns-mapping",expires:c.expires,lastVerified:c.lastVerified}))}}return t}maybeAddSNITuple(e,t){var n;for(let i=0;i<e.length;i++)if(e[i][0]===vEe&&((n=e[i+1])==null?void 0:n[0])!==dA)return e.splice(i+1,0,[dA,t]),!0;return!1}confirm(e,t){const n=this.findHost(e);let i=!1;for(const[s,o]of this.mappings.entries())o.domain===n&&(this.log("marking %s to %s DNS mapping as verified",s,o.domain),i=o.verified,o.verified=!0,o.expires=Date.now()+t,o.lastVerified=Date.now());return i}unconfirm(e,t){const n=this.findHost(e);let i=!1;for(const[s,o]of this.mappings.entries())o.domain===n&&(this.log("removing verification of %s to %s DNS mapping",s,o.domain),i=i||o.verified,o.verified=!1,o.expires=Date.now()+t);return i}findHost(e){for(const t of e.stringTuples())if(t[0]===dA||t[0]===EEe||t[0]===SEe||t[0]===xEe||t[0]===AEe)return t[1]}}const hA=4,fA=41,pA=6,IEe=273;class kEe{constructor(e,t={}){u(this,"log");u(this,"mappings");this.log=e.logger.forComponent("libp2p:address-manager:ip-mappings"),this.mappings=new Map}has(e){const t=e.stringTuples();for(const n of this.mappings.values())for(const i of n)if(i.externalIp===t[0][1])return!0;return!1}add(e,t,n,i=t,s="tcp"){const o=`${e}-${t}-${s}`,a=this.mappings.get(o)??[],c={internalIp:e,internalPort:t,externalIp:n,externalPort:i,externalFamily:Gd(n)?4:6,protocol:s,verified:!1,expires:0};a.push(c),this.mappings.set(o,a)}remove(e){const t=e.stringTuples(),n=t[0][1]??"",i=t[1][0]===pA?"tcp":"udp",s=parseInt(t[1][1]??"0");let o=!1;for(const[a,c]of this.mappings.entries()){for(let l=0;l<c.length;l++){const d=c[l];d.externalIp===n&&d.externalPort===s&&d.protocol===i&&(this.log("removing %s:%s to %s:%s %s IP mapping",d.externalIp,d.externalPort,n,s,i),o=o||d.verified,c.splice(l,1),l--)}c.length===0&&this.mappings.delete(a)}return o}getAll(e){const t=[];for(const{multiaddr:n}of e){const i=n.stringTuples();let s;if((i[0][0]===hA||i[0][0]===fA)&&i[1][0]===pA?s=`${i[0][1]}-${i[1][1]}-tcp`:(i[0][0]===hA||i[0][0]===fA)&&i[1][0]===IEe&&(s=`${i[0][1]}-${i[1][1]}-udp`),s==null)continue;const o=this.mappings.get(s);if(o!=null)for(const a of o)i[0][0]=a.externalFamily===4?hA:fA,i[0][1]=a.externalIp,i[1][1]=`${a.externalPort}`,t.push({multiaddr:Oe(`/${i.map(c=>[ze(c[0]).name,c[1]].join("/")).join("/")}`),verified:a.verified,type:"ip-mapping",expires:a.expires,lastVerified:a.lastVerified})}return t}confirm(e,t){const i=e.stringTuples()[0][1];let s=!1;for(const o of this.mappings.values())for(const a of o)a.externalIp===i&&(this.log("marking %s to %s IP mapping as verified",a.internalIp,a.externalIp),s=a.verified,a.verified=!0,a.expires=Date.now()+t,a.lastVerified=Date.now());return s}unconfirm(e,t){const n=e.stringTuples(),i=n[0][1]??"",s=n[1][0]===pA?"tcp":"udp",o=parseInt(n[1][1]??"0");let a=!1;for(const c of this.mappings.values())for(let l=0;l<c.length;l++){const d=c[l];d.externalIp===i&&d.externalPort===o&&d.protocol===s&&(this.log("removing verification of %s:%s to %s:%s %s IP mapping",d.externalIp,d.externalPort,i,o,s),a=a||d.verified,d.verified=!1,d.expires=Date.now()+t)}return a}}const _Ee=4,TEe=41;function PEe(r){try{const[[e,t]]=r.stringTuples();if(t==null)return!1;if(e===_Ee)return t.startsWith("169.254.");if(e===TEe)return t.toLowerCase().startsWith("fe80")}catch{}return!1}const DEe={maxObservedAddresses:10};class $Ee{constructor(e,t={}){u(this,"log");u(this,"addresses");u(this,"maxObservedAddresses");this.log=e.logger.forComponent("libp2p:address-manager:observed-addresses"),this.addresses=new Map,this.maxObservedAddresses=t.maxObservedAddresses??DEe.maxObservedAddresses}has(e){return this.addresses.has(e.toString())}removePrefixed(e){for(const t of this.addresses.keys())t.toString().startsWith(e)&&this.addresses.delete(t)}add(e){this.addresses.size!==this.maxObservedAddresses&&(ql(e)||PEe(e)||(this.log("adding observed address %a",e),this.addresses.set(e.toString(),{verified:!1,expires:0})))}getAll(){return Array.from(this.addresses).map(([e,t])=>({multiaddr:Oe(e),verified:t.verified,type:"observed",expires:t.expires,lastVerified:t.lastVerified}))}remove(e){var n;const t=((n=this.addresses.get(e.toString()))==null?void 0:n.verified)??!1;return this.log("removing observed address %a",e),this.addresses.delete(e.toString()),t}confirm(e,t){const n=e.toString(),i=this.addresses.get(n)??{verified:!1,expires:Date.now()+t,lastVerified:Date.now()},s=i.verified;return i.verified=!0,i.expires=Date.now()+t,i.lastVerified=Date.now(),this.log("marking observed address %a as verified",n),this.addresses.set(n,i),s}}const NEe=[4,41,53,54,55,56];function IK(r){try{const[[e]]=r.stringTuples();return NEe.includes(e)}catch{}return!1}const MEe={maxObservedAddresses:10};class OEe{constructor(e,t={}){u(this,"log");u(this,"addresses");u(this,"maxObservedAddresses");this.log=e.logger.forComponent("libp2p:address-manager:observed-addresses"),this.addresses=new Map,this.maxObservedAddresses=t.maxObservedAddresses??MEe.maxObservedAddresses}get(e,t){if(ql(e))return{multiaddr:e,verified:!0,type:"transport",expires:Date.now()+t,lastVerified:Date.now()};const n=this.toKey(e);let i=this.addresses.get(n);return i==null&&(i={verified:!IK(e),expires:0},this.addresses.set(n,i)),{multiaddr:e,verified:i.verified,type:"transport",expires:i.expires,lastVerified:i.lastVerified}}has(e){const t=this.toKey(e);return this.addresses.has(t)}remove(e){var i;const t=this.toKey(e),n=((i=this.addresses.get(t))==null?void 0:i.verified)??!1;return this.log("removing observed address %a",e),this.addresses.delete(t),n}confirm(e,t){const n=this.toKey(e),i=this.addresses.get(n)??{verified:!1,expires:0,lastVerified:0},s=i.verified;return i.verified=!0,i.expires=Date.now()+t,i.lastVerified=Date.now(),this.addresses.set(n,i),s}unconfirm(e,t){const n=this.toKey(e),i=this.addresses.get(n)??{verified:!1,expires:0},s=i.verified;return i.verified=!1,i.expires=Date.now()+t,this.addresses.set(n,i),s}toKey(e){if(IK(e)){const t=e.toOptions();return`${t.host}-${t.port}-${t.transport}`}return e.toString()}}const kK=6e4,_K={addressVerificationTTL:kK*10,addressVerificationRetry:kK*5},REe=r=>r;function gA(r,e){const t=r.getPeerId();return t!=null&&tr(t).equals(e)&&(r=r.decapsulate(Oe(`/p2p/${e.toString()}`))),r}_H=Symbol.toStringTag;class LEe{constructor(e,t={}){u(this,"log");u(this,"components");u(this,"listen");u(this,"announce");u(this,"appendAnnounce");u(this,"announceFilter");u(this,"observed");u(this,"dnsMappings");u(this,"ipMappings");u(this,"transportAddresses");u(this,"observedAddressFilter");u(this,"addressVerificationTTL");u(this,"addressVerificationRetry");u(this,_H,"@libp2p/address-manager");const{listen:n=[],announce:i=[],appendAnnounce:s=[]}=t;this.components=e,this.log=e.logger.forComponent("libp2p:address-manager"),this.listen=n.map(o=>o.toString()),this.announce=new Set(i.map(o=>o.toString())),this.appendAnnounce=new Set(s.map(o=>o.toString())),this.observed=new $Ee(e,t),this.dnsMappings=new CEe(e,t),this.ipMappings=new kEe(e,t),this.transportAddresses=new OEe(e,t),this.announceFilter=t.announceFilter??REe,this.observedAddressFilter=Ll(1024),this.addressVerificationTTL=t.addressVerificationTTL??_K.addressVerificationTTL,this.addressVerificationRetry=t.addressVerificationRetry??_K.addressVerificationRetry,this._updatePeerStoreAddresses=bEe(this._updatePeerStoreAddresses.bind(this),1e3),e.events.addEventListener("transport:listening",()=>{this._updatePeerStoreAddresses()}),e.events.addEventListener("transport:close",()=>{this._updatePeerStoreAddresses()})}_updatePeerStoreAddresses(){const e=this.getAddresses().map(t=>t.getPeerId()===this.components.peerId.toString()?t.decapsulate(`/p2p/${this.components.peerId.toString()}`):t);this.components.peerStore.patch(this.components.peerId,{multiaddrs:e}).catch(t=>{this.log.error("error updating addresses",t)})}getListenAddrs(){return Array.from(this.listen).map(e=>Oe(e))}getAnnounceAddrs(){return Array.from(this.announce).map(e=>Oe(e))}getAppendAnnounceAddrs(){return Array.from(this.appendAnnounce).map(e=>Oe(e))}getObservedAddrs(){return this.observed.getAll().map(e=>e.multiaddr)}addObservedAddr(e){const t=e.stringTuples(),n=`${t[0][1]}:${t[1][1]}`;this.observedAddressFilter.has(n)||(this.observedAddressFilter.add(n),e=gA(e,this.components.peerId),!this.ipMappings.has(e)&&(this.dnsMappings.has(e)||this.observed.add(e)))}confirmObservedAddr(e,t){e=gA(e,this.components.peerId);let n=!0;((t==null?void 0:t.type)==="transport"||this.transportAddresses.has(e))&&!this.transportAddresses.confirm(e,(t==null?void 0:t.ttl)??this.addressVerificationTTL)&&n&&(n=!1),((t==null?void 0:t.type)==="dns-mapping"||this.dnsMappings.has(e))&&!this.dnsMappings.confirm(e,(t==null?void 0:t.ttl)??this.addressVerificationTTL)&&n&&(n=!1),((t==null?void 0:t.type)==="ip-mapping"||this.ipMappings.has(e))&&!this.ipMappings.confirm(e,(t==null?void 0:t.ttl)??this.addressVerificationTTL)&&n&&(n=!1),((t==null?void 0:t.type)==="observed"||this.observed.has(e))&&(this.maybeUpgradeToIPMapping(e)?(this.ipMappings.confirm(e,(t==null?void 0:t.ttl)??this.addressVerificationTTL),n=!1):!this.observed.confirm(e,(t==null?void 0:t.ttl)??this.addressVerificationTTL)&&n&&(n=!1)),n||this._updatePeerStoreAddresses()}removeObservedAddr(e,t){e=gA(e,this.components.peerId),this.observed.has(e)&&this.observed.remove(e),this.transportAddresses.has(e)&&this.transportAddresses.unconfirm(e,(t==null?void 0:t.ttl)??this.addressVerificationRetry),this.dnsMappings.has(e)&&this.dnsMappings.unconfirm(e,(t==null?void 0:t.ttl)??this.addressVerificationRetry),this.ipMappings.has(e)&&this.ipMappings.unconfirm(e,(t==null?void 0:t.ttl)??this.addressVerificationRetry)}getAddresses(){const e=new Set,t=this.getAddressesWithMetadata().filter(n=>{if(!n.verified)return!1;const i=n.multiaddr.toString();return e.has(i)?!1:(e.add(i),!0)}).map(n=>n.multiaddr);return this.announceFilter(t.map(n=>{var s;const i=Oe(n);return((s=i.protos().pop())==null?void 0:s.path)===!0||i.getPeerId()===this.components.peerId.toString()?i:i.encapsulate(`/p2p/${this.components.peerId.toString()}`)}))}getAddressesWithMetadata(){const e=this.getAnnounceAddrs();if(e.length>0)return this.components.transportManager.getListeners().forEach(i=>{i.updateAnnounceAddrs(e)}),e.map(i=>({multiaddr:i,verified:!0,type:"announce",expires:Date.now()+this.addressVerificationTTL,lastVerified:Date.now()}));let t=[];t=t.concat(this.components.transportManager.getAddrs().map(i=>this.transportAddresses.get(i,this.addressVerificationTTL)));const n=this.getAppendAnnounceAddrs();return n.length>0&&(this.components.transportManager.getListeners().forEach(i=>{i.updateAnnounceAddrs(n)}),t=t.concat(n.map(i=>({multiaddr:i,verified:!0,type:"announce",expires:Date.now()+this.addressVerificationTTL,lastVerified:Date.now()})))),t=t.concat(this.observed.getAll()),t=t.concat(this.ipMappings.getAll(t)),t=t.concat(this.dnsMappings.getAll(t)),t}addDNSMapping(e,t){this.dnsMappings.add(e,t)}removeDNSMapping(e){this.dnsMappings.remove(Oe(`/dns/${e}`))&&this._updatePeerStoreAddresses()}addPublicAddressMapping(e,t,n,i=t,s="tcp"){this.ipMappings.add(e,t,n,i,s),this.observed.removePrefixed(`/ip${Gd(n)?4:6}/${n}/${s}/${i}`)}removePublicAddressMapping(e,t,n,i=t,s="tcp"){this.ipMappings.remove(Oe(`/ip${Gd(n)?4:6}/${n}/${s}/${i}`))&&this._updatePeerStoreAddresses()}maybeUpgradeToIPMapping(e){if(this.ipMappings.has(e))return!1;const t=e.toOptions();if(t.family===6||t.host==="127.0.0.1"||pc(t.host)===!0)return!1;const n=this.components.transportManager.getListeners(),i=[s=>G1.exactMatch(s)||gm.exactMatch(s),s=>fm.exactMatch(s),s=>ghe.exactMatch(s)];for(const s of i){if(!s(e))continue;const o=n.filter(l=>l.getAddrs().filter(d=>d.toOptions().family===4&&s(d)).length>0);if(o.length!==1)continue;const a=o[0].getAddrs().filter(l=>l.toOptions().host!=="127.0.0.1").pop();if(a==null)continue;const c=a.toOptions();return this.observed.remove(e),this.ipMappings.add(c.host,c.port,t.host,t.port,t.transport),!0}return!1}}var TK;(function(r){r.NOT_STARTED_YET="The libp2p node is not started yet",r.NOT_FOUND="Not found"})(TK||(TK={}));class BEe extends Error{constructor(e="Missing service"){super(e),this.name="MissingServiceError"}}class UEe extends Error{constructor(e="Unmet service dependencies"){super(e),this.name="UnmetServiceDependenciesError"}}class yA extends Error{constructor(e="No content routers available"){super(e),this.name="NoContentRoutersError"}}class PK extends Error{constructor(e="No peer routers available"){super(e),this.name="NoPeerRoutersError"}}class FEe extends Error{constructor(e="Should not try to find self"){super(e),this.name="QueriedForSelfError"}}class zEe extends Error{constructor(e="Unhandled protocol error"){super(e),this.name="UnhandledProtocolError"}}class VEe extends Error{constructor(e="Duplicate protocol handler error"){super(e),this.name="DuplicateProtocolHandlerError"}}class DK extends Error{constructor(e="Dial denied error"){super(e),this.name="DialDeniedError"}}class KEe extends Error{constructor(e="No transport was configured to listen on this address"){super(e),this.name="UnsupportedListenAddressError"}}class jEe extends Error{constructor(e="Configured listen addresses could not be listened on"){super(e),this.name="UnsupportedListenAddressesError"}}class HEe extends Error{constructor(e="No valid addresses"){super(e),this.name="NoValidAddressesError"}}class qEe extends Error{constructor(e="Connection intercepted"){super(e),this.name="ConnectionInterceptedError"}}class WEe extends Error{constructor(e="Connection denied"){super(e),this.name="ConnectionDeniedError"}}class I4 extends Error{constructor(e="Stream is not multiplexed"){super(e),this.name="MuxerUnavailableError"}}class k4 extends Error{constructor(e="Encryption failed"){super(e),this.name="EncryptionFailedError"}}class GEe extends Error{constructor(e="Transport unavailable"){super(e),this.name="TransportUnavailableError"}}class QEe{constructor(e={}){u(this,"components",{});u(this,"_started",!1);this.components={};for(const[t,n]of Object.entries(e))this.components[t]=n;this.components.logger==null&&(this.components.logger=Ry())}isStarted(){return this._started}async _invokeStartableMethod(e){await Promise.all(Object.values(this.components).filter(t=>Ib(t)).map(async t=>{var n;await((n=t[e])==null?void 0:n.call(t))}))}async beforeStart(){await this._invokeStartableMethod("beforeStart")}async start(){await this._invokeStartableMethod("start"),this._started=!0}async afterStart(){await this._invokeStartableMethod("afterStart")}async beforeStop(){await this._invokeStartableMethod("beforeStop")}async stop(){await this._invokeStartableMethod("stop"),this._started=!1}async afterStop(){await this._invokeStartableMethod("afterStop")}}const YEe=["metrics","connectionProtector","dns"],JEe=["components","isStarted","beforeStart","start","afterStart","beforeStop","stop","afterStop","then","_invokeStartableMethod"];function XEe(r={}){const e=new QEe(r);return new Proxy(e,{get(n,i,s){if(typeof i=="string"&&!JEe.includes(i)){const o=e.components[i];if(o==null&&!YEe.includes(i))throw new BEe(`${i} not set`);return o}return Reflect.get(n,i,s)},set(n,i,s){return typeof i=="string"?e.components[i]=s:Reflect.set(n,i,s),!0}})}function ZEe(r){const e={};for(const t of Object.values(r.components))for(const n of eSe(t))e[n]=!0;for(const t of Object.values(r.components))for(const n of tSe(t))if(e[n]!==!0)throw new UEe(`Service "${rSe(t)}" required capability "${n}" but it was not provided by any component, you may need to add additional configuration when creating your node.`)}function eSe(r){return Array.isArray(r==null?void 0:r[ur])?r[ur]:[]}function tSe(r){return Array.isArray(r==null?void 0:r[ja])?r[ja]:[]}function rSe(r){return(r==null?void 0:r[Symbol.toStringTag])??(r==null?void 0:r.toString())??"unknown"}const nSe=4,iSe=41;function sSe(r={}){return{denyDialPeer:async()=>!1,denyDialMultiaddr:async e=>{if(G1.matches(e))return!1;const t=e.stringTuples();return t[0][0]===nSe||t[0][0]===iSe?!!pc(`${t[0][1]}`):!1},denyInboundConnection:async()=>!1,denyOutboundConnection:async()=>!1,denyInboundEncryptedConnection:async()=>!1,denyOutboundEncryptedConnection:async()=>!1,denyInboundUpgradedConnection:async()=>!1,denyOutboundUpgradedConnection:async()=>!1,filterMultiaddrForPeer:async()=>!0,...r}}function $K(r){if(nP(r))return{peerId:r,multiaddrs:[]};let e=Array.isArray(r)?r:[r],t;if(e.length>0){const n=e[0].getPeerId();t=n==null?void 0:tr(n),e.forEach(i=>{if(!Sm(i))throw new $2("Invalid multiaddr");const s=i.getPeerId();if(s==null){if(t!=null)throw new Z("Multiaddrs must all have the same peer id or have no peer id")}else{const o=tr(s);if((t==null?void 0:t.equals(o))!==!0)throw new Z("Multiaddrs must all have the same peer id or have no peer id")}})}return e=e.filter(n=>!dhe.exactMatch(n)),{peerId:t,multiaddrs:e}}const oSe=["/ipfs/id/1.0.0","/ipfs/id/push/1.0.0","/libp2p/autonat/1.0.0","/libp2p/dcutr"];async function aSe(r,e){var i;const t=((i=r==null?void 0:r.streams)==null?void 0:i.map(s=>s.protocol))??[],n=(e==null?void 0:e.closableProtocols)??oSe;if(!(t.filter(s=>s!=null&&!n.includes(s)).length>0))try{await(r==null?void 0:r.close(e))}catch(s){r==null||r.abort(s)}}const NK=1e4,cSe=1e4,MK=1e4,OK=25,lSe=5,uSe=10,dSe=5,hSe="last-dial-failure",fSe="last-dial-success",RK=500,LK=100,BK=50;async function pSe(r,e){let t=!1;for(const i of J7.keys())if(t=r.protoNames().includes(i),t)break;if(!t)return[r];const n=await r.resolve(e);return e.log("resolved %s to",r,n.map(i=>i.toString())),n}function mA(r){try{let e;if(typeof r=="string"?e=Oe(r):e=r,!e.protoNames().includes("ipcidr")){const n=e.protoNames().includes("ip6")?"/ipcidr/128":"/ipcidr/32";e=e.encapsulate(n)}return t1e(e)}catch{throw new Error(`Can't convert to IpNet, Invalid multiaddr format: ${r}`)}}const gSe={maxConnections:LK};class ySe{constructor(e,t={}){u(this,"maxConnections");u(this,"connectionManager");u(this,"peerStore");u(this,"allow");u(this,"events");u(this,"log");this.maxConnections=t.maxConnections??gSe.maxConnections,this.allow=(t.allow??[]).map(n=>mA(n)),this.connectionManager=e.connectionManager,this.peerStore=e.peerStore,this.events=e.events,this.log=e.logger.forComponent("libp2p:connection-manager:connection-pruner"),this.maybePruneConnections=this.maybePruneConnections.bind(this)}start(){this.events.addEventListener("connection:open",this.maybePruneConnections)}stop(){this.events.removeEventListener("connection:open",this.maybePruneConnections)}maybePruneConnections(){this._maybePruneConnections().catch(e=>{this.log.error("error while pruning connections %e",e)})}async _maybePruneConnections(){const e=this.connectionManager.getConnections(),t=e.length;if(this.log("checking max connections limit %d/%d",t,this.maxConnections),t<=this.maxConnections)return;const n=new sc;for(const a of e){const c=a.remotePeer;if(!n.has(c)){n.set(c,0);try{const l=await this.peerStore.get(c);n.set(c,[...l.tags.values()].reduce((d,h)=>d+h.value,0))}catch(l){l.name!=="NotFoundError"&&this.log.error("error loading peer tags",l)}}}const i=this.sortConnections(e,n),s=Math.max(t-this.maxConnections,0),o=[];for(const a of i)if(this.log("too many connections open - closing a connection to %p",a.remotePeer),this.allow.some(l=>l.contains(a.remoteAddr.nodeAddress().address))||o.push(a),o.length===s)break;await Promise.all(o.map(async a=>{await aSe(a,{signal:AbortSignal.timeout(1e3)})})),this.events.safeDispatchEvent("connection:prune",{detail:o})}sortConnections(e,t){return e.sort((n,i)=>{const s=n.timeline.open,o=i.timeline.open;return s<o?1:s>o?-1:0}).sort((n,i)=>n.direction==="outbound"&&i.direction==="inbound"?1:n.direction==="inbound"&&i.direction==="outbound"?-1:0).sort((n,i)=>n.streams.length>i.streams.length?1:n.streams.length<i.streams.length?-1:0).sort((n,i)=>{const s=t.get(n.remotePeer)??0,o=t.get(i.remotePeer)??0;return s>o?1:s<o?-1:0})}}class mSe extends Ml{constructor(e={}){super({...e,sort:(t,n)=>t.options.priority>n.options.priority?-1:t.options.priority<n.options.priority?1:0})}}function wSe(r){return/^127\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/i.test(r)||/^::1$/.test(r)}function UK(r){if(!xL(r))return!1;const{address:e}=r.nodeAddress();return wSe(e)}function bSe(r,e){const t=fm.exactMatch(r.multiaddr),n=fm.exactMatch(e.multiaddr);if(t&&!n)return-1;if(!t&&n)return 1;const i=gm.exactMatch(r.multiaddr),s=gm.exactMatch(e.multiaddr);if(i&&!s)return-1;if(!i&&s)return 1;const o=G1.exactMatch(r.multiaddr),a=G1.exactMatch(e.multiaddr);if(o&&!a)return-1;if(!o&&a)return 1;const c=R7.exactMatch(r.multiaddr),l=R7.exactMatch(e.multiaddr);if(c&&!l)return-1;if(!c&&l)return 1;const d=O7.exactMatch(r.multiaddr),h=O7.exactMatch(e.multiaddr);if(d&&!h)return-1;if(!d&&h)return 1;const p=tO.exactMatch(r.multiaddr),m=tO.exactMatch(e.multiaddr);return p&&!m?-1:!p&&m?1:0}function vSe(r,e){const t=UK(r.multiaddr),n=UK(e.multiaddr);return t&&!n?1:!t&&n?-1:0}function ESe(r,e){const t=ql(r.multiaddr),n=ql(e.multiaddr);return t&&!n?1:!t&&n?-1:0}function SSe(r,e){return r.isCertified&&!e.isCertified?-1:!r.isCertified&&e.isCertified?1:0}function xSe(r,e){const t=gc.exactMatch(r.multiaddr),n=gc.exactMatch(e.multiaddr);return t&&!n?1:!t&&n?-1:0}function ASe(r){return r.sort(bSe).sort(SSe).sort(xSe).sort(ESe).sort(vSe)}const _4={maxParallelDials:BK,maxDialQueueLength:RK,maxPeerAddrsToDial:OK,dialTimeout:NK};class CSe{constructor(e,t={}){u(this,"queue");u(this,"components");u(this,"addressSorter");u(this,"maxPeerAddrsToDial");u(this,"maxDialQueueLength");u(this,"dialTimeout");u(this,"shutDownController");u(this,"connections");u(this,"log");this.addressSorter=t.addressSorter,this.maxPeerAddrsToDial=t.maxPeerAddrsToDial??_4.maxPeerAddrsToDial,this.maxDialQueueLength=t.maxDialQueueLength??_4.maxDialQueueLength,this.dialTimeout=t.dialTimeout??_4.dialTimeout,this.connections=t.connections??new sc,this.log=e.logger.forComponent("libp2p:connection-manager:dial-queue"),this.components=e,this.shutDownController=new AbortController,this.shutDownController.signal;for(const[n,i]of Object.entries(t.resolvers??{}))J7.set(n,i);this.queue=new mSe({concurrency:t.maxParallelDials??_4.maxParallelDials,metricName:"libp2p_dial_queue",metrics:e.metrics}),this.queue.addEventListener("error",n=>{var i;((i=n.detail)==null?void 0:i.name)!==Al.name&&this.log.error("error in dial queue - %e",n.detail)})}start(){this.shutDownController=new AbortController,this.shutDownController.signal}stop(){this.shutDownController.abort(),this.queue.abort()}async dial(e,t={}){var a,c,l;const{peerId:n,multiaddrs:i}=$K(e),s=Array.from(this.connections.values()).flat().find(d=>t.force===!0?!1:d.remotePeer.equals(n)?!0:i.find(h=>h.equals(d.remoteAddr)));if((s==null?void 0:s.status)==="open")return this.log("already connected to %a",s.remoteAddr),(a=t.onProgress)==null||a.call(t,new ke("dial-queue:already-connected")),s;const o=this.queue.queue.find(d=>{if((n==null?void 0:n.equals(d.options.peerId))===!0)return!0;const h=d.options.multiaddrs;if(h==null)return!1;for(const p of i)if(h.has(p.toString()))return!0;return!1});if(o!=null){this.log("joining existing dial target for %p",n);for(const d of i)o.options.multiaddrs.add(d.toString());return(c=t.onProgress)==null||c.call(t,new ke("dial-queue:already-in-dial-queue")),o.join(t)}if(this.queue.size>=this.maxDialQueueLength)throw new Ed("Dial queue is full");return this.log("creating dial target for %p",n,i.map(d=>d.toString())),(l=t.onProgress)==null||l.call(t,new ke("dial-queue:add-to-dial-queue")),this.queue.add(async d=>{var p;(p=d.onProgress)==null||p.call(d,new ke("dial-queue:start-dial"));const h=ft([this.shutDownController.signal,d.signal]);try{return await this.dialPeer(d,h)}finally{h.clear()}},{peerId:n,priority:t.priority??KK,multiaddrs:new Set(i.map(d=>d.toString())),signal:t.signal??AbortSignal.timeout(this.dialTimeout),onProgress:t.onProgress})}async dialPeer(e,t){var d;const n=e.peerId,i=e.multiaddrs,s=new Set;let o=e.multiaddrs.size===0,a=0,c=0;const l=[];for(this.log("starting dial to %p",n);o||i.size>0;){c++,o=!1;const h=[],p=new Set(e.multiaddrs);i.clear(),this.log("calculating addrs to dial %p from %s",n,[...p]);const m=await this.calculateMultiaddrs(n,p,{...e,signal:t});for(const f of m){if(s.has(f.multiaddr.toString())){this.log.trace("skipping previously failed multiaddr %a while dialing %p",f.multiaddr,n);continue}h.push(f)}this.log("%s dial to %p with %s",c===1?"starting":"continuing",n,h.map(f=>f.multiaddr.toString())),(d=e==null?void 0:e.onProgress)==null||d.call(e,new ke("dial-queue:calculated-addresses",h));for(const f of h){if(a===this.maxPeerAddrsToDial)throw this.log("dialed maxPeerAddrsToDial (%d) addresses for %p, not trying any others",a,e.peerId),new Ed("Peer had more than maxPeerAddrsToDial");a++;try{const g=await this.components.transportManager.dial(f.multiaddr,{...e,signal:t});this.log("dial to %a succeeded",f.multiaddr);try{await this.components.peerStore.merge(g.remotePeer,{multiaddrs:[g.remoteAddr],metadata:{[fSe]:ie(Date.now().toString())}})}catch(w){this.log.error("could not update last dial failure key for %p",n,w)}return g}catch(g){if(this.log.error("dial failed to %a",f.multiaddr,g),s.add(f.multiaddr.toString()),n!=null)try{await this.components.peerStore.merge(n,{metadata:{[hSe]:ie(Date.now().toString())}})}catch(w){this.log.error("could not update last dial failure key for %p",n,w)}if(t.aborted)throw new f1(g.message);l.push(g)}}}throw l.length===1?l[0]:new AggregateError(l,"All multiaddr dials failed")}async calculateMultiaddrs(e,t=new Set,n={}){var h,p;const i=[...t].map(m=>({multiaddr:Oe(m),isCertified:!1}));if(e!=null){if(this.components.peerId.equals(e))throw new Ed("Tried to dial self");if(await((p=(h=this.components.connectionGater).denyDialPeer)==null?void 0:p.call(h,e))===!0)throw new DK("The dial request is blocked by gater.allowDialPeer");if(i.length===0){this.log("loading multiaddrs for %p",e);try{const m=await this.components.peerStore.get(e);i.push(...m.addresses),this.log("loaded multiaddrs for %p",e,i.map(({multiaddr:f})=>f.toString()))}catch(m){if(m.name!=="NotFoundError")throw m}}if(i.length===0){this.log("looking up multiaddrs for %p in the peer routing",e);try{const m=await this.components.peerRouting.findPeer(e,n);this.log("found multiaddrs for %p in the peer routing",e,i.map(({multiaddr:f})=>f.toString())),i.push(...m.multiaddrs.map(f=>({multiaddr:f,isCertified:!1})))}catch(m){m.name==="NoPeerRoutersError"?this.log("no peer routers configured",e):this.log.error("looking up multiaddrs for %p in the peer routing failed - %e",e,m)}}}let s=(await Promise.all(i.map(async m=>{const f=await pSe(m.multiaddr,{dns:this.components.dns,...n,log:this.log});return f.length===1&&f[0].equals(m.multiaddr)?m:f.map(g=>({multiaddr:g,isCertified:!1}))}))).flat();if(e!=null){const m=`/p2p/${e.toString()}`;s=s.map(f=>{const g=f.multiaddr.protos().pop();return(g==null?void 0:g.path)===!0?f:f.multiaddr.getPeerId()==null?{multiaddr:f.multiaddr.encapsulate(m),isCertified:f.isCertified}:f})}const o=s.filter(m=>{if(this.components.transportManager.dialTransportForMultiaddr(m.multiaddr)==null)return!1;const f=m.multiaddr.getPeerId();return e!=null&&f!=null?e.equals(f):!0}),a=new Map;for(const m of o){const f=m.multiaddr.toString(),g=a.get(f);if(g!=null){g.isCertified=g.isCertified||m.isCertified||!1;continue}a.set(f,m)}const c=[...a.values()];if(c.length===0)throw new HEe("The dial request has no valid addresses");const l=[];for(const m of c)this.components.connectionGater.denyDialMultiaddr!=null&&await this.components.connectionGater.denyDialMultiaddr(m.multiaddr)||l.push(m);const d=this.addressSorter==null?ASe(l):l.sort(this.addressSorter);if(d.length===0)throw new DK("The connection gater denied all addresses in the dial request");return this.log.trace("addresses for %p before filtering",e??"unknown peer",s.map(({multiaddr:m})=>m.toString())),this.log.trace("addresses for %p after filtering",e??"unknown peer",d.map(({multiaddr:m})=>m.toString())),d}async isDialable(e,t={}){Array.isArray(e)||(e=[e]);try{const n=await this.calculateMultiaddrs(void 0,new Set(e.map(i=>i.toString())),t);return t.runOnLimitedConnection===!1?n.find(i=>!gc.matches(i.multiaddr))!=null:!0}catch(n){this.log.trace("error calculating if multiaddr(s) were dialable",n)}return!1}}var FK={};function Bi(r,e){typeof e=="boolean"&&(e={forever:e}),this._originalTimeouts=JSON.parse(JSON.stringify(r)),this._timeouts=r,this._options=e||{},this._maxRetryTime=e&&e.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}var ISe=Bi;Bi.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)},Bi.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null},Bi.prototype.retry=function(r){if(this._timeout&&clearTimeout(this._timeout),!r)return!1;var e=new Date().getTime();if(r&&e-this._operationStart>=this._maxRetryTime)return this._errors.push(r),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(r);var t=this._timeouts.shift();if(t===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),t=this._cachedTimeouts.slice(-1);else return!1;var n=this;return this._timer=setTimeout(function(){n._attempts++,n._operationTimeoutCb&&(n._timeout=setTimeout(function(){n._operationTimeoutCb(n._attempts)},n._operationTimeout),n._options.unref&&n._timeout.unref()),n._fn(n._attempts)},t),this._options.unref&&this._timer.unref(),!0},Bi.prototype.attempt=function(r,e){this._fn=r,e&&(e.timeout&&(this._operationTimeout=e.timeout),e.cb&&(this._operationTimeoutCb=e.cb));var t=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){t._operationTimeoutCb()},t._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)},Bi.prototype.try=function(r){console.log("Using RetryOperation.try() is deprecated"),this.attempt(r)},Bi.prototype.start=function(r){console.log("Using RetryOperation.start() is deprecated"),this.attempt(r)},Bi.prototype.start=Bi.prototype.try,Bi.prototype.errors=function(){return this._errors},Bi.prototype.attempts=function(){return this._attempts},Bi.prototype.mainError=function(){if(this._errors.length===0)return null;for(var r={},e=null,t=0,n=0;n<this._errors.length;n++){var i=this._errors[n],s=i.message,o=(r[s]||0)+1;r[s]=o,o>=t&&(e=i,t=o)}return e},function(r){var e=ISe;r.operation=function(t){var n=r.timeouts(t);return new e(n,{forever:t&&(t.forever||t.retries===1/0),unref:t&&t.unref,maxRetryTime:t&&t.maxRetryTime})},r.timeouts=function(t){if(t instanceof Array)return[].concat(t);var n={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var i in t)n[i]=t[i];if(n.minTimeout>n.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var s=[],o=0;o<n.retries;o++)s.push(this.createTimeout(o,n));return t&&t.forever&&!s.length&&s.push(this.createTimeout(o,n)),s.sort(function(a,c){return a-c}),s},r.createTimeout=function(t,n){var i=n.randomize?Math.random()+1:1,s=Math.round(i*Math.max(n.minTimeout,1)*Math.pow(n.factor,t));return s=Math.min(s,n.maxTimeout),s},r.wrap=function(t,n,i){if(n instanceof Array&&(i=n,n=null),!i){i=[];for(var s in t)typeof t[s]=="function"&&i.push(s)}for(var o=0;o<i.length;o++){var a=i[o],c=t[a];t[a]=(function(d){var h=r.operation(n),p=Array.prototype.slice.call(arguments,1),m=p.pop();p.push(function(f){h.retry(f)||(f&&(arguments[0]=h.mainError()),m.apply(this,arguments))}),h.attempt(function(){d.apply(t,p)})}).bind(t,c),t[a].options=n}}}(FK);var kSe=FK;const _Se=Je(kSe),TSe=Object.prototype.toString,PSe=r=>TSe.call(r)==="[object Error]",DSe=new Set(["network error","Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Load failed","Network request failed","fetch failed","terminated"]);function $Se(r){return r&&PSe(r)&&r.name==="TypeError"&&typeof r.message=="string"?r.message==="Load failed"?r.stack===void 0:DSe.has(r.message):!1}class NSe extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,{message:e}=e):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}}const zK=(r,e,t)=>{const n=t.retries-(e-1);return r.attemptNumber=e,r.retriesLeft=n,r};async function MSe(r,e){return new Promise((t,n)=>{e={...e},e.onFailedAttempt??(e.onFailedAttempt=()=>{}),e.shouldRetry??(e.shouldRetry=()=>!0),e.retries??(e.retries=10);const i=_Se.operation(e),s=()=>{var a;i.stop(),n((a=e.signal)==null?void 0:a.reason)};e.signal&&!e.signal.aborted&&e.signal.addEventListener("abort",s,{once:!0});const o=()=>{var a;(a=e.signal)==null||a.removeEventListener("abort",s),i.stop()};i.attempt(async a=>{try{const c=await r(a);o(),t(c)}catch(c){try{if(!(c instanceof Error))throw new TypeError(`Non-error was thrown: "${c}". You should only throw errors.`);if(c instanceof NSe)throw c.originalError;if(c instanceof TypeError&&!$Se(c))throw c;if(zK(c,a,e),await e.shouldRetry(c)||(i.stop(),n(c)),await e.onFailedAttempt(c),!i.retry(c))throw i.mainError()}catch(l){zK(l,a,e),o(),n(l)}}})})}class OSe{constructor(e,t={}){u(this,"log");u(this,"queue");u(this,"started");u(this,"peerStore");u(this,"retries");u(this,"retryInterval");u(this,"backoffFactor");u(this,"connectionManager");u(this,"events");this.log=e.logger.forComponent("libp2p:reconnect-queue"),this.peerStore=e.peerStore,this.connectionManager=e.connectionManager,this.queue=new ic({concurrency:t.maxParallelReconnects??dSe,metricName:"libp2p_reconnect_queue",metrics:e.metrics}),this.started=!1,this.retries=t.retries??5,this.backoffFactor=t.backoffFactor,this.retryInterval=t.retryInterval,this.events=e.events,e.events.addEventListener("peer:disconnect",n=>{this.maybeReconnect(n.detail).catch(i=>{this.log.error("failed to maybe reconnect to %p - %e",n.detail,i)})})}async maybeReconnect(e){if(!this.started)return;const t=await this.peerStore.get(e);VK(t)&&(this.queue.has(e)||this.queue.add(async n=>{await MSe(async i=>{if(this.started)try{await this.connectionManager.openConnection(e,{signal:n==null?void 0:n.signal})}catch(s){throw this.log("reconnecting to %p attempt %d of %d failed - %e",e,i,this.retries,s),s}},{signal:n==null?void 0:n.signal,retries:this.retries,factor:this.backoffFactor,minTimeout:this.retryInterval})},{peerId:e}).catch(async n=>{this.log.error("failed to reconnect to %p - %e",e,n);const i={};[...t.tags.keys()].forEach(s=>{s.startsWith(_2)&&(i[s]=void 0)}),await this.peerStore.merge(e,{tags:i}),this.events.safeDispatchEvent("peer:reconnect-failure",{detail:e})}).catch(async n=>{this.log.error("failed to remove keep-alive tag from %p - %e",e,n)}))}start(){this.started=!0}async afterStart(){Promise.resolve().then(async()=>{const e=await this.peerStore.all({filters:[t=>VK(t)]});await Promise.all(e.map(async t=>{await this.connectionManager.openConnection(t.id).catch(n=>{this.log.error(n)})}))}).catch(e=>{this.log.error(e)})}stop(){this.started=!1,this.queue.abort()}}function VK(r){for(const e of r.tags.keys())if(e.startsWith(_2))return!0;return!1}const KK=50,wA={maxConnections:LK,inboundConnectionThreshold:lSe,maxIncomingPendingConnections:uSe};TH=Symbol.toStringTag;class RSe{constructor(e,t={}){u(this,"started");u(this,"connections");u(this,"allow");u(this,"deny");u(this,"maxIncomingPendingConnections");u(this,"incomingPendingConnections");u(this,"outboundPendingConnections");u(this,"maxConnections");u(this,"dialQueue");u(this,"reconnectQueue");u(this,"connectionPruner");u(this,"inboundConnectionRateLimiter");u(this,"peerStore");u(this,"metrics");u(this,"events");u(this,"log");u(this,"peerId");u(this,TH,"@libp2p/connection-manager");var n;if(this.maxConnections=t.maxConnections??wA.maxConnections,this.maxConnections<1)throw new Z("Connection Manager maxConnections must be greater than 0");this.connections=new sc,this.started=!1,this.peerId=e.peerId,this.peerStore=e.peerStore,this.metrics=e.metrics,this.events=e.events,this.log=e.logger.forComponent("libp2p:connection-manager"),this.onConnect=this.onConnect.bind(this),this.onDisconnect=this.onDisconnect.bind(this),this.allow=(t.allow??[]).map(i=>mA(i)),this.deny=(t.deny??[]).map(i=>mA(i)),this.incomingPendingConnections=0,this.maxIncomingPendingConnections=t.maxIncomingPendingConnections??wA.maxIncomingPendingConnections,this.outboundPendingConnections=0,this.inboundConnectionRateLimiter=new cF({points:t.inboundConnectionThreshold??wA.inboundConnectionThreshold,duration:1}),this.connectionPruner=new ySe({connectionManager:this,peerStore:e.peerStore,events:e.events,logger:e.logger},{maxConnections:this.maxConnections,allow:(n=t.allow)==null?void 0:n.map(i=>Oe(i))}),this.dialQueue=new CSe(e,{addressSorter:t.addressSorter,maxParallelDials:t.maxParallelDials??BK,maxDialQueueLength:t.maxDialQueueLength??RK,maxPeerAddrsToDial:t.maxPeerAddrsToDial??OK,dialTimeout:t.dialTimeout??NK,resolvers:t.resolvers??{dnsaddr:aK},connections:this.connections}),this.reconnectQueue=new OSe({events:e.events,peerStore:e.peerStore,logger:e.logger,connectionManager:this},{retries:t.reconnectRetries,retryInterval:t.reconnectRetryInterval,backoffFactor:t.reconnectBackoffFactor,maxParallelReconnects:t.maxParallelReconnects})}async start(){var e,t,n;(e=this.metrics)==null||e.registerMetricGroup("libp2p_connection_manager_connections",{calculate:()=>{const i={inbound:0,"inbound pending":this.incomingPendingConnections,outbound:0,"outbound pending":this.outboundPendingConnections};for(const s of this.connections.values())for(const o of s)i[o.direction]++;return i}}),(t=this.metrics)==null||t.registerMetricGroup("libp2p_protocol_streams_total",{label:"protocol",calculate:()=>{const i={};for(const s of this.connections.values())for(const o of s)for(const a of o.streams){const c=`${a.direction} ${a.protocol??"unnegotiated"}`;i[c]=(i[c]??0)+1}return i}}),(n=this.metrics)==null||n.registerMetricGroup("libp2p_connection_manager_protocol_streams_per_connection_90th_percentile",{label:"protocol",calculate:()=>{const i={};for(const o of this.connections.values())for(const a of o){const c={};for(const l of a.streams){const d=`${l.direction} ${l.protocol??"unnegotiated"}`;c[d]=(c[d]??0)+1}for(const[l,d]of Object.entries(c))i[l]=i[l]??[],i[l].push(d)}const s={};for(let[o,a]of Object.entries(i)){a=a.sort((l,d)=>l-d);const c=Math.floor(a.length*.9);s[o]=a[c]}return s}}),this.events.addEventListener("connection:open",this.onConnect),this.events.addEventListener("connection:close",this.onDisconnect),await xo(this.dialQueue,this.reconnectQueue,this.connectionPruner),this.started=!0,this.log("started")}async stop(){this.events.removeEventListener("connection:open",this.onConnect),this.events.removeEventListener("connection:close",this.onDisconnect),await Ka(this.reconnectQueue,this.dialQueue,this.connectionPruner);const e=[];for(const t of this.connections.values())for(const n of t)e.push((async()=>{try{await n.close()}catch(i){this.log.error(i)}})());this.log("closing %d connections",e.length),await Promise.all(e),this.connections.clear(),this.log("stopped")}getMaxConnections(){return this.maxConnections}onConnect(e){this._onConnect(e).catch(t=>{this.log.error(t)})}async _onConnect(e){const{detail:t}=e;if(!this.started){await t.close();return}if(t.status!=="open")return;const n=t.remotePeer,i=!this.connections.has(n),s=this.connections.get(n)??[];s.push(t),this.connections.set(n,s),n.publicKey!=null&&n.type==="RSA"&&await this.peerStore.patch(n,{publicKey:n.publicKey}),i&&this.events.safeDispatchEvent("peer:connect",{detail:t.remotePeer})}onDisconnect(e){const{detail:t}=e,n=t.remotePeer,s=(this.connections.get(n)??[]).filter(o=>o.id!==t.id);this.connections.set(n,s),s.length===0&&(this.log("onDisconnect remove all connections for peer %p",n),this.connections.delete(n),this.events.safeDispatchEvent("peer:disconnect",{detail:t.remotePeer}))}getConnections(e){if(e!=null)return this.connections.get(e)??[];let t=[];for(const n of this.connections.values())t=t.concat(n);return t}getConnectionsMap(){return this.connections}async openConnection(e,t={}){var n,i;if(!this.started)throw new Il("Not started");this.outboundPendingConnections++;try{(n=t.signal)==null||n.throwIfAborted();const{peerId:s}=$K(e);if(this.peerId.equals(s))throw new Ab("Can not dial self");if(s!=null&&t.force!==!0){this.log("dial %p",s);const l=this.getConnections(s).find(d=>d.limits==null);if(l!=null)return this.log("had an existing non-limited connection to %p",s),(i=t.onProgress)==null||i.call(t,new ke("dial-queue:already-connected")),l}const o=await this.dialQueue.dial(e,{...t,priority:t.priority??KK});if(o.status!=="open")throw new Sb("Remote closed connection during opening");let a=this.connections.get(o.remotePeer);a==null&&(a=[],this.connections.set(o.remotePeer,a));let c=!1;for(const l of a)if(l.id===o.id&&(c=!0),t.force!==!0&&l.id!==o.id&&l.remoteAddr.equals(o.remoteAddr))return o.abort(new $2("Duplicate multiaddr connection")),l;return c||a.push(o),o}finally{this.outboundPendingConnections--}}async closeConnections(e,t={}){const n=this.connections.get(e)??[];await Promise.all(n.map(async i=>{try{await i.close(t)}catch(s){i.abort(s)}}))}async acceptIncomingConnection(e){if(this.deny.some(i=>i.contains(e.remoteAddr.nodeAddress().address)))return this.log("connection from %a refused - connection remote address was in deny list",e.remoteAddr),!1;if(this.allow.some(i=>i.contains(e.remoteAddr.nodeAddress().address)))return this.incomingPendingConnections++,!0;if(this.incomingPendingConnections===this.maxIncomingPendingConnections)return this.log("connection from %a refused - incomingPendingConnections exceeded by host",e.remoteAddr),!1;if(e.remoteAddr.isThinWaistAddress()){const i=e.remoteAddr.nodeAddress().address;try{await this.inboundConnectionRateLimiter.consume(i,1)}catch{return this.log("connection from %a refused - inboundConnectionThreshold exceeded by host %s",e.remoteAddr,i),!1}}return this.getConnections().length<this.maxConnections?(this.incomingPendingConnections++,!0):(this.log("connection from %a refused - maxConnections exceeded",e.remoteAddr),!1)}afterUpgradeInbound(){this.incomingPendingConnections--}getDialQueue(){const e={queued:"queued",running:"active",errored:"error",complete:"success"};return this.dialQueue.queue.queue.map(t=>({id:t.id,status:e[t.status],peerId:t.options.peerId,multiaddrs:[...t.options.multiaddrs].map(n=>Oe(n))}))}async isDialable(e,t={}){return this.dialQueue.isDialable(e,t)}}const LSe=1e4,BSe="1.0.0",USe="ping",FSe="ipfs",jK=32,zSe=!0;DH=Symbol.toStringTag,PH=ur;class VSe{constructor(e,t={}){u(this,"protocol");u(this,"components");u(this,"log");u(this,"heartbeatInterval");u(this,"pingIntervalMs");u(this,"abortController");u(this,"timeout");u(this,"abortConnectionOnPingFailure");u(this,DH,"@libp2p/connection-monitor");u(this,PH,["@libp2p/connection-monitor"]);this.components=e,this.protocol=`/${t.protocolPrefix??FSe}/${USe}/${BSe}`,this.log=e.logger.forComponent("libp2p:connection-monitor"),this.pingIntervalMs=t.pingInterval??LSe,this.abortConnectionOnPingFailure=t.abortConnectionOnPingFailure??zSe,this.timeout=new pp({...t.pingTimeout??{},metrics:e.metrics,metricName:"libp2p_connection_monitor_ping_time_milliseconds"})}start(){this.abortController=new AbortController,this.abortController.signal,this.heartbeatInterval=setInterval(()=>{this.components.connectionManager.getConnections().forEach(e=>{Promise.resolve().then(async()=>{var n;let t=Date.now();try{const i=this.timeout.getTimeoutSignal({signal:(n=this.abortController)==null?void 0:n.signal}),s=await e.newStream(this.protocol,{signal:i,runOnLimitedConnection:!0}),o=Ym(s);t=Date.now(),await Promise.all([o.write(Za(jK),{signal:i}),o.read({bytes:jK,signal:i})]),e.rtt=Date.now()-t,await o.unwrap().close({signal:i})}catch(i){if(i.name!=="UnsupportedProtocolError")throw i;e.rtt=(Date.now()-t)/2}}).catch(t=>{this.log.error("error during heartbeat",t),this.abortConnectionOnPingFailure?(this.log.error("aborting connection due to ping failure"),e.abort(t)):this.log("connection ping failed, but not aborting due to abortConnectionOnPingFailure flag")})})},this.pingIntervalMs)}stop(){var e;(e=this.abortController)==null||e.abort(),this.heartbeatInterval!=null&&clearInterval(this.heartbeatInterval)}}$H=Symbol.toStringTag;class KSe{constructor(e,t){u(this,"routers");u(this,"started");u(this,"components");u(this,$H,"@libp2p/content-routing");var n,i,s,o,a;this.routers=t.routers??[],this.started=!1,this.components=e,this.findProviders=((n=e.metrics)==null?void 0:n.traceFunction("libp2p.contentRouting.findProviders",this.findProviders.bind(this),{optionsIndex:1,getAttributesFromArgs:([c],l)=>({...l,cid:c.toString()}),getAttributesFromYieldedValue:(c,l)=>({...l,providers:[...Array.isArray(l.providers)?l.providers:[],c.id.toString()]})}))??this.findProviders,this.provide=((i=e.metrics)==null?void 0:i.traceFunction("libp2p.contentRouting.provide",this.provide.bind(this),{optionsIndex:1,getAttributesFromArgs:([c],l)=>({...l,cid:c.toString()})}))??this.provide,this.cancelReprovide=((s=e.metrics)==null?void 0:s.traceFunction("libp2p.contentRouting.cancelReprovide",this.cancelReprovide.bind(this),{optionsIndex:1,getAttributesFromArgs:([c],l)=>({...l,cid:c.toString()})}))??this.cancelReprovide,this.put=((o=e.metrics)==null?void 0:o.traceFunction("libp2p.contentRouting.put",this.put.bind(this),{optionsIndex:2,getAttributesFromArgs:([c])=>({key:re(c,"base36")})}))??this.put,this.get=((a=e.metrics)==null?void 0:a.traceFunction("libp2p.contentRouting.get",this.get.bind(this),{optionsIndex:1,getAttributesFromArgs:([c])=>({key:re(c,"base36")})}))??this.get}isStarted(){return this.started}async start(){this.started=!0}async stop(){this.started=!1}async*findProviders(e,t={}){if(this.routers.length===0)throw new yA("No content routers available");const n=this,i=new ts;for await(const s of Pa(...n.routers.map(o=>o.findProviders(e,t))))s!=null&&(s.multiaddrs.length>0&&await this.components.peerStore.merge(s.id,{multiaddrs:s.multiaddrs}),!i.has(s.id)&&(i.add(s.id),yield s))}async provide(e,t={}){if(this.routers.length===0)throw new yA("No content routers available");await Promise.all(this.routers.map(async n=>{await n.provide(e,t)}))}async cancelReprovide(e,t={}){if(this.routers.length===0)throw new yA("No content routers available");await Promise.all(this.routers.map(async n=>{await n.cancelReprovide(e,t)}))}async put(e,t,n){if(!this.isStarted())throw new Il;await Promise.all(this.routers.map(async i=>{await i.put(e,t,n)}))}async get(e,t){if(!this.isStarted())throw new Il;return Promise.any(this.routers.map(async n=>n.get(e,t)))}}NH=Symbol.toStringTag;class jSe{constructor(e,t={}){u(this,"log");u(this,"peerId");u(this,"peerStore");u(this,"routers");u(this,NH,"@libp2p/peer-routing");var n,i;this.log=e.logger.forComponent("libp2p:peer-routing"),this.peerId=e.peerId,this.peerStore=e.peerStore,this.routers=t.routers??[],this.findPeer=((n=e.metrics)==null?void 0:n.traceFunction("libp2p.peerRouting.findPeer",this.findPeer.bind(this),{optionsIndex:1,getAttributesFromArgs:([s],o)=>({...o,peer:s.toString()})}))??this.findPeer,this.getClosestPeers=((i=e.metrics)==null?void 0:i.traceFunction("libp2p.peerRouting.getClosestPeers",this.getClosestPeers.bind(this),{optionsIndex:1,getAttributesFromArgs:([s],o)=>({...o,key:re(s,"base36")}),getAttributesFromYieldedValue:(s,o)=>({...o,peers:[...Array.isArray(o.peers)?o.peers:[],s.id.toString()]})}))??this.getClosestPeers}async findPeer(e,t){if(this.routers.length===0)throw new PK("No peer routers available");if(e.toString()===this.peerId.toString())throw new FEe("Should not try to find self");const n=this,i=Pa(...this.routers.map(s=>async function*(){try{yield await s.findPeer(e,t)}catch(o){n.log.error(o)}}()));for await(const s of i)if(s!=null)return s.multiaddrs.length>0&&await this.peerStore.merge(s.id,{multiaddrs:s.multiaddrs}),s;throw new Zt}async*getClosestPeers(e,t={}){if(this.routers.length===0)throw new PK("No peer routers available");const n=this,i=Ll(1024);for await(const s of lp(async function*(){const o=Pa(...n.routers.map(a=>a.getClosestPeers(e,t)));for await(let a of o)yield async()=>{if(a.multiaddrs.length===0)try{a=await n.findPeer(a.id,{...t,useCache:!1})}catch(c){n.log.error("could not find peer multiaddrs",c);return}return a}}()))s!=null&&(s.multiaddrs.length>0&&await this.peerStore.merge(s.id,{multiaddrs:s.multiaddrs}),!i.has(s.id.toMultihash().bytes)&&(i.add(s.id.toMultihash().bytes),yield s))}}class HSe extends(OH=er,MH=Symbol.toStringTag,OH){constructor(t){super();u(this,"peerRouting");u(this,"log");u(this,"walking");u(this,"walkers");u(this,"shutdownController");u(this,"walkController");u(this,"needNext");u(this,MH,"@libp2p/random-walk");this.log=t.logger.forComponent("libp2p:random-walk"),this.peerRouting=t.peerRouting,this.walkers=0,this.walking=!1,this.shutdownController=new AbortController,this.shutdownController.signal}start(){this.shutdownController=new AbortController,this.shutdownController.signal}stop(){this.shutdownController.abort()}async*walk(t){var i,s;this.walking||this.startWalk(),this.walkers++;const n=ft([this.shutdownController.signal,t==null?void 0:t.signal]);try{for(;;)(i=this.needNext)==null||i.resolve(),this.needNext=Re(),yield(await _i(this,"walk:peer",n,{errorEvent:"walk:error"})).detail}finally{n.clear(),this.walkers--,this.walkers===0&&((s=this.walkController)==null||s.abort(),this.walkController=void 0)}}startWalk(){this.walking=!0,this.walkController=new AbortController,this.walkController.signal;const t=ft([this.walkController.signal,this.shutdownController.signal]),n=Date.now();let i=0;Promise.resolve().then(async()=>{for(this.log("start walk");this.walkers>0;)try{const s=Za(32);let o=Date.now();for await(const a of this.peerRouting.getClosestPeers(s,{signal:t}))t.aborted&&this.log("aborting walk"),t.throwIfAborted(),this.log("found peer %p after %dms for %d walkers",a.id,Date.now()-o,this.walkers),i++,this.safeDispatchEvent("walk:peer",{detail:a}),this.walkers===1&&this.needNext!=null&&(this.log("wait for need next"),await an(this.needNext.promise,t)),o=Date.now();this.log("walk iteration for %b and %d walkers finished, found %d peers",s,this.walkers,i)}catch(s){this.log.error("random walk errored",s),this.safeDispatchEvent("walk:error",{detail:s})}this.log("no walkers left, ended walk")}).catch(s=>{this.log.error("random walk errored",s)}).finally(()=>{this.log("finished walk, found %d peers after %dms",i,Date.now()-n),this.walking=!1})}}const HK=32,qK=64;RH=Symbol.toStringTag;class qSe{constructor(e){u(this,"log");u(this,"topologies");u(this,"handlers");u(this,"components");u(this,RH,"@libp2p/registrar");this.log=e.logger.forComponent("libp2p:registrar"),this.topologies=new Map,this.handlers=new Map,this.components=e,this._onDisconnect=this._onDisconnect.bind(this),this._onPeerUpdate=this._onPeerUpdate.bind(this),this._onPeerIdentify=this._onPeerIdentify.bind(this),this.components.events.addEventListener("peer:disconnect",this._onDisconnect),this.components.events.addEventListener("peer:update",this._onPeerUpdate),this.components.events.addEventListener("peer:identify",this._onPeerIdentify)}getProtocols(){return Array.from(new Set([...this.handlers.keys()])).sort()}getHandler(e){const t=this.handlers.get(e);if(t==null)throw new zEe(`No handler registered for protocol ${e}`);return t}getTopologies(e){const t=this.topologies.get(e);return t==null?[]:[...t.values()]}async handle(e,t,n){if(this.handlers.has(e)&&(n==null?void 0:n.force)!==!0)throw new VEe(`Handler already registered for protocol ${e}`);const i=gE.bind({ignoreUndefined:!0})({maxInboundStreams:HK,maxOutboundStreams:qK},n);this.handlers.set(e,{handler:t,options:i}),await this.components.peerStore.merge(this.components.peerId,{protocols:[e]})}async unhandle(e){(Array.isArray(e)?e:[e]).forEach(n=>{this.handlers.delete(n)}),await this.components.peerStore.patch(this.components.peerId,{protocols:this.getProtocols()})}async register(e,t){if(t==null)throw new Z("invalid topology");const n=`${(Math.random()*1e9).toString(36)}${Date.now()}`;let i=this.topologies.get(e);return i==null&&(i=new Map,this.topologies.set(e,i)),i.set(n,t),n}unregister(e){for(const[t,n]of this.topologies.entries())n.has(e)&&(n.delete(e),n.size===0&&this.topologies.delete(t))}_onDisconnect(e){const t=e.detail;this.components.peerStore.get(t).then(n=>{var i,s,o;for(const a of n.protocols){const c=this.topologies.get(a);if(c!=null)for(const l of c.values())((i=l.filter)==null?void 0:i.has(t))!==!1&&((s=l.filter)==null||s.remove(t),(o=l.onDisconnect)==null||o.call(l,t))}}).catch(n=>{n.name!=="NotFoundError"&&this.log.error("could not inform topologies of disconnecting peer %p",t,n)})}_onPeerUpdate(e){var s,o,a;const{peer:t,previous:n}=e.detail,i=((n==null?void 0:n.protocols)??[]).filter(c=>!t.protocols.includes(c));for(const c of i){const l=this.topologies.get(c);if(l!=null)for(const d of l.values())((s=d.filter)==null?void 0:s.has(t.id))!==!1&&((o=d.filter)==null||o.remove(t.id),(a=d.onDisconnect)==null||a.call(d,t.id))}}_onPeerIdentify(e){var s,o,a;const t=e.detail.protocols,n=e.detail.connection,i=e.detail.peerId;for(const c of t){const l=this.topologies.get(c);if(l!=null)for(const d of l.values())n.limits!=null&&d.notifyOnLimitedConnection!==!0||((s=d.filter)==null?void 0:s.has(i))!==!0&&((o=d.filter)==null||o.add(i),(a=d.onConnect)==null||a.call(d,i,n))}}}LH=Symbol.toStringTag;class WSe{constructor(e,t={}){u(this,"log");u(this,"components");u(this,"transports");u(this,"listeners");u(this,"faultTolerance");u(this,"started");u(this,LH,"@libp2p/transport-manager");this.log=e.logger.forComponent("libp2p:transports"),this.components=e,this.started=!1,this.transports=new Map,this.listeners=RM({name:"libp2p_transport_manager_listeners",metrics:this.components.metrics}),this.faultTolerance=t.faultTolerance??xl.FATAL_ALL}add(e){const t=e[Symbol.toStringTag];if(t==null)throw new Z("Transport must have a valid tag");if(this.transports.has(t))throw new Z(`There is already a transport with the tag ${t}`);this.log("adding transport %s",t),this.transports.set(t,e),this.listeners.has(t)||this.listeners.set(t,[])}isStarted(){return this.started}start(){this.started=!0}async afterStart(){const e=this.components.addressManager.getListenAddrs();await this.listen(e)}async stop(){const e=[];for(const[t,n]of this.listeners)for(this.log("closing listeners for %s",t);n.length>0;){const i=n.pop();i!=null&&e.push(i.close())}await Promise.all(e),this.log("all listeners closed");for(const t of this.listeners.keys())this.listeners.set(t,[]);this.started=!1}async dial(e,t){var i;const n=this.dialTransportForMultiaddr(e);if(n==null)throw new GEe(`No transport available for address ${String(e)}`);return(i=t==null?void 0:t.onProgress)==null||i.call(t,new ke("transport-manager:selected-transport",n[Symbol.toStringTag])),n.dial(e,{...t,upgrader:this.components.upgrader})}getAddrs(){let e=[];for(const t of this.listeners.values())for(const n of t)e=[...e,...n.getAddrs()];return e}getTransports(){return Array.of(...this.transports.values())}getListeners(){return Array.of(...this.listeners.values()).flat()}dialTransportForMultiaddr(e){for(const t of this.transports.values())if(t.dialFilter([e]).length>0)return t}listenTransportForMultiaddr(e){for(const t of this.transports.values())if(t.listenFilter([e]).length>0)return t}async listen(e){if(!this.isStarted())throw new Il("Not started");if(e==null||e.length===0){this.log("no addresses were provided for listening, this node is dial only");return}const t={errors:new Map,ipv4:{success:0,attempts:0},ipv6:{success:0,attempts:0}};e.forEach(s=>{t.errors.set(s.toString(),new KEe)});const n=[];for(const[s,o]of this.transports.entries()){const a=o.listenFilter(e);for(const c of a){this.log("creating listener for %s on %a",s,c);const l=o.createListener({upgrader:this.components.upgrader});let d=this.listeners.get(s)??[];d==null&&(d=[],this.listeners.set(s,d)),d.push(l),l.addEventListener("listening",()=>{this.components.events.safeDispatchEvent("transport:listening",{detail:l})}),l.addEventListener("close",()=>{const h=d.findIndex(p=>p===l);d.splice(h,1),this.components.events.safeDispatchEvent("transport:close",{detail:l})}),QM.matches(c)?t.ipv4.attempts++:YM.matches(c)&&t.ipv6.attempts++,n.push(l.listen(c).then(()=>{t.errors.delete(c.toString()),QM.matches(c)&&t.ipv4.success++,YM.matches(c)&&t.ipv6.success++},h=>{throw this.log.error("transport %s could not listen on address %a - %e",s,c,h),t.errors.set(c.toString(),h),h}))}}const i=await Promise.allSettled(n);if(!(i.length>0&&i.every(s=>s.status==="fulfilled"))){if(this.ipv6Unsupported(t)){this.log("all IPv4 addresses succeed but all IPv6 failed");return}if(this.faultTolerance===xl.NO_FATAL){this.log("failed to listen on any address but fault tolerance allows this");return}throw new jEe(`Some configured addresses failed to be listened on, you may need to remove one or more listen addresses from your configuration or set \`transportManager.faultTolerance\` to NO_FATAL:
${[...t.errors.entries()].map(([s,o])=>`
  ${s}: ${`${o.stack??o}`.split(`
`).join(`
  `)}
`).join("")}`)}}ipv6Unsupported(e){if(e.ipv4.attempts===0||e.ipv6.attempts===0)return!1;const t=e.ipv4.attempts===e.ipv4.success,n=e.ipv6.success===0;return t&&n}async remove(e){const t=this.listeners.get(e)??[];this.log.trace("removing transport %s",e);const n=[];for(this.log.trace("closing listeners for %s",e);t.length>0;){const i=t.pop();i!=null&&n.push(i.close())}await Promise.all(n),this.transports.delete(e),this.listeners.delete(e)}async removeAll(){const e=[];for(const t of this.transports.keys())e.push(this.remove(t));await Promise.all(e)}}const On="/multistream/1.0.0",bA=1024,GSe=ie(`
`);async function n0(r,e,t){await r.write(e,t)}async function QSe(r,e,t){await r.writeV(e,t)}async function YSe(r,e){const t=await r.read(e);if(t.byteLength===0||t.get(t.byteLength-1)!==GSe[0])throw e.log.error("Invalid mss message - missing newline",t),new St("Missing newline");return t.sublist(0,-1)}async function Oh(r,e){const t=await YSe(r,e);return re(t.subarray())}async function vA(r,e,t){if(e=Array.isArray(e)?[...e]:[e],e.length===1&&t.negotiateFully===!1)return JSe(r,e[0],t);const n=Yd(r,{...t,maxDataLength:bA}),i=e.shift();if(i==null)throw new Error("At least one protocol must be specified");t.log.trace('select: write ["%s", "%s"]',On,i);const s=ie(`${On}
`),o=ie(`${i}
`);await QSe(n,[s,o],t),t.log.trace("select: reading multistream-select header");let a=await Oh(n,t);if(t.log.trace('select: read "%s"',a),a===On&&(t.log.trace("select: reading protocol response"),a=await Oh(n,t),t.log.trace('select: read "%s"',a)),a===i)return{stream:n.unwrap(),protocol:i};for(const c of e){t.log.trace('select: write "%s"',c),await n0(n,ie(`${c}
`),t),t.log.trace("select: reading protocol response");const l=await Oh(n,t);if(t.log.trace('select: read "%s" for "%s"',l,c),l===c)return{stream:n.unwrap(),protocol:c}}throw new h1("protocol selection failed")}function JSe(r,e,t){const n=r.sink.bind(r),i=r.source;let s=!1,o=!1;const a=Re();let c=!1,l=!1;const d=Re();let h=!1,p=!1;const m=Re(),f=Yd({sink:n,source:i},{...t,maxDataLength:bA});r.sink=async b=>{const{sink:v}=f.unwrap();await v(async function*(){let E=!1;for await(const C of b){if(l&&await d.promise,c)yield C;else{l=!0,t.log.trace('optimistic: write ["%s", "%s", data(%d)] in sink',On,e,C.byteLength);const k=`${e}
`;yield new Le(Uint8Array.from([19]),ie(`${On}
`),Er(k.length),ie(k),C).subarray(),t.log.trace('optimistic: wrote ["%s", "%s", data(%d)] in sink',On,e,C.byteLength),c=!0,l=!1,d.resolve(),g().catch(x=>{t.log.error("could not finish optimistic protocol negotiation of %s",e,x)})}E=!0}E||await g()}())};async function g(){if(o){t.log.trace("optimistic: already negotiating %s stream",e),await a.promise;return}o=!0;try{c||(t.log.trace("optimistic: doing send protocol for %s stream",e),await w()),h||(t.log.trace("optimistic: doing read protocol for %s stream",e),await y())}finally{o=!1,s=!0,a.resolve()}}async function w(){if(l){await d.promise;return}l=!0;try{t.log.trace('optimistic: write ["%s", "%s", data] in source',On,e),await f.writeV([ie(`${On}
`),ie(`${e}
`)]),t.log.trace('optimistic: wrote ["%s", "%s", data] in source',On,e)}finally{c=!0,l=!1,d.resolve()}}async function y(){if(p){await m.promise;return}p=!0;try{t.log.trace("optimistic: reading multistream select header");let b=await Oh(f,t);if(t.log.trace('optimistic: read multistream select header "%s"',b),b===On&&(b=await Oh(f,t)),t.log.trace('optimistic: read protocol "%s", expecting "%s"',b,e),b!==e)throw new h1("protocol selection failed")}finally{h=!0,p=!1,m.resolve()}}if(r.source=async function*(){await g(),t.log.trace('optimistic: reading data from "%s" stream',e),yield*f.unwrap().source}(),r.closeRead!=null){const b=r.closeRead.bind(r);r.closeRead=async v=>{s||await g().catch(E=>{t.log.error("could not negotiate protocol before close read",E)}),await b(v)}}if(r.closeWrite!=null){const b=r.closeWrite.bind(r);r.closeWrite=async v=>{s||await g().catch(E=>{t.log.error("could not negotiate protocol before close write",E)}),await b(v)}}if(r.close!=null){const b=r.close.bind(r);r.close=async v=>{const E=[];l&&E.push(d.promise),p&&E.push(m.promise),E.length>0?await an(Promise.all(E),v==null?void 0:v.signal):(s=!0,o=!1,a.resolve()),await b(v)}}return{stream:r,protocol:e}}async function EA(r,e,t){e=Array.isArray(e)?e:[e],t.log.trace("handle: available protocols %s",e);const n=Yd(r,{...t,maxDataLength:bA,maxLengthLength:2});for(;;){t.log.trace("handle: reading incoming string");const i=await Oh(n,t);if(t.log.trace('handle: read "%s"',i),i===On){t.log.trace('handle: respond with "%s" for "%s"',On,i),await n0(n,ie(`${On}
`),t),t.log.trace('handle: responded with "%s" for "%s"',On,i);continue}if(e.includes(i))return t.log.trace('handle: respond with "%s" for "%s"',i,i),await n0(n,ie(`${i}
`),t),t.log.trace('handle: responded with "%s" for "%s"',i,i),{stream:n.unwrap(),protocol:i};if(i==="ls"){const s=new Le(...e.map(o=>Od.single(ie(`${o}
`))),ie(`
`));t.log.trace('handle: respond with "%s" for %s',e,i),await n0(n,s,t),t.log.trace('handle: responded with "%s" for %s',e,i);continue}t.log.trace('handle: respond with "na" for "%s"',i),await n0(n,ie(`na
`),t),t.log('handle: responded with "na" for "%s"',i)}}const XSe=500;UH=Symbol.toStringTag,BH=PZ;class ZSe{constructor(e){u(this,"id");u(this,"remoteAddr");u(this,"remotePeer");u(this,"direction");u(this,"timeline");u(this,"multiplexer");u(this,"encryption");u(this,"status");u(this,"limits");u(this,"log");u(this,"tags");u(this,"_newStream");u(this,"_close");u(this,"_abort");u(this,"_getStreams");u(this,UH,"Connection");u(this,BH,!0);const{remoteAddr:t,remotePeer:n,newStream:i,close:s,abort:o,getStreams:a}=e;this.id=`${parseInt(String(Math.random()*1e9)).toString(36)}${Date.now()}`,this.remoteAddr=t,this.remotePeer=n,this.direction=e.direction,this.status="open",this.timeline=e.timeline,this.multiplexer=e.multiplexer,this.encryption=e.encryption,this.limits=e.limits,this.log=e.logger.forComponent(`libp2p:connection:${this.direction}:${this.id}`),this.remoteAddr.getPeerId()==null&&(this.remoteAddr=this.remoteAddr.encapsulate(`/p2p/${this.remotePeer}`)),this._newStream=i,this._close=s,this._abort=o,this._getStreams=a,this.tags=[]}get streams(){return this._getStreams()}async newStream(e,t){if(this.status==="closing")throw new sP("the connection is being closed");if(this.status==="closed")throw new Sb("the connection is closed");if(Array.isArray(e)||(e=[e]),this.limits!=null&&(t==null?void 0:t.runOnLimitedConnection)!==!0)throw new Cb("Cannot open protocol stream on limited connection");const n=await this._newStream(e,t);return n.direction="outbound",n}async close(e={}){if(!(this.status==="closed"||this.status==="closing")){if(this.log("closing connection to %a",this.remoteAddr),this.status="closing",e.signal==null){const t=AbortSignal.timeout(XSe);e={...e,signal:t}}try{this.log.trace("closing underlying transport"),await this._close(e),this.log.trace("updating timeline with close time"),this.status="closed",this.timeline.close=Date.now()}catch(t){this.log.error("error encountered during graceful close of connection to %a",this.remoteAddr,t),this.abort(t)}}}abort(e){this.status!=="closed"&&(this.log.error("aborting connection to %a due to error",this.remoteAddr,e),this.status="closing",this._abort(e),this.status="closed",this.timeline.close=Date.now())}}function exe(r){return new ZSe(r)}function txe(r,e){try{const{options:t}=e.getHandler(r);return t.maxInboundStreams}catch(t){if(t.name!=="UnhandledProtocolError")throw t}return HK}function rxe(r,e,t={}){try{const{options:n}=e.getHandler(r);if(n.maxOutboundStreams!=null)return n.maxOutboundStreams}catch(n){if(n.name!=="UnhandledProtocolError")throw n}return t.maxOutboundStreams??qK}function WK(r,e,t){let n=0;return t.streams.forEach(i=>{i.direction===e&&i.protocol===r&&n++}),n}FH=Symbol.toStringTag;class nxe{constructor(e,t){u(this,"components");u(this,"connectionEncrypters");u(this,"streamMuxers");u(this,"inboundUpgradeTimeout");u(this,"inboundStreamProtocolNegotiationTimeout");u(this,"outboundStreamProtocolNegotiationTimeout");u(this,"events");u(this,"metrics");u(this,FH,"@libp2p/upgrader");var n,i;this.components=e,this.connectionEncrypters=new Map,t.connectionEncrypters.forEach(s=>{this.connectionEncrypters.set(s.protocol,s)}),this.streamMuxers=new Map,t.streamMuxers.forEach(s=>{this.streamMuxers.set(s.protocol,s)}),this.inboundUpgradeTimeout=t.inboundUpgradeTimeout??cSe,this.inboundStreamProtocolNegotiationTimeout=t.inboundStreamProtocolNegotiationTimeout??MK,this.outboundStreamProtocolNegotiationTimeout=t.outboundStreamProtocolNegotiationTimeout??MK,this.events=e.events,this.metrics={dials:(n=e.metrics)==null?void 0:n.registerCounterGroup("libp2p_connection_manager_dials_total"),errors:(i=e.metrics)==null?void 0:i.registerCounterGroup("libp2p_connection_manager_dial_errors_total")}}async shouldBlockConnection(e,...t){const n=this.components.connectionGater[e];if(n==null)return;if(await n.apply(this.components.connectionGater,t)===!0)throw new qEe(`The multiaddr connection is blocked by gater.${e}`)}createInboundAbortSignal(e){return ft([AbortSignal.timeout(this.inboundUpgradeTimeout),e])}async upgradeInbound(e,t){var s,o;let n=!1;const i=this.createInboundAbortSignal(t.signal);try{if((s=this.metrics.dials)==null||s.increment({inbound:!0}),n=await this.components.connectionManager.acceptIncomingConnection(e),!n)throw new WEe("Connection denied");await this.shouldBlockConnection("denyInboundConnection",e),await this._performUpgrade(e,"inbound",{...t,signal:i})}catch(a){throw(o=this.metrics.errors)==null||o.increment({inbound:!0}),a}finally{i.clear(),n&&this.components.connectionManager.afterUpgradeInbound()}}async upgradeOutbound(e,t){var n,i;try{(n=this.metrics.dials)==null||n.increment({outbound:!0});const s=e.remoteAddr.getPeerId();let o;s!=null&&(o=tr(s),await this.shouldBlockConnection("denyOutboundConnection",o,e));let a="outbound";return t.initiator===!1&&(a="inbound"),await this._performUpgrade(e,a,t)}catch(s){throw(i=this.metrics.errors)==null||i.increment({outbound:!0}),s}}async _performUpgrade(e,t,n){var d,h,p;let i,s,o,a,c;(d=this.components.metrics)==null||d.trackMultiaddrConnection(e),e.log.trace("starting the %s connection upgrade",t);let l=e;if((n==null?void 0:n.skipProtection)!==!0){const m=this.components.connectionProtector;m!=null&&(e.log("protecting the %s connection",t),l=await m.protect(e,n))}try{if(i=l,(n==null?void 0:n.skipEncryption)!==!0){(h=n==null?void 0:n.onProgress)==null||h.call(n,new ke(`upgrader:encrypt-${t}-connection`)),{conn:i,remotePeer:s,protocol:c,streamMuxer:a}=await(t==="inbound"?this._encryptInbound(l,n):this._encryptOutbound(l,n));const m={...l,...i};await this.shouldBlockConnection(t==="inbound"?"denyInboundEncryptedConnection":"denyOutboundEncryptedConnection",s,m)}else{const m=e.remoteAddr.getPeerId();if(m==null)throw new $2(`${t} connection that skipped encryption must have a peer id`);const f=tr(m);c="native",s=f}if(s.equals(this.components.peerId)){const m=new Ab("Can not dial self");throw e.abort(m),m}if(o=i,(n==null?void 0:n.muxerFactory)!=null)a=n.muxerFactory;else if(a==null&&this.streamMuxers.size>0){(p=n==null?void 0:n.onProgress)==null||p.call(n,new ke(`upgrader:multiplex-${t}-connection`));const m=await(t==="inbound"?this._multiplexInbound({...l,...i},this.streamMuxers,n):this._multiplexOutbound({...l,...i},this.streamMuxers,n));a=m.muxerFactory,o=m.stream}}catch(m){throw e.log.error("failed to upgrade inbound connection %s %a - %e",t==="inbound"?"from":"to",e.remoteAddr,m),m}return await this.shouldBlockConnection(t==="inbound"?"denyInboundUpgradedConnection":"denyOutboundUpgradedConnection",s,e),e.log("successfully upgraded %s connection",t),this._createConnection({cryptoProtocol:c,direction:t,maConn:e,upgradedConn:o,muxerFactory:a,remotePeer:s,limits:n==null?void 0:n.limits})}_createConnection(e){const{cryptoProtocol:t,direction:n,maConn:i,upgradedConn:s,remotePeer:o,muxerFactory:a,limits:c}=e;let l,d,h;a!=null&&(l=a.createStreamMuxer({direction:n,onIncomingStream:f=>{h!=null&&Promise.resolve().then(async()=>{var C;const g=this.components.registrar.getProtocols(),w=AbortSignal.timeout(this.inboundStreamProtocolNegotiationTimeout),{stream:y,protocol:b}=await EA(f,g,{signal:w,log:f.log,yieldBytes:!1});if(h==null)return;h.log("incoming stream opened on %s",b);const v=txe(b,this.components.registrar);if(WK(b,"inbound",h)===v){const k=new lP(`Too many inbound protocol streams for protocol "${b}" - limit ${v}`);throw f.abort(k),k}f.source=y.source,f.sink=y.sink,f.protocol=b,y.closeWrite!=null&&(f.closeWrite=y.closeWrite),y.closeRead!=null&&(f.closeRead=y.closeRead),y.close!=null&&(f.close=y.close),await this.components.peerStore.merge(o,{protocols:[b]}),(C=this.components.metrics)==null||C.trackProtocolStream(f,h),this._onStream({connection:h,stream:f,protocol:b})}).catch(async g=>{h.log.error("error handling incoming stream id %s - %e",f.id,g),f.timeline.close==null&&await f.close()})}}),d=async(f,g={})=>{var y;if(l==null)throw new I4("Connection is not multiplexed");h.log.trace("starting new stream for protocols %s",f);const w=await l.newStream();h.log.trace("started new stream %s for protocols %s",w.id,f);try{if(g.signal==null){w.log("no abort signal was passed while trying to negotiate protocols %s falling back to default timeout",f);const k=AbortSignal.timeout(this.outboundStreamProtocolNegotiationTimeout);g={...g,signal:k}}w.log.trace("selecting protocol from protocols %s",f);const{stream:b,protocol:v}=await vA(w,f,{...g,log:w.log,yieldBytes:!0});w.log.trace("selected protocol %s",v);const E=rxe(v,this.components.registrar,g),C=WK(v,"outbound",h);if(C>=E){const k=new O2(`Too many outbound protocol streams for protocol "${v}" - ${C}/${E}`);throw w.abort(k),k}return await this.components.peerStore.merge(o,{protocols:[v]}),w.source=b.source,w.sink=b.sink,w.protocol=v,b.closeWrite!=null&&(w.closeWrite=b.closeWrite),b.closeRead!=null&&(w.closeRead=b.closeRead),b.close!=null&&(w.close=b.close),(y=this.components.metrics)==null||y.trackProtocolStream(w,h),w}catch(b){throw h.log.error("could not create new outbound stream on connection %s %a for protocols %s - %e",n==="inbound"?"from":"to",e.maConn.remoteAddr,f,b),w.timeline.close==null&&w.abort(b),b}},Promise.all([l.sink(s.source),s.sink(l.source)]).catch(f=>{h.log.error("error piping data through muxer - %e",f)}));const p=i.timeline;i.timeline=new Proxy(p,{set:(...f)=>(f[1]==="close"&&f[2]!=null&&p.close==null&&(async()=>{try{h.status==="open"&&await h.close()}catch(g){h.log.error("error closing connection after timeline close %e",g)}finally{this.events.safeDispatchEvent("connection:close",{detail:h})}})().catch(g=>{h.log.error("error thrown while dispatching connection:close event %e",g)}),Reflect.set(...f))}),i.timeline.upgraded=Date.now();const m=()=>{throw new I4("Connection is not multiplexed")};return h=exe({remoteAddr:i.remoteAddr,remotePeer:o,status:"open",direction:n,timeline:i.timeline,multiplexer:l==null?void 0:l.protocol,encryption:t,limits:c,logger:this.components.logger,newStream:d??m,getStreams:()=>(l==null?void 0:l.streams)??[],close:async f=>{await(l==null?void 0:l.close(f)),await i.close(f)},abort:f=>{i.abort(f),l==null||l.abort(f)}}),this.events.safeDispatchEvent("connection:open",{detail:h}),h.__maConnTimeline=p,h}_onStream(e){const{connection:t,stream:n,protocol:i}=e,{handler:s,options:o}=this.components.registrar.getHandler(i);if(t.limits!=null&&o.runOnLimitedConnection!==!0)throw new Cb("Cannot open protocol stream on limited connection");s({connection:t,stream:n})}async _encryptInbound(e,t){const n=Array.from(this.connectionEncrypters.keys());try{const{stream:i,protocol:s}=await EA(e,n,{...t,log:e.log}),o=this.connectionEncrypters.get(s);if(o==null)throw new k4(`no crypto module found for ${s}`);return e.log("encrypting inbound connection to %a using %s",e.remoteAddr,s),{...await o.secureInbound(i,t),protocol:s}}catch(i){throw e.log.error("encrypting inbound connection from %a failed",e.remoteAddr,i),new k4(i.message)}}async _encryptOutbound(e,t){const n=Array.from(this.connectionEncrypters.keys());try{e.log.trace("selecting encrypter from %s",n);const{stream:i,protocol:s}=await vA(e,n,{...t,log:e.log,yieldBytes:!0}),o=this.connectionEncrypters.get(s);if(o==null)throw new k4(`no crypto module found for ${s}`);return e.log("encrypting outbound connection to %a using %s",e.remoteAddr,s),{...await o.secureOutbound(i,t),protocol:s}}catch(i){throw e.log.error("encrypting outbound connection to %a failed",e.remoteAddr,i),new k4(i.message)}}async _multiplexOutbound(e,t,n){const i=Array.from(t.keys());e.log("outbound selecting muxer %s",i);try{e.log.trace("selecting stream muxer from %s",i);const{stream:s,protocol:o}=await vA(e,i,{...n,log:e.log,yieldBytes:!0});e.log("selected %s as muxer protocol",o);const a=t.get(o);return{stream:s,muxerFactory:a}}catch(s){throw e.log.error("error multiplexing outbound connection",s),new I4(String(s))}}async _multiplexInbound(e,t,n){const i=Array.from(t.keys());e.log("inbound handling muxers %s",i);try{const{stream:s,protocol:o}=await EA(e,i,{...n,log:e.log}),a=t.get(o);return{stream:s,muxerFactory:a}}catch(s){throw e.log.error("error multiplexing inbound connection",s),new I4(String(s))}}getConnectionEncrypters(){return this.connectionEncrypters}getStreamMuxers(){return this.streamMuxers}}class ixe extends er{constructor(t){var d,h,p,m,f,g,w,y,b,v,E,C;super();Ye(this,h0);u(this,"peerId");u(this,"peerStore");u(this,"contentRouting");u(this,"peerRouting");u(this,"metrics");u(this,"services");u(this,"logger");u(this,"status");u(this,"components");u(this,"log");this.status="stopped";const n=new er,i=n.dispatchEvent.bind(n);n.dispatchEvent=k=>{const x=i(k),I=this.dispatchEvent(new CustomEvent(k.type,{detail:k.detail}));return x||I},this.peerId=t.peerId,this.logger=t.logger??Ry(),this.log=this.logger.forComponent("libp2p"),this.services={};const s=((d=t.nodeInfo)==null?void 0:d.name)??sK,o=((h=t.nodeInfo)==null?void 0:h.version)??iK,a=this.components=XEe({peerId:t.peerId,privateKey:t.privateKey,nodeInfo:{name:s,version:o,userAgent:((p=t.nodeInfo)==null?void 0:p.userAgent)??oK(s,o)},logger:this.logger,events:n,datastore:t.datastore??new VR,connectionGater:sSe(t.connectionGater),dns:t.dns});this.peerStore=this.configureComponent("peerStore",wEe(a,{addressFilter:this.components.connectionGater.filterMultiaddrForPeer,...t.peerStore})),t.metrics!=null&&(this.metrics=this.configureComponent("metrics",t.metrics(this.components))),a.events.addEventListener("peer:update",k=>{if(k.detail.previous==null){const x={id:k.detail.peer.id,multiaddrs:k.detail.peer.addresses.map(I=>I.multiaddr)};a.events.safeDispatchEvent("peer:discovery",{detail:x})}}),t.connectionProtector!=null&&this.configureComponent("connectionProtector",t.connectionProtector(a)),this.components.upgrader=new nxe(this.components,{connectionEncrypters:(t.connectionEncrypters??[]).map((k,x)=>this.configureComponent(`connection-encryption-${x}`,k(this.components))),streamMuxers:(t.streamMuxers??[]).map((k,x)=>this.configureComponent(`stream-muxers-${x}`,k(this.components))),inboundUpgradeTimeout:(m=t.connectionManager)==null?void 0:m.inboundUpgradeTimeout,inboundStreamProtocolNegotiationTimeout:((f=t.connectionManager)==null?void 0:f.inboundStreamProtocolNegotiationTimeout)??((g=t.connectionManager)==null?void 0:g.protocolNegotiationTimeout),outboundStreamProtocolNegotiationTimeout:((w=t.connectionManager)==null?void 0:w.outboundStreamProtocolNegotiationTimeout)??((y=t.connectionManager)==null?void 0:y.protocolNegotiationTimeout)}),this.configureComponent("transportManager",new WSe(this.components,t.transportManager)),this.configureComponent("connectionManager",new RSe(this.components,t.connectionManager)),((b=t.connectionMonitor)==null?void 0:b.enabled)!==!1&&this.configureComponent("connectionMonitor",new VSe(this.components,t.connectionMonitor)),this.configureComponent("registrar",new qSe(this.components)),this.configureComponent("addressManager",new LEe(this.components,t.addresses));const c=(t.peerRouters??[]).map((k,x)=>this.configureComponent(`peer-router-${x}`,k(this.components)));this.peerRouting=this.components.peerRouting=this.configureComponent("peerRouting",new jSe(this.components,{routers:c}));const l=(t.contentRouters??[]).map((k,x)=>this.configureComponent(`content-router-${x}`,k(this.components)));if(this.contentRouting=this.components.contentRouting=this.configureComponent("contentRouting",new KSe(this.components,{routers:l})),this.configureComponent("randomWalk",new HSe(this.components)),(t.peerDiscovery??[]).forEach((k,x)=>{this.configureComponent(`peer-discovery-${x}`,k(this.components)).addEventListener("peer",T=>{Ae(this,h0,UA).call(this,T)})}),(v=t.transports)==null||v.forEach((k,x)=>{this.components.transportManager.add(this.configureComponent(`transport-${x}`,k(this.components)))}),t.services!=null)for(const k of Object.keys(t.services)){const x=t.services[k],I=x(this.components);if(I==null){this.log.error("service factory %s returned null or undefined instance",k);continue}this.services[k]=I,this.configureComponent(k,I),I[bd]!=null&&(this.log("registering service %s for content routing",k),l.push(I[bd])),I[vd]!=null&&(this.log("registering service %s for peer routing",k),c.push(I[vd])),I[k2]!=null&&(this.log("registering service %s for peer discovery",k),(C=(E=I[k2]).addEventListener)==null||C.call(E,"peer",T=>{Ae(this,h0,UA).call(this,T)}))}ZEe(a)}configureComponent(t,n){return n==null&&this.log.error("component %s was null or undefined",t),this.components[t]=n,n}async start(){var t,n,i,s;if(this.status==="stopped"){this.status="starting",this.log("libp2p is starting");try{await((n=(t=this.components).beforeStart)==null?void 0:n.call(t)),await this.components.start(),await((s=(i=this.components).afterStart)==null?void 0:s.call(i)),this.status="started",this.safeDispatchEvent("start",{detail:this}),this.log("libp2p has started")}catch(o){throw this.log.error("An error occurred starting libp2p",o),this.status="started",await this.stop(),o}}}async stop(){var t,n,i,s;this.status==="started"&&(this.log("libp2p is stopping"),this.status="stopping",await((n=(t=this.components).beforeStop)==null?void 0:n.call(t)),await this.components.stop(),await((s=(i=this.components).afterStop)==null?void 0:s.call(i)),this.status="stopped",this.safeDispatchEvent("stop",{detail:this}),this.log("libp2p has stopped"))}getConnections(t){return this.components.connectionManager.getConnections(t)}getDialQueue(){return this.components.connectionManager.getDialQueue()}getPeers(){const t=new ts;for(const n of this.components.connectionManager.getConnections())t.add(n.remotePeer);return Array.from(t)}async dial(t,n={}){return this.components.connectionManager.openConnection(t,{priority:75,...n})}async dialProtocol(t,n,i={}){if(n==null)throw new Z("no protocols were provided to open a stream");if(n=Array.isArray(n)?n:[n],n.length===0)throw new Z("no protocols were provided to open a stream");return(await this.dial(t,i)).newStream(n,i)}getMultiaddrs(){return this.components.addressManager.getAddresses()}getProtocols(){return this.components.registrar.getProtocols()}async hangUp(t,n={}){Sm(t)&&(t=tr(t.getPeerId()??"")),await this.components.connectionManager.closeConnections(t,n)}async getPublicKey(t,n={}){if(this.log("getPublicKey %p",t),t.publicKey!=null)return t.publicKey;try{const a=await this.peerStore.get(t);if(a.id.publicKey!=null)return a.id.publicKey}catch(a){if(a.name!=="NotFoundError")throw a}const i=sr([ie("/pk/"),t.toMultihash().bytes]),s=await this.contentRouting.get(i,n),o=kn(s);return await this.peerStore.patch(t,{publicKey:o}),o}async handle(t,n,i){Array.isArray(t)||(t=[t]),await Promise.all(t.map(async s=>{await this.components.registrar.handle(s,n,i)}))}async unhandle(t){Array.isArray(t)||(t=[t]),await Promise.all(t.map(async n=>{await this.components.registrar.unhandle(n)}))}async register(t,n){return this.components.registrar.register(t,n)}unregister(t){this.components.registrar.unregister(t)}async isDialable(t,n={}){return this.components.connectionManager.isDialable(t,n)}}h0=new WeakSet,UA=function(t){const{detail:n}=t;if(n.id.toString()===this.peerId.toString()){this.log.error("peer discovery mechanism discovered self");return}this.components.peerStore.merge(n.id,{multiaddrs:n.multiaddrs}).catch(i=>{this.log.error(i)})};async function sxe(r={}){r.privateKey??(r.privateKey=await hy("Ed25519"));const e=new ixe({...await A9e(r),peerId:Xse(r.privateKey)});return r.start!==!1&&await e.start(),e}async function oxe(r){const e=r.libp2p??{};e.privateKey==null&&r.datastore!=null&&(e.privateKey=await b9e(r.datastore,r.keychain));const t=w9e(e);return t.datastore=t.datastore??r.datastore,await sxe({...t,...e,start:!1})}async function GK(r={}){const e=r.datastore??new VR,t=r.blockstore??new Yge;let n;axe(r.libp2p)?n=r.libp2p:n=await oxe({...r,libp2p:{dns:r.dns,...r.libp2p,start:void 0},datastore:e});const i=new t2e({...r,libp2p:n,datastore:e,blockstore:t,blockBrokers:r.blockBrokers??[T1e(),Vde()],routers:r.routers??[pge(n),hge()],metrics:n.metrics});return r.start!==!1&&await i.start(),i}function axe(r){return r==null?!1:["dial","dialProtocol","hangUp","handle","unhandle","getMultiaddrs","getProtocols"].every(t=>typeof r[t]=="function")}function QK(r){return r[Symbol.asyncIterator]!=null}const T4=r=>{const e=gt(r),t=Cn(e);return Er(r,t),T4.bytes=e,t};T4.bytes=0;function SA(r,e){e=e??{};const t=e.lengthEncoder??T4;function*n(i){const s=t(i.byteLength);s instanceof Uint8Array?yield s:yield*s,i instanceof Uint8Array?yield i:yield*i}return QK(r)?async function*(){for await(const i of r)yield*n(i)}():function*(){for(const i of r)yield*n(i)}()}SA.single=(r,e)=>{e=e??{};const t=e.lengthEncoder??T4;return new Le(t(r.byteLength),r)};class cxe extends Error{constructor(){super(...arguments);u(this,"name","InvalidMessageLengthError");u(this,"code","ERR_INVALID_MSG_LENGTH")}}class lxe extends Error{constructor(){super(...arguments);u(this,"name","InvalidDataLengthError");u(this,"code","ERR_MSG_DATA_TOO_LONG")}}class uxe extends Error{constructor(){super(...arguments);u(this,"name","InvalidDataLengthLengthError");u(this,"code","ERR_MSG_LENGTH_TOO_LONG")}}class YK extends Error{constructor(){super(...arguments);u(this,"name","UnexpectedEOFError");u(this,"code","ERR_UNEXPECTED_EOF")}}const dxe=8,hxe=1024*1024*4;var bu;(function(r){r[r.LENGTH=0]="LENGTH",r[r.DATA=1]="DATA"})(bu||(bu={}));const xA=r=>{const e=Zi(r);return xA.bytes=gt(e),e};xA.bytes=0;function AA(r,e){const t=new Le;let n=bu.LENGTH,i=-1;const s=(e==null?void 0:e.lengthDecoder)??xA,o=(e==null?void 0:e.maxLengthLength)??dxe,a=(e==null?void 0:e.maxDataLength)??hxe;function*c(){for(;t.byteLength>0;){if(n===bu.LENGTH)try{if(i=s(t),i<0)throw new cxe("Invalid message length");if(i>a)throw new lxe("Message length too long");const l=s.bytes;t.consume(l),(e==null?void 0:e.onLength)!=null&&e.onLength(i),n=bu.DATA}catch(l){if(l instanceof RangeError){if(t.byteLength>o)throw new uxe("Message length length too long");break}throw l}if(n===bu.DATA){if(t.byteLength<i)break;const l=t.sublist(0,i);t.consume(i),(e==null?void 0:e.onData)!=null&&e.onData(l),yield l,n=bu.LENGTH}}}return QK(r)?async function*(){for await(const l of r)t.append(l),yield*c();if(t.byteLength>0)throw new YK("Unexpected end of input")}():function*(){for(const l of r)t.append(l),yield*c();if(t.byteLength>0)throw new YK("Unexpected end of input")}()}AA.fromReader=(r,e)=>{let t=1;const n=async function*(){for(;;)try{const{done:s,value:o}=await r.next(t);if(s===!0)return;o!=null&&(yield o)}catch(s){if(s.code==="ERR_UNDER_READ")return{done:!0,value:null};throw s}finally{t=1}}();return AA(n,{...e??{},onLength:s=>{t=s}})};function fxe(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}var pxe=XK,JK=128,gxe=-128,yxe=Math.pow(2,31);function XK(r,e,t){e=e||[],t=t||0;for(var n=t;r>=yxe;)e[t++]=r&255|JK,r/=128;for(;r&gxe;)e[t++]=r&255|JK,r>>>=7;return e[t]=r|0,XK.bytes=t-n+1,e}var mxe=CA,wxe=128,ZK=127;function CA(r,n){var t=0,n=n||0,i=0,s=n,o,a=r.length;do{if(s>=a)throw CA.bytes=0,new RangeError("Could not decode varint");o=r[s++],t+=i<28?(o&ZK)<<i:(o&ZK)*Math.pow(2,i),i+=7}while(o>=wxe);return CA.bytes=s-n,t}var bxe=Math.pow(2,7),vxe=Math.pow(2,14),Exe=Math.pow(2,21),Sxe=Math.pow(2,28),xxe=Math.pow(2,35),Axe=Math.pow(2,42),Cxe=Math.pow(2,49),Ixe=Math.pow(2,56),kxe=Math.pow(2,63),_xe=function(r){return r<bxe?1:r<vxe?2:r<Exe?3:r<Sxe?4:r<xxe?5:r<Axe?6:r<Cxe?7:r<Ixe?8:r<kxe?9:10},Txe={encode:pxe,decode:mxe,encodingLength:_xe},P4=Txe;function ej(r,e=0){return[P4.decode(r,e),P4.decode.bytes]}function tj(r,e,t=0){return P4.encode(r,e,t),e}function rj(r){return P4.encodingLength(r)}function nj(r,e){const t=e.byteLength,n=rj(r),i=n+rj(t),s=new Uint8Array(i+t);return tj(r,s,0),tj(t,s,n),s.set(e,i),new sj(r,t,e,s)}function ij(r){const e=fxe(r),[t,n]=ej(e),[i,s]=ej(e.subarray(n)),o=e.subarray(n+s);if(o.byteLength!==i)throw new Error("Incorrect length");return new sj(t,i,o,e)}class sj{constructor(e,t,n,i){u(this,"code");u(this,"size");u(this,"digest");u(this,"bytes");this.code=e,this.size=t,this.digest=n,this.bytes=i}}const Rh=1e3,IA=60*Rh,oj="/floodsub/1.0.0",aj="/meshsub/1.0.0",Pxe="/meshsub/1.1.0",kA="/meshsub/1.2.0",Dxe=6,$xe=4,Nxe=12,Mxe=4,Oxe=2,Rxe=5,Lxe=3,Bxe=6,Uxe=.25,Fxe=3,cj=100,zxe=Rh,Vxe=IA,Kxe=16,jxe=IA,Hxe=10*Rh,qxe=15,Wxe=300,Gxe=Rh,Qxe=60,Yxe=2,Jxe=10*Rh,Lh=5e3,Xxe=10,Zxe=3*Rh,eAe=2*IA,tAe=120*1e3,rAe="ERR_TOPIC_VALIDATOR_REJECT",nAe="ERR_TOPIC_VALIDATOR_IGNORE",iAe=0,sAe=128,oAe=1e3,aAe=1e3,cAe=1,lAe=512,uAe=512,dAe={maxSubscriptions:1/0,maxMessages:1/0,maxIhaveMessageIDs:1/0,maxIwantMessageIDs:1/0,maxIdontwantMessageIDs:1/0,maxControlMessages:1/0,maxPeerInfos:1/0};var vu;(function(r){(function(t){let n;t.codec=()=>(n==null&&(n=De((i,s,o={})=>{o.lengthDelimited!==!1&&s.fork(),i.subscribe!=null&&(s.uint32(8),s.bool(i.subscribe)),i.topic!=null&&(s.uint32(18),s.string(i.topic)),o.lengthDelimited!==!1&&s.ldelim()},(i,s,o={})=>{const a={},c=s==null?i.len:i.pos+s;for(;i.pos<c;){const l=i.uint32();switch(l>>>3){case 1:{a.subscribe=i.bool();break}case 2:{a.topic=i.string();break}default:{i.skipType(l&7);break}}}return a})),n),t.encode=i=>Pe(i,t.codec()),t.decode=(i,s)=>Te(i,t.codec(),s)})(r.SubOpts||(r.SubOpts={})),function(t){let n;t.codec=()=>(n==null&&(n=De((i,s,o={})=>{o.lengthDelimited!==!1&&s.fork(),i.from!=null&&(s.uint32(10),s.bytes(i.from)),i.data!=null&&(s.uint32(18),s.bytes(i.data)),i.seqno!=null&&(s.uint32(26),s.bytes(i.seqno)),i.topic!=null&&i.topic!==""&&(s.uint32(34),s.string(i.topic)),i.signature!=null&&(s.uint32(42),s.bytes(i.signature)),i.key!=null&&(s.uint32(50),s.bytes(i.key)),o.lengthDelimited!==!1&&s.ldelim()},(i,s,o={})=>{const a={topic:""},c=s==null?i.len:i.pos+s;for(;i.pos<c;){const l=i.uint32();switch(l>>>3){case 1:{a.from=i.bytes();break}case 2:{a.data=i.bytes();break}case 3:{a.seqno=i.bytes();break}case 4:{a.topic=i.string();break}case 5:{a.signature=i.bytes();break}case 6:{a.key=i.bytes();break}default:{i.skipType(l&7);break}}}return a})),n),t.encode=i=>Pe(i,t.codec()),t.decode=(i,s)=>Te(i,t.codec(),s)}(r.Message||(r.Message={})),function(t){let n;t.codec=()=>(n==null&&(n=De((i,s,o={})=>{if(o.lengthDelimited!==!1&&s.fork(),i.ihave!=null)for(const a of i.ihave)s.uint32(10),r.ControlIHave.codec().encode(a,s);if(i.iwant!=null)for(const a of i.iwant)s.uint32(18),r.ControlIWant.codec().encode(a,s);if(i.graft!=null)for(const a of i.graft)s.uint32(26),r.ControlGraft.codec().encode(a,s);if(i.prune!=null)for(const a of i.prune)s.uint32(34),r.ControlPrune.codec().encode(a,s);if(i.idontwant!=null)for(const a of i.idontwant)s.uint32(42),r.ControlIDontWant.codec().encode(a,s);o.lengthDelimited!==!1&&s.ldelim()},(i,s,o={})=>{var l,d,h,p,m,f,g,w,y,b;const a={ihave:[],iwant:[],graft:[],prune:[],idontwant:[]},c=s==null?i.len:i.pos+s;for(;i.pos<c;){const v=i.uint32();switch(v>>>3){case 1:{if(((l=o.limits)==null?void 0:l.ihave)!=null&&a.ihave.length===o.limits.ihave)throw new yt('Decode error - map field "ihave" had too many elements');a.ihave.push(r.ControlIHave.codec().decode(i,i.uint32(),{limits:(d=o.limits)==null?void 0:d.ihave$}));break}case 2:{if(((h=o.limits)==null?void 0:h.iwant)!=null&&a.iwant.length===o.limits.iwant)throw new yt('Decode error - map field "iwant" had too many elements');a.iwant.push(r.ControlIWant.codec().decode(i,i.uint32(),{limits:(p=o.limits)==null?void 0:p.iwant$}));break}case 3:{if(((m=o.limits)==null?void 0:m.graft)!=null&&a.graft.length===o.limits.graft)throw new yt('Decode error - map field "graft" had too many elements');a.graft.push(r.ControlGraft.codec().decode(i,i.uint32(),{limits:(f=o.limits)==null?void 0:f.graft$}));break}case 4:{if(((g=o.limits)==null?void 0:g.prune)!=null&&a.prune.length===o.limits.prune)throw new yt('Decode error - map field "prune" had too many elements');a.prune.push(r.ControlPrune.codec().decode(i,i.uint32(),{limits:(w=o.limits)==null?void 0:w.prune$}));break}case 5:{if(((y=o.limits)==null?void 0:y.idontwant)!=null&&a.idontwant.length===o.limits.idontwant)throw new yt('Decode error - map field "idontwant" had too many elements');a.idontwant.push(r.ControlIDontWant.codec().decode(i,i.uint32(),{limits:(b=o.limits)==null?void 0:b.idontwant$}));break}default:{i.skipType(v&7);break}}}return a})),n),t.encode=i=>Pe(i,t.codec()),t.decode=(i,s)=>Te(i,t.codec(),s)}(r.ControlMessage||(r.ControlMessage={})),function(t){let n;t.codec=()=>(n==null&&(n=De((i,s,o={})=>{if(o.lengthDelimited!==!1&&s.fork(),i.topicID!=null&&(s.uint32(10),s.string(i.topicID)),i.messageIDs!=null)for(const a of i.messageIDs)s.uint32(18),s.bytes(a);o.lengthDelimited!==!1&&s.ldelim()},(i,s,o={})=>{var l;const a={messageIDs:[]},c=s==null?i.len:i.pos+s;for(;i.pos<c;){const d=i.uint32();switch(d>>>3){case 1:{a.topicID=i.string();break}case 2:{if(((l=o.limits)==null?void 0:l.messageIDs)!=null&&a.messageIDs.length===o.limits.messageIDs)throw new yt('Decode error - map field "messageIDs" had too many elements');a.messageIDs.push(i.bytes());break}default:{i.skipType(d&7);break}}}return a})),n),t.encode=i=>Pe(i,t.codec()),t.decode=(i,s)=>Te(i,t.codec(),s)}(r.ControlIHave||(r.ControlIHave={})),function(t){let n;t.codec=()=>(n==null&&(n=De((i,s,o={})=>{if(o.lengthDelimited!==!1&&s.fork(),i.messageIDs!=null)for(const a of i.messageIDs)s.uint32(10),s.bytes(a);o.lengthDelimited!==!1&&s.ldelim()},(i,s,o={})=>{var l;const a={messageIDs:[]},c=s==null?i.len:i.pos+s;for(;i.pos<c;){const d=i.uint32();switch(d>>>3){case 1:{if(((l=o.limits)==null?void 0:l.messageIDs)!=null&&a.messageIDs.length===o.limits.messageIDs)throw new yt('Decode error - map field "messageIDs" had too many elements');a.messageIDs.push(i.bytes());break}default:{i.skipType(d&7);break}}}return a})),n),t.encode=i=>Pe(i,t.codec()),t.decode=(i,s)=>Te(i,t.codec(),s)}(r.ControlIWant||(r.ControlIWant={})),function(t){let n;t.codec=()=>(n==null&&(n=De((i,s,o={})=>{o.lengthDelimited!==!1&&s.fork(),i.topicID!=null&&(s.uint32(10),s.string(i.topicID)),o.lengthDelimited!==!1&&s.ldelim()},(i,s,o={})=>{const a={},c=s==null?i.len:i.pos+s;for(;i.pos<c;){const l=i.uint32();switch(l>>>3){case 1:{a.topicID=i.string();break}default:{i.skipType(l&7);break}}}return a})),n),t.encode=i=>Pe(i,t.codec()),t.decode=(i,s)=>Te(i,t.codec(),s)}(r.ControlGraft||(r.ControlGraft={})),function(t){let n;t.codec=()=>(n==null&&(n=De((i,s,o={})=>{if(o.lengthDelimited!==!1&&s.fork(),i.topicID!=null&&(s.uint32(10),s.string(i.topicID)),i.peers!=null)for(const a of i.peers)s.uint32(18),r.PeerInfo.codec().encode(a,s);i.backoff!=null&&(s.uint32(24),s.uint64Number(i.backoff)),o.lengthDelimited!==!1&&s.ldelim()},(i,s,o={})=>{var l,d;const a={peers:[]},c=s==null?i.len:i.pos+s;for(;i.pos<c;){const h=i.uint32();switch(h>>>3){case 1:{a.topicID=i.string();break}case 2:{if(((l=o.limits)==null?void 0:l.peers)!=null&&a.peers.length===o.limits.peers)throw new yt('Decode error - map field "peers" had too many elements');a.peers.push(r.PeerInfo.codec().decode(i,i.uint32(),{limits:(d=o.limits)==null?void 0:d.peers$}));break}case 3:{a.backoff=i.uint64Number();break}default:{i.skipType(h&7);break}}}return a})),n),t.encode=i=>Pe(i,t.codec()),t.decode=(i,s)=>Te(i,t.codec(),s)}(r.ControlPrune||(r.ControlPrune={})),function(t){let n;t.codec=()=>(n==null&&(n=De((i,s,o={})=>{o.lengthDelimited!==!1&&s.fork(),i.peerID!=null&&(s.uint32(10),s.bytes(i.peerID)),i.signedPeerRecord!=null&&(s.uint32(18),s.bytes(i.signedPeerRecord)),o.lengthDelimited!==!1&&s.ldelim()},(i,s,o={})=>{const a={},c=s==null?i.len:i.pos+s;for(;i.pos<c;){const l=i.uint32();switch(l>>>3){case 1:{a.peerID=i.bytes();break}case 2:{a.signedPeerRecord=i.bytes();break}default:{i.skipType(l&7);break}}}return a})),n),t.encode=i=>Pe(i,t.codec()),t.decode=(i,s)=>Te(i,t.codec(),s)}(r.PeerInfo||(r.PeerInfo={})),function(t){let n;t.codec=()=>(n==null&&(n=De((i,s,o={})=>{if(o.lengthDelimited!==!1&&s.fork(),i.messageIDs!=null)for(const a of i.messageIDs)s.uint32(10),s.bytes(a);o.lengthDelimited!==!1&&s.ldelim()},(i,s,o={})=>{var l;const a={messageIDs:[]},c=s==null?i.len:i.pos+s;for(;i.pos<c;){const d=i.uint32();switch(d>>>3){case 1:{if(((l=o.limits)==null?void 0:l.messageIDs)!=null&&a.messageIDs.length===o.limits.messageIDs)throw new yt('Decode error - map field "messageIDs" had too many elements');a.messageIDs.push(i.bytes());break}default:{i.skipType(d&7);break}}}return a})),n),t.encode=i=>Pe(i,t.codec()),t.decode=(i,s)=>Te(i,t.codec(),s)}(r.ControlIDontWant||(r.ControlIDontWant={}));let e;r.codec=()=>(e==null&&(e=De((t,n,i={})=>{if(i.lengthDelimited!==!1&&n.fork(),t.subscriptions!=null)for(const s of t.subscriptions)n.uint32(10),r.SubOpts.codec().encode(s,n);if(t.messages!=null)for(const s of t.messages)n.uint32(18),r.Message.codec().encode(s,n);t.control!=null&&(n.uint32(26),r.ControlMessage.codec().encode(t.control,n)),i.lengthDelimited!==!1&&n.ldelim()},(t,n,i={})=>{var a,c,l,d,h;const s={subscriptions:[],messages:[]},o=n==null?t.len:t.pos+n;for(;t.pos<o;){const p=t.uint32();switch(p>>>3){case 1:{if(((a=i.limits)==null?void 0:a.subscriptions)!=null&&s.subscriptions.length===i.limits.subscriptions)throw new yt('Decode error - map field "subscriptions" had too many elements');s.subscriptions.push(r.SubOpts.codec().decode(t,t.uint32(),{limits:(c=i.limits)==null?void 0:c.subscriptions$}));break}case 2:{if(((l=i.limits)==null?void 0:l.messages)!=null&&s.messages.length===i.limits.messages)throw new yt('Decode error - map field "messages" had too many elements');s.messages.push(r.Message.codec().decode(t,t.uint32(),{limits:(d=i.limits)==null?void 0:d.messages$}));break}case 3:{s.control=r.ControlMessage.codec().decode(t,t.uint32(),{limits:(h=i.limits)==null?void 0:h.control});break}default:{t.skipType(p&7);break}}}return s})),e),r.encode=t=>Pe(t,r.codec()),r.decode=(t,n)=>Te(t,r.codec(),n)})(vu||(vu={}));class hAe{constructor(e,t,n){u(this,"gossip");u(this,"msgs",new Map);u(this,"msgIdToStrFn");u(this,"history",[]);u(this,"notValidatedCount",0);this.gossip=e,this.msgIdToStrFn=n;for(let i=0;i<t;i++)this.history[i]=[]}get size(){return this.msgs.size}put(e,t,n=!1){const{msgIdStr:i}=e;return this.msgs.has(i)?!1:(this.msgs.set(i,{message:t,validated:n,originatingPeers:new Set,iwantCounts:new Map}),this.history[0].push({...e,topic:t.topic}),n||this.notValidatedCount++,!0)}observeDuplicate(e,t){const n=this.msgs.get(e);n!=null&&!n.validated&&n.originatingPeers.add(t)}get(e){var t;return(t=this.msgs.get(this.msgIdToStrFn(e)))==null?void 0:t.message}getWithIWantCount(e,t){const n=this.msgs.get(e);if(n==null)return null;const i=(n.iwantCounts.get(t)??0)+1;return n.iwantCounts.set(t,i),{msg:n.message,count:i}}getGossipIDs(e){const t=new Map;for(let n=0;n<this.gossip;n++)this.history[n].forEach(i=>{const s=this.msgs.get(i.msgIdStr);if(((s==null?void 0:s.validated)??!1)&&e.has(i.topic)){let o=t.get(i.topic);o==null&&(o=[],t.set(i.topic,o)),o.push(i.msgId)}});return t}validate(e){const t=this.msgs.get(e);if(t==null)return null;t.validated||this.notValidatedCount--;const{message:n,originatingPeers:i}=t;return t.validated=!0,t.originatingPeers=new Set,{message:n,originatingPeers:i}}shift(){this.history[this.history.length-1].forEach(t=>{const n=this.msgs.get(t.msgIdStr);n!=null&&(this.msgs.delete(t.msgIdStr),n.validated||this.notValidatedCount--)}),this.history.pop(),this.history.unshift([])}remove(e){const t=this.msgs.get(e);return t==null?null:(this.msgs.delete(e),t)}}var lj;(function(r){r.StrictSign="StrictSign",r.StrictNoSign="StrictNoSign"})(lj||(lj={}));var Bh;(function(r){r[r.Signing=0]="Signing",r[r.Anonymous=1]="Anonymous"})(Bh||(Bh={}));var ms;(function(r){r.Error="error",r.Ignore="ignore",r.Reject="reject",r.Blacklisted="blacklisted"})(ms||(ms={}));var Rn;(function(r){r.InvalidSignature="invalid_signature",r.InvalidSeqno="invalid_seqno",r.InvalidPeerId="invalid_peerid",r.SignaturePresent="signature_present",r.SeqnoPresent="seqno_present",r.FromPresent="from_present",r.TransformFailed="transform_failed"})(Rn||(Rn={}));var Ln;(function(r){r.duplicate="duplicate",r.invalid="invalid",r.valid="valid"})(Ln||(Ln={}));function uj(r){switch(r){case Ci.Ignore:return ms.Ignore;case Ci.Reject:return ms.Reject;default:throw new Error("Unreachable")}}var dj;(function(r){r.forward="forward",r.publish="publish"})(dj||(dj={}));var Bn;(function(r){r.Fanout="fanout",r.Random="random",r.Subscribed="subscribed",r.Outbound="outbound",r.NotEnough="not_enough",r.Opportunistic="opportunistic"})(Bn||(Bn={}));var Qs;(function(r){r.Dc="disconnected",r.BadScore="bad_score",r.Prune="prune",r.Excess="excess"})(Qs||(Qs={}));var i0;(function(r){r.GraftBackoff="graft_backoff",r.BrokenPromise="broken_promise",r.MessageDeficit="message_deficit",r.IPColocation="IP_colocation"})(i0||(i0={}));var s0;(function(r){r.LowScore="low_score",r.MaxIhave="max_ihave",r.MaxIasked="max_iasked"})(s0||(s0={}));var Uh;(function(r){r.graylist="graylist",r.publish="publish",r.gossip="gossip",r.mesh="mesh"})(Uh||(Uh={}));function fAe(r,e,t){return{protocolsEnabled:r.gauge({name:"gossipsub_protocol",help:"Status of enabled protocols",labelNames:["protocol"]}),topicSubscriptionStatus:r.gauge({name:"gossipsub_topic_subscription_status",help:"Status of our subscription to this topic",labelNames:["topicStr"]}),topicPeersCount:r.gauge({name:"gossipsub_topic_peer_count",help:"Number of peers subscribed to each topic",labelNames:["topicStr"]}),meshPeerCounts:r.gauge({name:"gossipsub_mesh_peer_count",help:"Number of peers in our mesh",labelNames:["topicStr"]}),meshPeerInclusionEventsFanout:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_fanout_total",help:"Number of times we include peers in a topic mesh for fanout reasons",labelNames:["topic"]}),meshPeerInclusionEventsRandom:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_random_total",help:"Number of times we include peers in a topic mesh for random reasons",labelNames:["topic"]}),meshPeerInclusionEventsSubscribed:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_subscribed_total",help:"Number of times we include peers in a topic mesh for subscribed reasons",labelNames:["topic"]}),meshPeerInclusionEventsOutbound:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_outbound_total",help:"Number of times we include peers in a topic mesh for outbound reasons",labelNames:["topic"]}),meshPeerInclusionEventsNotEnough:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_not_enough_total",help:"Number of times we include peers in a topic mesh for not_enough reasons",labelNames:["topic"]}),meshPeerInclusionEventsOpportunistic:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_opportunistic_total",help:"Number of times we include peers in a topic mesh for opportunistic reasons",labelNames:["topic"]}),meshPeerInclusionEventsUnknown:r.gauge({name:"gossipsub_mesh_peer_inclusion_events_unknown_total",help:"Number of times we include peers in a topic mesh for unknown reasons",labelNames:["topic"]}),meshPeerChurnEventsDisconnected:r.gauge({name:"gossipsub_peer_churn_events_disconnected_total",help:"Number of times we remove peers in a topic mesh for disconnected reasons",labelNames:["topic"]}),meshPeerChurnEventsBadScore:r.gauge({name:"gossipsub_peer_churn_events_bad_score_total",help:"Number of times we remove peers in a topic mesh for bad_score reasons",labelNames:["topic"]}),meshPeerChurnEventsPrune:r.gauge({name:"gossipsub_peer_churn_events_prune_total",help:"Number of times we remove peers in a topic mesh for prune reasons",labelNames:["topic"]}),meshPeerChurnEventsExcess:r.gauge({name:"gossipsub_peer_churn_events_excess_total",help:"Number of times we remove peers in a topic mesh for excess reasons",labelNames:["topic"]}),meshPeerChurnEventsUnknown:r.gauge({name:"gossipsub_peer_churn_events_unknown_total",help:"Number of times we remove peers in a topic mesh for unknown reasons",labelNames:["topic"]}),peersPerProtocol:r.gauge({name:"gossipsub_peers_per_protocol_count",help:"Peers connected for each topic",labelNames:["protocol"]}),heartbeatDuration:r.histogram({name:"gossipsub_heartbeat_duration_seconds",help:"The time it takes to complete one iteration of the heartbeat",buckets:[.01,.1,1]}),heartbeatSkipped:r.gauge({name:"gossipsub_heartbeat_skipped",help:"Heartbeat run took longer than heartbeat interval so next is skipped"}),acceptedMessagesTotal:r.gauge({name:"gossipsub_accepted_messages_total",help:"Total accepted messages for each topic",labelNames:["topic"]}),ignoredMessagesTotal:r.gauge({name:"gossipsub_ignored_messages_total",help:"Total ignored messages for each topic",labelNames:["topic"]}),rejectedMessagesTotal:r.gauge({name:"gossipsub_rejected_messages_total",help:"Total rejected messages for each topic",labelNames:["topic"]}),unknownValidationResultsTotal:r.gauge({name:"gossipsub_unknown_validation_results_total",help:"Total unknown validation results for each topic",labelNames:["topic"]}),asyncValidationMcacheHit:r.gauge({name:"gossipsub_async_validation_mcache_hit_total",help:"Async validation result reported by the user layer",labelNames:["hit"]}),asyncValidationDelayFromFirstSeenSec:r.histogram({name:"gossipsub_async_validation_delay_from_first_seen",help:"Async validation report delay from first seen in second",buckets:[.01,.03,.1,.3,1,3,10]}),asyncValidationUnknownFirstSeen:r.gauge({name:"gossipsub_async_validation_unknown_first_seen_count_total",help:"Async validation report unknown first seen value for message"}),peerReadStreamError:r.gauge({name:"gossipsub_peer_read_stream_err_count_total",help:"Peer read stream error"}),rpcRecvBytes:r.gauge({name:"gossipsub_rpc_recv_bytes_total",help:"RPC recv"}),rpcRecvCount:r.gauge({name:"gossipsub_rpc_recv_count_total",help:"RPC recv"}),rpcRecvSubscription:r.gauge({name:"gossipsub_rpc_recv_subscription_total",help:"RPC recv"}),rpcRecvMessage:r.gauge({name:"gossipsub_rpc_recv_message_total",help:"RPC recv"}),rpcRecvControl:r.gauge({name:"gossipsub_rpc_recv_control_total",help:"RPC recv"}),rpcRecvIHave:r.gauge({name:"gossipsub_rpc_recv_ihave_total",help:"RPC recv"}),rpcRecvIWant:r.gauge({name:"gossipsub_rpc_recv_iwant_total",help:"RPC recv"}),rpcRecvGraft:r.gauge({name:"gossipsub_rpc_recv_graft_total",help:"RPC recv"}),rpcRecvPrune:r.gauge({name:"gossipsub_rpc_recv_prune_total",help:"RPC recv"}),rpcDataError:r.gauge({name:"gossipsub_rpc_data_err_count_total",help:"RPC data error"}),rpcRecvError:r.gauge({name:"gossipsub_rpc_recv_err_count_total",help:"RPC recv error"}),rpcRecvNotAccepted:r.gauge({name:"gossipsub_rpc_rcv_not_accepted_total",help:"Total count of RPC dropped because acceptFrom() == false"}),rpcSentBytes:r.gauge({name:"gossipsub_rpc_sent_bytes_total",help:"RPC sent"}),rpcSentCount:r.gauge({name:"gossipsub_rpc_sent_count_total",help:"RPC sent"}),rpcSentSubscription:r.gauge({name:"gossipsub_rpc_sent_subscription_total",help:"RPC sent"}),rpcSentMessage:r.gauge({name:"gossipsub_rpc_sent_message_total",help:"RPC sent"}),rpcSentControl:r.gauge({name:"gossipsub_rpc_sent_control_total",help:"RPC sent"}),rpcSentIHave:r.gauge({name:"gossipsub_rpc_sent_ihave_total",help:"RPC sent"}),rpcSentIWant:r.gauge({name:"gossipsub_rpc_sent_iwant_total",help:"RPC sent"}),rpcSentGraft:r.gauge({name:"gossipsub_rpc_sent_graft_total",help:"RPC sent"}),rpcSentPrune:r.gauge({name:"gossipsub_rpc_sent_prune_total",help:"RPC sent"}),rpcSentIDontWant:r.gauge({name:"gossipsub_rpc_sent_idontwant_total",help:"RPC sent"}),msgPublishCount:r.gauge({name:"gossipsub_msg_publish_count_total",help:"Total count of msg published by topic",labelNames:["topic"]}),msgPublishPeersByTopic:r.gauge({name:"gossipsub_msg_publish_peers_total",help:"Total count of peers that we publish a msg to",labelNames:["topic"]}),directPeersPublishedTotal:r.gauge({name:"gossipsub_direct_peers_published_total",help:"Total direct peers that we publish a msg to",labelNames:["topic"]}),floodsubPeersPublishedTotal:r.gauge({name:"gossipsub_floodsub_peers_published_total",help:"Total floodsub peers that we publish a msg to",labelNames:["topic"]}),meshPeersPublishedTotal:r.gauge({name:"gossipsub_mesh_peers_published_total",help:"Total mesh peers that we publish a msg to",labelNames:["topic"]}),fanoutPeersPublishedTotal:r.gauge({name:"gossipsub_fanout_peers_published_total",help:"Total fanout peers that we publish a msg to",labelNames:["topic"]}),msgPublishBytes:r.gauge({name:"gossipsub_msg_publish_bytes_total",help:"Total count of msg publish data.length bytes",labelNames:["topic"]}),msgPublishTime:r.histogram({name:"gossipsub_msg_publish_seconds",help:"Total time in seconds to publish a message",buckets:[.001,.002,.005,.01,.1,.5,1],labelNames:["topic"]}),msgForwardCount:r.gauge({name:"gossipsub_msg_forward_count_total",help:"Total count of msg forwarded by topic",labelNames:["topic"]}),msgForwardPeers:r.gauge({name:"gossipsub_msg_forward_peers_total",help:"Total count of peers that we forward a msg to",labelNames:["topic"]}),msgReceivedPreValidation:r.gauge({name:"gossipsub_msg_received_prevalidation_total",help:"Total count of recv msgs before any validation",labelNames:["topic"]}),msgReceivedError:r.gauge({name:"gossipsub_msg_received_error_total",help:"Total count of recv msgs error",labelNames:["topic"]}),prevalidationInvalidTotal:r.gauge({name:"gossipsub_pre_validation_invalid_total",help:"Total count of invalid messages received",labelNames:["topic"]}),prevalidationValidTotal:r.gauge({name:"gossipsub_pre_validation_valid_total",help:"Total count of valid messages received",labelNames:["topic"]}),prevalidationDuplicateTotal:r.gauge({name:"gossipsub_pre_validation_duplicate_total",help:"Total count of duplicate messages received",labelNames:["topic"]}),prevalidationUnknownTotal:r.gauge({name:"gossipsub_pre_validation_unknown_status_total",help:"Total count of unknown_status messages received",labelNames:["topic"]}),msgReceivedInvalid:r.gauge({name:"gossipsub_msg_received_invalid_total",help:"Tracks specific reason of invalid",labelNames:["error"]}),msgReceivedInvalidByTopic:r.gauge({name:"gossipsub_msg_received_invalid_by_topic_total",help:"Tracks specific invalid message by topic",labelNames:["topic"]}),duplicateMsgDeliveryDelay:r.histogram({name:"gossisub_duplicate_msg_delivery_delay_seconds",help:"Time since the 1st duplicated message validated",labelNames:["topic"],buckets:[.25*t.maxMeshMessageDeliveriesWindowSec,.5*t.maxMeshMessageDeliveriesWindowSec,Number(t.maxMeshMessageDeliveriesWindowSec),2*t.maxMeshMessageDeliveriesWindowSec,4*t.maxMeshMessageDeliveriesWindowSec]}),duplicateMsgLateDelivery:r.gauge({name:"gossisub_duplicate_msg_late_delivery_total",help:"Total count of late duplicate message delivery by topic, which triggers P3 penalty",labelNames:["topic"]}),duplicateMsgIgnored:r.gauge({name:"gossisub_ignored_published_duplicate_msgs_total",help:"Total count of published duplicate message ignored by topic",labelNames:["topic"]}),scoreFnCalls:r.gauge({name:"gossipsub_score_fn_calls_total",help:"Total times score() is called"}),scoreFnRuns:r.gauge({name:"gossipsub_score_fn_runs_total",help:"Total times score() call actually computed computeScore(), no cache"}),scoreCachedDelta:r.histogram({name:"gossipsub_score_cache_delta",help:"Delta of score between cached values that expired",buckets:[10,100,1e3]}),peersByScoreThreshold:r.gauge({name:"gossipsub_peers_by_score_threshold_count",help:"Current count of peers by score threshold",labelNames:["threshold"]}),score:r.avgMinMax({name:"gossipsub_score",help:"Avg min max of gossip scores"}),scoreWeights:r.avgMinMax({name:"gossipsub_score_weights",help:"Separate score weights",labelNames:["topic","p"]}),scorePerMesh:r.avgMinMax({name:"gossipsub_score_per_mesh",help:"Histogram of the scores for each mesh topic",labelNames:["topic"]}),scoringPenalties:r.gauge({name:"gossipsub_scoring_penalties_total",help:"A counter of the kind of penalties being applied to peers",labelNames:["penalty"]}),behaviourPenalty:r.histogram({name:"gossipsub_peer_stat_behaviour_penalty",help:"Current peer stat behaviour_penalty at each scrape",buckets:[.25*t.behaviourPenaltyThreshold,.5*t.behaviourPenaltyThreshold,Number(t.behaviourPenaltyThreshold),2*t.behaviourPenaltyThreshold,4*t.behaviourPenaltyThreshold]}),ihaveRcvIgnored:r.gauge({name:"gossipsub_ihave_rcv_ignored_total",help:"Total received IHAVE messages that we ignore for some reason",labelNames:["reason"]}),ihaveRcvMsgids:r.gauge({name:"gossipsub_ihave_rcv_msgids_total",help:"Total received IHAVE messages by topic",labelNames:["topic"]}),ihaveRcvNotSeenMsgids:r.gauge({name:"gossipsub_ihave_rcv_not_seen_msgids_total",help:"Total messages per topic we do not have, not actual requests",labelNames:["topic"]}),iwantRcvMsgids:r.gauge({name:"gossipsub_iwant_rcv_msgids_total",help:"Total received IWANT messages by topic",labelNames:["topic"]}),iwantRcvDonthaveMsgids:r.gauge({name:"gossipsub_iwant_rcv_dont_have_msgids_total",help:"Total requested messageIDs that we do not have"}),idontwantRcvMsgids:r.gauge({name:"gossipsub_idontwant_rcv_msgids_total",help:"Total received IDONTWANT messages"}),idontwantRcvDonthaveMsgids:r.gauge({name:"gossipsub_idontwant_rcv_dont_have_msgids_total",help:"Total received IDONTWANT messageIDs that we do not have in mcache"}),iwantPromiseStarted:r.gauge({name:"gossipsub_iwant_promise_sent_total",help:"Total count of started IWANT promises"}),iwantPromiseResolved:r.gauge({name:"gossipsub_iwant_promise_resolved_total",help:"Total count of resolved IWANT promises"}),iwantPromiseResolvedFromDuplicate:r.gauge({name:"gossipsub_iwant_promise_resolved_from_duplicate_total",help:"Total count of resolved IWANT promises from duplicate messages"}),iwantPromiseResolvedPeers:r.gauge({name:"gossipsub_iwant_promise_resolved_peers",help:"Total count of peers we have asked IWANT promises that are resolved"}),iwantPromiseBroken:r.gauge({name:"gossipsub_iwant_promise_broken",help:"Total count of broken IWANT promises"}),iwantMessagePruned:r.gauge({name:"gossipsub_iwant_message_pruned",help:"Total count of pruned IWANT messages"}),iwantPromiseDeliveryTime:r.histogram({name:"gossipsub_iwant_promise_delivery_seconds",help:"Histogram of delivery time of resolved IWANT promises",buckets:[.5*t.gossipPromiseExpireSec,Number(t.gossipPromiseExpireSec),2*t.gossipPromiseExpireSec,4*t.gossipPromiseExpireSec]}),iwantPromiseUntracked:r.gauge({name:"gossip_iwant_promise_untracked",help:"Total count of untracked IWANT promise"}),connectedPeersBackoffSec:r.histogram({name:"gossipsub_connected_peers_backoff_seconds",help:"Backoff time in seconds",buckets:[1,2,4,10,20,60,120]}),cacheSize:r.gauge({name:"gossipsub_cache_size",help:"Unbounded cache sizes",labelNames:["cache"]}),mcacheSize:r.gauge({name:"gossipsub_mcache_size",help:"Current mcache msg count"}),mcacheNotValidatedCount:r.gauge({name:"gossipsub_mcache_not_validated_count",help:"Current mcache msg count not validated"}),fastMsgIdCacheCollision:r.gauge({name:"gossipsub_fastmsgid_cache_collision_total",help:"Total count of key collisions on fastmsgid cache put"}),newConnectionCount:r.gauge({name:"gossipsub_new_connection_total",help:"Total new connection by status",labelNames:["status"]}),topicStrToLabel:e,toTopic(n){return this.topicStrToLabel.get(n)??n},onJoin(n){this.topicSubscriptionStatus.set({topicStr:n},1),this.meshPeerCounts.set({topicStr:n},0)},onLeave(n){this.topicSubscriptionStatus.set({topicStr:n},0),this.meshPeerCounts.set({topicStr:n},0)},onAddToMesh(n,i,s){const o=this.toTopic(n);switch(i){case Bn.Fanout:this.meshPeerInclusionEventsFanout.inc({topic:o},s);break;case Bn.Random:this.meshPeerInclusionEventsRandom.inc({topic:o},s);break;case Bn.Subscribed:this.meshPeerInclusionEventsSubscribed.inc({topic:o},s);break;case Bn.Outbound:this.meshPeerInclusionEventsOutbound.inc({topic:o},s);break;case Bn.NotEnough:this.meshPeerInclusionEventsNotEnough.inc({topic:o},s);break;case Bn.Opportunistic:this.meshPeerInclusionEventsOpportunistic.inc({topic:o},s);break;default:this.meshPeerInclusionEventsUnknown.inc({topic:o},s);break}},onRemoveFromMesh(n,i,s){const o=this.toTopic(n);switch(i){case Qs.Dc:this.meshPeerChurnEventsDisconnected.inc({topic:o},s);break;case Qs.BadScore:this.meshPeerChurnEventsBadScore.inc({topic:o},s);break;case Qs.Prune:this.meshPeerChurnEventsPrune.inc({topic:o},s);break;case Qs.Excess:this.meshPeerChurnEventsExcess.inc({topic:o},s);break;default:this.meshPeerChurnEventsUnknown.inc({topic:o},s);break}},onReportValidation(n,i,s){if(this.asyncValidationMcacheHit.inc({hit:n!=null?"hit":"miss"}),n!=null){const o=this.toTopic(n.message.topic);switch(i){case Ci.Accept:this.acceptedMessagesTotal.inc({topic:o});break;case Ci.Ignore:this.ignoredMessagesTotal.inc({topic:o});break;case Ci.Reject:this.rejectedMessagesTotal.inc({topic:o});break;default:this.unknownValidationResultsTotal.inc({topic:o});break}}s!=null?this.asyncValidationDelayFromFirstSeenSec.observe((Date.now()-s)/1e3):this.asyncValidationUnknownFirstSeen.inc()},onScorePenalty(n){this.scoringPenalties.inc({penalty:n},1)},onIhaveRcv(n,i,s){const o=this.toTopic(n);this.ihaveRcvMsgids.inc({topic:o},i),this.ihaveRcvNotSeenMsgids.inc({topic:o},s)},onIwantRcv(n,i){for(const[s,o]of n){const a=this.toTopic(s);this.iwantRcvMsgids.inc({topic:a},o)}this.iwantRcvDonthaveMsgids.inc(i)},onIdontwantRcv(n,i){this.idontwantRcvMsgids.inc(n),this.idontwantRcvDonthaveMsgids.inc(i)},onForwardMsg(n,i){const s=this.toTopic(n);this.msgForwardCount.inc({topic:s},1),this.msgForwardPeers.inc({topic:s},i)},onPublishMsg(n,i,s,o,a){const c=this.toTopic(n);this.msgPublishCount.inc({topic:c},1),this.msgPublishBytes.inc({topic:c},s*o),this.msgPublishPeersByTopic.inc({topic:c},s),this.directPeersPublishedTotal.inc({topic:c},i.direct),this.floodsubPeersPublishedTotal.inc({topic:c},i.floodsub),this.meshPeersPublishedTotal.inc({topic:c},i.mesh),this.fanoutPeersPublishedTotal.inc({topic:c},i.fanout),this.msgPublishTime.observe({topic:c},a/1e3)},onMsgRecvPreValidation(n){const i=this.toTopic(n);this.msgReceivedPreValidation.inc({topic:i},1)},onMsgRecvError(n){const i=this.toTopic(n);this.msgReceivedError.inc({topic:i},1)},onPrevalidationResult(n,i){const s=this.toTopic(n);switch(i){case Ln.duplicate:this.prevalidationDuplicateTotal.inc({topic:s});break;case Ln.invalid:this.prevalidationInvalidTotal.inc({topic:s});break;case Ln.valid:this.prevalidationValidTotal.inc({topic:s});break;default:this.prevalidationUnknownTotal.inc({topic:s});break}},onMsgRecvInvalid(n,i){const s=this.toTopic(n),o=i.reason===ms.Error?i.error:i.reason;this.msgReceivedInvalid.inc({error:o},1),this.msgReceivedInvalidByTopic.inc({topic:s},1)},onDuplicateMsgDelivery(n,i,s){const o=this.toTopic(n);this.duplicateMsgDeliveryDelay.observe({topic:o},i/1e3),s&&this.duplicateMsgLateDelivery.inc({topic:o},1)},onPublishDuplicateMsg(n){const i=this.toTopic(n);this.duplicateMsgIgnored.inc({topic:i},1)},onPeerReadStreamError(){this.peerReadStreamError.inc(1)},onRpcRecvError(){this.rpcRecvError.inc(1)},onRpcDataError(){this.rpcDataError.inc(1)},onRpcRecv(n,i){this.rpcRecvBytes.inc(i),this.rpcRecvCount.inc(1),n.subscriptions!=null&&this.rpcRecvSubscription.inc(n.subscriptions.length),n.messages!=null&&this.rpcRecvMessage.inc(n.messages.length),n.control!=null&&(this.rpcRecvControl.inc(1),n.control.ihave!=null&&this.rpcRecvIHave.inc(n.control.ihave.length),n.control.iwant!=null&&this.rpcRecvIWant.inc(n.control.iwant.length),n.control.graft!=null&&this.rpcRecvGraft.inc(n.control.graft.length),n.control.prune!=null&&this.rpcRecvPrune.inc(n.control.prune.length))},onRpcSent(n,i){var s,o,a,c,l;if(this.rpcSentBytes.inc(i),this.rpcSentCount.inc(1),n.subscriptions!=null&&this.rpcSentSubscription.inc(n.subscriptions.length),n.messages!=null&&this.rpcSentMessage.inc(n.messages.length),n.control!=null){const d=((s=n.control.ihave)==null?void 0:s.length)??0,h=((o=n.control.iwant)==null?void 0:o.length)??0,p=((a=n.control.graft)==null?void 0:a.length)??0,m=((c=n.control.prune)==null?void 0:c.length)??0,f=((l=n.control.idontwant)==null?void 0:l.length)??0;d>0&&this.rpcSentIHave.inc(d),h>0&&this.rpcSentIWant.inc(h),p>0&&this.rpcSentGraft.inc(p),m>0&&this.rpcSentPrune.inc(m),f>0&&this.rpcSentIDontWant.inc(f),(d>0||h>0||p>0||m>0||f>0)&&this.rpcSentControl.inc(1)}},registerScores(n,i){let s=0,o=0,a=0,c=0;for(const l of n)l>=i.graylistThreshold&&s++,l>=i.publishThreshold&&o++,l>=i.gossipThreshold&&a++,l>=0&&c++;this.peersByScoreThreshold.set({threshold:Uh.graylist},s),this.peersByScoreThreshold.set({threshold:Uh.publish},o),this.peersByScoreThreshold.set({threshold:Uh.gossip},a),this.peersByScoreThreshold.set({threshold:Uh.mesh},c),this.score.set(n)},registerScoreWeights(n){for(const[i,s]of n.byTopic)this.scoreWeights.set({topic:i,p:"p1"},s.p1w),this.scoreWeights.set({topic:i,p:"p2"},s.p2w),this.scoreWeights.set({topic:i,p:"p3"},s.p3w),this.scoreWeights.set({topic:i,p:"p3b"},s.p3bw),this.scoreWeights.set({topic:i,p:"p4"},s.p4w);this.scoreWeights.set({p:"p5"},n.p5w),this.scoreWeights.set({p:"p6"},n.p6w),this.scoreWeights.set({p:"p7"},n.p7w)},registerScorePerMesh(n,i){const s=new Map;n.forEach((o,a)=>{const c=this.topicStrToLabel.get(a)??"unknown";let l=s.get(c);l==null&&(l=new Set,s.set(c,l)),o.forEach(d=>l==null?void 0:l.add(d))});for(const[o,a]of s){const c=[];a.forEach(l=>{c.push(i.get(l)??0)}),this.scorePerMesh.set({topic:o},c)}}}}class wt extends Error{constructor(e="Invalid peer score params"){super(e),this.name="InvalidPeerScoreParamsError"}}u(wt,"name","InvalidPeerScoreParamsError");const pAe={topics:{},topicScoreCap:10,appSpecificScore:()=>0,appSpecificWeight:10,IPColocationFactorWeight:-5,IPColocationFactorThreshold:10,IPColocationFactorWhitelist:new Set,behaviourPenaltyWeight:-10,behaviourPenaltyThreshold:0,behaviourPenaltyDecay:.2,decayInterval:1e3,decayToZero:.1,retainScore:3600*1e3},gAe={topicWeight:.5,timeInMeshWeight:1,timeInMeshQuantum:1,timeInMeshCap:3600,firstMessageDeliveriesWeight:1,firstMessageDeliveriesDecay:.5,firstMessageDeliveriesCap:2e3,meshMessageDeliveriesWeight:-1,meshMessageDeliveriesDecay:.5,meshMessageDeliveriesCap:100,meshMessageDeliveriesThreshold:20,meshMessageDeliveriesWindow:10,meshMessageDeliveriesActivation:5e3,meshFailurePenaltyWeight:-1,meshFailurePenaltyDecay:.5,invalidMessageDeliveriesWeight:-1,invalidMessageDeliveriesDecay:.3};function yAe(r={}){return{...pAe,...r,topics:r.topics!=null?Object.entries(r.topics).reduce((e,[t,n])=>(e[t]=mAe(n),e),{}):{}}}function mAe(r={}){return{...gAe,...r}}function wAe(r){for(const[e,t]of Object.entries(r.topics))try{bAe(t)}catch(n){throw new wt(`invalid score parameters for topic ${e}: ${n.message}`)}if(r.topicScoreCap<0)throw new wt("invalid topic score cap; must be positive (or 0 for no cap)");if(r.appSpecificScore===null||r.appSpecificScore===void 0)throw new wt("missing application specific score function");if(r.IPColocationFactorWeight>0)throw new wt("invalid IPColocationFactorWeight; must be negative (or 0 to disable)");if(r.IPColocationFactorWeight!==0&&r.IPColocationFactorThreshold<1)throw new wt("invalid IPColocationFactorThreshold; must be at least 1");if(r.behaviourPenaltyWeight>0)throw new wt("invalid BehaviourPenaltyWeight; must be negative (or 0 to disable)");if(r.behaviourPenaltyWeight!==0&&(r.behaviourPenaltyDecay<=0||r.behaviourPenaltyDecay>=1))throw new wt("invalid BehaviourPenaltyDecay; must be between 0 and 1");if(r.decayInterval<1e3)throw new wt("invalid DecayInterval; must be at least 1s");if(r.decayToZero<=0||r.decayToZero>=1)throw new wt("invalid DecayToZero; must be between 0 and 1")}function bAe(r){if(r.topicWeight<0)throw new wt("invalid topic weight; must be >= 0");if(r.timeInMeshQuantum===0)throw new wt("invalid TimeInMeshQuantum; must be non zero");if(r.timeInMeshWeight<0)throw new wt("invalid TimeInMeshWeight; must be positive (or 0 to disable)");if(r.timeInMeshWeight!==0&&r.timeInMeshQuantum<=0)throw new wt("invalid TimeInMeshQuantum; must be positive");if(r.timeInMeshWeight!==0&&r.timeInMeshCap<=0)throw new wt("invalid TimeInMeshCap; must be positive");if(r.firstMessageDeliveriesWeight<0)throw new wt("invallid FirstMessageDeliveriesWeight; must be positive (or 0 to disable)");if(r.firstMessageDeliveriesWeight!==0&&(r.firstMessageDeliveriesDecay<=0||r.firstMessageDeliveriesDecay>=1))throw new wt("invalid FirstMessageDeliveriesDecay; must be between 0 and 1");if(r.firstMessageDeliveriesWeight!==0&&r.firstMessageDeliveriesCap<=0)throw new wt("invalid FirstMessageDeliveriesCap; must be positive");if(r.meshMessageDeliveriesWeight>0)throw new wt("invalid MeshMessageDeliveriesWeight; must be negative (or 0 to disable)");if(r.meshMessageDeliveriesWeight!==0&&(r.meshMessageDeliveriesDecay<=0||r.meshMessageDeliveriesDecay>=1))throw new wt("invalid MeshMessageDeliveriesDecay; must be between 0 and 1");if(r.meshMessageDeliveriesWeight!==0&&r.meshMessageDeliveriesCap<=0)throw new wt("invalid MeshMessageDeliveriesCap; must be positive");if(r.meshMessageDeliveriesWeight!==0&&r.meshMessageDeliveriesThreshold<=0)throw new wt("invalid MeshMessageDeliveriesThreshold; must be positive");if(r.meshMessageDeliveriesWindow<0)throw new wt("invalid MeshMessageDeliveriesWindow; must be non-negative");if(r.meshMessageDeliveriesWeight!==0&&r.meshMessageDeliveriesActivation<1e3)throw new wt("invalid MeshMessageDeliveriesActivation; must be at least 1s");if(r.meshFailurePenaltyWeight>0)throw new wt("invalid MeshFailurePenaltyWeight; must be negative (or 0 to disable)");if(r.meshFailurePenaltyWeight!==0&&(r.meshFailurePenaltyDecay<=0||r.meshFailurePenaltyDecay>=1))throw new wt("invalid MeshFailurePenaltyDecay; must be between 0 and 1");if(r.invalidMessageDeliveriesWeight>0)throw new wt("invalid InvalidMessageDeliveriesWeight; must be negative (or 0 to disable)");if(r.invalidMessageDeliveriesDecay<=0||r.invalidMessageDeliveriesDecay>=1)throw new wt("invalid InvalidMessageDeliveriesDecay; must be between 0 and 1")}const vAe={gossipThreshold:-10,publishThreshold:-50,graylistThreshold:-80,acceptPXThreshold:10,opportunisticGraftThreshold:20};function EAe(r={}){return{...vAe,...r}}function _A(r,e,t=()=>!0){const n=new Set;if(e<=0)return n;for(const i of r){if(n.size>=e)break;t(i)&&(n.add(i),r.delete(i))}return n}function SAe(r,e){return _A(r,e,()=>!0)}class xAe extends Map{constructor(t){super();u(this,"getDefault");this.getDefault=t}getOrDefault(t){let n=super.get(t);return n===void 0&&(n=this.getDefault(),this.set(t,n)),n}}function AAe(r,e,t,n){let i=0;Object.entries(e.topics).forEach(([o,a])=>{const c=t.topics[o];if(c===void 0)return;let l=0;if(a.inMesh){let m=a.meshTime/c.timeInMeshQuantum;m>c.timeInMeshCap&&(m=c.timeInMeshCap),l+=m*c.timeInMeshWeight}let d=a.firstMessageDeliveries;if(d>c.firstMessageDeliveriesCap&&(d=c.firstMessageDeliveriesCap),l+=d*c.firstMessageDeliveriesWeight,a.meshMessageDeliveriesActive&&a.meshMessageDeliveries<c.meshMessageDeliveriesThreshold){const m=c.meshMessageDeliveriesThreshold-a.meshMessageDeliveries,f=m*m;l+=f*c.meshMessageDeliveriesWeight}const h=a.meshFailurePenalty;l+=h*c.meshFailurePenaltyWeight;const p=a.invalidMessageDeliveries*a.invalidMessageDeliveries;l+=p*c.invalidMessageDeliveriesWeight,i+=l*c.topicWeight}),t.topicScoreCap>0&&i>t.topicScoreCap&&(i=t.topicScoreCap);const s=t.appSpecificScore(r);if(i+=s*t.appSpecificWeight,e.knownIPs.forEach(o=>{if(t.IPColocationFactorWhitelist.has(o))return;const a=n.get(o),c=a!=null?a.size:0;if(c>t.IPColocationFactorThreshold){const l=c-t.IPColocationFactorThreshold,d=l*l;i+=d*t.IPColocationFactorWeight}}),e.behaviourPenalty>t.behaviourPenaltyThreshold){const o=e.behaviourPenalty-t.behaviourPenaltyThreshold,a=o*o;i+=a*t.behaviourPenaltyWeight}return i}function Vt(r,t){var t=t||{};this._capacity=t.capacity,this._head=0,this._tail=0,Array.isArray(r)?this._fromArray(r):(this._capacityMask=3,this._list=new Array(4))}Vt.prototype.peekAt=function(e){var t=e;if(t===(t|0)){var n=this.size();if(!(t>=n||t<-n))return t<0&&(t+=n),t=this._head+t&this._capacityMask,this._list[t]}},Vt.prototype.get=function(e){return this.peekAt(e)},Vt.prototype.peek=function(){if(this._head!==this._tail)return this._list[this._head]},Vt.prototype.peekFront=function(){return this.peek()},Vt.prototype.peekBack=function(){return this.peekAt(-1)},Object.defineProperty(Vt.prototype,"length",{get:function(){return this.size()}}),Vt.prototype.size=function(){return this._head===this._tail?0:this._head<this._tail?this._tail-this._head:this._capacityMask+1-(this._head-this._tail)},Vt.prototype.unshift=function(e){if(arguments.length===0)return this.size();var t=this._list.length;return this._head=this._head-1+t&this._capacityMask,this._list[this._head]=e,this._tail===this._head&&this._growArray(),this._capacity&&this.size()>this._capacity&&this.pop(),this._head<this._tail?this._tail-this._head:this._capacityMask+1-(this._head-this._tail)},Vt.prototype.shift=function(){var e=this._head;if(e!==this._tail){var t=this._list[e];return this._list[e]=void 0,this._head=e+1&this._capacityMask,e<2&&this._tail>1e4&&this._tail<=this._list.length>>>2&&this._shrinkArray(),t}},Vt.prototype.push=function(e){if(arguments.length===0)return this.size();var t=this._tail;return this._list[t]=e,this._tail=t+1&this._capacityMask,this._tail===this._head&&this._growArray(),this._capacity&&this.size()>this._capacity&&this.shift(),this._head<this._tail?this._tail-this._head:this._capacityMask+1-(this._head-this._tail)},Vt.prototype.pop=function(){var e=this._tail;if(e!==this._head){var t=this._list.length;this._tail=e-1+t&this._capacityMask;var n=this._list[this._tail];return this._list[this._tail]=void 0,this._head<2&&e>1e4&&e<=t>>>2&&this._shrinkArray(),n}},Vt.prototype.removeOne=function(e){var t=e;if(t===(t|0)&&this._head!==this._tail){var n=this.size(),i=this._list.length;if(!(t>=n||t<-n)){t<0&&(t+=n),t=this._head+t&this._capacityMask;var s=this._list[t],o;if(e<n/2){for(o=e;o>0;o--)this._list[t]=this._list[t=t-1+i&this._capacityMask];this._list[t]=void 0,this._head=this._head+1+i&this._capacityMask}else{for(o=n-1-e;o>0;o--)this._list[t]=this._list[t=t+1+i&this._capacityMask];this._list[t]=void 0,this._tail=this._tail-1+i&this._capacityMask}return s}}},Vt.prototype.remove=function(e,t){var n=e,i,s=t;if(n===(n|0)&&this._head!==this._tail){var o=this.size(),a=this._list.length;if(!(n>=o||n<-o||t<1)){if(n<0&&(n+=o),t===1||!t)return i=new Array(1),i[0]=this.removeOne(n),i;if(n===0&&n+t>=o)return i=this.toArray(),this.clear(),i;n+t>o&&(t=o-n);var c;for(i=new Array(t),c=0;c<t;c++)i[c]=this._list[this._head+n+c&this._capacityMask];if(n=this._head+n&this._capacityMask,e+t===o){for(this._tail=this._tail-t+a&this._capacityMask,c=t;c>0;c--)this._list[n=n+1+a&this._capacityMask]=void 0;return i}if(e===0){for(this._head=this._head+t+a&this._capacityMask,c=t-1;c>0;c--)this._list[n=n+1+a&this._capacityMask]=void 0;return i}if(n<o/2){for(this._head=this._head+e+t+a&this._capacityMask,c=e;c>0;c--)this.unshift(this._list[n=n-1+a&this._capacityMask]);for(n=this._head-1+a&this._capacityMask;s>0;)this._list[n=n-1+a&this._capacityMask]=void 0,s--;e<0&&(this._tail=n)}else{for(this._tail=n,n=n+t+a&this._capacityMask,c=o-(t+e);c>0;c--)this.push(this._list[n++]);for(n=this._tail;s>0;)this._list[n=n+1+a&this._capacityMask]=void 0,s--}return this._head<2&&this._tail>1e4&&this._tail<=a>>>2&&this._shrinkArray(),i}}},Vt.prototype.splice=function(e,t){var n=e;if(n===(n|0)){var i=this.size();if(n<0&&(n+=i),!(n>i))if(arguments.length>2){var s,o,a,c=arguments.length,l=this._list.length,d=2;if(!i||n<i/2){for(o=new Array(n),s=0;s<n;s++)o[s]=this._list[this._head+s&this._capacityMask];for(t===0?(a=[],n>0&&(this._head=this._head+n+l&this._capacityMask)):(a=this.remove(n,t),this._head=this._head+n+l&this._capacityMask);c>d;)this.unshift(arguments[--c]);for(s=n;s>0;s--)this.unshift(o[s-1])}else{o=new Array(i-(n+t));var h=o.length;for(s=0;s<h;s++)o[s]=this._list[this._head+n+t+s&this._capacityMask];for(t===0?(a=[],n!=i&&(this._tail=this._head+n+l&this._capacityMask)):(a=this.remove(n,t),this._tail=this._tail-h+l&this._capacityMask);d<c;)this.push(arguments[d++]);for(s=0;s<h;s++)this.push(o[s])}return a}else return this.remove(n,t)}},Vt.prototype.clear=function(){this._list=new Array(this._list.length),this._head=0,this._tail=0},Vt.prototype.isEmpty=function(){return this._head===this._tail},Vt.prototype.toArray=function(){return this._copyArray(!1)},Vt.prototype._fromArray=function(e){var t=e.length,n=this._nextPowerOf2(t);this._list=new Array(n),this._capacityMask=n-1,this._tail=t;for(var i=0;i<t;i++)this._list[i]=e[i]},Vt.prototype._copyArray=function(e,t){var n=this._list,i=n.length,s=this.length;if(t=t|s,t==s&&this._head<this._tail)return this._list.slice(this._head,this._tail);var o=new Array(t),a=0,c;if(e||this._head>this._tail){for(c=this._head;c<i;c++)o[a++]=n[c];for(c=0;c<this._tail;c++)o[a++]=n[c]}else for(c=this._head;c<this._tail;c++)o[a++]=n[c];return o},Vt.prototype._growArray=function(){if(this._head!=0){var e=this._copyArray(!0,this._list.length<<1);this._tail=this._list.length,this._head=0,this._list=e}else this._tail=this._list.length,this._list.length<<=1;this._capacityMask=this._capacityMask<<1|1},Vt.prototype._shrinkArray=function(){this._list.length>>>=1,this._capacityMask>>>=1},Vt.prototype._nextPowerOf2=function(e){var t=Math.log(e)/Math.log(2),n=1<<t+1;return Math.max(n,4)};var CAe=Vt;const IAe=Je(CAe);var Un;(function(r){r[r.unknown=0]="unknown",r[r.valid=1]="valid",r[r.invalid=2]="invalid",r[r.ignored=3]="ignored"})(Un||(Un={}));class kAe{constructor(){u(this,"records");u(this,"queue");this.records=new Map,this.queue=new IAe}getRecord(e){return this.records.get(e)}ensureRecord(e){let t=this.records.get(e);if(t!=null)return t;t={status:Un.unknown,firstSeenTsMs:Date.now(),validated:0,peers:new Set},this.records.set(e,t);const n={msgId:e,expire:Date.now()+tAe};return this.queue.push(n),t}gc(){const e=Date.now();let t=this.queue.peekFront();for(;t!=null&&t.expire<e;)this.records.delete(t.msgId),this.queue.shift(),t=this.queue.peekFront()}clear(){this.records.clear(),this.queue.clear()}}class _Ae{constructor(e,t,n,i){u(this,"params");u(this,"metrics");u(this,"peerStats",new Map);u(this,"peerIPs",new xAe(()=>new Set));u(this,"scoreCache",new Map);u(this,"deliveryRecords",new kAe);u(this,"_backgroundInterval");u(this,"scoreCacheValidityMs");u(this,"computeScore");u(this,"log");this.params=e,this.metrics=t,wAe(e),this.scoreCacheValidityMs=i.scoreCacheValidityMs,this.computeScore=i.computeScore??AAe,this.log=n.forComponent("libp2p:gossipsub:score")}get size(){return this.peerStats.size}start(){if(this._backgroundInterval!=null){this.log("Peer score already running");return}this._backgroundInterval=setInterval(()=>{this.background()},this.params.decayInterval),this.log("started")}stop(){if(this._backgroundInterval==null){this.log("Peer score already stopped");return}clearInterval(this._backgroundInterval),delete this._backgroundInterval,this.peerIPs.clear(),this.peerStats.clear(),this.deliveryRecords.clear(),this.log("stopped")}background(){this.refreshScores(),this.deliveryRecords.gc()}dumpPeerScoreStats(){return Object.fromEntries(Array.from(this.peerStats.entries()).map(([e,t])=>[e,t]))}messageFirstSeenTimestampMs(e){const t=this.deliveryRecords.getRecord(e);return t!=null?t.firstSeenTsMs:null}refreshScores(){const e=Date.now(),t=this.params.decayToZero;this.peerStats.forEach((n,i)=>{if(!n.connected){e>n.expire&&(this.removeIPsForPeer(i,n.knownIPs),this.peerStats.delete(i),this.scoreCache.delete(i));return}Object.entries(n.topics).forEach(([s,o])=>{const a=this.params.topics[s];a!==void 0&&(o.firstMessageDeliveries*=a.firstMessageDeliveriesDecay,o.firstMessageDeliveries<t&&(o.firstMessageDeliveries=0),o.meshMessageDeliveries*=a.meshMessageDeliveriesDecay,o.meshMessageDeliveries<t&&(o.meshMessageDeliveries=0),o.meshFailurePenalty*=a.meshFailurePenaltyDecay,o.meshFailurePenalty<t&&(o.meshFailurePenalty=0),o.invalidMessageDeliveries*=a.invalidMessageDeliveriesDecay,o.invalidMessageDeliveries<t&&(o.invalidMessageDeliveries=0),o.inMesh&&(o.meshTime=e-o.graftTime,o.meshTime>a.meshMessageDeliveriesActivation&&(o.meshMessageDeliveriesActive=!0)))}),n.behaviourPenalty*=this.params.behaviourPenaltyDecay,n.behaviourPenalty<t&&(n.behaviourPenalty=0)})}score(e){var a,c,l;(a=this.metrics)==null||a.scoreFnCalls.inc();const t=this.peerStats.get(e);if(t==null)return 0;const n=Date.now(),i=this.scoreCache.get(e);if(i!=null&&i.cacheUntil>n)return i.score;(c=this.metrics)==null||c.scoreFnRuns.inc();const s=this.computeScore(e,t,this.params,this.peerIPs),o=n+this.scoreCacheValidityMs;return i!=null?((l=this.metrics)==null||l.scoreCachedDelta.observe(Math.abs(s-i.score)),i.score=s,i.cacheUntil=o):this.scoreCache.set(e,{score:s,cacheUntil:o}),s}addPenalty(e,t,n){var s;const i=this.peerStats.get(e);i!=null&&(i.behaviourPenalty+=t,(s=this.metrics)==null||s.onScorePenalty(n))}addPeer(e){const t={connected:!0,expire:0,topics:{},knownIPs:new Set,behaviourPenalty:0};this.peerStats.set(e,t)}addIP(e,t){const n=this.peerStats.get(e);n!=null&&n.knownIPs.add(t),this.peerIPs.getOrDefault(t).add(e)}removeIP(e,t){const n=this.peerStats.get(e);n!=null&&n.knownIPs.delete(t);const i=this.peerIPs.get(t);i!=null&&(i.delete(e),i.size===0&&this.peerIPs.delete(t))}removePeer(e){const t=this.peerStats.get(e);if(t!=null){if(this.score(e)>0){this.removeIPsForPeer(e,t.knownIPs),this.peerStats.delete(e);return}Object.entries(t.topics).forEach(([n,i])=>{i.firstMessageDeliveries=0;const s=this.params.topics[n].meshMessageDeliveriesThreshold;if(i.inMesh&&i.meshMessageDeliveriesActive&&i.meshMessageDeliveries<s){const o=s-i.meshMessageDeliveries;i.meshFailurePenalty+=o*o}i.inMesh=!1,i.meshMessageDeliveriesActive=!1}),t.connected=!1,t.expire=Date.now()+this.params.retainScore}}graft(e,t){const n=this.peerStats.get(e);if(n!=null){const i=this.getPtopicStats(n,t);i!=null&&(i.inMesh=!0,i.graftTime=Date.now(),i.meshTime=0,i.meshMessageDeliveriesActive=!1)}}prune(e,t){const n=this.peerStats.get(e);if(n!=null){const i=this.getPtopicStats(n,t);if(i!=null){const s=this.params.topics[t].meshMessageDeliveriesThreshold;if(i.meshMessageDeliveriesActive&&i.meshMessageDeliveries<s){const o=s-i.meshMessageDeliveries;i.meshFailurePenalty+=o*o}i.meshMessageDeliveriesActive=!1,i.inMesh=!1}}}validateMessage(e){this.deliveryRecords.ensureRecord(e)}deliverMessage(e,t,n){this.markFirstMessageDelivery(e,n);const i=this.deliveryRecords.ensureRecord(t),s=Date.now();if(i.status!==Un.unknown){this.log("unexpected delivery: message from %s was first seen %s ago and has delivery status %s",e,s-i.firstSeenTsMs,Un[i.status]);return}i.status=Un.valid,i.validated=s,i.peers.forEach(o=>{o!==e.toString()&&this.markDuplicateMessageDelivery(o,n)})}rejectInvalidMessage(e,t){this.markInvalidMessageDelivery(e,t)}rejectMessage(e,t,n,i){switch(i){case ms.Error:this.markInvalidMessageDelivery(e,n);return;case ms.Blacklisted:return}const s=this.deliveryRecords.ensureRecord(t);if(s.status!==Un.unknown){this.log("unexpected rejection: message from %s was first seen %s ago and has delivery status %d",e,Date.now()-s.firstSeenTsMs,Un[s.status]);return}if(i===ms.Ignore){s.status=Un.ignored,s.peers.clear();return}s.status=Un.invalid,this.markInvalidMessageDelivery(e,n),s.peers.forEach(o=>{this.markInvalidMessageDelivery(o,n)}),s.peers.clear()}duplicateMessage(e,t,n){const i=this.deliveryRecords.ensureRecord(t);if(!i.peers.has(e))switch(i.status){case Un.unknown:i.peers.add(e);break;case Un.valid:i.peers.add(e),this.markDuplicateMessageDelivery(e,n,i.validated);break;case Un.invalid:this.markInvalidMessageDelivery(e,n);break;case Un.ignored:break}}markInvalidMessageDelivery(e,t){const n=this.peerStats.get(e);if(n!=null){const i=this.getPtopicStats(n,t);i!=null&&(i.invalidMessageDeliveries+=1)}}markFirstMessageDelivery(e,t){const n=this.peerStats.get(e);if(n!=null){const i=this.getPtopicStats(n,t);if(i!=null){let s=this.params.topics[t].firstMessageDeliveriesCap;i.firstMessageDeliveries=Math.min(s,i.firstMessageDeliveries+1),i.inMesh&&(s=this.params.topics[t].meshMessageDeliveriesCap,i.meshMessageDeliveries=Math.min(s,i.meshMessageDeliveries+1))}}}markDuplicateMessageDelivery(e,t,n){var s;const i=this.peerStats.get(e);if(i!=null){const o=n!==void 0?Date.now():0,a=this.getPtopicStats(i,t);if(a!=null&&a.inMesh){const c=this.params.topics[t];if(n!==void 0){const d=o-n,h=d>c.meshMessageDeliveriesWindow;if((s=this.metrics)==null||s.onDuplicateMsgDelivery(t,d,h),h)return}const l=c.meshMessageDeliveriesCap;a.meshMessageDeliveries=Math.min(l,a.meshMessageDeliveries+1)}}}removeIPsForPeer(e,t){for(const n of t){const i=this.peerIPs.get(n);i!=null&&(i.delete(e),i.size===0&&this.peerIPs.delete(n))}}getPtopicStats(e,t){let n=e.topics[t];return n!==void 0?n:this.params.topics[t]!==void 0?(n={inMesh:!1,graftTime:0,meshTime:0,firstMessageDeliveries:0,meshMessageDeliveries:0,meshMessageDeliveriesActive:!1,meshFailurePenalty:0,invalidMessageDeliveries:0},e.topics[t]=n,n):null}}function TAe(r,e,t,n,i){let s=0;const o=new Map;if(Object.entries(e.topics).forEach(([p,m])=>{const f=i.get(p)??"unknown",g=t.topics[p];if(g===void 0)return;let w=o.get(f);w==null&&(w={p1w:0,p2w:0,p3w:0,p3bw:0,p4w:0},o.set(f,w));let y=0,b=0,v=0,E=0,C=0;if(m.inMesh){const T=Math.max(m.meshTime/g.timeInMeshQuantum,g.timeInMeshCap);y+=T*g.timeInMeshWeight}let k=m.firstMessageDeliveries;if(k>g.firstMessageDeliveriesCap&&(k=g.firstMessageDeliveriesCap),b+=k*g.firstMessageDeliveriesWeight,m.meshMessageDeliveriesActive&&m.meshMessageDeliveries<g.meshMessageDeliveriesThreshold){const T=g.meshMessageDeliveriesThreshold-m.meshMessageDeliveries,L=T*T;v+=L*g.meshMessageDeliveriesWeight}const x=m.meshFailurePenalty;E+=x*g.meshFailurePenaltyWeight;const I=m.invalidMessageDeliveries*m.invalidMessageDeliveries;C+=I*g.invalidMessageDeliveriesWeight,s+=(y+b+v+E+C)*g.topicWeight,w.p1w+=y,w.p2w+=b,w.p3w+=v,w.p3bw+=E,w.p4w+=C}),t.topicScoreCap>0&&s>t.topicScoreCap){s=t.topicScoreCap;const p=t.topicScoreCap/s;for(const m of o.values())m.p1w*=p,m.p2w*=p,m.p3w*=p,m.p3bw*=p,m.p4w*=p}let a=0,c=0,l=0;const d=t.appSpecificScore(r);a+=d*t.appSpecificWeight,e.knownIPs.forEach(p=>{if(t.IPColocationFactorWhitelist.has(p))return;const m=n.get(p),f=m!=null?m.size:0;if(f>t.IPColocationFactorThreshold){const g=f-t.IPColocationFactorThreshold,w=g*g;c+=w*t.IPColocationFactorWeight}});const h=e.behaviourPenalty*e.behaviourPenalty;return l+=h*t.behaviourPenaltyWeight,s+=a+c+l,{byTopic:o,p5w:a,p6w:c,p7w:l,score:s}}function PAe(r,e,t,n,i){const s={byTopic:new Map,p5w:[],p6w:[],p7w:[],score:[]};for(const o of r){const a=e.get(o);if(a!=null){const c=TAe(o,a,t,n,i);for(const[l,d]of c.byTopic){let h=s.byTopic.get(l);h==null&&(h={p1w:[],p2w:[],p3w:[],p3bw:[],p4w:[]},s.byTopic.set(l,h)),h.p1w.push(d.p1w),h.p2w.push(d.p2w),h.p3w.push(d.p3w),h.p3bw.push(d.p3bw),h.p4w.push(d.p4w)}s.p5w.push(c.p5w),s.p6w.push(c.p6w),s.p7w.push(c.p7w),s.score.push(c.score)}else s.p5w.push(0),s.p6w.push(0),s.p7w.push(0),s.score.push(0)}return s}class DAe{constructor(e,t,n){u(this,"rawStream");u(this,"pushable");u(this,"closeController");u(this,"maxBufferSize");this.rawStream=e,this.pushable=ho(),this.closeController=new AbortController,this.maxBufferSize=n.maxBufferSize??1/0,this.closeController.signal.addEventListener("abort",()=>{e.close().catch(i=>{e.abort(i)})}),cn(this.pushable,this.rawStream).catch(t)}get protocol(){return this.rawStream.protocol}push(e){if(this.pushable.readableLength>this.maxBufferSize)throw Error(`OutboundStream buffer full, size > ${this.maxBufferSize}`);this.pushable.push(SA.single(e))}pushPrefixed(e){if(this.pushable.readableLength>this.maxBufferSize)throw Error(`OutboundStream buffer full, size > ${this.maxBufferSize}`);this.pushable.push(e)}async close(){this.closeController.abort(),await this.pushable.return()}}class $Ae{constructor(e,t={}){u(this,"source");u(this,"rawStream");u(this,"closeController");this.rawStream=e,this.closeController=new AbortController,this.closeController.signal.addEventListener("abort",()=>{e.close().catch(n=>{e.abort(n)})}),this.source=cn(this.rawStream,n=>AA(n,t))}async close(){this.closeController.abort()}}class NAe{constructor(e,t,n){u(this,"gossipsubIWantFollowupMs");u(this,"msgIdToStrFn");u(this,"metrics");u(this,"promises",new Map);u(this,"requestMsByMsg",new Map);u(this,"requestMsByMsgExpire");this.gossipsubIWantFollowupMs=e,this.msgIdToStrFn=t,this.metrics=n,this.requestMsByMsgExpire=10*e}get size(){return this.promises.size}get requestMsByMsgSize(){return this.requestMsByMsg.size}addPromise(e,t){const n=Math.floor(Math.random()*t.length),i=t[n],s=this.msgIdToStrFn(i);let o=this.promises.get(s);o==null&&(o=new Map,this.promises.set(s,o));const a=Date.now();o.has(e)||(o.set(e,a+this.gossipsubIWantFollowupMs),this.metrics!=null&&(this.metrics.iwantPromiseStarted.inc(1),this.requestMsByMsg.has(s)||this.requestMsByMsg.set(s,a)))}getBrokenPromises(){var i;const e=Date.now(),t=new Map;let n=0;return this.promises.forEach((s,o)=>{s.forEach((a,c)=>{a<e&&(t.set(c,(t.get(c)??0)+1),s.delete(c),n++)}),s.size===0&&this.promises.delete(o)}),(i=this.metrics)==null||i.iwantPromiseBroken.inc(n),t}deliverMessage(e,t=!1){this.trackMessage(e);const n=this.promises.get(e);n!=null&&(this.promises.delete(e),this.metrics!=null&&(this.metrics.iwantPromiseResolved.inc(1),t&&this.metrics.iwantPromiseResolvedFromDuplicate.inc(1),this.metrics.iwantPromiseResolvedPeers.inc(n.size)))}rejectMessage(e,t){switch(this.trackMessage(e),t){case ms.Error:return}this.promises.delete(e)}clear(){this.promises.clear()}prune(){var n;const e=Date.now()-this.requestMsByMsgExpire;let t=0;for(const[i,s]of this.requestMsByMsg.entries())if(s<e)this.requestMsByMsg.delete(i),t++;else break;(n=this.metrics)==null||n.iwantMessagePruned.inc(t)}trackMessage(e){if(this.metrics!=null){const t=this.requestMsByMsg.get(e);t!==void 0&&(this.metrics.iwantPromiseDeliveryTime.observe((Date.now()-t)/1e3),this.requestMsByMsg.delete(e))}}}const hj=ie("libp2p-pubsub:");async function MAe(r,e,t,n){switch(r.type){case Bh.Signing:{const i={from:r.author.toMultihash().bytes,data:n,seqno:Za(8),topic:e,signature:void 0,key:void 0},s=sr([hj,vu.Message.encode(i)]);i.signature=await r.privateKey.sign(s),i.key=r.key;const o={type:"signed",from:r.author,data:t,sequenceNumber:BigInt(`0x${re(i.seqno??new Uint8Array(0),"base16")}`),topic:e,signature:i.signature,key:kn(i.key)};return{raw:i,msg:o}}case Bh.Anonymous:return{raw:{from:void 0,data:n,seqno:void 0,topic:e,signature:void 0,key:void 0},msg:{type:"unsigned",data:t,topic:e}};default:throw new Error("Unreachable")}}async function OAe(r,e){switch(r){case vb:return e.signature!=null?{valid:!1,error:Rn.SignaturePresent}:e.seqno!=null?{valid:!1,error:Rn.SeqnoPresent}:e.key!=null?{valid:!1,error:Rn.FromPresent}:{valid:!0,message:{type:"unsigned",topic:e.topic,data:e.data??new Uint8Array(0)}};case T2:{if(e.seqno==null)return{valid:!1,error:Rn.InvalidSeqno};if(e.seqno.length!==8)return{valid:!1,error:Rn.InvalidSeqno};if(e.signature==null)return{valid:!1,error:Rn.InvalidSignature};if(e.from==null)return{valid:!1,error:Rn.InvalidPeerId};let t;try{t=ei(ij(e.from))}catch{return{valid:!1,error:Rn.InvalidPeerId}}let n;if(e.key!=null){if(n=kn(e.key),t.publicKey!==void 0&&!n.equals(t.publicKey))return{valid:!1,error:Rn.InvalidPeerId}}else{if(t.publicKey==null)return{valid:!1,error:Rn.InvalidPeerId};n=t.publicKey}const i={from:e.from,data:e.data,seqno:e.seqno,topic:e.topic,signature:void 0,key:void 0},s=sr([hj,vu.Message.encode(i)]);return await n.verify(s,e.signature)?{valid:!0,message:{type:"signed",from:t,data:e.data??new Uint8Array(0),sequenceNumber:BigInt(`0x${re(e.seqno,"base16")}`),topic:e.topic,signature:e.signature,key:e.key!=null?kn(e.key):n}}:{valid:!1,error:Rn.InvalidSignature}}default:throw new Error("Unreachable")}}function Ys(r=[],e){return{subscriptions:[],messages:r,control:e!==void 0?{graft:e.graft??[],prune:e.prune??[],ihave:e.ihave??[],iwant:e.iwant??[],idontwant:e.idontwant??[]}:void 0}}function fj(r){return r.control===void 0&&(r.control={graft:[],prune:[],ihave:[],iwant:[],idontwant:[]}),r}function sa(r){if(r.length<=1)return r;const e=()=>Math.floor(Math.random()*Math.floor(r.length));for(let t=0;t<r.length;t++){const n=e(),i=r[t];r[t]=r[n],r[n]=i}return r}function RAe(r){return re(r,"base64")}function LAe(r,e,t){switch(r){case T2:return{type:Bh.Signing,author:e,key:ki(t.publicKey),privateKey:t};case vb:return{type:Bh.Anonymous};default:throw new Error(`Unknown signature policy "${r}"`)}}const BAe=(r,e)=>{const t=ie(e.toString(16).padStart(16,"0"),"base16"),n=ki(r),i=new Uint8Array(n.byteLength+t.length);return i.set(n,0),i.set(t,n.byteLength),i};function UAe({name:r,code:e,encode:t}){return new FAe(r,e,t)}class FAe{constructor(e,t,n){u(this,"name");u(this,"code");u(this,"encode");this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?nj(this.code,t):t.then(n=>nj(this.code,n))}else throw Error("Unknown type, must be binary type")}}function zAe(r){return async e=>new Uint8Array(await crypto.subtle.digest(r,e))}const VAe=UAe({name:"sha2-256",code:18,encode:zAe("SHA-256")});function KAe(r){if(r.type!=="signed")throw new Error("expected signed message type");if(r.sequenceNumber==null)throw Error("missing seqno field");return BAe(r.from.publicKey??r.key,r.sequenceNumber)}async function jAe(r){return VAe.encode(r.data)}var D4;(function(r){r[r.ip4=4]="ip4",r[r.ip6=41]="ip6"})(D4||(D4={}));function HAe(r){for(const e of r.tuples())switch(e[0]){case D4.ip4:case D4.ip6:return K7(e[0],e[1])}return null}class TA{constructor(e){u(this,"entries",new Map);u(this,"validityMs");this.validityMs=e.validityMs}get size(){return this.entries.size}put(e,t){return this.entries.has(e)?!0:(this.entries.set(e,{value:t,validUntilMs:Date.now()+this.validityMs}),!1)}prune(){const e=Date.now();for(const[t,n]of this.entries.entries())if(n.validUntilMs<e)this.entries.delete(t);else break}has(e){return this.entries.has(e)}get(e){const t=this.entries.get(e);return t!=null&&t.validUntilMs>=Date.now()?t.value:void 0}clear(){this.entries.clear()}}var fi;(function(r){r[r.started=0]="started",r[r.stopped=1]="stopped"})(fi||(fi={}));class pj extends(jH=er,KH=Symbol.toStringTag,VH=ur,zH=ja,jH){constructor(t,n={}){super();u(this,"globalSignaturePolicy");u(this,"multicodecs",[kA,Pxe,aj]);u(this,"publishConfig");u(this,"dataTransform");u(this,"peers",new Map);u(this,"streamsInbound",new Map);u(this,"streamsOutbound",new Map);u(this,"outboundInflightQueue",ho({objectMode:!0}));u(this,"direct",new Set);u(this,"floodsubPeers",new Set);u(this,"seenCache");u(this,"acceptFromWhitelist",new Map);u(this,"topics",new Map);u(this,"subscriptions",new Set);u(this,"mesh",new Map);u(this,"fanout",new Map);u(this,"fanoutLastpub",new Map);u(this,"gossip",new Map);u(this,"control",new Map);u(this,"peerhave",new Map);u(this,"iasked",new Map);u(this,"backoff",new Map);u(this,"outbound",new Map);u(this,"msgIdFn");u(this,"fastMsgIdFn");u(this,"msgIdToStrFn");u(this,"fastMsgIdCache");u(this,"publishedMessageIds");u(this,"mcache");u(this,"score");u(this,"topicValidators",new Map);u(this,"log");u(this,"heartbeatTicks",0);u(this,"gossipTracer");u(this,"idontwantCounts",new Map);u(this,"idontwants",new Map);u(this,"components");u(this,"directPeerInitial",null);u(this,"opts");u(this,"decodeRpcLimits");u(this,"metrics");u(this,"status",{code:fi.stopped});u(this,"maxInboundStreams");u(this,"maxOutboundStreams");u(this,"runOnLimitedConnection");u(this,"allowedTopics");u(this,"heartbeatTimer",null);u(this,KH,"@chainsafe/libp2p-gossipsub");u(this,VH,["@libp2p/pubsub"]);u(this,zH,["@libp2p/identify"]);u(this,"runHeartbeat",()=>{var n;const t=(n=this.metrics)==null?void 0:n.heartbeatDuration.startTimer();this.heartbeat().catch(i=>{this.log("Error running heartbeat",i)}).finally(()=>{var i;if(t!=null&&t(),this.status.code===fi.started){clearTimeout(this.status.heartbeatTimeout);let s=this.opts.heartbeatInterval-(Date.now()-this.status.hearbeatStartMs)%this.opts.heartbeatInterval;s<this.opts.heartbeatInterval*.25&&(s+=this.opts.heartbeatInterval,(i=this.metrics)==null||i.heartbeatSkipped.inc()),this.status.heartbeatTimeout=setTimeout(this.runHeartbeat,s)}})});u(this,"tagMeshPeer",t=>{const{peerId:n,topic:i}=t.detail;this.components.peerStore.merge(this.peers.get(n)??tr(n),{tags:{[i]:{value:100}}}).catch(s=>{this.log.error("Error tagging peer %s with topic %s",n,i,s)})});u(this,"untagMeshPeer",t=>{const{peerId:n,topic:i}=t.detail;this.components.peerStore.merge(this.peers.get(n)??tr(n),{tags:{[i]:void 0}}).catch(s=>{this.log.error("Error untagging peer %s with topic %s",n,i,s)})});const i={fallbackToFloodsub:!0,floodPublish:!0,batchPublish:!1,tagMeshPeers:!0,doPX:!1,directPeers:[],D:Dxe,Dlo:$xe,Dhi:Nxe,Dscore:Mxe,Dout:Oxe,Dlazy:Bxe,heartbeatInterval:zxe,fanoutTTL:Vxe,mcacheLength:Rxe,mcacheGossip:Lxe,seenTTL:eAe,gossipsubIWantFollowupMs:Zxe,prunePeers:Kxe,pruneBackoff:jxe,unsubcribeBackoff:Hxe,graftFloodThreshold:Jxe,opportunisticGraftPeers:Yxe,opportunisticGraftTicks:Qxe,directConnectTicks:Wxe,gossipFactor:Uxe,idontwantMinDataSize:lAe,idontwantMaxMessages:uAe,...n,scoreParams:yAe(n.scoreParams),scoreThresholds:EAe(n.scoreThresholds)};if(this.components=t,this.decodeRpcLimits=i.decodeRpcLimits??dAe,this.globalSignaturePolicy=i.globalSignaturePolicy??T2,i.fallbackToFloodsub&&this.multicodecs.push(oj),this.log=t.logger.forComponent(i.debugName??"libp2p:gossipsub"),this.opts=i,this.direct=new Set(i.directPeers.map(s=>s.id.toString())),this.seenCache=new TA({validityMs:i.seenTTL}),this.publishedMessageIds=new TA({validityMs:i.seenTTL}),n.msgIdFn!=null)this.msgIdFn=n.msgIdFn;else switch(this.globalSignaturePolicy){case T2:this.msgIdFn=KAe;break;case vb:this.msgIdFn=jAe;break;default:throw new Error(`Invalid globalSignaturePolicy: ${this.globalSignaturePolicy}`)}if(n.fastMsgIdFn!=null&&(this.fastMsgIdFn=n.fastMsgIdFn,this.fastMsgIdCache=new TA({validityMs:i.seenTTL})),this.msgIdToStrFn=n.msgIdToStrFn??RAe,this.mcache=n.messageCache??new hAe(i.mcacheGossip,i.mcacheLength,this.msgIdToStrFn),n.dataTransform!=null&&(this.dataTransform=n.dataTransform),n.metricsRegister!=null){if(n.metricsTopicStrToLabel==null)throw Error("Must set metricsTopicStrToLabel with metrics");const s=Math.max(...Object.values(i.scoreParams.topics).map(a=>a.meshMessageDeliveriesWindow),aAe),o=fAe(n.metricsRegister,n.metricsTopicStrToLabel,{gossipPromiseExpireSec:this.opts.gossipsubIWantFollowupMs/1e3,behaviourPenaltyThreshold:i.scoreParams.behaviourPenaltyThreshold,maxMeshMessageDeliveriesWindowSec:s/1e3});o.mcacheSize.addCollect(()=>{this.onScrapeMetrics(o)});for(const a of this.multicodecs)o.protocolsEnabled.set({protocol:a},1);this.metrics=o}else this.metrics=null;this.gossipTracer=new NAe(this.opts.gossipsubIWantFollowupMs,this.msgIdToStrFn,this.metrics),this.score=new _Ae(this.opts.scoreParams,this.metrics,this.components.logger,{scoreCacheValidityMs:i.heartbeatInterval}),this.maxInboundStreams=n.maxInboundStreams,this.maxOutboundStreams=n.maxOutboundStreams,this.runOnLimitedConnection=n.runOnLimitedConnection,this.allowedTopics=i.allowedTopics!=null?new Set(i.allowedTopics):null}getPeers(){return[...this.peers.values()]}isStarted(){return this.status.code===fi.started}async start(){if(this.isStarted())return;this.log("starting"),this.publishConfig=LAe(this.globalSignaturePolicy,this.components.peerId,this.components.privateKey),this.outboundInflightQueue=ho({objectMode:!0}),cn(this.outboundInflightQueue,async o=>{for await(const{peerId:a,connection:c}of o)await this.createOutboundStream(a,c)}).catch(o=>{this.log.error("outbound inflight queue error",o)}),await Promise.all(this.opts.directPeers.map(async o=>{await this.components.peerStore.merge(o.id,{multiaddrs:o.addrs})}));const t=this.components.registrar;await Promise.all(this.multicodecs.map(async o=>t.handle(o,this.onIncomingStream.bind(this),{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:this.runOnLimitedConnection})));const n={onConnect:this.onPeerConnected.bind(this),onDisconnect:this.onPeerDisconnected.bind(this),notifyOnLimitedConnection:this.runOnLimitedConnection},i=await Promise.all(this.multicodecs.map(async o=>t.register(o,n))),s=setTimeout(this.runHeartbeat,cj);this.status={code:fi.started,registrarTopologyIds:i,heartbeatTimeout:s,hearbeatStartMs:Date.now()+cj},this.score.start(),this.directPeerInitial=setTimeout(()=>{Promise.resolve().then(async()=>{await Promise.all(Array.from(this.direct).map(async o=>this.connect(o)))}).catch(o=>{this.log(o)})},Gxe),this.opts.tagMeshPeers&&(this.addEventListener("gossipsub:graft",this.tagMeshPeer),this.addEventListener("gossipsub:prune",this.untagMeshPeer)),this.log("started")}async stop(){if(this.log("stopping"),this.status.code!==fi.started)return;const{registrarTopologyIds:t}=this.status;this.status={code:fi.stopped},this.opts.tagMeshPeers&&(this.removeEventListener("gossipsub:graft",this.tagMeshPeer),this.removeEventListener("gossipsub:prune",this.untagMeshPeer));const n=this.components.registrar;await Promise.all(this.multicodecs.map(async s=>n.unhandle(s))),t.forEach(s=>{n.unregister(s)}),this.outboundInflightQueue.end();const i=[];for(const s of this.streamsOutbound.values())i.push(s.close());this.streamsOutbound.clear();for(const s of this.streamsInbound.values())i.push(s.close());this.streamsInbound.clear(),await Promise.all(i),this.peers.clear(),this.subscriptions.clear(),this.heartbeatTimer!=null&&(this.heartbeatTimer.cancel(),this.heartbeatTimer=null),this.score.stop(),this.mesh.clear(),this.fanout.clear(),this.fanoutLastpub.clear(),this.gossip.clear(),this.control.clear(),this.peerhave.clear(),this.iasked.clear(),this.backoff.clear(),this.outbound.clear(),this.gossipTracer.clear(),this.seenCache.clear(),this.fastMsgIdCache!=null&&this.fastMsgIdCache.clear(),this.directPeerInitial!=null&&clearTimeout(this.directPeerInitial),this.idontwantCounts.clear(),this.idontwants.clear(),this.log("stopped")}dumpPeerScoreStats(){return this.score.dumpPeerScoreStats()}onIncomingStream({stream:t,connection:n}){if(!this.isStarted())return;const i=n.remotePeer;this.addPeer(i,n.direction,n.remoteAddr),this.createInboundStream(i,t),this.outboundInflightQueue.push({peerId:i,connection:n})}onPeerConnected(t,n){var i;(i=this.metrics)==null||i.newConnectionCount.inc({status:n.status}),!(!this.isStarted()||n.status!=="open")&&(this.addPeer(t,n.direction,n.remoteAddr),this.outboundInflightQueue.push({peerId:t,connection:n}))}onPeerDisconnected(t){this.log("connection ended %p",t),this.removePeer(t)}async createOutboundStream(t,n){var s;if(!this.isStarted())return;const i=t.toString();if(this.peers.has(i)&&!this.streamsOutbound.has(i))try{const o=new DAe(await n.newStream(this.multicodecs,{runOnLimitedConnection:this.runOnLimitedConnection}),c=>{this.log.error("outbound pipe error",c)},{maxBufferSize:this.opts.maxOutboundBufferSize});this.log("create outbound stream %p",t),this.streamsOutbound.set(i,o);const a=o.protocol;a===oj&&this.floodsubPeers.add(i),(s=this.metrics)==null||s.peersPerProtocol.inc({protocol:a},1),this.subscriptions.size>0&&(this.log("send subscriptions to",i),this.sendSubscriptions(i,Array.from(this.subscriptions),!0))}catch(o){this.log.error("createOutboundStream error",o)}}createInboundStream(t,n){if(!this.isStarted())return;const i=t.toString();if(!this.peers.has(i))return;const s=this.streamsInbound.get(i);s!==void 0&&(this.log("replacing existing inbound steam %s",i),s.close().catch(a=>{this.log.error(a)})),this.log("create inbound stream %s",i);const o=new $Ae(n,{maxDataLength:this.opts.maxInboundDataLength});this.streamsInbound.set(i,o),this.pipePeerReadStream(t,o.source).catch(a=>{this.log(a)})}addPeer(t,n,i){const s=t.toString();if(!this.peers.has(s)){this.log("new peer %p",t),this.peers.set(s,t),this.score.addPeer(s);const o=HAe(i);o!==null?this.score.addIP(s,o):this.log("Added peer has no IP in current address %s %s",s,i.toString()),this.outbound.has(s)||this.outbound.set(s,n==="outbound")}}removePeer(t){var o,a;const n=t.toString();if(!this.peers.has(n))return;this.log("delete peer %p",t),this.peers.delete(n);const i=this.streamsOutbound.get(n),s=this.streamsInbound.get(n);i!=null&&((o=this.metrics)==null||o.peersPerProtocol.inc({protocol:i.protocol},-1)),i==null||i.close().catch(c=>{this.log.error(c)}),s==null||s.close().catch(c=>{this.log.error(c)}),this.streamsOutbound.delete(n),this.streamsInbound.delete(n);for(const c of this.topics.values())c.delete(n);for(const[c,l]of this.mesh)l.delete(n)&&((a=this.metrics)==null||a.onRemoveFromMesh(c,Qs.Dc,1));for(const c of this.fanout.values())c.delete(n);this.floodsubPeers.delete(n),this.gossip.delete(n),this.control.delete(n),this.outbound.delete(n),this.idontwantCounts.delete(n),this.idontwants.delete(n),this.score.removePeer(n),this.acceptFromWhitelist.delete(n)}get started(){return this.status.code===fi.started}getMeshPeers(t){const n=this.mesh.get(t);return n!=null?Array.from(n):[]}getSubscribers(t){const n=this.topics.get(t);return(n!=null?Array.from(n):[]).map(i=>this.peers.get(i)??tr(i))}getTopics(){return Array.from(this.subscriptions)}async pipePeerReadStream(t,n){var i;try{await cn(n,async s=>{var o,a,c;for await(const l of s)try{const d=l.subarray(),h=vu.decode(d,{limits:{subscriptions:this.decodeRpcLimits.maxSubscriptions,messages:this.decodeRpcLimits.maxMessages,control$:{ihave:this.decodeRpcLimits.maxIhaveMessageIDs,iwant:this.decodeRpcLimits.maxIwantMessageIDs,graft:this.decodeRpcLimits.maxControlMessages,prune:this.decodeRpcLimits.maxControlMessages,prune$:{peers:this.decodeRpcLimits.maxPeerInfos},idontwant:this.decodeRpcLimits.maxControlMessages,idontwant$:{messageIDs:this.decodeRpcLimits.maxIdontwantMessageIDs}}}});if((o=this.metrics)==null||o.onRpcRecv(h,d.length),this.opts.awaitRpcHandler)try{await this.handleReceivedRpc(t,h)}catch(p){(a=this.metrics)==null||a.onRpcRecvError(),this.log(p)}else this.handleReceivedRpc(t,h).catch(p=>{var m;(m=this.metrics)==null||m.onRpcRecvError(),this.log(p)})}catch(d){(c=this.metrics)==null||c.onRpcDataError(),this.log(d)}})}catch(s){(i=this.metrics)==null||i.onPeerReadStreamError(),this.handlePeerReadStreamError(s,t)}}handlePeerReadStreamError(t,n){this.log.error(t),this.onPeerDisconnected(n)}async handleReceivedRpc(t,n){var d;if(!this.acceptFrom(t.toString())){this.log("received message from unacceptable peer %p",t),(d=this.metrics)==null||d.rpcRecvNotAccepted.inc();return}const i=n.subscriptions!=null?n.subscriptions.length:0,s=n.messages!=null?n.messages.length:0;let o=0,a=0,c=0,l=0;if(n.control!=null&&(n.control.ihave!=null&&(o=n.control.ihave.length),n.control.iwant!=null&&(a=n.control.iwant.length),n.control.graft!=null&&(c=n.control.graft.length),n.control.prune!=null&&(l=n.control.prune.length)),this.log(`rpc.from ${t.toString()} subscriptions ${i} messages ${s} ihave ${o} iwant ${a} graft ${c} prune ${l}`),n.subscriptions!=null&&n.subscriptions.length>0){const h=[];n.subscriptions.forEach(p=>{const m=p.topic,f=p.subscribe===!0;if(m!=null){if(this.allowedTopics!=null&&!this.allowedTopics.has(m))return;this.handleReceivedSubscription(t,m,f),h.push({topic:m,subscribe:f})}}),this.safeDispatchEvent("subscription-change",{detail:{peerId:t,subscriptions:h}})}for(const h of n.messages){if(this.allowedTopics!=null&&!this.allowedTopics.has(h.topic))continue;const p=this.handleReceivedMessage(t,h).catch(m=>{var f;(f=this.metrics)==null||f.onMsgRecvError(h.topic),this.log(m)});this.opts.awaitRpcMessageHandler&&await p}n.control!=null&&await this.handleControlMessage(t.toString(),n.control)}handleReceivedSubscription(t,n,i){this.log("subscription update from %p topic %s",t,n);let s=this.topics.get(n);s==null&&(s=new Set,this.topics.set(n,s)),i?s.add(t.toString()):s.delete(t.toString())}async handleReceivedMessage(t,n){var o,a,c;(o=this.metrics)==null||o.onMsgRecvPreValidation(n.topic);const i=await this.validateReceivedMessage(t,n);(a=this.metrics)==null||a.onPrevalidationResult(n.topic,i.code);const s=i.code;switch(s){case Ln.duplicate:this.score.duplicateMessage(t.toString(),i.msgIdStr,n.topic),this.gossipTracer.deliverMessage(i.msgIdStr,!0),this.mcache.observeDuplicate(i.msgIdStr,t.toString());return;case Ln.invalid:if(i.msgIdStr!=null){const l=i.msgIdStr;this.score.rejectMessage(t.toString(),l,n.topic,i.reason),this.gossipTracer.rejectMessage(l,i.reason)}else this.score.rejectInvalidMessage(t.toString(),n.topic);(c=this.metrics)==null||c.onMsgRecvInvalid(n.topic,i);return;case Ln.valid:this.score.validateMessage(i.messageId.msgIdStr),this.gossipTracer.deliverMessage(i.messageId.msgIdStr),this.mcache.put(i.messageId,n,!this.opts.asyncValidation),this.subscriptions.has(n.topic)&&(!this.components.peerId.equals(t)||this.opts.emitSelf)&&(super.dispatchEvent(new CustomEvent("gossipsub:message",{detail:{propagationSource:t,msgId:i.messageId.msgIdStr,msg:i.msg}})),super.dispatchEvent(new CustomEvent("message",{detail:i.msg}))),this.opts.asyncValidation||this.forwardMessage(i.messageId.msgIdStr,n,t.toString());break;default:throw new Error(`Invalid validation result: ${s}`)}}async validateReceivedMessage(t,n){var p,m,f,g;const i=(p=this.fastMsgIdFn)==null?void 0:p.call(this,n),s=i!==void 0?(m=this.fastMsgIdCache)==null?void 0:m.get(i):void 0;if(s!=null)return{code:Ln.duplicate,msgIdStr:s};const o=await OAe(this.globalSignaturePolicy,n);if(!o.valid)return{code:Ln.invalid,reason:ms.Error,error:o.error};const a=o.message;try{this.dataTransform!=null&&(a.data=this.dataTransform.inboundTransform(n.topic,a.data))}catch(w){return this.log("Invalid message, transform failed",w),{code:Ln.invalid,reason:ms.Error,error:Rn.TransformFailed}}const c=await this.msgIdFn(a),l=this.msgIdToStrFn(c),d={msgId:c,msgIdStr:l};if(i!==void 0&&this.fastMsgIdCache!=null&&this.fastMsgIdCache.put(i,l)&&((f=this.metrics)==null||f.fastMsgIdCacheCollision.inc()),this.seenCache.has(l))return{code:Ln.duplicate,msgIdStr:l};this.seenCache.put(l),(((g=n.data)==null?void 0:g.length)??0)>=this.opts.idontwantMinDataSize&&this.sendIDontWants(c,n.topic,t.toString());const h=this.topicValidators.get(n.topic);if(h!=null){let w;try{w=await h(t,a)}catch(y){const b=y.code;b===nAe&&(w=Ci.Ignore),b===rAe?w=Ci.Reject:w=Ci.Ignore}if(w!==Ci.Accept)return{code:Ln.invalid,reason:uj(w),msgIdStr:l}}return{code:Ln.valid,messageId:d,msg:a}}getScore(t){return this.score.score(t)}sendSubscriptions(t,n,i){this.sendRpc(t,{subscriptions:n.map(s=>({topic:s,subscribe:i})),messages:[]})}async handleControlMessage(t,n){var l,d,h,p,m,f,g;if(n===void 0)return;const i=((l=n.ihave)==null?void 0:l.length)>0?this.handleIHave(t,n.ihave):[],s=((d=n.iwant)==null?void 0:d.length)>0?this.handleIWant(t,n.iwant):[],o=((h=n.graft)==null?void 0:h.length)>0?await this.handleGraft(t,n.graft):[];if(((p=n.prune)==null?void 0:p.length)>0&&await this.handlePrune(t,n.prune),((m=n.idontwant)==null?void 0:m.length)>0&&this.handleIdontwant(t,n.idontwant),i.length===0&&s.length===0&&o.length===0)return;const a=this.sendRpc(t,Ys(s,{iwant:i,prune:o})),c=(f=i[0])==null?void 0:f.messageIDs;c!=null&&(a?this.gossipTracer.addPromise(t,c):(g=this.metrics)==null||g.iwantPromiseUntracked.inc(1))}acceptFrom(t){if(this.direct.has(t))return!0;const n=Date.now(),i=this.acceptFromWhitelist.get(t);if(i!=null&&i.messagesAccepted<sAe&&i.acceptUntil>=n)return i.messagesAccepted+=1,!0;const s=this.score.score(t);return s>=iAe?this.acceptFromWhitelist.set(t,{messagesAccepted:0,acceptUntil:n+oAe}):this.acceptFromWhitelist.delete(t),s>=this.opts.scoreThresholds.graylistThreshold}handleIHave(t,n){var d,h,p;if(n.length===0)return[];const i=this.score.score(t);if(i<this.opts.scoreThresholds.gossipThreshold)return this.log("IHAVE: ignoring peer %s with score below threshold [ score = %d ]",t,i),(d=this.metrics)==null||d.ihaveRcvIgnored.inc({reason:s0.LowScore}),[];const s=(this.peerhave.get(t)??0)+1;if(this.peerhave.set(t,s),s>Xxe)return this.log("IHAVE: peer %s has advertised too many times (%d) within this heartbeat interval; ignoring",t,s),(h=this.metrics)==null||h.ihaveRcvIgnored.inc({reason:s0.MaxIhave}),[];const o=this.iasked.get(t)??0;if(o>=Lh)return this.log("IHAVE: peer %s has already advertised too many messages (%d); ignoring",t,o),(p=this.metrics)==null||p.ihaveRcvIgnored.inc({reason:s0.MaxIasked}),[];const a=new Map;if(n.forEach(({topicID:m,messageIDs:f})=>{var w;if(m==null||f==null||!this.mesh.has(m))return;let g=0;f.forEach(y=>{const b=this.msgIdToStrFn(y);this.seenCache.has(b)||(a.set(b,y),g++)}),(w=this.metrics)==null||w.onIhaveRcv(m,f.length,g)}),a.size===0)return[];let c=a.size;c+o>Lh&&(c=Lh-o),this.log("IHAVE: Asking for %d out of %d messages from %s",c,a.size,t);let l=Array.from(a.values());return sa(l),l=l.slice(0,c),this.iasked.set(t,o+c),[{messageIDs:l}]}handleIWant(t,n){var c;if(n.length===0)return[];const i=this.score.score(t);if(i<this.opts.scoreThresholds.gossipThreshold)return this.log("IWANT: ignoring peer %s with score below threshold [score = %d]",t,i),[];const s=new Map,o=new Map;let a=0;return n.forEach(({messageIDs:l})=>{l==null||l.forEach(d=>{const h=this.msgIdToStrFn(d),p=this.mcache.getWithIWantCount(h,t);if(p==null){a++;return}if(o.set(p.msg.topic,1+(o.get(p.msg.topic)??0)),p.count>Fxe){this.log("IWANT: Peer %s has asked for message %s too many times: ignoring request",t,d);return}s.set(h,p.msg)})}),(c=this.metrics)==null||c.onIwantRcv(o,a),s.size===0?(this.log("IWANT: Could not provide any wanted messages to %s",t),[]):(this.log("IWANT: Sending %d messages to %s",s.size,t),Array.from(s.values()))}async handleGraft(t,n){const i=[],s=this.score.score(t),o=Date.now();let a=this.opts.doPX;if(n.forEach(({topicID:l})=>{var p,m;if(l==null)return;const d=this.mesh.get(l);if(d==null){a=!1;return}if(d.has(t))return;const h=(p=this.backoff.get(l))==null?void 0:p.get(t);if(this.direct.has(t))this.log("GRAFT: ignoring request from direct peer %s",t),i.push(l),a=!1;else if(typeof h=="number"&&o<h){this.log("GRAFT: ignoring backed off peer %s",t),this.score.addPenalty(t,1,i0.GraftBackoff),a=!1;const f=h+this.opts.graftFloodThreshold-this.opts.pruneBackoff;o<f&&this.score.addPenalty(t,1,i0.GraftBackoff),this.addBackoff(t,l),i.push(l)}else s<0?(this.log("GRAFT: ignoring peer %s with negative score: score=%d, topic=%s",t,s,l),i.push(l),a=!1,this.addBackoff(t,l)):d.size>=this.opts.Dhi&&!(this.outbound.get(t)??!1)?(i.push(l),this.addBackoff(t,l)):(this.log("GRAFT: Add mesh link from %s in %s",t,l),this.score.graft(t,l),d.add(t),(m=this.metrics)==null||m.onAddToMesh(l,Bn.Subscribed,1));this.safeDispatchEvent("gossipsub:graft",{detail:{peerId:t,topic:l,direction:"inbound"}})}),i.length===0)return[];const c=!1;return Promise.all(i.map(async l=>this.makePrune(t,l,a,c)))}async handlePrune(t,n){var s;const i=this.score.score(t);for(const{topicID:o,backoff:a,peers:c}of n){if(o==null)continue;const l=this.mesh.get(o);if(l==null)return;this.log("PRUNE: Remove mesh link to %s in %s",t,o),this.score.prune(t,o),l.has(t)&&(l.delete(t),(s=this.metrics)==null||s.onRemoveFromMesh(o,Qs.Prune,1)),typeof a=="number"&&a>0?this.doAddBackoff(t,o,a*1e3):this.addBackoff(t,o),c!=null&&c.length>0&&(i<this.opts.scoreThresholds.acceptPXThreshold?this.log("PRUNE: ignoring PX from peer %s with insufficient score [score = %d, topic = %s]",t,i,o):await this.pxConnect(c)),this.safeDispatchEvent("gossipsub:prune",{detail:{peerId:t,topic:o,direction:"inbound"}})}}handleIdontwant(t,n){var l;let i=this.idontwantCounts.get(t)??0;if(i>=this.opts.idontwantMaxMessages)return;const s=i;let o=this.idontwants.get(t);o==null&&(o=new Map,this.idontwants.set(t,o));let a=0;e:for(const{messageIDs:d}of n)for(const h of d){if(i>=this.opts.idontwantMaxMessages)break e;i++;const p=this.msgIdToStrFn(h);o.set(p,this.heartbeatTicks),this.mcache.msgs.has(p)||a++}this.idontwantCounts.set(t,i);const c=i-s;(l=this.metrics)==null||l.onIdontwantRcv(c,a)}addBackoff(t,n){this.doAddBackoff(t,n,this.opts.pruneBackoff)}doAddBackoff(t,n,i){let s=this.backoff.get(n);s==null&&(s=new Map,this.backoff.set(n,s));const o=Date.now()+i;(s.get(t)??0)<o&&s.set(t,o)}applyIwantPenalties(){this.gossipTracer.getBrokenPromises().forEach((t,n)=>{this.log("peer %s didn't follow up in %d IWANT requests; adding penalty",n,t),this.score.addPenalty(n,t,i0.BrokenPromise)})}clearBackoff(){if(this.heartbeatTicks%qxe!==0)return;const t=Date.now();this.backoff.forEach((n,i)=>{n.forEach((s,o)=>{s+cAe*this.opts.heartbeatInterval<t&&n.delete(o)}),n.size===0&&this.backoff.delete(i)})}async directConnect(){const t=[];this.direct.forEach(n=>{this.streamsOutbound.has(n)||t.push(n)}),await Promise.all(t.map(async n=>this.connect(n)))}async pxConnect(t){t.length>this.opts.prunePeers&&(sa(t),t=t.slice(0,this.opts.prunePeers));const n=[];await Promise.all(t.map(async i=>{if(i.peerID==null)return;const s=ei(ij(i.peerID)),o=s.toString();if(!this.peers.has(o)){if(i.signedPeerRecord==null){n.push(o);return}try{if(!await this.components.peerStore.consumePeerRecord(i.signedPeerRecord,s)){this.log("bogus peer record obtained through px: could not add peer record to address book");return}n.push(o)}catch{this.log("bogus peer record obtained through px: invalid signature or not a peer record")}}})),n.length!==0&&await Promise.all(n.map(async i=>this.connect(i)))}async connect(t){var s;this.log("Initiating connection with %s",t);const n=tr(t),i=await this.components.connectionManager.openConnection(n);for(const o of this.multicodecs)for(const a of this.components.registrar.getTopologies(o))(s=a.onConnect)==null||s.call(a,n,i)}subscribe(t){if(this.status.code!==fi.started)throw new Error("Pubsub has not started");if(!this.subscriptions.has(t)){this.subscriptions.add(t);for(const n of this.peers.keys())this.sendSubscriptions(n,[t],!0)}this.join(t)}unsubscribe(t){if(this.status.code!==fi.started)throw new Error("Pubsub is not started");const n=this.subscriptions.delete(t);if(this.log("unsubscribe from %s - am subscribed %s",t,n),n)for(const i of this.peers.keys())this.sendSubscriptions(i,[t],!1);this.leave(t)}join(t){var o,a,c;if(this.status.code!==fi.started)throw new Error("Gossipsub has not started");if(this.mesh.has(t))return;this.log("JOIN %s",t),(o=this.metrics)==null||o.onJoin(t);const n=new Set,i=this.backoff.get(t),s=this.fanout.get(t);if(s!=null&&(this.fanout.delete(t),this.fanoutLastpub.delete(t),s.forEach(l=>{!this.direct.has(l)&&this.score.score(l)>=0&&(i==null?void 0:i.has(l))!==!0&&n.add(l)}),(a=this.metrics)==null||a.onAddToMesh(t,Bn.Fanout,n.size)),n.size<this.opts.D){const l=n.size;this.getRandomGossipPeers(t,this.opts.D,h=>!n.has(h)&&!this.direct.has(h)&&this.score.score(h)>=0&&(i==null?void 0:i.has(h))!==!0).forEach(h=>{n.add(h)}),(c=this.metrics)==null||c.onAddToMesh(t,Bn.Random,n.size-l)}this.mesh.set(t,n),n.forEach(l=>{this.log("JOIN: Add mesh link to %s in %s",l,t),this.sendGraft(l,t)})}leave(t){var i;if(this.status.code!==fi.started)throw new Error("Gossipsub has not started");this.log("LEAVE %s",t),(i=this.metrics)==null||i.onLeave(t);const n=this.mesh.get(t);n!=null&&(Promise.all(Array.from(n).map(async s=>{this.log("LEAVE: Remove mesh link to %s in %s",s,t),await this.sendPrune(s,t)})).catch(s=>{this.log("Error sending prunes to mesh peers",s)}),this.mesh.delete(t))}selectPeersToForward(t,n,i){const s=new Set,o=this.topics.get(t);o!=null&&(this.direct.forEach(c=>{o.has(c)&&n!==c&&!((i==null?void 0:i.has(c))??!1)&&s.add(c)}),this.floodsubPeers.forEach(c=>{o.has(c)&&n!==c&&!((i==null?void 0:i.has(c))??!1)&&this.score.score(c)>=this.opts.scoreThresholds.publishThreshold&&s.add(c)}));const a=this.mesh.get(t);return a!=null&&a.size>0&&a.forEach(c=>{n!==c&&!((i==null?void 0:i.has(c))??!1)&&s.add(c)}),s}selectPeersToPublish(t){const n=new Set,i={direct:0,floodsub:0,mesh:0,fanout:0},s=this.topics.get(t);if(s!=null)if(this.opts.floodPublish)s.forEach(o=>{this.direct.has(o)?(n.add(o),i.direct++):this.score.score(o)>=this.opts.scoreThresholds.publishThreshold&&(n.add(o),i.floodsub++)});else{this.direct.forEach(a=>{s.has(a)&&(n.add(a),i.direct++)}),this.floodsubPeers.forEach(a=>{s.has(a)&&this.score.score(a)>=this.opts.scoreThresholds.publishThreshold&&(n.add(a),i.floodsub++)});const o=this.mesh.get(t);if(o!=null&&o.size>0)o.forEach(a=>{n.add(a),i.mesh++}),o.size<this.opts.D&&this.getRandomGossipPeers(t,this.opts.D-o.size,c=>!o.has(c)&&!this.direct.has(c)&&!this.floodsubPeers.has(c)&&this.score.score(c)>=this.opts.scoreThresholds.publishThreshold).forEach(c=>{n.add(c),i.mesh++});else{const a=this.fanout.get(t);if(a!=null&&a.size>0)a.forEach(c=>{n.add(c),i.fanout++});else{const c=this.getRandomGossipPeers(t,this.opts.D,l=>this.score.score(l)>=this.opts.scoreThresholds.publishThreshold);c.size>0&&(this.fanout.set(t,c),c.forEach(l=>{n.add(l),i.fanout++}))}this.fanoutLastpub.set(t,Date.now())}}return{tosend:n,tosendCount:i}}forwardMessage(t,n,i,s){var a;i!=null&&this.score.deliverMessage(i,t,n.topic);const o=this.selectPeersToForward(n.topic,i,s);o.forEach(c=>{this.sendRpc(c,Ys([n]))}),(a=this.metrics)==null||a.onForwardMsg(n.topic,o.size)}async publish(t,n,i){var v,E;const s=Date.now(),o=this.dataTransform!=null?this.dataTransform.outboundTransform(t,n):n;if(this.publishConfig==null)throw Error("PublishError.Uninitialized");const{raw:a,msg:c}=await MAe(this.publishConfig,t,n,o),l=await this.msgIdFn(c),d=this.msgIdToStrFn(l),h=(i==null?void 0:i.ignoreDuplicatePublishError)??this.opts.ignoreDuplicatePublishError;if(this.seenCache.has(d)){if(h)return(v=this.metrics)==null||v.onPublishDuplicateMsg(t),{recipients:[]};throw Error("PublishError.Duplicate")}const{tosend:p,tosendCount:m}=this.selectPeersToPublish(t),f=this.opts.emitSelf&&this.subscriptions.has(t),g=(i==null?void 0:i.allowPublishToZeroTopicPeers)??this.opts.allowPublishToZeroTopicPeers;if(p.size===0&&!g&&!f)throw Error("PublishError.NoPeersSubscribedToTopic");this.seenCache.put(d),this.mcache.put({msgId:l,msgIdStr:d},a,!0),this.publishedMessageIds.put(d);const w=(i==null?void 0:i.batchPublish)??this.opts.batchPublish,y=Ys([a]);if(w)this.sendRpcInBatch(p,y);else for(const C of p)this.sendRpc(C,y)||p.delete(C);const b=Date.now()-s;return(E=this.metrics)==null||E.onPublishMsg(t,m,p.size,a.data!=null?a.data.length:0,b),f&&(p.add(this.components.peerId.toString()),super.dispatchEvent(new CustomEvent("gossipsub:message",{detail:{propagationSource:this.components.peerId,msgId:d,msg:c}})),super.dispatchEvent(new CustomEvent("message",{detail:c}))),{recipients:Array.from(p.values()).map(C=>this.peers.get(C)??tr(C))}}sendRpcInBatch(t,n){var o;const i=vu.encode(n),s=SA.single(i);for(const a of t){const c=this.streamsOutbound.get(a);if(c==null){this.log(`Cannot send RPC to ${a} as there is no open stream to it available`),t.delete(a);continue}try{c.pushPrefixed(s)}catch(l){t.delete(a),this.log.error(`Cannot send rpc to ${a}`,l)}(o=this.metrics)==null||o.onRpcSent(n,i.length)}}reportMessageValidationResult(t,n,i){var a;let s;if(i===Ci.Accept){if(s=this.mcache.validate(t),s!=null){const{message:c,originatingPeers:l}=s;this.score.deliverMessage(n,t,c.topic),this.forwardMessage(t,s.message,n,l)}}else if(s=this.mcache.remove(t),s!=null){const c=uj(i),{message:l,originatingPeers:d}=s;this.score.rejectMessage(n,t,l.topic,c);for(const h of d)this.score.rejectMessage(h,t,l.topic,c)}const o=this.score.messageFirstSeenTimestampMs(t);(a=this.metrics)==null||a.onReportValidation(s,i,o)}sendGraft(t,n){const s=Ys([],{graft:[{topicID:n}]});this.sendRpc(t,s)}async sendPrune(t,n){const s=[await this.makePrune(t,n,this.opts.doPX,!0)],o=Ys([],{prune:s});this.sendRpc(t,o)}sendIDontWants(t,n,i){var c;const s=this.mesh.get(n);if(s==null)return;const o=new Set(s);o.delete(i);for(const l of o)((c=this.streamsOutbound.get(l))==null?void 0:c.protocol)!==kA&&o.delete(l);const a=Ys([],{idontwant:[{messageIDs:[t]}]});this.sendRpcInBatch(o,a)}sendRpc(t,n){var c,l,d,h,p;const i=this.streamsOutbound.get(t);if(i==null)return this.log(`Cannot send RPC to ${t} as there is no open stream to it available`),!1;const s=this.control.get(t);s!=null&&(this.piggybackControl(t,n,s),this.control.delete(t));const o=this.gossip.get(t);o!=null&&(this.piggybackGossip(t,n,o),this.gossip.delete(t));const a=vu.encode(n);try{i.push(a)}catch(m){return this.log.error(`Cannot send rpc to ${t}`,m),s!=null&&this.control.set(t,s),o!=null&&this.gossip.set(t,o),!1}if((c=this.metrics)==null||c.onRpcSent(n,a.length),((l=n.control)==null?void 0:l.graft)!=null)for(const m of(d=n.control)==null?void 0:d.graft)m.topicID!=null&&this.safeDispatchEvent("gossipsub:graft",{detail:{peerId:t,topic:m.topicID,direction:"outbound"}});if(((h=n.control)==null?void 0:h.prune)!=null)for(const m of(p=n.control)==null?void 0:p.prune)m.topicID!=null&&this.safeDispatchEvent("gossipsub:prune",{detail:{peerId:t,topic:m.topicID,direction:"outbound"}});return!0}piggybackControl(t,n,i){var o,a;const s=fj(n);for(const c of i.graft)c.topicID!=null&&(((o=this.mesh.get(c.topicID))==null?void 0:o.has(t))??!1)&&s.control.graft.push(c);for(const c of i.prune)c.topicID!=null&&!(((a=this.mesh.get(c.topicID))==null?void 0:a.has(t))??!1)&&s.control.prune.push(c)}piggybackGossip(t,n,i){const s=fj(n);s.control.ihave=i}async sendGraftPrune(t,n,i){const s=this.opts.doPX,o=!1;for(const[a,c]of t){const l=c.map(p=>({topicID:p}));let d=[];const h=n.get(a);h!=null&&(d=await Promise.all(h.map(async p=>this.makePrune(a,p,s&&!(i.get(a)??!1),o))),n.delete(a)),this.sendRpc(a,Ys([],{graft:l,prune:d}))}for(const[a,c]of n){const l=await Promise.all(c.map(async d=>this.makePrune(a,d,s&&!(i.get(a)??!1),o)));this.sendRpc(a,Ys([],{prune:l}))}}emitGossip(t){const n=this.mcache.getGossipIDs(new Set(t.keys()));for(const[i,s]of t)this.doEmitGossip(i,s,n.get(i)??[])}doEmitGossip(t,n,i){if(i.length===0||(sa(i),i.length>Lh&&this.log("too many messages for gossip; will truncate IHAVE list (%d messages)",i.length),n.size===0))return;let s=this.opts.Dlazy;const a=this.opts.gossipFactor*n.size;let c=n;a>s&&(s=a),s>c.size?s=c.size:c=sa(Array.from(c)).slice(0,s),c.forEach(l=>{let d=i;i.length>Lh&&(d=sa(d.slice()).slice(0,Lh)),this.pushGossip(l,{topicID:t,messageIDs:d})})}flush(){for(const[t,n]of this.gossip.entries())this.gossip.delete(t),this.sendRpc(t,Ys([],{ihave:n}));for(const[t,n]of this.control.entries()){this.control.delete(t);const i=Ys([],{graft:n.graft,prune:n.prune});this.sendRpc(t,i)}}pushGossip(t,n){this.log("Add gossip to %s",t);const i=this.gossip.get(t)??[];this.gossip.set(t,i.concat(n))}async makePrune(t,n,i,s){var d;if(this.score.prune(t,n),((d=this.streamsOutbound.get(t))==null?void 0:d.protocol)===aj)return{topicID:n,peers:[]};const o=s?this.opts.unsubcribeBackoff:this.opts.pruneBackoff,a=o/1e3;if(this.doAddBackoff(t,n,o),!i)return{topicID:n,peers:[],backoff:a};const c=this.getRandomGossipPeers(n,this.opts.prunePeers,h=>h!==t&&this.score.score(h)>=0),l=await Promise.all(Array.from(c).map(async h=>{const p=this.peers.get(h)??tr(h);let m;try{m=await this.components.peerStore.get(p)}catch(f){if(f.name!=="NotFoundError")throw f}return{peerID:p.toMultihash().bytes,signedPeerRecord:m==null?void 0:m.peerRecordEnvelope}}));return{topicID:n,peers:l,backoff:a}}async heartbeat(){var g,w;const{D:t,Dlo:n,Dhi:i,Dscore:s,Dout:o,fanoutTTL:a}=this.opts;this.heartbeatTicks++;const c=new Map,l=y=>{let b=c.get(y);return b===void 0&&(b=this.score.score(y),c.set(y,b)),b},d=new Map,h=new Map,p=new Map;this.clearBackoff(),this.peerhave.clear(),(g=this.metrics)==null||g.cacheSize.set({cache:"iasked"},this.iasked.size),this.iasked.clear(),this.applyIwantPenalties(),this.idontwantCounts.clear();for(const y of this.idontwants.values())for(const[b,v]of y)this.heartbeatTicks-v>=this.opts.mcacheLength&&y.delete(b);this.heartbeatTicks%this.opts.directConnectTicks===0&&await this.directConnect(),(w=this.fastMsgIdCache)==null||w.prune(),this.seenCache.prune(),this.gossipTracer.prune(),this.publishedMessageIds.prune();const m=new Map;this.mesh.forEach((y,b)=>{const v=this.topics.get(b),E=new Set,C=new Set;if(m.set(b,C),v!=null){const I=sa(Array.from(v)),T=this.backoff.get(b);for(const L of I){const z=this.streamsOutbound.get(L);if(z!=null&&this.multicodecs.includes(z.protocol)&&!y.has(L)&&!this.direct.has(L)){const B=l(L);(T==null?void 0:T.has(L))!==!0&&B>=0&&E.add(L),B>=this.opts.scoreThresholds.gossipThreshold&&C.add(L)}}}const k=(I,T)=>{var z;this.log("HEARTBEAT: Remove mesh link to %s in %s",I,b),this.addBackoff(I,b),y.delete(I),l(I)>=this.opts.scoreThresholds.gossipThreshold&&C.add(I),(z=this.metrics)==null||z.onRemoveFromMesh(b,T,1);const L=h.get(I);L==null?h.set(I,[b]):L.push(b)},x=(I,T)=>{var z;this.log("HEARTBEAT: Add mesh link to %s in %s",I,b),this.score.graft(I,b),y.add(I),C.delete(I),(z=this.metrics)==null||z.onAddToMesh(b,T,1);const L=d.get(I);L==null?d.set(I,[b]):L.push(b)};if(y.forEach(I=>{const T=l(I);T<0&&(this.log("HEARTBEAT: Prune peer %s with negative score: score=%d, topic=%s",I,T,b),k(I,Qs.BadScore),p.set(I,!0))}),y.size<n){const I=t-y.size;SAe(E,I).forEach(L=>{x(L,Bn.NotEnough)})}if(y.size>i){let I=Array.from(y);I.sort((L,z)=>l(z)-l(L)),I=I.slice(0,s).concat(sa(I.slice(s)));let T=0;if(I.slice(0,t).forEach(L=>{(this.outbound.get(L)??!1)&&T++}),T<o){const L=B=>{const G=I[B];for(let K=B;K>0;K--)I[K]=I[K-1];I[0]=G};if(T>0){let B=T;for(let G=1;G<t&&B>0;G++)(this.outbound.get(I[G])??!1)&&(L(G),B--)}let z=t-T;for(let B=t;B<I.length&&z>0;B++)(this.outbound.get(I[B])??!1)&&(L(B),z--)}I.slice(t).forEach(L=>{k(L,Qs.Excess)})}if(y.size>=n){let I=0;if(y.forEach(T=>{(this.outbound.get(T)??!1)&&I++}),I<o){const T=o-I;_A(E,T,z=>this.outbound.get(z)===!0).forEach(z=>{x(z,Bn.Outbound)})}}if(this.heartbeatTicks%this.opts.opportunisticGraftTicks===0&&y.size>1){const I=Array.from(y).sort((z,B)=>l(z)-l(B)),T=Math.floor(y.size/2),L=l(I[T]);if(L<this.opts.scoreThresholds.opportunisticGraftThreshold){const z=this.opts.opportunisticGraftPeers,B=_A(E,z,G=>l(G)>L);for(const G of B)this.log("HEARTBEAT: Opportunistically graft peer %s on topic %s",G,b),x(G,Bn.Opportunistic)}}});const f=Date.now();this.fanoutLastpub.forEach((y,b)=>{y+a<f&&(this.fanout.delete(b),this.fanoutLastpub.delete(b))}),this.fanout.forEach((y,b)=>{const v=this.topics.get(b);y.forEach(x=>{(!((v==null?void 0:v.has(x))??!1)||l(x)<this.opts.scoreThresholds.publishThreshold)&&y.delete(x)});const E=this.topics.get(b),C=[],k=new Set;if(m.set(b,k),E!=null){const x=sa(Array.from(E));for(const I of x){const T=this.streamsOutbound.get(I);if(T!=null&&this.multicodecs.includes(T.protocol)&&!y.has(I)&&!this.direct.has(I)){const L=l(I);L>=this.opts.scoreThresholds.publishThreshold&&C.push(I),L>=this.opts.scoreThresholds.gossipThreshold&&k.add(I)}}}if(y.size<t){const x=t-y.size;C.slice(0,x).forEach(I=>{y.add(I),k==null||k.delete(I)})}}),this.emitGossip(m),await this.sendGraftPrune(d,h,p),this.flush(),this.mcache.shift(),this.dispatchEvent(new CustomEvent("gossipsub:heartbeat"))}getRandomGossipPeers(t,n,i=()=>!0){const s=this.topics.get(t);if(s==null)return new Set;let o=[];return s.forEach(a=>{const c=this.streamsOutbound.get(a);c!=null&&this.multicodecs.includes(c.protocol)&&i(a)&&o.push(a)}),o=sa(o),n>0&&o.length>n&&(o=o.slice(0,n)),new Set(o)}onScrapeMetrics(t){var l,d;t.mcacheSize.set(this.mcache.size),t.mcacheNotValidatedCount.set(this.mcache.notValidatedCount),t.cacheSize.set({cache:"direct"},this.direct.size),t.cacheSize.set({cache:"seenCache"},this.seenCache.size),t.cacheSize.set({cache:"fastMsgIdCache"},((l=this.fastMsgIdCache)==null?void 0:l.size)??0),t.cacheSize.set({cache:"publishedMessageIds"},this.publishedMessageIds.size),t.cacheSize.set({cache:"mcache"},this.mcache.size),t.cacheSize.set({cache:"score"},this.score.size),t.cacheSize.set({cache:"gossipTracer.promises"},this.gossipTracer.size),t.cacheSize.set({cache:"gossipTracer.requests"},this.gossipTracer.requestMsByMsgSize),t.cacheSize.set({cache:"topics"},this.topics.size),t.cacheSize.set({cache:"subscriptions"},this.subscriptions.size),t.cacheSize.set({cache:"mesh"},this.mesh.size),t.cacheSize.set({cache:"fanout"},this.fanout.size),t.cacheSize.set({cache:"peers"},this.peers.size),t.cacheSize.set({cache:"streamsOutbound"},this.streamsOutbound.size),t.cacheSize.set({cache:"streamsInbound"},this.streamsInbound.size),t.cacheSize.set({cache:"acceptFromWhitelist"},this.acceptFromWhitelist.size),t.cacheSize.set({cache:"gossip"},this.gossip.size),t.cacheSize.set({cache:"control"},this.control.size),t.cacheSize.set({cache:"peerhave"},this.peerhave.size),t.cacheSize.set({cache:"outbound"},this.outbound.size);let n=0;const i=Date.now();t.connectedPeersBackoffSec.reset();for(const h of this.backoff.values()){n+=h.size;for(const[p,m]of h.entries())this.peers.has(p)&&t.connectedPeersBackoffSec.observe(Math.max(0,m-i)/1e3)}t.cacheSize.set({cache:"backoff"},n);let s=0;for(const h of this.idontwants.values())s+=h.size;t.cacheSize.set({cache:"idontwants"},s);for(const[h,p]of this.topics)t.topicPeersCount.set({topicStr:h},p.size);for(const[h,p]of this.mesh)t.meshPeerCounts.set({topicStr:h},p.size);const o=[],a=new Map;t.behaviourPenalty.reset();for(const h of this.peers.keys()){const p=this.score.score(h);o.push(p),a.set(h,p),t.behaviourPenalty.observe(((d=this.score.peerStats.get(h))==null?void 0:d.behaviourPenalty)??0)}t.registerScores(o,this.opts.scoreThresholds),t.registerScorePerMesh(this.mesh,a);const c=PAe(this.peers.keys(),this.score.peerStats,this.score.params,this.score.peerIPs,t.topicStrToLabel);t.registerScoreWeights(c)}}u(pj,"multicodec",kA);function gj(r={}){return e=>new pj(e,r)}const qAe=r=>{const[e,t]=ct.useState(null),[n,i]=ct.useState(null);return ct.useEffect(()=>{async function s(){try{console.log("Starting OrbitDB initialization for",r);let o;try{o=await GK({libp2p:{transports:[eA(),Xx(),W9()],transportManager:{faultTolerance:xl.NO_FATAL},peerDiscovery:[V9({list:["/dns4/bootstrap.libp2p.io/tcp/443/wss/p2p/12D3KooWQL1aS4qD3yCjmV7gNmx4F5gP7pNXG1qimV5DXe7tXUn","/dns4/bootstrap.libp2p.io/tcp/443/wss/p2p/12D3KooWAtfLqN4QmgjrZ9eZ9r4L1B7bH7d9eW8fA4n4bBAyKSm","/dns4/relay.libp2p.io/tcp/443/wss/p2p/12D3KooWAdNWhqW6zSMv1tW2aLKNvEfR7f2DubkXq56Y2uLmsdN","/dns4/relay.ipfs.io/tcp/443/wss/p2p/12D3KooWAdNWhqW6zSMv1tW2aLKNvEfR7f2DubkXq56Y2uLmsdN","/dns4/relay.ipfs.io/tcp/443/wss/p2p/12D3KooWAdNWhqW6zSMv1tW2aLKNvEfR7f2DubkXq56Y2uLmsdN"]})],services:{identify:G9(),pubsub:gj()}}}),o.libp2p.addEventListener("peer:connect",l=>{console.log("Connected to peer:",l.detail.toString())}),o.libp2p.addEventListener("peer:disconnect",l=>{console.log("Disconnected from peer:",l.detail.toString())})}catch(l){throw console.error("Failed to initialize Helia:",l),new Error("IPFS initialization failed")}if(console.log("IPFS initialized:",o),!o)throw new Error("IPFS instance is undefined");const a=await u$({ipfs:o});console.log("OrbitDB instance created:",a);const c=await a.open("citizenx-annotations",{type:"documents"});console.log("Database opened:",c),t(c)}catch(o){console.error("OrbitDB initialization failed:",o),i("Failed to initialize decentralized storage")}}s()},[r]),{db:e,error:n}},gn=r=>{try{const e=new URL(r);let t=e.pathname.replace(/^\/[a-z]{2}(\/|$)/,"/");t.startsWith("/")||(t="/"+t),t=t.replace(/\/+$/,"");const n=new URLSearchParams(e.search),i=new URLSearchParams;return e.searchParams.forEach((o,a)=>{!a.startsWith("utm_")&&!["lang","locale"].includes(a)&&i.set(a,o)}),`${e.protocol}//${e.host}${t}${i.toString()?"?"+i.toString():""}`}catch(e){return console.error("Failed to normalize URL:",e),r}},WAe=(r,e,t)=>{const[n,i]=ct.useState([]),[s,o]=ct.useState(null);if(console.log("Starting OrbitDB initialization for",r),!r||r.trim()==="")return console.warn("URL is empty or invalid, skipping OrbitDB initialization"),{annotations:n,setAnnotations:i,error:"Waiting for URL...",handleSaveAnnotation:async()=>{},handleDeleteAnnotation:async()=>{}};const a=gn(r);return console.log("Normalized URL:",a),ct.useEffect(()=>{async function d(){if(e)try{let h=JSON.parse(localStorage.getItem("citizenx-annotations")||"[]");console.log("Local annotations on init:",h);const p=h.filter(f=>{try{return gn(f.url),!0}catch(g){return console.warn("Removing annotation with invalid URL from localStorage:",f.url,g),!1}});h.length!==p.length&&(console.warn("Invalid URLs detected in localStorage, cleaning up..."),localStorage.setItem("citizenx-annotations",JSON.stringify(p)),h=p);const m=t?h.filter(f=>{try{return gn(f.url)===a&&f.did&&f.did===t}catch(g){return console.warn("Skipping annotation with invalid URL:",f.url,g),!1}}):[];i(m),await new Promise(async f=>{const g=await e.all();console.log("Initial OrbitDB docs:",g);for(const w of g)try{gn(w.value.url)}catch(y){console.warn("Removing OrbitDB doc with invalid URL:",w.value.url,y);try{await e.del(w.hash),console.log("Deleted invalid doc from OrbitDB:",w.hash)}catch(b){console.error("Failed to delete invalid doc from OrbitDB:",b)}}e.events.on("update",async()=>{const w=await e.all();console.log("Initial update, annotations loaded:",w);const y=t?w.filter(b=>{try{return gn(b.value.url)===a&&b.value.did&&b.value.did===t}catch(v){return console.warn("Skipping OrbitDB doc with invalid URL:",b.value.url,v),!1}}):[];i(y.map(b=>b.value)),f()})}),h.length>0&&e.events.on("peer",async()=>{console.log("Peer connected, syncing localStorage annotations to OrbitDB");for(const w of h)try{await e.put(w),console.log("Synced local annotation to OrbitDB:",w)}catch(y){console.error("Failed to sync local annotation:",y)}localStorage.removeItem("citizenx-annotations");const f=await e.all(),g=t?f.filter(w=>{try{return gn(w.value.url)===a&&w.value.did&&w.value.did===t}catch(y){return console.warn("Skipping OrbitDB doc with invalid URL:",w.value.url,y),!1}}):[];i(g.map(w=>w.value))}),e.events.on("update",async()=>{const f=await e.all();console.log("Database updated, new docs:",f);const g=t?f.filter(w=>{try{return gn(w.value.url)===a&&w.value.did&&w.value.did===t}catch(y){return console.warn("Skipping OrbitDB doc with invalid URL:",w.value.url,y),!1}}):[];i(g.map(w=>w.value)),console.log("Annotations database updated:",g)})}catch(h){console.error("Failed to fetch annotations:",h),o("Failed to load annotations")}else{let h=JSON.parse(localStorage.getItem("citizenx-annotations")||"[]");const p=h.filter(f=>{try{return gn(f.url),!0}catch(g){return console.warn("Removing annotation with invalid URL from localStorage:",f.url,g),!1}});h.length!==p.length&&(console.warn("Invalid URLs detected in localStorage, cleaning up..."),localStorage.setItem("citizenx-annotations",JSON.stringify(p)),h=p);const m=t?h.filter(f=>{try{return gn(f.url)===a&&f.did&&f.did===t}catch(g){return console.warn("Skipping annotation with invalid URL:",f.url,g),!1}}):[];i(m)}}d()},[e,a,t]),{annotations:n,setAnnotations:i,error:s,handleSaveAnnotation:async d=>{if(!t){o("Please authenticate to save annotations.");return}if(d.trim()&&e){const h={_id:Date.now().toString(),url:a,text:d.trim(),timestamp:Date.now(),did:t};try{await e.put(h),console.log("Successfully saved to OrbitDB:",h);const p=await e.all();console.log("Annotations after save:",p);const m=p.filter(f=>{try{return gn(f.value.url)===a&&f.value.did&&f.value.did===t}catch(g){return console.warn("Skipping OrbitDB doc with invalid URL:",f.value.url,g),!1}});i(m.map(f=>f.value))}catch(p){const m=p;if(m.message.includes("NoPeersSubscribedToTopic")){console.warn("No peers subscribed, saving to localStorage:",h);const f=JSON.parse(localStorage.getItem("citizenx-annotations")||"[]");f.push(h),localStorage.setItem("citizenx-annotations",JSON.stringify(f));const g=f.filter(w=>{try{return gn(w.url)===a&&w.did&&w.did===t}catch(y){return console.warn("Skipping annotation with invalid URL:",w.url,y),!1}});i(g),e.events.on("peer",async()=>{console.log("Peer connected, retrying save to OrbitDB");try{await e.put(h),console.log("Successfully saved to OrbitDB after peer connection:",h),localStorage.removeItem("citizenx-annotations");const w=await e.all(),y=t?w.filter(b=>{try{return gn(b.value.url)===a&&b.value.did&&b.value.did===t}catch(v){return console.warn("Skipping OrbitDB doc with invalid URL:",b.value.url,v),!1}}):[];i(y.map(b=>b.value))}catch(w){console.error("Retry failed:",w)}})}else console.error("Failed to save annotation:",m),o("Failed to save annotation")}}else if(d.trim()){const h={_id:Date.now().toString(),url:a,text:d.trim(),timestamp:Date.now(),did:t},p=JSON.parse(localStorage.getItem("citizenx-annotations")||"[]");p.push(h),localStorage.setItem("citizenx-annotations",JSON.stringify(p));const m=p.filter(f=>{try{return gn(f.url)===a&&f.did&&f.did===t}catch(g){return console.warn("Skipping annotation with invalid URL:",f.url,g),!1}});i(m)}},handleDeleteAnnotation:async d=>{if(e)try{await e.del(d),console.log("Successfully deleted annotation from OrbitDB:",d);const h=await e.all(),p=t?h.filter(m=>{try{return gn(m.value.url)===a&&m.value.did&&m.value.did===t}catch(f){return console.warn("Skipping OrbitDB doc with invalid URL:",m.value.url,f),!1}}):[];i(p.map(m=>m.value))}catch(h){console.error("Failed to delete annotation:",h),o("Failed to delete annotation")}else{const p=JSON.parse(localStorage.getItem("citizenx-annotations")||"[]").filter(f=>f._id!==d);localStorage.setItem("citizenx-annotations",JSON.stringify(p));const m=t?p.filter(f=>{try{return gn(f.url)===a&&f.did&&f.did===t}catch(g){return console.warn("Skipping annotation with invalid URL:",f.url,g),!1}}):[];i(m),console.warn("No peers subscribed, deleted from localStorage:",d)}}}},yj=r=>{const[e,t]=ct.useState(new Map),[n,i]=ct.useState(null),[s,o]=ct.useState(null);return ct.useEffect(()=>{async function l(){try{console.log("Initializing user profiles database...");const d=await GK({libp2p:{transports:[eA(),Xx(),W9()],transportManager:{faultTolerance:xl.NO_FATAL},peerDiscovery:[V9({list:["/dns4/bootstrap.libp2p.io/tcp/443/wss/p2p/12D3KooWQL1aS4qD3yCjmV7gNmx4F5gP7pNXG1qimV5DXe7tXUn","/dns4/bootstrap.libp2p.io/tcp/443/wss/p2p/12D3KooWAtfLqN4QmgjrZ9eZ9r4L1B7bH7d9eW8fA4n4bBAyKSm","/dns4/relay.libp2p.io/tcp/443/wss/p2p/12D3KooWAdNWhqW6zSMv1tW2aLKNvEfR7f2DubkXq56Y2uLmsdN","/dns4/relay.ipfs.io/tcp/443/wss/p2p/12D3KooWAdNWhqW6zSMv1tW2aLKNvEfR7f2DubkXq56Y2uLmsdN","/dns4/relay.ipfs.io/tcp/443/wss/p2p/12D3KooWAdNWhqW6zSMv1tW2aLKNvEfR7f2DubkXq56Y2uLmsdN","/dns4/go-ipfs-bootstrap-1.ipfs.dwebops.pub/tcp/443/wss/p2p/QmNnooDu7bfjPFoTZYxMNLWUQJyrVwtbZguyWvRmga5yW","/dns4/go-ipfs-bootstrap-2.ipfs.dwebops.pub/tcp/443/wss/p2p/QmNnooDu7bfjPFoTZYxMNLWUQJyrVwtbZguyWvRmga5yX"]})],services:{identify:G9(),pubsub:gj()}}});d.libp2p.addEventListener("peer:connect",w=>{console.log("Connected to peer:",w.detail.toString())}),d.libp2p.addEventListener("peer:disconnect",w=>{console.log("Disconnected from peer:",w.detail.toString())}),console.log("IPFS initialized for user profiles:",d);const p=await(await u$({ipfs:d})).open("citizenx-user-profiles",{type:"documents"});console.log("User profiles database opened:",p),o(p);const m=await p.all(),f=new Map;m.forEach(w=>{f.set(w.value._id,w.value)}),JSON.parse(localStorage.getItem("citizenx-user-profiles")||"[]").forEach(w=>{f.has(w._id)||f.set(w._id,w)}),t(f),console.log("Initial profiles loaded:",Array.from(f.entries())),p.events.on("update",async()=>{const w=await p.all(),y=new Map;w.forEach(v=>{y.set(v.value._id,v.value)}),JSON.parse(localStorage.getItem("citizenx-user-profiles")||"[]").forEach(v=>{y.has(v._id)||y.set(v._id,v)}),t(y),console.log("User profiles updated:",Array.from(y.entries()))}),p.events.on("peer",async()=>{console.log("Peer connected, syncing local profiles to OrbitDB");const w=JSON.parse(localStorage.getItem("citizenx-user-profiles")||"[]");for(const v of w)try{await p.put(v),console.log("Synced local profile to OrbitDB:",v)}catch(E){console.error("Failed to sync local profile:",E)}localStorage.setItem("citizenx-user-profiles",JSON.stringify([]));const y=await p.all(),b=new Map;y.forEach(v=>{b.set(v.value._id,v.value)}),t(b),console.log("Profiles after sync:",Array.from(b.entries()))})}catch(d){console.error("Failed to initialize user profiles database:",d),i("Failed to initialize user profiles database")}}l()},[]),{profiles:e,createProfile:async(l,d)=>{if(!r)throw new Error("User not authenticated");const h={_id:r,handle:l,profilePicture:d};try{if(!s)throw new Error("Database not initialized");await s.put(h),console.log("User profile created:",h),t(p=>{const m=new Map(p);return m.set(r,h),console.log("Profiles after create:",Array.from(m.entries())),m})}catch(p){if(p.message.includes("NoPeersSubscribedToTopic")){console.warn("No peers subscribed, saving profile to localStorage:",h);const m=JSON.parse(localStorage.getItem("citizenx-user-profiles")||"[]"),f=m.findIndex(g=>g._id===r);f!==-1?m[f]=h:m.push(h),localStorage.setItem("citizenx-user-profiles",JSON.stringify(m)),t(g=>{const w=new Map(g);return w.set(r,h),console.log("Profiles after local save:",Array.from(w.entries())),w})}else throw console.error("Failed to create user profile:",p),p}},updateProfile:async(l,d)=>{if(!r)throw new Error("User not authenticated");try{if(!s)throw new Error("Database not initialized");const h=await s.get(r);if(!h)throw new Error("User profile not found");const p={...h,handle:l,profilePicture:d};await s.put(p),console.log("User profile updated:",p),t(m=>{const f=new Map(m);return f.set(r,p),console.log("Profiles after update:",Array.from(f.entries())),f})}catch(h){if(h.message.includes("NoPeersSubscribedToTopic")){console.warn("No peers subscribed, updating profile in localStorage:",{did:r,handle:l,profilePicture:d});const p=JSON.parse(localStorage.getItem("citizenx-user-profiles")||"[]"),m=p.findIndex(g=>g._id===r),f={_id:r,handle:l,profilePicture:d};m!==-1?p[m]=f:p.push(f),localStorage.setItem("citizenx-user-profiles",JSON.stringify(p)),t(g=>{const w=new Map(g);return w.set(r,f),console.log("Profiles after local update:",Array.from(w.entries())),w})}else throw console.error("Failed to update user profile:",h),h}},error:n}};async function GAe(){const r=await crypto.subtle.generateKey({name:"ECDSA",namedCurve:"P-256"},!0,["sign","verify"]),e=await crypto.subtle.exportKey("spki",r.publicKey),t=btoa(String.fromCharCode(...new Uint8Array(e))),n=await crypto.subtle.exportKey("pkcs8",r.privateKey),i=btoa(String.fromCharCode(...new Uint8Array(n)));return{publicKey:t,privateKey:i,rawPublicKey:r.publicKey,rawPrivateKey:r.privateKey}}async function mj(r,e){const t=Uint8Array.from(atob(e),a=>a.charCodeAt(0)),n=await crypto.subtle.importKey("pkcs8",t,{name:"ECDSA",namedCurve:"P-256"},!1,["sign"]),s=new TextEncoder().encode(r),o=await crypto.subtle.sign({name:"ECDSA",hash:"SHA-256"},n,s);return btoa(String.fromCharCode(...new Uint8Array(o)))}async function wj(r,e,t){const n=Uint8Array.from(atob(t),c=>c.charCodeAt(0)),i=await crypto.subtle.importKey("spki",n,{name:"ECDSA",namedCurve:"P-256"},!1,["verify"]),s=Uint8Array.from(atob(e),c=>c.charCodeAt(0)),a=new TextEncoder().encode(r);return await crypto.subtle.verify({name:"ECDSA",hash:"SHA-256"},i,s,a)}async function QAe(r,e){const t=new TextEncoder,n=t.encode(e),i=crypto.getRandomValues(new Uint8Array(16)),s=await crypto.subtle.importKey("raw",n,{name:"PBKDF2"},!1,["deriveBits","deriveKey"]),o=await crypto.subtle.deriveKey({name:"PBKDF2",salt:i,iterations:1e5,hash:"SHA-256"},s,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"]),a=crypto.getRandomValues(new Uint8Array(12)),c=t.encode(r),l=await crypto.subtle.encrypt({name:"AES-GCM",iv:a},o,c),d=new Uint8Array(i.length+a.length+l.byteLength);return d.set(i,0),d.set(a,i.length),d.set(new Uint8Array(l),i.length+a.length),btoa(String.fromCharCode(...d))}async function YAe(r,e){const t=Uint8Array.from(atob(r),h=>h.charCodeAt(0)),n=t.slice(0,16),i=t.slice(16,28),s=t.slice(28),a=new TextEncoder().encode(e),c=await crypto.subtle.importKey("raw",a,{name:"PBKDF2"},!1,["deriveBits","deriveKey"]),l=await crypto.subtle.deriveKey({name:"PBKDF2",salt:n,iterations:1e5,hash:"SHA-256"},c,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"]),d=await crypto.subtle.decrypt({name:"AES-GCM",iv:i},l,s);return new TextDecoder().decode(d)}const JAe=()=>{const[r,e]=ct.useState(null),[t,n]=ct.useState(null),{profiles:i,createProfile:s,updateProfile:o,error:a}=yj(r),[c,l]=ct.useState(null);return ct.useEffect(()=>{const f=chrome;if(!f.storage||!f.storage.local){n("chrome.storage.local is not available");return}f.storage.local.get(["did"],g=>{g.did&&(e(g.did),console.log("Initial DID from storage:",g.did))})},[]),ct.useEffect(()=>{if(r&&i.size>0){const f=i.get(r);l(f||null)}},[r,i]),{did:r,profile:c,authenticate:async()=>{try{const f=chrome;if(!f.storage||!f.storage.local)throw new Error("chrome.storage.local is not available");const g=await new Promise(w=>{f.storage.local.get(["did","privateKey"],w)});if(g.did&&g.privateKey){e(g.did),console.log("Authenticated DID:",g.did);const w=Date.now().toString(),y=await mj(w,g.privateKey);if(!await wj(w,y,g.did))throw new Error("Failed to verify existing key pair");n(null)}else{const w=await GAe();f.storage.local.set({did:w.publicKey,privateKey:w.privateKey},()=>{console.log("Key pair stored in chrome.storage.local"),e(w.publicKey),console.log("New authenticated DID:",w.publicKey),n(null)})}}catch(f){console.error("Authentication error:",f),n(f.message),e(null)}},signOut:()=>{e(null),l(null),n(null);const f=chrome;f.storage&&f.storage.local&&f.storage.local.remove(["did","privateKey"],()=>{console.log("Cleared DID and private key from chrome.storage.local")})},exportIdentity:async f=>{const g=chrome;if(!g.storage||!g.storage.local)throw new Error("chrome.storage.local is not available");const w=await new Promise(v=>{g.storage.local.get(["did","privateKey"],v)});if(!w.did||!w.privateKey)throw new Error("No identity found to export");const y=await QAe(w.privateKey,f);return JSON.stringify({did:w.did,privateKey:y})},importIdentity:async(f,g)=>{try{const w=chrome;if(!w.storage||!w.storage.local)throw new Error("chrome.storage.local is not available");const{did:y,privateKey:b}=JSON.parse(f),v=await YAe(b,g),E=Date.now().toString(),C=await mj(E,v);if(!await wj(E,C,y))throw new Error("Invalid key pair or passphrase");w.storage.local.set({did:y,privateKey:v},()=>{console.log("Imported identity stored in chrome.storage.local"),e(y),console.log("Imported DID:",y),n(null)})}catch(w){throw console.error("Import error:",w),n(w.message),e(null),w}},createProfile:s,updateProfile:o,error:t||a}},XAe=({annotations:r,profiles:e,onDelete:t})=>(console.log("AnnotationList profiles:",Array.from(e.entries())),Ue.jsx("div",{children:r.map(n=>{console.log(`Annotation DID: ${n.did}`);const i=n.did?e.get(n.did):null;return console.log(`Creator profile for DID ${n.did}:`,i),Ue.jsxs("div",{style:{marginBottom:"8px",borderBottom:"1px solid #ccc",paddingBottom:"8px"},children:[Ue.jsxs("div",{style:{display:"flex",alignItems:"center",marginBottom:"4px"},children:[(i==null?void 0:i.profilePicture)&&Ue.jsx("img",{src:i.profilePicture,alt:i.handle,style:{width:"24px",height:"24px",borderRadius:"50%",marginRight:"8px"}}),Ue.jsx("span",{style:{fontSize:"0.8rem",fontWeight:"bold"},children:(i==null?void 0:i.handle)||(n.did?`${n.did.slice(0,6)}...${n.did.slice(-4)}`:"Unknown")})]}),Ue.jsx("p",{style:{margin:"0",fontSize:"0.9rem"},children:n.text}),Ue.jsx("button",{onClick:()=>t(n._id),style:{padding:"2px 8px",background:"#ff0000",color:"#fff",border:"none",borderRadius:"3px",cursor:"pointer",marginTop:"4px"},children:"Delete"})]},n._id)})})),ZAe=({url:r})=>{const[e,t]=ct.useState(""),{did:n,profile:i,authenticate:s,signOut:o,exportIdentity:a,importIdentity:c,createProfile:l,updateProfile:d,error:h}=JAe(),{profiles:p,error:m}=yj(n),[f,g]=ct.useState(""),[w,y]=ct.useState(""),[b,v]=ct.useState(""),[E,C]=ct.useState(""),[k,x]=ct.useState(""),[I,T]=ct.useState(""),[L,z]=ct.useState(!1),[B,G]=ct.useState(""),[K,q]=ct.useState(""),Q=r.startsWith("chrome-extension://"),{db:j,error:O}=Q?{db:null,error:null}:qAe(r),{annotations:U,error:W,handleSaveAnnotation:Y,handleDeleteAnnotation:H}=Q?{annotations:[],error:null,handleSaveAnnotation:async()=>{},handleDeleteAnnotation:async()=>{}}:WAe(r,j,n),oe=h||O||W||m;ct.useEffect(()=>{n&&!i&&z(!0)},[n,i]);const ye=async()=>{await Y(e),t("")},de=async()=>{try{if(!b){T("Please enter a passphrase to export your identity");return}const Ie=await a(b);g(Ie),T("")}catch(Ie){T(Ie.message)}},le=async()=>{try{if(!w||!E){x("Please enter the identity data and passphrase");return}await c(w,E),y(""),C(""),x(""),g("")}catch(Ie){x(Ie.message)}},$e=async()=>{try{if(!B||!K){T("Please provide a handle and profile picture");return}i?await d(B,K):await l(B,K),z(!1),G(""),q("")}catch(Ie){T(Ie.message)}},Ne=Ie=>{var bt;const tt=(bt=Ie.target.files)==null?void 0:bt[0];if(tt){const vt=new FileReader;vt.onload=kt=>{var Yt;(Yt=kt.target)!=null&&Yt.result&&q(kt.target.result)},vt.readAsDataURL(tt)}};return Ue.jsxs("div",{style:{padding:"16px",maxWidth:"300px"},children:[Ue.jsx("h1",{style:{fontSize:"1.5rem",fontWeight:"bold",margin:"0 0 8px 0"},children:"CitizenX Annotations"}),n?Ue.jsxs("div",{style:{marginBottom:"8px"},children:[Ue.jsxs("div",{style:{display:"flex",alignItems:"center",marginBottom:"8px"},children:[i&&i.profilePicture&&Ue.jsx("img",{src:i.profilePicture,alt:"Profile",style:{width:"32px",height:"32px",borderRadius:"50%",marginRight:"8px"}}),Ue.jsxs("p",{style:{margin:"0",fontSize:"0.9rem"},children:["Connected: ",(i==null?void 0:i.handle)||"Set your handle"]}),Ue.jsx("button",{onClick:()=>z(!0),style:{marginLeft:"8px",padding:"2px 8px",background:"#007bff",color:"#fff",border:"none",borderRadius:"3px",cursor:"pointer"},children:"Edit Profile"})]}),Ue.jsx("button",{onClick:o,style:{padding:"5px 10px",background:"#ff0000",color:"#fff",border:"none",borderRadius:"3px",cursor:"pointer",marginBottom:"8px"},children:"Sign Out"}),Ue.jsxs("div",{style:{marginBottom:"8px"},children:[Ue.jsx("input",{type:"password",placeholder:"Enter passphrase to export",value:b,onChange:Ie=>v(Ie.target.value),style:{width:"100%",marginBottom:"4px"}}),Ue.jsx("button",{onClick:de,style:{padding:"5px 10px",background:"#007bff",color:"#fff",border:"none",borderRadius:"3px",cursor:"pointer",width:"100%"},children:"Export Identity"}),I&&Ue.jsx("p",{style:{color:"red",margin:"4px 0 0 0",fontSize:"0.8rem"},children:I}),f&&Ue.jsx("textarea",{value:f,readOnly:!0,style:{width:"100%",height:"60px",marginTop:"4px",fontSize:"0.8rem"}})]})]}):Ue.jsxs("div",{style:{marginBottom:"8px"},children:[Ue.jsx("button",{onClick:s,style:{padding:"5px 10px",background:"#007bff",color:"#fff",border:"none",borderRadius:"3px",cursor:"pointer",marginBottom:"8px",width:"100%"},children:"Authenticate"}),Ue.jsxs("div",{children:[Ue.jsx("textarea",{value:w,onChange:Ie=>y(Ie.target.value),placeholder:"Paste your exported identity here...",style:{width:"100%",height:"60px",marginBottom:"4px",fontSize:"0.8rem"}}),Ue.jsx("input",{type:"password",placeholder:"Enter passphrase to import",value:E,onChange:Ie=>C(Ie.target.value),style:{width:"100%",marginBottom:"4px"}}),Ue.jsx("button",{onClick:le,style:{padding:"5px 10px",background:"#007bff",color:"#fff",border:"none",borderRadius:"3px",cursor:"pointer",width:"100%"},children:"Import Identity"}),k&&Ue.jsx("p",{style:{color:"red",margin:"4px 0 0 0",fontSize:"0.8rem"},children:k})]})]}),L&&Ue.jsxs("div",{style:{position:"fixed",top:"50%",left:"50%",transform:"translate(-50%, -50%)",background:"#fff",padding:"16px",borderRadius:"5px",boxShadow:"0 0 10px rgba(0,0,0,0.3)",zIndex:1e3},children:[Ue.jsx("h2",{style:{fontSize:"1.2rem",margin:"0 0 8px 0"},children:i?"Update Profile":"Set Profile"}),Ue.jsx("input",{type:"text",placeholder:"Enter your handle",value:B,onChange:Ie=>G(Ie.target.value),style:{width:"100%",marginBottom:"8px"}}),Ue.jsx("input",{type:"file",accept:"image/*",onChange:Ne,style:{width:"100%",marginBottom:"8px"}}),K&&Ue.jsx("img",{src:K,alt:"Preview",style:{width:"50px",height:"50px",borderRadius:"50%",marginBottom:"8px"}}),Ue.jsxs("div",{style:{display:"flex",gap:"8px"},children:[Ue.jsx("button",{onClick:$e,style:{padding:"5px 10px",background:"#28a745",color:"#fff",border:"none",borderRadius:"3px",cursor:"pointer"},children:"Save"}),Ue.jsx("button",{onClick:()=>z(!1),style:{padding:"5px 10px",background:"#ff0000",color:"#fff",border:"none",borderRadius:"3px",cursor:"pointer"},children:"Cancel"})]})]}),oe&&Ue.jsx("p",{style:{color:"red",margin:"0 0 8px 0"},children:oe}),Ue.jsx("textarea",{value:e,onChange:Ie=>t(Ie.target.value),placeholder:"Enter annotation...",style:{width:"100%",height:"80px",marginBottom:"8px"}}),Ue.jsx("button",{onClick:ye,disabled:!j,style:{padding:"5px 10px",background:j?"#28a745":"#ccc",color:"#fff",border:"none",borderRadius:"3px",cursor:j?"pointer":"not-allowed",marginBottom:"16px"},children:"Save"}),Ue.jsx(XAe,{annotations:U,profiles:p,onDelete:H})]})},eCe=()=>{const[r,e]=ct.useState(null);return ct.useEffect(()=>{const t=()=>{chrome.tabs.query({active:!0,currentWindow:!0},s=>{var o;(o=s[0])!=null&&o.url?e(s[0].url):(console.error("Failed to get current tab URL"),e(""))})};t();const n=(s,o,a)=>{o.url&&a.active&&e(o.url)};chrome.tabs.onUpdated.addListener(n);const i=()=>{t()};return chrome.tabs.onActivated.addListener(i),()=>{chrome.tabs.onUpdated.removeListener(n),chrome.tabs.onActivated.removeListener(i)}},[]),r===null?Ue.jsx("div",{children:"Loading..."}):Ue.jsx(ZAe,{url:r})},bj=document.getElementById("root");bj?i_(bj).render(Ue.jsx(eCe,{})):console.error("Root element not found")})();
